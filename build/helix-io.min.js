!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("helix")):"function"==typeof define&&define.amd?define("HX",["exports","helix"],e):e(t.HX=t.HX||{},t.HX)}(this,function(t,e){"use strict";function r(){this.defaultScene=new e.Scene,this.scenes={},this.materials={},this.entities={},this.animations={}}function i(){e.Importer.call(this,r),this._numComponentLookUp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},this._flipCoord=new e.Matrix4x4,this._flipCoord.setColumn(0,new e.Float4((-1),0,0,0)),this._flipCoord.setColumn(1,new e.Float4(0,0,1,0)),this._flipCoord.setColumn(2,new e.Float4(0,1,0,0))}function a(){this._listeners=[],this._lookUp={}}function s(){this.onComplete=new a,this.onProgress=new a,this._queue=[],this._childQueues=[],this._currentIndex=0,this._isRunning=!1}function n(){e.Importer.call(this,Object,e.URLLoader.DATA_TEXT),this._textures=[],this._texturesToLoad=[],this._activeMaterial=null}function o(){e.Importer.call(this,e.Entity),this._objects=[],this._vertices=[],this._normals=[],this._uvs=[],this._hasNormals=!1,this._defaultMaterial=new e.BasicMaterial,this._target=null,this._mtlLibFile=null}function h(){HX.Importer.call(this,HX.Model)}function u(t){this._dataView=t,this._offset=0,this._endian=u.LITTLE_ENDIAN}function p(){}function l(){}i.prototype=Object.create(e.Importer.prototype),i.prototype.parse=function(t,r){this._defaultSceneIndex=void 0,this._gltf=JSON.parse(t);var i=this._gltf.asset;if(this._target=r,i.hasOwnProperty("minVersion")){i.minVersion.split(".")}if(i.hasOwnProperty("version")){var a=i.version.split(".");if("2"!==a[0])throw new Error("Unsupported glTF version!")}this._assetLibrary=new e.AssetLibrary,this._binFileCheck={},this._queueImages(),this._queueBuffers(),this._assetLibrary.onComplete.bind(function(){this._continueParsing()},this),this._assetLibrary.onProgress.bind(function(t){this._notifyProgress(.8*t)},this),this._assetLibrary.load()},i.prototype._continueParsing=function(){var t=this._gltf;t.hasOwnProperty("scene")&&(this._defaultSceneIndex=t.scene);var r=new e.AsyncTaskQueue;r.queue(this._parseMaterials.bind(this)),r.queue(this._parseMeshes.bind(this)),r.queue(this._parseNodes.bind(this)),r.queue(this._parseScenes.bind(this)),r.queue(this._parseAnimations.bind(this)),r.queue(this._playAnimations.bind(this)),r.queue(this._notifyComplete.bind(this),this._target),r.onProgress.bind(function(t){this._notifyProgress(.8+.2*t)}.bind(this)),r.execute()},i.prototype._getAccessor=function(t){var e,r=this._gltf.accessors[t];void 0!==r.bufferView&&(e=this._getBufferView(r.bufferView));var i={dataType:r.componentType,numComponents:this._numComponentLookUp[r.type],type:r.type,data:e?e.data:null,min:r.min,max:r.max,byteOffset:e.byteOffset+(r.byteOffset||0),count:r.count,isSparse:!1};if(r.sparse){i.isSparse=!0,i.sparseCount=r.sparse.count,i.sparseOffsets=[];var a=this._getBufferView(r.sparse.indices.bufferView),s=this._getBufferView(r.sparse.values.bufferView);i.sparseIndices={data:a.data,byteOffset:r.sparse.indices.byteOffset,dataType:r.componentType},i.sparseValues={data:s.data,byteOffset:r.values.indices.byteOffset}}return i},i.prototype._getBufferView=function(t){var e=this._gltf.bufferViews[t],r=this._buffers[e.buffer],i=r.byteOffset+(e.byteOffset||0);return{data:this._assetLibrary.get(r.assetID),byteOffset:i,byteLength:e.byteLength}},i.prototype._queueImages=function(){var t=this._gltf.images;if(t)for(var r=0;r<t.length;++r){var i=t[r];this._assetLibrary.queueAsset("hx_image_"+r,this._correctURL(i.uri),e.AssetLibrary.Type.ASSET,e.JPG)}},i.prototype._queueBuffers=function(){var t=this._gltf.buffers;if(t){this._buffers=[];for(var r=0;r<t.length;++r){var i=t[r];if(!this._binFileCheck[i.uri]){var a="hx_bin_"+r;this._assetLibrary.queueAsset(a,this._correctURL(i.uri),e.AssetLibrary.Type.RAW_BINARY),this._binFileCheck[i.uri]=!0,this._buffers[r]={assetID:a,byteOffset:i.byteOffset||0,byteLength:i.byteLength}}}}},i.prototype._parseMaterials=function(){var t=this._gltf.materials;if(t){this._materials=[];for(var r=0;r<t.length;++r){var i=t[r],a=new e.BasicMaterial;if(a.name=i.name,a.specularMapMode=e.BasicMaterial.SPECULAR_MAP_METALLIC_ROUGHNESS,a.normalMap=this._getTexture(i.normalTexture),a.occlusionMap=this._getTexture(i.occlusionTexture),a.emissionMap=this._getTexture(i.emissiveTexture),i.emissiveFactor){var s=new e.Color(i.emissiveFactor[0],i.emissiveFactor[1],i.emissiveFactor[2],1);a.emissiveColor=s.linearToGamma()}else a.emissionMap&&(a.emissiveColor=e.Color.WHITE);var n=i.pbrMetallicRoughness;if(n){if(a.colorMap=this._getTexture(n.baseColorTexture),a.specularMap=this._getTexture(n.metallicRoughnessTexture),n.baseColorFactor){var o=new e.Color(n.baseColorFactor[0],n.baseColorFactor[1],n.baseColorFactor[2],n.baseColorFactor[3]);a.color=o.linearToGamma()}a.metallicness=void 0===n.metallicFactor?1:n.metallicFactor,a.roughness=void 0===n.roughnessFactor?1:n.roughnessFactor,a.specularMap&&(a.roughness*=.5,a.roughnessRange=-a.roughness)}this._materials[r]=a,this._target.materials[a.name]=a}}},i.prototype._getTexture=function(t){return t?this._assetLibrary.get("hx_image_"+t.index):null},i.prototype._parseMeshes=function(){var t=this._gltf.meshes;if(t){this._entities=[];for(var r=0;r<t.length;++r){for(var i=t[r],a=new e.Entity,s=0;s<i.primitives.length;++s){var n=i.primitives[s];this._parsePrimitive(n,a),i.weights&&this._parseMorphWeights(i.weights,a)}a.name=i.name,this._entities[r]=a}}},i.prototype._parseMorphWeights=function(t,r){var i=new e.MorphAnimation;if(t)for(var a=0,s=t.length;a<s;++a)i.setWeight("morphTarget_"+a,t[a]);r.addComponent(i)},i.prototype._parseMorphTargets=function(t,r){for(var i=0;i<t.length;++i){var a=t[i],s=new e.MorphTarget;s.name="morphTarget_"+i;var n=this._getAccessor(a.POSITION),o=void 0!==a.NORMAL?this._getAccessor(a.NORMAL):null,h=new Float32Array(3*n.count);if(this._readVertexData(h,0,n,3,3,!0),o){var u=new Float32Array(3*o.count);this._readVertexData(u,0,o,3,3,!0)}s.init(h,u),r.addMorphTarget(s)}},i.prototype._parsePrimitive=function(t,r){var i=e.Mesh.createDefaultEmpty(),a=t.attributes,s=this._getAccessor(a.POSITION),n=void 0!==a.NORMAL?this._getAccessor(a.NORMAL):null,o=void 0!==a.TANGENT?this._getAccessor(a.TANGENT):null,h=void 0!==a.TEXCOORD_0?this._getAccessor(a.TEXCOORD_0):null,u=void 0!==a.JOINTS_0?this._getAccessor(a.JOINTS_0):null,p=void 0!==a.WEIGHTS_0?this._getAccessor(a.WEIGHTS_0):null,l=0,_=i.getVertexStride(0),c=new Float32Array(s.count*_);this._readVertexData(c,0,s,3,_,!0),n?this._readVertexData(c,3,n,3,_,!0):l=e.NormalTangentGenerator.MODE_NORMALS,o?this._readVertexData(c,6,o,4,_,!0):h&&(l|=e.NormalTangentGenerator.MODE_TANGENTS),h&&this._readUVData(c,10,h,_),i.setVertexData(c,0);var f=this._getAccessor(t.indices);if(i.setIndexData(this._readIndices(f)),l){var d=new e.NormalTangentGenerator;d.generate(i)}if(u){i.addVertexAttribute("hx_jointIndices",4,1),i.addVertexAttribute("hx_jointWeights",4,1),_=i.getVertexStride(1);var m=new Float32Array(u.count*_);this._readVertexData(m,0,u,4,_),this._readVertexData(m,4,p,4,_),i.setVertexData(m,1)}r.addComponent(new e.MeshInstance(i,this._materials[t.material])),t.targets&&t.targets.length>0&&this._parseMorphTargets(t.targets,i)},i.prototype._readVertexData=function(t,r,i,a,s,n){var o,h,u,p=r,l=i.byteOffset,_=i.count,c=i.data;if(c)for(i.dataType===e.DataType.FLOAT?(h=c.getFloat32,u=4):i.dataType===e.DataType.UNSIGNED_SHORT?(h=c.getUint16,u=2):i.dataType===e.DataType.UNSIGNED_INT&&(h=c.getUint32,u=4),o=0;o<_;++o){for(var f=0;f<a;++f)t[p+f]=h.call(c,l,!0),l+=u;p+=s}else{for(o=0;o<_;++o)for(f=0;f<a;++f)t[p+f]=0;p+=s}if(i.isSparse&&this._applySparseAccessor(t,i,a,s,h,u),n)for(p=r,o=0;o<_;++o){var d=t[p+1];t[p]=-t[p],t[p+1]=t[p+2],t[p+2]=d,p+=s}},i.prototype._applySparseAccessor=function(t,r,i,a,s,n){var o,h,u=r.sparseCount,p=r.sparseIndices.data,l=r.sparseValues.data,_=r.sparseIndices.byteOffset,c=r.sparseValues.byteOffset;r.dataType===e.DataType.UNSIGNED_SHORT?(o=p.getUint16,h=2):r.dataType===e.DataType.UNSIGNED_INT&&(o=p.getUint32,h=4);for(var f=0;f<u;++f){for(var d=o.call(p,_)*a,m=0;m<i;++m){var g=s.call(l,c,!0);c+=n,t[d+m]=g}_+=h}},i.prototype._readUVData=function(t,e,r,i){for(var a=e,s=r.byteOffset,n=r.count,o=r.data,h=0;h<n;++h)t[a]=o.getFloat32(s,!0),t[a+1]=1-o.getFloat32(s+4,!0),s+=8,a+=i},i.prototype._readIndices=function(t){var r,i,a,s=t.byteOffset,n=t.data,o=t.count;t.dataType===e.DataType.UNSIGNED_SHORT?(i=Uint16Array,r=n.getUint16,a=2):t.dataType===e.DataType.UNSIGNED_INT&&(i=Uint32Array,r=n.getUint32,a=4);for(var h=new i(o),u=0;u<o;++u)h[u]=r.call(n,s,!0),s+=a;return h},i.prototype._parseSkin=function(t,r){var i=t.skin,a=this._gltf.skins[i],s=this._getAccessor(a.inverseBindMatrices),n=s.data,o=s.byteOffset,h=new e.Skeleton,u=new e.SkeletonPose,p=this._nodes[a.skeleton];p.parent&&p.parent.detach(p);for(var l=0;l<a.joints.length;++l){var _=a.joints[l],c=new e.SkeletonJoint;c.inverseBindPose=this._readMatrix4x4(n,o),o+=64,c.inverseBindPose.prepend(this._flipCoord),c.inverseBindPose.append(this._flipCoord),h.addJoint(c);var f=this._nodes[_];if(void 0!==f._jointIndex)throw new Error("Adding one node to multiple skeletons!");f._jointIndex=l,f._skeletonPose=u;var d=new e.SkeletonJointPose;d.position.copyFrom(f.position),d.rotation.copyFrom(f.rotation),d.scale.copyFrom(f.scale),u.setJointPose(l,d)}for(l=0;l<a.joints.length;++l)_=a.joints[l],f=this._nodes[_],c=h.getJoint(l),c.parentIndex=f!==p&&f.parent?f.parent._jointIndex:-1;var m=r.getComponentsByType(e.MeshInstance);for(l=0;l<m.length;++l){var g=m[l];g.mesh.skeleton=h,g.skeletonPose=u}},i.prototype._parseNodes=function(){var t=this._gltf.nodes;if(t){var r=new e.Matrix4x4;this._nodes=[];for(var i=0;i<t.length;++i){var a,s=t[i];s.hasOwnProperty("mesh")?(a=this._entities[s.mesh],a.name=s.name||"node_"+i,this._target.entities[a.name]=a):a=new e.SceneNode,s.rotation&&(a.rotation.set(s.rotation[0],s.rotation[1],s.rotation[2],s.rotation[3]),r.fromQuaternion(a.rotation),r.prepend(this._flipCoord),r.append(this._flipCoord),a.rotation.fromMatrix(r)),s.translation&&a.position.set(s.translation[0],s.translation[1],-s.translation[2],1),s.scale&&a.scale.set(s.scale[0],s.scale[1],s.scale[2],1),s.matrix&&(a.matrix=new e.Matrix4x4(s.matrix),a.matrix.prepend(this._flipCoord),a.matrix.append(this._flipCoord)),this._nodes[i]=a}for(i=0;i<t.length;++i)if(s=t[i],a=this._nodes[i],s.children)for(var n=0;n<s.children.length;++n){var o=s.children[n];a.attach(this._nodes[o])}for(i=0;i<t.length;++i)s=t[i],a=this._nodes[i],s.hasOwnProperty("skin")&&this._parseSkin(s,a)}},i.prototype._parseScenes=function(){var t=this._gltf.scenes;if(t)for(var r=0;r<t.length;++r){var i,a=t[r];r===this._defaultSceneIndex?i=this._target.defaultScene:(i=new e.Scene,this._target.scenes.push(i));for(var s=a.nodes,n=0;n<s.length;++n){var o=s[n];i.attach(this._nodes[o])}}},i.prototype._parseAnimationSampler=function(t,r){var i=this._getAccessor(t.input),a=this._getAccessor(t.output),s=i.data,n=a.data,o=i.byteOffset,h=a.byteOffset,u=new e.Matrix4x4,p=a.count/i.count,l=[];if(1===p)var _=l[0]=new e.AnimationClip;else for(var c=0;c<p;++c)l[c]=new e.AnimationClip;for(var f=0;f<i.count;++f){var d;switch(a.numComponents){case 1:for(d=[],c=0;c<p;++c)d[c]=this._readFloat(n,h+4*c);break;case 3:if(d=this._readFloat3(n,h),r){d.x=-d.x;var m=d.y;d.y=d.z,d.z=m}break;case 4:d=this._readQuat(n,h),r&&(u.fromQuaternion(d),u.prepend(this._flipCoord),u.append(this._flipCoord),d.fromMatrix(u));break;default:throw new Error("Unsupported animation sampler type")}var g,y=1e3*this._readFloat(s,o);if(1===p)g=new e.KeyFrame(y,d),_.addKeyFrame(g);else for(c=0;c<p;++c)g=new e.KeyFrame(y,d[c]),l[c].addKeyFrame(g);h+=a.numComponents*p*4,o+=4}return l},i.prototype._parseAnimations=function(){var t=this._gltf.animations;if(t)for(var r=0;r<t.length;++r){for(var i=t[r],a=new e.LayeredAnimation,s=0;s<i.channels.length;++s)for(var n=this._parseAnimationChannel(i.channels[s],i.samplers),o=0;o<n.length;++o)a.addLayer(n[o]);a.name=i.name||"animation_"+r,this._target.animations[a.name]=a}},i.prototype._parseAnimationChannel=function(t,r){var i=this._nodes[t.target.node],a=[];switch(void 0!==i._jointIndex&&(i=i._skeletonPose._jointPoses[i._jointIndex]),t.target.path){case"translation":var s=this._parseAnimationSampler(r[t.sampler],!0);a=[new e.AnimationLayerFloat4(i,"position",s[0])];break;case"rotation":s=this._parseAnimationSampler(r[t.sampler],!0),a=[new e.AnimationLayerQuat(i,"rotation",s[0])];break;case"scale":s=this._parseAnimationSampler(r[t.sampler],!1),a=[new e.AnimationLayerFloat4(i,"scale",s[0])];break;case"weights":s=this._parseAnimationSampler(r[t.sampler],!1),a=[];for(var n=0;n<s.length;++n)a.push(new e.AnimationLayerMorphTarget(i.getFirstComponentByType(e.MorphAnimation),"morphTarget_"+n,s[n]));break;default:throw new Error("Unknown channel path!")}return a},i.prototype._playAnimations=function(){var t=this._target.animations;e.ArrayUtils.forEach(t,function(t){t.play()})},i.prototype._readFloat3=function(t,r){var i=new e.Float4;return i.x=t.getFloat32(r,!0),i.y=t.getFloat32(r+4,!0),i.z=t.getFloat32(r+8,!0),i},i.prototype._readQuat=function(t,r){var i=new e.Quaternion;return i.x=t.getFloat32(r,!0),i.y=t.getFloat32(r+4,!0),i.z=t.getFloat32(r+8,!0),i.w=t.getFloat32(r+12,!0),i},i.prototype._readFloat=function(t,e){return t.getFloat32(e,!0)},i.prototype._readMatrix4x4=function(t,r){for(var i=[],a=0;a<16;++a)i[a]=t.getFloat32(r,!0),r+=4;return new e.Matrix4x4(i)},a.prototype={bind:function(t,e){this._lookUp[t]=this._listeners.length;var r=e?t.bind(e):t;this._listeners.push(r)},unbind:function(t){var e=this._lookUp[t];void 0!==e&&(this._listeners.splice(e,1),delete this._lookUp[t])},unbindAll:function(){this._listeners=[],this._lookUp={}},dispatch:function(t){for(var e=this._listeners.length,r=0;r<e;++r)this._listeners[r].apply(null,arguments)},get hasListeners(){return this._listeners.length>0}},s.prototype={queue:function(t,e){var r=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);this._queue.push({func:t,args:r.slice(1)})},addChildQueue:function(t){this._childQueues.push(t)},execute:function(){if(this._isRunning)throw new Error("Already running!");this._isRunning=!0,this._currentIndex=0,this._executeTask()},_executeTask:function(){setTimeout(this._executeImpl.bind(this))},_executeImpl:function(){if(this.onProgress.dispatch(this._currentIndex/this._queue.length),this._childQueues.length>0){var t=this._childQueues.shift();t.onComplete.bind(this._executeImpl,this),t.execute()}else if(this._queue.length===this._currentIndex)this.onComplete.dispatch();else{var e=this._queue[this._currentIndex];e.func.apply(this,e.args),++this._currentIndex,this._executeTask()}}},n.prototype=Object.create(e.Importer.prototype),n.prototype.parse=function(t,e){for(var r=t.split("\n"),i=r.length,a=0;a<i;++a){var s=r[a].replace(/^\s+|\s+$/g,"");this._parseLine(s,e)}this._loadTextures(e)},n.prototype._parseLine=function(t,r){if(0!==t.length&&"#"!==t.charAt(0)){var i=t.split(/\s+/);switch(i[0].toLowerCase()){case"newmtl":this._activeMaterial=new e.BasicMaterial,this._activeMaterial.name=i[1],r[i[1]]=this._activeMaterial;break;case"ns":var a=parseFloat(i[1]);this._activeMaterial.roughness=e.BasicMaterial.roughnessFromShininess(a),this._activeMaterial.roughnessRange=this._activeMaterial.roughness;break;case"kd":this._activeMaterial.color=new e.Color(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));break;case"map_kd":this._activeMaterial.colorMap=this._getTexture(i[1]);break;case"map_d":this._activeMaterial.maskMap=this._getTexture(i[1]),this._activeMaterial.alphaThreshold=.5;break;case"map_ns":this._activeMaterial.specularMap=this._getTexture(i[1]);break;case"map_bump":case"bump":this._activeMaterial.normalMap=this._getTexture(i[1])}}},n.prototype._getTexture=function(t){if(!this._textures[t]){var r=new e.Texture2D;this._textures[t]=r,this._texturesToLoad.push({file:this._correctURL(t),importer:e.JPG,target:r})}return this._textures[t]},n.prototype._loadTextures=function(t){var r=new e.AssetLibrary(null,this.options.crossOrigin);r.fileMap=this.fileMap;var i=this._texturesToLoad,a=i.length;if(0===a)return void this._notifyComplete(t);for(var s=0;s<i.length;++s)r.queueAsset(i[s].file,i[s].file,e.AssetLibrary.Type.ASSET,i[s].importer,this.options,i[s].target);r.onComplete.bind(function(){this._notifyComplete(t)},this),r.onProgress.bind(function(t){this._notifyProgress(t)},this),r.load(i)},o.prototype=Object.create(e.Importer.prototype),o.prototype.parse=function(t,e){this._groupsAsObjects=void 0===this.options.groupsAsObjects||this._groupsAsObjects,this._target=e;var r=t.split("\n"),i=r.length;this._pushNewObject("hx_default");for(var a=0;a<i;++a){var s=r[a].replace(/^\s+|\s+$/g,"");this._parseLine(s)}this._mtlLibFile?this._loadMTLLib(this._mtlLibFile):this._finish(null)},o.prototype._finish=function(t){for(var e=new s,r=this._objects.length,i=0;i<r;++i)e.queue(this._translateObject.bind(this),i,t);e.queue(this._notifyComplete.bind(this),this._target),e.execute()},o.prototype._loadMTLLib=function(t){var r=new e.AssetLoader(n),i=this;r.onComplete=function(t){i._finish(t)},r.onProgress=function(t){i._notifyProgress(.8*t)},r.onFail=function(t){i._notifyFailure(t)},r.load(t)},o.prototype._parseLine=function(t){if(0!==t.length&&"#"!==t.charAt(0)){var e=t.split(/\s+/);switch(e[0].toLowerCase()){case"mtllib":this._mtlLibFile=this._correctURL(e[1]);break;case"usemtl":this._setActiveSubGroup(e[1]);break;case"v":this._vertices.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"vt":this._uvs.push(parseFloat(e[1]),parseFloat(e[2]));break;case"vn":this._normals.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"o":this._pushNewObject(e[1]);break;case"g":this._groupsAsObjects?this._pushNewObject(e[1]):this._pushNewGroup(e[1]);break;case"f":this._parseFaceData(e)}}},o.prototype._pushNewObject=function(t){this._activeObject=new o._ObjectData,this._activeObject.name=t,this._objects.push(this._activeObject),this._pushNewGroup("hx_default")},o.prototype._pushNewGroup=function(t){this._activeGroup=new o._GroupData,this._activeGroup.name=t||"Group"+this._activeGroup.length,this._activeObject.groups.push(this._activeGroup),this._setActiveSubGroup("hx_default")},o.prototype._setActiveSubGroup=function(t){this._activeGroup.subgroups[t]=this._activeGroup.subgroups[t]||new o._SubGroupData,this._activeSubGroup=this._activeGroup.subgroups[t]},o.prototype._parseFaceData=function(t){for(var e=new o._FaceData,r=t.length,i=1;i<r;++i){var a=new o._FaceVertexData;e.vertices.push(a);var s=t[i].split("/"),n=3*(s[0]-1);a.posX=this._vertices[n],a.posY=this._vertices[n+1],a.posZ=this._vertices[n+2],s.length>1&&(n=2*(s[1]-1),a.uvU=this._uvs[n],a.uvV=this._uvs[n+1],s.length>2&&(n=3*(s[2]-1),this._hasNormals=!0,a.normalX=this._normals[n],a.normalY=this._normals[n+1],a.normalZ=this._normals[n+2]))}this._activeSubGroup.faces.push(e),this._activeSubGroup.numIndices+=4===t.length?3:6},o.prototype._translateObject=function(t,r){var i=this._objects[t],a=i.groups.length;if(0!==a){for(var s=new e.Entity,n=0;n<a;++n){var o=i.groups[n];for(var h in o.subgroups)if(o.subgroups.hasOwnProperty(h)){var u=o.subgroups[h];if(0===u.numIndices)continue;var p=r?r[h]:null;p=p||this._defaultMaterial;var l=this._translateMesh(u),_=new e.MeshInstance(l,p);s.addComponent(_)}}s.name=i.name,this._target.attach(s),this._notifyProgress(.8+(t+1)/this._objects.length*.2)}},o.prototype._translateMesh=function(t){for(var r=e.Mesh.createDefaultEmpty(),i=[],a=new Array(t.numIndices),s=0,n=0,o=t.faces,h=o.length,u=0;u<h;++u){for(var p=o[u],l=p.vertices,_=l.length,c=0;c<_;++c){var f=l[c],d=f.getHash();i.hasOwnProperty(d)||(i[d]={index:s++,vertex:f})}a[n]=i[l[0].getHash()].index,a[n+1]=i[l[2].getHash()].index,a[n+2]=i[l[1].getHash()].index,n+=3,4===_&&(a[n]=i[l[0].getHash()].index,a[n+1]=i[l[3].getHash()].index,a[n+2]=i[l[2].getHash()].index,n+=3)}var m=new Array(s*e.Mesh.DEFAULT_VERTEX_SIZE);for(d in i)if(i.hasOwnProperty(d)){var g=i[d],y=g.vertex,v=g.index*e.Mesh.DEFAULT_VERTEX_SIZE;m[v]=y.posX,m[v+1]=y.posY,m[v+2]=y.posZ,m[v+3]=y.normalX,m[v+4]=y.normalY,m[v+5]=y.normalZ,m[v+6]=0,m[v+7]=0,m[v+8]=0,m[v+9]=1,m[v+10]=y.uvU,m[v+11]=y.uvV}r.setVertexData(m,0),r.setIndexData(a);var w=e.NormalTangentGenerator.MODE_TANGENTS;this._hasNormals||(w|=e.NormalTangentGenerator.MODE_NORMALS);var b=new e.NormalTangentGenerator;return b.generate(r,w,!0),r},o._FaceVertexData=function(){this.posX=0,this.posY=0,this.posZ=0,this.uvU=0,this.uvV=0,this.normalX=0,this.normalY=0,this.normalZ=0,this._hash=""},o._FaceVertexData.prototype={getHash:function(){return this._hash||(this._hash=this.posX+"/"+this.posY+"/"+this.posZ+"/"+this.uvU+"/"+this.uvV+"/"+this.normalX+"/"+this.normalY+"/"+this.normalZ+"/"),this._hash}},o._FaceData=function(){this.vertices=[]},o._SubGroupData=function(){this.numIndices=0,this.faces=[]},o._GroupData=function(){this.subgroups=[],this.name="",this._activeMaterial=null},o._ObjectData=function(){this.name="",this.groups=[],this._activeGroup=null},h.prototype=Object.create(HX.Importer.prototype),h.prototype.parse=function(t,e){var r=JSON.parse(t);if("BufferGeometry"!==r.type)throw new Error("JSON does not contain correct BufferGeometry data! (type property is not BufferGeometry)");var i=HX.Mesh.createDefaultEmpty();this.parseAttributes(r.data.attributes,i),this.parseIndices(r.data.index,i);var a=r.data.attributes.normal?HX.NormalTangentGenerator.MODE_NORMALS:0;if(a|=r.data.attributes.tangent?HX.NormalTangentGenerator.MODE_TANGENTS:0){var s=new HX.NormalTangentGenerator;s.generate(i,a)}e.addMesh(i),this._notifyComplete(e)},h.prototype.parseAttributes=function(t,e){var r={position:"hx_position",normal:"hx_normal",tangent:"hx_tangent",uv:"hx_texCoord"},i=t.position.array.length/t.position.itemSize;for(var a in t)if(t.hasOwnProperty(a)&&!r.hasOwnProperty(a)&&(e.addVertexAttribute(a,t[a].itemSize),"Float32Array"!==t[a].type))throw new Error("Unsupported vertex attribute data type!");var s=e.getVertexStride(0),n=new Float32Array(i*s);for(a in t)if(t.hasOwnProperty(a)){var o=t[a],h=r[a]||a,u=e.getVertexAttributeByName(h),p=o.itemSize,l=0,_=o.array.length,c=u.offset,f=!1;for("position"!==a&&"normal"!==a&&"tangent"!==a||(f=!0);l<_;){for(var d=0;d<p;++d)n[c+d]=o.array[l++];if(f){var m=n[c+1],g=n[c+2];n[c+1]=g,n[c+2]=m}c+=s}}e.setVertexData(n,0)},h.prototype.parseIndices=function(t,e){var r;switch(t.type){case"Uint16Array":r=new Uint16Array(t.array);break;case"Uint32Array":r=new Uint32Array(t.array);break;default:throw new Error("Unsupported index type "+t.type)}e.setIndexData(r)},u.LITTLE_ENDIAN=!0,u.BIG_ENDIAN=!1,u.prototype={get offset(){return this._offset},set offset(t){this._offset=t},get endian(){return this._endian},set endian(t){this._endian=t},get byteLength(){return this._dataView.byteLength},get bytesAvailable(){return this._dataView.byteLength-this._offset},writeChar:function(t){return this.writeUint8(t.charCodeAt(0))},writeUint8:function(t){return this._dataView.setUint8(this._offset++,t)},writeUint16:function(t){var e=this._dataView.setUint16(this._offset,t,this._endian);return this._offset+=2,e},writeUint32:function(t){var e=this._dataView.setUint32(this._offset,t,this._endian);return this._offset+=4,e},writeInt8:function(t){return this._dataView.setInt8(this._offset++,t)},writeInt16:function(t){var e=this._dataView.setInt16(this._offset,t,this._endian);return this._offset+=2,e},writeInt32:function(t){var e=this._dataView.setInt32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat32:function(t){var e=this._dataView.setFloat32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat64:function(t){var e=this._dataView.setFloat64(this._offset,t,this._endian);return this._offset+=8,e},writeString:function(t){for(var e=t.length,r=0;r<e;++r)this.writeUint8(t.charCodeAt(r))},writeUint8Array:function(t){this._writeArray(t,this.writeUint8)},writeUint16Array:function(t){this._writeArray(t,this.writeUint16)},writeUint32Array:function(t){this._writeArray(t,this.writeUint32)},writeInt8Array:function(t){this._writeArray(t,this.writeInt8)},writeInt16Array:function(t){this._writeArray(t,this.writeInt16)},writeInt32Array:function(t){this._writeArray(t,this.writeInt32)},writeFloat32Array:function(t){this._writeArray(t,this.writeFloat32)},writeFloat64Array:function(t){this._writeArray(t,this.writeFloat64)},_writeArray:function(t,e){for(var r=t.length,i=0;i<r;++i)e.call(this,t[i])}},p.VERSION="0.1.0",p.VALUE_TYPE_SKELETON_POSE=1,p.VALUE_TYPE_NUMBER=2,p.VALUE_TYPE_FLOAT3=3,p.VALUE_TYPE_QUATERNION=4,p.prototype={"export":function(t){var e=this._getValueType(t),r=this._calculateFileSize(t,e),i=new ArrayBuffer(r),a=new DataView(i),s=new u(a),n=p.VERSION.split(".");s.writeString("HX_CLIP"),s.writeUint16Array(n),s.writeUint8(e);var o=t.numKeyFrames;if(s.writeUint32(o),e===p.VALUE_TYPE_SKELETON_POSE){var h=t.getKeyFrame(0),l=h.value;s.writeUint8(l.numJoints)}else s.writeUint8(0);for(var _=0;_<o;++_)h=t.getKeyFrame(_),s.writeUint32(h.time),this._writeValue(s,e,h.value);return i},_getValueType:function(t){var e=t.getKeyFrame(0),r=e.value;if(r instanceof HX.SkeletonPose)return p.VALUE_TYPE_SKELETON_POSE;if(r instanceof HX.Float4)return p.VALUE_TYPE_FLOAT3;if(r instanceof HX.Quaternion)return p.VALUE_TYPE_QUATERNION;if("number"==typeof r)return p.VALUE_TYPE_NUMBER;throw new Error("Unsupported animation clip")},_writeValue:function(t,e,r){if(e===p.VALUE_TYPE_SKELETON_POSE)for(var i=r.numJoints,a=0;a<i;++a){var s=r.getJointPose(a);t.writeFloat32(s.position.x),t.writeFloat32(s.position.y),t.writeFloat32(s.position.z),t.writeFloat32(s.rotation.x),t.writeFloat32(s.rotation.y),t.writeFloat32(s.rotation.z),t.writeFloat32(s.rotation.w),t.writeFloat32(s.scale.x),t.writeFloat32(s.scale.y),t.writeFloat32(s.scale.z)}else e===p.VALUE_TYPE_FLOAT3?(t.writeFloat32(r.x),t.writeFloat32(r.y),t.writeFloat32(r.z)):e===p.VALUE_TYPE_QUATERNION?(t.writeFloat32(r.x),t.writeFloat32(r.y),t.writeFloat32(r.z),t.writeFloat32(r.w)):e===p.VALUE_TYPE_NUMBER&&t.writeFloat32(r)},_calculateFileSize:function(t,e){var r=7;r+=6,r+=1,r+=4,r+=1;var i=this._calculateKeyFrameSize(e,t);return r+=t.numKeyFrames*i},_calculateKeyFrameSize:function(t,e){var r=4;if(t===p.VALUE_TYPE_SKELETON_POSE){var i=e.getKeyFrame(0).value.numJoints;r+=10*i*4}else t===p.VALUE_TYPE_FLOAT3?r+=12:t===p.VALUE_TYPE_QUATERNION?r+=16:t===p.VALUE_TYPE_NUMBER&&(r+=4);return r}},l.VERSION="0.1.0",l.prototype={"export":function(t){var e=this._calculateFileSize(t),r=new ArrayBuffer(e),i=new DataView(r),a=new u(i),s=l.VERSION.split(".");return a.writeString("HX_MESH"),a.writeUint16Array(s),this._writeMeshData(a,t),this._writeSkeleton(a,t.skeleton),r},_writeMeshData:function(t,e){t.writeUint32(e.numIndices),e._indexType===HX.DataType.UNSIGNED_INT?(t.writeUint8(32),t.writeUint32Array(e.getIndexData())):(t.writeUint8(16),t.writeUint16Array(e.getIndexData())),t.writeUint32(e.numVertices),t.writeUint8(e.numVertexAttributes);for(var r=0;r<e.numVertexAttributes;++r){var i=e.getVertexAttributeByIndex(r);t.writeUint8(i.name.length),t.writeString(i.name),t.writeUint8(i.streamIndex),t.writeUint8(i.numComponents)}for(t.writeUint8(e.numStreams),r=0;r<e.numStreams;++r){var a=e.getVertexData(r);t.writeUint32(a.length),t.writeFloat32Array(a)}},_writeSkeleton:function(t,e){var r=e?e.numJoints:0;t.writeUint8(r);for(var i=0;i<r;++i){var a=e.getJoint(i);a.name?(t.writeUint8(a.name.length),t.writeString(a.name)):t.writeUint8(0),t.writeUint8(a.parentIndex===-1?255:a.parentIndex),t.writeFloat32Array(a.inverseBindPose._m)}},_calculateFileSize:function(t){var e=7;e+=6,e+=4,e+=1;var r;r=t._indexType===HX.DataType.UNSIGNED_INT?4:2,e+=r*t.numIndices,e+=4,e+=1;for(var i=0;i<t.numVertexAttributes;++i){var a=t.getVertexAttributeByIndex(i);e+=1,e+=a.name.length,e+=1,e+=1}for(e+=1,i=0;i<t.numStreams;++i)e+=4,e+=4*t.getVertexData(i).length;e+=1;for(var s=t.skeleton?t.skeleton.numJoints:0,n=0;n<s;++n){var o=t.skeleton.getJoint(n);e+=1,e+=o.name?o.name.length:0,e+=1,e+=64}return e}},t.GLTF=i,t.GLTFData=r,t.OBJ=o,t.MTL=n,t.THREEBufferGeometry=h,t.AnimationClipExporter=p,t.MeshExporter=l,Object.defineProperty(t,"__esModule",{value:!0})});