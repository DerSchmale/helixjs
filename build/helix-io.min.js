HX.FbxObject=function(){this.name=null,this.UID=null,this.parent=null,this.data=null},HX.FbxObject.prototype={connectObject:function(e){throw new Error("Unhandled object connection "+e.toString()+" -> "+this.toString())},connectProperty:function(e,t){},copyProperties:function(e){for(var t in e)if(this.hasOwnProperty(t)&&void 0!==e[t]&&null!==e[t]){var i=t.charAt(0);i.toUpperCase()===i&&(this[t]=e[t])}}},HX.FbxObject.prototype.toString=function(){return"[FbxObject(name="+this.name+")]"},HX.FbxNode=function(){HX.FbxObject.call(this),this.RotationOffset=null,this.RotationPivot=null,this.ScalingOffset=null,this.ScalingPivot=null,this.RotationOrder=0,this.PreRotation=null,this.PostRotation=null,this.InheritType=0,this.GeometricTranslation=null,this.GeometricRotation=null,this.GeometricScaling=null,this["Lcl Translation"]=null,this["Lcl Rotation"]=null,this["Lcl Scaling"]=null,this.Visibility=!0,this.type=null,this.children=null,this.skeleton=null,this.defaultAttribute=null,this.attributes=null,this.mesh=null,this.materials=null,this.animationCurveNodes=null,this._geometricMatrix=null,this._matrix=null},HX.FbxNode.prototype=Object.create(HX.FbxObject.prototype,{numChildren:{get:function(){return this.children?this.children.length:0}},geometryTransform:{get:function(){if(!this._geometricMatrix&&(this._geometricMatrix=new HX.Matrix4x4,this.GeometricRotation||this.GeometricScaling||this.GeometricTranslation)){var e=new HX.Transform;if(this.GeometricRotation){var t=new HX.Quaternion;t.fromEuler(this.GeometricRotation.x*HX.DEG_TO_RAD,this.GeometricRotation.y*HX.DEG_TO_RAD,this.GeometricRotation.z*HX.DEG_TO_RAD),e.rotation=t}this.GeometricScaling&&(e.scale=this.GeometricScaling),this.GeometricTranslation&&(e.position=this.GeometricTranslation),this._geometricMatrix.copyFrom(e.matrix)}return this._geometricMatrix}},matrix:{get:function(){if(!this._matrix){this._matrix=new HX.Matrix4x4;var e=this._matrix;this.ScalingPivot&&e.appendTranslation(HX.Float4.negate(this.ScalingPivot));var t=this["Lcl Scaling"];t&&e.appendScale(t.x,t.y,t.z),this.ScalingPivot&&e.appendTranslation(this.ScalingPivot),this.ScalingOffset&&e.appendTranslation(this.ScalingOffset),this.RotationPivot&&e.appendTranslation(HX.Float4.negate(this.RotationPivot)),this.PreRotation&&e.appendQuaternion(this._convertRotation(this.PreRotation)),this["Lcl Rotation"]&&e.appendQuaternion(this._convertRotation(this["Lcl Rotation"])),this.PostRotation&&e.appendQuaternion(this._convertRotation(this.PostRotation)),this.RotationPivot&&e.appendTranslation(this.RotationPivot),this.RotationOffset&&e.appendTranslation(this.RotationOffset),this["Lcl Translation"]&&e.appendTranslation(this["Lcl Translation"])}return this._matrix}}}),HX.FbxNode.prototype.getChild=function(e){return this.children[e]},HX.FbxNode.prototype.connectObject=function(e){if(e instanceof HX.FbxNode)"Root"===e.type?this.skeleton=e:(this.children=this.children||[],this.children.push(e),e.parent=this);else if(e instanceof HX.FbxNodeAttribute)this.defaultAttribute=this.defaultAttribute||e,this.attributes=this.attributes||[],this.attributes.push(e);else if(e instanceof HX.FbxMesh)this.mesh=e,this.mesh.parent=this;else if(e instanceof HX.FbxMaterial)this.materials=this.materials||[],this.materials.push(e);else if(!(e instanceof HX.FbxTrashNode))throw new Error("Incompatible child object "+e.toString()+" for "+this.type)},HX.FbxNode.prototype._convertRotation=function(e){var t=new HX.Quaternion;return t.fromEuler(e.x*HX.DEG_TO_RAD,e.y*HX.DEG_TO_RAD,e.z*HX.DEG_TO_RAD),t},HX.FbxNode.prototype.connectProperty=function(e,t){e instanceof HX.FbxAnimationCurveNode&&(this.animationCurveNodes=this.animationCurveNodes||{},this.animationCurveNodes[t]=e,e.propertyName=t)},HX.FbxNode.prototype.toString=function(){return"[FbxNode(name="+this.name+", type="+this.type+")]"},HX.FBX=function(){HX.Importer.call(this,HX.SceneNode,HX.Importer.TYPE_BINARY),this._rootNode=null},HX.FBX.prototype=Object.create(HX.Importer.prototype),HX.FBX.prototype.parse=function(e,t){var i=new HX.DataStream(e),n=new HX.FBXBinaryDeserializer,a=new HX.FBXGraphBuilder,r=new HX.FBXConverter,s=new HX.FBXSettings;try{var o,l=Date.now(),h=n.deserialize(i);if(o=Date.now(),console.log("Serialization: "+(o-l)),l=o,s.init(h),n.version<7e3)throw new Error("Unsupported FBX version!");a.build(h,s),o=Date.now(),console.log("Graph building: "+(o-l)),l=o,r.convert(a.sceneRoot,a.animationStack,t,s),o=Date.now(),console.log("Conversion: "+(o-l))}catch(c){return console.log(c.stack),void this._notifyFailure(c.message)}r.textureTokens.length>0?this._loadTextures(r.textureTokens,r.textureMaterialMap,t):this._notifyComplete(t)},HX.FBX.prototype._loadTextures=function(e,t,i){var n=e.length;this._textureLibrary=new HX.AssetLibrary;for(var a=0;a<n;++a){var r=e[a];r.filename=this._correctURL(r.filename),this._textureLibrary.queueAsset(r.filename,r.filename,HX.AssetLibrary.Type.ASSET,HX.JPG)}this._textureLibrary.onComplete.bind(function(){for(var e=t.length,n=0;n<e;++n){var a=t[n],r=a.token,s=this._textureLibrary.get(r.filename);switch(s.name=r.name,a.mapType){case HX.FBXConverter._TextureToken.NORMAL_MAP:a.material.normalMap=s;break;case HX.FBXConverter._TextureToken.SPECULAR_MAP:a.material.specularMap=s;break;case HX.FBXConverter._TextureToken.DIFFUSE_MAP:a.material.colorMap=s}}this._notifyComplete(i)},this),this._textureLibrary.load()},HX.FBXAnimationConverter=function(){this._skinningData=null,this._jointUIDLookUp=null,this._skeleton=null,this._fakeJointIndex=-1,this._animationClips=null,this._frameRate=24},HX.FBXAnimationConverter.prototype={get skeleton(){return this._skeleton},get animationClips(){return this._animationClips},get fakeJointIndex(){return this._fakeJointIndex},getJointBinding:function(e){return this._skinningData[e]},convertSkin:function(e,t){this._skeleton=new HX.Skeleton,this._skinningData=[],this._jointUIDLookUp={};for(var i=e.clusters.length,n=0;n<i;++n){var a=e.clusters[n];this._addJointsToSkeleton(this._getRootNodeForCluster(a));var r=this._jointUIDLookUp[a.limbNode.UID];this._assignInverseBindPose(a,t,r.joint),this._assignJointBinding(a,r.index)}var s=new HX.SkeletonJoint;this._fakeJointIndex=this._skeleton.numJoints,this._skeleton.addJoint(s);for(var o in this._jointUIDLookUp)this._jointUIDLookUp[o].fbxNode.data=null},convertClips:function(e,t,i,n){this._frameRate=n.frameRate,this._animationClips=[];for(var a=0;a<e.layers.length;++a)for(var r=e.LocalStop.getFrameCount(this._frameRate)-e.LocalStart.getFrameCount(this._frameRate)+1,s=e.layers,o=0;o<s.length;++o){var l=this._convertLayer(s[o],r);this._animationClips.push(l)}},_addJointsToSkeleton:function(e){e.data!==!0&&(e.data=!0,this._convertSkeletonNode(e,-1))},_convertSkeletonNode:function(e,t){var i=new HX.SkeletonJoint;i.parentIndex=t;var n=this._skeleton.numJoints;if(this._skeleton.addJoint(i),this._jointUIDLookUp[e.UID]={joint:i,index:n,fbxNode:e},e.animationCurveNodes)for(var a in e.animationCurveNodes)if(e.animationCurveNodes.hasOwnProperty(a)){var r=e.animationCurveNodes[a];r.data=n}for(var s=0;s<e.numChildren;++s)this._convertSkeletonNode(e.getChild(s),n)},_assignJointBinding:function(e,t){if(e.indices)for(var i=e.indices.length,n=0;n<i;++n)if(e.weights[n]>0){var a=e.indices[n],r=this._skinningData[a]=this._skinningData[a]||[],s=new HX.FBXModelInstanceConverter._JointBinding;s.jointIndex=t,s.jointWeight=e.weights[n],r.push(s)}},_assignInverseBindPose:function(e,t,i){i.inverseBindPose.copyFrom(e.transformLink),i.inverseBindPose.invertAffine(),i.inverseBindPose.prependAffine(e.transform),i.inverseBindPose.prependAffine(t)},_getLimbGlobalMatrix:function(e){if(!e._globalMatrix)if(e._globalMatrix=new HX.Matrix4x4,e.parent&&"LimbNode"===e.parent.type){var t=this._getLimbGlobalMatrix(e.parent);e._globalMatrix.multiply(t,e.matrix)}else e._globalMatrix.copyFrom(e.matrix);return e._globalMatrix},_getRootNodeForCluster:function(e){for(var t=e.limbNode;t;){if("LimbNode"!==t.type)return t;t=t.parent}throw new Error("No Root node found!")},_convertLayer:function(e,t){var i=new HX.SkeletonClip;i.frameRate=this._frameRate,this._convertToFrames(e,t);for(var n=0;n<t;++n)i.addFrame(this._convertFrame(e,n));return i},_convertToFrames:function(e,t){for(var i=e.curveNodes.length,n=0;n<i;++n){var a=e.curveNodes[n];for(var r in a.curves)if(a.curves.hasOwnProperty(r)){var s=a.curves[r];this._convertCurveToFrames(s,t)}}},_convertCurveToFrames:function(e,t){for(var i=0,n=0,a=1e3/this._frameRate,r=e.KeyTime.length,s=[],o=0;o<t;++o){for(i+=a;n<r&&e.KeyTime[n].milliseconds<i;)++n;if(0===n)s.push(e.KeyValueFloat[n]);else if(n===r)s.push(e.KeyValueFloat[n-1]);else{var l=e.KeyTime[n].milliseconds,h=e.KeyTime[n-1].milliseconds,c=(i-h)/(l-h),u=e.KeyValueFloat[n],p=e.KeyValueFloat[n-1];s.push(p+(u-p)*c)}}e.data=s},_convertFrame:function(e,t){for(var i=new HX.SkeletonPose,n=this._skeleton.numJoints,a=e.curveNodes.length,r=[],s=0;s<n;++s){var o=this._skeleton.getJoint(s),l=o.inverseBindPose.clone();if(l.invertAffine(),o.parentIndex!==-1){var h=this._skeleton.getJoint(o.parentIndex).inverseBindPose;l.appendAffine(h)}var c=new HX.FBXAnimationConverter._JointPose,u=new HX.Transform;l.decompose(u),c["Lcl Translation"].copyFrom(u.position),u.rotation.toEuler(c["Lcl Rotation"]),c["Lcl Rotation"].x*=HX.RAD_TO_DEG,c["Lcl Rotation"].y*=HX.RAD_TO_DEG,c["Lcl Rotation"].z*=HX.RAD_TO_DEG,c["Lcl Scaling"].copyFrom(u.scale),r[s]=c}for(var s=0;s<a;++s){var p=e.curveNodes[s],_=p.data;if(null!==_){var d=r[_][p.propertyName];for(var m in p.curves)if(p.curves.hasOwnProperty(m)){var f=p.curves[m].data[t];switch(m){case"d|X":d.x=f;break;case"d|Y":d.y=f;break;case"d|Z":d.z=f}}}}for(var s=0;s<n;++s){var X=new HX.SkeletonJointPose,v=r[s];X.position.copyFrom(v["Lcl Translation"]),X.scale.copyFrom(v["Lcl Scaling"]);var b=v["Lcl Rotation"];X.rotation.fromEuler(b.x*HX.DEG_TO_RAD,b.y*HX.DEG_TO_RAD,b.z*HX.DEG_TO_RAD),i.jointPoses[s]=X}return i.jointPoses[this._fakeJointIndex]=new HX.SkeletonJointPose,i}},HX.FBXAnimationConverter._JointPose=function(){this["Lcl Translation"]=new HX.Float4(0,0,0),this["Lcl Rotation"]=new HX.Float4(0,0,0),this["Lcl Scaling"]=new HX.Float4(1,1,1)},HX.FBXBinaryDeserializer=function(){this._version=0},HX.FBXBinaryDeserializer.prototype={get version(){return this._version},deserialize:function(e){this._data=e,this._verifyHeader(),26!==this._data.getUint16()&&console.log("Suspected oddity with FBX file"),this._version=this._data.getUint32();var t=new HX.FBXRecord;return t.name="[root]",this._deserializeNode(t),t},_verifyHeader:function(){if("Kaydara FBX Binary  \0"!==this._data.getString(21))throw new Error("Incorrect FBX file header!")},_deserializeNode:function(e){var t;do t=this._importNode(),t&&e.children.push(t);while(t)},_importNode:function(){var e=this._data,t=e.getUint32(),i=e.getUint32(),n=e.getUint32(),a=e.getUint8();if(0===t){if(0!==i||0!==n||0!==a)throw new Error("Invalid null node!");return null}var r=new HX.FBXRecord;r.name=e.getString(a);for(var s=0;s<i;++s){var o=this._parseDataElement();r.data.push(o)}return e.offset!==t&&this._deserializeNode(r),r},_parseDataElement:function(){var e=this._data.getChar();switch(e){case HX.FBXBinaryDeserializer.BOOLEAN:return this._data.getUint8();case HX.FBXBinaryDeserializer.INT16:return this._data.getInt16();case HX.FBXBinaryDeserializer.INT32:return this._data.getInt32();case HX.FBXBinaryDeserializer.INT64:return this._data.getInt64AsFloat64();case HX.FBXBinaryDeserializer.FLOAT:return this._data.getFloat32();case HX.FBXBinaryDeserializer.DOUBLE:return this._data.getFloat64();case HX.FBXBinaryDeserializer.STRING:var t=this._data.getUint32();return this._data.getString(t);case HX.FBXBinaryDeserializer.RAW:var t=this._data.getUint32();return this._data.getUint8Array(t);default:return this._parseArray(e)}},_parseArray:function(e){var t=this._data.getUint32(),i=this._data.getUint32(),n=this._data.getUint32();if(0===i)switch(e){case HX.FBXBinaryDeserializer.BOOLEAN_ARRAY:return this._data.getUint8Array(t);case HX.FBXBinaryDeserializer.INT32_ARRAY:return this._data.getInt32Array(t);case HX.FBXBinaryDeserializer.INT64_ARRAY:return this._data.getInt64AsFloat64Array(t);case HX.FBXBinaryDeserializer.FLOAT_ARRAY:return this._data.getFloat32Array(t);case HX.FBXBinaryDeserializer.DOUBLE_ARRAY:return this._data.getFloat64Array(t);default:throw new Error("Unknown data type code "+e)}else{var a=this._data.getUint8Array(n);switch(a=pako.inflate(a).buffer,e){case HX.FBXBinaryDeserializer.BOOLEAN_ARRAY:return new Uint8Array(a.buffer);case HX.FBXBinaryDeserializer.INT32_ARRAY:return new Int32Array(a);case HX.FBXBinaryDeserializer.INT64_ARRAY:var a=new HX.DataStream(new DataView(a));return a.getInt64AsFloat64Array(a.byteLength/8);case HX.FBXBinaryDeserializer.FLOAT_ARRAY:return new Float32Array(a);case HX.FBXBinaryDeserializer.DOUBLE_ARRAY:return new Float64Array(a);default:throw new Error("Unknown data type code "+e)}}}},HX.FBXBinaryDeserializer.INT16="Y",HX.FBXBinaryDeserializer.BOOLEAN="C",HX.FBXBinaryDeserializer.INT32="I",HX.FBXBinaryDeserializer.FLOAT="F",HX.FBXBinaryDeserializer.DOUBLE="D",HX.FBXBinaryDeserializer.INT64="L",HX.FBXBinaryDeserializer.BOOLEAN_ARRAY="b",HX.FBXBinaryDeserializer.INT32_ARRAY="i",HX.FBXBinaryDeserializer.FLOAT_ARRAY="f",HX.FBXBinaryDeserializer.DOUBLE_ARRAY="d",HX.FBXBinaryDeserializer.INT64_ARRAY="l",HX.FBXBinaryDeserializer.STRING="S",HX.FBXBinaryDeserializer.RAW="R",HX.FBXConverter=function(){this._settings=null,this._objects=null,this._textureTokens=null,this._textureMaterialMap=null,this._rootNode=null},HX.FBXConverter.prototype={get textureTokens(){return this._textureTokens},get textureMaterialMap(){return this._textureMaterialMap},convert:function(e,t,i,n){this._settings=n,this._objects=[],this._textureTokens=[],this._textureMaterialMap=[],this._rootNode=e,this._animationStack=t,this._convertSceneNode(e,i)},_convertNode:function(e){var t;if(e.mesh)t=this._convertModelMesh(e);else{if(!(e.children&&e.children.length>1))return null;t=new HX.SceneNode,this._convertSceneNode(e,t)}return t.name=e.name,this._convertSceneGraphObject(e,t),t},_convertSceneNode:function(e,t){for(var i=e.children.length,n=0;n<i;++n){var a=this._convertNode(e.children[n]);a&&t.attach(a)}},_convertModelMesh:function(e){var t=this._convertGeometry(e.mesh,e.geometryTransform),i=[];if(e.materials)for(var n=e.materials.length,a=0;a<n;++a)i[a]=this._convertMaterial(e.materials[a]);else i.push(new HX.BasicMaterial);return t.createModelInstance(i)},_convertSceneGraphObject:function(e,t){t.matrix=e.matrix},_convertGeometry:function(e,t){if(this._objects[e.UID])return this._objects[e.UID];var i=new HX.FBXModelInstanceConverter;return i.convertToModel(e,this._animationStack,t,this._settings),this._objects[e.UID]=i,i},_convertMaterial:function(e){if(this._objects[e.UID])return this._objects[e.UID];var t=new HX.BasicMaterial;return t.name=e.name,e.DiffuseColor&&(t.color=e.DiffuseColor),e.Shininess&&(e.ShininessExponent=e.Shininess),e.ShininessExponent&&(t.roughness=HX.BasicMaterial.roughnessFromShininess(e.Shininess)),e.textures&&(e.textures.NormalMap&&this._convertTexture(e.textures.NormalMap,t,HX.FBXConverter._TextureToken.NORMAL_MAP),e.textures.SpecularColor&&this._convertTexture(e.textures.SpecularColor,t,HX.FBXConverter._TextureToken.SPECULAR_MAP),e.textures.DiffuseColor&&this._convertTexture(e.textures.DiffuseColor,t,HX.FBXConverter._TextureToken.DIFFUSE_MAP)),this._objects[e.UID]=t,t},_convertTexture:function(e,t,i){var n;this._objects[e.UID]?n=this._objects[e.UID]:(n=new HX.FBXConverter._TextureToken,n.name=e.name,n.mapType=i,n.filename=e.relativeFilename?e.relativeFilename:e.video.relativeFilename,this._textureTokens.push(n),this._objects[e.UID]=n);var a=new HX.FBXConverter._TextureMaterialMapping(t,n,i);this._textureMaterialMap.push(a)}},HX.FBXConverter._TextureMaterialMapping=function(e,t,i){this.material=e,this.token=t,this.mapType=i},HX.FBXConverter._TextureToken=function(){this.filename=null,this.name=null,this.UID=null},HX.FBXConverter._TextureToken.NORMAL_MAP=0,HX.FBXConverter._TextureToken.SPECULAR_MAP=1,HX.FBXConverter._TextureToken.DIFFUSE_MAP=2,HX.FBXGraphBuilder=function(){this._settings=null,this._templates=null,this._objects=null,this._rootNode=null,this._animationStack=null,this._bindPoses=null},HX.FBXGraphBuilder.prototype={get bindPoses(){return this._bindPoses},get sceneRoot(){return this._rootNode},get animationStack(){return this._animationStack},build:function(e,t){this._settings=t,this._templates={},this._objects={},this._bindPoses=null,this._rootNode=new HX.FbxNode,this._rootNode.name="hx_rootNode",this._animationStack=null,this._processTemplates(e.getChildByName("Definitions")),this._processObjects(e.getChildByName("Objects")),this._processConnections(e.getChildByName("Connections"))},_processTemplates:function(e){for(var t=e.children.length,i=0;i<t;++i){var n=e.children[i];if("ObjectType"===n.name){var a=n.getChildByName("PropertyTemplate");if(!a)continue;var r=a.data[0],s=n.data[0],o=this._createNode(s,r,a);o&&this._assignProperties(o,a.getChildByName("Properties70")),this._templates[s]=o}}},_processObjects:function(e){for(var t=e.children.length,i=0;i<t;++i){var n=null,a=e.children[i];switch(a.name){case"Geometry":n=this._processGeometry(a);break;case"NodeAttribute":n=new HX.FbxNodeAttribute,n.type=a.data[2];break;case"Model":n=new HX.FbxNode,n.type=a.data[2];break;case"Material":n=new HX.FbxMaterial;break;case"Video":n=new HX.FbxVideo;var r=a.getChildByName("RelativeFilename");n.relativeFilename=r?r.data[0]:null;break;case"Texture":n=new HX.FbxFileTexture;var r=a.getChildByName("RelativeFilename");n.relativeFilename=r?r.data[0]:null;break;case"Pose":n=this._processPose(a),this._bindPoses=this._bindPoses||[],this._bindPoses.push(n);break;case"Deformer":n="Skin"===a.data[2]?new HX.FbxSkin:this._processCluster(a);break;case"AnimationStack":n=new HX.FbxAnimStack,this._animationStack=n;break;case"AnimationLayer":n=new HX.FbxAnimLayer;break;case"AnimationCurve":n=new HX.FbxAnimationCurve,this._assignFlatData(n,a);for(var s=[],o=0;o<n.KeyTime.length;++o)s[o]=new HX.FbxTime(n.KeyTime[o]);n.KeyTime=s;break;case"AnimationCurveNode":n=new HX.FbxAnimationCurveNode;break;default:n=new HX.FbxTrashNode}if(n){var l=a.data[0];n.name=this._getObjectDefName(a),n.UID=l,this._templates[a.name]&&n.copyProperties(this._templates[a.name]),this._assignProperties(n,a.getChildByName("Properties70")),this._objects[l]=n}}},_processPose:function(e){var t=new HX.FbxPose;t.type=e.data[2];for(var i=0;i<e.children.length;++i){var n=e.children[i];if("PoseNode"===n.name){var a=new HX.FbxPoseNode;a.targetUID=n.getChildByName("Node").data[0],a.matrix=new HX.Matrix4x4(n.getChildByName("Matrix").data[0]),t.poseNodes.push(a)}}return t},_processConnections:function(e){for(var t=e.children.length,i=0;i<t;++i){var n=e.children[i],a=n.data[0],r=this._objects[n.data[1]],s=this._objects[n.data[2]]||this._rootNode;"OO"===a?s.connectObject(r):"OP"===a&&s.connectProperty(r,n.data[3])}},_createNode:function(e,t){return"Material"===e?new HX.FbxMaterial:HX[t]?new HX[t]:void 0},_assignFlatData:function(e,t){for(var i=t.children.length,n=0;n<i;++n){var a=t.children[n];e.hasOwnProperty(a.name)&&(e[a.name]=a.data[0])}},_assignProperties:function(e,t){if(t)for(var i=t.children.length,n=0;n<i;++n){var a=t.children[n];e.hasOwnProperty(a.data[0])&&(e[a.data[0]]=this._getPropertyValue(a))}},_getPropertyValue:function(e){var t=e.data;switch(t[1]){case"Vector3D":case"Lcl Translation":case"Lcl Scaling":case"Lcl Rotatfion":return new HX.Float4(t[4],t[5],t[6]);case"bool":case"Visibility":case"Visibility Inheritance":return 0!==t[4];case"ColorRGB":case"Color":return new HX.Color(t[4],t[5],t[6]);case"enum":case"double":case"float":case"int":case"KString":return t[4];case"KTime":return new HX.FbxTime(t[4]);case"object":return null}},_processGeometry:function(e){for(var t=new HX.FbxMesh,i=e.children.length,n={},a=0;a<i;++a){var r=e.children[a];switch(r.name){case"Vertices":t.vertices=r.data[0];break;case"PolygonVertexIndex":t.indices=r.data[0];break;case"Layer":t.layerElements=t.layerElements||{},this._processLayer(r,n,t.layerElements);break;default:n[r.name]||(n[r.name]=r)}}return t},_processLayer:function(e,t,i){for(var n=e.children.length,a=0;a<n;++a){var r=e.children[a];if("LayerElement"===r.name){var s=r.getChildByName("Type").data[0];if(!i[r.type]){var r=this._processLayerElement(t[s]);i[r.type]=r}}}},_processLayerElement:function(e){for(var t=new HX.FbxLayerElement,i=e.children.length,n=0;n<i;++n){var a=e.children[n];switch(a.name){case"MappingInformationType":var r=a.data[0];t.mappingInformationType="ByPolygonVertex"===r?HX.FbxLayerElement.MAPPING_TYPE.BY_POLYGON_VERTEX:"ByPolygon"===r?HX.FbxLayerElement.MAPPING_TYPE.BY_POLYGON:"AllSame"===r?HX.FbxLayerElement.MAPPING_TYPE.ALL_SAME:HX.FbxLayerElement.MAPPING_TYPE.BY_CONTROL_POINT;break;case"ReferenceInformationType":t.referenceInformationType="Direct"===a.data[0]?HX.FbxLayerElement.REFERENCE_TYPE.DIRECT:HX.FbxLayerElement.REFERENCE_TYPE.INDEX_TO_DIRECT;break;case"Normals":case"Colors":case"UV":case"Smoothing":t.type=a.name,t.directData=a.data[0];break;case"NormalsIndex":case"ColorIndex":case"UVIndex":case"SmoothingIndex":t.indexData=a.data[0];break;case"Materials":t.type=a.name,t.indexData=a.data[0]}}return t},_getObjectDefName:function(e){return e.data[1].split(HX.FBXGraphBuilder._STRING_DEMARCATION)[0]},_processCluster:function(e){for(var t=new HX.FbxCluster,i=e.children.length,n=0;n<i;++n){var a=e.children[n];switch(a.name){case"Transform":t.transform=new HX.Matrix4x4(a.data[0]);break;case"TransformLink":t.transformLink=new HX.Matrix4x4(a.data[0]);break;case"Indexes":t.indices=a.data[0];break;case"Weights":t.weights=a.data[0]}}return t}},HX.FBXGraphBuilder._STRING_DEMARCATION=String.fromCharCode(0,1),HX.FBXModelInstanceConverter=function(){this._perMaterialData=null,this._expandedMesh=null,this._vertexStride=0,this._ctrlPointLookUp=null,this._model=null,this._animationConverter=null,this._fakeJointIndex=-1,this._useSkinning=!1},HX.FBXModelInstanceConverter.prototype={createModelInstance:function(e){for(var t=[],i=this._modelMaterialIDs.length,n=0;n<i;++n)t[n]=e[this._modelMaterialIDs[n]];var a=new HX.ModelInstance(this._model,t),r=this._animationConverter.animationClips;if(r){if(1!==r.length)throw new Error("TODO! Implement blend node");a.addComponent(new HX.SkeletonAnimation(r[0]))}return a},convertToModel:function(e,t,i,n){this._perMaterialData=[],this._ctrlPointLookUp=[],this._modelMaterialIDs=[],this._useSkinning=!1,this._modelData=new HX.ModelData,this._animationConverter=new HX.FBXAnimationConverter,e.deformers&&this._generateSkinningData(e,i),this._generateExpandedMeshData(e,i),this._vertexStride=HX.MeshData.DEFAULT_VERTEX_SIZE,this._expandedMesh.hasColor&&(this._vertexStride+=3),this._splitPerMaterial(),this._generateModel(),e.deformers&&this._animationConverter.convertClips(t,e,i,n),this._model.name=e.name},_generateExpandedMeshData:function(e,t){this._expandedMesh=new HX.FBXModelInstanceConverter._ExpandedMesh;var i,n,a,r,s=e.indices,o=e.vertices,l=e.layerElements;l&&(i=l.Normals,n=l.Colors,a=l.UV,r=l.Materials);var h=[],c=0,u=0;i&&(this._expandedMesh.hasNormals=!0),n&&(this._expandedMesh.hasColor=!0),a&&(this._expandedMesh.hasUVs=!0);for(var p=s.length,_=0;_<p;++_){var d=s[_],m=new HX.FBXModelInstanceConverter._Vertex;if(d<0&&(d=-d-1,m.lastVertex=!0),m.pos.x=o[3*d],m.pos.y=o[3*d+1],m.pos.z=o[3*d+2],t&&t.transformPoint(m.pos,m.pos),this._modelData.skeleton&&(m.jointBindings=this._animationConverter.getJointBinding(d)),m.ctrlPointIndex=d,i&&(m.normal=this._extractLayerData(i,d,_,3),t&&t.transformVector(m.normal,m.normal)),n&&(m.color=this._extractLayerData(n,d,_,3)),a&&(m.uv=this._extractLayerData(a,d,_,2)),r&&r.mappingInformationType!==HX.FbxLayerElement.MAPPING_TYPE.ALL_SAME){var f=r.indexData[c];m.materialIndex=f,f>u&&(u=f)}m.lastVertex&&++c,h[_]=m}this._expandedMesh.vertices=h,this._expandedMesh.numMaterials=u+1},_extractLayerData:function(e,t,i,n){var a=n>2?new HX.Float4:new HX.Float2;if(e.referenceInformationType===HX.FbxLayerElement.REFERENCE_TYPE.DIRECT){var r=e.mappingInformationType===HX.FbxLayerElement.MAPPING_TYPE.BY_CONTROL_POINT?t:i;a.x=e.directData[r*n],a.y=e.directData[r*n+1],n>2&&(a.z=e.directData[r*n+2])}else{var r=e.mappingInformationType===HX.FbxLayerElement.MAPPING_TYPE.BY_CONTROL_POINT?e.indexData[t]:e.indexData[i];a.x=e.directData[r*n],a.y=e.directData[r*n+1],n>2&&(a.z=e.directData[r*n+2])}return a},_splitPerMaterial:function(){for(var e=0;e<this._expandedMesh.numMaterials;++e)this._perMaterialData[e]=new HX.FBXModelInstanceConverter._PerMaterialData;for(var t,i,n,e=0,a=0,r=this._expandedMesh.vertices,s=r.length,o=!0;e<s;){var l=this._perMaterialData[r[e].materialIndex];if(l.vertices||(o=!0),o&&(o=!1,l.indexCounter=0,l.indices=[],l.vertices=[],l.ctrlPointIndices=[],l.indexLookUp={},l.indexStack.push(l.indices),l.vertexStack.push(l.vertices),l.ctrlPointStack.push(l.ctrlPointIndices),this._useSkinning&&(l.skinning=[],l.skinningStack.push(l.skinning))),t=this._getOrAddIndex(r[e]),t<0)o=!0;else if(i=this._getOrAddIndex(r[e+1]),i<0)o=!0;else{e+=2;var h;do if(h=r[e],n=this._getOrAddIndex(h),n<0)o=!0;else{++e;var c=this._perMaterialData[h.materialIndex].indices;c[a]=t,c[a+1]=i,c[a+2]=n,a+=3,i=n}while(!h.lastVertex&&!o)}}},_getOrAddIndex:function(e){var t=e.getHash(),i=this._perMaterialData[e.materialIndex],n=i.indexLookUp;if(n.hasOwnProperty(t))return n[t];if(i.indexCounter>65535)return-1;var a=i.skinning,r=i.vertices,s=i.indexCounter++,o=s*this._vertexStride,l=8*s;if(i.ctrlPointIndices[e.ctrlPointIndex]=s,n[t]=s,r[o]=e.pos.x,r[o+1]=e.pos.y,r[o+2]=e.pos.z,a){var h=e.jointBindings,c=h?h.length:0;c>4&&(c=4,console.warn("Warning: more than 4 joints not supported. Model will not animate correctly"),h.sort(function(e,t){return t.jointWeight-e.jointWeight}));for(var u=0,p=0;p<c;++p){var _=h[p].jointWeight;a[l+p]=h[p].jointIndex,a[l+p+4]=_,u+=_}u=u>=1?0:1-u;for(var p=c;p<4;++p)a[l+p]=this._fakeJointIndex,a[l+p+4]=p===c?u:0}return this._expandedMesh.hasNormals?(r[o+3]=e.normal.x,r[o+4]=e.normal.y,r[o+5]=e.normal.z):r[o+3]=r[o+4]=r[o+5]=0,r[o+6]=r[o+7]=r[o+8]=r[o+9]=0,this._expandedMesh.hasUVs?(r[o+10]=e.uv.x,r[o+11]=e.uv.y):r[o+10]=r[o+11]=0,this._expandedMesh.hasColor&&(r[o+12]=e.color.x,r[o+13]=e.color.y,r[o+14]=e.color.z),s},_generateModel:function(){for(var e=0,t=this._expandedMesh.numMaterials,i=0;i<t;++i)for(var n=this._perMaterialData[i],a=n.indexStack.length,r=0;r<a;++r){var s=HX.MeshData.createDefaultEmpty();this._expandedMesh.hasColor&&s.addVertexAttribute("hx_vertexColor",3),s.setVertexData(n.vertexStack[r],0),s.setIndexData(n.indexStack[r]),this._useSkinning&&(s.addVertexAttribute("hx_boneIndices",4,1),s.addVertexAttribute("hx_boneWeights",4,1),s.setVertexData(n.skinningStack[r],1));for(var o=n.ctrlPointStack[r],l=o.length,h=0;h<l;++h)this._ctrlPointLookUp[o[h]]={index:h,meshIndex:e};++e,this._modelMaterialIDs.push(i);var c=HX.NormalTangentGenerator.MODE_TANGENTS;this._expandedMesh.hasNormals||(c|=HX.NormalTangentGenerator.MODE_NORMALS);var u=new HX.NormalTangentGenerator;u.generate(s,c),this._modelData.addMeshData(s)}this._model=new HX.Model(this._modelData)},_generateSkinningData:function(e,t){var i=e.deformers.length;if(0!==i){if(i>1)throw new Error("Multiple skins not supported");this._animationConverter.convertSkin(e.deformers[0],t),this._modelData.skeleton=this._animationConverter.skeleton,this._useSkinning=!0}}},HX.FBXModelInstanceConverter._ExpandedMesh=function(){this.vertices=null,this.hasColor=!1,this.hasUVs=!1,this.hasNormals=!1,this.numMaterials=0},HX.FBXModelInstanceConverter._JointBinding=function(){this.jointIndex=0,this.jointWeight=0},HX.FBXModelInstanceConverter._Vertex=function(){this.pos=new HX.Float4,this.uv=null,this.normal=null,this.color=null,this.materialIndex=0,this.ctrlPointIndex=-1,this.jointBindings=null,this._hash=null,this.lastVertex=!1},HX.FBXModelInstanceConverter._Vertex.prototype={getHash:function(){if(!this._hash){var e=this.ctrlPointIndex+"/"+this.materialIndex+"/"+this.pos.x+"/"+this.pos.y+"/"+this.pos.z;this.normal&&(e+="/"+this.normal.x+"/"+this.normal.y+"/"+this.normal.z),this.uv&&(e+="/"+this.uv.x+"/"+this.uv.y),this.color&&(e+="/"+this.color.x+"/"+this.color.y+"/"+this.color.z),this._hash=e}return this._hash}},HX.FBXModelInstanceConverter._PerMaterialData=function(){this.indexCounter=0,this.vertexStack=[],this.skinningStack=[],this.indexStack=[],this.ctrlPointStack=[],this.vertices=null,this.indices=null,this.skinning=null,this.ctrlPointIndices=null,this.indexLookUp={}},HX.FBXRecord=function(){this.name="",this.data=[],this.children=[]},HX.FBXRecord.prototype={getChildByName:function(e){for(var t=this.children.length,i=0;i<t;++i){var n=this.children[i];if(n.name===e)return n}},printDebug:function(e,t){void 0===e&&(e=!0),void 0===t&&(t=0);for(var i="",n=0;n<t;++n)i+="\t";if(console.log(i+this.name),e&&this.data.length>0){console.log(i+"\t[data] {");for(var n=0;n<this.data.length;++n)console.log(i+"\t\t["+n+"] : "+this.data[n]);console.log(i+"}")}for(var n=0;n<this.children.length;++n)this.children[n].printDebug(e,t+1)}},HX.FBXSettings=function(){this._matrix=new HX.Matrix4x4,this._frameRate=24},HX.FBXSettings.prototype={get orientationMatrix(){return this._matrix},get frameRate(){return this._frameRate},init:function(e){for(var t=1,i=1,n=2,a=1,r=e.getChildByName("GlobalSettings"),s=r.getChildByName("Properties70"),o=s.children.length,l=[0,120,100,60,50,48,30],h=0;h<o;++h){var c=s.children[h];switch(c.data[0]){case"UpAxis":t=c.data[4];break;case"UpAxisSign":i=c.data[4];break;case"FrontAxis":n=c.data[4];break;case"FrontAxisSign":a=c.data[4];break;case"TimeMode":l[c.data[4]]&&(this._frameRate=l[c.data[4]])}}var u=[HX.Float4.X_AXIS,HX.Float4.Y_AXIS,HX.Float4.Z_AXIS],p=u[n].clone(),_=u[t].clone();p.scale(a),_.scale(i),this._matrix.lookAt(p,HX.Float4.ORIGIN_POINT,_),this._matrix.invert()}},HX.MTL=function(){HX.Importer.call(this,Object,HX.URLLoader.DATA_TEXT),this._textures=[],this._texturesToLoad=[],this._activeMaterial=null},HX.MTL.prototype=Object.create(HX.Importer.prototype),HX.MTL.prototype.parse=function(e,t){for(var i=e.split("\n"),n=i.length,a=0;a<n;++a){var r=i[a].replace(/^\s+|\s+$/g,"");this._parseLine(r,t)}this._loadTextures(t)},HX.MTL.prototype._parseLine=function(e,t){if(0!==e.length&&"#"!==e.charAt(0)){var i=e.split(/\s+/);switch(i[0].toLowerCase()){case"newmtl":this._activeMaterial=new HX.BasicMaterial,this._activeMaterial.name=i[1],t[i[1]]=this._activeMaterial;break;case"ns":var n=parseFloat(i[1]);this._activeMaterial.roughness=HX.BasicMaterial.roughnessFromShininess(n);break;case"kd":this._activeMaterial.color=new HX.Color(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));break;case"map_kd":this._activeMaterial.colorMap=this._getTexture(i[1]);break;case"map_d":this._activeMaterial.maskMap=this._getTexture(i[1]),this._activeMaterial.alphaThreshold=.5;break;case"map_ns":this._activeMaterial.specularMap=this._getTexture(i[1]);break;case"map_bump":case"bump":this._activeMaterial.normalMap=this._getTexture(i[1])}}},HX.MTL.prototype._getTexture=function(e){if(!this._textures[e]){var t=new HX.Texture2D;this._textures[e]=t,this._texturesToLoad.push({file:this._correctURL(e),importer:HX.JPG,target:t})}return this._textures[e]},HX.MTL.prototype._loadTextures=function(e){var t=new HX.AssetLibrary,i=this._texturesToLoad,n=i.length;if(0===n)return void this._notifyComplete(e);for(var a=0;a<i.length;++a)t.queueAsset(i[a].file,i[a].file,HX.AssetLibrary.Type.ASSET,i[a].importer,i[a].target);t.onComplete.bind(function(){this._notifyComplete(e)},this),t.load(i)},HX.OBJ=function(){HX.Importer.call(this,HX.SceneNode),this._objects=[],this._vertices=[],this._normals=[],this._uvs=[],this._hasNormals=!1,this._defaultMaterial=new HX.BasicMaterial,this._target=null,this._mtlLibFile=null},HX.OBJ.prototype=Object.create(HX.Importer.prototype),HX.OBJ.prototype.parse=function(e,t){this._groupsAsObjects=void 0===this.options.groupsAsObjects||this._groupsAsObjects,this._target=t;var i=e.split("\n"),n=i.length;
this._pushNewObject("hx_default");for(var a=0;a<n;++a){var r=i[a].replace(/^\s+|\s+$/g,"");this._parseLine(r)}this._mtlLibFile?this._loadMTLLib(this._mtlLibFile):this._finish(null)},HX.OBJ.prototype._finish=function(e){this._translate(e),this._notifyComplete(this._target)},HX.OBJ.prototype._loadMTLLib=function(e){var t=new HX.AssetLoader(HX.MTL),i=this;t.onComplete=function(e){i._finish(e)},t.onFail=function(e){i._notifyFailure(e)},t.load(e)},HX.OBJ.prototype._parseLine=function(e){if(0!==e.length&&"#"!==e.charAt(0)){var t=e.split(/\s+/);switch(t[0].toLowerCase()){case"mtllib":this._mtlLibFile=this._correctURL(t[1]);break;case"usemtl":this._setActiveSubGroup(t[1]);break;case"v":this._vertices.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));break;case"vt":this._uvs.push(parseFloat(t[1]),parseFloat(t[2]));break;case"vn":this._normals.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));break;case"o":this._pushNewObject(t[1]);break;case"g":this._groupsAsObjects?this._pushNewObject(t[1]):this._pushNewGroup(t[1]);break;case"f":this._parseFaceData(t)}}},HX.OBJ.prototype._pushNewObject=function(e){this._activeObject=new HX.OBJ._ObjectData,this._activeObject.name=e,this._objects.push(this._activeObject),this._pushNewGroup("hx_default")},HX.OBJ.prototype._pushNewGroup=function(e){this._activeGroup=new HX.OBJ._GroupData,this._activeGroup.name=e||"Group"+this._activeGroup.length,this._activeObject.groups.push(this._activeGroup),this._setActiveSubGroup("hx_default")},HX.OBJ.prototype._setActiveSubGroup=function(e){this._activeGroup.subgroups[e]=this._activeGroup.subgroups[e]||new HX.OBJ._SubGroupData,this._activeSubGroup=this._activeGroup.subgroups[e]},HX.OBJ.prototype._parseFaceData=function(e){for(var t=new HX.OBJ._FaceData,i=e.length,n=1;n<i;++n){var a=new HX.OBJ._FaceVertexData;t.vertices.push(a);var r=e[n].split("/"),s=3*(r[0]-1);a.posX=this._vertices[s],a.posY=this._vertices[s+1],a.posZ=this._vertices[s+2],r.length>1&&(s=2*(r[1]-1),a.uvU=this._uvs[s],a.uvV=this._uvs[s+1],r.length>2&&(s=3*(r[2]-1),this._hasNormals=!0,a.normalX=this._normals[s],a.normalY=this._normals[s+1],a.normalZ=this._normals[s+2]))}this._activeSubGroup.faces.push(t),this._activeSubGroup.numIndices+=4===e.length?3:6},HX.OBJ.prototype._translate=function(e){for(var t=this._objects.length,i=0;i<t;++i)this._translateObject(this._objects[i],e)},HX.OBJ.prototype._translateObject=function(e,t){var i=e.groups.length;if(0!==i){for(var n=new HX.ModelData,a=[],r=new HX.Model,s=0;s<i;++s){var o=e.groups[s];for(var l in o.subgroups)if(o.subgroups.hasOwnProperty(l)){var h=o.subgroups[l];if(0===h.numIndices)continue;n.addMeshData(this._translateMeshData(h));var c=t?t[l]:null;c=c||this._defaultMaterial,a.push(c)}}r._setModelData(n);var u=new HX.ModelInstance(r,a);u.name=e.name,this._target.attach(u)}},HX.OBJ.prototype._translateMeshData=function(e){for(var t=HX.MeshData.createDefaultEmpty(),i=[],n=new Array(e.numIndices),a=0,r=0,s=e.faces,o=s.length,l=0;l<o;++l){for(var h=s[l],c=h.vertices,u=c.length,p=0;p<u;++p){var _=c[p],d=_.getHash();i.hasOwnProperty(d)||(i[d]={index:a++,vertex:_})}n[r]=i[c[0].getHash()].index,n[r+1]=i[c[1].getHash()].index,n[r+2]=i[c[2].getHash()].index,r+=3,4===u&&(n[r]=i[c[0].getHash()].index,n[r+1]=i[c[2].getHash()].index,n[r+2]=i[c[3].getHash()].index,r+=3)}var m=new Array(a*HX.MeshData.DEFAULT_VERTEX_SIZE);for(var d in i)if(i.hasOwnProperty(d)){var f=i[d],X=f.vertex,v=f.index*HX.MeshData.DEFAULT_VERTEX_SIZE;m[v]=X.posX,m[v+1]=X.posY,m[v+2]=X.posZ,m[v+3]=X.normalX,m[v+4]=X.normalY,m[v+5]=X.normalZ,m[v+6]=0,m[v+7]=0,m[v+8]=0,m[v+9]=1,m[v+10]=X.uvU,m[v+11]=X.uvV}t.setVertexData(m,0),t.setIndexData(n);var b=HX.NormalTangentGenerator.MODE_TANGENTS;this._hasNormals||(b|=HX.NormalTangentGenerator.MODE_NORMALS);var x=new HX.NormalTangentGenerator;return x.generate(t,b,!0),t},HX.OBJ._FaceVertexData=function(){this.posX=0,this.posY=0,this.posZ=0,this.uvU=0,this.uvV=0,this.normalX=0,this.normalY=0,this.normalZ=0,this._hash=""},HX.OBJ._FaceVertexData.prototype={getHash:function(){return this._hash||(this._hash=this.posX+"/"+this.posY+"/"+this.posZ+"/"+this.uvU+"/"+this.uvV+"/"+this.normalX+"/"+this.normalY+"/"+this.normalZ+"/"),this._hash}},HX.OBJ._FaceData=function(){this.vertices=[]},HX.OBJ._SubGroupData=function(){this.numIndices=0,this.faces=[]},HX.OBJ._GroupData=function(){this.subgroups=[],this.name="",this._activeMaterial=null},HX.OBJ._ObjectData=function(){this.name="",this.groups=[],this._activeGroup=null},HX.MD5Anim=function(){HX.Importer.call(this,HX.SkeletonClip),this._hierarchy=null,this._baseFrame=null,this._activeFrame=null,this._numJoints=0,this._frameRate=0,this._correctionQuad=new HX.Quaternion,this._correctionQuad.fromAxisAngle(HX.Float4.X_AXIS,.5*-Math.PI)},HX.MD5Anim.prototype=Object.create(HX.Importer.prototype),HX.MD5Anim.prototype.parse=function(e,t){this._hierarchy=[],this._baseFrame=[],this._target=t;for(var i=e.split("\n"),n=i.length,a=null,r=0;r<n;++r){var s=i[r].replace(/^\s+|\s+$/g,""),o=s.split(/\s+/);if("//"!==o[0]&&""!==o[0])if(a)a.call(this,o),"}"===o[0]&&(a=null);else switch(o[0]){case"commandline":case"numFrames":case"MD5Version":case"numAnimatedComponents":break;case"numJoints":this._numJoints=parseInt(o[1]);break;case"frameRate":this._frameRate=parseInt(o[1]);break;case"hierarchy":a=this._parseHierarchy;break;case"bounds":a=this._parseBounds;break;case"baseframe":a=this._parseBaseFrame;break;case"frame":this._activeFrame=new HX.MD5Anim._FrameData,a=this._parseFrame}}this._notifyComplete(t)},HX.MD5Anim.prototype._parseHierarchy=function(e){if("}"!==e[0]){var t=new HX.MD5Anim._HierachyData;t.name=e[0].substring(1,e[0].length-1),t.parent=parseInt(e[1]),t.flags=parseInt(e[2]),t.startIndex=parseInt(e[3]),this._hierarchy.push(t)}},HX.MD5Anim.prototype._parseBounds=function(e){},HX.MD5Anim.prototype._parseBaseFrame=function(e){if("}"!==e[0]){var t=new HX.MD5Anim._BaseFrameData,i=t.pos;i.x=parseFloat(e[1]),i.y=parseFloat(e[2]),i.z=parseFloat(e[3]);var n=t.quat;n.x=parseFloat(e[6]),n.y=parseFloat(e[7]),n.z=parseFloat(e[8]),n.w=1-n.x*n.x-n.y*n.y-n.z*n.z,n.w<0?n.w=0:n.w=-Math.sqrt(n.w),this._baseFrame.push(t)}},HX.MD5Anim.prototype._parseFrame=function(e){if("}"===e[0])return void this._translateFrame();for(var t=e.length,i=0;i<t;++i)this._activeFrame.components.push(parseFloat(e[i]))},HX.MD5Anim.prototype._translateFrame=function(){for(var e=new HX.SkeletonPose,t=0;t<this._numJoints;++t){var i=new HX.SkeletonJointPose,n=this._hierarchy[t],a=this._baseFrame[t],r=n.flags,s=a.pos,o=a.quat,l=this._activeFrame.components,h=n.startIndex;1&r&&(s.x=l[h]),2&r&&(s.y=l[h+1]),4&r&&(s.z=l[h+2]),8&r&&(o.x=l[h+3]),16&r&&(o.y=l[h+4]),32&r&&(o.z=l[h+5]);var c=1-o.x*o.x-o.y*o.y-o.z*o.z;o.w=c<0?0:-Math.sqrt(c),n.parent<0?(i.rotation.multiply(this._correctionQuad,o),i.position=this._correctionQuad.rotate(s)):(i.rotation.copyFrom(o),i.position.copyFrom(s)),e.jointPoses.push(i)}var u=this._target.numKeyFrames/this._frameRate*1e3;this._target.addKeyFrame(new HX.KeyFrame(u,e))},HX.MD5Anim._HierachyData=function(){this.name=null,this.parent=-1,this.flags=0,this.startIndex=0},HX.MD5Anim._BaseFrameData=function(){this.pos=new HX.Float4,this.quat=new HX.Quaternion},HX.MD5Anim._FrameData=function(){this.components=[]},HX.MD5Mesh=function(){HX.Importer.call(this,HX.Model),this._target=null,this._meshData=null,this._jointData=null,this._skeleton=null,this._correctionQuad=new HX.Quaternion,this._correctionQuad.fromAxisAngle(HX.Float4.X_AXIS,.5*-Math.PI)},HX.MD5Mesh.prototype=Object.create(HX.Importer.prototype),HX.MD5Mesh.prototype.parse=function(e,t){this._modelData=new HX.ModelData,this._skeleton=new HX.Skeleton,this._jointData=[];for(var i=e.split("\n"),n=i.length,a=null,r=0;r<n;++r){var s=i[r].replace(/^\s+|\s+$/g,""),o=s.split(/\s+/);if("//"!==o[0]&&""!==o[0])if(a)a.call(this,o),"}"===o[0]&&(a=null);else switch(o[0]){case"commandline":case"numMeshes":case"numJoints":case"MD5Version":break;case"joints":a=this._parseJoint;break;case"mesh":this._meshData=new HX.MD5Mesh._MeshData,a=this._parseMesh}}t._setModelData(this._modelData),t.skeleton=this._skeleton,this._notifyComplete(t)},HX.MD5Mesh.prototype._parseJoint=function(e){if("}"!==e[0]){var t=new HX.MD5Mesh._Joint,i=t.pos,n=t.quat;t.name=e[0].substring(1,e[0].length-1),t.parentIndex=parseInt(e[1]),i.x=parseFloat(e[3]),i.y=parseFloat(e[4]),i.z=parseFloat(e[5]),this._correctionQuad.rotate(t.pos,t.pos),n.x=parseFloat(e[8]),n.y=parseFloat(e[9]),n.z=parseFloat(e[10]),n.w=1-n.x*n.x-n.y*n.y-n.z*n.z,n.w<0?n.w=0:n.w=-Math.sqrt(n.w),n.multiply(this._correctionQuad,n),this._jointData.push(t);var a=new HX.SkeletonJoint;a.inverseBindPose.fromQuaternion(n);var i=t.pos;a.inverseBindPose.appendTranslation(i),a.inverseBindPose.invertAffine(),a.parentIndex=t.parentIndex,this._skeleton.addJoint(a)}},HX.MD5Mesh.prototype._parseMesh=function(e){switch(e[0]){case"shader":case"numVerts":case"numWeights":break;case"tri":this._meshData.indices.push(parseInt(e[2]),parseInt(e[4]),parseInt(e[3]));break;case"vert":this._parseVert(e);break;case"weight":this._parseWeight(e);break;case"}":this._translateMesh()}},HX.MD5Mesh.prototype._parseVert=function(e){var t=new HX.MD5Mesh._VertexData;t.u=parseFloat(e[3]),t.v=parseFloat(e[4]),t.startWeight=parseInt(e[6]),t.countWeight=parseInt(e[7]),this._meshData.vertexData.push(t)},HX.MD5Mesh.prototype._parseWeight=function(e){var t=new HX.MD5Mesh._WeightData;t.joint=parseInt(e[2]),t.bias=parseFloat(e[3]),t.pos.x=parseFloat(e[5]),t.pos.y=parseFloat(e[6]),t.pos.z=parseFloat(e[7]),this._meshData.weightData.push(t)},HX.MD5Mesh.prototype._translateMesh=function(){var e=new HX.MeshData.createDefaultEmpty;e.addVertexAttribute("hx_boneIndices",4,1),e.addVertexAttribute("hx_boneWeights",4,1);for(var t,i,n,a=[],r=[],s=this._meshData.vertexData,o=s.length,l=0,h=0,c=0;c<o;++c){var u=s[c];t=i=n=0,u.countWeight>4&&console.warn("Warning: more than 4 weights assigned. Mesh will not animate correctly");for(var p=0;p<u.countWeight;++p){var _=this._meshData.weightData[u.startWeight+p],d=this._jointData[_.joint],m=d.quat.rotate(_.pos),f=d.pos,X=_.bias;t+=(m.x+f.x)*X,i+=(m.y+f.y)*X,n+=(m.z+f.z)*X,p<4&&(r[h+p]=_.joint,r[h+4+p]=_.bias)}a[l]=t,a[l+1]=i,a[l+2]=n,a[l+10]=u.u,a[l+11]=1-u.v;for(var p=u.countWeight;p<4;++p)r[h+p]=0,r[h+4+p]=0;h+=8,l+=12}e.setVertexData(a,0),e.setVertexData(r,1),e.setIndexData(this._meshData.indices);var v=new HX.NormalTangentGenerator;v.generate(e),this._modelData.addMeshData(e)},HX.MD5Mesh._Joint=function(){this.name=null,this.parentIndex=-1,this.quat=new HX.Quaternion,this.pos=new HX.Float4},HX.MD5Mesh._MeshData=function(){this.vertexData=[],this.weightData=[],this.indices=[]},HX.MD5Mesh._VertexData=function(){this.u=0,this.v=0,this.startWeight=0,this.countWeight=0},HX.MD5Mesh._WeightData=function(){this.joint=0,this.bias=0,this.pos=new HX.Float4},HX.FbxAnimationCurve=function(){HX.FbxObject.call(this),this.Default=void 0,this.KeyVer=0,this.KeyTime=0,this.KeyValueFloat=null,this.KeyAttrFlags=0,this.KeyAttrDataFloat=null,this.KeyAttrRefCount=0},HX.FbxAnimationCurve.prototype=Object.create(HX.FbxObject.prototype),HX.FbxAnimationCurve.prototype.toString=function(){return"[FbxAnimationCurve(name="+this.name+")]"},HX.FbxAnimationCurveNode=function(){HX.FbxObject.call(this),this.curves=null,this["d|X"]=0,this["d|Y"]=0,this["d|Z"]=0,this.propertyName=null},HX.FbxAnimationCurveNode.prototype=Object.create(HX.FbxObject.prototype),HX.FbxAnimationCurveNode.prototype.toString=function(){return"[FbxAnimationCurveNode(name="+this.name+")]"},HX.FbxAnimationCurveNode.prototype.connectProperty=function(e,t){e instanceof HX.FbxAnimationCurve&&(this.curves=this.curves||{},this.curves[t]=e)},HX.FbxAnimLayer=function(){HX.FbxObject.call(this),this.curveNodes=null},HX.FbxAnimLayer.prototype=Object.create(HX.FbxObject.prototype),HX.FbxAnimLayer.prototype.toString=function(){return"[FbxAnimLayer(name="+this.name+")]"},HX.FbxAnimLayer.prototype.connectObject=function(e){if(!(e instanceof HX.FbxAnimationCurveNode))throw new Error("Incompatible child object "+e.toString());this.curveNodes=this.curveNodes||[],this.curveNodes.push(e)},HX.FbxAnimStack=function(){HX.FbxObject.call(this),this.LocalStart=0,this.LocalStop=0,this.ReferenceStart=0,this.ReferenceStop=0,this.layers=null},HX.FbxAnimStack.prototype=Object.create(HX.FbxObject.prototype),HX.FbxAnimStack.prototype.connectObject=function(e){if(!(e instanceof HX.FbxAnimLayer))throw new Error("Incompatible child object "+e.toString());this.layers=this.layers||[],this.layers.push(e)},HX.FbxAnimStack.prototype.toString=function(){return"[FbxAnimStack(name="+this.name+")]"},HX.FbxCluster=function(){HX.FbxObject.call(this),this.limbNode=null,this.transform=null,this.transformLink=null,this.indices=null,this.weights=null},HX.FbxCluster.prototype=Object.create(HX.FbxObject.prototype),HX.FbxCluster.prototype.toString=function(){return"[FbxCluster(name="+this.name+")]"},HX.FbxCluster.prototype.connectObject=function(e){if(!(e instanceof HX.FbxNode))throw new Error("Unhandled object connection "+e.toString());this.limbNode=e},HX.FbxFileTexture=function(){HX.FbxObject.call(this),this.WrapModeU=0,this.WrapModeV=0,this.relativeFilename=null,this.video=null},HX.FbxFileTexture.prototype=Object.create(HX.FbxObject.prototype),HX.FbxFileTexture.prototype.connectObject=function(e){if(!(e instanceof HX.FbxVideo))throw new Error("Incompatible child object!");this.video=e},HX.FbxFileTexture.prototype.toString=function(){return"[FbxFileTexture(name="+this.name+")]"},HX.FbxLayerElement=function(){HX.FbxObject.call(this),this.directData=null,this.indexData=null,this.type=null,this.mappingInformationType=0,this.referenceInformationType=0},HX.FbxLayerElement.prototype=Object.create(HX.FbxObject.prototype),HX.FbxLayerElement.MAPPING_TYPE={NONE:0,BY_POLYGON_VERTEX:1,BY_CONTROL_POINT:2,BY_POLYGON:3,ALL_SAME:4},HX.FbxLayerElement.REFERENCE_TYPE={DIRECT:1,INDEX_TO_DIRECT:2},HX.FbxLayerElement.prototype.toString=function(){return"[FbxLayerElement(name="+this.name+")]"},HX.FbxMaterial=function(){HX.FbxObject.call(this),this.EmissiveColor=null,this.EmissiveFactor=1,this.DiffuseColor=null,this.DiffuseFactor=1,this.ShininessExponent=void 0,this.Shininess=void 0,this.textures=null},HX.FbxMaterial.prototype=Object.create(HX.FbxObject.prototype),HX.FbxMaterial.prototype.connectProperty=function(e,t){if(!(e instanceof HX.FbxFileTexture))throw new Error("Unknown object property!");this.textures=this.textures||{},this.textures[t]=e},HX.FbxMaterial.prototype.toString=function(){return"[FbxMaterial(name="+this.name+")]"},HX.FbxMesh=function(){HX.FbxObject.call(this),this.Color=null,this["Casts Shadows"]=!0,this.vertices=null,this.layerElements=null,this.deformers=null},HX.FbxMesh.prototype=Object.create(HX.FbxObject.prototype),HX.FbxMesh.prototype.toString=function(){return"[FbxMesh(name="+this.name+")]"},HX.FbxMesh.prototype.connectObject=function(e){if(!(e instanceof HX.FbxSkin))throw new Error("Unhandled object connection "+e.toString());this.deformers=this.deformers||[],this.deformers.push(e)},HX.FbxNodeAttribute=function(){HX.FbxObject.call(this),this.type=null},HX.FbxNodeAttribute.prototype=Object.create(HX.FbxObject.prototype),HX.FbxNodeAttribute.prototype.toString=function(){return"[FbxNodeAttribute(name="+this.name+", type="+this.type+")]"},HX.FbxPose=function(){HX.FbxObject.call(this),this.type=null,this.poseNodes=[]},HX.FbxPose.prototype=Object.create(HX.FbxObject.prototype),HX.FbxPose.prototype.toString=function(){return"[FbxPose(name="+this.name+")]"},HX.FbxPoseNode=function(){this.targetUID=null,this.matrix=null},HX.FbxSkin=function(){HX.FbxObject.call(this),this.clusters=null},HX.FbxSkin.prototype=Object.create(HX.FbxObject.prototype),HX.FbxSkin.prototype.toString=function(){return"[FbxSkin(name="+this.name+")]"},HX.FbxSkin.prototype.connectObject=function(e){if(!(e instanceof HX.FbxCluster))throw new Error("Unhandled object connection "+e.toString());this.clusters=this.clusters||[],this.clusters.push(e)},HX.FbxTime=function(e){this._value=e},HX.FbxTime.getSpan=function(e,t){return new HX.FbxTime(t._value-e._value)},HX.FbxTime.TC_MILLISECOND=46186158,HX.FbxTime.prototype={get milliseconds(){return this._value/HX.FbxTime.TC_MILLISECOND},set milliseconds(e){this._value=e*HX.FbxTime.TC_MILLISECOND},getFrameCount:function(e){return Math.floor(this.milliseconds/1e3*e)},toString:function(){return"[FbxTime(name="+this._value+")]"}},HX.FbxTrashNode=function(){HX.FbxObject.call(this)},HX.FbxTrashNode.prototype=Object.create(HX.FbxObject.prototype),HX.FbxTrashNode.prototype.toString=function(){return"[FbxTrashNode(name="+this.name+")]"},HX.FbxTrashNode.prototype.connectObject=function(e){},HX.FbxVideo=function(){HX.FbxObject.call(this),this.relativeFilename=null},HX.FbxVideo.prototype=Object.create(HX.FbxObject.prototype),HX.FbxVideo.prototype.toString=function(){return"[FbxVideo(name="+this.name+")]"};