!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("helix")):"function"==typeof define&&define.amd?define("HX_IO",["exports","helix"],e):e(t.HX_IO={},t.HX)}(this,function(t,v){"use strict";function e(){this.defaultScene=new v.Scene,this.scenes={}}function r(){v.Importer.call(this,e),this._numComponentLookUp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},this._flipCoord=new v.Matrix4x4,this._flipCoord.setColumn(0,new v.Float4(-1,0,0,0)),this._flipCoord.setColumn(1,new v.Float4(0,0,1,0)),this._flipCoord.setColumn(2,new v.Float4(0,1,0,0))}function i(){this._listeners=[],this._lookUp={}}function a(){this.onComplete=new i,this.onProgress=new i,this._queue=[],this._childQueues=[],this._currentIndex=0,this._isRunning=!1}function s(){v.Importer.call(this,Object,v.URLLoader.DATA_TEXT),this._textures=[],this._texturesToLoad=[],this._activeMaterial=null}function o(){v.Importer.call(this,v.Entity),this._objects=[],this._vertices=[],this._normals=[],this._uvs=[],this._hasNormals=!1,this._defaultMaterial=new v.BasicMaterial,this._target=null,this._mtlLibFile=null}function n(){v.Importer.call(this,v.Mesh)}function u(t){this._dataView=t,this._offset=0,this._endian=u.LITTLE_ENDIAN}function p(){}function h(){}(r.prototype=Object.create(v.Importer.prototype)).parse=function(t,e){this._defaultSceneIndex=void 0,this._gltf=JSON.parse(t);var r=this._gltf.asset;if(this._target=e,this._animationTargetNodes={},this._animations=[],r.hasOwnProperty("minVersion"))r.minVersion.split(".");if(r.hasOwnProperty("version")&&"2"!==r.version.split(".")[0])throw new Error("Unsupported glTF version!");this._assetLibrary=new v.AssetLibrary,this._binFileCheck={},this._queueImages(),this._queueBuffers(),this._assetLibrary.onComplete.bind(function(){this._continueParsing()},this),this._assetLibrary.onProgress.bind(function(t){this._notifyProgress(.8*t)},this),this._assetLibrary.load()},r.prototype._continueParsing=function(){var t=this._gltf;t.hasOwnProperty("scene")&&(this._defaultSceneIndex=t.scene);var e=new v.AsyncTaskQueue;e.queue(this._parseMaterials.bind(this)),e.queue(this._parseMeshes.bind(this)),e.queue(this._parseNodes.bind(this)),e.queue(this._parseScenes.bind(this)),e.queue(this._parseAnimations.bind(this)),e.queue(this._assignAnimations.bind(this)),e.onComplete.bind(function(){this._notifyComplete(this._target)}.bind(this)),e.onProgress.bind(function(t){this._notifyProgress(.8+.2*t)}.bind(this)),e.execute()},r.prototype._getAccessor=function(t){var e,r=this._gltf.accessors[t];void 0!==r.bufferView&&(e=this._getBufferView(r.bufferView));var i={dataType:r.componentType,numComponents:this._numComponentLookUp[r.type],type:r.type,data:e?e.data:null,min:r.min,max:r.max,byteOffset:e.byteOffset+(r.byteOffset||0),byteStride:e.byteStride,count:r.count,isSparse:!1};if(r.sparse){i.isSparse=!0,i.sparseCount=r.sparse.count,i.sparseOffsets=[];var a=this._getBufferView(r.sparse.indices.bufferView),s=this._getBufferView(r.sparse.values.bufferView);i.sparseIndices={data:a.data,byteOffset:r.sparse.indices.byteOffset,dataType:r.componentType},i.sparseValues={data:s.data,byteOffset:r.values.indices.byteOffset}}return i},r.prototype._getBufferView=function(t){var e=this._gltf.bufferViews[t],r=this._buffers[e.buffer],i=r.byteOffset+(e.byteOffset||0);return{data:this._assetLibrary.get(r.assetID),byteOffset:i,byteLength:e.byteLength,byteStride:e.byteStride}},r.prototype._queueImages=function(){var t=this._gltf.images;if(t)for(var e=0;e<t.length;++e){var r=t[e];this._assetLibrary.queueAsset("hx_image_"+e,this._correctURL(r.uri),v.AssetLibrary.Type.ASSET,v.JPG)}},r.prototype._queueBuffers=function(){var t=this._gltf.buffers;if(t){this._buffers=[];for(var e=0;e<t.length;++e){var r=t[e];if(!this._binFileCheck[r.uri]){var i="hx_bin_"+e;this._assetLibrary.queueAsset(i,this._correctURL(r.uri),v.AssetLibrary.Type.RAW_BINARY),this._binFileCheck[r.uri]=!0,this._buffers[e]={assetID:i,byteOffset:r.byteOffset||0,byteLength:r.byteLength}}}}},r.prototype._parseMaterials=function(){var t=this._gltf.materials;if(t){this._materials=[];for(var e=0;e<t.length;++e){var r=t[e],i=new v.BasicMaterial;if(i.name=r.name,i.specularMapMode=v.BasicMaterial.SPECULAR_MAP_METALLIC_ROUGHNESS,i.normalMap=this._getTexture(r.normalTexture),i.occlusionMap=this._getTexture(r.occlusionTexture),i.emissionMap=this._getTexture(r.emissiveTexture),r.doubleSided&&(i.cullMode=v.CullMode.NONE),r.emissiveFactor){var a=new v.Color(r.emissiveFactor[0],r.emissiveFactor[1],r.emissiveFactor[2],1);i.emissiveColor=a.linearToGamma()}else i.emissionMap&&(i.emissiveColor=v.Color.WHITE);var s=r.pbrMetallicRoughness;if(s){if(i.colorMap=this._getTexture(s.baseColorTexture),i.specularMap=this._getTexture(s.metallicRoughnessTexture),s.baseColorFactor){var n=new v.Color(s.baseColorFactor[0],s.baseColorFactor[1],s.baseColorFactor[2],s.baseColorFactor[3]);i.color=n.linearToGamma()}i.metallicness=void 0===s.metallicFactor?1:s.metallicFactor,i.roughness=void 0===s.roughnessFactor?1:s.roughnessFactor,i.specularMap&&(i.roughness*=.5,i.roughnessRange=-i.roughness)}this._materials[e]=i}}},r.prototype._getTexture=function(t){return t?this._assetLibrary.get("hx_image_"+this._gltf.textures[t.index].source):null},r.prototype._parseMeshes=function(){var t=this._gltf.meshes;if(t){this._entities=[];for(var e=0;e<t.length;++e){var r=t[e],i=new v.Entity;i.name=r.name;for(var a=0;a<r.primitives.length;++a){var s=r.primitives[a];this._parsePrimitive(s,i),r.weights&&this._parseMorphWeights(r.weights,i)}this._entities[e]=i}}},r.prototype._parseMorphWeights=function(t,e){var r=new v.MorphAnimation;if(t)for(var i=0,a=t.length;i<a;++i)r.setWeight("morphTarget_"+i,t[i]);e.addComponent(r),this._animationTargetNodes[r.name]=e},r.prototype._parseMorphTargets=function(t,e){for(var r=0;r<t.length;++r){var i=t[r],a=new v.MorphTarget;a.name="morphTarget_"+r;var s=this._getAccessor(i.POSITION),n=void 0!==i.NORMAL?this._getAccessor(i.NORMAL):null,o=new Float32Array(3*s.count);if(this._readVertexData(o,0,s,3,3,!0),n){var h=new Float32Array(3*n.count);this._readVertexData(h,0,n,3,3,!0)}a.init(o,h),e.addMorphTarget(a)}},r.prototype._parsePrimitive=function(t,e){var r=v.Mesh.createDefaultEmpty(),i=t.attributes,a=this._getAccessor(i.POSITION),s=void 0!==i.NORMAL?this._getAccessor(i.NORMAL):null,n=void 0!==i.TANGENT?this._getAccessor(i.TANGENT):null,o=void 0!==i.TEXCOORD_0?this._getAccessor(i.TEXCOORD_0):null,h=void 0!==i.JOINTS_0?this._getAccessor(i.JOINTS_0):null,l=void 0!==i.WEIGHTS_0?this._getAccessor(i.WEIGHTS_0):null,u=0,p=r.getVertexStride(0),_=new Float32Array(a.count*p);this._readVertexData(_,0,a,3,p,!0),s?this._readVertexData(_,3,s,3,p,!0):u=v.NormalTangentGenerator.MODE_NORMALS,n?this._readVertexData(_,6,n,4,p,!0):o&&(u|=v.NormalTangentGenerator.MODE_TANGENTS),o&&this._readUVData(_,10,o,p),r.setVertexData(_,0);var c=this._getAccessor(t.indices);(r.setIndexData(this._readIndices(c)),u)&&(new v.NormalTangentGenerator).generate(r);if(h){r.addVertexAttribute("hx_jointIndices",4,1),r.addVertexAttribute("hx_jointWeights",4,1),p=r.getVertexStride(1);var f=new Float32Array(h.count*p);this._readVertexData(f,0,h,4,p),this._readVertexData(f,4,l,4,p),r.setVertexData(f,1)}e.addComponent(new v.MeshInstance(r,this._materials[t.material])),t.targets&&0<t.targets.length&&this._parseMorphTargets(t.targets,r)},r.prototype._readVertexData=function(t,e,r,i,a,s){var n,o,h,l=e,u=r.byteOffset,p=r.count,_=r.data,c=r.byteStride||0;if(_){if(r.dataType===v.DataType.FLOAT)o=_.getFloat32,h=4;else if(r.dataType===v.DataType.UNSIGNED_SHORT)o=_.getUint16,h=2;else if(r.dataType===v.DataType.UNSIGNED_INT)o=_.getUint32,h=4;else{if(r.dataType!==v.DataType.UNSIGNED_BYTE)throw new Error("Unknown data type "+r.dataType);o=_.getUint8,h=1}for(n=0;n<p;++n){for(var f=u,d=0;d<i;++d)t[l+d]=o.call(_,u,!0),u+=h;l+=a,c&&(u=f+c)}}else{for(n=0;n<p;++n)for(d=0;d<i;++d)t[l+d]=0;l+=a}if(r.isSparse&&this._applySparseAccessor(t,r,i,a,o,h),s)for(l=e,n=0;n<p;++n){var m=t[l+1];t[l]=-t[l],t[l+1]=t[l+2],t[l+2]=m,l+=a}},r.prototype._applySparseAccessor=function(t,e,r,i,a,s){var n,o,h=e.sparseCount,l=e.sparseIndices.data,u=e.sparseValues.data,p=e.sparseIndices.byteOffset,_=e.sparseValues.byteOffset;e.dataType===v.DataType.UNSIGNED_SHORT?(n=l.getUint16,o=2):e.dataType===v.DataType.UNSIGNED_INT&&(n=l.getUint32,o=4);for(var c=0;c<h;++c){for(var f=n.call(l,p)*i,d=0;d<r;++d){var m=a.call(u,_,!0);_+=s,t[f+d]=m}p+=o}},r.prototype._readUVData=function(t,e,r,i){for(var a=e,s=r.byteOffset,n=r.count,o=r.data,h=0;h<n;++h)t[a]=o.getFloat32(s,!0),t[a+1]=1-o.getFloat32(s+4,!0),s+=8,a+=i},r.prototype._readIndices=function(t){var e,r,i,a=t.byteOffset,s=t.data,n=t.count;t.dataType===v.DataType.UNSIGNED_SHORT?(r=Uint16Array,e=s.getUint16,i=2):t.dataType===v.DataType.UNSIGNED_INT&&(r=Uint32Array,e=s.getUint32,i=4);for(var o=new r(n),h=0;h<n;++h)o[h]=e.call(s,a,!0),a+=i;return o},r.prototype._parseSkin=function(t,e){var r=t.skin,i=this._gltf.skins[r];i.name=i.name||"skin ";var a=this._getAccessor(i.inverseBindMatrices),s=a.data,n=a.byteOffset,o=new v.Skeleton,h=new v.SkeletonPose,l=this._nodes[i.skeleton],u=new v.Matrix4x4;l.parent&&l.parent.detach(l);for(var p=0;p<i.joints.length;++p){var _=i.joints[p],c=new v.SkeletonJoint;c.inverseBindPose=this._readMatrix4x4(s,n),n+=64,c.inverseBindPose.prepend(this._flipCoord),c.inverseBindPose.append(this._flipCoord),c.inverseBindPose.append(u),o.addJoint(c);var f=this._nodes[_];if(void 0!==f._jointIndex)throw new Error("Adding one node to multiple skeletons!");f._jointIndex=p,f._skeletonPose=h,f._skeleton=o,i.name&&(c.name=i.name+"_joint_"+p);var d=new v.SkeletonJointPose;d.position.copyFrom(f.position),d.rotation.copyFrom(f.rotation),d.scale.copyFrom(f.scale),h.setJointPose(p,d),this._animationTargetNodes[c.name]=e}for(p=0;p<i.joints.length;++p)_=i.joints[p],f=this._nodes[_],(c=o.getJoint(p)).parentIndex=f!==l&&f.parent?f.parent._jointIndex:-1;var m=e.getComponentsByType(v.MeshInstance);for(p=0;p<m.length;++p){var g=m[p];g.mesh.skeleton=o,g.skeletonPose=h}},r.prototype._parseNodes=function(){var t=this._gltf.nodes;if(t){var e=new v.Matrix4x4;this._nodes=[];for(var r=0;r<t.length;++r){var i,a=t[r];a.hasOwnProperty("mesh")?(i=this._entities[a.mesh],a.name&&(i.name=a.name)):i=new v.SceneNode,this._animationTargetNodes[i.name]=i,a.rotation&&(i.rotation.set(a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3]),e.fromQuaternion(i.rotation),e.prepend(this._flipCoord),e.append(this._flipCoord),i.rotation.fromMatrix(e)),a.translation&&i.position.set(-a.translation[0],a.translation[2],a.translation[1],1),a.scale&&(e.fromScale(a.scale[0],a.scale[1],a.scale[2]),e.prepend(this._flipCoord),e.append(this._flipCoord),i.scale.set(e.getColumn(0).length,e.getColumn(1).length,e.getColumn(2).length)),a.matrix&&(i.matrix=new v.Matrix4x4(a.matrix),i.matrix.prepend(this._flipCoord),i.matrix.append(this._flipCoord)),this._nodes[r]=i}for(r=0;r<t.length;++r)if(a=t[r],i=this._nodes[r],a.children)for(var s=0;s<a.children.length;++s){var n=a.children[s];i.attach(this._nodes[n])}for(r=0;r<t.length;++r)a=t[r],i=this._nodes[r],a.hasOwnProperty("skin")&&this._parseSkin(a,i)}},r.prototype._parseScenes=function(){var t=this._gltf.scenes;if(t)for(var e=0;e<t.length;++e){var r,i=t[e];e===this._defaultSceneIndex?r=this._target.defaultScene:(r=new v.Scene,this._target.scenes.push(r));for(var a=i.nodes,s=0;s<a.length;++s){var n=a[s];r.attach(this._nodes[n])}}},r.prototype._parseAnimationSampler=function(t,e){var r=this._getAccessor(t.input),i=this._getAccessor(t.output),a=r.data,s=i.data,n=r.byteOffset,o=i.byteOffset,h=new v.Matrix4x4,l=i.count/r.count,u=[];if(1===l)var p=u[0]=new v.AnimationClip;else for(var _=0;_<l;++_)u[_]=new v.AnimationClip;for(var c=0;c<r.count;++c){var f;switch(i.numComponents){case 1:for(f=[],_=0;_<l;++_)f[_]=this._readFloat(s,o+4*_);break;case 3:if(f=this._readFloat3(s,o),e){f.x=-f.x;var d=f.y;f.y=f.z,f.z=d}break;case 4:f=this._readQuat(s,o),e&&(h.fromQuaternion(f),h.prepend(this._flipCoord),h.append(this._flipCoord),f.fromMatrix(h));break;default:throw new Error("Unsupported animation sampler type")}var m,g=1e3*this._readFloat(a,n);if(1===l)m=new v.KeyFrame(g,f),p.addKeyFrame(m);else for(_=0;_<l;++_)m=new v.KeyFrame(g,f[_]),u[_].addKeyFrame(m);o+=i.numComponents*l*4,n+=4}return u},r.prototype._parseAnimations=function(){var t=this._gltf.animations;if(t)for(var e=0;e<t.length;++e){for(var r=t[e],i=new v.LayeredAnimation,a=0;a<r.channels.length;++a)for(var s=this._parseAnimationChannel(r.channels[a],r.samplers),n=0;n<s.length;++n)i.addLayer(s[n]);i.name=r.name||"animation_"+e,this._animations.push(i)}},r.prototype._parseAnimationChannel=function(t,e){var r,i=this._nodes[t.target.node],a=[];switch(void 0!==i._jointIndex?(r=i._skeleton.getJoint(i._jointIndex).name,i=i._skeletonPose._jointPoses[i._jointIndex]):r=i.name,t.target.path){case"translation":var s=this._parseAnimationSampler(e[t.sampler],!0);a=[new v.AnimationLayerFloat4(r,"position",s[0])];break;case"rotation":s=this._parseAnimationSampler(e[t.sampler],!0),a=[new v.AnimationLayerQuat(r,"rotation",s[0])];break;case"scale":s=this._parseAnimationSampler(e[t.sampler],!1),a=[new v.AnimationLayerFloat4(r,"scale",s[0])];break;case"weights":s=this._parseAnimationSampler(e[t.sampler],!1),a=[];for(var n=0;n<s.length;++n)a.push(new v.AnimationLayerMorphTarget(i.getFirstComponentByType(v.MorphAnimation).name,"morphTarget_"+n,s[n]));break;default:throw new Error("Unknown channel path!")}return a},r.prototype._assignAnimations=function(){for(var t=this._animations,e=0,r=t.length;e<r;++e){var i=t[e];this._animationTargetNodes[i._layers[0]._targetName]._scene.rootNode.addComponent(i)}},r.prototype._readFloat3=function(t,e){var r=new v.Float4;return r.x=t.getFloat32(e,!0),r.y=t.getFloat32(e+4,!0),r.z=t.getFloat32(e+8,!0),r},r.prototype._readQuat=function(t,e){var r=new v.Quaternion;return r.x=t.getFloat32(e,!0),r.y=t.getFloat32(e+4,!0),r.z=t.getFloat32(e+8,!0),r.w=t.getFloat32(e+12,!0),r},r.prototype._readFloat=function(t,e){return t.getFloat32(e,!0)},r.prototype._readMatrix4x4=function(t,e){for(var r=[],i=0;i<16;++i)r[i]=t.getFloat32(e,!0),e+=4;return new v.Matrix4x4(r)},i.prototype={bind:function(t,e){this._lookUp[t]=this._listeners.length;var r=e?t.bind(e):t;this._listeners.push(r)},unbind:function(t){var e=this._lookUp[t];void 0!==e&&(this._listeners.splice(e,1),delete this._lookUp[t])},unbindAll:function(){this._listeners=[],this._lookUp={}},dispatch:function(t){for(var e=this._listeners.length,r=0;r<e;++r)this._listeners[r].apply(null,arguments)},get hasListeners(){return 0<this._listeners.length}},a.prototype={queue:function(t,e){var r=1===arguments.length?[t]:Array.apply(null,arguments);this._queue.push({func:t,args:r.slice(1)})},addChildQueue:function(t){this._childQueues.push(t)},execute:function(){if(this._isRunning)throw new Error("Already running!");this._isRunning=!0,this._currentIndex=0,this._executeTask()},_executeTask:function(){setTimeout(this._executeImpl.bind(this))},_executeImpl:function(){if(this.onProgress.dispatch(this._currentIndex/this._queue.length),0<this._childQueues.length){var t=this._childQueues.shift();t.onComplete.bind(this._executeImpl,this),t.execute()}else if(this._queue.length===this._currentIndex)this.onComplete.dispatch();else{var e=this._queue[this._currentIndex];e.func.apply(this,e.args),++this._currentIndex,this._executeTask()}}},(s.prototype=Object.create(v.Importer.prototype)).parse=function(t,e){for(var r=t.split("\n"),i=r.length,a=0;a<i;++a){var s=r[a].replace(/^\s+|\s+$/g,"");this._parseLine(s,e)}this._loadTextures(e)},s.prototype._parseLine=function(t,e){if(0!==t.length&&"#"!==t.charAt(0)){var r=t.split(/\s+/);switch(r[0].toLowerCase()){case"newmtl":this._activeMaterial=new v.BasicMaterial,this._activeMaterial.name=r[1],e[r[1]]=this._activeMaterial;break;case"ns":var i=parseFloat(r[1]);this._activeMaterial.roughness=v.BasicMaterial.roughnessFromShininess(i),this._activeMaterial.roughnessRange=this._activeMaterial.roughness;break;case"kd":this._activeMaterial.color=new v.Color(parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3]));break;case"map_kd":this._activeMaterial.colorMap=this._getTexture(r[1]);break;case"map_d":this._activeMaterial.maskMap=this._getTexture(r[1]),this._activeMaterial.alphaThreshold=.5;break;case"map_ns":this._activeMaterial.specularMap=this._getTexture(r[1]);break;case"map_bump":case"bump":this._activeMaterial.normalMap=this._getTexture(r[1])}}},s.prototype._getTexture=function(t){if(!this._textures[t]){var e=new v.Texture2D;this._textures[t]=e,this._texturesToLoad.push({file:this._correctURL(t),importer:v.JPG,target:e})}return this._textures[t]},s.prototype._loadTextures=function(t){var e=new v.AssetLibrary(null,this.options.crossOrigin);e.fileMap=this.fileMap;var r=this._texturesToLoad;if(0!==r.length){for(var i=0;i<r.length;++i)e.queueAsset(r[i].file,r[i].file,v.AssetLibrary.Type.ASSET,r[i].importer,this.options,r[i].target);e.onComplete.bind(function(){this._notifyComplete(t)},this),e.onProgress.bind(function(t){this._notifyProgress(t)},this),e.load(r)}else this._notifyComplete(t)},(o.prototype=Object.create(v.Importer.prototype)).parse=function(t,e){this._groupsAsObjects=void 0===this.options.groupsAsObjects||this._groupsAsObjects,this._target=e;var r=t.split("\n"),i=r.length;this._pushNewObject("hx_default");for(var a=0;a<i;++a){var s=r[a].replace(/^\s+|\s+$/g,"");this._parseLine(s)}this._mtlLibFile?this._loadMTLLib(this._mtlLibFile):this._finish(null)},o.prototype._finish=function(t){for(var e=new a,r=this._objects.length,i=0;i<r;++i)e.queue(this._translateObject.bind(this),i,t);e.queue(this._notifyComplete.bind(this),this._target),e.execute()},o.prototype._loadMTLLib=function(t){var e=new v.AssetLoader(s),r=this;e.onComplete=function(t){r._finish(t)},e.onProgress=function(t){r._notifyProgress(.8*t)},e.onFail=function(t){r._notifyFailure(t)},e.load(t)},o.prototype._parseLine=function(t){if(0!==t.length&&"#"!==t.charAt(0)){var e=t.split(/\s+/);switch(e[0].toLowerCase()){case"mtllib":this._mtlLibFile=this._correctURL(e[1]);break;case"usemtl":this._setActiveSubGroup(e[1]);break;case"v":this._vertices.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"vt":this._uvs.push(parseFloat(e[1]),parseFloat(e[2]));break;case"vn":this._normals.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"o":this._pushNewObject(e[1]);break;case"g":this._groupsAsObjects?this._pushNewObject(e[1]):this._pushNewGroup(e[1]);break;case"f":this._parseFaceData(e)}}},o.prototype._pushNewObject=function(t){this._activeObject=new o._ObjectData,this._activeObject.name=t,this._objects.push(this._activeObject),this._pushNewGroup("hx_default")},o.prototype._pushNewGroup=function(t){this._activeGroup=new o._GroupData,this._activeGroup.name=t||"Group"+this._activeGroup.length,this._activeObject.groups.push(this._activeGroup),this._setActiveSubGroup("hx_default")},o.prototype._setActiveSubGroup=function(t){this._activeGroup.subgroups[t]=this._activeGroup.subgroups[t]||new o._SubGroupData,this._activeSubGroup=this._activeGroup.subgroups[t]},o.prototype._parseFaceData=function(t){for(var e=new o._FaceData,r=t.length,i=1;i<r;++i){var a=new o._FaceVertexData;e.vertices.push(a);var s=t[i].split("/"),n=3*(s[0]-1);a.posX=this._vertices[n],a.posY=this._vertices[n+1],a.posZ=this._vertices[n+2],1<s.length&&(n=2*(s[1]-1),a.uvU=this._uvs[n],a.uvV=this._uvs[n+1],2<s.length&&(n=3*(s[2]-1),this._hasNormals=!0,a.normalX=this._normals[n],a.normalY=this._normals[n+1],a.normalZ=this._normals[n+2]))}this._activeSubGroup.faces.push(e),this._activeSubGroup.numIndices+=4===t.length?3:6},o.prototype._translateObject=function(t,e){var r=this._objects[t],i=r.groups.length;if(0!==i){for(var a=new v.Entity,s=0;s<i;++s){var n=r.groups[s];for(var o in n.subgroups)if(n.subgroups.hasOwnProperty(o)){var h=n.subgroups[o];if(0===h.numIndices)continue;var l=e?e[o]:null;l=l||this._defaultMaterial;var u=this._translateMesh(h),p=new v.MeshInstance(u,l);a.addComponent(p)}}r.name&&(a.name=r.name),this._target.attach(a),this._notifyProgress(.8+(t+1)/this._objects.length*.2)}},o.prototype._translateMesh=function(t){var e=v.Mesh.createDefaultEmpty(),r=[],i=new Array(t.numIndices),a=0,s=0;t.name&&(e.name=t.name);for(var n=t.faces,o=n.length,h=0;h<o;++h){for(var l=n[h].vertices,u=l.length,p=0;p<u;++p){var _=l[p],c=_.getHash();r.hasOwnProperty(c)||(r[c]={index:a++,vertex:_})}i[s]=r[l[0].getHash()].index,i[s+1]=r[l[2].getHash()].index,i[s+2]=r[l[1].getHash()].index,s+=3,4===u&&(i[s]=r[l[0].getHash()].index,i[s+1]=r[l[3].getHash()].index,i[s+2]=r[l[2].getHash()].index,s+=3)}var f=new Array(a*v.Mesh.DEFAULT_VERTEX_SIZE);for(c in r)if(r.hasOwnProperty(c)){var d=r[c],m=d.vertex,g=d.index*v.Mesh.DEFAULT_VERTEX_SIZE;f[g]=m.posX,f[g+1]=m.posY,f[g+2]=m.posZ,f[g+3]=m.normalX,f[g+4]=m.normalY,f[g+5]=m.normalZ,f[g+6]=0,f[g+7]=0,f[g+8]=0,f[g+9]=1,f[g+10]=m.uvU,f[g+11]=m.uvV}e.setVertexData(f,0),e.setIndexData(i);var y=v.NormalTangentGenerator.MODE_TANGENTS;return this._hasNormals||(y|=v.NormalTangentGenerator.MODE_NORMALS),(new v.NormalTangentGenerator).generate(e,y,!0),e},(o._FaceVertexData=function(){this.posX=0,this.posY=0,this.posZ=0,this.uvU=0,this.uvV=0,this.normalX=0,this.normalY=0,this.normalZ=0,this._hash=""}).prototype={getHash:function(){return this._hash||(this._hash=this.posX+"/"+this.posY+"/"+this.posZ+"/"+this.uvU+"/"+this.uvV+"/"+this.normalX+"/"+this.normalY+"/"+this.normalZ+"/"),this._hash}},o._FaceData=function(){this.vertices=[]},o._SubGroupData=function(){this.numIndices=0,this.faces=[]},o._GroupData=function(){this.subgroups=[],this.name=null,this._activeMaterial=null},o._ObjectData=function(){this.name=null,this.groups=[],this._activeGroup=null},(n.prototype=Object.create(v.Importer.prototype)).parse=function(t,e){var r=JSON.parse(t);if("BufferGeometry"!==r.type)throw new Error("JSON does not contain correct BufferGeometry data! (type property is not BufferGeometry)");v.Mesh.createDefaultEmpty(e),this.parseAttributes(r.data.attributes,e),this.parseIndices(r.data.index,e);var i=r.data.attributes.normal?v.NormalTangentGenerator.MODE_NORMALS:0;(i|=r.data.attributes.tangent?v.NormalTangentGenerator.MODE_TANGENTS:0)&&(new v.NormalTangentGenerator).generate(e,i);this._notifyComplete(e)},n.prototype.parseAttributes=function(t,e){var r={position:"hx_position",normal:"hx_normal",tangent:"hx_tangent",uv:"hx_texCoord"},i=t.position.array.length/t.position.itemSize;for(var a in t)if(t.hasOwnProperty(a)&&!r.hasOwnProperty(a)&&(e.addVertexAttribute(a,t[a].itemSize),"Float32Array"!==t[a].type))throw new Error("Unsupported vertex attribute data type!");var s=e.getVertexStride(0),n=new Float32Array(i*s);for(a in t)if(t.hasOwnProperty(a)){var o=t[a],h=r[a]||a,l=e.getVertexAttributeByName(h),u=o.itemSize,p=0,_=o.array.length,c=l.offset,f=!1;for("position"!==a&&"normal"!==a&&"tangent"!==a||(f=!0);p<_;){for(var d=0;d<u;++d)n[c+d]=o.array[p++];if(f){var m=n[c+1],g=n[c+2];n[c+1]=g,n[c+2]=m}c+=s}}e.setVertexData(n,0)},n.prototype.parseIndices=function(t,e){var r;switch(t.type){case"Uint16Array":r=new Uint16Array(t.array);break;case"Uint32Array":r=new Uint32Array(t.array);break;default:throw new Error("Unsupported index type "+t.type)}e.setIndexData(r)},u.LITTLE_ENDIAN=!0,u.BIG_ENDIAN=!1,u.prototype={get offset(){return this._offset},set offset(t){this._offset=t},get endian(){return this._endian},set endian(t){this._endian=t},get byteLength(){return this._dataView.byteLength},get bytesAvailable(){return this._dataView.byteLength-this._offset},writeChar:function(t){return this.writeUint8(t.charCodeAt(0))},writeUint8:function(t){return this._dataView.setUint8(this._offset++,t)},writeUint16:function(t){var e=this._dataView.setUint16(this._offset,t,this._endian);return this._offset+=2,e},writeUint32:function(t){var e=this._dataView.setUint32(this._offset,t,this._endian);return this._offset+=4,e},writeInt8:function(t){return this._dataView.setInt8(this._offset++,t)},writeInt16:function(t){var e=this._dataView.setInt16(this._offset,t,this._endian);return this._offset+=2,e},writeInt32:function(t){var e=this._dataView.setInt32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat32:function(t){var e=this._dataView.setFloat32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat64:function(t){var e=this._dataView.setFloat64(this._offset,t,this._endian);return this._offset+=8,e},writeString:function(t){for(var e=t.length,r=0;r<e;++r)this.writeUint8(t.charCodeAt(r))},writeUint8Array:function(t){this._writeArray(t,this.writeUint8)},writeUint16Array:function(t){this._writeArray(t,this.writeUint16)},writeUint32Array:function(t){this._writeArray(t,this.writeUint32)},writeInt8Array:function(t){this._writeArray(t,this.writeInt8)},writeInt16Array:function(t){this._writeArray(t,this.writeInt16)},writeInt32Array:function(t){this._writeArray(t,this.writeInt32)},writeFloat32Array:function(t){this._writeArray(t,this.writeFloat32)},writeFloat64Array:function(t){this._writeArray(t,this.writeFloat64)},_writeArray:function(t,e){for(var r=t.length,i=0;i<r;++i)e.call(this,t[i])}},p.VERSION="0.1.0",p.VALUE_TYPE_SKELETON_POSE=1,p.VALUE_TYPE_NUMBER=2,p.VALUE_TYPE_FLOAT3=3,p.VALUE_TYPE_QUATERNION=4,p.prototype={export:function(t){var e=this._getValueType(t),r=this._calculateFileSize(t,e),i=new ArrayBuffer(r),a=new u(new DataView(i)),s=p.VERSION.split(".");a.writeString("HX_CLIP"),a.writeUint16Array(s),a.writeUint8(e);var n=t.numKeyFrames;if(a.writeUint32(n),e===p.VALUE_TYPE_SKELETON_POSE){var o=t.getKeyFrame(0),h=o.value;a.writeUint8(h.numJoints)}else a.writeUint8(0);for(var l=0;l<n;++l)o=t.getKeyFrame(l),a.writeUint32(o.time),this._writeValue(a,e,o.value);return i},_getValueType:function(t){var e=t.getKeyFrame(0).value;if(e instanceof v.SkeletonPose)return p.VALUE_TYPE_SKELETON_POSE;if(e instanceof v.Float4)return p.VALUE_TYPE_FLOAT3;if(e instanceof v.Quaternion)return p.VALUE_TYPE_QUATERNION;if("number"==typeof e)return p.VALUE_TYPE_NUMBER;throw new Error("Unsupported animation clip")},_writeValue:function(t,e,r){if(e===p.VALUE_TYPE_SKELETON_POSE)for(var i=r.numJoints,a=0;a<i;++a){var s=r.getJointPose(a);t.writeFloat32(s.position.x),t.writeFloat32(s.position.y),t.writeFloat32(s.position.z),t.writeFloat32(s.rotation.x),t.writeFloat32(s.rotation.y),t.writeFloat32(s.rotation.z),t.writeFloat32(s.rotation.w),t.writeFloat32(s.scale.x),t.writeFloat32(s.scale.y),t.writeFloat32(s.scale.z)}else e===p.VALUE_TYPE_FLOAT3?(t.writeFloat32(r.x),t.writeFloat32(r.y),t.writeFloat32(r.z)):e===p.VALUE_TYPE_QUATERNION?(t.writeFloat32(r.x),t.writeFloat32(r.y),t.writeFloat32(r.z),t.writeFloat32(r.w)):e===p.VALUE_TYPE_NUMBER&&t.writeFloat32(r)},_calculateFileSize:function(t,e){var r=7;r+=6,r+=1,r+=4,r+=1;var i=this._calculateKeyFrameSize(e,t);return r+=t.numKeyFrames*i},_calculateKeyFrameSize:function(t,e){var r=4;t===p.VALUE_TYPE_SKELETON_POSE?r+=10*e.getKeyFrame(0).value.numJoints*4:t===p.VALUE_TYPE_FLOAT3?r+=12:t===p.VALUE_TYPE_QUATERNION?r+=16:t===p.VALUE_TYPE_NUMBER&&(r+=4);return r}},h.VERSION="0.1.0",h.prototype={export:function(t){var e=this._calculateFileSize(t),r=new ArrayBuffer(e),i=new u(new DataView(r)),a=h.VERSION.split(".");return i.writeString("HX_MESH"),i.writeUint16Array(a),this._writeMeshData(i,t),this._writeSkeleton(i,t.skeleton),r},_writeMeshData:function(t,e){t.writeUint32(e.numIndices),e._indexType===v.DataType.UNSIGNED_INT?(t.writeUint8(32),t.writeUint32Array(e.getIndexData())):(t.writeUint8(16),t.writeUint16Array(e.getIndexData())),t.writeUint32(e.numVertices),t.writeUint8(e.numVertexAttributes);for(var r=0;r<e.numVertexAttributes;++r){var i=e.getVertexAttributeByIndex(r);t.writeUint8(i.name.length),t.writeString(i.name),t.writeUint8(i.streamIndex),t.writeUint8(i.numComponents)}for(t.writeUint8(e.numStreams),r=0;r<e.numStreams;++r){var a=e.getVertexData(r);t.writeUint32(a.length),t.writeFloat32Array(a)}},_writeSkeleton:function(t,e){var r=e?e.numJoints:0;t.writeUint8(r);for(var i=0;i<r;++i){var a=e.getJoint(i);a.name?(t.writeUint8(a.name.length),t.writeString(a.name)):t.writeUint8(0),t.writeUint8(-1===a.parentIndex?255:a.parentIndex),t.writeFloat32Array(a.inverseBindPose._m)}},_calculateFileSize:function(t){var e=7;e+=6,e+=4,e+=1,e+=(t._indexType===v.DataType.UNSIGNED_INT?4:2)*t.numIndices,e+=4,e+=1;for(var r=0;r<t.numVertexAttributes;++r){e+=1,e+=t.getVertexAttributeByIndex(r).name.length,e+=1,e+=1}for(e+=1,r=0;r<t.numStreams;++r)e+=4,e+=4*t.getVertexData(r).length;e+=1;for(var i=t.skeleton?t.skeleton.numJoints:0,a=0;a<i;++a){var s=t.skeleton.getJoint(a);e+=1,e+=s.name?s.name.length:0,e+=1,e+=64}return e}},t.GLTF=r,t.GLTFData=e,t.OBJ=o,t.MTL=s,t.THREEBufferGeometry=n,t.AnimationClipExporter=p,t.MeshExporter=h,Object.defineProperty(t,"__esModule",{value:!0})});