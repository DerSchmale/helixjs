!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("helix")):"function"==typeof define&&define.amd?define("HX_IO",["exports","helix"],e):e(t.HX_IO={},t.HX)}(this,function(t,E){"use strict";function e(){this.defaultScene=new E.Scene,this.scenes={}}function F(t,e){return t.getFloat32(e,!0)}function y(t,e){for(var i=[],r=0;r<16;++r)i[r]=t.getFloat32(e,!0),e+=4;return new E.Matrix4x4(i)}function i(){E.Importer.call(this,e),this._numComponentLookUp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},this._flipCoord=new E.Matrix4x4,this._flipCoord.setColumn(0,new E.Float4(-1,0,0,0)),this._flipCoord.setColumn(1,new E.Float4(0,0,1,0)),this._flipCoord.setColumn(2,new E.Float4(0,1,0,0))}function r(){this._listeners=[],this._lookUp={}}function n(){this.onComplete=new r,this.onProgress=new r,this._queue=[],this._childQueues=[],this._currentIndex=0,this._isRunning=!1}function a(){E.Importer.call(this,Object,E.URLLoader.DATA_TEXT),this._textures=[],this._texturesToLoad=[],this._activeMaterial=null}function o(){E.Importer.call(this,E.Entity),this._objects=[],this._vertices=[],this._normals=[],this._uvs=[],this._hasNormals=!1,this._defaultMaterial=new E.BasicMaterial,this._target=null,this._mtlLibFile=null}function s(){E.Importer.call(this,E.Mesh)}function u(t){this._dataView=t,this._offset=0,this._endian=u.LITTLE_ENDIAN}function p(){}function h(){}(i.prototype=Object.create(E.Importer.prototype)).parse=function(t,e){this._defaultSceneIndex=void 0,this._gltf=JSON.parse(t);var i=this._gltf.asset;if(this._target=e,this._animationTargetNodes={},this._animations=[],i.hasOwnProperty("minVersion"))i.minVersion.split(".");if(i.hasOwnProperty("version")&&"2"!==i.version.split(".")[0])throw new Error("Unsupported glTF version!");this._assetLibrary=new E.AssetLibrary,this._binFileCheck={},this._queueImages(),this._queueBuffers(),this._assetLibrary.onComplete.bind(function(){this._continueParsing()},this),this._assetLibrary.onProgress.bind(function(t){this._notifyProgress(.8*t)},this),this._assetLibrary.load()},i.prototype._continueParsing=function(){var t=this._gltf;t.hasOwnProperty("scene")&&(this._defaultSceneIndex=t.scene);var e=new E.AsyncTaskQueue;e.queue(this._parseMaterials.bind(this)),e.queue(this._parseMeshes.bind(this)),e.queue(this._parseNodes.bind(this)),e.queue(this._parseScenes.bind(this)),e.queue(this._parseAnimations.bind(this)),e.queue(this._assignAnimations.bind(this)),e.onComplete.bind(this._finalize.bind(this)),e.onProgress.bind(function(t){this._notifyProgress(.8+.2*t)}.bind(this)),e.execute()},i.prototype._finalize=function(){for(var t=new E.AsyncTaskQueue,e=0,i=this._materials.length;e<i;++e){var r=this._materials[e];t.queue(r.init.bind(r))}t.onComplete.bind(function(){this._notifyComplete(this._target)}.bind(this)),t.execute()},i.prototype._getAccessor=function(t){var e,i=this._gltf.accessors[t];void 0!==i.bufferView&&(e=this._getBufferView(i.bufferView));var r={dataType:i.componentType,numComponents:this._numComponentLookUp[i.type],type:i.type,data:e?e.data:null,min:i.min,max:i.max,byteOffset:e.byteOffset+(i.byteOffset||0),byteStride:e.byteStride,count:i.count,isSparse:!1};if(i.sparse){r.isSparse=!0,r.sparseCount=i.sparse.count,r.sparseOffsets=[];var a=this._getBufferView(i.sparse.indices.bufferView),s=this._getBufferView(i.sparse.values.bufferView);r.sparseIndices={data:a.data,byteOffset:i.sparse.indices.byteOffset,dataType:i.componentType},r.sparseValues={data:s.data,byteOffset:i.values.indices.byteOffset}}return r},i.prototype._getBufferView=function(t){var e=this._gltf.bufferViews[t],i=this._buffers[e.buffer],r=i.byteOffset+(e.byteOffset||0);return{data:this._assetLibrary.get(i.assetID),byteOffset:r,byteLength:e.byteLength,byteStride:e.byteStride}},i.prototype._queueImages=function(){var t=this._gltf.images;if(t)for(var e=0;e<t.length;++e){var i=t[e];this._assetLibrary.queueAsset("hx_image_"+e,this._correctURL(i.uri),E.AssetLibrary.Type.ASSET,E.JPG)}},i.prototype._queueBuffers=function(){var t=this._gltf.buffers;if(t){this._buffers=[];for(var e=0;e<t.length;++e){var i=t[e];if(!this._binFileCheck[i.uri]){var r="hx_bin_"+e;this._assetLibrary.queueAsset(r,this._correctURL(i.uri),E.AssetLibrary.Type.RAW_BINARY),this._binFileCheck[i.uri]=!0,this._buffers[e]={assetID:r,byteOffset:i.byteOffset||0,byteLength:i.byteLength}}}}},i.prototype._parseMaterials=function(){var t=this._gltf.materials;if(t){this._materials=[];for(var e=0;e<t.length;++e){var i=t[e],r=new E.BasicMaterial;if(r.name=i.name,r.specularMapMode=E.BasicMaterial.SPECULAR_MAP_METALLIC_ROUGHNESS,r.normalMap=this._getTexture(i.normalTexture),r.occlusionMap=this._getTexture(i.occlusionTexture),r.emissionMap=this._getTexture(i.emissiveTexture),i.doubleSided&&(r.cullMode=E.CullMode.NONE),i.emissiveFactor){var a=new E.Color(i.emissiveFactor[0],i.emissiveFactor[1],i.emissiveFactor[2],1);r.emissiveColor=a.linearToGamma()}else r.emissionMap&&(r.emissiveColor=E.Color.WHITE);var s=i.pbrMetallicRoughness;if(s){if(r.colorMap=this._getTexture(s.baseColorTexture),r.specularMap=this._getTexture(s.metallicRoughnessTexture),s.baseColorFactor){var n=new E.Color(s.baseColorFactor[0],s.baseColorFactor[1],s.baseColorFactor[2],s.baseColorFactor[3]);r.color=n.linearToGamma()}r.metallicness=void 0===s.metallicFactor?1:s.metallicFactor,r.roughness=void 0===s.roughnessFactor?1:s.roughnessFactor,r.specularMap&&(r.roughness*=.5,r.roughnessRange=-r.roughness)}this._materials[e]=r}}},i.prototype._getTexture=function(t){return t?this._assetLibrary.get("hx_image_"+this._gltf.textures[t.index].source):null},i.prototype._parseMeshes=function(){var t=this._gltf.meshes;if(t){this._entities=[];for(var e=0,i=t.length;e<i;++e){var r=t[e],a=new E.Entity;a.name=r.name;for(var s=0,n=r.primitives.length;s<n;++s){var o=r.primitives[s];this._parsePrimitive(o,a),r.weights&&this._parseMorphWeights(r.weights,a)}this._entities[e]=a}}},i.prototype._parseMorphWeights=function(t,e){var i=new E.MorphAnimation;if(t)for(var r=0,a=t.length;r<a;++r)i.setWeight("morphTarget_"+r,t[r]);e.addComponent(i),this._animationTargetNodes[i.name]=e},i.prototype._parseMorphTargets=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],a=new E.MorphTarget;a.name="morphTarget_"+i;var s=this._getAccessor(r.POSITION),n=void 0!==r.NORMAL?this._getAccessor(r.NORMAL):null,o=new Float32Array(3*s.count);if(this._readVertexData(o,0,s,3,3,!0),n){var h=new Float32Array(3*n.count);this._readVertexData(h,0,n,3,3,!0)}a.init(o,h),e.addMorphTarget(a)}},i.prototype._parsePrimitive=function(t,e){var i=E.Mesh.createDefaultEmpty(),r=t.attributes,a=this._getAccessor(r.POSITION),s=void 0!==r.NORMAL?this._getAccessor(r.NORMAL):null,n=void 0!==r.TANGENT?this._getAccessor(r.TANGENT):null,o=void 0!==r.TEXCOORD_0?this._getAccessor(r.TEXCOORD_0):null,h=void 0!==r.JOINTS_0?this._getAccessor(r.JOINTS_0):null,l=void 0!==r.WEIGHTS_0?this._getAccessor(r.WEIGHTS_0):null,u=0,p=i.getVertexStride(0),_=new Float32Array(a.count*p);this._readVertexData(_,0,a,3,p,!0),s?this._readVertexData(_,3,s,3,p,!0):u=E.NormalTangentGenerator.MODE_NORMALS,n?this._readVertexData(_,6,n,4,p,!0):o&&(u|=E.NormalTangentGenerator.MODE_TANGENTS),o&&this._readUVData(_,10,o,p),i.setVertexData(_,0),t.hasOwnProperty("mode")&&(i.elementType=t.mode);var c=this._getAccessor(t.indices);(i.setIndexData(this._readIndices(c)),u)&&(new E.NormalTangentGenerator).generate(i);if(h){i.addVertexAttribute("hx_jointIndices",4,1),i.addVertexAttribute("hx_jointWeights",4,1),p=i.getVertexStride(1);var f=new Float32Array(h.count*p);this._readVertexData(f,0,h,4,p),this._readVertexData(f,4,l,4,p),i.setVertexData(f,1)}e.addComponent(new E.MeshInstance(i,this._materials[t.material])),t.targets&&0<t.targets.length&&this._parseMorphTargets(t.targets,i)},i.prototype._readVertexData=function(t,e,i,r,a,s){var n,o,h,l=e,u=i.byteOffset,p=i.count,_=i.data,c=i.byteStride||0;if(_){if(i.dataType===E.DataType.FLOAT)o=_.getFloat32,h=4;else if(i.dataType===E.DataType.UNSIGNED_SHORT)o=_.getUint16,h=2;else if(i.dataType===E.DataType.UNSIGNED_INT)o=_.getUint32,h=4;else{if(i.dataType!==E.DataType.UNSIGNED_BYTE)throw new Error("Unknown data type "+i.dataType);o=_.getUint8,h=1}for(n=0;n<p;++n){for(var f=u,d=0;d<r;++d)t[l+d]=o.call(_,u,!0),u+=h;l+=a,c&&(u=f+c)}}else{for(n=0;n<p;++n)for(d=0;d<r;++d)t[l+d]=0;l+=a}if(i.isSparse&&this._applySparseAccessor(t,i,r,a,o,h),s)for(l=e,n=0;n<p;++n){var m=t[l+1];t[l]=-t[l],t[l+1]=t[l+2],t[l+2]=m,l+=a}},i.prototype._applySparseAccessor=function(t,e,i,r,a,s){var n,o,h=e.sparseCount,l=e.sparseIndices.data,u=e.sparseValues.data,p=e.sparseIndices.byteOffset,_=e.sparseValues.byteOffset;e.dataType===E.DataType.UNSIGNED_SHORT?(n=l.getUint16,o=2):e.dataType===E.DataType.UNSIGNED_INT&&(n=l.getUint32,o=4);for(var c=0;c<h;++c){for(var f=n.call(l,p)*r,d=0;d<i;++d){var m=a.call(u,_,!0);_+=s,t[f+d]=m}p+=o}},i.prototype._readUVData=function(t,e,i,r){for(var a=e,s=i.byteOffset,n=i.count,o=i.data,h=0;h<n;++h)t[a]=o.getFloat32(s,!0),t[a+1]=1-o.getFloat32(s+4,!0),s+=8,a+=r},i.prototype._readIndices=function(t){var e,i,r,a=t.byteOffset,s=t.data,n=t.count;if(t.dataType===E.DataType.UNSIGNED_SHORT)i=Uint16Array,e=s.getUint16,r=2;else{if(t.dataType!==E.DataType.UNSIGNED_INT)throw new Error("Unknown data type for indices!");i=Uint32Array,e=s.getUint32,r=4}for(var o=new i(n),h=0;h<n;++h)o[h]=e.call(s,a,!0),a+=r;return o},i.prototype._parseSkin=function(t,e){var i=t.skin,r=this._gltf.skins[i];r.name=r.name||"skin ";var a=this._getAccessor(r.inverseBindMatrices),s=a.data,n=a.byteOffset,o=new E.Skeleton,h=new E.SkeletonPose,l=this._nodes[r.skeleton],u=new E.Matrix4x4;l.parent&&l.parent.detach(l);for(var p=0;p<r.joints.length;++p){var _=r.joints[p],c=new E.SkeletonJoint;c.inverseBindPose=y(s,n),n+=64,c.inverseBindPose.prepend(this._flipCoord),c.inverseBindPose.append(this._flipCoord),c.inverseBindPose.append(u),o.addJoint(c);var f=this._nodes[_];if(void 0!==f._jointIndex)throw new Error("Adding one node to multiple skeletons!");f._jointIndex=p,f._skeletonPose=h,f._skeleton=o,r.name&&(c.name=r.name+"_joint_"+p);var d=new E.SkeletonJointPose;d.position.copyFrom(f.position),d.rotation.copyFrom(f.rotation),d.scale.copyFrom(f.scale),h.setJointPose(p,d),this._animationTargetNodes[c.name]=e}for(p=0;p<r.joints.length;++p)_=r.joints[p],f=this._nodes[_],(c=o.getJoint(p)).parentIndex=f!==l&&f.parent?f.parent._jointIndex:-1;var m=e.getComponentsByType(E.MeshInstance);for(p=0;p<m.length;++p){var g=m[p];g.mesh.skeleton=o,g.skeletonPose=h}},i.prototype._parseNodes=function(){var t=this._gltf.nodes;if(t){var e=new E.Matrix4x4;this._nodes=[];for(var i=0;i<t.length;++i){var r,a=t[i];a.hasOwnProperty("mesh")?(r=this._entities[a.mesh],a.name&&(r.name=a.name)):r=new E.SceneNode,this._animationTargetNodes[r.name]=r,a.rotation&&(r.rotation.set(a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3]),e.fromQuaternion(r.rotation),e.prepend(this._flipCoord),e.append(this._flipCoord),r.rotation.fromMatrix(e)),a.translation&&r.position.set(-a.translation[0],a.translation[2],a.translation[1],1),a.scale&&(e.fromScale(a.scale[0],a.scale[1],a.scale[2]),e.prepend(this._flipCoord),e.append(this._flipCoord),r.scale.set(e.getColumn(0).length,e.getColumn(1).length,e.getColumn(2).length)),a.matrix&&(r.matrix=new E.Matrix4x4(a.matrix),r.matrix.prepend(this._flipCoord),r.matrix.append(this._flipCoord)),this._nodes[i]=r}for(i=0;i<t.length;++i)if(a=t[i],r=this._nodes[i],a.children)for(var s=0;s<a.children.length;++s){var n=a.children[s];r.attach(this._nodes[n])}for(i=0;i<t.length;++i)a=t[i],r=this._nodes[i],a.hasOwnProperty("skin")&&this._parseSkin(a,r)}},i.prototype._parseScenes=function(){var t=this._gltf.scenes;if(t)for(var e=0;e<t.length;++e){var i,r=t[e];e===this._defaultSceneIndex?i=this._target.defaultScene:(i=new E.Scene,this._target.scenes.push(i));for(var a=r.nodes,s=0;s<a.length;++s){var n=a[s];i.attach(this._nodes[n])}}},i.prototype._parseAnimationSampler=function(t,e,i){var r,a,s,n,o,h,l=this._getAccessor(t.input),u=this._getAccessor(t.output),p=l.data,_=u.data,c=l.byteOffset,f=u.byteOffset,d=new E.Matrix4x4,m=u.count/l.count,g=[];if(1===m){var y=g[0]=new E.AnimationClip;y.duration=i}else for(var v=0;v<m;++v)g[v]=new E.AnimationClip,g[v].duration=i;for(var w=0;w<l.count;++w){var b;switch(u.numComponents){case 1:for(b=[],v=0;v<m;++v)b[v]=F(_,f+4*v);break;case 3:if(n=_,o=f,h=void 0,(h=new E.Float4).x=n.getFloat32(o,!0),h.y=n.getFloat32(o+4,!0),h.z=n.getFloat32(o+8,!0),b=h,e){b.x=-b.x;var A=b.y;b.y=b.z,b.z=A}break;case 4:r=_,a=f,s=void 0,(s=new E.Quaternion).x=r.getFloat32(a,!0),s.y=r.getFloat32(a+4,!0),s.z=r.getFloat32(a+8,!0),s.w=r.getFloat32(a+12,!0),b=s,e&&(d.fromQuaternion(b),d.prepend(this._flipCoord),d.append(this._flipCoord),b.fromMatrix(d));break;default:throw new Error("Unsupported animation sampler type")}var T,x=1e3*F(p,c);if(1===m)T=new E.KeyFrame(x,b),y.addKeyFrame(T);else for(v=0;v<m;++v)T=new E.KeyFrame(x,b[v]),g[v].addKeyFrame(T);f+=u.numComponents*m*4,c+=4}return g},i.prototype._parseAnimations=function(){var t=this._gltf.animations;if(t)for(var e=0;e<t.length;++e){for(var i=t[e],r=new E.LayeredAnimation,a=0,s=0;s<i.samplers.length;++s){var n=this._gltf.accessors[i.samplers[s].input].max[0];a=Math.max(a,n)}for(a*=1e3,s=0;s<i.channels.length;++s)for(var o=this._parseAnimationChannel(i.channels[s],i.samplers,a),h=0;h<o.length;++h)r.addLayer(o[h]);r.name=i.name||"animation_"+e,this._animations.push(r)}},i.prototype._parseAnimationChannel=function(t,e,i){var r,a=this._nodes[t.target.node],s=[];switch(void 0!==a._jointIndex?(r=a._skeleton.getJoint(a._jointIndex).name,a=a._skeletonPose._jointPoses[a._jointIndex]):r=a.name,t.target.path){case"translation":var n=this._parseAnimationSampler(e[t.sampler],!0,i);s=[new E.AnimationLayerFloat4(r,"position",n[0])];break;case"rotation":n=this._parseAnimationSampler(e[t.sampler],!0,i),s=[new E.AnimationLayerQuat(r,"rotation",n[0])];break;case"scale":n=this._parseAnimationSampler(e[t.sampler],!1,i),s=[new E.AnimationLayerFloat4(r,"scale",n[0])];break;case"weights":n=this._parseAnimationSampler(e[t.sampler],!1,i),s=[];for(var o=0;o<n.length;++o)s.push(new E.AnimationLayerMorphTarget(a.getFirstComponentByType(E.MorphAnimation).name,"morphTarget_"+o,clip));break;default:throw new Error("Unknown channel path!")}return s},i.prototype._assignAnimations=function(){for(var t=this._animations,e=0,i=t.length;e<i;++e){var r=t[e];this._animationTargetNodes[r._layers[0]._targetName]._scene.rootNode.addComponent(r)}},r.prototype={bind:function(t,e){this._lookUp[t]=this._listeners.length;var i=e?t.bind(e):t;this._listeners.push(i)},unbind:function(t){var e=this._lookUp[t];void 0!==e&&(this._listeners.splice(e,1),delete this._lookUp[t])},unbindAll:function(){this._listeners=[],this._lookUp={}},dispatch:function(t){for(var e=this._listeners.length,i=0;i<e;++i)this._listeners[i].apply(null,arguments)},get hasListeners(){return 0<this._listeners.length}},n.prototype={queue:function(t,e){var i=1===arguments.length?[t]:Array.apply(null,arguments);this._queue.push({func:t,args:i.slice(1)})},addChildQueue:function(t){this._childQueues.push(t)},execute:function(){if(this._isRunning)throw new Error("Already running!");this._isRunning=!0,this._currentIndex=0,this._executeTask()},_executeTask:function(){setTimeout(this._executeImpl.bind(this))},_executeImpl:function(){if(this.onProgress.dispatch(this._currentIndex/this._queue.length),0<this._childQueues.length){var t=this._childQueues.shift();t.onComplete.bind(this._executeImpl,this),t.execute()}else if(this._queue.length===this._currentIndex)this.onComplete.dispatch();else{var e=this._queue[this._currentIndex];e.func.apply(this,e.args),++this._currentIndex,this._executeTask()}}},(a.prototype=Object.create(E.Importer.prototype)).parse=function(t,e){for(var i=t.split("\n"),r=i.length,a=0;a<r;++a){var s=i[a].replace(/^\s+|\s+$/g,"");this._parseLine(s,e)}this._loadTextures(e)},a.prototype._parseLine=function(t,e){if(0!==t.length&&"#"!==t.charAt(0)){var i=t.split(/\s+/);switch(i[0].toLowerCase()){case"newmtl":this._activeMaterial=new E.BasicMaterial,this._activeMaterial.name=i[1],e[i[1]]=this._activeMaterial;break;case"ns":var r=parseFloat(i[1]);this._activeMaterial.roughness=E.BasicMaterial.roughnessFromShininess(r),this._activeMaterial.roughnessRange=this._activeMaterial.roughness;break;case"kd":this._activeMaterial.color=new E.Color(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));break;case"map_kd":this._activeMaterial.colorMap=this._getTexture(i[1]);break;case"map_d":this._activeMaterial.maskMap=this._getTexture(i[1]),this._activeMaterial.alphaThreshold=.5;break;case"map_ns":this._activeMaterial.specularMap=this._getTexture(i[1]);break;case"map_bump":case"bump":this._activeMaterial.normalMap=this._getTexture(i[1])}}},a.prototype._getTexture=function(t){if(!this._textures[t]){var e=new E.Texture2D;this._textures[t]=e,this._texturesToLoad.push({file:this._correctURL(t),importer:E.JPG,target:e})}return this._textures[t]},a.prototype._loadTextures=function(t){var e=new E.AssetLibrary(null,this.options.crossOrigin);e.fileMap=this.fileMap;var i=this._texturesToLoad;if(0!==i.length){for(var r=0;r<i.length;++r)e.queueAsset(i[r].file,i[r].file,E.AssetLibrary.Type.ASSET,i[r].importer,this.options,i[r].target);e.onComplete.bind(function(){this._notifyComplete(t)},this),e.onProgress.bind(function(t){this._notifyProgress(t)},this),e.load(i)}else this._notifyComplete(t)},(o.prototype=Object.create(E.Importer.prototype)).parse=function(t,e){this._groupsAsObjects=void 0===this.options.groupsAsObjects||this._groupsAsObjects,this._target=e;var i=t.split("\n"),r=i.length;this._pushNewObject("hx_default");for(var a=0;a<r;++a){var s=i[a].replace(/^\s+|\s+$/g,"");this._parseLine(s)}this._mtlLibFile?this._loadMTLLib(this._mtlLibFile):this._finish(null)},o.prototype._finish=function(t){for(var e=new n,i=this._objects.length,r=0;r<i;++r)e.queue(this._translateObject.bind(this),r,t);for(var a in t)if(t.hasOwnProperty(a)){var s=t[a];e.queue(s.init.bind(s))}e.onComplete.bind(this._onComplete,this),e.execute()},o.prototype._onComplete=function(){this._notifyComplete(this._target)},o.prototype._loadMTLLib=function(t){var e=new E.AssetLoader(a),i=this;e.onComplete=function(t){i._finish(t)},e.onProgress=function(t){i._notifyProgress(.8*t)},e.onFail=function(t){i._notifyFailure(t)},e.load(t)},o.prototype._parseLine=function(t){if(0!==t.length&&"#"!==t.charAt(0)){var e=t.split(/\s+/);switch(e[0].toLowerCase()){case"mtllib":this._mtlLibFile=this._correctURL(e[1]);break;case"usemtl":this._setActiveSubGroup(e[1]);break;case"v":this._vertices.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"vt":this._uvs.push(parseFloat(e[1]),parseFloat(e[2]));break;case"vn":this._normals.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"o":this._pushNewObject(e[1]);break;case"g":this._groupsAsObjects?this._pushNewObject(e[1]):this._pushNewGroup(e[1]);break;case"f":this._parseFaceData(e)}}},o.prototype._pushNewObject=function(t){this._activeObject=new o._ObjectData,this._activeObject.name=t,this._objects.push(this._activeObject),this._pushNewGroup("hx_default")},o.prototype._pushNewGroup=function(t){this._activeGroup=new o._GroupData,this._activeGroup.name=t||"Group"+this._activeGroup.length,this._activeObject.groups.push(this._activeGroup),this._setActiveSubGroup("hx_default")},o.prototype._setActiveSubGroup=function(t){this._activeGroup.subgroups[t]=this._activeGroup.subgroups[t]||new o._SubGroupData,this._activeSubGroup=this._activeGroup.subgroups[t]},o.prototype._parseFaceData=function(t){for(var e=new o._FaceData,i=t.length,r=1;r<i;++r){var a=new o._FaceVertexData;e.vertices.push(a);var s=t[r].split("/"),n=3*(s[0]-1);a.posX=this._vertices[n],a.posY=this._vertices[n+1],a.posZ=this._vertices[n+2],1<s.length&&(n=2*(s[1]-1),a.uvU=this._uvs[n],a.uvV=this._uvs[n+1],2<s.length&&(n=3*(s[2]-1),this._hasNormals=!0,a.normalX=this._normals[n],a.normalY=this._normals[n+1],a.normalZ=this._normals[n+2]))}this._activeSubGroup.faces.push(e),this._activeSubGroup.numIndices+=4===t.length?3:6},o.prototype._translateObject=function(t,e){var i=this._objects[t],r=i.groups.length;if(0!==r){for(var a=new E.Entity,s=0;s<r;++s){var n=i.groups[s];for(var o in n.subgroups)if(n.subgroups.hasOwnProperty(o)){var h=n.subgroups[o];if(0===h.numIndices)continue;var l=e?e[o]:null;l=l||this._defaultMaterial;var u=this._translateMesh(h),p=new E.MeshInstance(u,l);a.addComponent(p)}}i.name&&(a.name=i.name),this._target.attach(a),this._notifyProgress(.8+(t+1)/this._objects.length*.2)}},o.prototype._translateMesh=function(t){var e=E.Mesh.createDefaultEmpty(),i=[],r=new Array(t.numIndices),a=0,s=0;t.name&&(e.name=t.name);for(var n=t.faces,o=n.length,h=0;h<o;++h){for(var l=n[h].vertices,u=l.length,p=0;p<u;++p){var _=l[p],c=_.getHash();i.hasOwnProperty(c)||(i[c]={index:a++,vertex:_})}r[s]=i[l[0].getHash()].index,r[s+1]=i[l[2].getHash()].index,r[s+2]=i[l[1].getHash()].index,s+=3,4===u&&(r[s]=i[l[0].getHash()].index,r[s+1]=i[l[3].getHash()].index,r[s+2]=i[l[2].getHash()].index,s+=3)}var f=new Array(a*E.Mesh.DEFAULT_VERTEX_SIZE);for(c in i)if(i.hasOwnProperty(c)){var d=i[c],m=d.vertex,g=d.index*E.Mesh.DEFAULT_VERTEX_SIZE;f[g]=m.posX,f[g+1]=m.posY,f[g+2]=m.posZ,f[g+3]=m.normalX,f[g+4]=m.normalY,f[g+5]=m.normalZ,f[g+6]=0,f[g+7]=0,f[g+8]=0,f[g+9]=1,f[g+10]=m.uvU,f[g+11]=m.uvV}e.setVertexData(f,0),e.setIndexData(r);var y=E.NormalTangentGenerator.MODE_TANGENTS;return this._hasNormals||(y|=E.NormalTangentGenerator.MODE_NORMALS),(new E.NormalTangentGenerator).generate(e,y,!0),e},(o._FaceVertexData=function(){this.posX=0,this.posY=0,this.posZ=0,this.uvU=0,this.uvV=0,this.normalX=0,this.normalY=0,this.normalZ=0,this._hash=""}).prototype={getHash:function(){return this._hash||(this._hash=this.posX+"/"+this.posY+"/"+this.posZ+"/"+this.uvU+"/"+this.uvV+"/"+this.normalX+"/"+this.normalY+"/"+this.normalZ+"/"),this._hash}},o._FaceData=function(){this.vertices=[]},o._SubGroupData=function(){this.numIndices=0,this.faces=[]},o._GroupData=function(){this.subgroups=[],this.name=null,this._activeMaterial=null},o._ObjectData=function(){this.name=null,this.groups=[],this._activeGroup=null},(s.prototype=Object.create(E.Importer.prototype)).parse=function(t,e){var i=JSON.parse(t);if("BufferGeometry"!==i.type)throw new Error("JSON does not contain correct BufferGeometry data! (type property is not BufferGeometry)");E.Mesh.createDefaultEmpty(e),this.parseAttributes(i.data.attributes,e),this.parseIndices(i.data.index,e);var r=i.data.attributes.normal?E.NormalTangentGenerator.MODE_NORMALS:0;(r|=i.data.attributes.tangent?E.NormalTangentGenerator.MODE_TANGENTS:0)&&(new E.NormalTangentGenerator).generate(e,r);this._notifyComplete(e)},s.prototype.parseAttributes=function(t,e){var i={position:"hx_position",normal:"hx_normal",tangent:"hx_tangent",uv:"hx_texCoord"},r=t.position.array.length/t.position.itemSize;for(var a in t)if(t.hasOwnProperty(a)&&!i.hasOwnProperty(a)&&(e.addVertexAttribute(a,t[a].itemSize),"Float32Array"!==t[a].type))throw new Error("Unsupported vertex attribute data type!");var s=e.getVertexStride(0),n=new Float32Array(r*s);for(a in t)if(t.hasOwnProperty(a)){var o=t[a],h=i[a]||a,l=e.getVertexAttributeByName(h),u=o.itemSize,p=0,_=o.array.length,c=l.offset,f=!1;for("position"!==a&&"normal"!==a&&"tangent"!==a||(f=!0);p<_;){for(var d=0;d<u;++d)n[c+d]=o.array[p++];if(f){var m=n[c+1],g=n[c+2];n[c+1]=g,n[c+2]=m}c+=s}}e.setVertexData(n,0)},s.prototype.parseIndices=function(t,e){var i;switch(t.type){case"Uint16Array":i=new Uint16Array(t.array);break;case"Uint32Array":i=new Uint32Array(t.array);break;default:throw new Error("Unsupported index type "+t.type)}e.setIndexData(i)},u.LITTLE_ENDIAN=!0,u.BIG_ENDIAN=!1,u.prototype={get offset(){return this._offset},set offset(t){this._offset=t},get endian(){return this._endian},set endian(t){this._endian=t},get byteLength(){return this._dataView.byteLength},get bytesAvailable(){return this._dataView.byteLength-this._offset},writeChar:function(t){return this.writeUint8(t.charCodeAt(0))},writeUint8:function(t){return this._dataView.setUint8(this._offset++,t)},writeUint16:function(t){var e=this._dataView.setUint16(this._offset,t,this._endian);return this._offset+=2,e},writeUint32:function(t){var e=this._dataView.setUint32(this._offset,t,this._endian);return this._offset+=4,e},writeInt8:function(t){return this._dataView.setInt8(this._offset++,t)},writeInt16:function(t){var e=this._dataView.setInt16(this._offset,t,this._endian);return this._offset+=2,e},writeInt32:function(t){var e=this._dataView.setInt32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat32:function(t){var e=this._dataView.setFloat32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat64:function(t){var e=this._dataView.setFloat64(this._offset,t,this._endian);return this._offset+=8,e},writeString:function(t){for(var e=t.length,i=0;i<e;++i)this.writeUint8(t.charCodeAt(i))},writeUint8Array:function(t){this._writeArray(t,this.writeUint8)},writeUint16Array:function(t){this._writeArray(t,this.writeUint16)},writeUint32Array:function(t){this._writeArray(t,this.writeUint32)},writeInt8Array:function(t){this._writeArray(t,this.writeInt8)},writeInt16Array:function(t){this._writeArray(t,this.writeInt16)},writeInt32Array:function(t){this._writeArray(t,this.writeInt32)},writeFloat32Array:function(t){this._writeArray(t,this.writeFloat32)},writeFloat64Array:function(t){this._writeArray(t,this.writeFloat64)},_writeArray:function(t,e){for(var i=t.length,r=0;r<i;++r)e.call(this,t[r])}},p.VERSION="0.1.0",p.VALUE_TYPE_SKELETON_POSE=1,p.VALUE_TYPE_NUMBER=2,p.VALUE_TYPE_FLOAT3=3,p.VALUE_TYPE_QUATERNION=4,p.prototype={export:function(t){var e=this._getValueType(t),i=this._calculateFileSize(t,e),r=new ArrayBuffer(i),a=new u(new DataView(r)),s=p.VERSION.split(".");a.writeString("HX_CLIP"),a.writeUint16Array(s),a.writeUint8(e);var n=t.numKeyFrames;if(a.writeUint32(n),e===p.VALUE_TYPE_SKELETON_POSE){var o=t.getKeyFrame(0),h=o.value;a.writeUint8(h.numJoints)}else a.writeUint8(0);for(var l=0;l<n;++l)o=t.getKeyFrame(l),a.writeUint32(o.time),this._writeValue(a,e,o.value);return r},_getValueType:function(t){var e=t.getKeyFrame(0).value;if(e instanceof E.SkeletonPose)return p.VALUE_TYPE_SKELETON_POSE;if(e instanceof E.Float4)return p.VALUE_TYPE_FLOAT3;if(e instanceof E.Quaternion)return p.VALUE_TYPE_QUATERNION;if("number"==typeof e)return p.VALUE_TYPE_NUMBER;throw new Error("Unsupported animation clip")},_writeValue:function(t,e,i){if(e===p.VALUE_TYPE_SKELETON_POSE)for(var r=i.numJoints,a=0;a<r;++a){var s=i.getJointPose(a);t.writeFloat32(s.position.x),t.writeFloat32(s.position.y),t.writeFloat32(s.position.z),t.writeFloat32(s.rotation.x),t.writeFloat32(s.rotation.y),t.writeFloat32(s.rotation.z),t.writeFloat32(s.rotation.w),t.writeFloat32(s.scale.x),t.writeFloat32(s.scale.y),t.writeFloat32(s.scale.z)}else e===p.VALUE_TYPE_FLOAT3?(t.writeFloat32(i.x),t.writeFloat32(i.y),t.writeFloat32(i.z)):e===p.VALUE_TYPE_QUATERNION?(t.writeFloat32(i.x),t.writeFloat32(i.y),t.writeFloat32(i.z),t.writeFloat32(i.w)):e===p.VALUE_TYPE_NUMBER&&t.writeFloat32(i)},_calculateFileSize:function(t,e){var i=7;i+=6,i+=1,i+=4,i+=1;var r=this._calculateKeyFrameSize(e,t);return i+=t.numKeyFrames*r},_calculateKeyFrameSize:function(t,e){var i=4;t===p.VALUE_TYPE_SKELETON_POSE?i+=10*e.getKeyFrame(0).value.numJoints*4:t===p.VALUE_TYPE_FLOAT3?i+=12:t===p.VALUE_TYPE_QUATERNION?i+=16:t===p.VALUE_TYPE_NUMBER&&(i+=4);return i}},h.VERSION="0.1.0",h.prototype={export:function(t){var e=this._calculateFileSize(t),i=new ArrayBuffer(e),r=new u(new DataView(i)),a=h.VERSION.split(".");return r.writeString("HX_MESH"),r.writeUint16Array(a),this._writeMeshData(r,t),this._writeSkeleton(r,t.skeleton),i},_writeMeshData:function(t,e){t.writeUint32(e.numIndices),e._indexType===E.DataType.UNSIGNED_INT?(t.writeUint8(32),t.writeUint32Array(e.getIndexData())):(t.writeUint8(16),t.writeUint16Array(e.getIndexData())),t.writeUint32(e.numVertices),t.writeUint8(e.numVertexAttributes);for(var i=0;i<e.numVertexAttributes;++i){var r=e.getVertexAttributeByIndex(i);t.writeUint8(r.name.length),t.writeString(r.name),t.writeUint8(r.streamIndex),t.writeUint8(r.numComponents)}for(t.writeUint8(e.numStreams),i=0;i<e.numStreams;++i){var a=e.getVertexData(i);t.writeUint32(a.length),t.writeFloat32Array(a)}},_writeSkeleton:function(t,e){var i=e?e.numJoints:0;t.writeUint8(i);for(var r=0;r<i;++r){var a=e.getJoint(r);a.name?(t.writeUint8(a.name.length),t.writeString(a.name)):t.writeUint8(0),t.writeUint8(-1===a.parentIndex?255:a.parentIndex),t.writeFloat32Array(a.inverseBindPose._m)}},_calculateFileSize:function(t){var e=7;e+=6,e+=4,e+=1,e+=(t._indexType===E.DataType.UNSIGNED_INT?4:2)*t.numIndices,e+=4,e+=1;for(var i=0;i<t.numVertexAttributes;++i){e+=1,e+=t.getVertexAttributeByIndex(i).name.length,e+=1,e+=1}for(e+=1,i=0;i<t.numStreams;++i)e+=4,e+=4*t.getVertexData(i).length;e+=1;for(var r=t.skeleton?t.skeleton.numJoints:0,a=0;a<r;++a){var s=t.skeleton.getJoint(a);e+=1,e+=s.name?s.name.length:0,e+=1,e+=64}return e}},t.GLTF=i,t.GLTFData=e,t.OBJ=o,t.MTL=a,t.THREEBufferGeometry=s,t.AnimationClipExporter=p,t.MeshExporter=h,Object.defineProperty(t,"__esModule",{value:!0})});