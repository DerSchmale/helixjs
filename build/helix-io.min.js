!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("helix")):"function"==typeof define&&define.amd?define("HX_IO",["exports","helix"],t):t(e.HX_IO={},e.HX)}(this,function(e,M){"use strict";function t(){this.defaultScene=new M.Scene,this.scenes={}}function O(e,t){return e.getFloat32(t,!0)}function g(e,t){for(var s=[],a=0;a<16;++a)s[a]=e.getFloat32(t,!0),t+=4;return new M.Matrix4x4(s)}function s(){M.Importer.call(this,t),this._numComponentLookUp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},this._flipCoord=new M.Matrix4x4,this._flipCoord.setColumn(0,new M.Float4(-1,0,0,0)),this._flipCoord.setColumn(1,new M.Float4(0,0,1,0)),this._flipCoord.setColumn(2,new M.Float4(0,1,0,0))}function a(){this._listeners=[],this._lookUp={}}function n(){this.onComplete=new a,this.onProgress=new a,this._queue=[],this._childQueues=[],this._currentIndex=0,this._isRunning=!1,this._timeout=void 0}function i(){M.Importer.call(this,Object,M.URLLoader.DATA_TEXT),this._textures=[],this._texturesToLoad=[],this._activeMaterial=null}function o(){M.Importer.call(this,M.Entity),this._objects=[],this._vertices=[],this._normals=[],this._uvs=[],this._hasNormals=!1,this._defaultMaterial=new M.BasicMaterial,this._target=null,this._mtlLibFile=null}function r(){M.Importer.call(this,M.Mesh)}(s.prototype=Object.create(M.Importer.prototype)).parse=function(e,t){this._defaultSceneIndex=void 0,this._gltf=JSON.parse(e);var s=this._gltf.asset;if(this._target=t,this._animationTargetNodes={},this._animations=[],s.hasOwnProperty("minVersion"))s.minVersion.split(".");if(s.hasOwnProperty("version")&&"2"!==s.version.split(".")[0])throw new Error("Unsupported glTF version!");this._assetLibrary=new M.AssetLibrary,this._binFileCheck={},this._queueImages(),this._queueBuffers(),this._assetLibrary.onComplete.bind(function(){this._continueParsing()},this),this._assetLibrary.onProgress.bind(function(e){this._notifyProgress(.8*e)},this),this._assetLibrary.load()},s.prototype._continueParsing=function(){var e=this._gltf;e.hasOwnProperty("scene")&&(this._defaultSceneIndex=e.scene);var t=new M.AsyncTaskQueue;t.queue(this._parseMaterials.bind(this)),t.queue(this._parseMeshes.bind(this)),t.queue(this._parseNodes.bind(this)),t.queue(this._parseScenes.bind(this)),t.queue(this._parseAnimations.bind(this)),t.queue(this._assignAnimations.bind(this)),t.onComplete.bind(this._finalize.bind(this)),t.onProgress.bind(function(e){this._notifyProgress(.8+.2*e)}.bind(this)),t.execute()},s.prototype._finalize=function(){for(var e=new M.AsyncTaskQueue,t=0,s=this._materials.length;t<s;++t){var a=this._materials[t];e.queue(a.init.bind(a))}e.onComplete.bind(function(){this._notifyComplete(this._target)}.bind(this)),e.execute()},s.prototype._getAccessor=function(e){var t,s=this._gltf.accessors[e];void 0!==s.bufferView&&(t=this._getBufferView(s.bufferView));var a={dataType:s.componentType,numComponents:this._numComponentLookUp[s.type],type:s.type,data:t?t.data:null,min:s.min,max:s.max,byteOffset:t.byteOffset+(s.byteOffset||0),byteStride:t.byteStride,count:s.count,isSparse:!1};if(s.sparse){a.isSparse=!0,a.sparseCount=s.sparse.count,a.sparseOffsets=[];var i=this._getBufferView(s.sparse.indices.bufferView),r=this._getBufferView(s.sparse.values.bufferView);a.sparseIndices={data:i.data,byteOffset:s.sparse.indices.byteOffset,dataType:s.componentType},a.sparseValues={data:r.data,byteOffset:s.values.indices.byteOffset}}return a},s.prototype._getBufferView=function(e){var t=this._gltf.bufferViews[e],s=this._buffers[t.buffer],a=s.byteOffset+(t.byteOffset||0);return{data:this._assetLibrary.get(s.assetID),byteOffset:a,byteLength:t.byteLength,byteStride:t.byteStride}},s.prototype._queueImages=function(){var e=this._gltf.images;if(e)for(var t=0;t<e.length;++t){var s=e[t];this._assetLibrary.queueAsset("hx_image_"+t,this._correctURL(s.uri),M.AssetLibrary.Type.ASSET,M.JPG)}},s.prototype._queueBuffers=function(){var e=this._gltf.buffers;if(e){this._buffers=[];for(var t=0;t<e.length;++t){var s=e[t];if(!this._binFileCheck[s.uri]){var a="hx_bin_"+t;this._assetLibrary.queueAsset(a,this._correctURL(s.uri),M.AssetLibrary.Type.RAW_BINARY),this._binFileCheck[s.uri]=!0,this._buffers[t]={assetID:a,byteOffset:s.byteOffset||0,byteLength:s.byteLength}}}}},s.prototype._parseMaterials=function(){var e=this._gltf.materials;if(e){this._materials=[];for(var t=0;t<e.length;++t){var s=e[t],a=new M.BasicMaterial;if(a.name=s.name,a.specularMapMode=M.BasicMaterial.SPECULAR_MAP_METALLIC_ROUGHNESS,a.normalMap=this._getTexture(s.normalTexture),a.occlusionMap=this._getTexture(s.occlusionTexture),a.emissionMap=this._getTexture(s.emissiveTexture),s.doubleSided&&(a.cullMode=M.CullMode.NONE),s.emissiveFactor){var i=new M.Color(s.emissiveFactor[0],s.emissiveFactor[1],s.emissiveFactor[2],1);a.emissiveColor=i.linearToGamma()}else a.emissionMap&&(a.emissiveColor=M.Color.WHITE);var r=s.pbrMetallicRoughness;if(r){if(a.colorMap=this._getTexture(r.baseColorTexture),a.specularMap=this._getTexture(r.metallicRoughnessTexture),r.baseColorFactor){var n=new M.Color(r.baseColorFactor[0],r.baseColorFactor[1],r.baseColorFactor[2],r.baseColorFactor[3]);a.color=n.linearToGamma()}a.metallicness=void 0===r.metallicFactor?1:r.metallicFactor,a.roughness=void 0===r.roughnessFactor?1:r.roughnessFactor,a.normalSpecularReflectance=.04,a.specularMap&&(a.roughness*=.5,a.roughnessRange=-a.roughness)}this._materials[t]=a}}},s.prototype._getTexture=function(e){return e?this._assetLibrary.get("hx_image_"+this._gltf.textures[e.index].source):null},s.prototype._parseMeshes=function(){var e=this._gltf.meshes;if(e){this._entities=[];for(var t=0,s=e.length;t<s;++t){var a=e[t],i=new M.Entity;i.name=a.name;for(var r=0,n=a.primitives.length;r<n;++r){var o=a.primitives[r];this._parsePrimitive(o,i),a.weights&&this._parseMorphWeights(a.weights,i)}this._entities[t]=i}}},s.prototype._parseMorphWeights=function(e,t){var s=new M.MorphAnimation;if(e)for(var a=0,i=e.length;a<i;++a)s.setWeight("morphTarget_"+a,e[a]);t.addComponent(s),this._animationTargetNodes[s.name]=t},s.prototype._parseMorphTargets=function(e,t){for(var s=0;s<e.length;++s){var a=e[s],i=new M.MorphTarget;i.name="morphTarget_"+s;var r=this._getAccessor(a.POSITION),n=void 0!==a.NORMAL?this._getAccessor(a.NORMAL):null,o=new Float32Array(3*r.count);if(this._readVertexData(o,0,r,3,3,!0),i.setPositionData(o),n){var h=new Float32Array(3*n.count);this._readVertexData(h,0,n,3,3,!0),i.setNormalData(h)}t.addMorphTarget(i)}},s.prototype._parsePrimitive=function(e,t){var s=M.Mesh.createDefaultEmpty(),a=e.attributes,i=this._getAccessor(a.POSITION),r=void 0!==a.NORMAL?this._getAccessor(a.NORMAL):null,n=void 0!==a.TANGENT?this._getAccessor(a.TANGENT):null,o=void 0!==a.TEXCOORD_0?this._getAccessor(a.TEXCOORD_0):null,h=void 0!==a.JOINTS_0?this._getAccessor(a.JOINTS_0):null,p=void 0!==a.WEIGHTS_0?this._getAccessor(a.WEIGHTS_0):null,l=0,u=s.getVertexStride(0),c=new Float32Array(i.count*u);this._readVertexData(c,0,i,3,u,!0),r?this._readVertexData(c,3,r,3,u,!0):l=M.NormalTangentGenerator.MODE_NORMALS,n?this._readVertexData(c,6,n,4,u,!0):o&&(l|=M.NormalTangentGenerator.MODE_TANGENTS),o&&this._readUVData(c,10,o,u),s.setVertexData(c,0),e.hasOwnProperty("mode")&&(s.elementType=e.mode);var _=this._getAccessor(e.indices);(s.setIndexData(this._readIndices(_)),l)&&(new M.NormalTangentGenerator).generate(s,l);if(h){s.addVertexAttribute("hx_jointIndices",4,1),s.addVertexAttribute("hx_jointWeights",4,1),u=s.getVertexStride(1);var f=new Float32Array(h.count*u);this._readVertexData(f,0,h,4,u),this._readVertexData(f,4,p,4,u),s.setVertexData(f,1)}t.addComponent(new M.MeshInstance(s,this._materials[e.material])),e.targets&&0<e.targets.length&&this._parseMorphTargets(e.targets,s)},s.prototype._readVertexData=function(e,t,s,a,i,r){var n,o,h,p=t,l=s.byteOffset,u=s.count,c=s.data,_=s.byteStride||0;if(c){if(s.dataType===M.DataType.FLOAT)o=c.getFloat32,h=4;else if(s.dataType===M.DataType.UNSIGNED_SHORT)o=c.getUint16,h=2;else if(s.dataType===M.DataType.UNSIGNED_INT)o=c.getUint32,h=4;else{if(s.dataType!==M.DataType.UNSIGNED_BYTE)throw new Error("Unknown data type "+s.dataType);o=c.getUint8,h=1}for(n=0;n<u;++n){for(var f=l,d=0;d<a;++d)e[p+d]=o.call(c,l,!0),l+=h;p+=i,_&&(l=f+_)}}else{for(n=0;n<u;++n)for(d=0;d<a;++d)e[p+d]=0;p+=i}if(s.isSparse&&this._applySparseAccessor(e,s,a,i,o,h),r)for(p=t,n=0;n<u;++n){var m=e[p+1];e[p]=-e[p],e[p+1]=e[p+2],e[p+2]=m,p+=i}},s.prototype._applySparseAccessor=function(e,t,s,a,i,r){var n,o,h=t.sparseCount,p=t.sparseIndices.data,l=t.sparseValues.data,u=t.sparseIndices.byteOffset,c=t.sparseValues.byteOffset;t.dataType===M.DataType.UNSIGNED_SHORT?(n=p.getUint16,o=2):t.dataType===M.DataType.UNSIGNED_INT&&(n=p.getUint32,o=4);for(var _=0;_<h;++_){for(var f=n.call(p,u)*a,d=0;d<s;++d){var m=i.call(l,c,!0);c+=r,e[f+d]=m}u+=o}},s.prototype._readUVData=function(e,t,s,a){for(var i=t,r=s.byteOffset,n=s.count,o=s.data,h=0;h<n;++h)e[i]=o.getFloat32(r,!0),e[i+1]=o.getFloat32(r+4,!0),r+=8,i+=a},s.prototype._readIndices=function(e){var t=e.byteOffset,s=e.data,a=e.count;if(e.dataType===M.DataType.UNSIGNED_SHORT)return new Uint16Array(s.buffer,t,a);if(e.dataType===M.DataType.UNSIGNED_INT)return new Uint32Array(s.buffer,t,a);throw new Error("Unknown data type for indices!")},s.prototype._parseSkin=function(e,t){var s=e.skin,a=this._gltf.skins[s];a.name=a.name||"skin ";var i=this._getAccessor(a.inverseBindMatrices),r=i.data,n=i.byteOffset,o=new M.Skeleton,h=new M.SkeletonPose,p=this._nodes[a.skeleton];p.parent&&p.parent.detach(p);for(var l=0;l<a.joints.length;++l){var u=a.joints[l],c=new M.SkeletonJoint;c.inverseBindPose=g(r,n),n+=64,c.inverseBindPose.prepend(this._flipCoord),c.inverseBindPose.append(this._flipCoord),o.joints.push(c);var _=this._nodes[u];if(void 0!==_._jointIndex)throw new Error("Adding one node to multiple skeletons!");_._jointIndex=l,_._skeletonPose=h,_._skeleton=o,a.name&&(c.name=a.name+"_joint_"+l);var f=new M.SkeletonJointPose;f.position.copyFrom(_.position),f.rotation.copyFrom(_.rotation),f.scale.copyFrom(_.scale),h.setJointPose(l,f),this._animationTargetNodes[c.name]=t}for(l=0;l<a.joints.length;++l)u=a.joints[l],_=this._nodes[u],(c=o.joints[l]).parentIndex=_!==p&&_.parent?_.parent._jointIndex:-1;var d=t.getComponentsByType(M.MeshInstance);for(l=0;l<d.length;++l){var m=d[l];m.skeleton=o,m.skeletonPose=h}},s.prototype._parseNodes=function(){var e=this._gltf.nodes;if(e){var t=new M.Matrix4x4;this._nodes=[];for(var s=0;s<e.length;++s){var a,i=e[s];i.hasOwnProperty("mesh")?(a=this._entities[i.mesh],i.name&&(a.name=i.name)):a=new M.SceneNode,this._animationTargetNodes[a.name]=a,i.rotation&&(a.rotation.set(i.rotation[0],i.rotation[1],i.rotation[2],i.rotation[3]),t.fromQuaternion(a.rotation),t.prepend(this._flipCoord),t.append(this._flipCoord),a.rotation.fromMatrix(t)),i.translation&&a.position.set(-i.translation[0],i.translation[2],i.translation[1],1),i.scale&&(t.fromScale(i.scale[0],i.scale[1],i.scale[2]),t.prepend(this._flipCoord),t.append(this._flipCoord),a.scale.set(t.getColumn(0).length,t.getColumn(1).length,t.getColumn(2).length)),i.matrix&&(a.matrix=new M.Matrix4x4(i.matrix),a.matrix.prepend(this._flipCoord),a.matrix.append(this._flipCoord)),this._nodes[s]=a}for(s=0;s<e.length;++s)if(i=e[s],a=this._nodes[s],i.children)for(var r=0;r<i.children.length;++r){var n=i.children[r];a.attach(this._nodes[n])}for(s=0;s<e.length;++s)i=e[s],a=this._nodes[s],i.hasOwnProperty("skin")&&this._parseSkin(i,a)}},s.prototype._parseScenes=function(){var e=this._gltf.scenes;if(e)for(var t=0;t<e.length;++t){var s,a=e[t];t===this._defaultSceneIndex?s=this._target.defaultScene:(s=new M.Scene,this._target.scenes.push(s));for(var i=a.nodes,r=0;r<i.length;++r){var n=i[r];s.attach(this._nodes[n])}}},s.prototype._parseAnimationSampler=function(e,t,s){var a,i,r,n,o,h,p=this._getAccessor(e.input),l=this._getAccessor(e.output),u=p.data,c=l.data,_=p.byteOffset,f=l.byteOffset,d=new M.Matrix4x4,m=l.count/p.count,g=[];if(1===m){var v=g[0]=new M.AnimationClip;v.duration=s}else for(var y=0;y<m;++y)g[y]=new M.AnimationClip,g[y].duration=s;for(var b=0;b<p.count;++b){var x;switch(l.numComponents){case 1:for(x=[],y=0;y<m;++y)x[y]=O(c,f+4*y);break;case 3:if(n=c,o=f,h=void 0,(h=new M.Float4).x=n.getFloat32(o,!0),h.y=n.getFloat32(o+4,!0),h.z=n.getFloat32(o+8,!0),x=h,t){x.x=-x.x;var w=x.y;x.y=x.z,x.z=w}break;case 4:a=c,i=f,r=void 0,(r=new M.Quaternion).x=a.getFloat32(i,!0),r.y=a.getFloat32(i+4,!0),r.z=a.getFloat32(i+8,!0),r.w=a.getFloat32(i+12,!0),x=r,t&&(d.fromQuaternion(x),d.prepend(this._flipCoord),d.append(this._flipCoord),x.fromMatrix(d));break;default:throw new Error("Unsupported animation sampler type")}var T,A=1e3*O(u,_);if(1===m)T=new M.KeyFrame(A,x),v.addKeyFrame(T);else for(y=0;y<m;++y)T=new M.KeyFrame(A,x[y]),g[y].addKeyFrame(T);f+=l.numComponents*m*4,_+=4}return g},s.prototype._parseAnimations=function(){var e=this._gltf.animations;if(e)for(var t=0;t<e.length;++t){for(var s=e[t],a=new M.LayeredAnimation,i=0,r=0;r<s.samplers.length;++r){var n=this._gltf.accessors[s.samplers[r].input].max[0];i=Math.max(i,n)}for(i*=1e3,r=0;r<s.channels.length;++r)for(var o=this._parseAnimationChannel(s.channels[r],s.samplers,i),h=0;h<o.length;++h)a.addLayer(o[h]);a.name=s.name||"animation_"+t,this._animations.push(a)}},s.prototype._parseAnimationChannel=function(e,t,s){var a,i=this._nodes[e.target.node],r=[];switch(void 0!==i._jointIndex?(a=i._skeleton.joints[i._jointIndex].name,i=i._skeletonPose._jointPoses[i._jointIndex]):a=i.name,e.target.path){case"translation":var n=this._parseAnimationSampler(t[e.sampler],!0,s);r=[new M.AnimationLayerFloat4(a,"position",n[0])];break;case"rotation":n=this._parseAnimationSampler(t[e.sampler],!0,s),r=[new M.AnimationLayerQuat(a,"rotation",n[0])];break;case"scale":n=this._parseAnimationSampler(t[e.sampler],!1,s),r=[new M.AnimationLayerFloat4(a,"scale",n[0])];break;case"weights":n=this._parseAnimationSampler(t[e.sampler],!1,s),r=[];for(var o=0;o<n.length;++o)r.push(new M.AnimationLayerMorphTarget(i.getFirstComponentByType(M.MorphAnimation).name,"morphTarget_"+o,n[o]));break;default:throw new Error("Unknown channel path!")}return r},s.prototype._assignAnimations=function(){for(var e=this._animations,t=0,s=e.length;t<s;++t){var a=e[t];this._animationTargetNodes[a._layers[0]._targetName]._scene.rootNode.addComponent(a)}},a.prototype={bind:function(e,t){this._lookUp[e]=this._listeners.length;var s=t?e.bind(t):e;this._listeners.push(s)},unbind:function(e){var t=this._lookUp[e];void 0!==t&&(this._listeners.splice(t,1),delete this._lookUp[e])},unbindAll:function(){this._listeners=[],this._lookUp={}},dispatch:function(e){for(var t=this._listeners.length,s=0;s<t;++s)this._listeners[s].apply(null,arguments)},get hasListeners(){return 0<this._listeners.length}},n.prototype={get isRunning(){return this._isRunning},queue:function(e,t){var s=1===arguments.length?[e]:Array.apply(null,arguments);this._queue.push({func:e,args:s.slice(1)})},addChildQueue:function(e){this._childQueues.push(e)},execute:function(){if(this._isRunning)throw new Error("Already running!");this._isRunning=!0,this._currentIndex=0,this._executeTask()},cancel:function(){this._isRunning&&(void 0!==this._timeout&&clearTimeout(this._timeout),this._isRunning=!1,this._timeout=void 0)},_executeTask:function(){this._timeout=setTimeout(this._executeImpl.bind(this))},_executeImpl:function(){if(this._isRunning)if(this.onProgress.dispatch(this._currentIndex/this._queue.length),0<this._childQueues.length){var e=this._childQueues.shift();e.onComplete.bind(this._executeImpl,this),e.execute()}else if(this._queue.length===this._currentIndex)this._isRunning=!1,this.onComplete.dispatch();else{var t=this._queue[this._currentIndex];t.func.apply(this,t.args),++this._currentIndex,this._executeTask()}}},(i.prototype=Object.create(M.Importer.prototype)).parse=function(e,t){for(var s=e.split("\n"),a=s.length,i=0;i<a;++i){var r=s[i].replace(/^\s+|\s+$/g,"");this._parseLine(r,t)}this._loadTextures(t)},i.prototype._parseLine=function(e,t){if(0!==e.length&&"#"!==e.charAt(0)){var s=e.split(/\s+/);switch(s[0].toLowerCase()){case"newmtl":this._activeMaterial=new M.BasicMaterial,this._activeMaterial.name=s[1],t[s[1]]=this._activeMaterial;break;case"ns":var a=parseFloat(s[1]);this._activeMaterial.roughness=M.BasicMaterial.roughnessFromShininess(a),this._activeMaterial.roughnessRange=this._activeMaterial.roughness;break;case"kd":this._activeMaterial.color=new M.Color(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));break;case"map_kd":this._activeMaterial.colorMap=this._getTexture(s[1]);break;case"map_d":this._activeMaterial.maskMap=this._getTexture(s[1]),this._activeMaterial.alphaThreshold=.5;break;case"map_ns":this._activeMaterial.specularMap=this._getTexture(s[1]);break;case"map_bump":case"bump":this._activeMaterial.normalMap=this._getTexture(s[1])}}},i.prototype._getTexture=function(e){if(!this._textures[e]){var t=new M.Texture2D;this._textures[e]=t,this._texturesToLoad.push({file:this._correctURL(e),importer:M.JPG,target:t})}return this._textures[e]},i.prototype._loadTextures=function(e){var t=new M.AssetLibrary(null,this.options.crossOrigin);t.fileMap=this.fileMap;var s=this._texturesToLoad;if(0!==s.length){for(var a=0;a<s.length;++a)t.queueAsset(s[a].file,s[a].file,M.AssetLibrary.Type.ASSET,s[a].importer,this.options,s[a].target);t.onComplete.bind(function(){this._notifyComplete(e)},this),t.onProgress.bind(function(e){this._notifyProgress(e)},this),t.load(s)}else this._notifyComplete(e)},(o.prototype=Object.create(M.Importer.prototype)).parse=function(e,t){this._groupsAsObjects=void 0===this.options.groupsAsObjects||this._groupsAsObjects,this._target=t;var s=e.split("\n"),a=s.length;this._pushNewObject("hx_default");for(var i=0;i<a;++i){var r=s[i].replace(/^\s+|\s+$/g,"");this._parseLine(r)}this._mtlLibFile?this._loadMTLLib(this._mtlLibFile):this._finish(null)},o.prototype._finish=function(e){for(var t=new n,s=this._objects.length,a=0;a<s;++a)t.queue(this._translateObject.bind(this),a,e);for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];t.queue(r.init.bind(r))}t.onComplete.bind(this._onComplete,this),t.execute()},o.prototype._onComplete=function(){this._notifyComplete(this._target)},o.prototype._loadMTLLib=function(e){var t=new M.AssetLoader(i),s=this;t.onComplete=function(e){s._finish(e)},t.onProgress=function(e){s._notifyProgress(.8*e)},t.onFail=function(e){s._notifyFailure(e)},t.load(e)},o.prototype._parseLine=function(e){if(0!==e.length&&"#"!==e.charAt(0)){var t=e.split(/\s+/);switch(t[0].toLowerCase()){case"mtllib":this._mtlLibFile=this._correctURL(t[1]);break;case"usemtl":this._setActiveSubGroup(t[1]);break;case"v":this._vertices.push(parseFloat(t[1]),parseFloat(t[3]),parseFloat(t[2]));break;case"vt":this._uvs.push(parseFloat(t[1]),1-parseFloat(t[2]));break;case"vn":this._normals.push(parseFloat(t[1]),parseFloat(t[3]),parseFloat(t[2]));break;case"o":this._pushNewObject(t[1]);break;case"g":this._groupsAsObjects?this._pushNewObject(t[1]):this._pushNewGroup(t[1]);break;case"f":this._parseFaceData(t)}}},o.prototype._pushNewObject=function(e){this._activeObject=new o._ObjectData,this._activeObject.name=e,this._objects.push(this._activeObject),this._pushNewGroup("hx_default")},o.prototype._pushNewGroup=function(e){this._activeGroup=new o._GroupData,this._activeGroup.name=e||"Group"+this._activeGroup.length,this._activeObject.groups.push(this._activeGroup),this._setActiveSubGroup("hx_default")},o.prototype._setActiveSubGroup=function(e){this._activeGroup.subgroups[e]=this._activeGroup.subgroups[e]||new o._SubGroupData,this._activeSubGroup=this._activeGroup.subgroups[e]},o.prototype._parseFaceData=function(e){for(var t=new o._FaceData,s=e.length,a=1;a<s;++a){var i=new o._FaceVertexData;t.vertices.push(i);var r=e[a].split("/"),n=3*(r[0]-1);i.posX=this._vertices[n],i.posY=this._vertices[n+1],i.posZ=this._vertices[n+2],1<r.length&&(n=2*(r[1]-1),i.uvU=this._uvs[n],i.uvV=this._uvs[n+1],2<r.length&&(n=3*(r[2]-1),this._hasNormals=!0,i.normalX=this._normals[n],i.normalY=this._normals[n+1],i.normalZ=this._normals[n+2]))}this._activeSubGroup.faces.push(t),this._activeSubGroup.numIndices+=4===e.length?3:6},o.prototype._translateObject=function(e,t){var s=this._objects[e],a=s.groups.length;if(0!==a){for(var i=new M.Entity,r=0;r<a;++r){var n=s.groups[r];for(var o in n.subgroups)if(n.subgroups.hasOwnProperty(o)){var h=n.subgroups[o];if(0===h.numIndices)continue;var p=t?t[o]:null;p=p||this._defaultMaterial;var l=this._translateMesh(h),u=new M.MeshInstance(l,p);i.addComponent(u)}}s.name&&(i.name=s.name),this._target.attach(i),this._notifyProgress(.8+(e+1)/this._objects.length*.2)}},o.prototype._translateMesh=function(e){var t=M.Mesh.createDefaultEmpty(),s=[],a=new Array(e.numIndices),i=0,r=0;e.name&&(t.name=e.name);for(var n=e.faces,o=n.length,h=0;h<o;++h){for(var p=n[h].vertices,l=p.length,u=0;u<l;++u){var c=p[u],_=c.getHash();s.hasOwnProperty(_)||(s[_]={index:i++,vertex:c})}a[r]=s[p[0].getHash()].index,a[r+1]=s[p[2].getHash()].index,a[r+2]=s[p[1].getHash()].index,r+=3,4===l&&(a[r]=s[p[0].getHash()].index,a[r+1]=s[p[3].getHash()].index,a[r+2]=s[p[2].getHash()].index,r+=3)}var f=new Array(i*M.Mesh.DEFAULT_VERTEX_SIZE);for(_ in s)if(s.hasOwnProperty(_)){var d=s[_],m=d.vertex,g=d.index*M.Mesh.DEFAULT_VERTEX_SIZE;f[g]=m.posX,f[g+1]=m.posY,f[g+2]=m.posZ,f[g+3]=m.normalX,f[g+4]=m.normalY,f[g+5]=m.normalZ,f[g+6]=0,f[g+7]=0,f[g+8]=0,f[g+9]=1,f[g+10]=m.uvU,f[g+11]=m.uvV}t.setVertexData(f,0),t.setIndexData(a);var v=M.NormalTangentGenerator.MODE_TANGENTS;return this._hasNormals||(v|=M.NormalTangentGenerator.MODE_NORMALS),(new M.NormalTangentGenerator).generate(t,v,!0),t},(o._FaceVertexData=function(){this.posX=0,this.posY=0,this.posZ=0,this.uvU=0,this.uvV=0,this.normalX=0,this.normalY=0,this.normalZ=0,this._hash=""}).prototype={getHash:function(){return this._hash||(this._hash=this.posX+"/"+this.posY+"/"+this.posZ+"/"+this.uvU+"/"+this.uvV+"/"+this.normalX+"/"+this.normalY+"/"+this.normalZ+"/"),this._hash}},o._FaceData=function(){this.vertices=[]},o._SubGroupData=function(){this.numIndices=0,this.faces=[]},o._GroupData=function(){this.subgroups=[],this.name=null,this._activeMaterial=null},o._ObjectData=function(){this.name=null,this.groups=[],this._activeGroup=null},(r.prototype=Object.create(M.Importer.prototype)).parse=function(e,t){var s=JSON.parse(e);if("BufferGeometry"!==s.type)throw new Error("JSON does not contain correct BufferGeometry data! (type property is not BufferGeometry)");M.Mesh.createDefaultEmpty(t),this.parseAttributes(s.data.attributes,t),this.parseIndices(s.data.index,t);var a=s.data.attributes.normal?M.NormalTangentGenerator.MODE_NORMALS:0;(a|=s.data.attributes.tangent?M.NormalTangentGenerator.MODE_TANGENTS:0)&&(new M.NormalTangentGenerator).generate(t,a);this._notifyComplete(t)},r.prototype.parseAttributes=function(e,t){var s={position:"hx_position",normal:"hx_normal",tangent:"hx_tangent",uv:"hx_texCoord"},a=e.position.array.length/e.position.itemSize;for(var i in e)if(e.hasOwnProperty(i)&&!s.hasOwnProperty(i)&&(t.addVertexAttribute(i,e[i].itemSize),"Float32Array"!==e[i].type))throw new Error("Unsupported vertex attribute data type!");var r=t.getVertexStride(0),n=new Float32Array(a*r);for(i in e)if(e.hasOwnProperty(i)){var o=e[i],h=s[i]||i,p=t.getVertexAttributeByName(h),l=o.itemSize,u=0,c=o.array.length,_=p.offset,f=!1;for("position"!==i&&"normal"!==i&&"tangent"!==i||(f=!0);u<c;){for(var d=0;d<l;++d)n[_+d]=o.array[u++];if(f){var m=n[_+1],g=n[_+2];n[_+1]=g,n[_+2]=m}_+=r}}t.setVertexData(n,0)},r.prototype.parseIndices=function(e,t){var s;switch(e.type){case"Uint16Array":s=new Uint16Array(e.array);break;case"Uint32Array":s=new Uint32Array(e.array);break;default:throw new Error("Unsupported index type "+e.type)}t.setIndexData(s)},e.GLTF=s,e.GLTFData=t,e.OBJ=o,e.MTL=i,e.THREEBufferGeometry=r,Object.defineProperty(e,"__esModule",{value:!0})});