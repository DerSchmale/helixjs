!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("helix"),require("pako")):"function"==typeof define&&define.amd?define("HX",["exports","helix","pako"],e):e(t.HX=t.HX||{},t.HX,t.pako)}(this,function(t,e,i){"use strict";function n(){this.defaultScene=new e.Scene,this.scenes={},this.materials={},this.models={},this.modelInstances={},this.animations={}}function r(){e.Importer.call(this,n),this._numComponentLookUp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},this._flipCoord=new e.Matrix4x4,this._flipCoord.setColumn(0,new e.Float4((-1),0,0,0)),this._flipCoord.setColumn(1,new e.Float4(0,0,1,0)),this._flipCoord.setColumn(2,new e.Float4(0,1,0,0))}function a(){e.Importer.call(this,e.Model),this._target=null,this._meshData=null,this._jointData=null,this._skeleton=null}function s(){e.Importer.call(this,e.AnimationClip),this._hierarchy=null,this._baseFrame=null,this._activeFrame=null,this._numJoints=0,this._frameRate=0}function o(){this._listeners=[],this._lookUp={}}function h(){this.onComplete=new o,this.onProgress=new o,this._queue=[],this._childQueues=[],this._currentIndex=0,this._isRunning=!1}function l(){e.Importer.call(this,Object,e.URLLoader.DATA_TEXT),this._textures=[],this._texturesToLoad=[],this._activeMaterial=null}function c(){e.Importer.call(this,e.SceneNode),this._objects=[],this._vertices=[],this._normals=[],this._uvs=[],this._hasNormals=!1,this._defaultMaterial=new e.BasicMaterial,this._target=null,this._mtlLibFile=null}function u(){this.name="",this.data=[],this.children=[]}function p(){this._version=0}function _(){this.name=null,this.UID=null,this.parent=null,this.data=null}function f(){_.call(this),this.type=null}function d(){_.call(this),this.limbNode=null,this.transform=null,this.transformLink=null,this.indices=null,this.weights=null}function m(){_.call(this),this.clusters=null}function v(){_.call(this),this.Color=null,this["Casts Shadows"]=!0,this.vertices=null,this.layerElements=null,this.deformers=null}function g(){_.call(this),this.relativeFilename=null}function y(){_.call(this),this.WrapModeU=0,this.WrapModeV=0,this.relativeFilename=null,this.video=null}function x(){_.call(this),this.EmissiveColor=null,this.EmissiveFactor=1,this.DiffuseColor=null,this.DiffuseFactor=1,this.ShininessExponent=void 0,this.Shininess=void 0,this.textures=null}function w(){_.call(this)}function b(){_.call(this),this.Default=void 0,this.KeyVer=0,this.KeyTime=0,this.KeyValueFloat=null,this.KeyAttrFlags=0,this.KeyAttrDataFloat=null,this.KeyAttrRefCount=0}function T(){_.call(this),this.curves=null,this["d|X"]=0,this["d|Y"]=0,this["d|Z"]=0,this.propertyName=null}function A(){_.call(this),this.RotationOffset=null,this.RotationPivot=null,this.ScalingOffset=null,this.ScalingPivot=null,this.RotationOrder=0,this.PreRotation=null,this.PostRotation=null,this.InheritType=0,this.GeometricTranslation=null,this.GeometricRotation=null,this.GeometricScaling=null,this["Lcl Translation"]=null,this["Lcl Rotation"]=null,this["Lcl Scaling"]=null,this.Visibility=!0,this.type=null,this.children=null,this.skeleton=null,this.defaultAttribute=null,this.attributes=null,this.mesh=null,this.materials=null,this.animationCurveNodes=null,this._geometricMatrix=null,this._matrix=null}function I(){_.call(this),this.curveNodes=null}function M(t){this._value=t}function F(){_.call(this),this.LocalStart=new M,this.LocalStop=new M,this.ReferenceStart=new M,this.ReferenceStop=new M,this.layers=null}function S(){_.call(this),this.type=null,this.poseNodes=[]}function N(){this.targetUID=null,this.matrix=null}function O(){_.call(this),this.directData=null,this.indexData=null,this.type=null,this.mappingInformationType=0,this.referenceInformationType=0}function D(){this._settings=null,this._templates=null,this._objects=null,this._rootNode=null,this._animationStack=null,this._bindPoses=null}function E(){this._skinningData=null,this._jointUIDLookUp=null,this._skeleton=null,this._fakeJointIndex=-1,this._animationClips=null,this._frameRate=24}function k(){this._perMaterialData=null,this._expandedMesh=null,this._vertexStride=0,this._ctrlPointLookUp=null,this._model=null,this._animationConverter=null,this._fakeJointIndex=-1,this._useSkinning=!1}function P(){this._settings=null,this._objects=null,this._textureTokens=null,this._textureMaterialMap=null,this._rootNode=null}function L(){this._matrix=new HX.Matrix4x4,this._frameRate=24}function C(){e.Importer.call(this,e.SceneNode,e.Importer.TYPE_BINARY),this._rootNode=null}function U(t){this._dataView=t,this._offset=0,this._endian=U.LITTLE_ENDIAN}function R(){}function j(){}r.prototype=Object.create(e.Importer.prototype),r.prototype.parse=function(t,i){this._defaultSceneIndex=void 0,this._gltf=JSON.parse(t);var n=this._gltf.asset;if(this._target=i,n.hasOwnProperty("minVersion")){n.minVersion.split(".")}if(n.hasOwnProperty("version")){var r=n.version.split(".");if("2"!==r[0])throw new Error("Unsupported glTF version!")}this._assetLibrary=new e.AssetLibrary,this._binFileCheck={},this._queueImages(),this._queueBuffers(),this._assetLibrary.onComplete.bind(function(){this._continueParsing()},this),this._assetLibrary.onProgress.bind(function(t){this._notifyProgress(.8*t)},this),this._assetLibrary.load()},r.prototype._continueParsing=function(){var t=this._gltf;t.hasOwnProperty("scene")&&(this._defaultSceneIndex=t.scene);var i=new e.AsyncTaskQueue;i.queue(this._parseMaterials.bind(this)),i.queue(this._parseMeshes.bind(this)),i.queue(this._parseNodes.bind(this)),i.queue(this._parseScenes.bind(this)),i.queue(this._parseAnimations.bind(this)),i.queue(this._playAnimations.bind(this)),i.queue(this._notifyComplete.bind(this),this._target),i.onProgress.bind(function(t){this._notifyProgress(.8+.2*t)}.bind(this)),i.execute()},r.prototype._getAccessor=function(t){var e,i=this._gltf.accessors[t];void 0!==i.bufferView&&(e=this._getBufferView(i.bufferView));var n={dataType:i.componentType,numComponents:this._numComponentLookUp[i.type],type:i.type,data:e?e.data:null,min:i.min,max:i.max,byteOffset:e.byteOffset+(i.byteOffset||0),dataType:i.componentType,count:i.count,isSparse:!1};if(i.sparse){n.isSparse=!0,n.sparseCount=i.sparse.count,n.sparseOffsets=[];var r=this._getBufferView(i.sparse.indices.bufferView),a=this._getBufferView(i.sparse.values.bufferView);n.sparseIndices={data:r.data,byteOffset:i.sparse.indices.byteOffset,dataType:i.componentType},n.sparseValues={data:a.data,byteOffset:i.values.indices.byteOffset}}return n},r.prototype._getBufferView=function(t){var e=this._gltf.bufferViews[t],i=this._buffers[e.buffer],n=i.byteOffset+(e.byteOffset||0);return{data:this._assetLibrary.get(i.assetID),byteOffset:n,byteLength:e.byteLength}},r.prototype._queueImages=function(){var t=this._gltf.images;if(t)for(var i=0;i<t.length;++i){var n=t[i];this._assetLibrary.queueAsset("hx_image_"+i,this._correctURL(n.uri),e.AssetLibrary.Type.ASSET,e.JPG)}},r.prototype._queueBuffers=function(){var t=this._gltf.buffers;if(t){this._buffers=[];for(var i=0;i<t.length;++i){var n=t[i];if(!this._binFileCheck[n.uri]){var r="hx_bin_"+i;this._assetLibrary.queueAsset(r,this._correctURL(n.uri),e.AssetLibrary.Type.RAW_BINARY),this._binFileCheck[n.uri]=!0,this._buffers[i]={assetID:r,byteOffset:n.byteOffset||0,byteLength:n.byteLength}}}}},r.prototype._parseMaterials=function(){var t=this._gltf.materials;if(t){this._materials=[];for(var i=0;i<t.length;++i){var n=t[i],r=new e.BasicMaterial;if(r.name=n.name,r.specularMapMode=e.BasicMaterial.SPECULAR_MAP_METALLIC_ROUGHNESS,r.normalMap=this._getTexture(n.normalTexture),r.occlusionMap=this._getTexture(n.occlusionTexture),r.emissionMap=this._getTexture(n.emissiveTexture),n.emissiveFactor){var a=new e.Color(n.emissiveFactor[0],n.emissiveFactor[1],n.emissiveFactor[2],1);r.emissiveColor=a.linearToGamma()}else r.emissionMap&&(r.emissiveColor=e.Color.WHITE);var s=n.pbrMetallicRoughness;if(s){if(r.colorMap=this._getTexture(s.baseColorTexture),r.specularMap=this._getTexture(s.metallicRoughnessTexture),s.baseColorFactor){var o=new e.Color(s.baseColorFactor[0],s.baseColorFactor[1],s.baseColorFactor[2],s.baseColorFactor[3]);r.color=o.linearToGamma()}r.metallicness=void 0===s.metallicFactor?1:s.metallicFactor,r.roughness=void 0===s.roughnessFactor?1:s.roughnessFactor,r.specularMap&&(r.roughness*=.5,r.roughnessRange=-r.roughness)}this._materials[i]=r,this._target.materials[r.name]=r}}},r.prototype._getTexture=function(t){return t?this._assetLibrary.get("hx_image_"+t.index):null},r.prototype._parseMeshes=function(){var t=this._gltf.meshes;if(t){this._modelInstances=[];for(var i=0;i<t.length;++i){for(var n=t[i],r=new e.Model,a=[],s=null,o=0,h=!1,l=0;l<n.primitives.length;++l){var c=n.primitives[l];if(c.targets){o=c.targets.length,s=[];for(var u=0;u<o;++u)s[u]=new e.MorphTarget,s[u].name="morphTarget_"+u;c.targets[0].NORMAL&&(h=!0);break}}for(l=0;l<n.primitives.length;++l)c=n.primitives[l],this._parsePrimitive(c,r,a,o>0,h),c.targets&&this._parseMorphTargets(c.targets,l,s);r.name=n.name;var p=new e.ModelInstance(r,a);if(o>0){var _=new e.MorphAnimation(s);if(n.weights)for(l=0;l<o;++l)_.setWeight("morphTarget_"+l,n.weights[l]);p.addComponent(_)}this._modelInstances[i]=p,this._target.models[r.name]=r}}},r.prototype._parseMorphTargets=function(t,e,i){for(var n=0;n<t.length;++n){var r=t[n],a=i[n],s=this._getAccessor(r.POSITION),o=void 0!==r.NORMAL?this._getAccessor(r.NORMAL):null,h=new Float32Array(3*s.count);if(this._readVertexData(h,0,s,3,3,!0),o){var l=new Float32Array(3*o.count);this._readVertexData(l,0,o,3,3,!0)}a.init(e,h,l)}},r.prototype._parsePrimitive=function(t,i,n,r,a){var s=e.Mesh.createDefaultEmpty(),o=t.attributes,h=this._getAccessor(o.POSITION),l=void 0!==o.NORMAL?this._getAccessor(o.NORMAL):null,c=void 0!==o.TANGENT?this._getAccessor(o.TANGENT):null,u=void 0!==o.TEXCOORD_0?this._getAccessor(o.TEXCOORD_0):null,p=void 0!==o.JOINTS_0?this._getAccessor(o.JOINTS_0):null,_=void 0!==o.WEIGHTS_0?this._getAccessor(o.WEIGHTS_0):null,f=0,d=s.getVertexStride(0),m=new Float32Array(h.count*d);this._readVertexData(m,0,h,3,d,!0),l?this._readVertexData(m,3,l,3,d,!0):f=e.NormalTangentGenerator.MODE_NORMALS,c?this._readVertexData(m,6,c,4,d,!0):u&&(f|=e.NormalTangentGenerator.MODE_TANGENTS),u&&this._readUVData(m,10,u,d),s.setVertexData(m,0);var v=this._getAccessor(t.indices);if(s.setIndexData(this._readIndices(v)),f){var g=new e.NormalTangentGenerator;g.generate(s)}if(p){s.addVertexAttribute("hx_jointIndices",4,1),s.addVertexAttribute("hx_jointWeights",4,1),d=s.getVertexStride(1);var y=new Float32Array(p.count*d);this._readVertexData(y,0,p,4,d),this._readVertexData(y,4,_,4,d),s.setVertexData(y,1)}r&&s.generateMorphData(a),i.addMesh(s),n.push(this._materials[t.material])},r.prototype._readVertexData=function(t,i,n,r,a,s){var o,h,l,c=i,u=n.byteOffset,p=n.count,_=n.data;if(_)for(n.dataType===e.DataType.FLOAT?(h=_.getFloat32,l=4):n.dataType===e.DataType.UNSIGNED_SHORT?(h=_.getUint16,l=2):n.dataType===e.DataType.UNSIGNED_INT&&(h=_.getUint32,l=4),o=0;o<p;++o){for(var f=0;f<r;++f)t[c+f]=h.call(_,u,!0),u+=l;c+=a}else{for(o=0;o<p;++o)for(var f=0;f<r;++f)t[c+f]=0;c+=a}if(n.isSparse&&this._applySparseAccessor(t,n,r,a,h,l),s)for(c=i,o=0;o<p;++o){var d=t[c+1];t[c]=-t[c],t[c+1]=t[c+2],t[c+2]=d,c+=a}},r.prototype._applySparseAccessor=function(t,i,n,r,a,s){var o,h,l=i.sparseCount,c=i.sparseIndices.data,u=i.sparseValues.data,p=i.sparseIndices.byteOffset,_=i.sparseValues.byteOffset;i.dataType===e.DataType.UNSIGNED_SHORT?(o=c.getUint16,h=2):i.dataType===e.DataType.UNSIGNED_INT&&(o=c.getUint32,h=4);for(var f=0;f<l;++f){for(var d=o.call(c,p)*r,m=0;m<n;++m){var v=a.call(u,_,!0);_+=s,t[d+m]=v}p+=h}},r.prototype._readUVData=function(t,e,i,n){for(var r=e,a=i.byteOffset,s=i.count,o=i.data,h=0;h<s;++h)t[r]=o.getFloat32(a,!0),t[r+1]=1-o.getFloat32(a+4,!0),a+=8,r+=n},r.prototype._readIndices=function(t){var i,n,r,a=t.byteOffset,s=t.data,o=t.count;t.dataType===e.DataType.UNSIGNED_SHORT?(n=Uint16Array,i=s.getUint16,r=2):t.dataType===e.DataType.UNSIGNED_INT&&(n=Uint32Array,i=s.getUint32,r=4);for(var h=new n(o),l=0;l<o;++l)h[l]=i.call(s,a,!0),a+=r;return h},r.prototype._parseSkin=function(t,i){var n=t.skin,r=this._gltf.skins[n],a=this._getAccessor(r.inverseBindMatrices),s=a.data,o=a.byteOffset,h=new e.Skeleton,l=new e.SkeletonPose,c=this._nodes[r.skeleton];c.parent&&c.parent.detach(c);for(var u=0;u<r.joints.length;++u){var p=r.joints[u],_=new e.SkeletonJoint;_.inverseBindPose=this._readMatrix4x4(s,o),o+=64,_.inverseBindPose.prepend(this._flipCoord),_.inverseBindPose.append(this._flipCoord),h.addJoint(_);var f=this._nodes[p];if(void 0!==f._jointIndex)throw new Error("Adding one node to multiple skeletons!");f._jointIndex=u,f._skeletonPose=l;var d=new e.SkeletonJointPose;d.position.copyFrom(f.position),d.rotation.copyFrom(f.rotation),d.scale.copyFrom(f.scale),l.setJointPose(u,d)}for(u=0;u<r.joints.length;++u){var p=r.joints[u],f=this._nodes[p],_=h.getJoint(u);_.parentIndex=f!==c&&f.parent?f.parent._jointIndex:-1}i.model.skeleton=h,i.skeletonPose=l},r.prototype._parseNodes=function(){var t=this._gltf.nodes;if(t){var i=new e.Matrix4x4;this._nodes=[];for(var n=0;n<t.length;++n){var r,a=t[n];a.hasOwnProperty("mesh")?(r=this._modelInstances[a.mesh],r.name=a.name||r.model.name||"node_"+n,this._target.modelInstances[r.name]=r):r=new e.SceneNode,a.rotation&&(r.rotation.set(a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3]),i.fromQuaternion(r.rotation),i.prepend(this._flipCoord),i.append(this._flipCoord),r.rotation.fromMatrix(i)),a.translation&&r.position.set(a.translation[0],a.translation[1],-a.translation[2],1),a.scale&&r.scale.set(a.scale[0],a.scale[1],a.scale[2],1),a.matrix&&(r.matrix=new e.Matrix4x4(a.matrix),r.matrix.prepend(this._flipCoord),r.matrix.append(this._flipCoord)),this._nodes[n]=r}for(n=0;n<t.length;++n)if(a=t[n],r=this._nodes[n],a.children)for(var s=0;s<a.children.length;++s){var o=a.children[s];r.attach(this._nodes[o])}for(n=0;n<t.length;++n)a=t[n],r=this._nodes[n],a.hasOwnProperty("skin")&&this._parseSkin(a,r)}},r.prototype._parseScenes=function(){var t=this._gltf.scenes;if(t)for(var i=0;i<t.length;++i){var n,r=t[i];i===this._defaultSceneIndex?n=this._target.defaultScene:(n=new e.Scene,this._target.scenes.push(n));for(var a=r.nodes,s=0;s<a.length;++s){var o=a[s];n.attach(this._nodes[o])}}},r.prototype._parseAnimationSampler=function(t,i){var n=this._getAccessor(t.input),r=this._getAccessor(t.output),a=n.data,s=r.data,o=n.byteOffset,h=r.byteOffset,l=new e.Matrix4x4,c=r.count/n.count,u=[];if(1===c)var p=u[0]=new e.AnimationClip;else for(var _=0;_<c;++_)u[_]=new e.AnimationClip;for(var f=0;f<n.count;++f){var d;switch(r.numComponents){case 1:for(d=[],_=0;_<c;++_)d[_]=this._readFloat(s,h+4*_);break;case 3:if(d=this._readFloat3(s,h),i){d.x=-d.x;var m=d.y;d.y=d.z,d.z=m}break;case 4:d=this._readQuat(s,h),i&&(l.fromQuaternion(d),l.prepend(this._flipCoord),l.append(this._flipCoord),d.fromMatrix(l));break;default:throw new Error("Unsupported animation sampler type")}var v,g=1e3*this._readFloat(a,o);if(1===c)v=new e.KeyFrame(g,d),p.addKeyFrame(v);else for(var _=0;_<c;++_)v=new e.KeyFrame(g,d[_]),u[_].addKeyFrame(v);h+=r.numComponents*c*4,o+=4}return u},r.prototype._parseAnimations=function(){var t=this._gltf.animations;if(t)for(var i=0;i<t.length;++i){for(var n=t[i],r=new e.LayeredAnimation,a=0;a<n.channels.length;++a)for(var s=this._parseAnimationChannel(n.channels[a],n.samplers),o=0;o<s.length;++o)r.addLayer(s[o]);r.name=n.name||"animation_"+i,this._target.animations[r.name]=r}},r.prototype._parseAnimationChannel=function(t,i){var n=this._nodes[t.target.node],r=[];switch(void 0!==n._jointIndex&&(n=n._skeletonPose._jointPoses[n._jointIndex]),t.target.path){case"translation":var a=this._parseAnimationSampler(i[t.sampler],!0);r=[new e.AnimationLayerFloat4(n,"position",a[0])];break;case"rotation":var a=this._parseAnimationSampler(i[t.sampler],!0);r=[new e.AnimationLayerQuat(n,"rotation",a[0])];break;case"scale":var a=this._parseAnimationSampler(i[t.sampler],!1);r=[new e.AnimationLayerFloat4(n,"scale",a[0])];break;case"weights":var a=this._parseAnimationSampler(i[t.sampler],!1);r=[];for(var s=0;s<a.length;++s)r.push(new e.AnimationLayerMorphTarget(n.getFirstComponentByType(e.MorphAnimation),"morphTarget_"+s,a[s]));break;default:throw new Error("Unknown channel path!")}return r},r.prototype._playAnimations=function(){var t=this._target.animations;e.ArrayUtils.forEach(t,function(t){t.play()})},r.prototype._readFloat3=function(t,i){var n=new e.Float4;return n.x=t.getFloat32(i,!0),n.y=t.getFloat32(i+4,!0),n.z=t.getFloat32(i+8,!0),n},r.prototype._readQuat=function(t,i){var n=new e.Quaternion;return n.x=t.getFloat32(i,!0),n.y=t.getFloat32(i+4,!0),n.z=t.getFloat32(i+8,!0),n.w=t.getFloat32(i+12,!0),n},r.prototype._readFloat=function(t,e){return t.getFloat32(e,!0)},r.prototype._readMatrix4x4=function(t,i){for(var n=[],r=0;r<16;++r)n[r]=t.getFloat32(i,!0),i+=4;return new e.Matrix4x4(n)},a.prototype=Object.create(e.Importer.prototype),a.prototype.parse=function(t,i){this._skeleton=new e.Skeleton,this._model=i,this._jointData=[];for(var n=t.split("\n"),r=n.length,s=null,o=0;o<r;++o){var h=n[o].replace(/^\s+|\s+$/g,""),l=h.split(/\s+/);if("//"!==l[0]&&""!==l[0])if(s)s.call(this,l),"}"===l[0]&&(s=null);else switch(l[0]){case"commandline":case"numMeshes":case"numJoints":case"MD5Version":break;case"joints":s=this._parseJoint;break;case"mesh":this._meshData=new a._MeshData,s=this._parseMesh}}i.skeleton=this._skeleton,this._notifyComplete(i)},a.prototype._parseJoint=function(t){if("}"!==t[0]){var i=new a._Joint,n=i.pos,r=i.quat;i.name=t[0].substring(1,t[0].length-1),i.parentIndex=parseInt(t[1]),n.x=parseFloat(t[3]),n.y=parseFloat(t[4]),n.z=parseFloat(t[5]),r.x=parseFloat(t[8]),r.y=parseFloat(t[9]),r.z=parseFloat(t[10]),r.w=1-r.x*r.x-r.y*r.y-r.z*r.z,r.w<0?r.w=0:r.w=-Math.sqrt(r.w),this._jointData.push(i);var s=new e.SkeletonJoint;s.inverseBindPose.fromQuaternion(r);var n=i.pos;s.inverseBindPose.appendTranslation(n),s.inverseBindPose.invertAffine(),s.parentIndex=i.parentIndex,this._skeleton.addJoint(s)}},a.prototype._parseMesh=function(t){switch(t[0]){case"shader":case"numVerts":case"numWeights":break;case"tri":this._meshData.indices.push(parseInt(t[2]),parseInt(t[4]),parseInt(t[3]));break;case"vert":this._parseVert(t);break;case"weight":this._parseWeight(t);break;case"}":this._translateMesh()}},a.prototype._parseVert=function(t){var e=new a._VertexData;e.u=parseFloat(t[3]),e.v=parseFloat(t[4]),e.startWeight=parseInt(t[6]),e.countWeight=parseInt(t[7]),this._meshData.vertexData.push(e)},a.prototype._parseWeight=function(t){var e=new a._WeightData;e.joint=parseInt(t[2]),e.bias=parseFloat(t[3]),e.pos.x=parseFloat(t[5]),e.pos.y=parseFloat(t[6]),e.pos.z=parseFloat(t[7]),this._meshData.weightData.push(e)},a.prototype._translateMesh=function(){var t=new e.Mesh.createDefaultEmpty;t.addVertexAttribute("hx_jointIndices",4,1),t.addVertexAttribute("hx_jointWeights",4,1);for(var i,n,r,a=[],s=[],o=this._meshData.vertexData,h=o.length,l=0,c=0,u=0;u<h;++u){var p=o[u];i=n=r=0,p.countWeight>4&&console.warn("Warning: more than 4 weights assigned. Mesh will not animate correctly");for(var _=0;_<p.countWeight;++_){var f=this._meshData.weightData[p.startWeight+_],d=this._jointData[f.joint],m=d.quat.rotate(f.pos),v=d.pos,g=f.bias;i+=(m.x+v.x)*g,n+=(m.y+v.y)*g,r+=(m.z+v.z)*g,_<4&&(s[c+_]=f.joint,s[c+4+_]=f.bias)}a[l]=i,a[l+1]=n,a[l+2]=r,a[l+3]=0,a[l+4]=0,a[l+5]=1,a[l+6]=1,a[l+7]=0,a[l+8]=0,a[l+9]=1,a[l+10]=p.u,a[l+11]=1-p.v;for(var _=p.countWeight;_<4;++_)s[c+_]=0,s[c+4+_]=0;c+=8,l+=12}t.setVertexData(a,0),t.setVertexData(s,1),t.setIndexData(this._meshData.indices);var y=new e.NormalTangentGenerator;y.generate(t,e.NormalTangentGenerator.MODE_NORMALS|e.NormalTangentGenerator.MODE_TANGENTS),this._model.addMesh(t)},a._Joint=function(){this.name=null,this.parentIndex=-1,this.quat=new e.Quaternion,this.pos=new e.Float4},a._MeshData=function(){this.vertexData=[],this.weightData=[],this.indices=[]},a._VertexData=function(){this.u=0,this.v=0,this.startWeight=0,this.countWeight=0},a._WeightData=function(){this.joint=0,this.bias=0,this.pos=new e.Float4},s.prototype=Object.create(e.Importer.prototype),s.prototype.parse=function(t,e){this._hierarchy=[],this._baseFrame=[],this._target=e;for(var i=t.split("\n"),n=i.length,r=null,a=0;a<n;++a){var o=i[a].replace(/^\s+|\s+$/g,""),h=o.split(/\s+/);if("//"!==h[0]&&""!==h[0])if(r)r.call(this,h),"}"===h[0]&&(r=null);else switch(h[0]){case"commandline":case"numFrames":case"MD5Version":case"numAnimatedComponents":break;case"numJoints":this._numJoints=parseInt(h[1]);break;case"frameRate":this._frameRate=parseInt(h[1]);break;case"hierarchy":r=this._parseHierarchy;break;case"bounds":r=this._parseBounds;break;case"baseframe":r=this._parseBaseFrame;break;case"frame":this._activeFrame=new s._FrameData,r=this._parseFrame}}this._notifyComplete(e)},s.prototype._parseHierarchy=function(t){if("}"!==t[0]){var e=new s._HierachyData;e.name=t[0].substring(1,t[0].length-1),e.parent=parseInt(t[1]),e.flags=parseInt(t[2]),e.startIndex=parseInt(t[3]),this._hierarchy.push(e)}},s.prototype._parseBounds=function(t){},s.prototype._parseBaseFrame=function(t){if("}"!==t[0]){var e=new s._BaseFrameData,i=e.pos;i.x=parseFloat(t[1]),i.y=parseFloat(t[2]),i.z=parseFloat(t[3]);var n=e.quat;n.x=parseFloat(t[6]),n.y=parseFloat(t[7]),n.z=parseFloat(t[8]),n.w=1-n.x*n.x-n.y*n.y-n.z*n.z,n.w<0?n.w=0:n.w=-Math.sqrt(n.w),this._baseFrame.push(e)}},s.prototype._parseFrame=function(t){if("}"===t[0])return void this._translateFrame();for(var e=t.length,i=0;i<e;++i)this._activeFrame.components.push(parseFloat(t[i]))},s.prototype._translateFrame=function(){for(var t=new e.SkeletonPose,i=0;i<this._numJoints;++i){var n=new e.SkeletonJointPose,r=this._hierarchy[i],a=this._baseFrame[i],s=r.flags,o=a.pos,h=a.quat,l=this._activeFrame.components,c=r.startIndex;1&s&&(o.x=l[c]),2&s&&(o.y=l[c+1]),4&s&&(o.z=l[c+2]),8&s&&(h.x=l[c+3]),16&s&&(h.y=l[c+4]),32&s&&(h.z=l[c+5]);var u=1-h.x*h.x-h.y*h.y-h.z*h.z;h.w=u<0?0:-Math.sqrt(u),n.rotation.copyFrom(h),n.position.copyFrom(o),t.setJointPose(i,n)}var p=this._target.numKeyFrames/this._frameRate*1e3;this._target.addKeyFrame(new e.KeyFrame(p,t))},s._HierachyData=function(){this.name=null,this.parent=-1,this.flags=0,this.startIndex=0},s._BaseFrameData=function(){this.pos=new e.Float4,this.quat=new e.Quaternion},s._FrameData=function(){this.components=[]},o.prototype={bind:function(t,e){this._lookUp[t]=this._listeners.length;var i=e?t.bind(e):t;this._listeners.push(i)},unbind:function(t){var e=this._lookUp[t];void 0!==e&&(this._listeners.splice(e,1),delete this._lookUp[t])},unbindAll:function(){this._listeners=[],this._lookUp={}},dispatch:function(t){for(var e=this._listeners.length,i=0;i<e;++i)this._listeners[i].apply(null,arguments)},get hasListeners(){return this._listeners.length>0}},h.prototype={queue:function(t,e){var i=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);this._queue.push({func:t,args:i.slice(1)})},addChildQueue:function(t){this._childQueues.push(t)},execute:function(){if(this._isRunning)throw new Error("Already running!");this._isRunning=!0,this._currentIndex=0,this._executeTask()},_executeTask:function(){setTimeout(this._executeImpl.bind(this))},_executeImpl:function(){if(this.onProgress.dispatch(this._currentIndex/this._queue.length),this._childQueues.length>0){var t=this._childQueues.shift();t.onComplete.bind(this._executeImpl,this),t.execute()}else if(this._queue.length===this._currentIndex)this.onComplete.dispatch();else{var e=this._queue[this._currentIndex];e.func.apply(this,e.args),++this._currentIndex,this._executeTask()}}},l.prototype=Object.create(e.Importer.prototype),l.prototype.parse=function(t,e){for(var i=t.split("\n"),n=i.length,r=0;r<n;++r){var a=i[r].replace(/^\s+|\s+$/g,"");this._parseLine(a,e)}this._loadTextures(e)},l.prototype._parseLine=function(t,i){if(0!==t.length&&"#"!==t.charAt(0)){var n=t.split(/\s+/);switch(n[0].toLowerCase()){case"newmtl":this._activeMaterial=new e.BasicMaterial,this._activeMaterial.name=n[1],i[n[1]]=this._activeMaterial;break;case"ns":var r=parseFloat(n[1]);this._activeMaterial.roughness=e.BasicMaterial.roughnessFromShininess(r),this._activeMaterial.roughnessRange=this._activeMaterial.roughness;break;case"kd":this._activeMaterial.color=new e.Color(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]));break;case"map_kd":this._activeMaterial.colorMap=this._getTexture(n[1]);break;case"map_d":this._activeMaterial.maskMap=this._getTexture(n[1]),this._activeMaterial.alphaThreshold=.5;break;case"map_ns":this._activeMaterial.specularMap=this._getTexture(n[1]);break;case"map_bump":case"bump":this._activeMaterial.normalMap=this._getTexture(n[1])}}},l.prototype._getTexture=function(t){if(!this._textures[t]){var i=new e.Texture2D;this._textures[t]=i,this._texturesToLoad.push({file:this._correctURL(t),importer:e.JPG,target:i})}return this._textures[t]},l.prototype._loadTextures=function(t){var i=new e.AssetLibrary(null,this.options.crossOrigin);i.fileMap=this.fileMap;var n=this._texturesToLoad,r=n.length;if(0===r)return void this._notifyComplete(t);for(var a=0;a<n.length;++a)i.queueAsset(n[a].file,n[a].file,e.AssetLibrary.Type.ASSET,n[a].importer,this.options,n[a].target);i.onComplete.bind(function(){this._notifyComplete(t)},this),i.onProgress.bind(function(t){this._notifyProgress(t)},this),i.load(n)},c.prototype=Object.create(e.Importer.prototype),c.prototype.parse=function(t,e){this._groupsAsObjects=void 0===this.options.groupsAsObjects||this._groupsAsObjects,this._target=e;var i=t.split("\n"),n=i.length;this._pushNewObject("hx_default");for(var r=0;r<n;++r){var a=i[r].replace(/^\s+|\s+$/g,"");this._parseLine(a)}this._mtlLibFile?this._loadMTLLib(this._mtlLibFile):this._finish(null)},c.prototype._finish=function(t){for(var e=new h,i=this._objects.length,n=0;n<i;++n)e.queue(this._translateObject.bind(this),n,t);e.queue(this._notifyComplete.bind(this),this._target),e.execute()},c.prototype._loadMTLLib=function(t){var i=new e.AssetLoader(l),n=this;i.onComplete=function(t){n._finish(t)},i.onProgress=function(t){n._notifyProgress(.8*t)},i.onFail=function(t){n._notifyFailure(t)},i.load(t)},c.prototype._parseLine=function(t){if(0!==t.length&&"#"!==t.charAt(0)){var e=t.split(/\s+/);switch(e[0].toLowerCase()){case"mtllib":this._mtlLibFile=this._correctURL(e[1]);break;case"usemtl":this._setActiveSubGroup(e[1]);break;case"v":this._vertices.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"vt":this._uvs.push(parseFloat(e[1]),parseFloat(e[2]));break;case"vn":this._normals.push(parseFloat(e[1]),parseFloat(e[3]),parseFloat(e[2]));break;case"o":this._pushNewObject(e[1]);break;case"g":this._groupsAsObjects?this._pushNewObject(e[1]):this._pushNewGroup(e[1]);break;case"f":this._parseFaceData(e)}}},c.prototype._pushNewObject=function(t){this._activeObject=new c._ObjectData,this._activeObject.name=t,this._objects.push(this._activeObject),this._pushNewGroup("hx_default")},c.prototype._pushNewGroup=function(t){this._activeGroup=new c._GroupData,this._activeGroup.name=t||"Group"+this._activeGroup.length,this._activeObject.groups.push(this._activeGroup),this._setActiveSubGroup("hx_default")},c.prototype._setActiveSubGroup=function(t){this._activeGroup.subgroups[t]=this._activeGroup.subgroups[t]||new c._SubGroupData,this._activeSubGroup=this._activeGroup.subgroups[t]},c.prototype._parseFaceData=function(t){for(var e=new c._FaceData,i=t.length,n=1;n<i;++n){var r=new c._FaceVertexData;e.vertices.push(r);var a=t[n].split("/"),s=3*(a[0]-1);r.posX=this._vertices[s],r.posY=this._vertices[s+1],r.posZ=this._vertices[s+2],a.length>1&&(s=2*(a[1]-1),r.uvU=this._uvs[s],r.uvV=this._uvs[s+1],a.length>2&&(s=3*(a[2]-1),this._hasNormals=!0,r.normalX=this._normals[s],r.normalY=this._normals[s+1],r.normalZ=this._normals[s+2]))}this._activeSubGroup.faces.push(e),this._activeSubGroup.numIndices+=4===t.length?3:6},c.prototype._translateObject=function(t,i){var n=this._objects[t],r=n.groups.length;if(0!==r){for(var a=[],s=new e.Model,o=0;o<r;++o){var h=n.groups[o];for(var l in h.subgroups)if(h.subgroups.hasOwnProperty(l)){var c=h.subgroups[l];if(0===c.numIndices)continue;s.addMesh(this._translateMesh(c));var u=i?i[l]:null;u=u||this._defaultMaterial,a.push(u)}}var p=new e.ModelInstance(s,a);p.name=n.name,this._target.attach(p),this._notifyProgress(.8+(t+1)/this._objects.length*.2)}},c.prototype._translateMesh=function(t){for(var i=e.Mesh.createDefaultEmpty(),n=[],r=new Array(t.numIndices),a=0,s=0,o=t.faces,h=o.length,l=0;l<h;++l){for(var c=o[l],u=c.vertices,p=u.length,_=0;_<p;++_){var f=u[_],d=f.getHash();n.hasOwnProperty(d)||(n[d]={index:a++,vertex:f})}r[s]=n[u[0].getHash()].index,r[s+1]=n[u[2].getHash()].index,r[s+2]=n[u[1].getHash()].index,s+=3,4===p&&(r[s]=n[u[0].getHash()].index,r[s+1]=n[u[3].getHash()].index,r[s+2]=n[u[2].getHash()].index,s+=3)}var m=new Array(a*e.Mesh.DEFAULT_VERTEX_SIZE);for(var d in n)if(n.hasOwnProperty(d)){var v=n[d],g=v.vertex,y=v.index*e.Mesh.DEFAULT_VERTEX_SIZE;m[y]=g.posX,m[y+1]=g.posY,m[y+2]=g.posZ,m[y+3]=g.normalX,m[y+4]=g.normalY,m[y+5]=g.normalZ,m[y+6]=0,m[y+7]=0,m[y+8]=0,m[y+9]=1,m[y+10]=g.uvU,m[y+11]=g.uvV}i.setVertexData(m,0),i.setIndexData(r);var x=e.NormalTangentGenerator.MODE_TANGENTS;this._hasNormals||(x|=e.NormalTangentGenerator.MODE_NORMALS);var w=new e.NormalTangentGenerator;return w.generate(i,x,!0),i},c._FaceVertexData=function(){this.posX=0,this.posY=0,this.posZ=0,this.uvU=0,this.uvV=0,this.normalX=0,this.normalY=0,this.normalZ=0,this._hash=""},c._FaceVertexData.prototype={getHash:function(){return this._hash||(this._hash=this.posX+"/"+this.posY+"/"+this.posZ+"/"+this.uvU+"/"+this.uvV+"/"+this.normalX+"/"+this.normalY+"/"+this.normalZ+"/"),this._hash}},c._FaceData=function(){this.vertices=[]},c._SubGroupData=function(){this.numIndices=0,this.faces=[]},c._GroupData=function(){this.subgroups=[],this.name="",this._activeMaterial=null},c._ObjectData=function(){this.name="",this.groups=[],this._activeGroup=null},u.prototype={getChildByName:function(t){for(var e=this.children.length,i=0;i<e;++i){var n=this.children[i];if(n.name===t)return n}},printDebug:function(t,e){void 0===t&&(t=!0),void 0===e&&(e=0);for(var i="",n=0;n<e;++n)i+="\t";if(console.log(i+this.name),t&&this.data.length>0){console.log(i+"\t[data] {");for(var n=0;n<this.data.length;++n)console.log(i+"\t\t["+n+"] : "+this.data[n]);console.log(i+"}")}for(var n=0;n<this.children.length;++n)this.children[n].printDebug(t,e+1)}},p.prototype={get version(){return this._version},deserialize:function(t){this._data=t,this._verifyHeader(),26!==this._data.getUint16()&&console.log("Suspected oddity with FBX file"),this._version=this._data.getUint32();var e=new u;return e.name="[root]",this._deserializeNode(e),e},_verifyHeader:function(){if("Kaydara FBX Binary  \0"!==this._data.getString(21))throw new Error("Incorrect FBX file header!")},_deserializeNode:function(t){var e;do e=this._importNode(),e&&t.children.push(e);while(e)},_importNode:function(){var t=this._data,e=t.getUint32(),i=t.getUint32(),n=t.getUint32(),r=t.getUint8();if(0===e){if(0!==i||0!==n||0!==r)throw new Error("Invalid null node!");return null}var a=new u;a.name=t.getString(r);for(var s=0;s<i;++s){var o=this._parseDataElement();a.data.push(o)}return t.offset!==e&&this._deserializeNode(a),a},_parseDataElement:function(){var t=this._data.getChar();switch(t){case p.BOOLEAN:return this._data.getUint8();case p.INT16:return this._data.getInt16();case p.INT32:return this._data.getInt32();case p.INT64:return this._data.getInt64AsFloat64();case p.FLOAT:return this._data.getFloat32();case p.DOUBLE:return this._data.getFloat64();case p.STRING:var e=this._data.getUint32();return 0===e?"":this._data.getString(e);case p.RAW:var e=this._data.getUint32();return this._data.getUint8Array(e);default:return this._parseArray(t)}},_parseArray:function(t){var e=this._data.getUint32(),n=this._data.getUint32(),r=this._data.getUint32();if(0===n)switch(t){case p.BOOLEAN_ARRAY:return this._data.getUint8Array(e);case p.INT32_ARRAY:return this._data.getInt32Array(e);case p.INT64_ARRAY:return this._data.getInt64AsFloat64Array(e);
case p.FLOAT_ARRAY:return this._data.getFloat32Array(e);case p.DOUBLE_ARRAY:return this._data.getFloat64Array(e);default:throw new Error("Unknown data type code "+t)}else{if(1!==n)throw new Error("Invalid encoding value "+n);var a=this._data.getUint8Array(r);switch(a=i.inflate(a).buffer,t){case p.BOOLEAN_ARRAY:return new Uint8Array(a);case p.INT32_ARRAY:return new Int32Array(a);case p.INT64_ARRAY:return a=new HX.DataStream(new DataView(a)),a.getInt64AsFloat64Array(a.byteLength/8);case p.FLOAT_ARRAY:return new Float32Array(a);case p.DOUBLE_ARRAY:return new Float64Array(a);default:throw new Error("Unknown data type code "+t)}}}},p.INT16="Y",p.BOOLEAN="C",p.INT32="I",p.FLOAT="F",p.DOUBLE="D",p.INT64="L",p.BOOLEAN_ARRAY="b",p.INT32_ARRAY="i",p.FLOAT_ARRAY="f",p.DOUBLE_ARRAY="d",p.INT64_ARRAY="l",p.STRING="S",p.RAW="R",_.prototype={connectObject:function(t){throw new Error("Unhandled object connection "+t.toString()+" -> "+this.toString())},connectProperty:function(t,e){},copyProperties:function(t){for(var e in t)if(this.hasOwnProperty(e)&&void 0!==t[e]&&null!==t[e]){var i=e.charAt(0);i.toUpperCase()===i&&(this[e]=t[e])}}},_.prototype.toString=function(){return"[FbxObject(name="+this.name+")]"},f.prototype=Object.create(_.prototype),f.prototype.toString=function(){return"[FbxNodeAttribute(name="+this.name+", type="+this.type+")]"},d.prototype=Object.create(_.prototype),d.prototype.toString=function(){return"[FbxCluster(name="+this.name+")]"},d.prototype.connectObject=function(t){if(!(t instanceof A))throw new Error("Unhandled object connection "+t.toString());this.limbNode=t},m.prototype=Object.create(_.prototype),m.prototype.toString=function(){return"[FbxSkin(name="+this.name+")]"},m.prototype.connectObject=function(t){if(!(t instanceof d))throw new Error("Unhandled object connection "+t.toString());this.clusters=this.clusters||[],this.clusters.push(t)},v.prototype=Object.create(_.prototype),v.prototype.toString=function(){return"[FbxMesh(name="+this.name+")]"},v.prototype.connectObject=function(t){if(!(t instanceof m))throw new Error("Unhandled object connection "+t.toString());this.deformers=this.deformers||[],this.deformers.push(t)},g.prototype=Object.create(_.prototype),g.prototype.toString=function(){return"[FbxVideo(name="+this.name+")]"},y.prototype=Object.create(_.prototype),y.prototype.connectObject=function(t){if(!(t instanceof g))throw new Error("Incompatible child object!");this.video=t},y.prototype.toString=function(){return"[FbxFileTexture(name="+this.name+")]"},x.prototype=Object.create(_.prototype),x.prototype.connectProperty=function(t,e){if(!(t instanceof y))throw new Error("Unknown object property!");this.textures=this.textures||{},this.textures[e]=t},x.prototype.toString=function(){return"[FbxMaterial(name="+this.name+")]"},w.prototype=Object.create(_.prototype),w.prototype.toString=function(){return"[FbxTrashNode(name="+this.name+")]"},w.prototype.connectObject=function(t){},b.prototype=Object.create(_.prototype),b.prototype.toString=function(){return"[FbxAnimationCurve(name="+this.name+")]"},T.prototype=Object.create(_.prototype),T.prototype.toString=function(){return"[FbxAnimationCurveNode(name="+this.name+")]"},T.prototype.connectProperty=function(t,e){t instanceof b&&(this.curves=this.curves||{},this.curves[e]=t)},A.prototype=Object.create(_.prototype,{numChildren:{get:function(){return this.children?this.children.length:0}},geometryTransform:{get:function(){if(!this._geometricMatrix&&(this._geometricMatrix=new HX.Matrix4x4,this.GeometricRotation||this.GeometricScaling||this.GeometricTranslation)){var t=new HX.Transform;if(this.GeometricRotation){var e=new HX.Quaternion;e.fromEuler(this.GeometricRotation.x*HX.MathX.DEG_TO_RAD,this.GeometricRotation.y*HX.MathX.DEG_TO_RAD,this.GeometricRotation.z*HX.MathX.DEG_TO_RAD),t.rotation=e}this.GeometricScaling&&(t.scale=this.GeometricScaling),this.GeometricTranslation&&(t.position=this.GeometricTranslation),this._geometricMatrix.copyFrom(t.matrix)}return this._geometricMatrix}},matrix:{get:function(){if(!this._matrix){this._matrix=new HX.Matrix4x4;var t=this._matrix,e=new HX.Float4;this.ScalingPivot&&(e.negativeOf(this.ScalingPivot),t.appendTranslation(e));var i=this["Lcl Scaling"];i&&t.appendScale(i.x,i.y,i.z),this.ScalingPivot&&t.appendTranslation(this.ScalingPivot),this.ScalingOffset&&t.appendTranslation(this.ScalingOffset),this.RotationPivot&&(e.negativeOf(this.RotationPivot),t.appendTranslation(e)),this.PreRotation&&t.appendQuaternion(this._convertRotation(this.PreRotation)),this["Lcl Rotation"]&&t.appendQuaternion(this._convertRotation(this["Lcl Rotation"])),this.PostRotation&&t.appendQuaternion(this._convertRotation(this.PostRotation)),this.RotationPivot&&t.appendTranslation(this.RotationPivot),this.RotationOffset&&t.appendTranslation(this.RotationOffset),this["Lcl Translation"]&&t.appendTranslation(this["Lcl Translation"])}return this._matrix}}}),A.prototype.getChild=function(t){return this.children[t]},A.prototype.connectObject=function(t){if(t instanceof A)"Root"===t.type?this.skeleton=t:(this.children=this.children||[],this.children.push(t),t.parent=this);else if(t instanceof f)this.defaultAttribute=this.defaultAttribute||t,this.attributes=this.attributes||[],this.attributes.push(t);else if(t instanceof v)this.mesh=t,this.mesh.parent=this;else if(t instanceof x)this.materials=this.materials||[],this.materials.push(t);else if(!(t instanceof w))throw new Error("Incompatible child object "+t.toString()+" for "+this.type)},A.prototype._convertRotation=function(t){var e=new HX.Quaternion;return e.fromEuler(t.x*HX.MathX.DEG_TO_RAD,t.y*HX.MathX.DEG_TO_RAD,t.z*HX.MathX.DEG_TO_RAD),e},A.prototype.connectProperty=function(t,e){t instanceof T&&(this.animationCurveNodes=this.animationCurveNodes||{},this.animationCurveNodes[e]=t,t.propertyName=e)},A.prototype.toString=function(){return"[FbxNode(name="+this.name+", type="+this.type+")]"},I.prototype=Object.create(_.prototype),I.prototype.toString=function(){return"[FbxAnimLayer(name="+this.name+")]"},I.prototype.connectObject=function(t){if(!(t instanceof T))throw new Error("Incompatible child object "+t.toString());this.curveNodes=this.curveNodes||[],this.curveNodes.push(t)},M.getSpan=function(t,e){return new M(e._value-t._value)},M.TC_MILLISECOND=46186158,M.prototype={get milliseconds(){return this._value/M.TC_MILLISECOND},set milliseconds(t){this._value=t*M.TC_MILLISECOND},getFrameCount:function(t){return Math.floor(this.milliseconds/1e3*t)},toString:function(){return"[FbxTime(name="+this._value+")]"}},F.prototype=Object.create(_.prototype),F.prototype.connectObject=function(t){if(!(t instanceof I))throw new Error("Incompatible child object "+t.toString());this.layers=this.layers||[],this.layers.push(t)},F.prototype.toString=function(){return"[FbxAnimStack(name="+this.name+")]"},S.prototype=Object.create(_.prototype),S.prototype.toString=function(){return"[FbxPose(name="+this.name+")]"},O.prototype=Object.create(_.prototype),O.MAPPING_TYPE={NONE:0,BY_POLYGON_VERTEX:1,BY_CONTROL_POINT:2,BY_POLYGON:3,ALL_SAME:4},O.REFERENCE_TYPE={DIRECT:1,INDEX_TO_DIRECT:2},O.prototype.toString=function(){return"[FbxLayerElement(name="+this.name+")]"},D.prototype={get bindPoses(){return this._bindPoses},get sceneRoot(){return this._rootNode},get animationStack(){return this._animationStack},build:function(t,e){this._settings=e,this._templates={},this._objects={},this._bindPoses=null,this._rootNode=new A,this._rootNode.name="hx_rootNode",this._animationStack=null,this._processTemplates(t.getChildByName("Definitions")),this._processObjects(t.getChildByName("Objects")),this._processConnections(t.getChildByName("Connections"))},_processTemplates:function(t){for(var e=t.children.length,i=0;i<e;++i){var n=t.children[i];if("ObjectType"===n.name){var r=n.getChildByName("PropertyTemplate");if(!r)continue;var a=r.data[0],s=n.data[0],o=this._createNode(s,a,r);o&&this._assignProperties(o,r.getChildByName("Properties70")),this._templates[s]=o}}},_processObjects:function(t){for(var e=t.children.length,i=0;i<e;++i){var n=null,r=t.children[i];switch(r.name){case"Geometry":n=this._processGeometry(r);break;case"NodeAttribute":n=new f,n.type=r.data[2];break;case"Model":n=new A,n.type=r.data[2];break;case"Material":n=new x;break;case"Video":n=new g;var a=r.getChildByName("RelativeFilename");n.relativeFilename=a?a.data[0]:null;break;case"Texture":n=new y;var a=r.getChildByName("RelativeFilename");n.relativeFilename=a?a.data[0]:null;break;case"Pose":n=this._processPose(r),this._bindPoses=this._bindPoses||[],this._bindPoses.push(n);break;case"Deformer":n="Skin"===r.data[2]?new m:this._processCluster(r);break;case"AnimationStack":n=new F,this._animationStack=n;break;case"AnimationLayer":n=new I;break;case"AnimationCurve":n=new b,this._assignFlatData(n,r);for(var s=[],o=0;o<n.KeyTime.length;++o)s[o]=new M(n.KeyTime[o]);n.KeyTime=s;break;case"AnimationCurveNode":n=new T;break;default:n=new w}if(n){var h=r.data[0];n.name=this._getObjectDefName(r),n.UID=h,this._templates[r.name]&&n.copyProperties(this._templates[r.name]),this._assignProperties(n,r.getChildByName("Properties70")),this._objects[h]=n}}},_processPose:function(t){var e=new S;e.type=t.data[2];for(var i=0;i<t.children.length;++i){var n=t.children[i];if("PoseNode"===n.name){var r=new N;r.targetUID=n.getChildByName("Node").data[0],r.matrix=new HX.Matrix4x4(n.getChildByName("Matrix").data[0]),e.poseNodes.push(r)}}return e},_processConnections:function(t){for(var e=t.children.length,i=0;i<e;++i){var n=t.children[i],r=n.data[0],a=this._objects[n.data[1]],s=this._objects[n.data[2]]||this._rootNode;"OO"===r?s.connectObject(a):"OP"===r&&s.connectProperty(a,n.data[3])}},_createNode:function(t,e){return"Material"===t?new x:HX[e]?new HX[e]:void 0},_assignFlatData:function(t,e){for(var i=e.children.length,n=0;n<i;++n){var r=e.children[n];t.hasOwnProperty(r.name)&&(t[r.name]=r.data[0])}},_assignProperties:function(t,e){if(e)for(var i=e.children.length,n=0;n<i;++n){var r=e.children[n];t.hasOwnProperty(r.data[0])&&(t[r.data[0]]=this._getPropertyValue(r))}},_getPropertyValue:function(t){var e=t.data;switch(e[1]){case"Vector3D":case"Lcl Translation":case"Lcl Scaling":case"Lcl Rotatfion":return new HX.Float4(e[4],e[5],e[6]);case"bool":case"Visibility":case"Visibility Inheritance":return 0!==e[4];case"ColorRGB":case"Color":return new HX.Color(e[4],e[5],e[6]);case"enum":case"double":case"float":case"int":case"KString":return e[4];case"KTime":return new M(e[4]);case"object":return null}},_processGeometry:function(t){for(var e=new v,i=t.children.length,n={},r=0;r<i;++r){var a=t.children[r];switch(a.name){case"Vertices":e.vertices=a.data[0];break;case"PolygonVertexIndex":e.indices=a.data[0];break;case"Layer":e.layerElements=e.layerElements||{},this._processLayer(a,n,e.layerElements);break;default:n[a.name]||(n[a.name]=a)}}return e},_processLayer:function(t,e,i){for(var n=t.children.length,r=0;r<n;++r){var a=t.children[r];if("LayerElement"===a.name){var s=a.getChildByName("Type").data[0];if(!i[a.type]){var a=this._processLayerElement(e[s]);i[a.type]=a}}}},_processLayerElement:function(t){for(var e=new O,i=t.children.length,n=0;n<i;++n){var r=t.children[n];switch(r.name){case"MappingInformationType":var a=r.data[0];e.mappingInformationType="ByPolygonVertex"===a?O.MAPPING_TYPE.BY_POLYGON_VERTEX:"ByPolygon"===a?O.MAPPING_TYPE.BY_POLYGON:"AllSame"===a?O.MAPPING_TYPE.ALL_SAME:O.MAPPING_TYPE.BY_CONTROL_POINT;break;case"ReferenceInformationType":e.referenceInformationType="Direct"===r.data[0]?O.REFERENCE_TYPE.DIRECT:O.REFERENCE_TYPE.INDEX_TO_DIRECT;break;case"Normals":case"Colors":case"UV":case"Smoothing":e.type=r.name,e.directData=r.data[0];break;case"NormalsIndex":case"ColorIndex":case"UVIndex":case"SmoothingIndex":e.indexData=r.data[0];break;case"Materials":e.type=r.name,e.indexData=r.data[0]}}return e},_getObjectDefName:function(t){return t.data[1].split(D._STRING_DEMARCATION)[0]},_processCluster:function(t){for(var e=new d,i=t.children.length,n=0;n<i;++n){var r=t.children[n];switch(r.name){case"Transform":e.transform=new HX.Matrix4x4(r.data[0]);break;case"TransformLink":e.transformLink=new HX.Matrix4x4(r.data[0]);break;case"Indexes":e.indices=r.data[0];break;case"Weights":e.weights=r.data[0]}}return e}},D._STRING_DEMARCATION=String.fromCharCode(0,1),E.prototype={get skeleton(){return this._skeleton},get animationClips(){return this._animationClips},get fakeJointIndex(){return this._fakeJointIndex},getJointBinding:function(t){return this._skinningData[t]},convertSkin:function(t,e){this._skeleton=new HX.Skeleton,this._skinningData=[],this._jointUIDLookUp={};for(var i=t.clusters.length,n=0;n<i;++n){var r=t.clusters[n];this._addJointsToSkeleton(this._getRootNodeForCluster(r));var a=this._jointUIDLookUp[r.limbNode.UID];this._assignInverseBindPose(r,e,a.joint),this._assignJointBinding(r,a.index)}for(var s in this._jointUIDLookUp)this._jointUIDLookUp[s].fbxNode.data=null},convertClips:function(t,e,i,n){this._frameRate=n.frameRate,this._animationClips=[];for(var r=0;r<t.layers.length;++r)for(var a=t.layers,s=0;s<a.length;++s){var o=this._convertLayer(a[s]);this._animationClips.push(o)}},_addJointsToSkeleton:function(t){t.data!==!0&&(t.data=!0,this._convertSkeletonNode(t,-1))},_convertSkeletonNode:function(t,e){var i=new HX.SkeletonJoint;i.parentIndex=e;var n=this._skeleton.numJoints;if(this._skeleton.addJoint(i),this._jointUIDLookUp[t.UID]={joint:i,index:n,fbxNode:t},t.animationCurveNodes)for(var r in t.animationCurveNodes)if(t.animationCurveNodes.hasOwnProperty(r)){var a=t.animationCurveNodes[r];a.data=n}for(var s=0;s<t.numChildren;++s)this._convertSkeletonNode(t.getChild(s),n)},_assignJointBinding:function(t,e){if(t.indices)for(var i=t.indices.length,n=0;n<i;++n)if(t.weights[n]>0){var r=t.indices[n],a=this._skinningData[r]=this._skinningData[r]||[],s=new k._JointBinding;s.jointIndex=e,s.jointWeight=t.weights[n],a.push(s)}},_assignInverseBindPose:function(t,e,i){i.inverseBindPose.copyFrom(t.transformLink),i.inverseBindPose.invertAffine(),i.inverseBindPose.prependAffine(t.transform),i.inverseBindPose.prependAffine(e)},_getLimbGlobalMatrix:function(t){if(!t._globalMatrix)if(t._globalMatrix=new HX.Matrix4x4,t.parent&&"LimbNode"===t.parent.type){var e=this._getLimbGlobalMatrix(t.parent);t._globalMatrix.multiply(e,t.matrix)}else t._globalMatrix.copyFrom(t.matrix);return t._globalMatrix},_getRootNodeForCluster:function(t){for(var e=t.limbNode;e;){if("LimbNode"!==e.type)return e;e=e.parent}throw new Error("No Root node found!")},_convertLayer:function(t){var e=this._convertToFrames(t);return this._convertToClip(e)},_convertToFrames:function(t){for(var e=[],i=t.curveNodes.length,n=0;n<i;++n){var r=t.curveNodes[n];for(var a in r.curves)if(r.curves.hasOwnProperty(a)){var s=r.curves[a];e.push({frames:this._addCurveToKeyFrame(s),node:r})}}return e},_addCurveToKeyFrame:function(t){for(var e=t.KeyTime.length,i=[],n=0;n<e;++n){var r=t.KeyTime[n].milliseconds,a=t.KeyValueFloat[n],s=new HX.KeyFrame(r,a);i.push(s)}return i},_completeKeyFrames:function(t){for(var e=[],i=t.length,n=0;n<i;++n)e[n]=0;for(var r=!1;!r;){var a=Number.POSITIVE_INFINITY,s=n;for(n=0;n<i;++n){var o=t[n].frames;o[e[n]].time<a&&(a=o[e[n]].time,s=n)}for(n=0;n<i;++n){o=t[n].frames;var h=e[n];if(o[h].time!==a){var l=Math.max(e[n]-1,0),c=HX.MathX.linearStep(o[l].time,o[h].time,a),u=HX.MathX.lerp(o[l].value,o[h].value,c),p=new HX.KeyFrame(a,u);o.splice(h,0,p)}}for(r=!0,n=0;n<i;++n)o=t[n].frames,o[e[n]].time<=a&&++e[n],e[n]<o.length&&(r=!1)}},_createTempJointPoses:function(){for(var t=[],e=this._skeleton.numJoints,i=0;i<e;++i){var n=this._skeleton.getJoint(i),r=n.inverseBindPose.clone();if(r.invertAffine(),n.parentIndex!==-1){var a=this._skeleton.getJoint(n.parentIndex).inverseBindPose;r.appendAffine(a)}var s=new E._JointPose,o=new HX.Transform;r.decompose(o),s["Lcl Translation"].copyFrom(o.position),o.rotation.toEuler(s["Lcl Rotation"]),s["Lcl Rotation"].x*=HX.MathX.RAD_TO_DEG,s["Lcl Rotation"].y*=HX.MathX.RAD_TO_DEG,s["Lcl Rotation"].z*=HX.MathX.RAD_TO_DEG,s["Lcl Scaling"].copyFrom(o.scale),t[i]=s}return t},_applyCurvesForFrame:function(t,e,i){for(var n=e.length,r=0;r<n;++r){var a=e[r],s=a.frames,o=a.node,h=o.data;if(null!==h){var l=t[h][o.propertyName];for(var c in o.curves)if(o.curves.hasOwnProperty(c)){var u=s[i].value;switch(c){case"d|X":l.x=u;break;case"d|Y":l.y=u;break;case"d|Z":l.z=u;break;default:throw new Error("Unknown target "+c)}}}}},_convertSkeletonPose:function(t){for(var e=new HX.SkeletonPose,i=this._skeleton.numJoints,n=0;n<i;++n){var r=new HX.SkeletonJointPose,a=t[n];r.position.copyFrom(a["Lcl Translation"]),r.scale.copyFrom(a["Lcl Scaling"]);var s=a["Lcl Rotation"];r.rotation.fromEuler(s.x*HX.MathX.DEG_TO_RAD,s.y*HX.MathX.DEG_TO_RAD,s.z*HX.MathX.DEG_TO_RAD),e.setJointPose(n,r)}return e},_convertToClip:function(t){for(var e=new HX.AnimationClip,i=t[0].frames.length,n=0;n<i;++n){var r=t[0].frames[n].time,a=this._createTempJointPoses();this._applyCurvesForFrame(a,t,n);var s=this._convertSkeletonPose(a);s.setJointPose(this._fakeJointIndex,new HX.SkeletonJointPose),e.addKeyFrame(new HX.KeyFrame(r,s))}return e}},E._JointPose=function(){this["Lcl Translation"]=new HX.Float4(0,0,0),this["Lcl Rotation"]=new HX.Float4(0,0,0),this["Lcl Scaling"]=new HX.Float4(1,1,1)},k.prototype={createModelInstance:function(t){for(var e=[],i=this._modelMaterialIDs.length,n=0;n<i;++n)e[n]=t[this._modelMaterialIDs[n]];var r=new HX.ModelInstance(this._model,e),a=this._animationConverter.animationClips;if(a){var s=new HX.SkeletonXFadeNode;for(n=0;n<a.length;++n)s.addClip(a[n]);r.addComponent(new HX.SkeletonAnimation(s)),s.fadeTo(a[0],0,!1)}return r},convertToModel:function(t,e,i,n){this._perMaterialData=[],this._ctrlPointLookUp=[],this._modelMaterialIDs=[],this._useSkinning=!1,this._model=new HX.Model,this._animationConverter=new E,t.deformers&&this._generateSkinningData(t,i),this._generateExpandedMeshData(t,i),this._vertexStride=HX.Mesh.DEFAULT_VERTEX_SIZE,this._expandedMesh.hasColor&&(this._vertexStride+=3),this._splitPerMaterial(),this._generateModel(),t.deformers&&this._animationConverter.convertClips(e,t,i,n),this._model.name=t.name},_generateExpandedMeshData:function(t,e){this._expandedMesh=new k._ExpandedMesh;var i,n,r,a,s=t.indices,o=t.vertices,h=t.layerElements;h&&(i=h.Normals,n=h.Colors,r=h.UV,a=h.Materials);var l=[],c=0,u=0;i&&(this._expandedMesh.hasNormals=!0),n&&(this._expandedMesh.hasColor=!0),r&&(this._expandedMesh.hasUVs=!0);for(var p=s.length,_=0;_<p;++_){var f=s[_],d=new k._Vertex;if(f<0&&(f=-f-1,d.lastVertex=!0),d.pos.x=o[3*f],d.pos.y=o[3*f+1],d.pos.z=o[3*f+2],e&&e.transformPoint(d.pos,d.pos),this._model.skeleton&&(d.jointBindings=this._animationConverter.getJointBinding(f)),d.ctrlPointIndex=f,i&&(d.normal=this._extractLayerData(i,f,_,3),e&&e.transformVector(d.normal,d.normal)),n&&(d.color=this._extractLayerData(n,f,_,3)),r&&(d.uv=this._extractLayerData(r,f,_,2)),a&&a.mappingInformationType!==O.MAPPING_TYPE.ALL_SAME){var m=a.indexData[c];d.materialIndex=m,m>u&&(u=m)}d.lastVertex&&++c,l[_]=d}this._expandedMesh.vertices=l,this._expandedMesh.numMaterials=u+1},_extractLayerData:function(t,e,i,n){var r=n>2?new HX.Float4:new HX.Float2;if(t.referenceInformationType===O.REFERENCE_TYPE.DIRECT){var a=t.mappingInformationType===O.MAPPING_TYPE.BY_CONTROL_POINT?e:i;r.x=t.directData[a*n],r.y=t.directData[a*n+1],n>2&&(r.z=t.directData[a*n+2])}else{var a=t.mappingInformationType===O.MAPPING_TYPE.BY_CONTROL_POINT?t.indexData[e]:t.indexData[i];r.x=t.directData[a*n],r.y=t.directData[a*n+1],n>2&&(r.z=t.directData[a*n+2])}return r},_splitPerMaterial:function(){for(var t=0;t<this._expandedMesh.numMaterials;++t)this._perMaterialData[t]=new k._PerMaterialData;for(var e,i,n,t=0,r=0,a=this._expandedMesh.vertices,s=a.length,o=!0;t<s;){var h=this._perMaterialData[a[t].materialIndex];if(h.vertices||(o=!0),o&&(o=!1,h.indexCounter=0,h.indices=[],h.vertices=[],h.ctrlPointIndices=[],h.indexLookUp={},h.indexStack.push(h.indices),h.vertexStack.push(h.vertices),h.ctrlPointStack.push(h.ctrlPointIndices),this._useSkinning&&(h.skinning=[],h.skinningStack.push(h.skinning))),e=this._getOrAddIndex(a[t]),e<0)o=!0;else if(i=this._getOrAddIndex(a[t+1]),i<0)o=!0;else{t+=2;var l;do if(l=a[t],n=this._getOrAddIndex(l),n<0)o=!0;else{++t;var c=this._perMaterialData[l.materialIndex].indices;c[r]=e,c[r+1]=i,c[r+2]=n,r+=3,i=n}while(!l.lastVertex&&!o)}}},_getOrAddIndex:function(t){var e=t.getHash(),i=this._perMaterialData[t.materialIndex],n=i.indexLookUp;if(n.hasOwnProperty(e))return n[e];if(i.indexCounter>65535)return-1;var r=i.skinning,a=i.vertices,s=i.indexCounter++,o=s*this._vertexStride,h=8*s;if(i.ctrlPointIndices[t.ctrlPointIndex]=s,n[e]=s,a[o]=t.pos.x,a[o+1]=t.pos.y,a[o+2]=t.pos.z,r){var l=t.jointBindings,c=l?l.length:0;c>4&&(c=4,console.warn("Warning: more than 4 joints not supported. Model will not animate correctly"),l.sort(function(t,e){return e.jointWeight-t.jointWeight}));for(var u=0,p=0;p<c;++p){var _=l[p].jointWeight;r[h+p]=l[p].jointIndex,r[h+p+4]=_,u+=_}u=u>=1?0:1-u;for(var p=c;p<4;++p)r[h+p]=this._fakeJointIndex,r[h+p+4]=p===c?u:0}return this._expandedMesh.hasNormals?(a[o+3]=t.normal.x,a[o+4]=t.normal.y,a[o+5]=t.normal.z):a[o+3]=a[o+4]=a[o+5]=0,a[o+6]=a[o+7]=a[o+8]=a[o+9]=0,this._expandedMesh.hasUVs?(a[o+10]=t.uv.x,a[o+11]=t.uv.y):a[o+10]=a[o+11]=0,this._expandedMesh.hasColor&&(a[o+12]=t.color.x,a[o+13]=t.color.y,a[o+14]=t.color.z),s},_generateModel:function(){for(var t=0,e=this._expandedMesh.numMaterials,i=0;i<e;++i)for(var n=this._perMaterialData[i],r=n.indexStack.length,a=0;a<r;++a){var s=HX.Mesh.createDefaultEmpty();this._expandedMesh.hasColor&&s.addVertexAttribute("hx_vertexColor",3),s.setVertexData(n.vertexStack[a],0),s.setIndexData(n.indexStack[a]),this._useSkinning&&(s.addVertexAttribute("hx_jointIndices",4,1),s.addVertexAttribute("hx_jointWeights",4,1),s.setVertexData(n.skinningStack[a],1));for(var o=n.ctrlPointStack[a],h=o.length,l=0;l<h;++l)this._ctrlPointLookUp[o[l]]={index:l,meshIndex:t};++t,this._modelMaterialIDs.push(i);var c=HX.NormalTangentGenerator.MODE_TANGENTS;this._expandedMesh.hasNormals||(c|=HX.NormalTangentGenerator.MODE_NORMALS);var u=new HX.NormalTangentGenerator;u.generate(s,c),this._model.addMesh(s)}},_generateSkinningData:function(t,e){var i=t.deformers.length;if(0!==i){if(i>1)throw new Error("Multiple skins not supported");this._animationConverter.convertSkin(t.deformers[0],e),this._model.skeleton=this._animationConverter.skeleton,this._useSkinning=!0}}},k._ExpandedMesh=function(){this.vertices=null,this.hasColor=!1,this.hasUVs=!1,this.hasNormals=!1,this.numMaterials=0},k._JointBinding=function(){this.jointIndex=0,this.jointWeight=0},k._Vertex=function(){this.pos=new HX.Float4,this.uv=null,this.normal=null,this.color=null,this.materialIndex=0,this.ctrlPointIndex=-1,this.jointBindings=null,this._hash=null,this.lastVertex=!1},k._Vertex.prototype={getHash:function(){if(!this._hash){var t=this.ctrlPointIndex+"/"+this.materialIndex+"/"+this.pos.x+"/"+this.pos.y+"/"+this.pos.z;this.normal&&(t+="/"+this.normal.x+"/"+this.normal.y+"/"+this.normal.z),this.uv&&(t+="/"+this.uv.x+"/"+this.uv.y),this.color&&(t+="/"+this.color.x+"/"+this.color.y+"/"+this.color.z),this._hash=t}return this._hash}},k._PerMaterialData=function(){this.indexCounter=0,this.vertexStack=[],this.skinningStack=[],this.indexStack=[],this.ctrlPointStack=[],this.vertices=null,this.indices=null,this.skinning=null,this.ctrlPointIndices=null,this.indexLookUp={}},P.prototype={get textureTokens(){return this._textureTokens},get textureMaterialMap(){return this._textureMaterialMap},convert:function(t,e,i,n){this._settings=n,this._objects=[],this._textureTokens=[],this._textureMaterialMap=[],this._rootNode=t,this._animationStack=e,this._convertSceneNode(t,i)},_convertNode:function(t){var e;if(t.mesh)e=this._convertModelMesh(t);else{if(!(t.children&&t.children.length>1))return null;e=new HX.SceneNode,this._convertSceneNode(t,e)}return e.name=t.name,this._convertSceneGraphObject(t,e),e},_convertSceneNode:function(t,e){for(var i=t.children.length,n=0;n<i;++n){var r=this._convertNode(t.children[n]);r&&e.attach(r)}},_convertModelMesh:function(t){var e=this._convertGeometry(t.mesh,t.geometryTransform),i=[];if(t.materials)for(var n=t.materials.length,r=0;r<n;++r)i[r]=this._convertMaterial(t.materials[r]);else i.push(new HX.BasicMaterial);return e.createModelInstance(i)},_convertSceneGraphObject:function(t,e){e.matrix=t.matrix},_convertGeometry:function(t,e){if(this._objects[t.UID])return this._objects[t.UID];var i=new k;return i.convertToModel(t,this._animationStack,e,this._settings),this._objects[t.UID]=i,i},_convertMaterial:function(t){if(this._objects[t.UID])return this._objects[t.UID];var e=new HX.BasicMaterial;return e.name=t.name,t.DiffuseColor&&(e.color=t.DiffuseColor),t.Shininess&&(t.ShininessExponent=t.Shininess),t.ShininessExponent&&(e.roughness=HX.BasicMaterial.roughnessFromShininess(t.Shininess)),t.textures&&(t.textures.NormalMap&&this._convertTexture(t.textures.NormalMap,e,P._TextureToken.NORMAL_MAP),t.textures.SpecularColor&&this._convertTexture(t.textures.SpecularColor,e,P._TextureToken.SPECULAR_MAP),t.textures.DiffuseColor&&this._convertTexture(t.textures.DiffuseColor,e,P._TextureToken.DIFFUSE_MAP)),this._objects[t.UID]=e,e},_convertTexture:function(t,e,i){var n;this._objects[t.UID]?n=this._objects[t.UID]:(n=new P._TextureToken,n.name=t.name,n.mapType=i,n.filename=t.relativeFilename?t.relativeFilename:t.video.relativeFilename,this._textureTokens.push(n),this._objects[t.UID]=n);var r=new P._TextureMaterialMapping(e,n,i);this._textureMaterialMap.push(r)}},P._TextureMaterialMapping=function(t,e,i){this.material=t,this.token=e,this.mapType=i},P._TextureToken=function(){this.filename=null,this.name=null,this.UID=null},P._TextureToken.NORMAL_MAP=0,P._TextureToken.SPECULAR_MAP=1,P._TextureToken.DIFFUSE_MAP=2,L.prototype={get orientationMatrix(){return this._matrix},get frameRate(){return this._frameRate},init:function(t){for(var e=1,i=1,n=2,r=1,a=t.getChildByName("GlobalSettings"),s=a.getChildByName("Properties70"),o=s.children.length,h=[0,120,100,60,50,48,30],l=0;l<o;++l){var c=s.children[l];switch(c.data[0]){case"UpAxis":e=c.data[4];break;case"UpAxisSign":i=c.data[4];break;case"FrontAxis":n=c.data[4];break;case"FrontAxisSign":r=c.data[4];break;case"TimeMode":h[c.data[4]]&&(this._frameRate=h[c.data[4]])}}var u=[HX.Float4.X_AXIS,HX.Float4.Y_AXIS,HX.Float4.Z_AXIS],p=u[n].clone(),_=u[e].clone();p.scale(r),_.scale(i),this._matrix.lookAt(p,HX.Float4.ORIGIN_POINT,_),this._matrix.invert()}},C.prototype=Object.create(e.Importer.prototype),C.prototype.parse=function(t,i){var n=new e.DataStream(t),r=new p,a=new D,s=new P,o=new L;try{var h,l=Date.now(),c=r.deserialize(n);if(h=Date.now(),console.log("Serialization: "+(h-l)),l=h,o.init(c),r.version<7e3)throw new Error("Unsupported FBX version!");a.build(c,o),h=Date.now(),console.log("Graph building: "+(h-l)),l=h,s.convert(a.sceneRoot,a.animationStack,i,o),h=Date.now(),console.log("Conversion: "+(h-l))}catch(u){return console.log(u.stack),void this._notifyFailure(u.message)}s.textureTokens.length>0?this._loadTextures(s.textureTokens,s.textureMaterialMap,i):this._notifyComplete(i)},C.prototype._loadTextures=function(t,i,n){var r=t.length;this._textureLibrary=new e.AssetLibrary(null,this.options.crossOrigin),this._textureLibrary.fileMap=this.fileMap;for(var a=0;a<r;++a){var s=t[a];s.filename=this._correctURL(s.filename),this._textureLibrary.queueAsset(s.filename,s.filename,e.AssetLibrary.Type.ASSET,e.JPG)}this._textureLibrary.onComplete.bind(function(){for(var t=i.length,e=0;e<t;++e){var r=i[e],a=r.token,s=this._textureLibrary.get(a.filename);switch(s.name=a.name,r.mapType){case P._TextureToken.NORMAL_MAP:r.material.normalMap=s;break;case P._TextureToken.SPECULAR_MAP:r.material.specularMap=s;break;case P._TextureToken.DIFFUSE_MAP:r.material.colorMap=s}}this._notifyComplete(n)},this),this._textureLibrary.load()},U.LITTLE_ENDIAN=!0,U.BIG_ENDIAN=!1,U.prototype={get offset(){return this._offset},set offset(t){this._offset=t},get endian(){return this._endian},set endian(t){this._endian=t},get byteLength(){return this._dataView.byteLength},get bytesAvailable(){return this._dataView.byteLength-this._offset},writeChar:function(t){return this.writeUint8(t.charCodeAt(0))},writeUint8:function(t){return this._dataView.setUint8(this._offset++,t)},writeUint16:function(t){var e=this._dataView.setUint16(this._offset,t,this._endian);return this._offset+=2,e},writeUint32:function(t){var e=this._dataView.setUint32(this._offset,t,this._endian);return this._offset+=4,e},writeInt8:function(t){return this._dataView.setInt8(this._offset++,t)},writeInt16:function(t){var e=this._dataView.setInt16(this._offset,t,this._endian);return this._offset+=2,e},writeInt32:function(t){var e=this._dataView.setInt32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat32:function(t){var e=this._dataView.setFloat32(this._offset,t,this._endian);return this._offset+=4,e},writeFloat64:function(t){var e=this._dataView.setFloat64(this._offset,t,this._endian);return this._offset+=8,e},writeString:function(t){for(var e=t.length,i=0;i<e;++i)this.writeUint8(t.charCodeAt(i))},writeUint8Array:function(t){this._writeArray(t,this.writeUint8)},writeUint16Array:function(t){this._writeArray(t,this.writeUint16)},writeUint32Array:function(t){this._writeArray(t,this.writeUint32)},writeInt8Array:function(t){this._writeArray(t,this.writeInt8)},writeInt16Array:function(t){this._writeArray(t,this.writeInt16)},writeInt32Array:function(t){this._writeArray(t,this.writeInt32)},writeFloat32Array:function(t){this._writeArray(t,this.writeFloat32)},writeFloat64Array:function(t){this._writeArray(t,this.writeFloat64)},_writeArray:function(t,e){for(var i=t.length,n=0;n<i;++n)e.call(this,t[n])}},R.VERSION="0.1.0",R.VALUE_TYPE_SKELETON_POSE=1,R.VALUE_TYPE_NUMBER=2,R.VALUE_TYPE_FLOAT3=3,R.VALUE_TYPE_QUATERNION=4,R.prototype={"export":function(t){var e=this._getValueType(t),i=this._calculateFileSize(t,e),n=new ArrayBuffer(i),r=new DataView(n),a=new U(r),s=R.VERSION.split(".");a.writeString("HX_CLIP"),a.writeUint16Array(s),a.writeUint8(e);var o=t.numKeyFrames;if(a.writeUint32(o),e===R.VALUE_TYPE_SKELETON_POSE){var h=t.getKeyFrame(0),l=h.value;a.writeUint8(l.numJoints)}else a.writeUint8(0);for(var c=0;c<o;++c){var h=t.getKeyFrame(c);a.writeUint32(h.time),this._writeValue(a,e,h.value)}return n},_getValueType:function(t){var e=t.getKeyFrame(0),i=e.value;if(i instanceof HX.SkeletonPose)return R.VALUE_TYPE_SKELETON_POSE;if(i instanceof HX.Float4)return R.VALUE_TYPE_FLOAT3;if(i instanceof HX.Quaternion)return R.VALUE_TYPE_QUATERNION;if("number"==typeof i)return R.VALUE_TYPE_NUMBER;throw new Error("Unsupported animation clip")},_writeValue:function(t,e,i){if(e===R.VALUE_TYPE_SKELETON_POSE)for(var n=i.numJoints,r=0;r<n;++r){var a=i.getJointPose(r);t.writeFloat32(a.position.x),t.writeFloat32(a.position.y),t.writeFloat32(a.position.z),t.writeFloat32(a.rotation.x),t.writeFloat32(a.rotation.y),t.writeFloat32(a.rotation.z),t.writeFloat32(a.rotation.w),t.writeFloat32(a.scale.x),t.writeFloat32(a.scale.y),t.writeFloat32(a.scale.z)}else e===R.VALUE_TYPE_FLOAT3?(t.writeFloat32(i.x),t.writeFloat32(i.y),t.writeFloat32(i.z)):e===R.VALUE_TYPE_QUATERNION?(t.writeFloat32(i.x),t.writeFloat32(i.y),t.writeFloat32(i.z),t.writeFloat32(i.w)):e===R.VALUE_TYPE_NUMBER&&t.writeFloat32(i)},_calculateFileSize:function(t,e){var i=7;i+=6,i+=1,i+=4,i+=1;var n=this._calculateKeyFrameSize(e,t);return i+=t.numKeyFrames*n},_calculateKeyFrameSize:function(t,e){var i=4;if(t===R.VALUE_TYPE_SKELETON_POSE){var n=e.getKeyFrame(0).value.numJoints;i+=10*n*4}else t===R.VALUE_TYPE_FLOAT3?i+=12:t===R.VALUE_TYPE_QUATERNION?i+=16:t===R.VALUE_TYPE_NUMBER&&(i+=4);return i}},j.VERSION="0.1.0",j.prototype={"export":function(t){var e=this._calculateFileSize(t),i=new ArrayBuffer(e),n=new DataView(i),r=new U(n),a=j.VERSION.split(".");r.writeString("HX_MODEL"),r.writeUint16Array(a);var s=t.numMeshes;r.writeUint16(s);for(var o=0;o<s;++o)this._writeMeshData(r,t.getMesh(o));return this._writeSkeleton(r,t.skeleton),
i},_writeMeshData:function(t,e){t.writeUint32(e.numIndices),e._indexType===HX.DataType.UNSIGNED_INT?(t.writeUint8(32),t.writeUint32Array(e.getIndexData())):(t.writeUint8(16),t.writeUint16Array(e.getIndexData())),t.writeUint32(e.numVertices),t.writeUint8(e.numVertexAttributes);for(var i=0;i<e.numVertexAttributes;++i){var n=e.getVertexAttributeByIndex(i);t.writeUint8(n.name.length),t.writeString(n.name),t.writeUint8(n.streamIndex),t.writeUint8(n.numComponents)}for(t.writeUint8(e.numStreams),i=0;i<e.numStreams;++i){var r=e.getVertexData(i);t.writeUint32(r.length),t.writeFloat32Array(r)}},_writeSkeleton:function(t,e){var i=e?e.numJoints:0;t.writeUint8(i);for(var n=0;n<i;++n){var r=e.getJoint(n);r.name?(t.writeUint8(r.name.length),t.writeString(r.name)):t.writeUint8(0),t.writeUint8(r.parentIndex===-1?255:r.parentIndex),t.writeFloat32Array(r.inverseBindPose._m)}},_calculateFileSize:function(t){var e=8;e+=6,e+=2;for(var i=t.numMeshes,n=0;n<i;++n){var r=t.getMesh(n);e+=4,e+=1;var a;a=r._indexType===HX.DataType.UNSIGNED_INT?4:2,e+=a*r.numIndices,e+=4,e+=1;for(var s=0;s<r.numVertexAttributes;++s){var o=r.getVertexAttributeByIndex(s);e+=1,e+=o.name.length,e+=1,e+=1}for(e+=1,s=0;s<r.numStreams;++s)e+=4,e+=4*r.getVertexData(s).length}e+=1;var h=t.skeleton?t.skeleton.numJoints:0;for(n=0;n<h;++n){var l=t.skeleton.getJoint(n);e+=1,e+=l.name?l.name.length:0,e+=1,e+=64}return e}},t.GLTF=r,t.GLTFData=n,t.MD5Mesh=a,t.MD5Anim=s,t.OBJ=c,t.MTL=l,t.FBX=C,t.AnimationClipExporter=R,t.ModelExporter=j,Object.defineProperty(t,"__esModule",{value:!0})});