!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("helix"),require("pako")):"function"==typeof define&&define.amd?define("HX",["exports","helix","pako"],e):e(t.HX=t.HX||{},t.HX,t.pako)}(this,function(t,e,n){"use strict";function a(){this.defaultScene=new e.Scene,this.scenes={},this.materials={},this.models={},this.modelInstances={},this.animations={}}function i(){e.Importer.call(this,a),this._numComponentLookUp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT4:16},this._invertZ=new e.Matrix4x4,this._flipZ=1}function r(){e.Importer.call(this,e.Model),this._target=null,this._meshData=null,this._jointData=null,this._skeleton=null,this._correctionQuad=new e.Quaternion,this._correctionQuad.fromAxisAngle(e.Float4.X_AXIS,.5*-Math.PI)}function s(){e.Importer.call(this,e.AnimationClip),this._hierarchy=null,this._baseFrame=null,this._activeFrame=null,this._numJoints=0,this._frameRate=0,this._correctionQuad=new e.Quaternion,this._correctionQuad.fromAxisAngle(e.Float4.X_AXIS,.5*-Math.PI)}function o(){e.Importer.call(this,e.SceneNode),this._objects=[],this._vertices=[],this._normals=[],this._uvs=[],this._hasNormals=!1,this._defaultMaterial=new e.BasicMaterial,this._target=null,this._mtlLibFile=null}function h(){e.Importer.call(this,Object,e.URLLoader.DATA_TEXT),this._textures=[],this._texturesToLoad=[],this._activeMaterial=null}function l(){this.name="",this.data=[],this.children=[]}function c(){this._version=0}function p(){this.name=null,this.UID=null,this.parent=null,this.data=null}function u(){p.call(this),this.type=null}function _(){p.call(this),this.limbNode=null,this.transform=null,this.transformLink=null,this.indices=null,this.weights=null}function d(){p.call(this),this.clusters=null}function m(){p.call(this),this.Color=null,this["Casts Shadows"]=!0,this.vertices=null,this.layerElements=null,this.deformers=null}function f(){p.call(this),this.relativeFilename=null}function v(){p.call(this),this.WrapModeU=0,this.WrapModeV=0,this.relativeFilename=null,this.video=null}function g(){p.call(this),this.EmissiveColor=null,this.EmissiveFactor=1,this.DiffuseColor=null,this.DiffuseFactor=1,this.ShininessExponent=void 0,this.Shininess=void 0,this.textures=null}function y(){p.call(this)}function x(){p.call(this),this.Default=void 0,this.KeyVer=0,this.KeyTime=0,this.KeyValueFloat=null,this.KeyAttrFlags=0,this.KeyAttrDataFloat=null,this.KeyAttrRefCount=0}function b(){p.call(this),this.curves=null,this["d|X"]=0,this["d|Y"]=0,this["d|Z"]=0,this.propertyName=null}function w(){p.call(this),this.RotationOffset=null,this.RotationPivot=null,this.ScalingOffset=null,this.ScalingPivot=null,this.RotationOrder=0,this.PreRotation=null,this.PostRotation=null,this.InheritType=0,this.GeometricTranslation=null,this.GeometricRotation=null,this.GeometricScaling=null,this["Lcl Translation"]=null,this["Lcl Rotation"]=null,this["Lcl Scaling"]=null,this.Visibility=!0,this.type=null,this.children=null,this.skeleton=null,this.defaultAttribute=null,this.attributes=null,this.mesh=null,this.materials=null,this.animationCurveNodes=null,this._geometricMatrix=null,this._matrix=null}function T(){p.call(this),this.curveNodes=null}function M(t){this._value=t}function I(){p.call(this),this.LocalStart=new M,this.LocalStop=new M,this.ReferenceStart=new M,this.ReferenceStop=new M,this.layers=null}function O(){p.call(this),this.type=null,this.poseNodes=[]}function D(){this.targetUID=null,this.matrix=null}function A(){p.call(this),this.directData=null,this.indexData=null,this.type=null,this.mappingInformationType=0,this.referenceInformationType=0}function F(){this._settings=null,this._templates=null,this._objects=null,this._rootNode=null,this._animationStack=null,this._bindPoses=null}function S(){this._skinningData=null,this._jointUIDLookUp=null,this._skeleton=null,this._fakeJointIndex=-1,this._animationClips=null,this._frameRate=24}function k(){this._perMaterialData=null,this._expandedMesh=null,this._vertexStride=0,this._ctrlPointLookUp=null,this._model=null,this._animationConverter=null,this._fakeJointIndex=-1,this._useSkinning=!1}function P(){this._settings=null,this._objects=null,this._textureTokens=null,this._textureMaterialMap=null,this._rootNode=null}function N(){this._matrix=new HX.Matrix4x4,this._frameRate=24}function L(){e.Importer.call(this,e.SceneNode,e.Importer.TYPE_BINARY),this._rootNode=null}i.prototype=Object.create(e.Importer.prototype),i.prototype.parse=function(t,n){var a=JSON.parse(t),i=a.asset;if(this._target=n,i.hasOwnProperty("minVersion")){i.minVersion.split(".")}if(i.hasOwnProperty("version")){var r=i.version.split(".");if("2"!==r[0])throw new Error("Unsupported glTF version!")}this._assetLibrary=new e.AssetLibrary,this._binFileCheck={},a.hasOwnProperty("images")&&this._parseImages(a.images),a.hasOwnProperty("buffers")&&this._parseBuffers(a.buffers),this._assetLibrary.onComplete.bind(function(){this._continueParsing(a)},this),this._assetLibrary.onProgress.bind(function(t){this._notifyProgress(t)},this),this._assetLibrary.load()},i.prototype._continueParsing=function(t){t.hasOwnProperty("materials")&&this._parseMaterials(t),t.hasOwnProperty("meshes")&&this._parseMeshes(t),t.hasOwnProperty("nodes")&&this._parseNodes(t);var e;t.hasOwnProperty("scene")&&(e=t.scene),t.hasOwnProperty("scenes")&&this._parseScenes(t,e),t.hasOwnProperty("animations")&&this._parseAnimations(t),this._notifyComplete()},i.prototype._getAccessor=function(t,e){var n=e.accessors[t],a=this._getBufferView(e,n.bufferView),i={dataType:n.componentType,numComponents:this._numComponentLookUp[n.type],type:n.type,data:a.data,min:n.min,max:n.max,byteOffset:a.byteOffset+(n.byteOffset||0),dataType:n.componentType,count:n.count};return i},i.prototype._getBufferView=function(t,e){var n=t.bufferViews[e],a=this._buffers[n.buffer],i=a.byteOffset+(n.byteOffset||0);return{data:this._assetLibrary.get(a.assetID),byteOffset:i,byteLength:n.byteLength}},i.prototype._parseImages=function(t){for(var n=0;n<t.length;++n){var a=t[n];this._assetLibrary.queueAsset("hx_image_"+n,this._correctURL(a.uri),e.AssetLibrary.Type.ASSET,e.JPG)}},i.prototype._parseBuffers=function(t){this._buffers=[];for(var n=0;n<t.length;++n){var a=t[n];if(!this._binFileCheck[a.uri]){var i="hx_bin_"+n;this._assetLibrary.queueAsset(i,this._correctURL(a.uri),e.AssetLibrary.Type.RAW_BINARY),this._binFileCheck[a.uri]=!0,this._buffers[n]={assetID:i,byteOffset:a.byteOffset||0,byteLength:a.byteLength}}}},i.prototype._parseMaterials=function(t){this._materials=[];for(var n=0;n<t.materials.length;++n){var a=t.materials[n],i=new e.BasicMaterial;if(i.name=a.name,i.specularMapMode=e.BasicMaterial.SPECULAR_MAP_METALLIC_ROUGHNESS,i.roughnessRange=-.5,a.hasOwnProperty("pbrMetallicRoughness")){var r=a.pbrMetallicRoughness;if(r.hasOwnProperty("baseColorTexture")&&(i.colorMap=this._assetLibrary.get("hx_image_"+r.baseColorTexture.index)),r.hasOwnProperty("metallicRoughnessTexture")&&(i.specularMap=this._assetLibrary.get("hx_image_"+r.metallicRoughnessTexture.index)),a.hasOwnProperty("normalTexture")&&(i.normalMap=this._assetLibrary.get("hx_image_"+a.normalTexture.index)),a.hasOwnProperty("emissiveTexture")&&(i.emissionMap=this._assetLibrary.get("hx_image_"+a.emissiveTexture.index),i.emissiveColor=e.Color.WHITE),a.hasOwnProperty("occlusionTexture")&&(i.occlusionMap=this._assetLibrary.get("hx_image_"+a.occlusionTexture.index)),r.hasOwnProperty("baseColorFactor")){var s=new e.Color(r.baseColorFactor[0],r.baseColorFactor[1],r.baseColorFactor[2],r.baseColorFactor[3]);i.color=s.linearToGamma()}if(r.hasOwnProperty("metallicFactor")?i.metallicness=r.metallicFactor:i.metallicness=1,r.hasOwnProperty("roughnessFactor")?i.roughnessRange=i.roughness=.5*r.roughnessFactor:i.roughness=.5,a.hasOwnProperty("emissiveFactor")){var o=new e.Color(a.emissiveFactor[0],a.emissiveFactor[1],a.emissiveFactor[2],1);i.emissiveColor=o.linearToGamma()}}this._materials[n]=i,this._target.materials[i.name]=i}},i.prototype._parseMeshes=function(t){this._modelInstances=[];for(var n=0;n<t.meshes.length;++n){for(var a=t.meshes[n],i=new e.Model,r=[],s=0;s<a.primitives.length;++s)this._parsePrimitive(a.primitives[s],t,i,r);i.name=a.name;var o=new e.ModelInstance(i,r);this._modelInstances[n]=o,this._target.models[i.name]=i}},i.prototype._readVertexDataVec4=function(t,n,a,i,r){var s,o,h=n,l=a.byteOffset,c=a.count,p=a.data;a.dataType===e.DataType.FLOAT?(s=p.getFloat32,o=4):a.dataType===e.DataType.UNSIGNED_SHORT?(s=p.getUint16,o=2):a.dataType===e.DataType.UNSIGNED_INT&&(s=p.getUint32,o=4);for(var u=0;u<c;++u)t[h]=s.call(p,l,!0),t[h+1]=s.call(p,l+o,!0),t[h+3]=r*s.call(p,l+2*o,!0),t[h+4]=s.call(p,l+3*o,!0),l+=4*o,h+=i},i.prototype._readVertexDataVec3=function(t,e,n,a){for(var i=e,r=n.byteOffset,s=n.count,o=n.data,h=0;h<s;++h)t[i]=o.getFloat32(r,!0),t[i+1]=o.getFloat32(r+4,!0),t[i+2]=-o.getFloat32(r+8,!0),r+=12,i+=a},i.prototype._readUVData=function(t,e,n,a){for(var i=e,r=n.byteOffset,s=n.count,o=n.data,h=0;h<s;++h)t[i]=o.getFloat32(r,!0),t[i+1]=1-o.getFloat32(r+4,!0),r+=8,i+=a},i.prototype._readIndices=function(t){var n,a,i,r=t.byteOffset,s=t.data,o=t.count;t.dataType===e.DataType.UNSIGNED_SHORT?(a=Uint16Array,n=s.getUint16,i=2):t.dataType===e.DataType.UNSIGNED_INT&&(a=Uint32Array,n=s.getUint32,i=4);for(var h=new a(o),l=0;l<o;++l)h[l]=n.call(s,r,!0),r+=i;return h},i.prototype._parsePrimitive=function(t,n,a,i){var r=e.Mesh.createDefaultEmpty(),s=t.attributes,o=this._getAccessor(s.POSITION,n),h=void 0!==s.NORMAL?this._getAccessor(s.NORMAL,n):null,l=void 0!==s.TANGENT?this._getAccessor(s.TANGENT,n):null,c=void 0!==s.TEXCOORD_0?this._getAccessor(s.TEXCOORD_0,n):null,p=void 0!==s.JOINTS_0?this._getAccessor(s.JOINTS_0,n):null,u=void 0!==s.WEIGHTS_0?this._getAccessor(s.WEIGHTS_0,n):null,_=0,d=r.getVertexStride(0),m=new Float32Array(o.count*d);this._readVertexDataVec3(m,0,o,d),h?this._readVertexDataVec3(m,3,h,d):_=e.NormalTangentGenerator.MODE_NORMALS,l?this._readVertexDataVec4(m,6,l,d,this._flipZ):c&&(_|=e.NormalTangentGenerator.MODE_TANGENTS),c&&this._readUVData(m,10,c,d),r.setVertexData(m,0);var f=this._getAccessor(t.indices,n);if(r.setIndexData(this._readIndices(f)),_){var v=new e.NormalTangentGenerator;v.generate(r,_)}if(p){r.addVertexAttribute("hx_jointIndices",4,1),r.addVertexAttribute("hx_jointWeights",4,1),d=r.getVertexStride(1);var g=new Float32Array(p.count*d);this._readVertexDataVec4(g,0,p,d,1),this._readVertexDataVec4(g,4,u,d,1),r.setVertexData(g,1)}a.addMesh(r),i.push(this._materials[t.material])},i.prototype._parseSkin=function(t,n,a){var i=n.skin,r=t.skins[i],s=this._getAccessor(r.inverseBindMatrices,t),o=s.data,h=s.byteOffset,l=new e.Skeleton,c=new e.SkeletonPose,p=new e.Matrix4x4,u=this._nodes[r.skeleton],_=new e.Matrix4x4;u.parent&&_.copyFrom(u.parent.worldMatrix);for(var d=0;d<r.joints.length;++d){var m=r.joints[d],f=new e.SkeletonJoint;f.inverseBindPose=new e.Matrix4x4;for(var v=0;v<16;++v)f.inverseBindPose._m[v]=o.getFloat32(h,!0),h+=4;f.inverseBindPose.prepend(this._invertZ),f.inverseBindPose.append(this._invertZ),l.addJoint(f);var g=this._nodes[m];g._jointIndex=d,g._skeletonPose=c,p.copyFrom(g.matrix);var y=new e.SkeletonJointPose;p.decompose(y),c.setJointPose(d,y)}for(d=0;d<r.joints.length;++d){var m=r.joints[d],g=this._nodes[m],f=l.getJoint(d);f.parentIndex=g!==u&&g.parent?g.parent._jointIndex:-1}a.model.skeleton=l,a.skeletonPose=c},i.prototype._parseNodes=function(t){this._nodes=[];for(var n=0;n<t.nodes.length;++n){var a,i=t.nodes[n];i.hasOwnProperty("mesh")?(a=this._modelInstances[i.mesh],a.name=i.name||a.model.name||"node_"+n,this._target.modelInstances[a.name]=a):a=new e.SceneNode,i.hasOwnProperty("rotation")&&a.rotation.set(i.rotation[0],i.rotation[1],i.rotation[2],i.rotation[3]),i.hasOwnProperty("translation")&&a.position.set(i.translation[0],i.translation[1],i.translation[2],1),i.hasOwnProperty("scale")&&a.scale.set(i.scale[0],i.scale[1],i.scale[2],1),i.hasOwnProperty("matrix")&&(a.matrix=new e.Matrix4x4(i.matrix));var r=a.matrix;a.matrix.prepend(this._invertZ),a.matrix.append(this._invertZ),a.matrix=r,this._nodes[n]=a}for(n=0;n<t.nodes.length;++n)if(i=t.nodes[n],a=this._nodes[n],i.hasOwnProperty("children"))for(var s=0;s<i.children.length;++s){var o=i.children[s];a.attach(this._nodes[o],t.meshes[i.mesh])}for(n=0;n<t.nodes.length;++n)i=t.nodes[n],a=this._nodes[n],i.hasOwnProperty("skin")&&this._parseSkin(t,i,a)},i.prototype._parseScenes=function(t,n){for(var a=0;a<t.scenes.length;++a){var i;a===n?i=this._target.defaultScene:(i=new e.Scene,this._target.scenes.push(i));for(var r=t.scenes[a],s=0;s<r.nodes.length;++s){var o=r.nodes[s];i.attach(this._nodes[o])}}},i.prototype._parseSampler=function(t,n,a){for(var i=this._getAccessor(n.input,t),r=this._getAccessor(n.output,t),s=i.data,o=r.data,h=i.byteOffset,l=r.byteOffset,c=new e.Matrix4x4,p=new e.AnimationClip,u=0;u<i.count;++u){var _;switch(r.numComponents){case 3:_=new e.Float4,_.x=o.getFloat32(l,!0),_.y=o.getFloat32(l+4,!0),_.z=o.getFloat32(l+8,!0)*(a?this._flipZ:1);break;case 4:_=new e.Quaternion,_.x=o.getFloat32(l,!0),_.y=o.getFloat32(l+4,!0),_.z=o.getFloat32(l+8,!0),_.w=o.getFloat32(l+12,!0),c.fromQuaternion(_),c.prepend(this._invertZ),c.append(this._invertZ),_.fromMatrix(c)}var d=new e.KeyFrame(1e3*s.getFloat32(h,!0),_);p.addKeyFrame(d),l+=4*r.numComponents,h+=4}return p},i.prototype._parseAnimations=function(t){for(var n=0;n<t.animations.length;++n){var a=t.animations[n],i=new e.LayeredAnimation;i.name=a.name||"animation_"+n,this._target.animations[i.name]=i;for(var r=0;r<a.channels.length;++r){var s,o=a.channels[r],h=this._nodes[o.target.node];switch(void 0!==h._jointIndex&&(h=h._skeletonPose._jointPoses[h._jointIndex]),o.target.path){case"translation":var l=this._parseSampler(t,a.samplers[o.sampler],!0);s=new e.AnimationLayerFloat4(h,"position",l);break;case"rotation":var l=this._parseSampler(t,a.samplers[o.sampler]);s=new e.AnimationLayerQuat(h,"rotation",l);break;case"scale":var l=this._parseSampler(t,a.samplers[o.sampler],!1);s=new e.AnimationLayerFloat4(h,"scale",l);break;default:throw new Error("Unknown channel path!")}i.addLayer(s)}i.play()}},r.prototype=Object.create(e.Importer.prototype),r.prototype.parse=function(t,n){this._skeleton=new e.Skeleton,this._model=n,this._jointData=[];for(var a=t.split("\n"),i=a.length,s=null,o=0;o<i;++o){var h=a[o].replace(/^\s+|\s+$/g,""),l=h.split(/\s+/);if("//"!==l[0]&&""!==l[0])if(s)s.call(this,l),"}"===l[0]&&(s=null);else switch(l[0]){case"commandline":case"numMeshes":case"numJoints":case"MD5Version":break;case"joints":s=this._parseJoint;break;case"mesh":this._meshData=new r._MeshData,s=this._parseMesh}}n.skeleton=this._skeleton,this._notifyComplete(n)},r.prototype._parseJoint=function(t){if("}"!==t[0]){var n=new r._Joint,a=n.pos,i=n.quat;n.name=t[0].substring(1,t[0].length-1),n.parentIndex=parseInt(t[1]),a.x=parseFloat(t[3]),a.y=parseFloat(t[4]),a.z=parseFloat(t[5]),this._correctionQuad.rotate(n.pos,n.pos),i.x=parseFloat(t[8]),i.y=parseFloat(t[9]),i.z=parseFloat(t[10]),i.w=1-i.x*i.x-i.y*i.y-i.z*i.z,i.w<0?i.w=0:i.w=-Math.sqrt(i.w),i.multiply(this._correctionQuad,i),this._jointData.push(n);var s=new e.SkeletonJoint;s.inverseBindPose.fromQuaternion(i);var a=n.pos;s.inverseBindPose.appendTranslation(a),s.inverseBindPose.invertAffine(),s.parentIndex=n.parentIndex,this._skeleton.addJoint(s)}},r.prototype._parseMesh=function(t){switch(t[0]){case"shader":case"numVerts":case"numWeights":break;case"tri":this._meshData.indices.push(parseInt(t[2]),parseInt(t[3]),parseInt(t[4]));break;case"vert":this._parseVert(t);break;case"weight":this._parseWeight(t);break;case"}":this._translateMesh()}},r.prototype._parseVert=function(t){var e=new r._VertexData;e.u=parseFloat(t[3]),e.v=parseFloat(t[4]),e.startWeight=parseInt(t[6]),e.countWeight=parseInt(t[7]),this._meshData.vertexData.push(e)},r.prototype._parseWeight=function(t){var e=new r._WeightData;e.joint=parseInt(t[2]),e.bias=parseFloat(t[3]),e.pos.x=parseFloat(t[5]),e.pos.y=parseFloat(t[6]),e.pos.z=parseFloat(t[7]),this._meshData.weightData.push(e)},r.prototype._translateMesh=function(){var t=new e.Mesh.createDefaultEmpty;t.addVertexAttribute("hx_jointIndices",4,1),t.addVertexAttribute("hx_jointWeights",4,1);for(var n,a,i,r=[],s=[],o=this._meshData.vertexData,h=o.length,l=0,c=0,p=0;p<h;++p){var u=o[p];n=a=i=0,u.countWeight>4&&console.warn("Warning: more than 4 weights assigned. Mesh will not animate correctly");for(var _=0;_<u.countWeight;++_){var d=this._meshData.weightData[u.startWeight+_],m=this._jointData[d.joint],f=m.quat.rotate(d.pos),v=m.pos,g=d.bias;n+=(f.x+v.x)*g,a+=(f.y+v.y)*g,i+=(f.z+v.z)*g,_<4&&(s[c+_]=d.joint,s[c+4+_]=d.bias)}r[l]=n,r[l+1]=a,r[l+2]=i,r[l+10]=u.u,r[l+11]=1-u.v;for(var _=u.countWeight;_<4;++_)s[c+_]=0,s[c+4+_]=0;c+=8,l+=12}t.setVertexData(r,0),t.setVertexData(s,1),t.setIndexData(this._meshData.indices);var y=new e.NormalTangentGenerator;y.generate(t),t.setVertexData(r,0),this._model.addMesh(t)},r._Joint=function(){this.name=null,this.parentIndex=-1,this.quat=new e.Quaternion,this.pos=new e.Float4},r._MeshData=function(){this.vertexData=[],this.weightData=[],this.indices=[]},r._VertexData=function(){this.u=0,this.v=0,this.startWeight=0,this.countWeight=0},r._WeightData=function(){this.joint=0,this.bias=0,this.pos=new e.Float4},s.prototype=Object.create(e.Importer.prototype),s.prototype.parse=function(t,e){this._hierarchy=[],this._baseFrame=[],this._target=e;for(var n=t.split("\n"),a=n.length,i=null,r=0;r<a;++r){var o=n[r].replace(/^\s+|\s+$/g,""),h=o.split(/\s+/);if("//"!==h[0]&&""!==h[0])if(i)i.call(this,h),"}"===h[0]&&(i=null);else switch(h[0]){case"commandline":case"numFrames":case"MD5Version":case"numAnimatedComponents":break;case"numJoints":this._numJoints=parseInt(h[1]);break;case"frameRate":this._frameRate=parseInt(h[1]);break;case"hierarchy":i=this._parseHierarchy;break;case"bounds":i=this._parseBounds;break;case"baseframe":i=this._parseBaseFrame;break;case"frame":this._activeFrame=new s._FrameData,i=this._parseFrame}}this._notifyComplete(e)},s.prototype._parseHierarchy=function(t){if("}"!==t[0]){var e=new s._HierachyData;e.name=t[0].substring(1,t[0].length-1),e.parent=parseInt(t[1]),e.flags=parseInt(t[2]),e.startIndex=parseInt(t[3]),this._hierarchy.push(e)}},s.prototype._parseBounds=function(t){},s.prototype._parseBaseFrame=function(t){if("}"!==t[0]){var e=new s._BaseFrameData,n=e.pos;n.x=parseFloat(t[1]),n.y=parseFloat(t[2]),n.z=parseFloat(t[3]);var a=e.quat;a.x=parseFloat(t[6]),a.y=parseFloat(t[7]),a.z=parseFloat(t[8]),a.w=1-a.x*a.x-a.y*a.y-a.z*a.z,a.w<0?a.w=0:a.w=-Math.sqrt(a.w),this._baseFrame.push(e)}},s.prototype._parseFrame=function(t){if("}"===t[0])return void this._translateFrame();for(var e=t.length,n=0;n<e;++n)this._activeFrame.components.push(parseFloat(t[n]))},s.prototype._translateFrame=function(){for(var t=new e.SkeletonPose,n=0;n<this._numJoints;++n){var a=new e.SkeletonJointPose,i=this._hierarchy[n],r=this._baseFrame[n],s=i.flags,o=r.pos,h=r.quat,l=this._activeFrame.components,c=i.startIndex;1&s&&(o.x=l[c]),2&s&&(o.y=l[c+1]),4&s&&(o.z=l[c+2]),8&s&&(h.x=l[c+3]),16&s&&(h.y=l[c+4]),32&s&&(h.z=l[c+5]);var p=1-h.x*h.x-h.y*h.y-h.z*h.z;h.w=p<0?0:-Math.sqrt(p),i.parent<0?(a.rotation.multiply(this._correctionQuad,h),a.position=this._correctionQuad.rotate(o)):(a.rotation.copyFrom(h),a.position.copyFrom(o)),t.setJointPose(n,a)}var u=this._target.numKeyFrames/this._frameRate*1e3;this._target.addKeyFrame(new e.KeyFrame(u,t))},s._HierachyData=function(){this.name=null,this.parent=-1,this.flags=0,this.startIndex=0},s._BaseFrameData=function(){this.pos=new e.Float4,this.quat=new e.Quaternion},s._FrameData=function(){this.components=[]},o.prototype=Object.create(e.Importer.prototype),o.prototype.parse=function(t,e){this._groupsAsObjects=void 0===this.options.groupsAsObjects||this._groupsAsObjects,this._target=e;var n=t.split("\n"),a=n.length;this._pushNewObject("hx_default");for(var i=0;i<a;++i){var r=n[i].replace(/^\s+|\s+$/g,"");this._parseLine(r)}this._mtlLibFile?this._loadMTLLib(this._mtlLibFile):this._finish(null)},o.prototype._finish=function(t){this._translate(t),this._notifyComplete(this._target)},o.prototype._loadMTLLib=function(t){var n=new e.AssetLoader(e.MTL),a=this;n.onComplete=function(t){a._finish(t)},n.onProgress=function(t){a._notifyProgress(t)},n.onFail=function(t){a._notifyFailure(t)},n.load(t)},o.prototype._parseLine=function(t){if(0!==t.length&&"#"!==t.charAt(0)){var e=t.split(/\s+/);switch(e[0].toLowerCase()){case"mtllib":this._mtlLibFile=this._correctURL(e[1]);break;case"usemtl":this._setActiveSubGroup(e[1]);break;case"v":this._vertices.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]));break;case"vt":this._uvs.push(parseFloat(e[1]),parseFloat(e[2]));break;case"vn":this._normals.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]));break;case"o":this._pushNewObject(e[1]);break;case"g":this._groupsAsObjects?this._pushNewObject(e[1]):this._pushNewGroup(e[1]);break;case"f":this._parseFaceData(e)}}},o.prototype._pushNewObject=function(t){this._activeObject=new o._ObjectData,this._activeObject.name=t,this._objects.push(this._activeObject),this._pushNewGroup("hx_default")},o.prototype._pushNewGroup=function(t){this._activeGroup=new o._GroupData,this._activeGroup.name=t||"Group"+this._activeGroup.length,this._activeObject.groups.push(this._activeGroup),this._setActiveSubGroup("hx_default")},o.prototype._setActiveSubGroup=function(t){this._activeGroup.subgroups[t]=this._activeGroup.subgroups[t]||new o._SubGroupData,this._activeSubGroup=this._activeGroup.subgroups[t]},o.prototype._parseFaceData=function(t){for(var e=new o._FaceData,n=t.length,a=1;a<n;++a){var i=new o._FaceVertexData;e.vertices.push(i);var r=t[a].split("/"),s=3*(r[0]-1);i.posX=this._vertices[s],i.posY=this._vertices[s+1],i.posZ=this._vertices[s+2],r.length>1&&(s=2*(r[1]-1),i.uvU=this._uvs[s],i.uvV=this._uvs[s+1],r.length>2&&(s=3*(r[2]-1),this._hasNormals=!0,i.normalX=this._normals[s],i.normalY=this._normals[s+1],i.normalZ=this._normals[s+2]))}this._activeSubGroup.faces.push(e),this._activeSubGroup.numIndices+=4===t.length?3:6},o.prototype._translate=function(t){for(var e=this._objects.length,n=0;n<e;++n)this._translateObject(this._objects[n],t)},o.prototype._translateObject=function(t,n){var a=t.groups.length;if(0!==a){for(var i=[],r=new e.Model,s=0;s<a;++s){var o=t.groups[s];for(var h in o.subgroups)if(o.subgroups.hasOwnProperty(h)){var l=o.subgroups[h];if(0===l.numIndices)continue;r.addMesh(this._translateMesh(l));var c=n?n[h]:null;c=c||this._defaultMaterial,i.push(c)}}var p=new e.ModelInstance(r,i);p.name=t.name,this._target.attach(p)}},o.prototype._translateMesh=function(t){for(var n=e.Mesh.createDefaultEmpty(),a=[],i=new Array(t.numIndices),r=0,s=0,o=t.faces,h=o.length,l=0;l<h;++l){for(var c=o[l],p=c.vertices,u=p.length,_=0;_<u;++_){var d=p[_],m=d.getHash();a.hasOwnProperty(m)||(a[m]={index:r++,vertex:d})}i[s]=a[p[0].getHash()].index,i[s+1]=a[p[2].getHash()].index,i[s+2]=a[p[1].getHash()].index,s+=3,4===u&&(i[s]=a[p[0].getHash()].index,i[s+1]=a[p[3].getHash()].index,i[s+2]=a[p[2].getHash()].index,s+=3)}var f=new Array(r*e.Mesh.DEFAULT_VERTEX_SIZE);for(var m in a)if(a.hasOwnProperty(m)){var v=a[m],g=v.vertex,y=v.index*e.Mesh.DEFAULT_VERTEX_SIZE;f[y]=g.posX,f[y+1]=g.posY,f[y+2]=g.posZ,f[y+3]=g.normalX,f[y+4]=g.normalY,f[y+5]=g.normalZ,f[y+6]=0,f[y+7]=0,f[y+8]=0,f[y+9]=1,f[y+10]=g.uvU,f[y+11]=g.uvV}n.setVertexData(f,0),n.setIndexData(i);var x=e.NormalTangentGenerator.MODE_TANGENTS;x|=e.NormalTangentGenerator.MODE_NORMALS;var b=new e.NormalTangentGenerator;return b.generate(n,x,!0),n},o._FaceVertexData=function(){this.posX=0,this.posY=0,this.posZ=0,this.uvU=0,this.uvV=0,this.normalX=0,this.normalY=0,this.normalZ=0,this._hash=""},o._FaceVertexData.prototype={getHash:function(){return this._hash||(this._hash=this.posX+"/"+this.posY+"/"+this.posZ+"/"+this.uvU+"/"+this.uvV+"/"+this.normalX+"/"+this.normalY+"/"+this.normalZ+"/"),this._hash}},o._FaceData=function(){this.vertices=[]},o._SubGroupData=function(){this.numIndices=0,this.faces=[]},o._GroupData=function(){this.subgroups=[],this.name="",this._activeMaterial=null},o._ObjectData=function(){this.name="",this.groups=[],this._activeGroup=null},h.prototype=Object.create(e.Importer.prototype),h.prototype.parse=function(t,e){for(var n=t.split("\n"),a=n.length,i=0;i<a;++i){var r=n[i].replace(/^\s+|\s+$/g,"");this._parseLine(r,e)}this._loadTextures(e)},h.prototype._parseLine=function(t,n){if(0!==t.length&&"#"!==t.charAt(0)){var a=t.split(/\s+/);switch(a[0].toLowerCase()){case"newmtl":this._activeMaterial=new e.BasicMaterial,this._activeMaterial.name=a[1],n[a[1]]=this._activeMaterial;break;case"ns":var i=parseFloat(a[1]);this._activeMaterial.roughness=e.BasicMaterial.roughnessFromShininess(i),this._activeMaterial.roughnessRange=this._activeMaterial.roughness;break;case"kd":this._activeMaterial.color=new e.Color(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));break;case"map_kd":this._activeMaterial.colorMap=this._getTexture(a[1]);break;case"map_d":this._activeMaterial.maskMap=this._getTexture(a[1]),this._activeMaterial.alphaThreshold=.5;break;case"map_ns":this._activeMaterial.specularMap=this._getTexture(a[1]);break;case"map_bump":case"bump":this._activeMaterial.normalMap=this._getTexture(a[1])}}},h.prototype._getTexture=function(t){if(!this._textures[t]){var n=new e.Texture2D;this._textures[t]=n,this._texturesToLoad.push({file:this._correctURL(t),importer:e.JPG,target:n})}return this._textures[t]},h.prototype._loadTextures=function(t){var n=new e.AssetLibrary(null,this.options.crossOrigin);n.fileMap=this.fileMap;var a=this._texturesToLoad,i=a.length;if(0===i)return void this._notifyComplete(t);for(var r=0;r<a.length;++r)n.queueAsset(a[r].file,a[r].file,e.AssetLibrary.Type.ASSET,a[r].importer,this.options,a[r].target);n.onComplete.bind(function(){this._notifyComplete(t)},this),n.onProgress.bind(function(t){this._notifyProgress(t)},this),n.load(a)},l.prototype={getChildByName:function(t){for(var e=this.children.length,n=0;n<e;++n){var a=this.children[n];if(a.name===t)return a}},printDebug:function(t,e){void 0===t&&(t=!0),void 0===e&&(e=0);for(var n="",a=0;a<e;++a)n+="\t";if(console.log(n+this.name),t&&this.data.length>0){console.log(n+"\t[data] {");for(var a=0;a<this.data.length;++a)console.log(n+"\t\t["+a+"] : "+this.data[a]);console.log(n+"}")}for(var a=0;a<this.children.length;++a)this.children[a].printDebug(t,e+1)}},c.prototype={get version(){return this._version},deserialize:function(t){this._data=t,this._verifyHeader(),26!==this._data.getUint16()&&console.log("Suspected oddity with FBX file"),this._version=this._data.getUint32();var e=new l;return e.name="[root]",this._deserializeNode(e),e},_verifyHeader:function(){if("Kaydara FBX Binary  \0"!==this._data.getString(21))throw new Error("Incorrect FBX file header!")},_deserializeNode:function(t){var e;do e=this._importNode(),e&&t.children.push(e);while(e)},_importNode:function(){var t=this._data,e=t.getUint32(),n=t.getUint32(),a=t.getUint32(),i=t.getUint8();if(0===e){if(0!==n||0!==a||0!==i)throw new Error("Invalid null node!");return null}var r=new l;r.name=t.getString(i);for(var s=0;s<n;++s){var o=this._parseDataElement();r.data.push(o)}return t.offset!==e&&this._deserializeNode(r),r},_parseDataElement:function(){var t=this._data.getChar();switch(t){case c.BOOLEAN:return this._data.getUint8();case c.INT16:return this._data.getInt16();case c.INT32:return this._data.getInt32();case c.INT64:return this._data.getInt64AsFloat64();case c.FLOAT:return this._data.getFloat32();case c.DOUBLE:return this._data.getFloat64();case c.STRING:var e=this._data.getUint32();return 0===e?"":this._data.getString(e);case c.RAW:var e=this._data.getUint32();return this._data.getUint8Array(e);default:return this._parseArray(t)}},_parseArray:function(t){var e=this._data.getUint32(),a=this._data.getUint32(),i=this._data.getUint32();if(0===a)switch(t){case c.BOOLEAN_ARRAY:return this._data.getUint8Array(e);case c.INT32_ARRAY:return this._data.getInt32Array(e);case c.INT64_ARRAY:return this._data.getInt64AsFloat64Array(e);case c.FLOAT_ARRAY:return this._data.getFloat32Array(e);case c.DOUBLE_ARRAY:return this._data.getFloat64Array(e);default:throw new Error("Unknown data type code "+t)}else{if(1!==a)throw new Error("Invalid encoding value "+a);var r=this._data.getUint8Array(i);switch(r=n.inflate(r).buffer,t){case c.BOOLEAN_ARRAY:return new Uint8Array(r);case c.INT32_ARRAY:return new Int32Array(r);case c.INT64_ARRAY:return r=new HX.DataStream(new DataView(r)),r.getInt64AsFloat64Array(r.byteLength/8);case c.FLOAT_ARRAY:return new Float32Array(r);case c.DOUBLE_ARRAY:return new Float64Array(r);default:throw new Error("Unknown data type code "+t)}}}},c.INT16="Y",c.BOOLEAN="C",c.INT32="I",c.FLOAT="F",c.DOUBLE="D",c.INT64="L",c.BOOLEAN_ARRAY="b",c.INT32_ARRAY="i",c.FLOAT_ARRAY="f",c.DOUBLE_ARRAY="d",c.INT64_ARRAY="l",c.STRING="S",c.RAW="R",p.prototype={connectObject:function(t){throw new Error("Unhandled object connection "+t.toString()+" -> "+this.toString())},connectProperty:function(t,e){},copyProperties:function(t){for(var e in t)if(this.hasOwnProperty(e)&&void 0!==t[e]&&null!==t[e]){var n=e.charAt(0);n.toUpperCase()===n&&(this[e]=t[e])}}},p.prototype.toString=function(){return"[FbxObject(name="+this.name+")]"},u.prototype=Object.create(p.prototype),u.prototype.toString=function(){return"[FbxNodeAttribute(name="+this.name+", type="+this.type+")]"},_.prototype=Object.create(p.prototype),_.prototype.toString=function(){return"[FbxCluster(name="+this.name+")]"},_.prototype.connectObject=function(t){if(!(t instanceof w))throw new Error("Unhandled object connection "+t.toString());this.limbNode=t},d.prototype=Object.create(p.prototype),d.prototype.toString=function(){return"[FbxSkin(name="+this.name+")]"},d.prototype.connectObject=function(t){if(!(t instanceof _))throw new Error("Unhandled object connection "+t.toString());this.clusters=this.clusters||[],this.clusters.push(t)},m.prototype=Object.create(p.prototype),m.prototype.toString=function(){return"[FbxMesh(name="+this.name+")]"},m.prototype.connectObject=function(t){if(!(t instanceof d))throw new Error("Unhandled object connection "+t.toString());this.deformers=this.deformers||[],this.deformers.push(t)},f.prototype=Object.create(p.prototype),f.prototype.toString=function(){return"[FbxVideo(name="+this.name+")]"},v.prototype=Object.create(p.prototype),v.prototype.connectObject=function(t){if(!(t instanceof f))throw new Error("Incompatible child object!");this.video=t},v.prototype.toString=function(){return"[FbxFileTexture(name="+this.name+")]"},g.prototype=Object.create(p.prototype),g.prototype.connectProperty=function(t,e){if(!(t instanceof v))throw new Error("Unknown object property!");this.textures=this.textures||{},this.textures[e]=t},g.prototype.toString=function(){return"[FbxMaterial(name="+this.name+")]"},y.prototype=Object.create(p.prototype),y.prototype.toString=function(){return"[FbxTrashNode(name="+this.name+")]"},y.prototype.connectObject=function(t){},x.prototype=Object.create(p.prototype),x.prototype.toString=function(){return"[FbxAnimationCurve(name="+this.name+")]"},b.prototype=Object.create(p.prototype),b.prototype.toString=function(){return"[FbxAnimationCurveNode(name="+this.name+")]"},b.prototype.connectProperty=function(t,e){t instanceof x&&(this.curves=this.curves||{},this.curves[e]=t)},w.prototype=Object.create(p.prototype,{numChildren:{get:function(){return this.children?this.children.length:0}},geometryTransform:{get:function(){if(!this._geometricMatrix&&(this._geometricMatrix=new HX.Matrix4x4,this.GeometricRotation||this.GeometricScaling||this.GeometricTranslation)){var t=new HX.Transform;if(this.GeometricRotation){var e=new HX.Quaternion;e.fromEuler(this.GeometricRotation.x*HX.DEG_TO_RAD,this.GeometricRotation.y*HX.DEG_TO_RAD,this.GeometricRotation.z*HX.DEG_TO_RAD),t.rotation=e}this.GeometricScaling&&(t.scale=this.GeometricScaling),this.GeometricTranslation&&(t.position=this.GeometricTranslation),this._geometricMatrix.copyFrom(t.matrix)}return this._geometricMatrix}},matrix:{get:function(){if(!this._matrix){this._matrix=new HX.Matrix4x4;
var t=this._matrix,e=new HX.Float4;this.ScalingPivot&&(e.negativeOf(this.ScalingPivot),t.appendTranslation(e));var n=this["Lcl Scaling"];n&&t.appendScale(n.x,n.y,n.z),this.ScalingPivot&&t.appendTranslation(this.ScalingPivot),this.ScalingOffset&&t.appendTranslation(this.ScalingOffset),this.RotationPivot&&(e.negativeOf(this.RotationPivot),t.appendTranslation(e)),this.PreRotation&&t.appendQuaternion(this._convertRotation(this.PreRotation)),this["Lcl Rotation"]&&t.appendQuaternion(this._convertRotation(this["Lcl Rotation"])),this.PostRotation&&t.appendQuaternion(this._convertRotation(this.PostRotation)),this.RotationPivot&&t.appendTranslation(this.RotationPivot),this.RotationOffset&&t.appendTranslation(this.RotationOffset),this["Lcl Translation"]&&t.appendTranslation(this["Lcl Translation"])}return this._matrix}}}),w.prototype.getChild=function(t){return this.children[t]},w.prototype.connectObject=function(t){if(t instanceof w)"Root"===t.type?this.skeleton=t:(this.children=this.children||[],this.children.push(t),t.parent=this);else if(t instanceof u)this.defaultAttribute=this.defaultAttribute||t,this.attributes=this.attributes||[],this.attributes.push(t);else if(t instanceof m)this.mesh=t,this.mesh.parent=this;else if(t instanceof g)this.materials=this.materials||[],this.materials.push(t);else if(!(t instanceof y))throw new Error("Incompatible child object "+t.toString()+" for "+this.type)},w.prototype._convertRotation=function(t){var e=new HX.Quaternion;return e.fromEuler(t.x*HX.DEG_TO_RAD,t.y*HX.DEG_TO_RAD,t.z*HX.DEG_TO_RAD),e},w.prototype.connectProperty=function(t,e){t instanceof b&&(this.animationCurveNodes=this.animationCurveNodes||{},this.animationCurveNodes[e]=t,t.propertyName=e)},w.prototype.toString=function(){return"[FbxNode(name="+this.name+", type="+this.type+")]"},T.prototype=Object.create(p.prototype),T.prototype.toString=function(){return"[FbxAnimLayer(name="+this.name+")]"},T.prototype.connectObject=function(t){if(!(t instanceof b))throw new Error("Incompatible child object "+t.toString());this.curveNodes=this.curveNodes||[],this.curveNodes.push(t)},M.getSpan=function(t,e){return new M(e._value-t._value)},M.TC_MILLISECOND=46186158,M.prototype={get milliseconds(){return this._value/M.TC_MILLISECOND},set milliseconds(t){this._value=t*M.TC_MILLISECOND},getFrameCount:function(t){return Math.floor(this.milliseconds/1e3*t)},toString:function(){return"[FbxTime(name="+this._value+")]"}},I.prototype=Object.create(p.prototype),I.prototype.connectObject=function(t){if(!(t instanceof T))throw new Error("Incompatible child object "+t.toString());this.layers=this.layers||[],this.layers.push(t)},I.prototype.toString=function(){return"[FbxAnimStack(name="+this.name+")]"},O.prototype=Object.create(p.prototype),O.prototype.toString=function(){return"[FbxPose(name="+this.name+")]"},A.prototype=Object.create(p.prototype),A.MAPPING_TYPE={NONE:0,BY_POLYGON_VERTEX:1,BY_CONTROL_POINT:2,BY_POLYGON:3,ALL_SAME:4},A.REFERENCE_TYPE={DIRECT:1,INDEX_TO_DIRECT:2},A.prototype.toString=function(){return"[FbxLayerElement(name="+this.name+")]"},F.prototype={get bindPoses(){return this._bindPoses},get sceneRoot(){return this._rootNode},get animationStack(){return this._animationStack},build:function(t,e){this._settings=e,this._templates={},this._objects={},this._bindPoses=null,this._rootNode=new w,this._rootNode.name="hx_rootNode",this._animationStack=null,this._processTemplates(t.getChildByName("Definitions")),this._processObjects(t.getChildByName("Objects")),this._processConnections(t.getChildByName("Connections"))},_processTemplates:function(t){for(var e=t.children.length,n=0;n<e;++n){var a=t.children[n];if("ObjectType"===a.name){var i=a.getChildByName("PropertyTemplate");if(!i)continue;var r=i.data[0],s=a.data[0],o=this._createNode(s,r,i);o&&this._assignProperties(o,i.getChildByName("Properties70")),this._templates[s]=o}}},_processObjects:function(t){for(var e=t.children.length,n=0;n<e;++n){var a=null,i=t.children[n];switch(i.name){case"Geometry":a=this._processGeometry(i);break;case"NodeAttribute":a=new u,a.type=i.data[2];break;case"Model":a=new w,a.type=i.data[2];break;case"Material":a=new g;break;case"Video":a=new f;var r=i.getChildByName("RelativeFilename");a.relativeFilename=r?r.data[0]:null;break;case"Texture":a=new v;var r=i.getChildByName("RelativeFilename");a.relativeFilename=r?r.data[0]:null;break;case"Pose":a=this._processPose(i),this._bindPoses=this._bindPoses||[],this._bindPoses.push(a);break;case"Deformer":a="Skin"===i.data[2]?new d:this._processCluster(i);break;case"AnimationStack":a=new I,this._animationStack=a;break;case"AnimationLayer":a=new T;break;case"AnimationCurve":a=new x,this._assignFlatData(a,i);for(var s=[],o=0;o<a.KeyTime.length;++o)s[o]=new M(a.KeyTime[o]);a.KeyTime=s;break;case"AnimationCurveNode":a=new b;break;default:a=new y}if(a){var h=i.data[0];a.name=this._getObjectDefName(i),a.UID=h,this._templates[i.name]&&a.copyProperties(this._templates[i.name]),this._assignProperties(a,i.getChildByName("Properties70")),this._objects[h]=a}}},_processPose:function(t){var e=new O;e.type=t.data[2];for(var n=0;n<t.children.length;++n){var a=t.children[n];if("PoseNode"===a.name){var i=new D;i.targetUID=a.getChildByName("Node").data[0],i.matrix=new HX.Matrix4x4(a.getChildByName("Matrix").data[0]),e.poseNodes.push(i)}}return e},_processConnections:function(t){for(var e=t.children.length,n=0;n<e;++n){var a=t.children[n],i=a.data[0],r=this._objects[a.data[1]],s=this._objects[a.data[2]]||this._rootNode;"OO"===i?s.connectObject(r):"OP"===i&&s.connectProperty(r,a.data[3])}},_createNode:function(t,e){return"Material"===t?new g:HX[e]?new HX[e]:void 0},_assignFlatData:function(t,e){for(var n=e.children.length,a=0;a<n;++a){var i=e.children[a];t.hasOwnProperty(i.name)&&(t[i.name]=i.data[0])}},_assignProperties:function(t,e){if(e)for(var n=e.children.length,a=0;a<n;++a){var i=e.children[a];t.hasOwnProperty(i.data[0])&&(t[i.data[0]]=this._getPropertyValue(i))}},_getPropertyValue:function(t){var e=t.data;switch(e[1]){case"Vector3D":case"Lcl Translation":case"Lcl Scaling":case"Lcl Rotatfion":return new HX.Float4(e[4],e[5],e[6]);case"bool":case"Visibility":case"Visibility Inheritance":return 0!==e[4];case"ColorRGB":case"Color":return new HX.Color(e[4],e[5],e[6]);case"enum":case"double":case"float":case"int":case"KString":return e[4];case"KTime":return new M(e[4]);case"object":return null}},_processGeometry:function(t){for(var e=new m,n=t.children.length,a={},i=0;i<n;++i){var r=t.children[i];switch(r.name){case"Vertices":e.vertices=r.data[0];break;case"PolygonVertexIndex":e.indices=r.data[0];break;case"Layer":e.layerElements=e.layerElements||{},this._processLayer(r,a,e.layerElements);break;default:a[r.name]||(a[r.name]=r)}}return e},_processLayer:function(t,e,n){for(var a=t.children.length,i=0;i<a;++i){var r=t.children[i];if("LayerElement"===r.name){var s=r.getChildByName("Type").data[0];if(!n[r.type]){var r=this._processLayerElement(e[s]);n[r.type]=r}}}},_processLayerElement:function(t){for(var e=new A,n=t.children.length,a=0;a<n;++a){var i=t.children[a];switch(i.name){case"MappingInformationType":var r=i.data[0];e.mappingInformationType="ByPolygonVertex"===r?A.MAPPING_TYPE.BY_POLYGON_VERTEX:"ByPolygon"===r?A.MAPPING_TYPE.BY_POLYGON:"AllSame"===r?A.MAPPING_TYPE.ALL_SAME:A.MAPPING_TYPE.BY_CONTROL_POINT;break;case"ReferenceInformationType":e.referenceInformationType="Direct"===i.data[0]?A.REFERENCE_TYPE.DIRECT:A.REFERENCE_TYPE.INDEX_TO_DIRECT;break;case"Normals":case"Colors":case"UV":case"Smoothing":e.type=i.name,e.directData=i.data[0];break;case"NormalsIndex":case"ColorIndex":case"UVIndex":case"SmoothingIndex":e.indexData=i.data[0];break;case"Materials":e.type=i.name,e.indexData=i.data[0]}}return e},_getObjectDefName:function(t){return t.data[1].split(F._STRING_DEMARCATION)[0]},_processCluster:function(t){for(var e=new _,n=t.children.length,a=0;a<n;++a){var i=t.children[a];switch(i.name){case"Transform":e.transform=new HX.Matrix4x4(i.data[0]);break;case"TransformLink":e.transformLink=new HX.Matrix4x4(i.data[0]);break;case"Indexes":e.indices=i.data[0];break;case"Weights":e.weights=i.data[0]}}return e}},F._STRING_DEMARCATION=String.fromCharCode(0,1),S.prototype={get skeleton(){return this._skeleton},get animationClips(){return this._animationClips},get fakeJointIndex(){return this._fakeJointIndex},getJointBinding:function(t){return this._skinningData[t]},convertSkin:function(t,e){this._skeleton=new HX.Skeleton,this._skinningData=[],this._jointUIDLookUp={};for(var n=t.clusters.length,a=0;a<n;++a){var i=t.clusters[a];this._addJointsToSkeleton(this._getRootNodeForCluster(i));var r=this._jointUIDLookUp[i.limbNode.UID];this._assignInverseBindPose(i,e,r.joint),this._assignJointBinding(i,r.index)}var s=new HX.SkeletonJoint;this._fakeJointIndex=this._skeleton.numJoints,this._skeleton.addJoint(s);for(var o in this._jointUIDLookUp)this._jointUIDLookUp[o].fbxNode.data=null},convertClips:function(t,e,n,a){this._frameRate=a.frameRate,this._animationClips=[];for(var i=0;i<t.layers.length;++i)for(var r=t.layers,s=0;s<r.length;++s){var o=this._convertLayer(r[s]);this._animationClips.push(o)}},_addJointsToSkeleton:function(t){t.data!==!0&&(t.data=!0,this._convertSkeletonNode(t,-1))},_convertSkeletonNode:function(t,e){var n=new HX.SkeletonJoint;n.parentIndex=e;var a=this._skeleton.numJoints;if(this._skeleton.addJoint(n),this._jointUIDLookUp[t.UID]={joint:n,index:a,fbxNode:t},t.animationCurveNodes)for(var i in t.animationCurveNodes)if(t.animationCurveNodes.hasOwnProperty(i)){var r=t.animationCurveNodes[i];r.data=a}for(var s=0;s<t.numChildren;++s)this._convertSkeletonNode(t.getChild(s),a)},_assignJointBinding:function(t,e){if(t.indices)for(var n=t.indices.length,a=0;a<n;++a)if(t.weights[a]>0){var i=t.indices[a],r=this._skinningData[i]=this._skinningData[i]||[],s=new k._JointBinding;s.jointIndex=e,s.jointWeight=t.weights[a],r.push(s)}},_assignInverseBindPose:function(t,e,n){n.inverseBindPose.copyFrom(t.transformLink),n.inverseBindPose.invertAffine(),n.inverseBindPose.prependAffine(t.transform),n.inverseBindPose.prependAffine(e)},_getLimbGlobalMatrix:function(t){if(!t._globalMatrix)if(t._globalMatrix=new HX.Matrix4x4,t.parent&&"LimbNode"===t.parent.type){var e=this._getLimbGlobalMatrix(t.parent);t._globalMatrix.multiply(e,t.matrix)}else t._globalMatrix.copyFrom(t.matrix);return t._globalMatrix},_getRootNodeForCluster:function(t){for(var e=t.limbNode;e;){if("LimbNode"!==e.type)return e;e=e.parent}throw new Error("No Root node found!")},_convertLayer:function(t){var e=this._convertToFrames(t);return this._convertToClip(e)},_convertToFrames:function(t){for(var e=[],n=t.curveNodes.length,a=0;a<n;++a){var i=t.curveNodes[a];for(var r in i.curves)if(i.curves.hasOwnProperty(r)){var s=i.curves[r];e.push({frames:this._addCurveToKeyFrame(s),node:i})}}return e},_addCurveToKeyFrame:function(t){for(var e=t.KeyTime.length,n=[],a=0;a<e;++a){var i=t.KeyTime[a].milliseconds,r=t.KeyValueFloat[a],s=new HX.KeyFrame(i,r);n.push(s)}return n},_completeKeyFrames:function(t){for(var e=[],n=t.length,a=0;a<n;++a)e[a]=0;for(var i=!1;!i;){var r=Number.POSITIVE_INFINITY,s=a;for(a=0;a<n;++a){var o=t[a].frames;o[e[a]].time<r&&(r=o[e[a]].time,s=a)}for(a=0;a<n;++a){o=t[a].frames;var h=e[a];if(o[h].time!==r){var l=Math.max(e[a]-1,0),c=HX.MathX.linearStep(o[l].time,o[h].time,r),p=HX.MathX.lerp(o[l].value,o[h].value,c),u=new HX.KeyFrame(r,p);o.splice(h,0,u)}}for(i=!0,a=0;a<n;++a)o=t[a].frames,o[e[a]].time<=r&&++e[a],e[a]<o.length&&(i=!1)}},_createTempJointPoses:function(){for(var t=[],e=this._skeleton.numJoints,n=0;n<e;++n){var a=this._skeleton.getJoint(n),i=a.inverseBindPose.clone();if(i.invertAffine(),a.parentIndex!==-1){var r=this._skeleton.getJoint(a.parentIndex).inverseBindPose;i.appendAffine(r)}var s=new S._JointPose,o=new HX.Transform;i.decompose(o),s["Lcl Translation"].copyFrom(o.position),o.rotation.toEuler(s["Lcl Rotation"]),s["Lcl Rotation"].x*=HX.RAD_TO_DEG,s["Lcl Rotation"].y*=HX.RAD_TO_DEG,s["Lcl Rotation"].z*=HX.RAD_TO_DEG,s["Lcl Scaling"].copyFrom(o.scale),t[n]=s}return t},_applyCurvesForFrame:function(t,e,n){for(var a=e.length,i=0;i<a;++i){var r=e[i],s=r.frames,o=r.node,h=o.data;if(null!==h){var l=t[h][o.propertyName];for(var c in o.curves)if(o.curves.hasOwnProperty(c)){var p=s[n].value;switch(c){case"d|X":l.x=p;break;case"d|Y":l.y=p;break;case"d|Z":l.z=p}}}}},_convertSkeletonPose:function(t){for(var e=new HX.SkeletonPose,n=this._skeleton.numJoints,a=0;a<n;++a){var i=new HX.SkeletonJointPose,r=t[a];i.position.copyFrom(r["Lcl Translation"]),i.scale.copyFrom(r["Lcl Scaling"]);var s=r["Lcl Rotation"];i.rotation.fromEuler(s.x*HX.DEG_TO_RAD,s.y*HX.DEG_TO_RAD,s.z*HX.DEG_TO_RAD),e.setJointPose(a,i)}return e},_convertToClip:function(t){for(var e=new HX.AnimationClip,n=t[0].frames.length,a=0;a<n;++a){var i=t[0].frames[a].time,r=this._createTempJointPoses();this._applyCurvesForFrame(r,t,a);var s=this._convertSkeletonPose(r);s.setJointPose(this._fakeJointIndex,new HX.SkeletonJointPose),e.addKeyFrame(new HX.KeyFrame(i,s))}return e}},S._JointPose=function(){this["Lcl Translation"]=new HX.Float4(0,0,0),this["Lcl Rotation"]=new HX.Float4(0,0,0),this["Lcl Scaling"]=new HX.Float4(1,1,1)},k.prototype={createModelInstance:function(t){for(var e=[],n=this._modelMaterialIDs.length,a=0;a<n;++a)e[a]=t[this._modelMaterialIDs[a]];var i=new HX.ModelInstance(this._model,e);this._animationConverter.animationClips;return i},convertToModel:function(t,e,n,a){this._perMaterialData=[],this._ctrlPointLookUp=[],this._modelMaterialIDs=[],this._useSkinning=!1,this._model=new HX.Model,this._animationConverter=new S,t.deformers&&this._generateSkinningData(t,n),this._generateExpandedMeshData(t,n),this._vertexStride=HX.Mesh.DEFAULT_VERTEX_SIZE,this._expandedMesh.hasColor&&(this._vertexStride+=3),this._splitPerMaterial(),this._generateModel(),t.deformers&&this._animationConverter.convertClips(e,t,n,a),this._model.name=t.name},_generateExpandedMeshData:function(t,e){this._expandedMesh=new k._ExpandedMesh;var n,a,i,r,s=t.indices,o=t.vertices,h=t.layerElements;h&&(n=h.Normals,a=h.Colors,i=h.UV,r=h.Materials);var l=[],c=0,p=0;n&&(this._expandedMesh.hasNormals=!0),a&&(this._expandedMesh.hasColor=!0),i&&(this._expandedMesh.hasUVs=!0);for(var u=s.length,_=0;_<u;++_){var d=s[_],m=new k._Vertex;if(d<0&&(d=-d-1,m.lastVertex=!0),m.pos.x=o[3*d],m.pos.y=o[3*d+1],m.pos.z=o[3*d+2],e&&e.transformPoint(m.pos,m.pos),this._model.skeleton&&(m.jointBindings=this._animationConverter.getJointBinding(d)),m.ctrlPointIndex=d,n&&(m.normal=this._extractLayerData(n,d,_,3),e&&e.transformVector(m.normal,m.normal)),a&&(m.color=this._extractLayerData(a,d,_,3)),i&&(m.uv=this._extractLayerData(i,d,_,2)),r&&r.mappingInformationType!==A.MAPPING_TYPE.ALL_SAME){var f=r.indexData[c];m.materialIndex=f,f>p&&(p=f)}m.lastVertex&&++c,l[_]=m}this._expandedMesh.vertices=l,this._expandedMesh.numMaterials=p+1},_extractLayerData:function(t,e,n,a){var i=a>2?new HX.Float4:new HX.Float2;if(t.referenceInformationType===A.REFERENCE_TYPE.DIRECT){var r=t.mappingInformationType===A.MAPPING_TYPE.BY_CONTROL_POINT?e:n;i.x=t.directData[r*a],i.y=t.directData[r*a+1],a>2&&(i.z=t.directData[r*a+2])}else{var r=t.mappingInformationType===A.MAPPING_TYPE.BY_CONTROL_POINT?t.indexData[e]:t.indexData[n];i.x=t.directData[r*a],i.y=t.directData[r*a+1],a>2&&(i.z=t.directData[r*a+2])}return i},_splitPerMaterial:function(){for(var t=0;t<this._expandedMesh.numMaterials;++t)this._perMaterialData[t]=new k._PerMaterialData;for(var e,n,a,t=0,i=0,r=this._expandedMesh.vertices,s=r.length,o=!0;t<s;){var h=this._perMaterialData[r[t].materialIndex];if(h.vertices||(o=!0),o&&(o=!1,h.indexCounter=0,h.indices=[],h.vertices=[],h.ctrlPointIndices=[],h.indexLookUp={},h.indexStack.push(h.indices),h.vertexStack.push(h.vertices),h.ctrlPointStack.push(h.ctrlPointIndices),this._useSkinning&&(h.skinning=[],h.skinningStack.push(h.skinning))),e=this._getOrAddIndex(r[t]),e<0)o=!0;else if(n=this._getOrAddIndex(r[t+1]),n<0)o=!0;else{t+=2;var l;do if(l=r[t],a=this._getOrAddIndex(l),a<0)o=!0;else{++t;var c=this._perMaterialData[l.materialIndex].indices;c[i]=e,c[i+1]=a,c[i+2]=n,i+=3,n=a}while(!l.lastVertex&&!o)}}},_getOrAddIndex:function(t){var e=t.getHash(),n=this._perMaterialData[t.materialIndex],a=n.indexLookUp;if(a.hasOwnProperty(e))return a[e];if(n.indexCounter>65535)return-1;var i=n.skinning,r=n.vertices,s=n.indexCounter++,o=s*this._vertexStride,h=8*s;if(n.ctrlPointIndices[t.ctrlPointIndex]=s,a[e]=s,r[o]=t.pos.x,r[o+1]=t.pos.y,r[o+2]=t.pos.z,i){var l=t.jointBindings,c=l?l.length:0;c>4&&(c=4,console.warn("Warning: more than 4 joints not supported. Model will not animate correctly"),l.sort(function(t,e){return e.jointWeight-t.jointWeight}));for(var p=0,u=0;u<c;++u){var _=l[u].jointWeight;i[h+u]=l[u].jointIndex,i[h+u+4]=_,p+=_}p=p>=1?0:1-p;for(var u=c;u<4;++u)i[h+u]=this._fakeJointIndex,i[h+u+4]=u===c?p:0}return this._expandedMesh.hasNormals?(r[o+3]=t.normal.x,r[o+4]=t.normal.y,r[o+5]=t.normal.z):r[o+3]=r[o+4]=r[o+5]=0,r[o+6]=r[o+7]=r[o+8]=r[o+9]=0,this._expandedMesh.hasUVs?(r[o+10]=t.uv.x,r[o+11]=t.uv.y):r[o+10]=r[o+11]=0,this._expandedMesh.hasColor&&(r[o+12]=t.color.x,r[o+13]=t.color.y,r[o+14]=t.color.z),s},_generateModel:function(){for(var t=0,e=this._expandedMesh.numMaterials,n=0;n<e;++n)for(var a=this._perMaterialData[n],i=a.indexStack.length,r=0;r<i;++r){var s=HX.Mesh.createDefaultEmpty();this._expandedMesh.hasColor&&s.addVertexAttribute("hx_vertexColor",3),s.setVertexData(a.vertexStack[r],0),s.setIndexData(a.indexStack[r]),this._useSkinning&&(s.addVertexAttribute("hx_jointIndices",4,1),s.addVertexAttribute("hx_jointWeights",4,1),s.setVertexData(a.skinningStack[r],1));for(var o=a.ctrlPointStack[r],h=o.length,l=0;l<h;++l)this._ctrlPointLookUp[o[l]]={index:l,meshIndex:t};++t,this._modelMaterialIDs.push(n);var c=HX.NormalTangentGenerator.MODE_TANGENTS;this._expandedMesh.hasNormals||(c|=HX.NormalTangentGenerator.MODE_NORMALS);var p=new HX.NormalTangentGenerator;p.generate(s,c),this._model.addMesh(s)}},_generateSkinningData:function(t,e){var n=t.deformers.length;if(0!==n){if(n>1)throw new Error("Multiple skins not supported");this._animationConverter.convertSkin(t.deformers[0],e),this._model.skeleton=this._animationConverter.skeleton,this._useSkinning=!0}}},k._ExpandedMesh=function(){this.vertices=null,this.hasColor=!1,this.hasUVs=!1,this.hasNormals=!1,this.numMaterials=0},k._JointBinding=function(){this.jointIndex=0,this.jointWeight=0},k._Vertex=function(){this.pos=new HX.Float4,this.uv=null,this.normal=null,this.color=null,this.materialIndex=0,this.ctrlPointIndex=-1,this.jointBindings=null,this._hash=null,this.lastVertex=!1},k._Vertex.prototype={getHash:function(){if(!this._hash){var t=this.ctrlPointIndex+"/"+this.materialIndex+"/"+this.pos.x+"/"+this.pos.y+"/"+this.pos.z;this.normal&&(t+="/"+this.normal.x+"/"+this.normal.y+"/"+this.normal.z),this.uv&&(t+="/"+this.uv.x+"/"+this.uv.y),this.color&&(t+="/"+this.color.x+"/"+this.color.y+"/"+this.color.z),this._hash=t}return this._hash}},k._PerMaterialData=function(){this.indexCounter=0,this.vertexStack=[],this.skinningStack=[],this.indexStack=[],this.ctrlPointStack=[],this.vertices=null,this.indices=null,this.skinning=null,this.ctrlPointIndices=null,this.indexLookUp={}},P.prototype={get textureTokens(){return this._textureTokens},get textureMaterialMap(){return this._textureMaterialMap},convert:function(t,e,n,a){this._settings=a,this._objects=[],this._textureTokens=[],this._textureMaterialMap=[],this._rootNode=t,this._animationStack=e,this._convertSceneNode(t,n)},_convertNode:function(t){var e;if(t.mesh)e=this._convertModelMesh(t);else{if(!(t.children&&t.children.length>1))return null;e=new HX.SceneNode,this._convertSceneNode(t,e)}return e.name=t.name,this._convertSceneGraphObject(t,e),e},_convertSceneNode:function(t,e){for(var n=t.children.length,a=0;a<n;++a){var i=this._convertNode(t.children[a]);i&&e.attach(i)}},_convertModelMesh:function(t){var e=this._convertGeometry(t.mesh,t.geometryTransform),n=[];if(t.materials)for(var a=t.materials.length,i=0;i<a;++i)n[i]=this._convertMaterial(t.materials[i]);else n.push(new HX.BasicMaterial);return e.createModelInstance(n)},_convertSceneGraphObject:function(t,e){e.matrix=t.matrix},_convertGeometry:function(t,e){if(this._objects[t.UID])return this._objects[t.UID];var n=new k;return n.convertToModel(t,this._animationStack,e,this._settings),this._objects[t.UID]=n,n},_convertMaterial:function(t){if(this._objects[t.UID])return this._objects[t.UID];var e=new HX.BasicMaterial;return e.name=t.name,t.DiffuseColor&&(e.color=t.DiffuseColor),t.Shininess&&(t.ShininessExponent=t.Shininess),t.ShininessExponent&&(e.roughness=HX.BasicMaterial.roughnessFromShininess(t.Shininess)),t.textures&&(t.textures.NormalMap&&this._convertTexture(t.textures.NormalMap,e,P._TextureToken.NORMAL_MAP),t.textures.SpecularColor&&this._convertTexture(t.textures.SpecularColor,e,P._TextureToken.SPECULAR_MAP),t.textures.DiffuseColor&&this._convertTexture(t.textures.DiffuseColor,e,P._TextureToken.DIFFUSE_MAP)),this._objects[t.UID]=e,e},_convertTexture:function(t,e,n){var a;this._objects[t.UID]?a=this._objects[t.UID]:(a=new P._TextureToken,a.name=t.name,a.mapType=n,a.filename=t.relativeFilename?t.relativeFilename:t.video.relativeFilename,this._textureTokens.push(a),this._objects[t.UID]=a);var i=new P._TextureMaterialMapping(e,a,n);this._textureMaterialMap.push(i)}},P._TextureMaterialMapping=function(t,e,n){this.material=t,this.token=e,this.mapType=n},P._TextureToken=function(){this.filename=null,this.name=null,this.UID=null},P._TextureToken.NORMAL_MAP=0,P._TextureToken.SPECULAR_MAP=1,P._TextureToken.DIFFUSE_MAP=2,N.prototype={get orientationMatrix(){return this._matrix},get frameRate(){return this._frameRate},init:function(t){for(var e=1,n=1,a=2,i=1,r=t.getChildByName("GlobalSettings"),s=r.getChildByName("Properties70"),o=s.children.length,h=[0,120,100,60,50,48,30],l=0;l<o;++l){var c=s.children[l];switch(c.data[0]){case"UpAxis":e=c.data[4];break;case"UpAxisSign":n=c.data[4];break;case"FrontAxis":a=c.data[4];break;case"FrontAxisSign":i=c.data[4];break;case"TimeMode":h[c.data[4]]&&(this._frameRate=h[c.data[4]])}}var p=[HX.Float4.X_AXIS,HX.Float4.Y_AXIS,HX.Float4.Z_AXIS],u=p[a].clone(),_=p[e].clone();u.scale(i),_.scale(n),this._matrix.lookAt(u,HX.Float4.ORIGIN_POINT,_),this._matrix.invert()}},L.prototype=Object.create(e.Importer.prototype),L.prototype.parse=function(t,n){var a=new e.DataStream(t),i=new c,r=new F,s=new P,o=new N;try{var h,l=Date.now(),p=i.deserialize(a);if(h=Date.now(),console.log("Serialization: "+(h-l)),l=h,o.init(p),i.version<7e3)throw new Error("Unsupported FBX version!");r.build(p,o),h=Date.now(),console.log("Graph building: "+(h-l)),l=h,s.convert(r.sceneRoot,r.animationStack,n,o),h=Date.now(),console.log("Conversion: "+(h-l))}catch(u){return console.log(u.stack),void this._notifyFailure(u.message)}s.textureTokens.length>0?this._loadTextures(s.textureTokens,s.textureMaterialMap,n):this._notifyComplete(n)},L.prototype._loadTextures=function(t,n,a){var i=t.length;this._textureLibrary=new e.AssetLibrary(null,this.options.crossOrigin),this._textureLibrary.fileMap=this.fileMap;for(var r=0;r<i;++r){var s=t[r];s.filename=this._correctURL(s.filename),this._textureLibrary.queueAsset(s.filename,s.filename,e.AssetLibrary.Type.ASSET,e.JPG)}this._textureLibrary.onComplete.bind(function(){for(var t=n.length,e=0;e<t;++e){var i=n[e],r=i.token,s=this._textureLibrary.get(r.filename);switch(s.name=r.name,i.mapType){case P._TextureToken.NORMAL_MAP:i.material.normalMap=s;break;case P._TextureToken.SPECULAR_MAP:i.material.specularMap=s;break;case P._TextureToken.DIFFUSE_MAP:i.material.colorMap=s}}this._notifyComplete(a)},this),this._textureLibrary.load()},t.GLTF=i,t.GLTFData=a,t.MD5Mesh=r,t.MD5Anim=s,t.OBJ=o,t.MTL=h,t.FBX=L,Object.defineProperty(t,"__esModule",{value:!0})});