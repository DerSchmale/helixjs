!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("cannon"),require("helix")):"function"==typeof define&&define.amd?define("HX",["exports","cannon","helix"],e):e(t.HX=t.HX||{},t.CANNON,t.HX)}(this,function(t,e,i){"use strict";function o(t,e,i){this.shape=t,this.offset=e||new HX.Float4,this.orientation=i}function n(){this._shapes=[]}function s(){this._center=null,this._orientation=null,this._positionOffset=null}function r(t,e){s.call(this),t&&e&&(this._halfExtents=HX.Float.subtract(e,t).scale(.5),this._center=HX.Float.add(e,t).scale(.5))}function h(t,e){s.call(this),this._radius=t,this._center=e,void 0!==t&&void 0===e&&(this._center=new HX.Float4)}function a(t,e){i.Component.call(this),this._collider=t,this._body=null,this._mass=e,this._linearDamping=.01,this._angularDamping=.01}function _(){i.EntitySystem.call(this),this._world=new e.World,this._gravity=-9.81,this._world.gravity.set(0,0,this._gravity),this._world.solver.tolerance=1e-4,this._world.solver.iterations=10,this._fixedTimeStep=1e3/60,this._world.broadphase=new e.NaiveBroadphase(this._world),this._components=[]}function p(t,e,i){s.call(this),this._radius=t,this._height=e,this._center=i,this._height<2*this._radius&&(this._height=2*this._radius),void 0!==t&&void 0===i&&(this._center=new HX.Float4)}function c(t){s.call(this),t&&(this._center=new HX.Float4(0,0,t))}function d(t,e,i,o,n){s.call(this),t instanceof HX.Texture2D?this._heightData=this._convertHeightMap(t,i||0,o||1,n):this._heightData=t,this._heightMapWidth=this._heightData.length,this._heightMapHeight=this._heightData[0].length,this._worldSize=e,this._elementSize=this._worldSize/(this._heightMapWidth-1),this._positionOffset=new HX.Float4(-this._elementSize*this._heightMapWidth*.5,-this._elementSize*this._heightMapHeight*.5,0,0)}function u(){HX.Component.call(this),this._move=new HX.Float2,this._walkForce=50,this._runForce=100,this._movementForce=this._walkForce,this._jumpForce=10,this._pitch=0,this._yaw=0,this._mouseX=0,this._mouseY=0,this._jump=0,this._onKeyDown=null,this._onKeyUp=null}n.prototype={get shapes(){return this._shapes},addShape:function(t,e,i){this._shapes.push(new o(t,e,i))}},s.prototype={createRigidBody:function(t){var i=this.createShape(t),o=new e.Body({mass:50*this.volume()});if(this._center||(this._center=t.center),i instanceof n)for(var s=i.shapes,r=0;r<s.length;++r){var h=s[r],a=HX.Float4.add(this._center,h.offset),_=void 0;this._orientation&&(_=this._orientation.clone()),h.orientation&&(_?_.append(h.orientation):_=h.orientation.clone()),o.addShape(h.shape,a,_)}else o.addShape(i,this._center,this._orientation);return o},createShape:function(t){throw new Error("Abstract method called!")},volume:function(){throw new Error("Abstract method called!")}},r.prototype=Object.create(s.prototype),r.prototype.volume=function(){return 8*(this._halfExtents.x*this._halfExtents.y*this._halfExtents.z)},r.prototype.createShape=function(t){this._halfExtents||(this._halfExtents=t.getHalfExtents());var i=new e.Vec3;return i.copy(this._halfExtents),new e.Box(i)},h.prototype=Object.create(s.prototype),h.prototype.volume=function(){var t=this._radius;return.75*Math.PI*t*t*t},h.prototype.createShape=function(t){return this._radius=this._radius||t.getRadius(),new e.Sphere(this._radius)},i.Component.create(a,{body:{get:function(){return this._body}},mass:{get:function(){return this._mass},set:function(t){this._mass=t,this._body&&(this._body.mass=t)}},linearDamping:{get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&(this._body.linearDamping=t)}},angularDamping:{get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&(this._body.angularDamping=t)}}}),a.prototype.addImpulse=function(t,e){this._body.applyImpulse(t,e||this._body.position)},a.prototype.addForce=function(t,e){this._body.applyForce(t,e||this._body.position)},a.prototype.onAdded=function(){this._createBody()},a.prototype.onRemoved=function(){},a.prototype.prepTransform=function(){var t=this._entity,e=this._body,i=t.position,o=t.rotation,n=this._collider._positionOffset;n?e.position.set(i.x+n.x,i.y+n.y,i.z+n.z):e.position.set(i.x,i.y,i.z),e.quaternion.set(o.x,o.y,o.z,o.w)},a.prototype.applyTransform=function(){if(0!==this._mass){var t=this._entity,e=this._body;this._collider._positionOffset?i.Float4.subtract(e.position,this._collider._positionOffset,t.position):t.position=e.position,t.rotation=e.quaternion}},a.prototype._createBody=function(){var t,e=this._entity;if(e instanceof i.ModelInstance)t=e.localBounds;else{var o=new i.Matrix4x4;o.inverseAffineOf(e.worldMatrix),t=new i.BoundingAABB,t.transformFrom(e.worldBounds,o)}this._collider||(this._collider=t instanceof i.BoundingAABB?new r:new h),this._body=this._collider.createRigidBody(t),void 0!==this._mass&&(this._body.mass=this._mass),this._body.linearDamping=this._linearDamping,this._body.angularDamping=this._angularDamping,this._body.position.copy(e.position),this._body.quaternion.copy(e.rotation)},_.prototype=Object.create(i.EntitySystem.prototype,{gravity:{get:function(){return this._gravity},set:function(t){this._gravity=t,t instanceof i.Float4?this._world.gravity.set(t.x,t.y,t.z):this._world.gravity.set(0,t,0)}},fixedTimeStep:{get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}}}),_.prototype.onStarted=function(){this._colliders=this.getEntitySet([a]),this._colliders.onEntityAdded.bind(this._onEntityAdded,this),this._colliders.onEntityRemoved.bind(this._onEntityRemoved,this);for(var t=this._colliders.numEntities,e=0;e<t;++e){var i=this._colliders.getEntity(e);this._onEntityAdded(i)}},_.prototype.onStopped=function(){this._colliders.onEntityAdded.unbind(this._onEntityAdded),this._colliders.onEntityRemoved.unbind(this._onEntityRemoved)},_.prototype._onEntityAdded=function(t){var e=t.getFirstComponentByType(a);this._components.push(e),this._world.addBody(e.body)},_.prototype._onEntityRemoved=function(t){var e=t.getFirstComponentByType(a);this._world.removeBody(e.body);var i=this._components.indexOf(e);this._components.splice(i,1)},_.prototype.onUpdate=function(t){for(var e=this._components.length,i=0;i<e;++i)this._components[i].prepTransform();for(this._world.step(.001*this._fixedTimeStep),i=0;i<e;++i)this._components[i].applyTransform()},p.prototype=Object.create(s.prototype),p.prototype.volume=function(){var t=this._radius,e=this._height-2*this._radius,i=.75*Math.PI*t*t*t,o=Math.PI*t*t*e;return o+i},p.prototype.createShape=function(t){var i=this._height-2*this._radius;this._radius=this._radius||t.getRadius();var o=new n;return o.addShape(new e.Sphere(this._radius),new HX.Float4(0,0,.5*-i)),o.addShape(new e.Sphere(this._radius),new HX.Float4(0,0,.5*i)),o.addShape(new e.Cylinder(this._radius,this._radius,i,10)),o},c.prototype=Object.create(s.prototype),c.prototype.volume=function(){return 0},c.prototype.createShape=function(t){return new CANNON.Plane},d.prototype=Object.create(s.prototype),d.prototype.volume=function(){return 0},d.prototype.createShape=function(t){return new e.Heightfield(this._heightData,{elementSize:this._elementSize})},d.prototype._convertHeightMap=function(t,e,i,o){var n=t.width,s=t.height,r=new HX.Texture2D;r.initEmpty(n,s,HX.TextureFormat.RGBA,t.dataType);var h=new HX.FrameBuffer(r);h.init(),HX.GL.setRenderTarget(h),HX.GL.clear(),HX.BlitTexture.execute(t);var a,_=n*s*4;if(t.dataType===HX.DataType.FLOAT)a=new Float32Array(_);else{if(t.dataType!==HX.DataType.UNSIGNED_BYTE)throw new Error("Invalid dataType!");a=new Uint8Array(_)}HX.GL.gl.readPixels(0,0,n,s,HX.TextureFormat.RGBA,t.dataType,a);var p=[],c=i-e;o&&(c/=255);for(var d=0;d<n;++d){p[d]=[];for(var u=0;u<s;++u){var l=d+u*n<<2,y=a[l];o&&(y+=a[l+1]/255+a[l+2]/65025+a[l+3]/16581375),p[d][u]=e+y*c}}return p},HX.Component.create(u,{walkForce:{get:function(){return this._walkForce},set:function(t){this._walkForce=t}},runForce:{get:function(){return this._runForce},set:function(t){this._runForce=t}},jumpForce:{get:function(){return this._jumpForce},set:function(t){this._jumpForce=t}},pitch:{get:function(){return this._pitch},set:function(t){this._pitch=t}},yaw:{get:function(){return this._yaw},set:function(t){this._yaw=t}}}),u.prototype.onAdded=function(t){var e=this;this._onKeyDown=function(t){var i="which"in t?t.which:t.keyCode;switch(i){case 16:e._movementForce=e._runForce;break;case 32:e._jump=e._jumpForce;break;case 87:e._setForward(1);break;case 83:e._setForward(-1);break;case 65:e._setStride(-1);break;case 68:e._setStride(1)}},this._onKeyUp=function(t){var i="which"in t?t.which:t.keyCode;switch(i){case 16:e._movementForce=e._walkForce;break;case 87:case 83:e._setForward(0);break;case 65:case 68:e._setStride(0)}},this._onMouseMove=function(t){t=t||window.event,e._addPitch((e._mouseY-t.clientY)/100),e._addYaw(-(e._mouseX-t.clientX)/100),e._mouseX=t.clientX,e._mouseY=t.clientY},this._onMouseDown=function(t){e._mouseX=t.clientX,e._mouseY=t.clientY,HX.META.TARGET_CANVAS.addEventListener("mousemove",e._onMouseMove)},this._onMouseUp=function(t){HX.META.TARGET_CANVAS.removeEventListener("mousemove",e._onMouseMove)},document.addEventListener("keydown",this._onKeyDown),document.addEventListener("keyup",this._onKeyUp),HX.META.TARGET_CANVAS.addEventListener("mousedown",this._onMouseDown),HX.META.TARGET_CANVAS.addEventListener("mouseup",this._onMouseUp)},u.prototype.onRemoved=function(t){document.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("keyup",this._onKeyUp),HX.META.TARGET_CANVAS.removeEventListener("mousemove",this._onMouseMove),HX.META.TARGET_CANVAS.removeEventListener("mousedown",this._onMouseDown),HX.META.TARGET_CANVAS.removeEventListener("mouseup",this._onMouseUp)},u.prototype.onUpdate=function(t){var e=new HX.Float2,i=new HX.Float2,o=new HX.Float4;return function(t){this._rigidBody=this.entity.getFirstComponentByType(a);var n=.5*Math.PI-.001;this._pitch<-n?this._pitch=-n:this._pitch>n&&(this._pitch=n),this.entity.rotation.fromPitchYawRoll(this._pitch,this._yaw,0);var s=this.entity.matrix,r=s._m;e.set(r[0],r[1]),i.set(r[4],r[5]),e.normalize(),i.normalize(),o.x=(this._move.x*e.x+this._move.y*i.x)*this._movementForce,o.y=(this._move.x*e.y+this._move.y*i.y)*this._movementForce,o.z=this._jump,this._jump=0,this._rigidBody.addImpulse(o)}}(),u.prototype._setForward=function(t){this._move.y=t},u.prototype._setStride=function(t){this._move.x=t},u.prototype._addPitch=function(t){this._pitch+=t},u.prototype._addYaw=function(t){this._yaw+=t},t.PhysicsSystem=_,t.RigidBody=a,t.BoxCollider=r,t.CapsuleCollider=p,t.SphereCollider=h,t.InfinitePlaneCollider=c,t.HeightfieldCollider=d,t.PlayerController=u,Object.defineProperty(t,"__esModule",{value:!0})});