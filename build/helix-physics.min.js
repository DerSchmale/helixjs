!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("helix"),require("cannon")):"function"==typeof define&&define.amd?define("HX_PHYS",["exports","helix","cannon"],e):e(t.HX_PHYS={},t.HX,t.CANNON)}(this,function(t,u,h){"use strict";function o(t,e,i){this.shape=t,this.offset=e||new u.Float4,this.orientation=i}function _(){this._shapes=[]}function s(){this._center=null,this._orientation=null,this._positionOffset=null}function n(t,e){s.call(this),t&&e&&(this._halfExtents=u.Float4.subtract(e,t).scale(.5),this._center=u.Float4.add(e,t).scale(.5))}function r(t,e){s.call(this),this._radius=t,this._center=e,void 0!==t&&void 0===e&&(this._center=new u.Float4)}function a(){this.rigidBody=null,this.entity=null,this.contactPoint=new HX.Float4(0,0,0,1),this.contactNormal=new HX.Float4(0,0,0,0),this.relativeVelocity=new HX.Float4(0,0,0,0)}function c(t,e,i){u.Component.call(this),this._collider=t,this._body=null,this._ignoreRotation=!1,this._isKinematic=!1,this._mass=e,this._linearDamping=.01,this._angularDamping=.01,this._material=i,this._collision=new a,this._onCollision=this._onCollision.bind(this)}function e(){u.EntitySystem.call(this),this._world=new h.World,this._gravity=-9.81,this._world.gravity.set(0,0,this._gravity),this._world.solver.tolerance=1e-4,this._world.solver.iterations=10,this._fixedTimeStep=1e3/60,this._world.broadphase=new h.SAPBroadphase(this._world),this._world.allowSleep=!0,this._components=[]}function i(t,e,i){s.call(this),this._radius=t,this._height=e,this._center=i,this._height<2*this._radius&&(this._height=2*this._radius),void 0!==t&&void 0===i&&(this._center=new u.Float4)}function d(t){s.call(this),t&&(this._center=new u.Float4(0,0,t))}function l(t,e,i,o,n){s.call(this),t instanceof u.Texture2D?(void 0===o&&(o=1),void 0===i&&(i=0),this._heightData=this._convertHeightMap(t,o-i,n)):(this._heightData=t,i=this._shiftHeightData()),this._heightMapWidth=this._heightData.length,this._heightMapHeight=this._heightData[0].length,this._worldSize=e,this._elementSize=this._worldSize/(this._heightMapWidth-1),this._positionOffset=new u.Float4(-this._elementSize*this._heightMapWidth*.5,-this._elementSize*this._heightMapHeight*.5,i,0)}function p(t,e){this._cannonMaterial=new CANNON.Material({friction:t,restitution:e})}function y(){u.Component.call(this),this._move=new u.Float2,this._walkForce=50,this._runForce=100,this._movementForce=this._walkForce,this._jumpForce=10,this._pitch=0,this._yaw=0,this._mouseX=0,this._mouseY=0,this._jump=0,this._onKeyDown=null,this._onKeyUp=null}var m,f,v;_.prototype={get shapes(){return this._shapes},addShape:function(t,e,i){this._shapes.push(new o(t,e,i))}},s.prototype={createRigidBody:function(t){var e=this.createShape(t),i=new h.Body({mass:50*this.volume()});if(this._center||(this._center=t.center),e instanceof _)for(var o=e.shapes,n=0;n<o.length;++n){var s=o[n],r=u.Float4.add(this._center,s.offset),a=void 0;this._orientation&&(a=this._orientation.clone()),s.orientation&&(a?a.append(s.orientation):a=s.orientation.clone()),i.addShape(s.shape,r,a)}else i.addShape(e,this._center,this._orientation);return i},createShape:function(t){throw new Error("Abstract method called!")},volume:function(){throw new Error("Abstract method called!")}},(n.prototype=Object.create(s.prototype)).volume=function(){return this._halfExtents.x*this._halfExtents.y*this._halfExtents.z*8},n.prototype.createShape=function(t){this._halfExtents||(this._halfExtents=t.getHalfExtents());var e=new h.Vec3;return e.copy(this._halfExtents),new h.Box(e)},(r.prototype=Object.create(s.prototype)).volume=function(){var t=this._radius;return.75*Math.PI*t*t*t},r.prototype.createShape=function(t){return this._radius=this._radius||t.getRadius(),new h.Sphere(this._radius)},c.COLLISION_MESSAGE="collision",u.Component.create(c,{isKinematic:{get:function(){return this._isKinematic},set:function(t){this._isKinematic=t,this._body&&(this._body.type=CANNON.Body.KINEMATIC)}},ignoreRotation:{get:function(){return this._ignoreRotation},set:function(t){this._ignoreRotation=t,this._body&&(this._body.fixedRotation=t)}},body:{get:function(){return this._body}},mass:{get:function(){return this._mass},set:function(t){this._mass=t,this._body&&(this._body.mass=t,this._body.updateMassProperties())}},linearDamping:{get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&(this._body.linearDamping=t)}},angularDamping:{get:function(){return this._angularDamping},set:function(t){this._angularDamping=t}},material:{get:function(){return this._material},set:function(t){this._material=t,this._body&&(this._body.material=t?t._cannonMaterial:null)}}}),c.prototype.addImpulse=function(t,e){if(e)this._body.applyImpulse(t,e);else{var i=this._body.velocity;i.x+=t.x,i.y+=t.y,i.z+=t.z}this._body.wakeUp()},c.prototype.addForce=function(t,e){if(e)this._body.applyForce(t,e);else{var i=this._body.force;i.x+=t.x,i.y+=t.y,i.z+=t.z}this._body.wakeUp()},c.prototype.onAdded=function(){this._createBody()},c.prototype.onRemoved=function(){this._body.removeEventListener("collide",this._onCollision),this._body=null},c.prototype.prepTransform=function(){var t=this._entity,e=this._body,i=t.position,o=this._collider._positionOffset;if(o?e.position.set(i.x+o.x,i.y+o.y,i.z+o.z):e.position.set(i.x,i.y,i.z),this._ignoreRotation)e.quaternion.set(0,0,0,1);else{var n=t.rotation;e.quaternion.set(n.x,n.y,n.z,n.w)}},c.prototype.applyTransform=function(){if(0!==this._mass){var t=this._entity,e=this._body;this._collider._positionOffset?u.Float4.subtract(e.position,this._collider._positionOffset,t.position):t.position=e.position,this._ignoreRotation||(t.rotation=e.quaternion)}},c.prototype._createBody=function(){var t=this._entity,e=t.getComponentsByType(u.MeshInstance),i=1===e.length?e[0].mesh.bounds:t.bounds;this._collider||(this._collider=i instanceof u.BoundingAABB?new n:new r),this._body=this._collider.createRigidBody(i),(this._body._hx_rigidBody=this)._body.addEventListener("collide",this._onCollision),this._isKinematic&&(this._body.type=CANNON.Body.KINEMATIC),void 0!==this._mass&&(this._body.mass=this._mass),void 0!==this._material&&(this._body.material=this._material._cannonMaterial),this._body.linearDamping=this._linearDamping,this._body.angularDamping=this._angularDamping,this._body.position.copy(t.position),this._body.fixedRotation=this._ignoreRotation,this._ignoreRotation||this._body.quaternion.copy(t.rotation),this._body.updateMassProperties()},c.prototype.clone=function(){var t=new c(this._collider,this._mass,this._material);return t.linearDamping=this.linearDamping,t.angularDamping=this.angularDamping,t.isKinematic=this._isKinematic,t},c.prototype._onCollision=function(t){if(this.hasListeners(c.COLLISION_MESSAGE)){var e,i,o,n,s=this._collision,r=t.body._hx_rigidBody,a=t.contact;s.rigidBody=r,s.entity=r._entity;var h=a.ni;a.bi===this._body?(o=a.bi.velocity,n=a.bj.velocity,e=a.bi,i=a.ri,s.contactNormal.set(h.x,h.y,h.z)):(o=a.bj.velocity,n=a.bi.velocity,e=a.bj,i=a.rj,s.contactNormal.set(-h.x,-h.y,-h.z)),s.relativeVelocity.set(o.x-n.x,o.y-n.y,o.z-n.z,0),s.contactPoint.set(e.x+i.x,e.y+i.y,e.z+i.z,1),this.broadcast(c.COLLISION_MESSAGE,s)}},(e.prototype=Object.create(u.EntitySystem.prototype,{gravity:{get:function(){return this._gravity},set:function(t){(this._gravity=t)instanceof u.Float4?this._world.gravity.set(t.x,t.y,t.z):this._world.gravity.set(0,t,0)}},fixedTimeStep:{get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}}})).onStarted=function(){this._colliders=this.getEntitySet([c]),this._colliders.onEntityAdded.bind(this._onEntityAdded,this),this._colliders.onEntityRemoved.bind(this._onEntityRemoved,this);for(var t=this._colliders.numEntities,e=0;e<t;++e){var i=this._colliders.getEntity(e);this._onEntityAdded(i)}},e.prototype.onStopped=function(){this._colliders.onEntityAdded.unbind(this._onEntityAdded),this._colliders.onEntityRemoved.unbind(this._onEntityRemoved),this._colliders.free(),this._colliders=null},e.prototype._onEntityAdded=function(t){var e=t.getFirstComponentByType(c);this._components.push(e),this._world.addBody(e.body)},e.prototype._onEntityRemoved=function(t){var e=t.getFirstComponentByType(c);this._world.removeBody(e.body);var i=this._components.indexOf(e);this._components.splice(i,1)},e.prototype.onUpdate=function(t){for(var e=this._components.length,i=0;i<e;++i)this._components[i].prepTransform();for(this._world.step(.001*this._fixedTimeStep),i=0;i<e;++i)this._components[i].applyTransform()},(i.prototype=Object.create(s.prototype)).volume=function(){var t=this._radius,e=this._height-2*this._radius,i=.75*Math.PI*t*t*t;return Math.PI*t*t*e+i},i.prototype.createShape=function(t){var e=this._height-2*this._radius;this._radius=this._radius||t.getRadius();var i=new _,o=new h.Sphere(this._radius);return i.addShape(o,new u.Float4(0,0,.5*-e)),i.addShape(o,new u.Float4(0,0,.5*e)),i.addShape(new h.Cylinder(this._radius,this._radius,e,10)),i},(d.prototype=Object.create(s.prototype)).volume=function(){return 0},d.prototype.createShape=function(t){return new CANNON.Plane},(l.prototype=Object.create(s.prototype)).volume=function(){return 0},l.prototype.createShape=function(t){return new h.Heightfield(this._heightData,{elementSize:this._elementSize})},l.prototype._convertHeightMap=function(t,e,i){var o=t.width,n=t.height,s=new u.Texture2D;s.initEmpty(o,n,u.TextureFormat.RGBA,t.dataType);var r=new u.FrameBuffer(s);r.init(),u.GL.setRenderTarget(r),u.GL.clear(),u.BlitTexture.execute(t);var a,h=o*n*4;if(t.dataType===u.DataType.FLOAT)a=new Float32Array(h);else{if(t.dataType!==u.DataType.UNSIGNED_BYTE)throw new Error("Invalid dataType!");a=new Uint8Array(h)}u.GL.gl.readPixels(0,0,o,n,u.TextureFormat.RGBA,t.dataType,a);var _=[];i&&(e/=255);for(var c=0;c<o;++c){_[c]=[];for(var d=0;d<n;++d){var l=c+d*o<<2,p=a[l];i&&(p+=a[l+1]/255+a[l+2]/65025+a[l+3]/16581375),_[c][d]=p*e}}return _},l.prototype._shiftHeightData=function(){for(var t=this._heightData,e=t.width,i=t.height,o=0,n=0;n<e;++n)for(var s=0;s<i;++s)t[n][s]<o&&(o=t[n][s]);if(0!==o){for(n=0;n<e;++n)for(s=0;s<i;++s)t[n][s]+=o;return o}},p.prototype={get friction(){return this._cannonMaterial.friction},set friction(t){this._cannonMaterial.friction=t},get restitution(){return this._cannonMaterial.restitution},set restitution(t){this._cannonMaterial.restitution=t}},u.Component.create(y,{walkForce:{get:function(){return this._walkForce},set:function(t){this._movementForce=t,this._walkForce=t}},runForce:{get:function(){return this._runForce},set:function(t){this._runForce=t}},jumpForce:{get:function(){return this._jumpForce},set:function(t){this._jumpForce=t}},pitch:{get:function(){return this._pitch},set:function(t){this._pitch=t}},yaw:{get:function(){return this._yaw},set:function(t){this._yaw=t}}}),y.prototype.onAdded=function(t){var e=this;this._onKeyDown=function(t){switch("which"in t?t.which:t.keyCode){case 16:e._movementForce=e._runForce;break;case 32:e._jump=e._jumpForce;break;case 87:e._setForward(1);break;case 83:e._setForward(-1);break;case 65:e._setStride(-1);break;case 68:e._setStride(1)}},this._onKeyUp=function(t){switch("which"in t?t.which:t.keyCode){case 16:e._movementForce=e._walkForce;break;case 87:case 83:e._setForward(0);break;case 65:case 68:e._setStride(0)}},this._onMouseMove=function(t){t=t||window.event,e._addPitch((e._mouseY-t.clientY)/100),e._addYaw(-(e._mouseX-t.clientX)/100),e._mouseX=t.clientX,e._mouseY=t.clientY},this._onMouseDown=function(t){e._mouseX=t.clientX,e._mouseY=t.clientY,u.META.TARGET_CANVAS.addEventListener("mousemove",e._onMouseMove)},this._onMouseUp=function(t){u.META.TARGET_CANVAS.removeEventListener("mousemove",e._onMouseMove)},document.addEventListener("keydown",this._onKeyDown),document.addEventListener("keyup",this._onKeyUp),u.META.TARGET_CANVAS.addEventListener("mousedown",this._onMouseDown),u.META.TARGET_CANVAS.addEventListener("mouseup",this._onMouseUp)},y.prototype.onRemoved=function(t){document.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("keyup",this._onKeyUp),u.META.TARGET_CANVAS.removeEventListener("mousemove",this._onMouseMove),u.META.TARGET_CANVAS.removeEventListener("mousedown",this._onMouseDown),u.META.TARGET_CANVAS.removeEventListener("mouseup",this._onMouseUp)},y.prototype.onUpdate=(m=new u.Float2,f=new u.Float2,v=new u.Float4,function(t){this._rigidBody=this.entity.getFirstComponentByType(c);var e=.5*Math.PI-.001;this._pitch<-e?this._pitch=-e:this._pitch>e&&(this._pitch=e),this.entity.rotation.fromPitchYawRoll(this._pitch,this._yaw,0);var i=this.entity.matrix._m;m.set(i[0],i[1]),f.set(i[4],i[5]),m.normalize(),f.normalize(),v.x=(this._move.x*m.x+this._move.y*f.x)*this._movementForce,v.y=(this._move.x*m.y+this._move.y*f.y)*this._movementForce,v.z=0,this._rigidBody.addForce(v),this._jump&&(v.x=0,v.y=0,v.z=this._jump,this._rigidBody.addImpulse(v),this._jump=0)}),y.prototype._setForward=function(t){this._move.y=t},y.prototype._setStride=function(t){this._move.x=t},y.prototype._addPitch=function(t){this._pitch+=t},y.prototype._addYaw=function(t){this._yaw+=t},y.prototype.clone=function(){var t=new y;return t.walkForce=this.walkForce,t.runForce=this.runForce,t.jumpForce=this.jumpForce,t.pitch=this.pitch,t.yaw=this.yaw,t},t.PhysicsSystem=e,t.RigidBody=c,t.BoxCollider=n,t.CapsuleCollider=i,t.SphereCollider=r,t.InfinitePlaneCollider=d,t.HeightfieldCollider=l,t.PhysicsMaterial=p,t.FPSController=y,t.Collision=a,Object.defineProperty(t,"__esModule",{value:!0})});