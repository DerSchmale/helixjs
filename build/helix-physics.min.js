!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("helix"),require("cannon")):"function"==typeof define&&define.amd?define("HX_PHYS",["exports","helix","cannon"],i):i(t.HX_PHYS={},t.HX,t.CANNON)}(this,function(t,y,h){"use strict";function n(t,i,e){this.shape=t,this.offset=i||new y.Float4,this.orientation=e}function l(){this._shapes=[]}function s(){this._center=null,this._orientation=null}function o(t,i){s.call(this),t&&i&&(this._halfExtents=y.Float4.subtract(i,t).scale(.5),this._center=y.Float4.add(i,t).scale(.5))}function a(t,i){s.call(this),this._radius=t,this._center=i}function r(){this.rigidBody=null,this.entity=null,this.contactPoint=new y.Float4(0,0,0,1),this.contactNormal=new y.Float4(0,0,0,0),this.relativeVelocity=new y.Float4(0,0,0,0)}l.prototype={get shapes(){return this._shapes},addShape:function(t,i,e){this._shapes.push(new n(t,i,e))}},s.prototype={createRigidBody:function(t){this._center||(this._center=t.center);var i=this.createShape(t),e=new h.Body({mass:50*this.volume()});if(i instanceof l)for(var n=i.shapes,o=0;o<n.length;++o){var s=n[o],a=y.Float4.add(this._center,s.offset),r=void 0;this._orientation&&(r=this._orientation.clone()),s.orientation&&(r?r.append(s.orientation):r=s.orientation.clone()),e.addShape(s.shape,a,r)}else e.addShape(i,this._center,this._orientation);return e},createShape:function(t){throw new Error("Abstract method called!")},volume:function(){throw new Error("Abstract method called!")}},(o.prototype=Object.create(s.prototype)).volume=function(){return this._halfExtents.x*this._halfExtents.y*this._halfExtents.z*8},o.prototype.createShape=function(t){this._halfExtents||(this._halfExtents=t.getHalfExtents());var i=new h.Vec3;return i.copy(this._halfExtents),new h.Box(i)},(a.prototype=Object.create(s.prototype)).volume=function(){var t=this._radius;return.75*Math.PI*t*t*t},a.prototype.createShape=function(t){return this._radius=this._radius||t.getRadius(),new h.Sphere(this._radius)};var e=new y.Matrix4x4,d=new y.Quaternion;function _(t,i,e){y.Component.call(this),this._collider=t,this._body=null,this._ignoreRotation=!1,this._isKinematic=!1,this._mass=i,this._linearDamping=.01,this._angularDamping=.01,this._material=e,this._linearVelocity=new y.Float4,this._angularVelocity=new y.Float4,this._collision=new r,this._onCollision=this._onCollision.bind(this)}function i(){y.EntitySystem.call(this),this._world=new h.World,this._gravity=-9.81,this._world.gravity.set(0,0,this._gravity),this._world.solver.tolerance=1e-4,this._world.solver.iterations=10,this._fixedTimeStep=1e3/60,this._world.broadphase=new h.SAPBroadphase(this._world),this._world.allowSleep=!0,this._components=[]}function c(t,i,e){s.call(this),this._radius=t,this._height=i,this._center=e,this._height<2*this._radius&&(this._height=2*this._radius)}function p(t,i,e,n){s.call(this),this._radius=t,this._height=i,this._center=n,e&&(e.normalize(),this._orientation=y.Quaternion.fromVectors(y.Float4.Z_AXIS,e))}function u(t,i,e){s.call(this),this._thickness=t||.1,i&&e&&(this._halfExtents=y.Float4.subtract(e,i).scale(.5),this._center=y.Float4.add(e,i).scale(.5))}function f(t){s.call(this),t&&(this._center=new y.Float4(0,0,t))}function g(t,i,e,n,o){s.call(this),t instanceof y.Texture2D?(void 0===n&&(n=1),void 0===e&&(e=0),this._heightData=this._convertHeightMap(t,n-e,o)):(this._heightData=t,e=this._shiftHeightData()),this._heightMapWidth=this._heightData.length,this._heightMapHeight=this._heightData[0].length,this._worldSize=i,this._elementSize=this._worldSize/(this._heightMapWidth-1),this._center=new y.Float4(-this._elementSize*this._heightMapWidth*.5,-this._elementSize*this._heightMapHeight*.5,e,0)}function m(t,i){this._cannonMaterial=new h.Material({friction:t,restitution:i})}_.COLLISION_MESSAGE="collision",y.Component.create(_,{linearVelocity:{get:function(){return this._linearVelocity.copyFrom(this._body.velocity),this._linearVelocity},set:function(t){this._body.velocity.set(t.x,t.y,t.z)}},angularVelocity:{get:function(){return this._angularVelocity.copyFrom(this._body.angularVelocity),this._angularVelocity},set:function(t){this._body.angularVelocity.set(t.x,t.y,t.z)}},isKinematic:{get:function(){return this._isKinematic},set:function(t){this._isKinematic=t,this._body&&(this._body.type=CANNON.Body.KINEMATIC,this._body.allowSleep=!1,this._body.wakeUp())}},ignoreRotation:{get:function(){return this._ignoreRotation},set:function(t){this._ignoreRotation=t,this._body&&(this._body.fixedRotation=t)}},body:{get:function(){return this._body}},mass:{get:function(){return this._mass},set:function(t){this._mass=t,this._body&&(this._body.mass=t,this._body.updateMassProperties())}},linearDamping:{get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&(this._body.linearDamping=t)}},angularDamping:{get:function(){return this._angularDamping},set:function(t){this._angularDamping=t}},material:{get:function(){return this._material},set:function(t){this._material=t,this._body&&(this._body.material=t?t._cannonMaterial:null)}}}),_.prototype.addImpulse=function(t,i){if(i)this._body.applyImpulse(t,i);else{var e=this._body.velocity;e.x+=t.x,e.y+=t.y,e.z+=t.z}this._body.wakeUp()},_.prototype.addForce=function(t,i){if(i)this._body.applyForce(t,i);else{var e=this._body.force;e.x+=t.x,e.y+=t.y,e.z+=t.z}this._body.wakeUp()},_.prototype.onAdded=function(){this._createBody(),this._body.addEventListener("collide",this._onCollision)},_.prototype.onRemoved=function(){this._body.removeEventListener("collide",this._onCollision),this._body=null},_.prototype.prepTransform=function(){var t,i=this._entity,e=this._body,n=e.position,o=e.quaternion,s=i.worldMatrix;(s.getColumn(3,n),this._ignoreRotation)?o.set(0,0,0,1):(i._isOnRoot?t=i.rotation:(t=d).fromMatrix(s),o.copy(t))},_.prototype.applyTransform=function(){var t=this._body;if(0!==this._mass&&!this._isKinematic&&t.sleepState===CANNON.Body.AWAKE){var i=this._entity;i.disableMatrixUpdates(),i._isOnRoot?(i.position=t.position,this._ignoreRotation||(i.rotation=t.quaternion)):(e.inverseAffineOf(i._parent.worldMatrix),e.transformPoint(t.position,i.position),e.transformQuaternion(t.quaternion,i.rotation)),i.enableMatrixUpdates()}},_.prototype._createBody=function(){var t=this._entity,i=t.getComponentsByType(y.MeshInstance),e=1===i.length?i[0].mesh.bounds:t.bounds;this._collider||(this._collider=e instanceof y.BoundingAABB?new o:new a),this._body=this._collider.createRigidBody(e),(this._body._hx_rigidBody=this)._isKinematic&&(this._body.type=CANNON.Body.KINEMATIC,this._body.allowSleep=!1),void 0!==this._mass&&(this._body.mass=this._mass),void 0!==this._material&&(this._body.material=this._material._cannonMaterial),this._body.linearDamping=this._linearDamping,this._body.angularDamping=this._angularDamping,this._body.position.copy(t.position),this._body.fixedRotation=this._ignoreRotation,this._ignoreRotation||this._body.quaternion.copy(t.rotation),this._body.updateMassProperties()},_.prototype.clone=function(){var t=new _(this._collider,this._mass,this._material);return t.linearDamping=this.linearDamping,t.angularDamping=this.angularDamping,t.isKinematic=this._isKinematic,t},_.prototype._onCollision=function(t){if(this.hasListeners(_.COLLISION_MESSAGE)){var i,e,n,o,s=this._collision,a=t.body._hx_rigidBody,r=t.contact;s.rigidBody=a,s.entity=a._entity;var h=r.ni;r.bi===this._body?(n=r.bi.velocity,o=r.bj.velocity,i=r.bi.position,e=r.ri,s.contactNormal.set(h.x,h.y,h.z)):(n=r.bj.velocity,o=r.bi.velocity,i=r.bj.position,e=r.rj,s.contactNormal.set(-h.x,-h.y,-h.z)),s.relativeVelocity.set(n.x-o.x,n.y-o.y,n.z-o.z,0),s.contactPoint.set(i.x+e.x,i.y+e.y,i.z+e.z,1),this.broadcast(_.COLLISION_MESSAGE,s)}},(i.prototype=Object.create(y.EntitySystem.prototype,{gravity:{get:function(){return this._gravity},set:function(t){(this._gravity=t)instanceof y.Float4?this._world.gravity.set(t.x,t.y,t.z):this._world.gravity.set(0,t,0)}},fixedTimeStep:{get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}},allowSleep:{get:function(){return this._world.allowSleep},set:function(t){this._world.allowSleep=t}}})).onStarted=function(){this._colliders=this.getEntitySet([_]),this._colliders.onEntityAdded.bind(this._onEntityAdded,this),this._colliders.onEntityRemoved.bind(this._onEntityRemoved,this);for(var t=this._colliders.numEntities,i=0;i<t;++i){var e=this._colliders.getEntity(i);this._onEntityAdded(e)}},i.prototype.onStopped=function(){this._colliders.onEntityAdded.unbind(this._onEntityAdded),this._colliders.onEntityRemoved.unbind(this._onEntityRemoved),this._colliders.free(),this._colliders=null},i.prototype._onEntityAdded=function(t){var i=t.getFirstComponentByType(_);this._components.push(i),this._world.addBody(i.body)},i.prototype._onEntityRemoved=function(t){var i=t.getFirstComponentByType(_);this._world.removeBody(i.body);var e=this._components.indexOf(i);this._components.splice(e,1)},i.prototype.onUpdate=function(t){for(var i=this._components.length,e=0;e<i;++e)this._components[e].prepTransform();for(this._world.step(.001*this._fixedTimeStep),e=0;e<i;++e)this._components[e].applyTransform()},(c.prototype=Object.create(s.prototype)).volume=function(){var t=this._radius,i=this._height-2*this._radius,e=.75*Math.PI*t*t*t;return Math.PI*t*t*i+e},c.prototype.createShape=function(t){this._height||(this._height=2*t.halfExtents.y);var i=this._height-2*this._radius;if(!this._radius){var e=new y.Float2;e.set(t.halfExtents),this._radius=e.length}var n=new l,o=new h.Sphere(this._radius);return n.addShape(o,new y.Float4(0,0,.5*-i)),n.addShape(o,new y.Float4(0,0,.5*i)),n.addShape(new h.Cylinder(this._radius,this._radius,i,10)),n},(p.prototype=Object.create(s.prototype)).volume=function(){return Math.PI*this._radius*this._radius*this._height},p.prototype.createShape=function(t){if(!this._radius){var i=new y.Float2;i.set(t.halfExtent),this._radius=i.length}return this._height||(this._height=2*t.halfExtent.z),new h.Cylinder(this._radius,this._radius,this._height,10)},(u.prototype=Object.create(s.prototype)).volume=function(){return this._halfExtents.x*this._halfExtents.y*this._halfExtents.z*8},u.prototype.createShape=function(t){this._halfExtents||(this._halfExtents=t.getHalfExtents());var i=new l,e=this._thickness,n=.5*e,o=this._halfExtents;return i.addShape(new h.Box(new h.Vec3(n,o.y+e,o.z)),new h.Vec3(o.x+n,0,0)),i.addShape(new h.Box(new h.Vec3(n,o.y+e,o.z)),new h.Vec3(-(o.x+n),0,0)),i.addShape(new h.Box(new h.Vec3(o.x+e,n,o.z)),new h.Vec3(0,o.y+n,0)),i.addShape(new h.Box(new h.Vec3(o.x+e,n,o.z)),new h.Vec3(0,-(o.y+n),0)),i.addShape(new h.Box(new h.Vec3(o.x,o.y,n)),new h.Vec3(0,0,o.z+n)),i.addShape(new h.Box(new h.Vec3(o.x,o.y,n)),new h.Vec3(0,0,-(o.z+n))),i},(f.prototype=Object.create(s.prototype)).volume=function(){return 0},f.prototype.createShape=function(t){return new h.Plane},(g.prototype=Object.create(s.prototype)).volume=function(){return 0},g.prototype.createShape=function(t){return new h.Heightfield(this._heightData,{elementSize:this._elementSize})},g.prototype._convertHeightMap=function(t,i,e){var n=t.width,o=t.height,s=new y.Texture2D;s.initEmpty(n,o,y.TextureFormat.RGBA,t.dataType);var a=new y.FrameBuffer(s);a.init(),y.GL.setRenderTarget(a),y.GL.clear(),y.BlitTexture.execute(t);var r,h=n*o*4;if(t.dataType===y.DataType.FLOAT)r=new Float32Array(h);else{if(t.dataType!==y.DataType.UNSIGNED_BYTE)throw new Error("Invalid dataType!");r=new Uint8Array(h)}y.GL.gl.readPixels(0,0,n,o,y.TextureFormat.RGBA,t.dataType,r);var l=[];e&&(i/=255);for(var d=0;d<n;++d){l[d]=[];for(var _=0;_<o;++_){var c=d+_*n<<2,p=r[c];e&&(p+=r[c+1]/255+r[c+2]/65025+r[c+3]/16581375),l[d][_]=p*i}}return l},g.prototype._shiftHeightData=function(){for(var t=this._heightData,i=t.width,e=t.height,n=0,o=0;o<i;++o)for(var s=0;s<e;++s)t[o][s]<n&&(n=t[o][s]);if(0!==n){for(o=0;o<i;++o)for(s=0;s<e;++s)t[o][s]+=n;return n}},m.prototype={get friction(){return this._cannonMaterial.friction},set friction(t){this._cannonMaterial.friction=t},get restitution(){return this._cannonMaterial.restitution},set restitution(t){this._cannonMaterial.restitution=t}},t.PhysicsSystem=i,t.RigidBody=_,t.BoxCollider=o,t.CapsuleCollider=c,t.CylinderCollider=p,t.InvertedBoxCollider=u,t.SphereCollider=a,t.InfinitePlaneCollider=f,t.HeightfieldCollider=g,t.PhysicsMaterial=m,t.Collision=r,Object.defineProperty(t,"__esModule",{value:!0})});