!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("HX",["exports"],e):e(t.HX={})}(this,function(t){"use strict";var d={_files:{},get:function(t,e){var i="";for(var n in e)e.hasOwnProperty(n)&&(i+="#define "+n+" "+e[n]+"\n");return i+d._files[t]}};d._files["debug_bounds_fragment.glsl"]="uniform vec4 color;\n\nvoid main()\n{\n    hx_FragColor = color;\n}",d._files["debug_bounds_vertex.glsl"]="vertex_attribute vec4 hx_position;\n\nuniform mat4 hx_wvpMatrix;\n\nvoid main()\n{\n    gl_Position = hx_wvpMatrix * hx_position;\n}",d._files["lighting_blinn_phong.glsl"]="/*// schlick-beckman\nfloat hx_lightVisibility(vec3 normal, vec3 viewDir, float roughness, float nDotL)\n{\n\tfloat nDotV = max(-dot(normal, viewDir), 0.0);\n\tfloat r = roughness * roughness * 0.797896;\n\tfloat g1 = nDotV * (1.0 - r) + r;\n\tfloat g2 = nDotL * (1.0 - r) + r;\n    return .25 / (g1 * g2);\n}*/\n\nfloat hx_blinnPhongDistribution(float roughness, vec3 normal, vec3 halfVector)\n{\n\tfloat roughnessSqr = clamp(roughness * roughness, 0.0001, .9999);\n//\troughnessSqr *= roughnessSqr;\n\tfloat halfDotNormal = max(-dot(halfVector, normal), 0.0);\n\treturn pow(halfDotNormal, 2.0/roughnessSqr - 2.0) / roughnessSqr;\n}\n\nvoid hx_brdf(in HX_GeometryData geometry, in vec3 lightDir, in vec3 viewDir, in vec3 viewPos, in vec3 lightColor, vec3 normalSpecularReflectance, out vec3 diffuseColor, out vec3 specularColor)\n{\n\tfloat nDotL = max(-dot(lightDir, geometry.normal), 0.0);\n\tvec3 irradiance = nDotL * lightColor;\t// in fact irradiance / PI\n\n\tvec3 halfVector = normalize(lightDir + viewDir);\n\n\tfloat distribution = hx_blinnPhongDistribution(geometry.roughness, geometry.normal, halfVector);\n\n\tfloat halfDotLight = max(dot(halfVector, lightDir), 0.0);\n\tfloat cosAngle = 1.0 - halfDotLight;\n\t// to the 5th power\n\tvec3 fresnel = normalSpecularReflectance + (1.0 - normalSpecularReflectance)*pow(cosAngle, 5.0);\n\n// / PI factor is encoded in light colour\n\tdiffuseColor = irradiance;\n\tspecularColor = irradiance * fresnel * distribution;\n\n//#ifdef HX_VISIBILITY\n//    specularColor *= hx_lightVisibility(normal, lightDir, geometry.roughness, nDotL);\n//#endif\n}",d._files["lighting_debug.glsl"]="void hx_brdf(in HX_GeometryData geometry, in vec3 lightDir, in vec3 viewDir, in vec3 viewPos, in vec3 lightColor, vec3 normalSpecularReflectance, out vec3 diffuseColor, out vec3 specularColor)\n{\n\tdiffuseColor = vec3(0.0);\n\tspecularColor = vec3(0.0);\n}",d._files["lighting_ggx.glsl"]="#ifdef HX_VISIBILITY_TERM\nfloat hx_geometryTerm(vec3 normal, vec3 dir, float k)\n{\n    float d = max(-dot(normal, dir), 0.0);\n    return d / (d * (1.0 - k) + k);\n}\n\n// schlick-beckman\nfloat hx_lightVisibility(vec3 normal, vec3 viewDir, vec3 lightDir, float roughness)\n{\n\tfloat k = roughness + 1.0;\n\tk = k * k * .125;\n\treturn hx_geometryTerm(normal, viewDir, k) * hx_geometryTerm(normal, lightDir, k);\n}\n#endif\n\nfloat hx_ggxDistribution(float roughness, vec3 normal, vec3 halfVector)\n{\n    float roughSqr = roughness*roughness;\n    float halfDotNormal = max(-dot(halfVector, normal), 0.0);\n    float denom = (halfDotNormal * halfDotNormal) * (roughSqr - 1.0) + 1.0;\n    return roughSqr / (denom * denom);\n}\n\n// light dir is to the lit surface\n// view dir is to the lit surface\nvoid hx_brdf(in HX_GeometryData geometry, in vec3 lightDir, in vec3 viewDir, in vec3 viewPos, in vec3 lightColor, vec3 normalSpecularReflectance, out vec3 diffuseColor, out vec3 specularColor)\n{\n\tfloat nDotL = max(-dot(lightDir, geometry.normal), 0.0);\n\tvec3 irradiance = nDotL * lightColor;\t// in fact irradiance / PI\n\n\tvec3 halfVector = normalize(lightDir + viewDir);\n\n    float mappedRoughness =  geometry.roughness * geometry.roughness;\n\n\tfloat distribution = hx_ggxDistribution(mappedRoughness, geometry.normal, halfVector);\n\n\tfloat halfDotLight = max(dot(halfVector, lightDir), 0.0);\n\tfloat cosAngle = 1.0 - halfDotLight;\n\tvec3 fresnel = normalSpecularReflectance + (1.0 - normalSpecularReflectance) * pow(cosAngle, 5.0);\n\n\tdiffuseColor = irradiance;\n\n\tspecularColor = irradiance * fresnel * distribution;\n\n#ifdef HX_VISIBILITY_TERM\n    specularColor *= hx_lightVisibility(geometry.normal, viewDir, lightDir, geometry.roughness);\n#endif\n}",d._files["default_geometry_fragment.glsl"]="uniform vec3 color;\nuniform vec3 emissiveColor;\nuniform float alpha;\n\n#if defined(COLOR_MAP) || defined(NORMAL_MAP)|| defined(SPECULAR_MAP)|| defined(ROUGHNESS_MAP) || defined(MASK_MAP) || defined(METALLIC_ROUGHNESS_MAP) || defined(OCCLUSION_MAP) || defined(EMISSION_MAP)\nvarying_in vec2 texCoords;\n#endif\n\n#ifdef COLOR_MAP\nuniform sampler2D colorMap;\n#endif\n\n#ifdef OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n\n#ifdef EMISSION_MAP\nuniform sampler2D emissionMap;\n#endif\n\n#ifdef MASK_MAP\nuniform sampler2D maskMap;\n#endif\n\n#ifndef HX_SKIP_NORMALS\n    varying_in vec3 normal;\n\n    #ifdef NORMAL_MAP\n    varying_in vec3 tangent;\n    varying_in vec3 bitangent;\n\n    uniform sampler2D normalMap;\n    #endif\n#endif\n\n#ifndef HX_SKIP_SPECULAR\nuniform float roughness;\nuniform float roughnessRange;\nuniform float normalSpecularReflectance;\nuniform float metallicness;\n\n#if defined(SPECULAR_MAP) || defined(ROUGHNESS_MAP) || defined(METALLIC_ROUGHNESS_MAP)\nuniform sampler2D specularMap;\n#endif\n\n#endif\n\n#if defined(ALPHA_THRESHOLD)\nuniform float alphaThreshold;\n#endif\n\n#ifdef VERTEX_COLORS\nvarying_in vec3 vertexColor;\n#endif\n\nHX_GeometryData hx_geometry()\n{\n    HX_GeometryData data;\n\n    vec4 outputColor = vec4(color, alpha);\n\n    #ifdef VERTEX_COLORS\n        outputColor.xyz *= vertexColor;\n    #endif\n\n    #ifdef COLOR_MAP\n        outputColor *= texture2D(colorMap, texCoords);\n    #endif\n\n    #ifdef MASK_MAP\n        outputColor.w *= texture2D(maskMap, texCoords).x;\n    #endif\n\n    #ifdef ALPHA_THRESHOLD\n        if (outputColor.w < alphaThreshold) discard;\n    #endif\n\n    data.color = hx_gammaToLinear(outputColor);\n\n#ifndef HX_SKIP_SPECULAR\n    float metallicnessOut = metallicness;\n    float specNormalReflOut = normalSpecularReflectance;\n    float roughnessOut = roughness;\n#endif\n\n#if defined(HX_SKIP_NORMALS) && defined(NORMAL_ROUGHNESS_MAP) && !defined(HX_SKIP_SPECULAR)\n    vec4 normalSample = texture2D(normalMap, texCoords);\n    roughnessOut -= roughnessRange * (normalSample.w - .5);\n#endif\n\n#ifndef HX_SKIP_NORMALS\n    vec3 fragNormal = normal;\n\n    #ifdef NORMAL_MAP\n        vec4 normalSample = texture2D(normalMap, texCoords);\n        mat3 TBN;\n        TBN[2] = normalize(normal);\n        TBN[0] = normalize(tangent);\n        TBN[1] = normalize(bitangent);\n\n        fragNormal = TBN * (normalSample.xyz - .5);\n\n        #ifdef NORMAL_ROUGHNESS_MAP\n            roughnessOut -= roughnessRange * (normalSample.w - .5);\n        #endif\n    #endif\n\n    #ifdef DOUBLE_SIDED\n        fragNormal *= gl_FrontFacing? 1.0 : -1.0;\n    #endif\n    data.normal = normalize(fragNormal);\n#endif\n\n#ifndef HX_SKIP_SPECULAR\n    #if defined(SPECULAR_MAP) || defined(ROUGHNESS_MAP) || defined(METALLIC_ROUGHNESS_MAP)\n          vec4 specSample = texture2D(specularMap, texCoords);\n\n          #ifdef METALLIC_ROUGHNESS_MAP\n              roughnessOut -= roughnessRange * (specSample.y - .5);\n              metallicnessOut *= specSample.z;\n\n          #else\n              roughnessOut -= roughnessRange * (specSample.x - .5);\n\n              #ifdef SPECULAR_MAP\n                  specNormalReflOut *= specSample.y;\n                  metallicnessOut *= specSample.z;\n              #endif\n          #endif\n    #endif\n\n    data.metallicness = metallicnessOut;\n    data.normalSpecularReflectance = specNormalReflOut;\n    data.roughness = roughnessOut;\n#endif\n\n    data.occlusion = 1.0;\n\n#ifdef OCCLUSION_MAP\n    data.occlusion = texture2D(occlusionMap, texCoords).x;\n#endif\n\n    vec3 emission = emissiveColor;\n#ifdef EMISSION_MAP\n    emission *= texture2D(emissionMap, texCoords).xyz;\n#endif\n\n    data.emission = hx_gammaToLinear(emission);\n    return data;\n}",d._files["default_geometry_vertex.glsl"]="vertex_attribute vec4 hx_position;\n\n// morph positions are offsets re the base position!\n#ifdef HX_USE_MORPHING\nvertex_attribute vec3 hx_morphPosition0;\nvertex_attribute vec3 hx_morphPosition1;\nvertex_attribute vec3 hx_morphPosition2;\nvertex_attribute vec3 hx_morphPosition3;\n\n#ifdef HX_USE_NORMAL_MORPHING\n    #ifndef HX_SKIP_NORMALS\n    vertex_attribute vec3 hx_morphNormal0;\n    vertex_attribute vec3 hx_morphNormal1;\n    vertex_attribute vec3 hx_morphNormal2;\n    vertex_attribute vec3 hx_morphNormal3;\n    #endif\n\nuniform float hx_morphWeights[4];\n#else\nvertex_attribute vec3 hx_morphPosition4;\nvertex_attribute vec3 hx_morphPosition5;\nvertex_attribute vec3 hx_morphPosition6;\nvertex_attribute vec3 hx_morphPosition7;\n\nuniform float hx_morphWeights[8];\n#endif\n\n#endif\n\n#ifdef HX_USE_SKINNING\nvertex_attribute vec4 hx_jointIndices;\nvertex_attribute vec4 hx_jointWeights;\n\n// WebGL doesn't support mat4x3 and I don't want to split the uniform either\n#ifdef HX_USE_SKINNING_TEXTURE\nuniform sampler2D hx_skinningTexture;\n#else\nuniform vec4 hx_skinningMatrices[HX_MAX_SKELETON_JOINTS * 3];\n#endif\n#endif\n\nuniform mat4 hx_wvpMatrix;\nuniform mat4 hx_worldViewMatrix;\n\n#if defined(COLOR_MAP) || defined(NORMAL_MAP)|| defined(SPECULAR_MAP)|| defined(ROUGHNESS_MAP) || defined(MASK_MAP) || defined(OCCLUSION_MAP) || defined(EMISSION_MAP)\nvertex_attribute vec2 hx_texCoord;\nvarying_out vec2 texCoords;\n#endif\n\n#ifdef VERTEX_COLORS\nvertex_attribute vec3 hx_vertexColor;\nvarying_out vec3 vertexColor;\n#endif\n\n#ifndef HX_SKIP_NORMALS\nvertex_attribute vec3 hx_normal;\nvarying_out vec3 normal;\n\nuniform mat3 hx_normalWorldViewMatrix;\n#ifdef NORMAL_MAP\nvertex_attribute vec4 hx_tangent;\n\nvarying_out vec3 tangent;\nvarying_out vec3 bitangent;\n#endif\n#endif\n\nvoid hx_geometry()\n{\n    vec4 morphedPosition = hx_position;\n\n    #ifndef HX_SKIP_NORMALS\n    vec3 morphedNormal = hx_normal;\n    #endif\n\n// TODO: Abstract this in functions for easier reuse in other materials\n#ifdef HX_USE_MORPHING\n    morphedPosition.xyz += hx_morphPosition0 * hx_morphWeights[0];\n    morphedPosition.xyz += hx_morphPosition1 * hx_morphWeights[1];\n    morphedPosition.xyz += hx_morphPosition2 * hx_morphWeights[2];\n    morphedPosition.xyz += hx_morphPosition3 * hx_morphWeights[3];\n    #ifdef HX_USE_NORMAL_MORPHING\n        #ifndef HX_SKIP_NORMALS\n        morphedNormal += hx_morphNormal0 * hx_morphWeights[0];\n        morphedNormal += hx_morphNormal1 * hx_morphWeights[1];\n        morphedNormal += hx_morphNormal2 * hx_morphWeights[2];\n        morphedNormal += hx_morphNormal3 * hx_morphWeights[3];\n        #endif\n    #else\n        morphedPosition.xyz += hx_morphPosition4 * hx_morphWeights[4];\n        morphedPosition.xyz += hx_morphPosition5 * hx_morphWeights[5];\n        morphedPosition.xyz += hx_morphPosition6 * hx_morphWeights[6];\n        morphedPosition.xyz += hx_morphPosition7 * hx_morphWeights[7];\n    #endif\n#endif\n\n#ifdef HX_USE_SKINNING\n    mat4 skinningMatrix = hx_getSkinningMatrix(0);\n\n    vec4 animPosition = morphedPosition * skinningMatrix;\n\n    #ifndef HX_SKIP_NORMALS\n        vec3 animNormal = morphedNormal * mat3(skinningMatrix);\n\n        #ifdef NORMAL_MAP\n        vec3 animTangent = hx_tangent.xyz * mat3(skinningMatrix);\n        #endif\n    #endif\n#else\n    vec4 animPosition = morphedPosition;\n\n    #ifndef HX_SKIP_NORMALS\n        vec3 animNormal = morphedNormal;\n\n        #ifdef NORMAL_MAP\n        vec3 animTangent = hx_tangent.xyz;\n        #endif\n    #endif\n#endif\n\n    // TODO: Should gl_position be handled by the shaders if we only return local position?\n    gl_Position = hx_wvpMatrix * animPosition;\n\n#ifndef HX_SKIP_NORMALS\n    normal = normalize(hx_normalWorldViewMatrix * animNormal);\n\n    #ifdef NORMAL_MAP\n        tangent = mat3(hx_worldViewMatrix) * animTangent;\n        bitangent = cross(tangent, normal) * hx_tangent.w;\n    #endif\n#endif\n\n#if defined(COLOR_MAP) || defined(NORMAL_MAP)|| defined(SPECULAR_MAP)|| defined(ROUGHNESS_MAP) || defined(MASK_MAP) || defined(OCCLUSION_MAP) || defined(EMISSION_MAP)\n    texCoords = hx_texCoord;\n#endif\n\n#ifdef VERTEX_COLORS\n    vertexColor = hx_vertexColor;\n#endif\n}",d._files["default_skybox_fragment.glsl"]="varying_in vec3 viewWorldDir;\n\nuniform samplerCube hx_skybox;\n\nHX_GeometryData hx_geometry()\n{\n    HX_GeometryData data;\n    data.color = textureCube(hx_skybox, viewWorldDir.xzy);\n    data.emission = vec3(0.0);\n    data.color = hx_gammaToLinear(data.color);\n    return data;\n}",d._files["default_skybox_vertex.glsl"]="vertex_attribute vec4 hx_position;\n\nuniform vec3 hx_cameraWorldPosition;\nuniform float hx_cameraFarPlaneDistance;\nuniform mat4 hx_viewProjectionMatrix;\n\nvarying_out vec3 viewWorldDir;\n\n// using 2D quad for rendering skyboxes rather than 3D cube causes jittering of the skybox\nvoid hx_geometry()\n{\n    viewWorldDir = hx_position.xyz;\n    vec4 pos = hx_position;\n    // use a decent portion of the frustum to prevent FP issues\n    pos.xyz = pos.xyz * hx_cameraFarPlaneDistance + hx_cameraWorldPosition;\n    pos = hx_viewProjectionMatrix * pos;\n    // make sure it's drawn behind everything else, so z = 1.0\n    pos.z = pos.w;\n    gl_Position = pos;\n}",d._files["material_dir_shadow_fragment.glsl"]="void main()\n{\n    // geometry is really only used for kil instructions if necessary\n    // hopefully the compiler optimizes the rest out for us\n    HX_GeometryData data = hx_geometry();\n    hx_FragColor = hx_getShadowMapValue(gl_FragCoord.z);\n}",d._files["material_fwd_base_fragment.glsl"]="uniform vec3 hx_ambientColor;\n\n#ifdef HX_SSAO\nuniform sampler2D hx_ssao;\n#endif\n\nuniform vec2 hx_rcpRenderTargetResolution;\n\nvoid main()\n{\n    vec2 screenUV = gl_FragCoord.xy * hx_rcpRenderTargetResolution;\n\n    HX_GeometryData data = hx_geometry();\n    // simply override with emission\n    hx_FragColor = data.color;\n    #ifdef HX_SSAO\n    float ssao = texture2D(hx_ssao, screenUV).x;\n    #else\n    float ssao = 1.0;\n    #endif\n    hx_FragColor.xyz = hx_FragColor.xyz * hx_ambientColor * ssao + data.emission;\n}",d._files["material_fwd_base_vertex.glsl"]="void main()\n{\n    hx_geometry();\n}",d._files["material_fwd_clustered_fragment.glsl"]="struct HX_PointSpotLight\n{\n// the order here is ordered in function of packing\n    vec3 color;\n    float radius;\n\n    vec3 position;\n    float rcpRadius;\n\n    vec3 direction; // spot only\n    float depthBias;\n\n    mat4 shadowMapMatrix;\n\n    int isSpot;\n    int castShadows;\n    vec2 angleData;    // cos(inner), rcp(cos(outer) - cos(inner))\n\n    vec4 shadowTile;    // xy = scale, zw = offset\n\n    // points only\n    // the 5 missing tiles, share the first one with spots!\n    vec4 shadowTiles[5];    // for each cube face\n};\n\nHX_SpotLight hx_asSpotLight(HX_PointSpotLight light)\n{\n    HX_SpotLight spot;\n    spot.color = light.color;\n    spot.position = light.position;\n    spot.radius = light.radius;\n    spot.direction = light.direction;\n    spot.rcpRadius = light.rcpRadius;\n    spot.angleData = light.angleData;\n    spot.shadowMapMatrix = light.shadowMapMatrix;\n    spot.depthBias = light.depthBias;\n    spot.castShadows = light.castShadows;\n    spot.shadowTile = light.shadowTile;\n    return spot;\n}\n\nHX_PointLight hx_asPointLight(HX_PointSpotLight light)\n{\n    HX_PointLight point;\n    point.color = light.color;\n    point.position = light.position;\n    point.radius = light.radius;\n    point.rcpRadius = light.rcpRadius;\n    point.shadowMapMatrix = light.shadowMapMatrix;\n    point.depthBias = light.depthBias;\n    point.castShadows = light.castShadows;\n    point.shadowTiles[0] = light.shadowTile;\n    point.shadowTiles[1] = light.shadowTiles[0];\n    point.shadowTiles[2] = light.shadowTiles[1];\n    point.shadowTiles[3] = light.shadowTiles[2];\n    point.shadowTiles[4] = light.shadowTiles[3];\n    point.shadowTiles[5] = light.shadowTiles[4];\n    return point;\n}\n\nvarying_in vec3 hx_viewPosition;\n\nuniform vec3 hx_ambientColor;\nuniform vec2 hx_rcpRenderTargetResolution;\nuniform sampler2D hx_shadowMap;\n\n#ifdef HX_SSAO\nuniform sampler2D hx_ssao;\n#endif\n\nuniform hx_lightingCells\n{\n    // std140 layout specification dictates arrays of scalars have strides rounded up to the alignment of vec4\n    // meaning the array would be 4 times as big when using floats. Hence the use of vec4s.\n    ivec4 hx_cells[HX_CELL_ARRAY_LEN];\n};\n\nuniform hx_lights\n{\n    int hx_numDirLights;\n    int hx_numLightProbes;\n    int hx_numPointSpotLights;\n\n#if HX_NUM_DIR_LIGHTS > 0\n    HX_DirectionalLight hx_directionalLights[HX_NUM_DIR_LIGHTS];\n#endif\n\n#if HX_NUM_LIGHT_PROBES > 0\n    HX_Probe hx_probes[HX_NUM_LIGHT_PROBES];\n#endif\n\n#if HX_NUM_POINT_SPOT_LIGHTS > 0\n    HX_PointSpotLight hx_pointSpotLights[HX_NUM_POINT_SPOT_LIGHTS];\n#endif\n\n};\n\n#if HX_NUM_LIGHT_PROBES > 0\nuniform mat4 hx_cameraWorldMatrix;\n\nuniform samplerCube hx_diffuseProbes[HX_NUM_LIGHT_PROBES];\nuniform samplerCube hx_specularProbes[HX_NUM_LIGHT_PROBES];\n#endif\n\nivec2 getCurrentCell(vec2 screenUV)\n{\n    return ivec2(screenUV * vec2(float(HX_NUM_CELLS_X), float(HX_NUM_CELLS_Y)));\n}\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n\n    // update the colours\n    vec3 specularColor = mix(vec3(data.normalSpecularReflectance), data.color.xyz, data.metallicness);\n    data.color.xyz *= 1.0 - data.metallicness;\n\n    vec3 diffuseAccum = vec3(0.0);\n    vec3 specularAccum = vec3(0.0);\n    vec3 viewVector = normalize(hx_viewPosition);\n\n    float ao = data.occlusion;\n    vec2 screenUV = gl_FragCoord.xy * hx_rcpRenderTargetResolution;\n\n    #ifdef HX_SSAO\n        ao = texture2D(hx_ssao, screenUV).x;\n    #endif\n\n    #if HX_NUM_DIR_LIGHTS > 0\n        for (int i = 0; i < hx_numDirLights; ++i) {\n            HX_DirectionalLight light = hx_directionalLights[i];\n            vec3 diffuse, specular;\n            hx_calculateLight(light, data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n\n            if (light.castShadows == 1) {\n                float shadow = hx_calculateShadows(light, hx_shadowMap, hx_viewPosition);\n                diffuse *= shadow;\n                specular *= shadow;\n            }\n\n            diffuseAccum += diffuse;\n            specularAccum += specular;\n        }\n    #endif\n\n    #if HX_NUM_LIGHT_PROBES > 0\n        vec3 worldNormal = mat3(hx_cameraWorldMatrix) * data.normal;\n        vec3 reflectedViewDir = reflect(viewVector, data.normal);\n        vec3 fresnel = hx_fresnelProbe(specularColor, reflectedViewDir, data.normal, data.roughness);\n\n        reflectedViewDir = mat3(hx_cameraWorldMatrix) * reflectedViewDir;\n\n        for (int i = 0; i < HX_NUM_LIGHT_PROBES; ++i) {\n            // this is a bit icky, but since the cube textures need to indexed using a literal, we can't loop over hx_numLightProbes\n            if (i < hx_numLightProbes) {\n                if (hx_probes[i].hasDiffuse == 1)\n                    diffuseAccum += hx_calculateDiffuseProbeLight(hx_diffuseProbes[i], worldNormal) * ao;\n\n                if (hx_probes[i].hasSpecular == 1)\n                    specularAccum += hx_calculateSpecularProbeLight(hx_specularProbes[i], hx_probes[i].numMipLevels, reflectedViewDir, fresnel, data.roughness) * ao;\n            }\n        }\n    #endif\n\n    #if HX_NUM_POINT_SPOT_LIGHTS > 0\n        ivec2 cell = getCurrentCell(screenUV);\n        int cellIndex = HX_CELL_STRIDE * (HX_NUM_CELLS_X * cell.y + cell.x);\n        int cellElm = cellIndex / 4;\n        int comp = cellIndex - cellElm * 4;\n\n        int numLights = hx_cells[cellElm][comp];\n\n//        specularAccum += float(numLights) / 5.0;\n\n        for (int i = 1; i <= numLights; ++i) {\n            vec3 diffuse, specular;\n            float shadow = 1.0;;\n            int lightIndex = cellIndex + i;\n            int cellElm = lightIndex / 4;\n            int comp = lightIndex - cellElm * 4;\n            lightIndex = hx_cells[cellElm][comp];\n\n            if (hx_pointSpotLights[lightIndex].isSpot == 1) {\n                HX_SpotLight spot = hx_asSpotLight(hx_pointSpotLights[lightIndex]);\n                hx_calculateLight(spot, data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n                if (spot.castShadows == 1)\n                    shadow = hx_calculateShadows(spot, hx_shadowMap, hx_viewPosition);\n            }\n            else {\n                HX_PointLight point = hx_asPointLight(hx_pointSpotLights[lightIndex]);\n                hx_calculateLight(point, data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n                if (point.castShadows == 1)\n                    shadow = hx_calculateShadows(point, hx_shadowMap, hx_viewPosition);\n            }\n\n            diffuseAccum += diffuse * shadow;\n            specularAccum += specular * shadow;\n        }\n    #endif\n\n    hx_FragColor = vec4((diffuseAccum + hx_ambientColor * ao) * data.color.xyz + specularAccum + data.emission, data.color.w);\n}",d._files["material_fwd_clustered_vertex.glsl"]="varying_out vec3 hx_viewPosition;\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    // we need to do an unprojection here to be sure to have skinning - or anything like that - support\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n}",d._files["material_fwd_dir_fragment.glsl"]="varying_in vec3 hx_viewPosition;\n\nuniform HX_DirectionalLight hx_directionalLight;\n\nuniform sampler2D hx_shadowMap;\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n\n    vec3 viewVector = normalize(hx_viewPosition);\n    vec3 diffuse, specular;\n\n    vec3 specularColor = mix(vec3(data.normalSpecularReflectance), data.color.xyz, data.metallicness);\n    data.color.xyz *= 1.0 - data.metallicness;\n\n    hx_calculateLight(hx_directionalLight, data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n\n    hx_FragColor = vec4(diffuse * data.color.xyz + specular, data.color.w);\n\n    if (hx_directionalLight.castShadows == 1)\n        hx_FragColor.xyz *= hx_calculateShadows(hx_directionalLight, hx_shadowMap, hx_viewPosition);\n}",d._files["material_fwd_dir_vertex.glsl"]="varying_out vec3 hx_viewPosition;\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n}",d._files["material_fwd_fixed_fragment.glsl"]="varying_in vec3 hx_viewPosition;\n\nuniform vec3 hx_ambientColor;\n\nuniform sampler2D hx_shadowMap;\n\n#if HX_NUM_DIR_LIGHTS > 0\nuniform HX_DirectionalLight hx_directionalLights[HX_NUM_DIR_LIGHTS];\n#endif\n\n#if HX_NUM_POINT_LIGHTS > 0\nuniform HX_PointLight hx_pointLights[HX_NUM_POINT_LIGHTS];\n#endif\n\n#if HX_NUM_SPOT_LIGHTS > 0\nuniform HX_SpotLight hx_spotLights[HX_NUM_SPOT_LIGHTS];\n#endif\n\n#if HX_NUM_DIFFUSE_PROBES > 0 || HX_NUM_SPECULAR_PROBES > 0\nuniform mat4 hx_cameraWorldMatrix;\n#endif\n\n#if HX_NUM_DIFFUSE_PROBES > 0\nuniform samplerCube hx_diffuseProbeMaps[HX_NUM_DIFFUSE_PROBES];\n#endif\n\n#if HX_NUM_SPECULAR_PROBES > 0\nuniform samplerCube hx_specularProbeMaps[HX_NUM_SPECULAR_PROBES];\nuniform float hx_specularProbeNumMips[HX_NUM_SPECULAR_PROBES];\n#endif\n\n#ifdef HX_SSAO\nuniform sampler2D hx_ssao;\n\nuniform vec2 hx_rcpRenderTargetResolution;\n#endif\n\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n\n    // update the colours\n    vec3 specularColor = mix(vec3(data.normalSpecularReflectance), data.color.xyz, data.metallicness);\n    data.color.xyz *= 1.0 - data.metallicness;\n\n    vec3 diffuseAccum = vec3(0.0);\n    vec3 specularAccum = vec3(0.0);\n    vec3 viewVector = normalize(hx_viewPosition);\n\n    float ao = data.occlusion;\n\n    #ifdef HX_SSAO\n        vec2 screenUV = gl_FragCoord.xy * hx_rcpRenderTargetResolution;\n        ao = texture2D(hx_ssao, screenUV).x;\n    #endif\n\n    #if HX_NUM_DIR_LIGHTS > 0\n    for (int i = 0; i < HX_NUM_DIR_LIGHTS; ++i) {\n        vec3 diffuse, specular;\n        hx_calculateLight(hx_directionalLights[i], data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n\n        if (hx_directionalLights[i].castShadows == 1) {\n            float shadow = hx_calculateShadows(hx_directionalLights[i], hx_shadowMap, hx_viewPosition);\n            diffuse *= shadow;\n            specular *= shadow;\n        }\n\n        diffuseAccum += diffuse;\n        specularAccum += specular;\n    }\n    #endif\n\n    #if HX_NUM_POINT_LIGHTS > 0\n    for (int i = 0; i < HX_NUM_POINT_LIGHTS; ++i) {\n        vec3 diffuse, specular;\n        hx_calculateLight(hx_pointLights[i], data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n\n        if (hx_pointLights[i].castShadows == 1) {\n            float shadow = hx_calculateShadows(hx_pointLights[i], hx_shadowMap, hx_viewPosition);\n            diffuse *= shadow;\n            specular *= shadow;\n        }\n\n        diffuseAccum += diffuse;\n        specularAccum += specular;\n    }\n    #endif\n\n    #if HX_NUM_SPOT_LIGHTS > 0\n    for (int i = 0; i < HX_NUM_SPOT_LIGHTS; ++i) {\n        vec3 diffuse, specular;\n        hx_calculateLight(hx_spotLights[i], data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n\n        if (hx_spotLights[i].castShadows == 1) {\n            float shadow = hx_calculateShadows(hx_spotLights[i], hx_shadowMap, hx_viewPosition);\n            diffuse *= shadow;\n            specular *= shadow;\n        }\n\n        diffuseAccum += diffuse;\n        specularAccum += specular;\n    }\n    #endif\n\n// TODO: add support for local probes\n\n    #if HX_NUM_DIFFUSE_PROBES > 0\n    vec3 worldNormal = mat3(hx_cameraWorldMatrix) * data.normal;\n    for (int i = 0; i < HX_NUM_DIFFUSE_PROBES; ++i) {\n        diffuseAccum += hx_calculateDiffuseProbeLight(hx_diffuseProbeMaps[i], worldNormal) * ao;\n    }\n    #endif\n\n    #if HX_NUM_SPECULAR_PROBES > 0\n    vec3 reflectedViewDir = reflect(viewVector, data.normal);\n    vec3 fresnel = hx_fresnelProbe(specularColor, reflectedViewDir, data.normal, data.roughness);\n\n    reflectedViewDir = mat3(hx_cameraWorldMatrix) * reflectedViewDir;\n\n   for (int i = 0; i < HX_NUM_SPECULAR_PROBES; ++i) {\n        specularAccum += hx_calculateSpecularProbeLight(hx_specularProbeMaps[i], hx_specularProbeNumMips[i], reflectedViewDir, fresnel, data.roughness) * ao;\n    }\n    #endif\n\n    hx_FragColor = vec4((diffuseAccum + hx_ambientColor * ao) * data.color.xyz + specularAccum + data.emission, data.color.w);\n}",d._files["material_fwd_fixed_vertex.glsl"]="varying_out vec3 hx_viewPosition;\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    // we need to do an unprojection here to be sure to have skinning - or anything like that - support\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n}",d._files["material_fwd_point_fragment.glsl"]="varying_in vec3 hx_viewPosition;\n\nuniform HX_PointLight hx_pointLight;\n\nuniform sampler2D hx_shadowMap;\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n\n    vec3 viewVector = normalize(hx_viewPosition);\n    vec3 diffuse, specular;\n\n    vec3 specularColor = mix(vec3(data.normalSpecularReflectance), data.color.xyz, data.metallicness);\n    data.color.xyz *= 1.0 - data.metallicness;\n\n    hx_calculateLight(hx_pointLight, data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n\n    hx_FragColor = vec4(diffuse * data.color.xyz + specular, data.color.w);\n\n    if (hx_pointLight.castShadows == 1)\n        hx_FragColor.xyz *= hx_calculateShadows(hx_pointLight, hx_shadowMap, hx_viewPosition);\n}",d._files["material_fwd_point_vertex.glsl"]="varying_out vec3 hx_viewPosition;\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n}",d._files["material_fwd_probe_fragment.glsl"]="varying_in vec3 hx_viewPosition;\nvarying_in vec3 hx_worldPosition;\n\nuniform samplerCube hx_diffuseProbeMap;\nuniform samplerCube hx_specularProbeMap;\nuniform float hx_specularProbeNumMips;\n\nuniform mat4 hx_cameraWorldMatrix;\n\n#ifdef HX_SSAO\nuniform vec2 hx_rcpRenderTargetResolution;\nuniform sampler2D hx_ssao;\n#endif\n\nuniform float hx_probeSize;\nuniform vec3 hx_probePosition;\nuniform float hx_probeLocal;\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n\n    vec3 viewVector = normalize(hx_viewPosition);\n\n    vec3 specularColor = mix(vec3(data.normalSpecularReflectance), data.color.xyz, data.metallicness);\n    data.color.xyz *= 1.0 - data.metallicness;\n\n    // TODO: We should be able to change the base of TBN in vertex shader\n    vec3 worldNormal = mat3(hx_cameraWorldMatrix) * data.normal;\n    vec3 reflectedViewDir = reflect(viewVector, data.normal);\n    vec3 fresnel = hx_fresnelProbe(specularColor, reflectedViewDir, data.normal, data.roughness);\n    reflectedViewDir = mat3(hx_cameraWorldMatrix) * reflectedViewDir;\n    vec3 diffRay = hx_intersectCubeMap(hx_worldPosition, hx_probePosition, worldNormal, hx_probeSize);\n    vec3 specRay = hx_intersectCubeMap(hx_worldPosition, hx_probePosition, reflectedViewDir, hx_probeSize);\n    diffRay = mix(worldNormal, diffRay, hx_probeLocal);\n    specRay = mix(reflectedViewDir, specRay, hx_probeLocal);\n    vec3 diffuse = hx_calculateDiffuseProbeLight(hx_diffuseProbeMap, diffRay);\n    vec3 specular = hx_calculateSpecularProbeLight(hx_specularProbeMap, hx_specularProbeNumMips, specRay, fresnel, data.roughness);\n\n    hx_FragColor = vec4((diffuse * data.color.xyz + specular) * data.occlusion, data.color.w);\n\n    #ifdef HX_SSAO\n    vec2 screenUV = gl_FragCoord.xy * hx_rcpRenderTargetResolution;\n    hx_FragColor.xyz *= texture2D(hx_ssao, screenUV).x;\n    #endif\n}",d._files["material_fwd_probe_vertex.glsl"]="varying_out vec3 hx_viewPosition;\nvarying_out vec3 hx_worldPosition;\nuniform mat4 hx_inverseProjectionMatrix;\nuniform mat4 hx_worldMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    hx_worldPosition = (hx_worldMatrix * gl_Position).xyz;\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n}",d._files["material_fwd_spot_fragment.glsl"]="varying_in vec3 hx_viewPosition;\n\nuniform HX_SpotLight hx_spotLight;\n\nuniform sampler2D hx_shadowMap;\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n\n    vec3 viewVector = normalize(hx_viewPosition);\n    vec3 diffuse, specular;\n\n    vec3 specularColor = mix(vec3(data.normalSpecularReflectance), data.color.xyz, data.metallicness);\n    data.color.xyz *= 1.0 - data.metallicness;\n\n    hx_calculateLight(hx_spotLight, data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n\n    hx_FragColor = vec4(diffuse * data.color.xyz + specular, data.color.w);\n\n    if (hx_spotLight.castShadows == 1)\n        hx_FragColor.xyz *= hx_calculateShadows(hx_spotLight, hx_shadowMap, hx_viewPosition);\n}",d._files["material_fwd_spot_vertex.glsl"]="varying_out vec3 hx_viewPosition;\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n}",d._files["material_normal_depth_fragment.glsl"]="varying_in float hx_linearDepth;\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n    hx_FragColor.xy = hx_encodeNormal(data.normal);\n    hx_FragColor.zw = hx_floatToRG8(hx_linearDepth);\n}",d._files["material_normal_depth_vertex.glsl"]="varying_out float hx_linearDepth;\n\nuniform float hx_rcpCameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\n\nvoid main()\n{\n    hx_geometry();\n\n    hx_linearDepth = (gl_Position.w - hx_cameraNearPlaneDistance) * hx_rcpCameraFrustumRange;\n}",d._files["material_point_shadow_fragment.glsl"]="varying_in vec3 hx_viewPosition;\n\nuniform float hx_rcpRadius;\n\nvoid main()\n{\n    // geometry is really only used for kil instructions if necessary\n    // hopefully the compiler optimizes the rest out for us\n    HX_GeometryData data = hx_geometry();\n\n    hx_FragColor = hx_getShadowMapValue(length(hx_viewPosition) * hx_rcpRadius);\n}",d._files["material_point_shadow_vertex.glsl"]="varying_out vec3 hx_viewPosition;\n\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n\n    // this shrinks it down to leave some room for filtering\n    gl_Position.xy *= .95;\n}",d._files["material_unlit_fragment.glsl"]="void main()\n{\n    HX_GeometryData data = hx_geometry();\n    hx_FragColor = data.color;\n    hx_FragColor.xyz += data.emission;\n}",d._files["material_unlit_vertex.glsl"]="void main()\n{\n    hx_geometry();\n}",d._files["directional_light.glsl"]="struct HX_DirectionalLight\n{\n    vec3 color;\n    vec3 direction; // in view space?\n\n    int castShadows;\n\n    mat4 shadowMapMatrices[4];\n    vec4 splitDistances;\n\n    float depthBias;\n    float maxShadowDistance;    // = light.splitDistances[light.numCascades - 1]\n};\n\nvoid hx_calculateLight(HX_DirectionalLight light, HX_GeometryData geometry, vec3 viewVector, vec3 viewPosition, vec3 normalSpecularReflectance, out vec3 diffuse, out vec3 specular)\n{\n\thx_brdf(geometry, light.direction, viewVector, viewPosition, light.color, normalSpecularReflectance, diffuse, specular);\n}\n\nmat4 hx_getShadowMatrix(HX_DirectionalLight light, vec3 viewPos)\n{\n    #if HX_NUM_SHADOW_CASCADES > 1\n        // not very efficient :(\n        for (int i = 0; i < HX_NUM_SHADOW_CASCADES - 1; ++i) {\n            if (viewPos.y < light.splitDistances[i])\n                return light.shadowMapMatrices[i];\n        }\n        return light.shadowMapMatrices[HX_NUM_SHADOW_CASCADES - 1];\n    #else\n        return light.shadowMapMatrices[0];\n    #endif\n}\n\n#ifdef HX_FRAGMENT_SHADER\nfloat hx_calculateShadows(HX_DirectionalLight light, sampler2D shadowMap, vec3 viewPos)\n{\n    mat4 shadowMatrix = hx_getShadowMatrix(light, viewPos);\n    vec4 shadowMapCoord = shadowMatrix * vec4(viewPos, 1.0);\n    float shadow = hx_readShadow(shadowMap, shadowMapCoord, light.depthBias);\n\n    // this can occur when meshInstance.castShadows = false, or using inherited bounds\n    bool isOutside = max(shadowMapCoord.x, shadowMapCoord.y) > 1.0 || min(shadowMapCoord.x, shadowMapCoord.y) < 0.0;\n    if (isOutside) shadow = 1.0;\n\n    // this makes sure that anything beyond the last cascade is unshadowed\n    return max(shadow, float(viewPos.y > light.maxShadowDistance));\n}\n#endif",d._files["light_probe.glsl"]="#define HX_PROBE_K0 .00098\n#define HX_PROBE_K1 .9921\n\n// really only used for clustered\nstruct HX_Probe\n{\n    int hasDiffuse;\n    int hasSpecular;\n    float numMipLevels;\n};\n\n/*\nvar minRoughness = 0.0014;\nvar maxPower = 2.0 / (minRoughness * minRoughness) - 2.0;\nvar maxMipFactor = (exp2(-10.0/Math.sqrt(maxPower)) - HX_PROBE_K0)/HX_PROBE_K1;\nvar HX_PROBE_SCALE = 1.0 / maxMipFactor\n*/\n\n#define HX_PROBE_SCALE\n\nvec3 hx_calculateDiffuseProbeLight(samplerCube texture, vec3 normal)\n{\n\treturn hx_gammaToLinear(textureCube(texture, normal.xzy).xyz);\n}\n\nvec3 hx_calculateSpecularProbeLight(samplerCube texture, float numMips, vec3 reflectedViewDir, vec3 fresnelColor, float roughness)\n{\n    #if defined(HX_TEXTURE_LOD) || defined (HX_GLSL_300_ES)\n    // knald method:\n        float power = 2.0/(roughness * roughness) - 2.0;\n        float factor = (exp2(-10.0/sqrt(power)) - HX_PROBE_K0)/HX_PROBE_K1;\n//        float mipLevel = numMips * (1.0 - clamp(factor * HX_PROBE_SCALE, 0.0, 1.0));\n        float mipLevel = numMips * (1.0 - clamp(factor, 0.0, 1.0));\n        #ifdef HX_GLSL_300_ES\n        vec4 specProbeSample = textureLod(texture, reflectedViewDir.xzy, mipLevel);\n        #else\n        vec4 specProbeSample = textureCubeLodEXT(texture, reflectedViewDir.xzy, mipLevel);\n        #endif\n    #else\n        vec4 specProbeSample = textureCube(texture, reflectedViewDir.xzy);\n    #endif\n\treturn hx_gammaToLinear(specProbeSample.xyz) * fresnelColor;\n}",d._files["point_light.glsl"]="struct HX_PointLight\n{\n    vec3 color;\n    vec3 position;\n    float radius;\n    float rcpRadius;\n\n    float depthBias;\n    mat4 shadowMapMatrix;\n    int castShadows;\n    vec4 shadowTiles[6];    // for each cube face\n};\n\nvoid hx_calculateLight(HX_PointLight light, HX_GeometryData geometry, vec3 viewVector, vec3 viewPosition, vec3 normalSpecularReflectance, out vec3 diffuse, out vec3 specular)\n{\n    vec3 direction = viewPosition - light.position;\n    float attenuation = dot(direction, direction);  // distance squared\n    float distance = sqrt(attenuation);\n    // normalize\n    direction /= distance;\n    attenuation = max((1.0 - distance * light.rcpRadius) / attenuation, 0.0);\n\thx_brdf(geometry, direction, viewVector, viewPosition, light.color * attenuation, normalSpecularReflectance, diffuse, specular);\n}\n\n#ifdef HX_FRAGMENT_SHADER\nfloat hx_calculateShadows(HX_PointLight light, sampler2D shadowMap, vec3 viewPos)\n{\n    vec3 dir = viewPos - light.position;\n    // go from view space back to world space, as a vector\n    float dist = length(dir);\n    dir = mat3(light.shadowMapMatrix) * dir;\n\n    // swizzle to opengl cube map space\n    dir = dir.xzy;\n\n    vec3 absDir = abs(dir);\n    float maxDir = max(max(absDir.x, absDir.y), absDir.z);\n    vec2 uv;\n    vec4 tile;\n    if (absDir.x == maxDir) {\n        tile = dir.x > 0.0? light.shadowTiles[0]: light.shadowTiles[1];\n        // signs are important (hence division by either dir or absDir\n        uv = vec2(-dir.z / dir.x, -dir.y / absDir.x);\n    }\n    else if (absDir.y == maxDir) {\n        tile = dir.y > 0.0? light.shadowTiles[4]: light.shadowTiles[5];\n        uv = vec2(dir.x / absDir.y, dir.z / dir.y);\n    }\n    else {\n        tile = dir.z > 0.0? light.shadowTiles[2]: light.shadowTiles[3];\n        uv = vec2(dir.x / dir.z, -dir.y / absDir.z);\n    }\n\n    // match the scaling applied in the shadow map pass (used to reduce bleeding from filtering)\n    uv *= .95;\n\n    vec4 shadowMapCoord;\n    shadowMapCoord.xy = uv * tile.xy + tile.zw;\n    shadowMapCoord.z = dist * light.rcpRadius;\n    shadowMapCoord.w = 1.0;\n    return hx_readShadow(shadowMap, shadowMapCoord, light.depthBias);\n}\n#endif",d._files["spot_light.glsl"]="struct HX_SpotLight\n{\n    vec3 color;\n    vec3 position;\n    vec3 direction;\n    float radius;\n    float rcpRadius;\n\n    vec2 angleData;    // cos(inner), rcp(cos(outer) - cos(inner))\n\n    mat4 shadowMapMatrix;\n    float depthBias;\n    int castShadows;\n\n    vec4 shadowTile;    // xy = scale, zw = offset\n};\n\nvoid hx_calculateLight(HX_SpotLight light, HX_GeometryData geometry, vec3 viewVector, vec3 viewPosition, vec3 normalSpecularReflectance, out vec3 diffuse, out vec3 specular)\n{\n    vec3 direction = viewPosition - light.position;\n    float attenuation = dot(direction, direction);  // distance squared\n    float distance = sqrt(attenuation);\n    // normalize\n    direction /= distance;\n\n    float cosAngle = dot(light.direction, direction);\n\n    attenuation = max((1.0 - distance * light.rcpRadius) / attenuation, 0.0);\n    attenuation *=  saturate((cosAngle - light.angleData.x) * light.angleData.y);\n\n\thx_brdf(geometry, direction, viewVector, viewPosition, light.color * attenuation, normalSpecularReflectance, diffuse, specular);\n}\n\n#ifdef HX_FRAGMENT_SHADER\nfloat hx_calculateShadows(HX_SpotLight light, sampler2D shadowMap, vec3 viewPos)\n{\n    vec4 shadowMapCoord = light.shadowMapMatrix * vec4(viewPos, 1.0);\n    shadowMapCoord /= shadowMapCoord.w;\n    // *.9 --\x3e match the scaling applied in the shadow map pass (used to reduce bleeding from filtering)\n    shadowMapCoord.xy = shadowMapCoord.xy * .95 * light.shadowTile.xy + light.shadowTile.zw;\n    shadowMapCoord.z = length(viewPos - light.position) * light.rcpRadius;\n    return hx_readShadow(shadowMap, shadowMapCoord, light.depthBias);\n}\n#endif",d._files["blend_color_copy_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D sampler;\n\nuniform vec4 blendColor;\n\nvoid main()\n{\n    // extractChannel comes from a macro\n   hx_FragColor = texture2D(sampler, uv) * blendColor;\n}\n",d._files["copy_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D sampler;\n\nvoid main()\n{\n    // extractChannel comes from a macro\n   hx_FragColor = vec4(extractChannels(texture2D(sampler, uv)));\n\n#ifndef COPY_ALPHA\n   hx_FragColor.a = 1.0;\n#endif\n}\n",d._files["copy_to_gamma_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D sampler;\n\nvoid main()\n{\n   hx_FragColor = hx_linearToGamma(texture2D(sampler, uv));\n}",d._files["copy_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nvarying_out vec2 uv;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    gl_Position = hx_position;\n}",d._files["null_fragment.glsl"]="void main()\n{\n   hx_FragColor = vec4(1.0);\n}\n",d._files["null_vertex.glsl"]="vertex_attribute vec4 hx_position;\n\nvoid main()\n{\n    gl_Position = hx_position;\n}",d._files["bloom_composite_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D bloomTexture;\nuniform sampler2D hx_backbuffer;\nuniform float strength;\n\nvoid main()\n{\n\thx_FragColor = texture2D(hx_backbuffer, uv) + texture2D(bloomTexture, uv) * strength;\n}",d._files["bloom_composite_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nvarying_out vec2 uv;\n\nvoid main()\n{\n\t   uv = hx_texCoord;\n\t   gl_Position = hx_position;\n}",d._files["bloom_threshold_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D hx_backbuffer;\n\nuniform float threshold;\n\nvoid main()\n{\n        vec4 color = texture2D(hx_backbuffer, uv);\n        float originalLuminance = .05 + hx_luminance(color);\n        float targetLuminance = max(originalLuminance - threshold, 0.0);\n        hx_FragColor = color * targetLuminance / originalLuminance;\n}\n",d._files["default_post_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nvarying_out vec2 uv;\n\nvoid main()\n{\n\tuv = hx_texCoord;\n\tgl_Position = hx_position;\n}",d._files["fog_fragment.glsl"]="varying_in vec2 uv;\nvarying_in vec3 viewDir;\n\nuniform vec3 tint;\nuniform float density;\nuniform float startDistance;\nuniform float heightFallOff;\n\nuniform float hx_cameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\nuniform vec3 hx_cameraWorldPosition;\n\nuniform sampler2D hx_normalDepthBuffer;\nuniform sampler2D hx_backbuffer;\n\nvoid main()\n{\n    vec4 normalDepth = texture2D(hx_normalDepthBuffer, uv);\n\tvec4 color = texture2D(hx_backbuffer, uv);\n\tfloat depth = hx_decodeLinearDepth(normalDepth);\n\t// do not fog up skybox\n\tif (normalDepth.z == 1.0 && normalDepth.w == 1.0) depth = 0.0;\n\tfloat absViewY = hx_cameraNearPlaneDistance + depth * hx_cameraFrustumRange;\n\tvec3 viewVec = viewDir * absViewY;\n\tfloat fogFactor = max(length(viewVec) - startDistance, 0.0);// * exp(-heightFallOff * hx_cameraWorldPosition.y);\n//    if( abs( viewVec.y ) > 0.1 )\n//\t{\n\t\tfloat t = heightFallOff * (viewVec.z + hx_cameraWorldPosition.z);\n\t\tfogFactor *= saturate(( 1.0 - exp( -t ) ) / t);\n//\t}\n\n\tfloat fog = clamp(exp(-fogFactor * density), 0.0, 1.0);\n\tcolor.xyz = mix(tint, color.xyz, fog);\n\thx_FragColor = color;\n}",d._files["fog_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nvarying_out vec2 uv;\nvarying_out vec3 viewDir;\n\nuniform mat4 hx_inverseProjectionMatrix;\nuniform mat4 hx_cameraWorldMatrix;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    viewDir = mat3(hx_cameraWorldMatrix) * hx_getLinearDepthViewVector(hx_position.xy, hx_inverseProjectionMatrix);\n    gl_Position = hx_position;\n}",d._files["fxaa_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D hx_backbuffer;\nuniform vec2 hx_rcpRenderTargetResolution;\nuniform float edgeThreshold;\nuniform float edgeThresholdMin;\nuniform float edgeSharpness;\n\nfloat luminanceHint(vec4 color)\n{\n\treturn .30/.59 * color.r + color.g;\n}\n\nvoid main()\n{\n\tvec4 center = texture2D(hx_backbuffer, uv);\n\tvec2 halfRes = vec2(hx_rcpRenderTargetResolution.x, hx_rcpRenderTargetResolution.y) * .5;\n\tfloat topLeftLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(-halfRes.x, halfRes.y)));\n\tfloat bottomLeftLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(-halfRes.x, -halfRes.y)));\n\tfloat topRightLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(halfRes.x, halfRes.y)));\n\tfloat bottomRightLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(halfRes.x, -halfRes.y)));\n\n\tfloat centerLum = luminanceHint(center);\n\tfloat minLum = min(min(topLeftLum, bottomLeftLum), min(topRightLum, bottomRightLum));\n\tfloat maxLum = max(max(topLeftLum, bottomLeftLum), max(topRightLum, bottomRightLum));\n\tfloat range = max(centerLum, maxLum) - min(centerLum, minLum);\n\tfloat threshold = max(edgeThresholdMin, maxLum * edgeThreshold);\n\tfloat applyFXAA = range < threshold? 0.0 : 1.0;\n\n\tfloat diagDiff1 = bottomLeftLum - topRightLum;\n\tfloat diagDiff2 = bottomRightLum - topLeftLum;\n\tvec2 dir1 = normalize(vec2(diagDiff1 + diagDiff2, diagDiff1 - diagDiff2));\n\tvec4 sampleNeg1 = texture2D(hx_backbuffer, uv - halfRes * dir1);\n\tvec4 samplePos1 = texture2D(hx_backbuffer, uv + halfRes * dir1);\n\n\tfloat minComp = min(abs(dir1.x), abs(dir1.y)) * edgeSharpness;\n\tvec2 dir2 = clamp(dir1.xy / minComp, -2.0, 2.0) * 2.0;\n\tvec4 sampleNeg2 = texture2D(hx_backbuffer, uv - hx_rcpRenderTargetResolution * dir2);\n\tvec4 samplePos2 = texture2D(hx_backbuffer, uv + hx_rcpRenderTargetResolution * dir2);\n\tvec4 tap1 = sampleNeg1 + samplePos1;\n\tvec4 fxaa = (tap1 + sampleNeg2 + samplePos2) * .25;\n\tfloat fxaaLum = luminanceHint(fxaa);\n\tif ((fxaaLum < minLum) || (fxaaLum > maxLum))\n\t\tfxaa = tap1 * .5;\n\thx_FragColor = mix(center, fxaa, applyFXAA);\n}",d._files["gaussian_blur_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D sourceTexture;\n\nuniform vec2 stepSize;\n\nuniform float gaussianWeights[NUM_WEIGHTS];\n\nvoid main()\n{\n\tvec4 total = texture2D(sourceTexture, uv) * gaussianWeights[0];\n    vec2 offset = vec2(0.0);\n\n\tfor (int i = 1; i <= RADIUS; ++i) {\n\t\toffset += stepSize;\n\t    vec4 s = texture2D(sourceTexture, uv + offset) + texture2D(sourceTexture, uv - offset);\n\t\ttotal += s * gaussianWeights[i];\n\t}\n\n\thx_FragColor = total;\n}",d._files["gaussian_blur_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nvarying_out vec2 uv;\n\nvoid main()\n{\n\tuv = hx_texCoord;\n\tgl_Position = hx_position;\n}",d._files["post_viewpos_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nvarying_out vec2 uv;\nvarying_out vec3 viewDir;\n\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    viewDir = hx_getLinearDepthViewVector(hx_position.xy, hx_inverseProjectionMatrix);\n    gl_Position = hx_position;\n}",d._files["ssr_fragment.glsl"]='#derivatives\n\n// TODO: This won\'t work anymore\nuniform sampler2D hx_gbufferColor;\nuniform sampler2D hx_gbufferNormals;\nuniform sampler2D hx_gbufferSpecular;\nuniform sampler2D hx_gbufferDepth;\nuniform sampler2D hx_dither2D;\nuniform vec2 hx_renderTargetResolution;\n\nuniform sampler2D hx_frontbuffer;\n\nvarying_in vec2 uv;\nvarying_in vec3 viewDir;\n\nuniform vec2 ditherTextureScale;\nuniform float hx_cameraNearPlaneDistance;\nuniform float hx_cameraFrustumRange;\nuniform float hx_rcpCameraFrustumRange;\nuniform mat4 hx_projectionMatrix;\n\nuniform float maxDistance;\nuniform float stepSize;\nuniform float maxRoughness;\n\n// all in viewspace\n// 0 is start, 1 is end\nfloat raytrace(in vec3 ray0, in vec3 rayDir, out float hitZ, out vec2 hitUV)\n{\n    vec4 dither = hx_sampleDefaultDither(hx_dither2D, uv * ditherTextureScale);\n    // Clip to the near plane\n\tfloat rayLength = ((ray0.z + rayDir.z * maxDistance) > -hx_cameraNearPlaneDistance) ?\n\t\t\t\t\t\t(-hx_cameraNearPlaneDistance - ray0.z) / rayDir.z : maxDistance;\n\n    vec3 ray1 = ray0 + rayDir * rayLength;\n\n    // only need the w component for perspective correct interpolation\n    // need to get adjusted ray end\'s uv value\n    vec4 hom0 = hx_projectionMatrix * vec4(ray0, 1.0);\n    vec4 hom1 = hx_projectionMatrix * vec4(ray1, 1.0);\n    float rcpW0 = 1.0 / hom0.w;\n    float rcpW1 = 1.0 / hom1.w;\n\n    hom0 *= rcpW0;\n    hom1 *= rcpW1;\n\n    // expressed in pixels, so we can snap to 1\n    // need to figure out the ratio between 1 pixel and the entire line "width" (if primarily vertical, it\'s actually height)\n\n    // line dimensions in pixels:\n\n    vec2 pixelSize = (hom1.xy - hom0.xy) * hx_renderTargetResolution * .5;\n\n    // line-"width" = max(abs(pixelSize.x), abs(pixelSize.y))\n    // ratio pixel/width = 1 / max(abs(pixelSize.x), abs(pixelSize.y))\n\n    float stepRatio = 1.0 / max(abs(pixelSize.x), abs(pixelSize.y)) * stepSize;\n\n    vec2 uvEnd = hom1.xy * .5 + .5;\n\n    vec2 dUV = (uvEnd - uv) * stepRatio;\n    hitUV = uv;\n\n    // linear depth\n    float rayDepth = (-ray0.z - hx_cameraNearPlaneDistance) * hx_rcpCameraFrustumRange;\n    float rayPerspDepth0 = rayDepth * rcpW0;\n    float rayPerspDepth1 = (-ray1.z - hx_cameraNearPlaneDistance) * hx_rcpCameraFrustumRange * rcpW1;\n    float rayPerspDepth = rayPerspDepth0;\n    // could probably optimize this:\n    float dRayD = (rayPerspDepth1 - rayPerspDepth0) * stepRatio;\n\n    float rcpW = rcpW0;\n    float dRcpW = (rcpW1 - rcpW0) * stepRatio;\n    float sceneDepth = rayDepth;\n\n    float amount = 0.0;\n\n    hitUV += dUV * dither.z;\n    rayPerspDepth += dRayD * dither.z;\n    rcpW += dRcpW * dither.z;\n\n    float sampleCount;\n    for (int i = 0; i < NUM_SAMPLES; ++i) {\n        rayDepth = rayPerspDepth / rcpW;\n\n        sceneDepth = hx_sampleLinearDepth(hx_gbufferDepth, hitUV);\n\n        if (rayDepth > sceneDepth + .001) {\n            amount = float(sceneDepth < 1.0);\n            sampleCount = float(i);\n            break;\n        }\n\n        hitUV += dUV;\n        rayPerspDepth += dRayD;\n        rcpW += dRcpW;\n    }\n\n    hitZ = -hx_cameraNearPlaneDistance - sceneDepth * hx_cameraFrustumRange;\n\n    amount *= clamp((1.0 - (sampleCount - float(NUM_SAMPLES)) / float(NUM_SAMPLES)) * 5.0, 0.0, 1.0);\n    return amount;\n}\n\nvoid main()\n{\n    vec4 colorSample = hx_gammaToLinear(texture2D(hx_gbufferColor, uv));\n    vec4 specularSample = texture2D(hx_gbufferSpecular, uv);\n    float depth = hx_sampleLinearDepth(hx_gbufferDepth, uv);\n    vec3 normalSpecularReflectance;\n    float roughness;\n    float metallicness;\n    hx_decodeReflectionData(colorSample, specularSample, normalSpecularReflectance, roughness, metallicness);\n    vec3 normal = hx_decodeNormal(texture2D(hx_gbufferNormals, uv));\n    vec3 reflDir = reflect(normalize(viewDir), normal);\n\n    vec3 fresnel = hx_fresnel(normalSpecularReflectance, reflDir, normal);\n    // not physically correct, but attenuation is required to look good\n\n    // step for every pixel\n\n    float absViewY = hx_cameraNearPlaneDistance + depth * hx_cameraFrustumRange;\n    vec3 viewSpacePos = absViewY * viewDir;\n\n    float hitY = 0.0;\n    vec2 hitUV;\n    float amount = raytrace(viewSpacePos, reflDir, hitY, hitUV);\n    float fadeFactor = 1.0 - clamp(reflDir.z * 2.0, 0.0, 1.0);\n\n    vec2 borderFactors = abs(hitUV * 2.0 - 1.0);\n    borderFactors = (1.0 - borderFactors) * 10.0;\n    fadeFactor *= clamp(borderFactors.x, 0.0, 1.0) * clamp(borderFactors.y, 0.0, 1.0);\n\n    float diff = viewSpacePos.y - hitY;\n    fadeFactor *= hx_linearStep(-1.0, 0.0, diff);\n    fadeFactor *= hx_linearStep(maxRoughness, 0.0, roughness);\n\n    vec4 reflColor = texture2D(hx_frontbuffer, hitUV);\n\n    float amountUsed = amount * fadeFactor;\n    hx_FragColor = vec4(fresnel * reflColor.xyz, amountUsed);\n}\n\n',d._files["ssr_stencil_fragment.glsl"]="uniform sampler2D hx_gbufferSpecular;\n\nvarying_in vec2 uv;\n\nuniform float maxRoughness;\n\nvoid main()\n{\n    vec4 specularSample = texture2D(hx_gbufferSpecular, uv);\n    if (specularSample.x > maxRoughness)\n        discard;\n}\n\n",d._files["tonemap_filmic_fragment.glsl"]="void main()\n{\n\tvec3 x = hx_getToneMapScaledColor().xyz * 16.0;\n\n    // Uncharted 2 tonemapping (http://filmicworlds.com/blog/filmic-tonemapping-operators/)\n\n\tfloat A = 0.15;\n    float B = 0.50;\n    float C = 0.10;\n    float D = 0.20;\n    float E = 0.02;\n    float F = 0.30;\n    float W = 11.2;\n\n    hx_FragColor.xyz = hx_gammaToLinear(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\n    hx_FragColor.w = 1.0;\n}",d._files["tonemap_reference_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D hx_backbuffer;\n\nvoid main()\n{\n\tvec4 color = texture2D(hx_backbuffer, uv);\n\tfloat lum = clamp(hx_luminance(color), 0.0, 1000.0);\n\tfloat l = log(1.0 + lum);\n\thx_FragColor = vec4(l, l, l, 1.0);\n}",d._files["tonemap_reinhard_fragment.glsl"]="void main()\n{\n\tvec4 color = hx_getToneMapScaledColor();\n\tfloat lum = hx_luminance(color);\n\thx_FragColor = color / (1.0 + lum);\n}",d._files["esm_blur_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D source;\nuniform vec2 direction; // this is 1/pixelSize\n\nfloat readValue(vec2 coord)\n{\n    float v = texture2D(source, coord).x;\n    return v;\n//    return exp(HX_ESM_CONSTANT * v);\n}\n\nvoid main()\n{\n    float total = readValue(uv);\n\n\tfor (int i = 1; i <= RADIUS; ++i) {\n\t    vec2 offset = direction * float(i);\n\t\ttotal += readValue(uv + offset) + readValue(uv - offset);\n\t}\n\n//\thx_FragColor = vec4(log(total * RCP_NUM_SAMPLES) / HX_ESM_CONSTANT);\n\thx_FragColor = vec4(total * RCP_NUM_SAMPLES);\n}",d._files["shadow_esm.glsl"]="vec4 hx_getShadowMapValue(float depth)\n{\n    // I wish we could write exp directly, but precision issues (can't encode real floats)\n    return vec4(exp(HX_ESM_CONSTANT * depth));\n// so when blurring, we'll need to do ln(sum(exp())\n//    return vec4(depth);\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec4 shadowMapCoord, float depthBias)\n{\n    float shadowSample = texture2D(shadowMap, shadowMapCoord.xy).x;\n    shadowMapCoord.z += depthBias;\n//    float diff = shadowSample - shadowMapCoord.z;\n//    return saturate(HX_ESM_DARKENING * exp(HX_ESM_CONSTANT * diff));\n    return saturate(HX_ESM_DARKENING * shadowSample * exp(-HX_ESM_CONSTANT * shadowMapCoord.z));\n}",d._files["shadow_hard.glsl"]="vec4 hx_getShadowMapValue(float depth)\n{\n    return hx_floatToRGBA8(depth);\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec4 shadowMapCoord, float depthBias)\n{\n    float shadowSample = hx_RGBA8ToFloat(texture2D(shadowMap, shadowMapCoord.xy));\n    float diff = shadowMapCoord.z - shadowSample - depthBias;\n    return float(diff < 0.0);\n}",d._files["shadow_pcf.glsl"]="#ifdef HX_PCF_DITHER_SHADOWS\n    uniform sampler2D hx_dither2D;\n    uniform vec2 hx_dither2DTextureScale;\n#endif\n\nuniform vec2 hx_poissonDisk[32];\n\nvec4 hx_getShadowMapValue(float depth)\n{\n    return hx_floatToRGBA8(depth);\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec4 shadowMapCoord, float depthBias)\n{\n    float shadowTest = 0.0;\n\n    #ifdef HX_PCF_DITHER_SHADOWS\n        vec4 dither = hx_sampleDefaultDither(hx_dither2D, gl_FragCoord.xy * hx_dither2DTextureScale);\n        dither = vec4(dither.x, -dither.y, dither.y, dither.x) * HX_PCF_SOFTNESS;  // add radius scale\n    #else\n        vec4 dither = vec4(HX_PCF_SOFTNESS);\n    #endif\n\n    for (int i = 0; i < HX_PCF_NUM_SHADOW_SAMPLES; ++i) {\n        vec2 offset;\n        offset.x = dot(dither.xy, hx_poissonDisk[i]);\n        offset.y = dot(dither.zw, hx_poissonDisk[i]);\n        float shadowSample = hx_RGBA8ToFloat(texture2D(shadowMap, shadowMapCoord.xy + offset));\n        float diff = shadowMapCoord.z - shadowSample - depthBias;\n        shadowTest += float(diff < 0.0);\n    }\n\n    return shadowTest * HX_PCF_RCP_NUM_SHADOW_SAMPLES;\n}",d._files["shadow_vsm.glsl"]="#derivatives\n\nvec4 hx_getShadowMapValue(float depth)\n{\n    float dx = dFdx(depth);\n    float dy = dFdy(depth);\n    float moment2 = depth * depth + 0.25*(dx*dx + dy*dy);\n\n    #if defined(HX_HALF_FLOAT_TEXTURES_LINEAR) || defined(HX_FLOAT_TEXTURES_LINEAR)\n    return vec4(depth, moment2, 0.0, 1.0);\n    #else\n    return vec4(hx_floatToRG8(depth), hx_floatToRG8(moment2));\n    #endif\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec4 shadowMapCoord, float depthBias)\n{\n    vec4 s = texture2D(shadowMap, shadowMapCoord.xy);\n    #if defined(HX_HALF_FLOAT_TEXTURES_LINEAR) || defined(HX_FLOAT_TEXTURES_LINEAR)\n    vec2 moments = s.xy;\n    #else\n    vec2 moments = vec2(hx_RG8ToFloat(s.xy), hx_RG8ToFloat(s.zw));\n    #endif\n    shadowMapCoord.z += depthBias;\n\n    float variance = moments.y - moments.x * moments.x;\n    variance = max(variance, HX_VSM_MIN_VARIANCE);\n\n    float diff = shadowMapCoord.z - moments.x;\n    float upperBound = 1.0;\n\n    // transparents could be closer to the light than casters\n    if (diff > 0.0)\n        upperBound = variance / (variance + diff*diff);\n\n    return saturate((upperBound - HX_VSM_LIGHT_BLEED_REDUCTION) * HX_VSM_RCP_LIGHT_BLEED_REDUCTION_RANGE);\n}",d._files["vsm_blur_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D source;\nuniform vec2 direction; // this is 1/pixelSize\n\nvec2 readValues(vec2 coord)\n{\n    vec4 s = texture2D(source, coord);\n    #if defined(HX_HALF_FLOAT_TEXTURES_LINEAR) || defined(HX_FLOAT_TEXTURES_LINEAR)\n    return s.xy;\n    #else\n    return vec2(hx_RG8ToFloat(s.xy), hx_RG8ToFloat(s.zw));\n    #endif\n}\n\nvoid main()\n{\n    vec2 total = readValues(uv);\n\n\tfor (int i = 1; i <= RADIUS; ++i) {\n\t    vec2 offset = direction * float(i);\n\t\ttotal += readValues(uv + offset) + readValues(uv - offset);\n\t}\n\n    total *= RCP_NUM_SAMPLES;\n\n#if defined(HX_HALF_FLOAT_TEXTURES_LINEAR) || defined(HX_FLOAT_TEXTURES_LINEAR)\n    hx_FragColor = vec4(total, 0.0, 1.0);\n#else\n\thx_FragColor.xy = hx_floatToRG8(total.x);\n\thx_FragColor.zw = hx_floatToRG8(total.y);\n#endif\n}",d._files["snippets_general.glsl"]="#define HX_LOG_10 2.302585093\n\n#ifdef HX_GLSL_300_ES\n// replace some outdated function names\nvec4 texture2D(sampler2D s, vec2 uv) { return texture(s, uv); }\nvec4 textureCube(samplerCube s, vec3 uvw) { return texture(s, uvw); }\n\n#define vertex_attribute in\n#define varying_in in\n#define varying_out out\n\n#ifdef HX_FRAGMENT_SHADER\nout vec4 hx_FragColor;\n#endif\n\n#else\n\n#define vertex_attribute attribute\n#define varying_in varying\n#define varying_out varying\n#define hx_FragColor gl_FragColor\n\n#endif\n\nfloat saturate(float value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\nvec2 saturate(vec2 value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\nvec4 saturate(vec4 value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\n// Only for 0 - 1\nvec4 hx_floatToRGBA8(float value)\n{\n    vec4 enc = value * vec4(1.0, 255.0, 65025.0, 16581375.0);\n    // cannot fract first value or 1 would not be encodable\n    enc.yzw = fract(enc.yzw);\n    return enc - enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n}\n\nfloat hx_RGBA8ToFloat(vec4 rgba)\n{\n    return dot(rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0));\n}\n\nvec2 hx_floatToRG8(float value)\n{\n    vec2 enc = vec2(1.0, 255.0) * value;\n    enc.y = fract(enc.y);\n    enc.x -= enc.y / 255.0;\n    return enc;\n}\n\nfloat hx_RG8ToFloat(vec2 rg)\n{\n    return dot(rg, vec2(1.0, 1.0/255.0));\n}\n\nvec2 hx_encodeNormal(vec3 normal)\n{\n    vec2 data;\n    float p = sqrt(-normal.y*8.0 + 8.0);\n    data = normal.xz / p + .5;\n    return data;\n}\n\nvec3 hx_decodeNormal(vec4 data)\n{\n    vec3 normal;\n    data.xy = data.xy*4.0 - 2.0;\n    float f = dot(data.xy, data.xy);\n    float g = sqrt(1.0 - f * .25);\n    normal.xz = data.xy * g;\n    normal.y = -(1.0 - f * .5);\n    return normal;\n}\n\nfloat hx_log10(float val)\n{\n    return log(val) / HX_LOG_10;\n}\n\nvec4 hx_gammaToLinear(vec4 color)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        color.x = pow(color.x, 2.2);\n        color.y = pow(color.y, 2.2);\n        color.z = pow(color.z, 2.2);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        color.xyz *= color.xyz;\n    #endif\n    return color;\n}\n\nvec3 hx_gammaToLinear(vec3 color)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        color.x = pow(color.x, 2.2);\n        color.y = pow(color.y, 2.2);\n        color.z = pow(color.z, 2.2);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        color.xyz *= color.xyz;\n    #endif\n    return color;\n}\n\nvec4 hx_linearToGamma(vec4 linear)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        linear.x = pow(linear.x, 0.454545);\n        linear.y = pow(linear.y, 0.454545);\n        linear.z = pow(linear.z, 0.454545);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        linear.xyz = sqrt(linear.xyz);\n    #endif\n    return linear;\n}\n\nvec3 hx_linearToGamma(vec3 linear)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        linear.x = pow(linear.x, 0.454545);\n        linear.y = pow(linear.y, 0.454545);\n        linear.z = pow(linear.z, 0.454545);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        linear.xyz = sqrt(linear.xyz);\n    #endif\n    return linear;\n}\n\n/*float hx_sampleLinearDepth(sampler2D tex, vec2 uv)\n{\n    return hx_RGBA8ToFloat(texture2D(tex, uv));\n}*/\n\nfloat hx_decodeLinearDepth(vec4 samp)\n{\n    return hx_RG8ToFloat(samp.zw);\n}\n\nvec3 hx_getFrustumVector(vec2 position, mat4 unprojectionMatrix)\n{\n    vec4 unprojNear = unprojectionMatrix * vec4(position, -1.0, 1.0);\n    vec4 unprojFar = unprojectionMatrix * vec4(position, 1.0, 1.0);\n    return unprojFar.xyz/unprojFar.w - unprojNear.xyz/unprojNear.w;\n}\n\n// view vector with z = 1, so we can use nearPlaneDist + linearDepth * (farPlaneDist - nearPlaneDist) as a scale factor to find view space position\nvec3 hx_getLinearDepthViewVector(vec2 position, mat4 unprojectionMatrix)\n{\n    vec4 unproj = unprojectionMatrix * vec4(position, 0.0, 1.0);\n    unproj /= unproj.w;\n    return unproj.xyz / unproj.y;\n}\n\n// THIS IS FOR NON_LINEAR DEPTH!\nfloat hx_depthToViewY(float depthSample, mat4 projectionMatrix)\n{\n    // View Y maps to NDC Z!!!\n    // y = projectionMatrix[3][2] / (d * 2.0 - 1.0 + projectionMatrix[1][2])\n    return projectionMatrix[3][2] / (depthSample * 2.0 - 1.0 + projectionMatrix[1][2]);\n}\n\nvec3 hx_getNormalSpecularReflectance(float metallicness, float insulatorNormalSpecularReflectance, vec3 color)\n{\n    return mix(vec3(insulatorNormalSpecularReflectance), color, metallicness);\n}\n\nvec3 hx_fresnel(vec3 normalSpecularReflectance, vec3 lightDir, vec3 halfVector)\n{\n    float cosAngle = 1.0 - max(dot(halfVector, lightDir), 0.0);\n    // to the 5th power\n    float power = pow(cosAngle, 5.0);\n    return normalSpecularReflectance + (1.0 - normalSpecularReflectance) * power;\n}\n\n// https://seblagarde.wordpress.com/2011/08/17/hello-world/\nvec3 hx_fresnelProbe(vec3 normalSpecularReflectance, vec3 lightDir, vec3 normal, float roughness)\n{\n    float cosAngle = 1.0 - max(dot(normal, lightDir), 0.0);\n    // to the 5th power\n    float power = pow(cosAngle, 5.0);\n    float gloss = (1.0 - roughness) * (1.0 - roughness);\n    vec3 bound = max(vec3(gloss), normalSpecularReflectance);\n    return normalSpecularReflectance + (bound - normalSpecularReflectance) * power;\n}\n\n\nfloat hx_luminance(vec4 color)\n{\n    return dot(color.xyz, vec3(.30, 0.59, .11));\n}\n\nfloat hx_luminance(vec3 color)\n{\n    return dot(color, vec3(.30, 0.59, .11));\n}\n\n// linear variant of smoothstep\nfloat hx_linearStep(float lower, float upper, float x)\n{\n    return clamp((x - lower) / (upper - lower), 0.0, 1.0);\n}\n\nvec4 hx_sampleDefaultDither(sampler2D ditherTexture, vec2 uv)\n{\n    vec4 s = texture2D(ditherTexture, uv);\n\n    #ifndef HX_FLOAT_TEXTURES\n    s = s * 2.0 - 1.0;\n    #endif\n\n    return s;\n}\n\nvec3 hx_intersectCubeMap(vec3 rayOrigin, vec3 cubeCenter, vec3 rayDir, float cubeSize)\n{\n    vec3 t = (cubeSize * sign(rayDir) - (rayOrigin - cubeCenter)) / rayDir;\n    float minT = min(min(t.x, t.y), t.z);\n    return rayOrigin + minT * rayDir;\n}\n\n// sadly, need a parameter due to a bug in Internet Explorer / Edge. Just pass in 0.\n#ifdef HX_USE_SKINNING_TEXTURE\n#define HX_RCP_MAX_SKELETON_JOINTS 1.0 / float(HX_MAX_SKELETON_JOINTS - 1)\nmat4 hx_getSkinningMatrixImpl(vec4 weights, vec4 indices, sampler2D tex)\n{\n    mat4 m = mat4(0.0);\n    for (int i = 0; i < 4; ++i) {\n        mat4 t;\n        float index = indices[i] * HX_RCP_MAX_SKELETON_JOINTS;\n        t[0] = texture2D(tex, vec2(index, 0.0));\n        t[1] = texture2D(tex, vec2(index, 0.5));\n        t[2] = texture2D(tex, vec2(index, 1.0));\n        t[3] = vec4(0.0, 0.0, 0.0, 1.0);\n        m += weights[i] * t;\n    }\n    return m;\n}\n#define hx_getSkinningMatrix(v) hx_getSkinningMatrixImpl(hx_jointWeights, hx_jointIndices, hx_skinningTexture)\n#else\n#define hx_getSkinningMatrix(v) ( hx_jointWeights.x * mat4(hx_skinningMatrices[int(hx_jointIndices.x) * 3], hx_skinningMatrices[int(hx_jointIndices.x) * 3 + 1], hx_skinningMatrices[int(hx_jointIndices.x) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) + hx_jointWeights.y * mat4(hx_skinningMatrices[int(hx_jointIndices.y) * 3], hx_skinningMatrices[int(hx_jointIndices.y) * 3 + 1], hx_skinningMatrices[int(hx_jointIndices.y) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) + hx_jointWeights.z * mat4(hx_skinningMatrices[int(hx_jointIndices.z) * 3], hx_skinningMatrices[int(hx_jointIndices.z) * 3 + 1], hx_skinningMatrices[int(hx_jointIndices.z) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) + hx_jointWeights.w * mat4(hx_skinningMatrices[int(hx_jointIndices.w) * 3], hx_skinningMatrices[int(hx_jointIndices.w) * 3 + 1], hx_skinningMatrices[int(hx_jointIndices.w) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) )\n#endif",d._files["snippets_geometry.glsl"]="struct HX_GeometryData\n{\n    vec4 color;\n    vec3 normal;\n    float metallicness;\n    float normalSpecularReflectance;\n    float roughness;\n    float occlusion;\n    vec3 emission;\n    vec4 data;  // this can be anything the lighting model requires (only works with forward rendering)\n};",d._files["snippets_tonemap.glsl"]="varying_in vec2 uv;\n\n#ifdef HX_ADAPTIVE\nuniform sampler2D hx_luminanceMap;\nuniform float hx_luminanceMipLevel;\n#endif\n\nuniform float hx_exposure;\nuniform float hx_key;\n\nuniform sampler2D hx_backbuffer;\n\n\nvec4 hx_getToneMapScaledColor()\n{\n    #ifdef HX_ADAPTIVE\n    #ifdef HX_GLSL_300_ES\n    float referenceLuminance = textureLod(hx_luminanceMap, uv, hx_luminanceMipLevel).x;\n    #else\n    float referenceLuminance = texture2DLodEXT(hx_luminanceMap, uv, hx_luminanceMipLevel).x;\n    #endif\n    referenceLuminance = exp(referenceLuminance) - 1.0;\n    referenceLuminance = clamp(referenceLuminance, .08, 1000.0);\n\tfloat exposure = hx_key / referenceLuminance * hx_exposure;\n\t#else\n\tfloat exposure = hx_exposure;\n\t#endif\n    return texture2D(hx_backbuffer, uv) * exposure;\n}",d._files["2d_to_cube_vertex.glsl"]="// position to write to\nvertex_attribute vec4 hx_position;\n\n// the corner of the cube map\nvertex_attribute vec3 corner;\n\nvarying_out vec3 direction;\n\nvoid main()\n{\n    direction = corner;\n    gl_Position = hx_position;\n}\n",d._files["equirectangular_to_cube_fragment.glsl"]="#define RECIPROCAL_PI2 0.15915494\n\nvarying_in vec3 direction;\n\nuniform sampler2D source;\n\nvoid main()\n{\n    vec3 dir = normalize(direction);\n    vec2 uv;\n    uv.x = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tuv.y = dir.y * 0.5 + 0.5;\n    hx_FragColor = texture2D(source, uv);\n}\n",d._files["greyscale_to_rgba8.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D source;\n\nvoid main()\n{\n    hx_FragColor = hx_floatToRGBA8(texture2D(source, uv).x);\n}\n",d._files["smooth_heightmap_fragment.glsl"]="varying_in vec2 uv;\n\nuniform sampler2D reference;    // the source (8 bit) texture\nuniform sampler2D source;\n\nuniform vec2 stepSize;\n\nvoid main()\n{\n    float gauss[4];\n    gauss[0] = 0.201788613113303;\n    gauss[1] = 0.17755834971394;\n    gauss[2] = 0.120969095455128;\n    gauss[3] = 0.063811162332456;\n    float refHeight = texture2D(reference, uv).x;\n    float total = hx_RGBA8ToFloat(texture2D(source, uv)) * gauss[0];\n    float totalWeight = gauss[0];\n    float currentWeightL = 1.0;\n    float currentWeightR = 1.0;\n    vec2 offset = vec2(0.0);\n\n\n    for (int i = 0; i < 3; ++i) {\n        offset += stepSize;\n        float refLeft = texture2D(reference, uv - offset).x;\n        float refRight = texture2D(reference, uv + offset).x;\n        float heightLeft = hx_RGBA8ToFloat(texture2D(source, uv - offset));\n        float heightRight = hx_RGBA8ToFloat(texture2D(source, uv + offset));\n        // smooth out over N pixels that have the same reference height in the source image\n        currentWeightL = max(currentWeightL - abs(refLeft - refHeight) * 5.0, 0.0);\n        currentWeightR = max(currentWeightR - abs(refRight - refHeight) * 5.0, 0.0);\n        totalWeight += (currentWeightL + currentWeightR) * gauss[i + 1];\n        total += (heightLeft * currentWeightL + heightRight * currentWeightR) *  gauss[i + 1];\n    }\n\n    hx_FragColor = hx_floatToRGBA8(total / totalWeight);\n//    hx_FragColor = hx_floatToRGBA8(refHeight);\n}\n",d._files["ao_blur_fragment.glsl"]="varying_in vec2 uv1;\nvarying_in vec2 uv2;\nvarying_in vec2 uv3;\nvarying_in vec2 uv4;\n\nuniform sampler2D source;\n\nvoid main()\n{\n    vec4 total = texture2D(source, uv1) + texture2D(source, uv2) + texture2D(source, uv3) + texture2D(source, uv4);\n\thx_FragColor = total * .25;\n}",d._files["ao_blur_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nvarying_out vec2 uv1;\nvarying_out vec2 uv2;\nvarying_out vec2 uv3;\nvarying_out vec2 uv4;\n\nuniform vec2 pixelSize;\n\nvoid main()\n{\n\tuv1 = hx_texCoord + vec2(-1.5, .5) * pixelSize;\n\tuv2 = hx_texCoord + vec2(.5, .5) * pixelSize;\n\tuv3 = hx_texCoord + vec2(.5, -1.5) * pixelSize;\n\tuv4 = hx_texCoord + vec2(-1.5, -1.5) * pixelSize;\n\tgl_Position = hx_position;\n}",d._files["hbao_fragment.glsl"]="uniform float hx_cameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\nuniform vec2 hx_rcpRenderTargetResolution;\nuniform mat4 hx_projectionMatrix;\n\nuniform float strengthPerRay;\nuniform float halfSampleRadius;\nuniform float bias;\nuniform float rcpFallOffDistance;\nuniform vec2 ditherScale;\n\nuniform sampler2D hx_normalDepthBuffer;\nuniform sampler2D sampleDirTexture;\nuniform sampler2D ditherTexture;\n\nvarying_in vec2 uv;\nvarying_in vec3 viewDir;\nvarying_in vec3 frustumCorner;\n\nvec3 getViewPos(vec2 sampleUV)\n{\n    vec4 smp = texture2D(hx_normalDepthBuffer, sampleUV);\n    float depth = hx_decodeLinearDepth(smp);\n    float viewY = hx_cameraNearPlaneDistance + depth * hx_cameraFrustumRange;\n    vec3 viewPos = frustumCorner * vec3(sampleUV.x * 2.0 - 1.0, 1.0, sampleUV.y * 2.0 - 1.0);\n    return viewPos * viewY;\n}\n\n// Retrieves the occlusion factor for a particular sample\nfloat getSampleOcclusion(vec2 sampleUV, vec3 centerViewPos, vec3 centerNormal, vec3 tangent, inout float topOcclusion)\n{\n    vec3 sampleViewPos = getViewPos(sampleUV);\n\n    // get occlusion factor based on candidate horizon elevation\n    vec3 horizonVector = sampleViewPos - centerViewPos;\n    float horizonVectorLength = length(horizonVector);\n\n    float occlusion;\n\n    // If the horizon vector points away from the tangent, make an estimate\n    if (dot(tangent, horizonVector) < 0.0)\n        occlusion = .5;\n    else\n        occlusion = dot(centerNormal, horizonVector) / horizonVectorLength;\n\n    // this adds occlusion only if angle of the horizon vector is higher than the previous highest one without branching\n    float diff = max(occlusion - topOcclusion, 0.0);\n    topOcclusion = max(occlusion, topOcclusion);\n\n    // attenuate occlusion contribution using distance function 1 - (d/f)^2\n    float distanceFactor = 1.0 - saturate(horizonVectorLength * rcpFallOffDistance);\n    return diff * distanceFactor;\n}\n\n// Retrieves the occlusion for a given ray\nfloat getRayOcclusion(vec2 direction, float jitter, vec2 projectedRadii, vec3 centerViewPos, vec3 centerNormal)\n{\n    // calculate the nearest neighbour sample along the direction vector\n    vec2 texelSizedStep = direction * hx_rcpRenderTargetResolution;\n    direction *= projectedRadii;\n\n    // gets the tangent for the current ray, this will be used to handle opposing horizon vectors\n    // Tangent is corrected with respect to face normal by projecting it onto the tangent plane defined by the normal\n    vec3 tangent = getViewPos(uv + texelSizedStep) - centerViewPos;\n    tangent -= dot(centerNormal, tangent) * centerNormal;\n\n    vec2 stepUV = direction.xy / float(NUM_SAMPLES_PER_RAY - 1);\n\n    // jitter the starting position for ray marching between the nearest neighbour and the sample step size\n    vec2 jitteredOffset = mix(texelSizedStep, stepUV, jitter);\n    //stepUV *= 1.0 + jitter * .1;\n    vec2 sampleUV = uv + jitteredOffset;\n\n    // top occlusion keeps track of the occlusion contribution of the last found occluder.\n    // set to bias value to avoid near-occluders\n    float topOcclusion = bias;\n    float occlusion = 0.0;\n\n    // march!\n    for (int step = 0; step < NUM_SAMPLES_PER_RAY; ++step) {\n        occlusion += getSampleOcclusion(sampleUV, centerViewPos, centerNormal, tangent, topOcclusion);\n        sampleUV += stepUV;\n    }\n\n    return occlusion;\n}\n\nvoid main()\n{\n    vec4 normalDepth = texture2D(hx_normalDepthBuffer, uv);\n    vec3 centerNormal = hx_decodeNormal(normalDepth);\n    float centerDepth = hx_decodeLinearDepth(normalDepth);\n    float viewY = hx_cameraNearPlaneDistance + centerDepth * hx_cameraFrustumRange;\n    vec3 centerViewPos = viewY * viewDir;\n\n    // clamp z to a minimum, so the radius does not get excessively large in screen-space\n    float projRadius = halfSampleRadius / max(centerViewPos.y, 7.0);\n    vec2 projectedRadii = projRadius * vec2(hx_projectionMatrix[0][0], hx_projectionMatrix[1][2]);\n\n    // do not take more steps than there are pixels\n    float totalOcclusion = 0.0;\n\n    vec2 randomFactors = texture2D(ditherTexture, uv * ditherScale).xy;\n\n    vec2 rayUV = vec2(0.0);\n    for (int i = 0; i < NUM_RAYS; ++i) {\n        rayUV.x = (float(i) + randomFactors.x) / float(NUM_RAYS);\n        vec2 sampleDir = texture2D(sampleDirTexture, rayUV).xy * 2.0 - 1.0;\n        totalOcclusion += getRayOcclusion(sampleDir, randomFactors.y, projectedRadii, centerViewPos, centerNormal);\n    }\n\n    totalOcclusion = 1.0 - clamp(strengthPerRay * totalOcclusion, 0.0, 1.0);\n    hx_FragColor = vec4(vec3(totalOcclusion), 1.0);\n}",d._files["hbao_vertex.glsl"]="vertex_attribute vec4 hx_position;\nvertex_attribute vec2 hx_texCoord;\n\nuniform mat4 hx_inverseProjectionMatrix;\n\nvarying_out vec2 uv;\nvarying_out vec3 viewDir;\nvarying_out vec3 frustumCorner;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    viewDir = hx_getLinearDepthViewVector(hx_position.xy, hx_inverseProjectionMatrix);\n    frustumCorner = hx_getLinearDepthViewVector(vec2(1.0, 1.0), hx_inverseProjectionMatrix);\n    gl_Position = hx_position;\n}",d._files["ssao_fragment.glsl"]='uniform mat4 hx_projectionMatrix;\nuniform mat4 hx_cameraWorldMatrix;\nuniform float hx_cameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\n\nuniform vec2 ditherScale;\nuniform float strengthPerSample;\nuniform float rcpFallOffDistance;\nuniform float sampleRadius;\nuniform vec3 samples[NUM_SAMPLES]; // w contains bias\n\nuniform sampler2D ditherTexture;\nuniform sampler2D hx_normalDepthBuffer;\n\nvarying_in vec2 uv;\n\nvoid main()\n{\n    vec4 normalDepth = texture2D(hx_normalDepthBuffer, uv);\n    vec3 centerNormal = hx_decodeNormal(normalDepth);\n    float centerDepth = hx_decodeLinearDepth(normalDepth);\n    float totalOcclusion = 0.0;\n    vec3 dither = texture2D(ditherTexture, uv * ditherScale).xyz;\n    vec3 randomPlaneNormal = normalize(dither - .5);\n    float w = hx_cameraNearPlaneDistance + centerDepth * hx_cameraFrustumRange;\n    float centerY = centerDepth * hx_cameraFrustumRange;    // can ignore nearDist\n    vec3 sampleRadii;\n    sampleRadii.xz = sampleRadius * .5 / w * vec2(hx_projectionMatrix[0][0], hx_projectionMatrix[1][2]);\n    sampleRadii.y = sampleRadius;\n\n    for (int i = 0; i < NUM_SAMPLES; ++i) {\n        vec3 sampleOffset = reflect(samples[i], randomPlaneNormal);\n        vec3 normOffset = normalize(sampleOffset);\n\n        // mirror sample position to the positive side of the plane\n        float cosFactor = dot(normOffset, centerNormal);\n        float sign = sign(cosFactor);\n        sampleOffset *= sign;\n        cosFactor *= sign;\n\n        vec3 scaledOffset = sampleOffset * sampleRadii;\n\n        vec2 samplePos = uv + scaledOffset.xz;\n        normalDepth = texture2D(hx_normalDepthBuffer, samplePos);\n        float occluderDepth = hx_decodeLinearDepth(normalDepth);\n\n        // can ignore nearDist\n        float occluderY = hx_cameraFrustumRange * occluderDepth;\n        float sampleY = centerY + scaledOffset.y;\n\n        float distanceFactor = max(1.0 - (sampleY - occluderY) * rcpFallOffDistance, 0.0);\n\n        // at this point, occlusion really means occlusion, and not the output "colour" (ie 1 = completely occluded)\n        float sampleOcclusion = float(occluderY < sampleY);\n\n        // if cosFactor = 0, the sample is coplanar, and occludes less\n        totalOcclusion += sampleOcclusion * distanceFactor * cosFactor;\n    }\n    hx_FragColor = vec4(vec3(1.0 - totalOcclusion * strengthPerSample), 1.0);\n}';var u={shuffle:function(t){for(var e,i,n=t.length;0!==n;)i=Math.floor(Math.random()*n),e=t[n-=1],t[n]=t[i],t[i]=e;return t},forEach:function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(t[i],i)}};function n(){this._listeners=[],this._lookUp={}}function e(){this._isRunning=!1,this._dt=0,this._currentTime=0,this._tickFunc=this._tick.bind(this),this.onTick=new n}function h(t,e,i,n){this.r=0,this.g=0,this.b=0,this.a=1,this.set(t,e,i,n)}n.prototype={bind:function(t,e){this._lookUp[t]=this._listeners.length;var i=e?t.bind(e):t;this._listeners.push(i)},unbind:function(t){var e=this._lookUp[t];void 0!==e&&(this._listeners.splice(e,1),delete this._lookUp[t])},unbindAll:function(){this._listeners=[],this._lookUp={}},dispatch:function(t){for(var e=this._listeners.length,i=0;i<e;++i)this._listeners[i].apply(null,arguments)},get hasListeners(){return 0<this._listeners.length}},e.prototype={start:function(){this._isRunning||(this._currentTime=0,this._isRunning=!0,requestAnimationFrame(this._tickFunc))},stop:function(){this._isRunning=!1},get dt(){return this._dt},get time(){return this._currentTime},_tick:function(t){this._isRunning&&(requestAnimationFrame(this._tickFunc),0===this._currentTime?this._dt=16:this._dt=t-this._currentTime,this._currentTime=t,this.onTick.dispatch(this._dt))}},h.lerp=function(t,e,i,n){n=n||new h;var r=t.r,s=t.g,o=t.b,a=t.a;return n.r=r+(e.r-r)*i,n.g=s+(e.g-s)*i,n.b=o+(e.b-o)*i,n.a=a+(e.a-a)*i,n},h.prototype={set:function(t,e,i,n){void 0===t?(this.a=1,this.r=1,this.g=1,this.b=1):void 0===e?(this.a=1,this.r=((16711680&t)>>>16)/255,this.g=((65280&t)>>>8)/255,this.b=(255&t)/255):(this.r=t,this.g=e,this.b=i,this.a=void 0===n?1:n)},scale:function(t){this.r*=t,this.g*=t,this.b*=t},hex:function(){return 255*Math.min(this.r,1)<<16|255*Math.min(this.g,1)<<8|255*Math.min(this.b,1)},luminance:function(){return.3*this.r+.59*this.g+.11*this.b},gammaToLinear:function(t){return t=t||new h,te.OPTIONS.usePreciseGammaCorrection?(t.r=Math.pow(this.r,2.2),t.g=Math.pow(this.g,2.2),t.b=Math.pow(this.b,2.2)):(t.r=this.r*this.r,t.g=this.g*this.g,t.b=this.b*this.b),t.a=this.a,t},linearToGamma:function(t){return t=t||new h,te.OPTIONS.usePreciseGammaCorrection?(t.r=Math.pow(this.r,.454545),t.g=Math.pow(this.g,.454545),t.b=Math.pow(this.b,.454545)):(t.r=Math.sqrt(this.r),t.g=Math.sqrt(this.g),t.b=Math.sqrt(this.b)),t.a=this.a,t},copyFrom:function(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a},toString:function(){return"Color("+this.r+", "+this.g+", "+this.b+", "+this.a+")"},clone:function(){var t=new h;return t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t}},h.BLACK=new h(0,0,0,1),h.ZERO=new h(0,0,0,0),h.RED=new h(1,0,0,1),h.GREEN=new h(0,1,0,1),h.BLUE=new h(0,0,1,1),h.YELLOW=new h(1,1,0,1),h.MAGENTA=new h(1,0,1,1),h.CYAN=new h(0,1,1,1),h.WHITE=new h(1,1,1,1);var r=0,a=!0,_=!0,l=!1,c=null,f=!1,p=null,m=null,i=null,s=null,o={numDrawCalls:0,numTriangles:0,numClears:0},g=null,B={gl:null,_setGL:function(t){B.gl=g=t},clear:function(t){void 0===t&&(t=Ie.COMPLETE),g.clear(t),++o.numClears},drawElements:function(t,e,i,n){n=n||g.UNSIGNED_SHORT,++o.numDrawCalls,o.numTriangles+=e/3,g.drawElements(t,e,n,2*i)},setViewport:function(t){t?g.viewport(t.x||0,t.y||0,t.width,t.height):g.viewport(0,0,te.TARGET_CANVAS.width,te.TARGET_CANVAS.height)},getCurrentRenderTarget:function(){return i},setColorMask:function(t){l||t===_||(_=t,g.colorMask(t,t,t,t))},lockColorMask:function(t){void 0!==t&&B.setColorMask(t),l=!0},unlockColorMask:function(t){void 0!==t&&B.setColorMask(t),l=!1},setRenderTarget:function(t){var e=i=t;e?(g.bindFramebuffer(g.FRAMEBUFFER,e._fbo),1<e._numColorTextures&&(Se.WEBGL_2?g.drawBuffers(e._drawBuffers):Se.EXT_DRAW_BUFFERS.drawBuffersWEBGL(e._drawBuffers))):g.bindFramebuffer(g.FRAMEBUFFER,null),B.setViewport(t)},enableAttributes:function(t){var e,i=r;if(i<t)for(e=i;e<t;++e)g.enableVertexAttribArray(e);else if(t<i)for(e=t+=1;e<i;++e)g.disableVertexAttribArray(e);r=t},setClearColor:function(t){t=t instanceof h?t:new h(t),g.clearColor(t.r,t.g,t.b,t.a)},setCullMode:function(t){if(c!==t){if(t===Ae.NONE)g.disable(g.CULL_FACE);else{c===Ae.NONE&&g.enable(g.CULL_FACE);var e=t;f&&(e===Ae.BACK?e=Ae.FRONT:e===Ae.FRONT&&(e=Ae.BACK)),g.cullFace(e)}c=t}},setInvertCulling:function(t){f!==t&&(f=t,c=Ae.NONE)},setDepthMask:function(t){a!==t&&(a=t,g.depthMask(a))},setDepthTest:function(t){p!==t&&((p=t)===Me.DISABLED?g.disable(g.DEPTH_TEST):(g.enable(g.DEPTH_TEST),g.depthFunc(p)))},setBlendState:function(t){if(m!==t){var e=m=t;if(e&&!1!==e.enabled){g.enable(g.BLEND),null===e.alphaSrcFactor||void 0===e.alphaSrcFactor?g.blendFunc(e.srcFactor,e.dstFactor):g.blendFuncSeparate(e.srcFactor,e.dstFactor,e.alphaSrcFactor,e.alphaDstFactor),null===e.alphaOperator||void 0===e.alphaOperator?g.blendEquation(e.operator):g.blendEquationSeparate(e.operator,e.alphaOperator);var i=e.color;i&&g.blendColor(i.r,i.g,i.b,i.a)}else g.disable(g.BLEND)}},updateStencilReferenceValue:function(t){var e=s;e&&e.reference!==t&&(e.reference=t,g.stencilFunc(e.comparison,t,e.readMask))},setStencilState:function(t){var e=s=t;e&&!1!==e.enabled?(g.enable(g.STENCIL_TEST),g.stencilFunc(e.comparison,e.reference,e.readMask),g.stencilOp(e.onStencilFail,e.onDepthFail,e.onPass),g.stencilMask(e.writeMask)):(g.disable(g.STENCIL_TEST),g.stencilFunc(Me.ALWAYS,0,255),g.stencilOp(Pe.KEEP,Pe.KEEP,Pe.KEEP))},setMaterialPassState:function(t,e,i,n,r){if(c!==t){if(t===Ae.NONE)g.disable(g.CULL_FACE);else{c===Ae.NONE&&g.enable(g.CULL_FACE);var s=t;f&&(s===Ae.BACK?s=Ae.FRONT:s===Ae.FRONT&&(s=Ae.BACK)),g.cullFace(s)}c=t}if(p!==e&&((p=e)===Me.DISABLED?g.disable(g.DEPTH_TEST):(g.enable(g.DEPTH_TEST),g.depthFunc(p))),a!==i&&(a=i,g.depthMask(a)),l||n===_||(_=n,g.colorMask(n,n,n,n)),m!==r)if((m=r)&&!1!==r.enabled){g.enable(g.BLEND),null===r.alphaSrcFactor||void 0===r.alphaSrcFactor?g.blendFunc(r.srcFactor,r.dstFactor):g.blendFuncSeparate(r.srcFactor,r.dstFactor,r.alphaSrcFactor,r.alphaDstFactor),null===r.alphaOperator||void 0===r.alphaOperator?g.blendEquation(r.operator):g.blendEquationSeparate(r.operator,r.alphaOperator);var o=r.color;o&&g.blendColor(o.r,o.g,o.b,o.a)}else g.disable(g.BLEND)}};function x(){this._blurShader=null,this._numBlurPasses=1,this._cullMode=Ae.FRONT}function v(){x.call(this)}x.prototype={get shadowMapFilter(){return Ee.NEAREST_NOMIP},get cullMode(){return this._cullMode},set cullMode(t){this._cullMode=t},getShadowMapFormat:function(){return Ne.RGBA},getShadowMapDataType:function(){return De.UNSIGNED_BYTE},getGLSL:function(){throw new Error("Abstract method called")},get blurShader(){return this._blurShader||(this._blurShader=this._createBlurShader()),this._blurShader},get numBlurPasses(){return this._numBlurPasses},set numBlurPasses(t){this._numBlurPasses=t},init:function(){},_createBlurShader:function(){},_invalidateBlurShader:function(){this._blurShader&&(this._blurShader=null)}},(v.prototype=Object.create(x.prototype)).getGLSL=function(){return d.get("shadow_hard.glsl")};var y,T,S={Unlit:null,BlinnPhong:d.get("lighting_blinn_phong.glsl"),GGX:d.get("lighting_ggx.glsl"),GGX_FULL:"#define HX_VISIBILITY_TERM\n"+d.get("lighting_ggx.glsl"),DEBUG:d.get("lighting_debug.glsl")},E={GENERAL:"precision highp float;\n\n"+d.get("snippets_general.glsl")+"\n\n",VERSION:""};function w(t,e){this.x=t||0,this.y=e||0}function A(t,e,i,n){this._mode=void 0===t?A.CIRCULAR:t,this._initialDistance=e||1,this._decayFactor=i||.99,this._maxTests=n||2e4,this._currentDistance=0,this._points=null,this.reset()}function O(t,e,i,n){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0===n?1:n}function P(t,e,i,n){this._mode=void 0===t?P.SPHERICAL:t,this._initialDistance=e||1,this._decayFactor=i||.99,this._maxTests=n||2e4,this._currentDistance=0,this._points=null,this.reset()}w.add=function(t,e,i){return(i=i||new w).x=t.x+e.x,i.y=t.y+e.y,i},w.subtract=function(t,e,i){return(i=i||new w).x=t.x-e.x,i.y=t.y-e.y,i},w.scale=function(t,e,i){return(i=i||new w).x=t.x*e,i.y=t.y*e,i},w.prototype={set:function(t,e){this.x=t,this.y=e},dot:function(t){return t.x*this.x+t.y*this.y},get lengthSqr(){return this.x*this.x+this.y*this.y},get length(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var t=1/this.length;this.x*=t,this.y*=t},clone:function(){return new w(this.x,this.y)},add:function(t){this.x+=t.x,this.y+=t.y},subtract:function(t){this.x-=t.x,this.y-=t.y},scale:function(t){this.x*=t,this.y*=t},negate:function(){this.x=-this.x,this.y=-this.y},negativeOf:function(t){this.x=-t.x,this.y=-t.y},abs:function(){this.x=Math.abs(this.x),this.y=Math.abs(this.y)},fromPolarCoordinates:function(t,e){this.x=t*Math.cos(e),this.y=t*Math.sin(e)},copyFrom:function(t){this.x=t.x,this.y=t.y},distanceTo:function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},squareDistanceTo:function(t){var e=t.x-this.x,i=t.y-this.y;return e*e+i*i},lerp:function(t,e,i){var n=t.x,r=t.y;this.x=n+(e.x-n)*i,this.y=r+(e.y-r)*i},maximize:function(t){t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y)},minimize:function(t){t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y)},angle:function(t){return Math.acos(this.dot(t)/(this.length*t.length))},angleNormalized:function(t){return Math.acos(this.dot(t))}},w.ZERO=new w(0,0),w.X_AXIS=new w(1,0),w.Y_AXIS=new w(0,1),A.SQUARE=0,A.CIRCULAR=1,A._initDefault=function(){(A.DEFAULT=new A).generatePoints(64),A.DEFAULT_FLOAT32=new Float32Array(128);for(var t=A.DEFAULT.getPoints(),e=0;e<64;++e){var i=t[e];A.DEFAULT_FLOAT32[2*e]=i.x,A.DEFAULT_FLOAT32[2*e+1]=i.y}},A.prototype={getPoints:function(){return this._points},reset:function(){this._currentDistance=this._initialDistance,this._points=[]},generatePoints:function(t){for(var e=0;e<t;++e)this.generatePoint()},generatePoint:function(){for(;;){for(var t=0,e=this._currentDistance*this._currentDistance;t++<this._maxTests;){var i=this._getCandidate();if(this._isValid(i,e))return this._points.push(i),i}this._currentDistance*=this._decayFactor}},_getCandidate:function(){for(;;){var t=2*Math.random()-1,e=2*Math.random()-1;if(this._mode===A.SQUARE||t*t+e*e<=1)return new w(t,e)}},_isValid:function(t,e){for(var i=this._points.length,n=0;n<i;++n){var r=this._points[n],s=t.x-r.x,o=t.y-r.y;if(s*s+o*o<e)return!1}return!0}},O.add=function(t,e,i){return(i=i||new O).x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w,i},O.subtract=function(t,e,i){return(i=i||new O).x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i.w=t.w-e.w,i},O.scale=function(t,e,i){return(i=i||new O).x=t.x*e,i.y=t.y*e,i.z=t.z*e,i},O.scale4=function(t,e,i){return(i=i||new O).x=t.x*e,i.y=t.y*e,i.z=t.z*e,i.w=t.w*e,i},O.cross=function(t,e,i){i=i||new O;var n=t.x,r=t.y,s=t.z,o=e.x,a=e.y,h=e.z;return i.x=r*h-s*a,i.y=s*o-n*h,i.z=n*a-r*o,i.w=0,i},O.prototype={set:function(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=void 0===n?this.w:n,this},get lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z},get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var t=1/this.length;return this.x*=t,this.y*=t,this.z*=t,this},normalizeAsPlane:function(){var t=1/this.length;return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},clone:function(){return new O(this.x,this.y,this.z,this.w)},add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},addScaled:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this},subtract:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this},scale4:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},negativeOf:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this.w=-t.w,this},homogeneousProject:function(){var t=1/this.w;return this.x*=t,this.y*=t,this.z*=t,this.w=1,this},abs:function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this.w=Math.abs(this.w),this},fromSphericalCoordinates:function(t,e,i){return this.x=t*Math.sin(i)*Math.cos(e),this.y=t*Math.sin(i)*Math.sin(e),this.z=t*Math.cos(i),this.w=1,this},copyFrom:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},maximize:function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this},maximize3:function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this},minimize:function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this},minimize3:function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this},planeFromNormalAndPoint:function(t,e){var i=t.x,n=t.y,r=t.z;return this.x=i,this.y=n,this.z=r,this.w=-(e.x*i+e.y*n+e.z*r),this},planeFromVectorsAndPoint:function(t,e,i){this.cross(t,e),this.normalize(),this.w=-(i.x*this.x+i.y*this.y+i.z*this.z)},planeFromPoints:(y=new O,T=new O,function(t,e,i){O.subtract(t,i,y),O.subtract(e,i,T),this.planeFromVectorsAndPoint(y,T,i)}),planeIntersectRay:function(t,e){e=e||new HX.Float4;var i=this.dot3(t.direction);if(1e-5<Math.abs(i)){var n=-(this.dot3(t.origin)+this.w)/i;if(0<n)return e.copyFrom(t.origin),e.addScaled(t.direction,n),!0}return null},angle:function(t){return Math.acos(this.dot3(t)/(this.length*t.length))},angleNormalized:function(t){return Math.acos(this.dot3(t))},distanceTo:function(t){var e=t.x-this.x,i=t.y-this.y,n=t.z-this.z;return Math.sqrt(e*e+i*i+n*n)},squareDistanceTo:function(t){var e=t.x-this.x,i=t.y-this.y,n=t.z-this.z;return e*e+i*i+n*n},dot3:function(t){return t.x*this.x+t.y*this.y+t.z*this.z},dot:function(t){return t.x*this.x+t.y*this.y+t.z*this.z},dot4:function(t){return t.x*this.x+t.y*this.y+t.z*this.z+t.w*this.w},lerp:function(t,e,i){var n=t.x,r=t.y,s=t.z,o=t.w;return this.x=n+(e.x-n)*i,this.y=r+(e.y-r)*i,this.z=s+(e.z-s)*i,this.w=o+(e.w-o)*i,this},cross:function(t,e){var i=t.x,n=t.y,r=t.z,s=e.x,o=e.y,a=e.z;return this.x=n*a-r*o,this.y=r*s-i*a,this.z=i*o-n*s,this.w=0,this},toString:function(){return"Float4("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}},O.ORIGIN_POINT=new O(0,0,0,1),O.ZERO=new O(0,0,0,0),O.X_AXIS=new O(1,0,0,0),O.Y_AXIS=new O(0,1,0,0),O.Z_AXIS=new O(0,0,1,0),P.BOX=0,P.SPHERICAL=1,P._initDefault=function(){(P.DEFAULT=new P).generatePoints(64),P.DEFAULT_FLOAT32=new Float32Array(192);for(var t=P.DEFAULT.getPoints(),e=0;e<64;++e){var i=t[e];P.DEFAULT_FLOAT32[3*e]=i.x,P.DEFAULT_FLOAT32[3*e+1]=i.y,P.DEFAULT_FLOAT32[3*e+2]=i.z}},P.prototype={getPoints:function(){return this._points},reset:function(){this._currentDistance=this._initialDistance,this._points=[]},generatePoints:function(t){for(var e=0;e<t;++e)this.generatePoint()},generatePoint:function(){for(;;){for(var t=0,e=this._currentDistance*this._currentDistance;t++<this._maxTests;){var i=this._getCandidate();if(this._isValid(i,e))return this._points.push(i),i}this._currentDistance*=this._decayFactor}},_getCandidate:function(){for(;;){var t=2*Math.random()-1,e=2*Math.random()-1,i=2*Math.random()-1;if(this._mode===P.BOX||t*t+e*e+i*i<=1)return new O(t,e,i,0)}},_isValid:function(t,e){for(var i=this._points.length,n=0;n<i;++n){var r=this._points[n],s=t.x-r.x,o=t.y-r.y,a=t.z-r.z;if(s*s+o*o+a*a<e)return!1}return!0}};var M,L,R,b=1/Math.log(2),I={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,sign:function(t){return 0===t?0:0<t?1:-1},isPowerOfTwo:function(t){return!!t&&(t&-t)===t},log2:function(t){return Math.log(t)*b},clamp:function(t,e,i){return t<e?e:i<t?i:t},saturate:function(t){return I.clamp(t,0,1)},lerp:function(t,e,i){return t+(e-t)*i},linearStep:function(t,e,i){return I.saturate((i-t)/(e-t))},estimateGaussianRadius:function(t,e){return Math.sqrt(-2*t*Math.log(e))},fract:function(t){return t-Math.floor(t)}};function N(t,e,i,n){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0===n?1:n}function D(){this._enabled=!0,this.onChange=new n,this._targets=[]}function C(){this._position=new O(0,0,0,1),this._rotation=new N,this._euler=new O(0,0,0,0),this._scale=new O(1,1,1,1),this._matrix=new F,this._eulerInvalid=!0,this._eulerChangeListener=new D,this._eulerChangeListener.add(this._euler,"x"),this._eulerChangeListener.add(this._euler,"y"),this._eulerChangeListener.add(this._euler,"z"),this._eulerChangeListener.onChange.bind(this._onEulerChanged,this),this._changeListener=new D,this._changeListener.add(this._position,"x"),this._changeListener.add(this._position,"y"),this._changeListener.add(this._position,"z"),this._changeListener.add(this._scale,"x"),this._changeListener.add(this._scale,"y"),this._changeListener.add(this._scale,"z"),this._changeListener.onChange.bind(this._invalidateMatrix,this),this._rotationChangeListener=new D,this._rotationChangeListener.add(this._rotation,"x"),this._rotationChangeListener.add(this._rotation,"y"),this._rotationChangeListener.add(this._rotation,"z"),this._rotationChangeListener.add(this._rotation,"w"),this._rotationChangeListener.onChange.bind(this._onRotationChanged,this)}function F(t,e,i,n,r,s,o,a,h,_,l,u,c,d,f,p){if(void 0!==t&&isNaN(t))this._m=new Float32Array(t);else{var m=this._m=new Float32Array(16);m[0]=void 0===t?1:0,m[1]=r||0,m[2]=h||0,m[3]=c||0,m[4]=e||0,m[5]=void 0===s?1:0,m[6]=_||0,m[7]=d||0,m[8]=i||0,m[9]=o||0,m[10]=void 0===l?1:0,m[11]=f||0,m[12]=n||0,m[13]=a||0,m[14]=u||0,m[15]=void 0===p?1:0}}N.prototype={fromAxisAngle:function(t,e){var i=.5*e,n=Math.sin(i)/t.length;return this.x=t.x*n,this.y=t.y*n,this.z=t.z*n,this.w=Math.cos(i),this},fromPitchYawRoll:function(t,e,i){var n=new F;return n.fromRotationPitchYawRoll(t,e,i),this.fromMatrix(n),this},fromEuler:function(t,e,i){void 0===e&&(e=t.y,i=t.z,t=t.x);var n=Math.cos(.5*t),r=Math.cos(.5*e),s=Math.cos(.5*i),o=Math.sin(.5*t),a=Math.sin(.5*e),h=Math.sin(.5*i);return this.x=o*r*s+n*a*h,this.y=n*a*s-o*r*h,this.z=n*r*h+o*a*s,this.w=n*r*s-o*a*h,this},toEuler:function(t){t=t||new O;var e=this.x,i=this.y,n=this.z,r=this.w,s=e*e,o=i*i,a=n*n,h=r*r;return t.x=Math.atan2(-2*(i*n-r*e),h-s-o+a),t.y=Math.asin(2*(e*n+r*i)),t.z=Math.atan2(-2*(e*i-r*n),h+s-o-a),t},fromMatrix:function(t){var e,i=t._m[0],n=t._m[5],r=t._m[10],s=i+n+r;return 0<s?(s+=1,e=1/Math.sqrt(s)*.5,this.x=e*(t._m[6]-t._m[9]),this.y=e*(t._m[8]-t._m[2]),this.z=e*(t._m[1]-t._m[4]),this.w=e*s):n<i&&r<i?(s=i-n-r+1,e=1/Math.sqrt(s)*.5,this.x=e*s,this.y=e*(t._m[1]+t._m[4]),this.z=e*(t._m[8]+t._m[2]),this.w=e*(t._m[6]-t._m[9])):r<n?(s=n-i-r+1,e=1/Math.sqrt(s)*.5,this.x=e*(t._m[1]+t._m[4]),this.y=e*s,this.z=e*(t._m[6]+t._m[9]),this.w=e*(t._m[8]-t._m[2])):(s=r-i-n+1,e=1/Math.sqrt(s)*.5,this.x=e*(t._m[8]+t._m[2]),this.y=e*(t._m[6]+t._m[9]),this.z=e*s,this.w=e*(t._m[1]-t._m[4])),this.normalize(),this},rotate:function(t,e){e=e||new O;var i=t.x,n=t.y,r=t.z,s=this.x,o=this.y,a=this.z,h=this.w,_=-s*i-o*n-a*r,l=h*i+o*r-a*n,u=h*n-s*r+a*i,c=h*r+s*n-o*i;return e.x=-_*s+l*h-u*a+c*o,e.y=-_*o+l*a+u*h-c*s,e.z=-_*a-l*o+u*s+c*h,e.w=t.w,e},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},set:function(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this},copyFrom:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},get normSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},get norm(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},conjugate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},invert:function(){var t=this.x,e=this.y,i=this.z,n=this.w,r=1/(t*t+e*e+i*i+n*n);return this.x=-t*r,this.y=-e*r,this.z=-i*r,this.w=n*r,this},multiply:function(t,e){var i=t.w,n=t.x,r=t.y,s=t.z,o=e.w,a=e.x,h=e.y,_=e.z;return this.x=i*a+n*o+r*_-s*h,this.y=i*h-n*_+r*o+s*a,this.z=i*_+n*h-r*a+s*o,this.w=i*o-n*a-r*h-s*_,this},append:function(t){return this.multiply(t,this)},prepend:function(t){return this.multiply(this,t)},lerp:function(t,e,i){var n=t.w,r=t.x,s=t.y,o=t.z,a=e.w,h=e.x,_=e.y,l=e.z;return n*a+r*h+s*_+o*l<0&&(a=-a,h=-h,_=-_,l=-l),this.x=r+i*(h-r),this.y=s+i*(_-s),this.z=o+i*(l-o),this.w=n+i*(a-n),this.normalize(),this},slerp:function(t,e,i){var n=t.w,r=t.x,s=t.y,o=t.z,a=e.w,h=e.x,_=e.y,l=e.z,u=n*a+r*h+s*_+o*l;if(u<0&&(u=-u,a=-a,h=-h,_=-_,l=-l),u<.95){var c=i*Math.acos(u),d=h-r*u,f=_-s*u,p=l-o*u,m=a-n*u,g=1/Math.sqrt(d*d+f*f+p*p+m*m);d*=g,f*=g,p*=g,m*=g;var x=Math.cos(c),v=Math.sin(c);this.x=r*x+d*v,this.y=s*x+f*v,this.z=o*x+p*v,this.w=n*x+m*v}else this.x=r+i*(h-r),this.y=s+i*(_-s),this.z=o+i*(l-o),this.w=n+i*(a-n),this.normalize();return this},toString:function(){return"Quaternion("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}},D.prototype={get enabled(){return this._enabled},set enabled(t){this._enabled=t},add:function(t,e){var i=this._targets.length;this._targets.push({object:t,propertyName:e,value:t[e]});var n=this,r=n._targets[i];Object.defineProperty(t,e,{get:function(){return r.value},set:function(t){t!==r.value&&(r.value=t,n._enabled&&n.onChange.dispatch())}})},remove:function(t,e){for(var i=0;i<this._targets.length;++i){var n=this._targets[i];n.object===t&&n.propertyName===e&&(delete n.object[n.propertyName],n.object[n.propertyName]=n.value,this._targets.splice(i--,1))}}},C.prototype={get position(){return this._position},set position(t){this._position.copyFrom(t)},get rotation(){return this._rotation},set rotation(t){this._rotationChangeListener.enabled=!1,this._rotation.copyFrom(t),this._rotationChangeListener.enabled=!0,this._onRotationChanged()},get euler(){return this._eulerInvalid&&(this._eulerChangeListener.enabled=!1,this._rotation.toEuler(this._euler),this._eulerChangeListener.enabled=!0),this._euler},set euler(t){this._eulerChangeListener.enabled=!1,this._euler.copyFrom(t),this._eulerChangeListener.enabled=!0,this._onEulerChanged()},get scale(){return this._scale},set scale(t){this._scale.copyFrom(t)},lookAt:function(t){this._matrix.lookAt(t,this._position),this._matrix.appendScale(this._scale),this._applyMatrix()},copyTransform:function(t){this._changeListener.enabled=!1,this._rotationChangeListener.enabled=!1,this._position.copyFrom(t.position),this._rotation.copyFrom(t.rotation),this._scale.copyFrom(t.scale),this._changeListener.enabled=!0,this._rotationChangeListener.enabled=!0,this._eulerInvalid=!0,this._invalidateMatrix()},get matrix(){return this._matrixInvalid&&this._updateMatrix(),this._matrix},set matrix(t){this._matrix.copyFrom(t),this._applyMatrix()},_onEulerChanged:function(){this._rotationChangeListener.enabled=!1,this._rotation.fromEuler(this._euler),this._rotationChangeListener.enabled=!0,this._invalidateMatrix()},_onRotationChanged:function(){this._eulerInvalid=!0,this._invalidateMatrix()},_invalidateMatrix:function(){this._matrixInvalid=!0},_updateMatrix:function(){this._matrix.compose(this),this._matrixInvalid=!1},_applyMatrix:function(){this._matrixInvalid=!1,this._changeListener.enabled=!1,this._rotationChangeListener.enabled=!1,this._matrix.decompose(this),this._changeListener.enabled=!0,this._rotationChangeListener.enabled=!0,this._eulerInvalid=!0},clone:function(){var t=new C;return this.copyTo(t),t},copyTo:function(t){t.matrix=this.target}},F.prototype={transform:function(t,e){e=e||new O;var i=t.x,n=t.y,r=t.z,s=t.w,o=this._m;return e.x=o[0]*i+o[4]*n+o[8]*r+o[12]*s,e.y=o[1]*i+o[5]*n+o[9]*r+o[13]*s,e.z=o[2]*i+o[6]*n+o[10]*r+o[14]*s,e.w=o[3]*i+o[7]*n+o[11]*r+o[15]*s,e},projectPoint:function(t,e){e=e||new O;var i=t.x,n=t.y,r=t.z,s=this._m,o=1/(s[3]*i+s[7]*n+s[11]*r+s[15]);return e.x=(s[0]*i+s[4]*n+s[8]*r+s[12])*o,e.y=(s[1]*i+s[5]*n+s[9]*r+s[13])*o,e.z=(s[2]*i+s[6]*n+s[10]*r+s[14])*o,e.w=1,e},transformPoint:function(t,e){e=e||new O;var i=t.x,n=t.y,r=t.z,s=this._m;return e.x=s[0]*i+s[4]*n+s[8]*r+s[12],e.y=s[1]*i+s[5]*n+s[9]*r+s[13],e.z=s[2]*i+s[6]*n+s[10]*r+s[14],e.w=1,e},transformNormal:function(t,e){var i=this._m,n=i[0],r=i[1],s=i[2],o=i[4],a=i[5],h=i[6],_=i[8],l=i[9],u=i[10],c=1/(n*(a*u-l*h)-o*(r*u-l*s)+_*(r*h-a*s)),d=(a*u-l*h)*c,f=(l*s-r*u)*c,p=(r*h-a*s)*c,m=(_*h-o*u)*c,g=(n*u-_*s)*c,x=(o*s-n*h)*c,v=(o*l-_*a)*c,y=(_*r-n*l)*c,T=(n*a-o*r)*c;e=e||new O;var S=t.x,E=t.y,w=t.z;return e.x=d*S+f*E+p*w,e.y=m*S+g*E+x*w,e.z=v*S+y*E+T*w,e.w=0,e},transformVector:function(t,e){e=e||new O;var i=t.x,n=t.y,r=t.z,s=this._m;return e.x=s[0]*i+s[4]*n+s[8]*r,e.y=s[1]*i+s[5]*n+s[9]*r,e.z=s[2]*i+s[6]*n+s[10]*r,e.w=0,e},transformExtent:function(t,e){e=e||new O;var i=t.x,n=t.y,r=t.z,s=this._m,o=s[0],a=s[1],h=s[2],_=s[4],l=s[5],u=s[6],c=s[8],d=s[9],f=s[10];return o<0&&(o=-o),a<0&&(a=-a),h<0&&(h=-h),_<0&&(_=-_),l<0&&(l=-l),u<0&&(u=-u),c<0&&(c=-c),d<0&&(d=-d),f<0&&(f=-f),e.x=o*i+_*n+c*r,e.y=a*i+l*n+d*r,e.z=h*i+u*n+f*r,e.w=0,e},copyFrom:function(t){var e=this._m,i=t._m;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this},fromQuaternion:function(t){var e=t.x,i=t.y,n=t.z,r=t.w,s=this._m;return s[0]=1-2*(i*i+n*n),s[1]=2*(e*i+r*n),s[2]=2*(e*n-r*i),s[3]=0,s[4]=2*(e*i-r*n),s[5]=1-2*(e*e+n*n),s[6]=2*(i*n+r*e),s[7]=0,s[8]=2*(e*n+r*i),s[9]=2*(i*n-r*e),s[10]=1-2*(e*e+i*i),s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},multiply:function(t,e){var i=t._m,n=e._m,r=i[0],s=i[1],o=i[2],a=i[3],h=i[4],_=i[5],l=i[6],u=i[7],c=i[8],d=i[9],f=i[10],p=i[11],m=i[12],g=i[13],x=i[14],v=i[15],y=n[0],T=n[1],S=n[2],E=n[3],w=n[4],A=n[5],P=n[6],M=n[7],L=n[8],R=n[9],b=n[10],I=n[11],N=n[12],D=n[13],O=n[14],C=n[15],F=this._m;return F[0]=r*y+h*T+c*S+m*E,F[1]=s*y+_*T+d*S+g*E,F[2]=o*y+l*T+f*S+x*E,F[3]=a*y+u*T+p*S+v*E,F[4]=r*w+h*A+c*P+m*M,F[5]=s*w+_*A+d*P+g*M,F[6]=o*w+l*A+f*P+x*M,F[7]=a*w+u*A+p*P+v*M,F[8]=r*L+h*R+c*b+m*I,F[9]=s*L+_*R+d*b+g*I,F[10]=o*L+l*R+f*b+x*I,F[11]=a*L+u*R+p*b+v*I,F[12]=r*N+h*D+c*O+m*C,F[13]=s*N+_*D+d*O+g*C,F[14]=o*N+l*D+f*O+x*C,F[15]=a*N+u*D+p*O+v*C,this},multiplyAffine:function(t,e){var i=t._m,n=e._m,r=i[0],s=i[1],o=i[2],a=i[4],h=i[5],_=i[6],l=i[8],u=i[9],c=i[10],d=i[12],f=i[13],p=i[14],m=n[0],g=n[1],x=n[2],v=n[4],y=n[5],T=n[6],S=n[8],E=n[9],w=n[10],A=n[12],P=n[13],M=n[14],L=this._m;return L[0]=r*m+a*g+l*x,L[1]=s*m+h*g+u*x,L[2]=o*m+_*g+c*x,L[4]=r*v+a*y+l*T,L[5]=s*v+h*y+u*T,L[6]=o*v+_*y+c*T,L[8]=r*S+a*E+l*w,L[9]=s*S+h*E+u*w,L[10]=o*S+_*E+c*w,L[12]=r*A+a*P+l*M+d,L[13]=s*A+h*P+u*M+f,L[14]=o*A+_*P+c*M+p,this},fromRotationAxisAngle:function(t,e){var i=Math.cos(e),n=Math.sin(e),r=1/t.length,s=t.x*r,o=t.y*r,a=t.z*r,h=1-i,_=this._m;return _[0]=h*s*s+i,_[1]=h*s*o+n*a,_[2]=h*s*a-n*o,_[3]=0,_[4]=h*s*o-n*a,_[5]=h*o*o+i,_[6]=h*o*a+n*s,_[7]=0,_[8]=h*s*a+n*o,_[9]=h*o*a-n*s,_[10]=h*a*a+i,_[11]=0,_[12]=0,_[13]=0,_[14]=0,_[15]=1,this},fromEuler:function(t,e,i){var n=Math.cos(t),r=Math.sin(t),s=Math.cos(e),o=Math.sin(e),a=Math.cos(i),h=Math.sin(i),_=this._m;return _[0]=s*a,_[1]=n*h+r*o*a,_[2]=r*h-n*o*a,_[3]=0,_[4]=-s*h,_[5]=n*a-r*o*h,_[6]=r*a+n*o*h,_[7]=0,_[8]=o,_[9]=-r*s,_[10]=n*s,_[11]=0,_[12]=0,_[13]=0,_[14]=0,_[15]=1,this},fromRotationPitchYawRoll:function(t,e,i){var n=Math.cos(-t),r=Math.cos(-e),s=Math.cos(i),o=Math.sin(-t),a=Math.sin(-e),h=Math.sin(i),_=-a*n,l=r*n,u=-o,c=-r*h-a*o*s,d=-a*h+o*s*r,f=n*s,p=l*f-u*d,m=u*c-_*f,g=_*d-l*c,x=this._m;return x[0]=p,x[1]=m,x[2]=g,x[3]=0,x[4]=_,x[5]=l,x[6]=u,x[7]=0,x[8]=c,x[9]=d,x[10]=f,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,this},fromTranslation:function(t,e,i){void 0===e&&(e=(t=t.x).y,i=t.z);var n=this._m;return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=t,n[13]=e,n[14]=i,n[15]=1,this},fromScale:function(t,e,i){t instanceof O?(e=t.y,i=t.z,t=t.x):void 0===e&&(e=i=t);var n=this._m;return n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=i,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this},fromPerspectiveProjection:function(t,e,i,n){var r=1/Math.tan(.5*t),s=r/e,o=1/(i-n),a=this._m;return a[0]=s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=0,a[6]=-(n+i)*o,a[7]=1,a[8]=0,a[9]=r,a[10]=0,a[11]=0,a[12]=0,a[13]=0,a[14]=2*i*n*o,a[15]=0,this},fromOrthographicOffCenterProjection:function(t,e,i,n,r,s){var o=1/(e-t),a=1/(i-n),h=1/(r-s),_=this._m;return _[0]=2*o,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=0,_[6]=-2*h,_[7]=0,_[8]=0,_[9]=2*a,_[10]=0,_[11]=0,_[12]=-(t+e)*o,_[13]=-(i+n)*a,_[14]=(s+r)*h,_[15]=1,this},fromOrthographicProjection:function(t,e,i,n){var r=1/t,s=1/e,o=1/(i-n),a=this._m;return a[0]=2*r,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=0,a[6]=2*o,a[7]=0,a[8]=0,a[9]=2*s,a[10]=0,a[11]=0,a[12]=0,a[13]=0,a[14]=(n+i)*o,a[15]=1,this},clone:function(){return new F(this._m)},transpose:function(){var t=this._m,e=t[1],i=t[2],n=t[3],r=t[6],s=t[7],o=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=e,t[6]=t[9],t[7]=t[13],t[8]=i,t[9]=r,t[11]=t[14],t[12]=n,t[13]=s,t[14]=o,this},determinant3x3:function(t,e){var i=0===e?4:0,n=e<2?8:4,r=3===e?8:12,s=0===t?1:0,o=t<2?2:1,a=3===t?2:3,h=this._m,_=h[i|o],l=h[o|n],u=h[r|o],c=h[i|a],d=h[n|a],f=h[a|r];return h[i|s]*(l*f-u*d)-h[n|s]*(_*f-u*c)+h[r|s]*(_*d-l*c)},cofactor:function(t,e){return(1-((t+e&1)<<1))*this.determinant3x3(t,e)},getCofactorMatrix:function(t,e,i){for(var n=(i=i||new F)._m,r=0;r<16;++r)n[r]=this.cofactor(3&r,r>>2);return i},getAdjugate:function(t,e,i){for(var n=(i=i||new F)._m,r=0;r<16;++r)n[r]=this.cofactor(r>>2,3&r);return i},determinant:function(){var t=this._m;return t[0]*this.determinant3x3(0,0)-t[4]*this.determinant3x3(0,1)+t[8]*this.determinant3x3(0,2)-t[12]*this.determinant3x3(0,3)},inverseOf:function(t){var e=1/t.determinant(),i=e*t.cofactor(0,0),n=e*t.cofactor(0,1),r=e*t.cofactor(0,2),s=e*t.cofactor(0,3),o=e*t.cofactor(1,0),a=e*t.cofactor(1,1),h=e*t.cofactor(1,2),_=e*t.cofactor(1,3),l=e*t.cofactor(2,0),u=e*t.cofactor(2,1),c=e*t.cofactor(2,2),d=e*t.cofactor(2,3),f=e*t.cofactor(3,0),p=e*t.cofactor(3,1),m=e*t.cofactor(3,2),g=e*t.cofactor(3,3),x=this._m;return x[0]=i,x[1]=n,x[2]=r,x[3]=s,x[4]=o,x[5]=a,x[6]=h,x[7]=_,x[8]=l,x[9]=u,x[10]=c,x[11]=d,x[12]=f,x[13]=p,x[14]=m,x[15]=g,this},inverseAffineOf:function(t){var e=t._m,i=e[0],n=e[1],r=e[2],s=e[4],o=e[5],a=e[6],h=e[8],_=e[9],l=e[10],u=e[12],c=e[13],d=e[14],f=1/(i*(o*l-_*a)-s*(n*l-_*r)+h*(n*a-o*r)),p=(o*l-_*a)*f,m=(_*r-n*l)*f,g=(n*a-o*r)*f,x=(h*a-s*l)*f,v=(i*l-h*r)*f,y=(s*r-i*a)*f,T=(s*_-h*o)*f,S=(h*n-i*_)*f,E=(i*o-s*n)*f,w=this._m;return w[0]=p,w[1]=m,w[2]=g,w[3]=0,w[4]=x,w[5]=v,w[6]=y,w[7]=0,w[8]=T,w[9]=S,w[10]=E,w[11]=0,w[12]=-p*u-x*c-T*d,w[13]=-m*u-v*c-S*d,w[14]=-g*u-y*c-E*d,w[15]=1,this},writeNormalMatrix:function(t,e){e=e||0;var i=this._m,n=i[0],r=i[1],s=i[2],o=i[4],a=i[5],h=i[6],_=i[8],l=i[9],u=i[10],c=1/(n*(a*u-l*h)-o*(r*u-l*s)+_*(r*h-a*s));t[e]=(a*u-l*h)*c,t[e+1]=(_*h-o*u)*c,t[e+2]=(o*l-_*a)*c,t[e+3]=(l*s-r*u)*c,t[e+4]=(n*u-_*s)*c,t[e+5]=(_*r-n*l)*c,t[e+6]=(r*h-a*s)*c,t[e+7]=(o*s-n*h)*c,t[e+8]=(n*a-o*r)*c},writeData:function(t,e){e=e||0;for(var i=this._m,n=0;n<16;++n)t[e+n]=i[n]},writeData4x3:function(t,e){var i=this._m;t[e=e||0]=i[0],t[e+1]=i[4],t[e+2]=i[8],t[e+3]=i[12],t[e+4]=i[1],t[e+5]=i[5],t[e+6]=i[9],t[e+7]=i[13],t[e+8]=i[2],t[e+9]=i[6],t[e+10]=i[10],t[e+11]=i[14]},invert:function(){return this.inverseOf(this)},invertAffine:function(){return this.inverseAffineOf(this)},append:function(t){return this.multiply(t,this)},prepend:function(t){return this.multiply(this,t)},appendAffine:function(t){return this.multiplyAffine(t,this)},prependAffine:function(t){return this.multiplyAffine(this,t)},add:function(t){var e=this._m,i=t._m;return e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[3]+=i[3],e[4]+=i[4],e[5]+=i[5],e[6]+=i[6],e[7]+=i[7],e[8]+=i[8],e[9]+=i[9],e[10]+=i[10],e[11]+=i[11],e[12]+=i[12],e[13]+=i[13],e[14]+=i[14],e[15]+=i[15],this},addAffine:function(t){var e=this._m,i=t._m;return e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[4]+=i[4],e[5]+=i[5],e[6]+=i[6],e[8]+=i[8],e[9]+=i[9],e[10]+=i[10],this},subtract:function(t){var e=this._m,i=t._m;return e[0]-=i[0],e[1]-=i[1],e[2]-=i[2],e[3]-=i[3],e[4]-=i[4],e[5]-=i[5],e[6]-=i[6],e[7]-=i[7],e[8]-=i[8],e[9]-=i[9],e[10]-=i[10],e[11]-=i[11],e[12]-=i[12],e[13]-=i[13],e[14]-=i[14],e[15]-=i[15],this},subtractAffine:function(t){var e=this._m,i=t._m;return e[0]-=i[0],e[1]-=i[1],e[2]-=i[2],e[4]-=i[4],e[5]-=i[5],e[6]-=i[6],e[8]-=i[8],e[9]-=i[9],e[10]-=i[10],this},appendScale:function(t,e,i){t instanceof O?(e=t.y,i=t.z,t=t.x):void 0===e&&(e=i=t);var n=this._m;return n[0]*=t,n[1]*=e,n[2]*=i,n[4]*=t,n[5]*=e,n[6]*=i,n[8]*=t,n[9]*=e,n[10]*=i,n[12]*=t,n[13]*=e,n[14]*=i,this},prependScale:function(t,e,i){t instanceof O?(e=t.y,i=t.z,t=t.x):void 0===e&&(e=i=t);var n=this._m;return n[0]*=t,n[1]*=t,n[2]*=t,n[3]*=t,n[4]*=e,n[5]*=e,n[6]*=e,n[7]*=e,n[8]*=i,n[9]*=i,n[10]*=i,n[11]*=i,this},appendTranslation:function(t,e,i){t instanceof O&&(e=t.y,i=t.z,t=t.x);var n=this._m;return n[12]+=t,n[13]+=e,n[14]+=i,this},prependTranslation:function(t,e,i){t instanceof O&&(e=t.y,i=t.z,t=t.x);var n=this._m;return n[12]+=n[0]*t+n[4]*e+n[8]*i,n[13]+=n[1]*t+n[5]*e+n[9]*i,n[14]+=n[2]*t+n[6]*e+n[10]*i,n[15]+=n[3]*t+n[7]*e+n[11]*i,this},appendQuaternion:function(t){var e=this._m,i=t.x,n=t.y,r=t.z,s=t.w,o=1-2*(n*n+r*r),a=2*(i*n+s*r),h=2*(i*r-s*n),_=2*(i*n-s*r),l=1-2*(i*i+r*r),u=2*(n*r+s*i),c=2*(i*r+s*n),d=2*(n*r-s*i),f=1-2*(i*i+n*n),p=e[0],m=e[1],g=e[2],x=e[4],v=e[5],y=e[6],T=e[8],S=e[9],E=e[10],w=e[12],A=e[13],P=e[14];return e[0]=o*p+_*m+c*g,e[1]=a*p+l*m+d*g,e[2]=h*p+u*m+f*g,e[4]=o*x+_*v+c*y,e[5]=a*x+l*v+d*y,e[6]=h*x+u*v+f*y,e[8]=o*T+_*S+c*E,e[9]=a*T+l*S+d*E,e[10]=h*T+u*S+f*E,e[12]=o*w+_*A+c*P,e[13]=a*w+l*A+d*P,e[14]=h*w+u*A+f*P,this},prependQuaternion:function(t){var e=this._m,i=t.x,n=t.y,r=t.z,s=t.w,o=e[0],a=e[1],h=e[2],_=e[4],l=e[5],u=e[6],c=e[8],d=e[9],f=e[10],p=1-2*(n*n+r*r),m=2*(i*n+s*r),g=2*(i*r-s*n),x=2*(i*n-s*r),v=1-2*(i*i+r*r),y=2*(n*r+s*i),T=2*(i*r+s*n),S=2*(n*r-s*i),E=1-2*(i*i+n*n);return e[0]=o*p+_*m+c*g,e[1]=a*p+l*m+d*g,e[2]=h*p+u*m+f*g,e[4]=o*x+_*v+c*y,e[5]=a*x+l*v+d*y,e[6]=h*x+u*v+f*y,e[8]=o*T+_*S+c*E,e[9]=a*T+l*S+d*E,e[10]=h*T+u*S+f*E,this},appendRotationAxisAngle:function(t,e){var i=this._m,n=Math.cos(e),r=Math.sin(e),s=1/t.length,o=t.x*s,a=t.y*s,h=t.z*s,_=1-n,l=_*o*o+n,u=_*o*a+r*h,c=_*o*h-r*a,d=_*o*a-r*h,f=_*a*a+n,p=_*a*h+r*o,m=_*o*h+r*a,g=_*a*h-r*o,x=_*h*h+n,v=i[0],y=i[1],T=i[2],S=i[4],E=i[5],w=i[6],A=i[8],P=i[9],M=i[10],L=i[12],R=i[13],b=i[14];return i[0]=l*v+d*y+m*T,i[1]=u*v+f*y+g*T,i[2]=c*v+p*y+x*T,i[4]=l*S+d*E+m*w,i[5]=u*S+f*E+g*w,i[6]=c*S+p*E+x*w,i[8]=l*A+d*P+m*M,i[9]=u*A+f*P+g*M,i[10]=c*A+p*P+x*M,i[12]=l*L+d*R+m*b,i[13]=u*L+f*R+g*b,i[14]=c*L+p*R+x*b,this},prependRotationAxisAngle:function(t,e){var i=this._m,n=Math.cos(e),r=Math.sin(e),s=1/t.length,o=t.x*s,a=t.y*s,h=t.z*s,_=1-n,l=i[0],u=i[1],c=i[2],d=i[4],f=i[5],p=i[6],m=i[8],g=i[9],x=i[10],v=_*o*o+n,y=_*o*a+r*h,T=_*o*h-r*a,S=_*o*a-r*h,E=_*a*a+n,w=_*a*h+r*o,A=_*o*h+r*a,P=_*a*h-r*o,M=_*h*h+n;return i[0]=l*v+d*y+m*T,i[1]=u*v+f*y+g*T,i[2]=c*v+p*y+x*T,i[4]=l*S+d*E+m*w,i[5]=u*S+f*E+g*w,i[6]=c*S+p*E+x*w,i[8]=l*A+d*P+m*M,i[9]=u*A+f*P+g*M,i[10]=c*A+p*P+x*M,this},getRow:function(t,e){var i=this._m;return(e=e||new O).x=i[t],e.y=i[4|t],e.z=i[8|t],e.w=i[12|t],e},setRow:function(t,e){var i=this._m;return i[t]=e.x,i[4|t]=e.y,i[8|t]=e.z,i[12|t]=e.w,this},getElement:function(t,e){return this._m[t|e<<2]},setElement:function(t,e,i){return this._m[t|e<<2]=i,this},getColumn:function(t,e){var i=this._m;return t<<=2,(e=e||new O).x=i[t],e.y=i[1|t],e.z=i[2|t],e.w=i[3|t],e},setColumn:function(t,e){var i=this._m;return i[t<<=2]=e.x,i[1|t]=e.y,i[2|t]=e.z,i[3|t]=e.w,this},copyColumn:function(t,e){var i=this._m,n=e._m;return i[t<<=2]=n[t],i[1|t]=n[1|t],i[2|t]=n[2|t],i[3|t]=n[3|t],this},lookAt:(M=new O,L=new O,R=new O,function(t,e,i){if(i=i||O.Z_AXIS,O.subtract(t,e,L),L.normalize(),O.cross(L,i,M),Math.abs(M.lengthSqr)<1e-4){var n=new O(i.x,i.z,i.y,0);O.cross(L,n,M),Math.abs(M.lengthSqr)<=1e-4&&(n.set(i.z,i.y,i.z,0),O.cross(L,n,M))}M.normalize(),O.cross(M,L,R);var r=this._m;return r[0]=M.x,r[1]=M.y,r[2]=M.z,r[3]=0,r[4]=L.x,r[5]=L.y,r[6]=L.z,r[7]=0,r[8]=R.x,r[9]=R.y,r[10]=R.z,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1,this}),compose:function(t){return this.fromScale(t.scale),this.appendQuaternion(t.rotation),this.appendTranslation(t.position),this},decompose:function(t,e,i){var n;t=t||new C,void 0===e?(e=t.rotation,i=t.scale,n=t.position):n=t;var r=this._m,s=r[0],o=r[1],a=r[2],h=r[4],_=r[5],l=r[6],u=r[8],c=r[9],d=r[10],f=o*l-a*_,p=a*h-s*l,m=s*_-o*h,g=I.sign(f*u+p*c+m*d);i.x=g*Math.sqrt(s*s+o*o+a*a),i.y=g*Math.sqrt(h*h+_*_+l*l),i.z=g*Math.sqrt(u*u+c*c+d*d),.999<i.x&&i.x<1.001&&(i.x=1),.999<i.y&&i.y<1.001&&(i.y=1),.999<i.z&&i.z<1.001&&(i.z=1);var x=this.clone(),v=1/i.x,y=1/i.y,T=1/i.z,S=x._m;return S[0]*=v,S[1]*=v,S[2]*=v,S[4]*=y,S[5]*=y,S[6]*=y,S[8]*=T,S[9]*=T,S[10]*=T,e.fromMatrix(x),this.getColumn(3,n),t},swapColums:function(t,e){var i=this._m;if(t!==e){e<<=2;var n=i[t<<=2],r=i[1|t],s=i[2|t],o=i[3|t];return i[t]=i[e],i[1|t]=i[1|e],i[2|t]=i[2|e],i[3|t]=i[3|e],i[e]=n,i[1|e]=r,i[2|e]=s,i[3|e]=o,this}},toString:function(){for(var t=this._m,e="",i=0;i<16;++i){var n=3&i;0===n&&(e+="["),e+=t[i],e+=3===n?"]\n":"\t , \t"}return e}},F.IDENTITY=new F,F.ZERO=new F(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var U,X,H,z,V,k,G={getSettersPerInstance:function(t){return void 0===G._instanceTable&&G._init(),G._findSetters(t,G._instanceTable)},getSettersPerPass:function(t){return void 0===G._passTable&&G._init(),G._findSetters(t,G._passTable)},_findSetters:function(t,e){var i=[];for(var n in e){var r=B.gl.getUniformLocation(t._program,n);if(r){var s=new e[n];i.push(s),s.location=r}}return i},_init:function(){G._instanceTable={},G._passTable={},G._instanceTable.hx_worldMatrix=Y,G._instanceTable.hx_worldViewMatrix=Q,G._instanceTable.hx_wvpMatrix=J,G._instanceTable.hx_inverseWVPMatrix=Z,G._instanceTable.hx_normalWorldMatrix=$,G._instanceTable.hx_normalWorldViewMatrix=tt,G._instanceTable["hx_skinningMatrices[0]"]=ft,G._instanceTable["hx_morphWeights[0]"]=pt,G._passTable.hx_viewMatrix=at,G._passTable.hx_projectionMatrix=q,G._passTable.hx_inverseProjectionMatrix=K,G._passTable.hx_viewProjectionMatrix=j,G._passTable.hx_inverseViewProjectionMatrix=W,G._passTable.hx_cameraWorldPosition=et,G._passTable.hx_cameraWorldMatrix=it,G._passTable.hx_cameraFrustumRange=nt,G._passTable.hx_rcpCameraFrustumRange=rt,G._passTable.hx_cameraNearPlaneDistance=st,G._passTable.hx_cameraFarPlaneDistance=ot,G._passTable.hx_renderTargetResolution=ht,G._passTable.hx_rcpRenderTargetResolution=lt,G._passTable.hx_dither2DTextureScale=ut,G._passTable.hx_ambientColor=_t,G._passTable["hx_poissonDisk[0]"]=ct,G._passTable["hx_poissonSphere[0]"]=dt}};function Y(){}function j(){}function W(){}function Z(){}function q(){}function K(){}function J(){}function Q(){this._matrix=new F}function $(){}function tt(){}function et(){}function it(){}function nt(){}function rt(){}function st(){}function ot(){}function at(){}function ht(){}function _t(){}function lt(){}function ut(){}function ct(){}function dt(){}function ft(){this._data=new Float32Array(12*te.OPTIONS.maxSkeletonJoints)}function pt(){}Y.prototype.execute=function(t,e){B.gl.uniformMatrix4fv(this.location,!1,e.worldMatrix._m)},j.prototype.execute=function(t){B.gl.uniformMatrix4fv(this.location,!1,t.viewProjectionMatrix._m)},W.prototype.execute=function(t){B.gl.uniformMatrix4fv(this.location,!1,t.inverseViewProjectionMatrix._m)},Z.prototype.execute=function(t){B.gl.uniformMatrix4fv(this.location,!1,t.inverseViewProjectionMatrix._m)},q.prototype.execute=function(t){B.gl.uniformMatrix4fv(this.location,!1,t.projectionMatrix._m)},K.prototype.execute=function(t){B.gl.uniformMatrix4fv(this.location,!1,t.inverseProjectionMatrix._m)},J.prototype.execute=(U=new F,X=U._m,function(t,e){U.multiply(t.viewProjectionMatrix,e.worldMatrix),B.gl.uniformMatrix4fv(this.location,!1,X)}),Q.prototype.execute=(H=new F,z=H._m,function(t,e){H.multiply(t.viewMatrix,e.worldMatrix),B.gl.uniformMatrix4fv(this.location,!1,z)}),$.prototype.execute=(V=new Float32Array(9),function(t,e){e.worldMatrix.writeNormalMatrix(V),B.gl.uniformMatrix3fv(this.location,!1,V)}),tt.prototype.execute=(k=new Float32Array(9),function(t,e){var i=t.viewMatrix._m,n=e.worldMatrix._m,r=i[0],s=i[1],o=i[2],a=i[4],h=i[5],_=i[6],l=i[8],u=i[9],c=i[10],d=i[12],f=i[13],p=i[14],m=n[0],g=n[1],x=n[2],v=n[3],y=n[4],T=n[5],S=n[6],E=n[7],w=n[8],A=n[9],P=n[10],M=n[11],L=r*m+a*g+l*x+d*v,R=s*m+h*g+u*x+f*v,b=o*m+_*g+c*x+p*v,I=r*y+a*T+l*S+d*E,N=s*y+h*T+u*S+f*E,D=o*y+_*T+c*S+p*E,O=r*w+a*A+l*P+d*M,C=s*w+h*A+u*P+f*M,F=o*w+_*A+c*P+p*M,U=1/(L*(N*F-C*D)-I*(R*F-C*b)+O*(R*D-N*b));k[0]=(N*F-C*D)*U,k[1]=(O*D-I*F)*U,k[2]=(I*C-O*N)*U,k[3]=(C*b-R*F)*U,k[4]=(L*F-O*b)*U,k[5]=(O*R-L*C)*U,k[6]=(R*D-N*b)*U,k[7]=(I*b-L*D)*U,k[8]=(L*N-I*R)*U,B.gl.uniformMatrix3fv(this.location,!1,k)}),et.prototype.execute=function(t){var e=t.worldMatrix._m;B.gl.uniform3f(this.location,e[12],e[13],e[14])},it.prototype.execute=function(t){var e=t.worldMatrix;B.gl.uniformMatrix4fv(this.location,!1,e._m)},nt.prototype.execute=function(t){B.gl.uniform1f(this.location,t._farDistance-t._nearDistance)},rt.prototype.execute=function(t){B.gl.uniform1f(this.location,1/(t._farDistance-t._nearDistance))},st.prototype.execute=function(t){B.gl.uniform1f(this.location,t._nearDistance)},ot.prototype.execute=function(t){B.gl.uniform1f(this.location,t._farDistance)},at.prototype.execute=function(t){B.gl.uniformMatrix4fv(this.location,!1,t.viewMatrix._m)},ht.prototype.execute=function(t){B.gl.uniform2f(this.location,t._renderTargetWidth,t._renderTargetHeight)},_t.prototype.execute=function(t,e){var i=e._ambientColor;B.gl.uniform3f(this.location,i.r,i.g,i.b)},lt.prototype.execute=function(t){B.gl.uniform2f(this.location,1/t._renderTargetWidth,1/t._renderTargetHeight)},ut.prototype.execute=function(){B.gl.uniform2f(this.location,1/Te.DEFAULT_2D_DITHER_TEXTURE.width,1/Te.DEFAULT_2D_DITHER_TEXTURE.height)},ct.prototype.execute=function(){B.gl.uniform2fv(this.location,A.DEFAULT_FLOAT32)},dt.prototype.execute=function(){B.gl.uniform3fv(this.location,P.DEFAULT_FLOAT32)},ft.prototype.execute=function(t,e){var i=e.skeleton;if(i){for(var n=e.skeletonMatrices,r=i.numJoints,s=0,o=0;o<r;++o)n[o].writeData4x3(this._data,s),s+=12;B.gl.uniform4fv(this.location,this._data)}},pt.prototype.execute=function(t,e){B.gl.uniform1fv(this.location,e.meshInstance._morphWeights)};var mt={printShaderCode:function(t){for(var e=t.split("\n"),i="",n=0;n<e.length;++n)i+=n+1+":\t"+e[n]+"\n";console.log(i)},printSkeletonHierarchy:function(t){for(var e="Skeleton: \n",i=0;i<t.numJoints;++i){for(var n=t.getJoint(i),r=n.name;-1!==n.parentIndex;)n=t.getJoint(n.parentIndex),e+="\t";e+="\t"+r+"\n"}console.log(e)},assert:function(t,e){if(!t)throw new Error(e)}};function gt(t,e){this._ready=!1,this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uniformSettersInstance=null,this._uniformSettersPass=null,t&&e&&this.init(t,e)}function xt(t){gt.call(this),this.init(d.get("copy_vertex.glsl"),t);var e=B.gl,i=e.getUniformLocation(this._program,"sampler");this._positionAttributeLocation=e.getAttribLocation(this._program,"hx_position"),this._texCoordAttributeLocation=e.getAttribLocation(this._program,"hx_texCoord"),e.useProgram(this._program),e.uniform1i(i,0)}function vt(t,e){var i="#define extractChannels(src) ((src)."+(t=t||"xyzw")+")\n";(e=void 0===e||e)&&(i+="#define COPY_ALPHA\n"),xt.call(this,i+d.get("copy_fragment.glsl"))}function yt(){xt.call(this,d.get("copy_to_gamma_fragment.glsl"))}function Tt(){this._buffer=B.gl.createBuffer()}function St(){this._buffer=B.gl.createBuffer()}function Et(t){this._type=t,this._expanse=Et.EXPANSE_EMPTY,this._minimumX=0,this._minimumY=0,this._minimumZ=0,this._maximumX=0,this._maximumY=0,this._maximumZ=0,this._halfExtentX=0,this._halfExtentY=0,this._halfExtentZ=0,this._center=new O}gt.ID_COUNTER=0,gt.prototype={constructor:gt,isReady:function(){return this._ready},init:function(t,e){var i=B.gl;if(t="#define HX_VERTEX_SHADER\n"+E.GENERAL+t,e="#define HX_FRAGMENT_SHADER\n"+E.GENERAL+e,t=this._processShaderCode(t),e=this._processShaderCode(e),this._vertexShader=i.createShader(i.VERTEX_SHADER),this._initShader(this._vertexShader,t))if(this._fragmentShader=i.createShader(i.FRAGMENT_SHADER),this._initShader(this._fragmentShader,e))if(this._program=i.createProgram(),i.attachShader(this._program,this._vertexShader),i.attachShader(this._program,this._fragmentShader),i.linkProgram(this._program),!te.OPTIONS.debug||i.getProgramParameter(this._program,i.LINK_STATUS))this._ready=!0,this._uniformSettersInstance=G.getSettersPerInstance(this),this._uniformSettersPass=G.getSettersPerPass(this);else{var n=i.getProgramInfoLog(this._program);if(this.dispose(),console.log("**********"),mt.printShaderCode(t),console.log("**********"),mt.printShaderCode(e),te.OPTIONS.throwOnShaderError)throw new Error("Error in program linking:"+n);console.warn("Error in program linking:"+n)}else{if(this.dispose(),te.OPTIONS.throwOnShaderError)throw new Error("Failed generating fragment shader: \n"+e);console.warn("Failed generating fragment shader:")}else{if(this.dispose(),te.OPTIONS.throwOnShaderError)throw new Error("Failed generating vertex shader: \n"+t);console.warn("Failed generating vertex shader")}},updatePassRenderState:function(t,e){B.gl.useProgram(this._program);for(var i=this._uniformSettersPass.length,n=0;n<i;++n)this._uniformSettersPass[n].execute(t,e)},updateInstanceRenderState:function(t,e){for(var i=this._uniformSettersInstance.length,n=0;n<i;++n)this._uniformSettersInstance[n].execute(t,e)},_initShader:function(t,e){var i=B.gl;return i.shaderSource(t,e),i.compileShader(t),!(te.OPTIONS.debug&&!i.getShaderParameter(t,i.COMPILE_STATUS))||(console.warn(i.getShaderInfoLog(t)),mt.printShaderCode(e),!1)},dispose:function(){var t=B.gl;t.deleteShader(this._vertexShader),t.deleteShader(this._fragmentShader),t.deleteProgram(this._program),this._ready=!1},getProgram:function(){return this._program},getUniformLocation:function(t){return B.gl.getUniformLocation(this._program,t)},getAttributeLocation:function(t){return B.gl.getAttribLocation(this._program,t)},_processShaderCode:function(t){return t=this._processExtensions(t,/^\s*#derivatives\s*$/gm,"GL_OES_standard_derivatives"),t=this._processExtensions(t,/^\s*#texturelod\s*$/gm,"GL_EXT_shader_texture_lod"),t=this._processExtensions(t,/^\s*#drawbuffers\s*$/gm,"GL_EXT_draw_buffers"),t=this._guard(t,/^\s*uniform\s+\w+\s+hx_\w+(\[\w+])?\s*;/gm),t=this._guard(t,/^\s*attribute\s+\w+\s+hx_\w+\s*;/gm),t=E.VERSION+t},_processExtensions:function(t,e,i){return t.search(e)<0?t:t="#extension "+i+" : enable\n"+t.replace(e,"")},_guard:function(t,e){for(var i=t.match(e)||[],n={},r=0;r<i.length;++r){var s=i[r];10===(s=s.replace(/(\r|\n)/g,"")).charCodeAt(0)&&(s=s.substring(1));var o=s.indexOf("hx_"),a=s.indexOf(";"),h=s.indexOf("[");0<=h&&h<a&&(a=h);var _=s.substring(o,a);if(!n[_=_.trim()]){n[_]=!0;var l="HX_GUARD_"+_.toUpperCase(),u="\n#ifndef "+l+"\n#define "+l+"\n"+s+"\n#endif\n";s=s.replace(/\[/g,"\\[");var c=new RegExp(s,"g");t=t.replace(c,u)}}return t}},(xt.prototype=Object.create(gt.prototype)).execute=function(t,e){var i=B.gl;B.setDepthTest(Me.DISABLED),B.setCullMode(Ae.NONE),t._vertexBuffers[0].bind(),t._indexBuffer.bind(),this.updatePassRenderState(),e.bind(0),i.vertexAttribPointer(this._positionAttributeLocation,2,i.FLOAT,!1,16,0),i.vertexAttribPointer(this._texCoordAttributeLocation,2,i.FLOAT,!1,16,8),B.enableAttributes(2),B.drawElements(Le.TRIANGLES,6,0)},vt.prototype=Object.create(xt.prototype),Object.create(xt.prototype).setBlendColor=function(t,e,i,n){var r=B.gl;r.useProgram(this._program),r.uniform4f(this._colorLocation,t,e,i,n)},yt.prototype=Object.create(xt.prototype),Tt.prototype={uploadData:function(t,e){void 0===e&&(e=Oe.STATIC_DRAW),this.bind(),B.gl.bufferData(B.gl.ELEMENT_ARRAY_BUFFER,t,e)},bind:function(){B.gl.bindBuffer(B.gl.ELEMENT_ARRAY_BUFFER,this._buffer)}},St.prototype={uploadData:function(t,e){void 0===e&&(e=B.gl.STATIC_DRAW),this.bind(),B.gl.bufferData(B.gl.ARRAY_BUFFER,t,e)},bind:function(){B.gl.bindBuffer(B.gl.ARRAY_BUFFER,this._buffer)}},Et.EXPANSE_EMPTY=0,Et.EXPANSE_INFINITE=1,Et.EXPANSE_FINITE=2,Et.EXPANSE_INHERIT=3,Et._testAABBToSphere=function(t,e){var i,n=e._maximumX,r=e._maximumY,s=e._maximumZ,o=t._minimumX,a=t._minimumY,h=t._minimumZ,_=e._halfExtentX,l=e._center.x,u=e._center.y,c=e._center.z,d=0;return l<o?d+=(i=l-o)*i:n<l&&(d+=(i=l-n)*i),u<a?d+=(i=u-a)*i:r<u&&(d+=(i=u-r)*i),c<h?d+=(i=c-h)*i:s<c&&(d+=(i=c-s)*i),d<_*_},Et.prototype={get expanse(){return this._expanse},get type(){return this._type},growToIncludeMesh:function(t){throw new Error("Abstract method!")},growToIncludeBound:function(t){throw new Error("Abstract method!")},growToIncludeMinMax:function(t,e){throw new Error("Abstract method!")},clear:function(t){this._minimumX=this._minimumY=this._minimumZ=0,this._maximumX=this._maximumY=this._maximumZ=0,this._center.set(0,0,0),this._halfExtentX=this._halfExtentY=this._halfExtentZ=0,this._expanse=void 0===t?Et.EXPANSE_EMPTY:t},get minimum(){return new O(this._minimumX,this._minimumY,this._minimumZ,1)},get maximum(){return new O(this._maximumX,this._maximumY,this._maximumZ,1)},get center(){return this._center},get halfExtent(){return new O(this._halfExtentX,this._halfExtentY,this._halfExtentZ,0)},getRadius:function(){throw new Error("Abstract method!")},transformFrom:function(t,e){throw new Error("Abstract method!")},intersectsConvexSolid:function(t,e){throw new Error("Abstract method!")},intersectsBound:function(t){throw new Error("Abstract method!")},classifyAgainstPlane:function(t){throw new Error("Abstract method!")},intersectsRay:function(t){throw new Error("Abstract method!")},createDebugModel:function(){throw new Error("Abstract method!")},getDebugModel:function(){return void 0===this._type._debugModel&&(this._type._debugModel=this.createDebugModel()),this._type._debugModel},toString:function(){return"BoundingVolume: [ "+this._minimumX+", "+this._minimumY+", "+this._minimumZ+" ] - [ "+this._maximumX+", "+this._maximumY+", "+this._maximumZ+" ], expanse: "+this._expanse}};var wt={FRONT:1,BACK:-1,INTERSECTING:0};function At(){Et.call(this,At)}function Pt(){this.name=null,this._positionBuffer=null,this._normalBuffer=null,this._numVertices=0}(At.prototype=Object.create(Et.prototype)).growToIncludeMesh=function(t){if(this._expanse!==Et.EXPANSE_INFINITE){var e,i,n,r,s,o,a=t.getVertexAttributeByName("hx_position"),h=a.offset,_=t.getVertexStride(a.streamIndex),l=t.getVertexData(a.streamIndex),u=l.length;for(this._expanse===Et.EXPANSE_EMPTY?(r=e=l[h],s=i=l[h+1],o=n=l[h+2],h+=_):(e=this._minimumX,i=this._minimumY,n=this._minimumZ,r=this._maximumX,s=this._maximumY,o=this._maximumZ);h<u;h+=_){var c=l[h],d=l[h+1],f=l[h+2];r<c?r=c:c<e&&(e=c),s<d?s=d:d<i&&(i=d),o<f?o=f:f<n&&(n=f)}this._minimumX=e,this._minimumY=i,this._minimumZ=n,this._maximumX=r,this._maximumY=s,this._maximumZ=o,this._expanse=Et.EXPANSE_FINITE,this._updateCenterAndExtent()}},At.prototype.growToIncludeBound=function(t){t._expanse!==Et.EXPANSE_EMPTY&&t._expanse!==Et.EXPANSE_INHERIT&&this._expanse!==Et.EXPANSE_INFINITE&&(t._expanse===Et.EXPANSE_INFINITE?this._expanse=Et.EXPANSE_INFINITE:this._expanse===Et.EXPANSE_EMPTY?(this._minimumX=t._minimumX,this._minimumY=t._minimumY,this._minimumZ=t._minimumZ,this._maximumX=t._maximumX,this._maximumY=t._maximumY,this._maximumZ=t._maximumZ,this._expanse=Et.EXPANSE_FINITE):(t._minimumX<this._minimumX&&(this._minimumX=t._minimumX),t._minimumY<this._minimumY&&(this._minimumY=t._minimumY),t._minimumZ<this._minimumZ&&(this._minimumZ=t._minimumZ),t._maximumX>this._maximumX&&(this._maximumX=t._maximumX),t._maximumY>this._maximumY&&(this._maximumY=t._maximumY),t._maximumZ>this._maximumZ&&(this._maximumZ=t._maximumZ)),this._updateCenterAndExtent())},At.prototype.growToIncludeMinMax=function(t,e){this._expanse!==Et.EXPANSE_INFINITE&&(this._expanse===Et.EXPANSE_EMPTY?(this._minimumX=t.x,this._minimumY=t.y,this._minimumZ=t.z,this._maximumX=e.x,this._maximumY=e.y,this._maximumZ=e.z,this._expanse=Et.EXPANSE_FINITE):(t.x<this._minimumX&&(this._minimumX=t.x),t.y<this._minimumY&&(this._minimumY=t.y),t.z<this._minimumZ&&(this._minimumZ=t.z),e.x>this._maximumX&&(this._maximumX=e.x),e.y>this._maximumY&&(this._maximumY=e.y),e.z>this._maximumZ&&(this._maximumZ=e.z)),this._updateCenterAndExtent())},At.prototype.transformFrom=function(t,e){if(t._expanse===Et.EXPANSE_FINITE){var i=e._m,n=i[0],r=i[1],s=i[2],o=i[4],a=i[5],h=i[6],_=i[8],l=i[9],u=i[10],c=t._center.x,d=t._center.y,f=t._center.z,p=this._center.x=n*c+o*d+_*f+i[12],m=this._center.y=r*c+a*d+l*f+i[13],g=this._center.z=s*c+h*d+u*f+i[14];n<0&&(n=-n),r<0&&(r=-r),s<0&&(s=-s),o<0&&(o=-o),a<0&&(a=-a),h<0&&(h=-h),_<0&&(_=-_),l<0&&(l=-l),u<0&&(u=-u),c=t._halfExtentX,d=t._halfExtentY,f=t._halfExtentZ;var x=this._halfExtentX=n*c+o*d+_*f,v=this._halfExtentY=r*c+a*d+l*f,y=this._halfExtentZ=s*c+h*d+u*f;this._minimumX=p-x,this._minimumY=m-v,this._minimumZ=g-y,this._maximumX=p+x,this._maximumY=m+v,this._maximumZ=g+y,this._expanse=t._expanse}else this.clear(t._expanse)},At.prototype.intersectsConvexSolid=function(t,e){if(this._expanse===Et.EXPANSE_INFINITE||this._expanse===Et.EXPANSE_INHERIT)return!0;if(this._expanse===Et.EXPANSE_EMPTY)return!1;for(var i=this._minimumX,n=this._minimumY,r=this._minimumZ,s=this._maximumX,o=this._maximumY,a=this._maximumZ,h=0;h<e;++h){var _=t[h],l=_.x,u=_.y,c=_.z;if(0<l*(0<l?i:s)+u*(0<u?n:o)+c*(0<c?r:a)+_.w)return!1}return!0},At.prototype.intersectsBound=function(t){return this._expanse!==Et.EXPANSE_EMPTY&&t._expanse!==Et.EXPANSE_EMPTY&&(this._expanse===Et.EXPANSE_INFINITE||t._expanse===Et.EXPANSE_INFINITE||this._expanse===Et.EXPANSE_INHERIT||t._expanse===Et.EXPANSE_INHERIT||(t._type===this._type?this._maximumX>t._minimumX&&this._minimumX<t._maximumX&&this._maximumY>t._minimumY&&this._minimumY<t._maximumY&&this._maximumZ>t._minimumZ&&this._minimumZ<t._maximumZ:Et._testAABBToSphere(this,t)))},At.prototype.classifyAgainstPlane=function(t){var e=t.x,i=t.y,n=t.z,r=t.w,s=e*this._center.x+i*this._center.y+n*this._center.z+r;e<0&&(e=-e),i<0&&(i=-i),n<0&&(n=-n);var o=e*this._halfExtentX+i*this._halfExtentY+n*this._halfExtentZ;return o<s?wt.FRONT:s<-o?wt.BACK:wt.INTERSECTING},At.prototype.intersectsRay=function(t){if(this._expanse===Et.EXPANSE_INFINITE)return!0;if(this._expanse===Et.EXPANSE_EMPTY||this._expanse===Et.EXPANSE_INHERIT)return!1;var e,i,n=t.origin,r=t.direction,s=n.x,o=n.y,a=n.z,h=r.x,_=r.y,l=r.z,u=1/h,c=1/_,d=1/l,f=-1/0,p=1/0;return 0!==h&&(e=(this._minimumX-s)*u,i=(this._maximumX-s)*u,f=Math.min(e,i),p=Math.max(e,i)),0!==_&&(e=(this._minimumY-o)*c,i=(this._maximumY-o)*c,f=Math.max(f,Math.min(e,i)),p=Math.min(p,Math.max(e,i))),0!==l&&(e=(this._minimumZ-a)*d,i=(this._maximumZ-a)*d,f=Math.max(f,Math.min(e,i)),p=Math.min(p,Math.max(e,i))),0<p&&f<=p},At.prototype.setExplicit=function(t,e){this._minimumX=t.x,this._minimumY=t.y,this._minimumZ=t.z,this._maximumX=e.x,this._maximumY=e.y,this._maximumZ=e.z,this._expanse=Et.EXPANSE_FINITE,this._updateCenterAndExtent()},At.prototype._updateCenterAndExtent=function(){var t=this._minimumX,e=this._minimumY,i=this._minimumZ,n=this._maximumX,r=this._maximumY,s=this._maximumZ;this._center.x=.5*(t+n),this._center.y=.5*(e+r),this._center.z=.5*(i+s),this._halfExtentX=.5*(n-t),this._halfExtentY=.5*(r-e),this._halfExtentZ=.5*(s-i)},At.prototype.getRadius=function(){return Math.sqrt(this._halfExtentX*this._halfExtentX+this._halfExtentY*this._halfExtentY+this._halfExtentZ*this._halfExtentZ)},At.prototype.getHalfExtents=function(){return new O(this._halfExtentX,this._halfExtentY,this._halfExtentZ,0)},Pt.prototype={get hasNormals(){return!!this._normalBuffer},get numVertices(){return this._numVertices},get positionBuffer(){return this._positionBuffer},get normalBuffer(){return this._normalBuffer},init:function(t,e){this._numVertices=t.length/3,this._positionBuffer=new St,this._positionBuffer.uploadData(new Float32Array(t)),e&&(this._normalBuffer=new St,this._normalBuffer.uploadData(new Float32Array(e)))}};var Mt=0;function Lt(){this.onBoundsChanged=new n,this.onLayoutChanged=new n,this.onMorphDataCreated=new n,this.onSkeletonChange=new n,this._name="",this._bounds=new At,this._boundsInvalid=!0,this._dynamicBounds=!0,this._vertexBuffers=[],this._vertexStrides=[],this._vertexData=[],this._indexData=void 0,this._vertexUsage=Oe.STATIC_DRAW,this._indexUsage=Oe.STATIC_DRAW,this._numStreams=0,this._numVertices=0,this._vertexAttributes=[],this._vertexAttributesLookUp={},this._indexBuffer=new Tt,this._morphTargets={},this._hasMorphNormals=!1,this._defaultMorphTarget=null,this._skeleton=null,this._renderOrderHint=++Mt}Lt.DEFAULT_VERTEX_SIZE=12,Lt.ID_COUNTER=0,Lt.createDefaultEmpty=function(t){return(t=t||new Lt).addVertexAttribute("hx_position",3),t.addVertexAttribute("hx_normal",3),t.addVertexAttribute("hx_tangent",4),t.addVertexAttribute("hx_texCoord",2),t},Lt.prototype={get bounds(){return this._boundsInvalid&&this._updateBounds(),this._bounds},set bounds(t){this._bounds=t,this._invalidateBounds()},get dynamicBounds(){return this._dynamicBounds},set dynamicBounds(t){t!==this._dynamicBounds&&((this._dynamicBounds=t)?this._invalidateBounds():this._boundsInvalid=!1)},get skeleton(){return this._skeleton},set skeleton(t){this._skeleton=t,this.onSkeletonChange.dispatch()},get hasMorphData(){return!!this._defaultMorphTarget},get hasMorphNormals(){return this._hasMorphNormals},hasVertexData:function(t){return!!this._vertexData[t]},getVertexData:function(t){return this._vertexData[t]},setVertexData:function(t,e,i){e=e||0,this._vertexUsage=i||Oe.STATIC_DRAW,this._vertexData[e]=t instanceof Float32Array?t:new Float32Array(t),this._vertexBuffers[e]=this._vertexBuffers[e]||new St,this._vertexBuffers[e].uploadData(this._vertexData[e],this._vertexUsage),0===e&&(this._numVertices=t.length/this._vertexStrides[0]),this._invalidateBounds()},getIndexData:function(){return this._indexData},setIndexData:function(t,e){this._indexUsage=e||Oe.STATIC_DRAW,t instanceof Uint16Array?(this._indexData=t,this._indexType=De.UNSIGNED_SHORT):t instanceof Uint32Array?(this._indexData=t,this._indexType=De.UNSIGNED_INT):(this._indexData=new Uint16Array(t),this._indexType=De.UNSIGNED_SHORT),this._numIndices=this._indexData.length,this._indexBuffer.uploadData(this._indexData,this._indexUsage)},addVertexAttribute:function(t,e,i){i=i||0,this._numStreams=Math.max(this._numStreams,i+1);var n=this._vertexStrides[i]||0,r={name:t,offset:n,numComponents:e,streamIndex:i};this._vertexAttributes.push(r),this._vertexAttributesLookUp[t]=r,this._vertexStrides[i]=n+e,this.onLayoutChanged.dispatch()},get numStreams(){return this._numStreams},extractAttributeData:function(t){for(var e=this.getVertexAttributeByName(t),i=this.getVertexStride(e),n=this.getVertexData(e.streamIndex),r=e.numComponents,s=[],o=0,a=e.offset;a<n.length;a+=i)for(var h=0;h<r;++h)s[o++]=n[a+h];return s},generateMorphData:function(t){var e;for(t?(this._hasMorphNormals=!0,e=4):e=8,n=0;n<e;++n)this.addVertexAttribute("hx_morphPosition"+n,3,this._numStreams),t&&this.addVertexAttribute("hx_morphNormal"+n,3,this._numStreams);for(var i=[],n=0;n<this._numVertices;++n)i.push(0,0,0);this._defaultMorphTarget=new St,this._defaultMorphTarget.uploadData(new Float32Array(i),Oe.STATIC_DRAW),this.onMorphDataCreated.dispatch(),this.onLayoutChanged.dispatch()},get numVertices(){return this._numVertices},get numIndices(){return this._numIndices},get numVertexAttributes(){return this._vertexAttributes.length},getVertexStride:function(t){return this._vertexStrides[t]},getVertexAttributeByName:function(t){return this._vertexAttributesLookUp[t]},getVertexAttributeByIndex:function(t){return this._vertexAttributes[t]},addMorphTarget:function(t){this._morphTargets[t.name]=t,this._defaultMorphTarget||this.generateMorphData()},removeMorphTarget:function(t){delete this._morphTargets[t.name]},getMorphTarget:function(t){return this._morphTargets[t]},clone:function(){for(var t=new Lt,e=this._vertexAttributes.length,i=0;i<e;++i){var n=this._vertexAttributes[i];t.addVertexAttribute(n.name,n.numComponents,n.streamIndex)}for(i=0;i<this._numStreams;++i)this._vertexData[i]&&t.setVertexData(this._vertexData[i],i,this._vertexUsage);return this._indexData&&t.setIndexData(this._indexData,this._indexUsage),t},translate:function(t,e,i){t instanceof O&&(t.y,t.z,t=t.x);var n=this.getVertexAttributeByName("hx_position");if(n){for(var r=this.getVertexStride(n),s=this.getVertexData(n.streamIndex),o=n.offset;o<s.length;o+=r)s[o]+=t,s[o+1]+=t,s[o+2]+=t;this._vertexBuffers[n.streamIndex].uploadData(this._vertexData[n.streamIndex],this._vertexUsage)}},_updateBounds:function(){this._bounds.clear(),this._bounds.growToIncludeMesh(this),this._boundsInvalid=!1},_invalidateBounds:function(){this._dynamicBounds&&(this._boundsInvalid=!0,this.onBoundsChanged.dispatch())}};var Rt,bt,It={create:function(){var t=new Lt;return t.addVertexAttribute("hx_position",2),t.addVertexAttribute("hx_texCoord",2),t.setVertexData([-1,1,0,1,1,1,1,1,1,-1,1,0,-1,-1,0,0],0),t.setIndexData([0,1,2,0,2,3]),t},_initDefault:function(){It.DEFAULT=It.create()}},Nt={assureSize:function(t,e,i,n,r,s){return(t!==i.width||e!==i.height)&&(i.initEmpty(t,e,r,s),n&&n.init(),!0)},copy:function(t,e){B.setRenderTarget(e),B.clear(),Te.COPY_SHADER.execute(It.DEFAULT,t),B.setRenderTarget(null)},encodeHalfFloat:(Rt=new Float32Array(1),bt=new Int32Array(Rt.buffer),function(t){Rt[0]=t;var e=bt[0],i=e>>16&32768,n=e>>12&2047,r=e>>23&255;return r<103?i:142<r?(i|=31744,i|=(255===r?0:1)&&8388607&e):r<113?i|=((n|=2048)>>114-r)+(n>>113-r&1):(i|=r-112<<10|n>>1,i+=1&n)}),encodeToFloat16Array:function(t){for(var e=Nt.encodeHalfFloat,i=[],n=0;n<t.length;++n)i[n]=e(t[n]);return new Uint16Array(i)}};function Dt(){this._name=null,this._default=Dt.DEFAULT,this._texture=B.gl.createTexture(),this._width=0,this._height=0,this._format=null,this._dataType=null,this.bind(),this.maxAnisotropy=Se.DEFAULT_TEXTURE_MAX_ANISOTROPY,this.filter=Ee.DEFAULT,this.wrapMode=we.DEFAULT,this._isReady=!1,B.gl.bindTexture(B.gl.TEXTURE_2D,null)}function Ot(){this._name=null,this._default=Ot.DEFAULT,this._texture=B.gl.createTexture(),this._size=0,this._format=null,this._dataType=null,this.bind(),this.filter=Ee.DEFAULT,this.maxAnisotropy=Se.DEFAULT_TEXTURE_MAX_ANISOTROPY,this._isReady=!1}function Ct(t,e,i,n){this.enabled=!0,this.srcFactor=t||Re.ONE,this.dstFactor=e||Re.ZERO,this.operator=i||be.ADD,this.alphaSrcFactor=null,this.alphaDstFactor=null,this.alphaOperator=null,this.color=n||null}function Ft(t,e,i){if(t&&void 0===t[0]&&(t=[t]),this._cubeFace=i,this._colorTextures=t,this._numColorTextures=this._colorTextures?this._colorTextures.length:0,this._depthBuffer=e,this._colorTextures&&1<this._numColorTextures){this._drawBuffers=new Array(this._numColorTextures);for(var n=0;n<this._numColorTextures;++n)this._drawBuffers[n]=Se.EXT_DRAW_BUFFERS.COLOR_ATTACHMENT0_WEBGL+n}else this._drawBuffers=null;this._fbo=B.gl.createFramebuffer()}Dt._initDefault=function(){var t=new Uint8Array([255,0,255,255]);(Dt.DEFAULT=new Dt).uploadData(t,1,1,!0),Dt.DEFAULT.filter=Ee.NEAREST_NOMIP},Dt.prototype={get name(){return this._name},set name(t){this._name=t},generateMipmap:function(){var t=B.gl;this.bind(),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)},get filter(){return this._filter},set filter(t){var e=B.gl;this._filter=t,this.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.min),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t.mag),e.bindTexture(e.TEXTURE_2D,null),t!==Ee.NEAREST_NOMIP&&t!==Ee.NEAREST||(this.maxAnisotropy=1)},get wrapMode(){return this._wrapMode},set wrapMode(t){var e=B.gl;this._wrapMode=t,this.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t.s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t.t),e.bindTexture(e.TEXTURE_2D,null)},get maxAnisotropy(){return this._maxAnisotropy},set maxAnisotropy(t){var e=B.gl;t>Se.DEFAULT_TEXTURE_MAX_ANISOTROPY&&(t=Se.DEFAULT_TEXTURE_MAX_ANISOTROPY),this._maxAnisotropy=t,this.bind(),Se.EXT_TEXTURE_FILTER_ANISOTROPIC&&B.gl.texParameteri(e.TEXTURE_2D,Se.EXT_TEXTURE_FILTER_ANISOTROPIC.TEXTURE_MAX_ANISOTROPY_EXT,t),e.bindTexture(e.TEXTURE_2D,null)},get width(){return this._width},get height(){return this._height},get format(){return this._format},get dataType(){return this._dataType},initEmpty:function(t,e,i,n){var r=B.gl;this._format=i=i||Ne.RGBA,this._dataType=n=n||De.UNSIGNED_BYTE,this.bind(),this._width=t,this._height=e;var s=Ne.getDefaultInternalFormat(i,n);r.texImage2D(r.TEXTURE_2D,0,s,t,e,0,i,n,null),this._isReady=!0,r.bindTexture(r.TEXTURE_2D,null)},uploadData:function(t,e,i,n,r,s){var o=B.gl;Se.EXT_HALF_FLOAT_TEXTURES&&s===De.HALF_FLOAT&&(t=Nt.encodeToFloat16Array(t)),this._width=e,this._height=i,this._format=r=r||Ne.RGBA,this._dataType=s=s||De.UNSIGNED_BYTE,n=void 0!==n&&n,this.bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0);var a=Ne.getDefaultInternalFormat(r,s);o.texImage2D(o.TEXTURE_2D,0,a,e,i,0,r,s,t),n&&o.generateMipmap(o.TEXTURE_2D),this._isReady=!0,o.bindTexture(o.TEXTURE_2D,null)},uploadImage:function(t,e,i,n,r,s){var o=B.gl;this._width=e,this._height=i,this._format=r=r||Ne.RGBA,this._dataType=s=s||De.UNSIGNED_BYTE,n=void 0===n||n,this.bind(),t&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,1);var a=Ne.getDefaultInternalFormat(r,s);o.texImage2D(o.TEXTURE_2D,0,a,r,s,t),n&&o.generateMipmap(o.TEXTURE_2D),this._isReady=!0,o.bindTexture(o.TEXTURE_2D,null)},isReady:function(){return this._isReady},bind:function(t){var e=B.gl;void 0!==t&&e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,this._texture)},toString:function(){return"[Texture2D(name="+this._name+")]"}},Ot._initDefault=function(){var t=B.gl,e=new Uint8Array([255,0,255,255]);(Ot.DEFAULT=new Ot).uploadData([e,e,e,e,e,e],1,!0),Ot.DEFAULT.filter=Ee.NEAREST_NOMIP,t.bindTexture(t.TEXTURE_CUBE_MAP,null)},Ot.prototype={get name(){return this._name},set name(t){this._name=t},generateMipmap:function(){this.bind();var t=B.gl;t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null)},get filter(){return this._filter},set filter(t){this._filter=t,this.bind();var e=B.gl;e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,t.min),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,t.mag),e.bindTexture(e.TEXTURE_CUBE_MAP,null)},get maxAnisotropy(){return this._maxAnisotropy},set maxAnisotropy(t){t>Se.DEFAULT_TEXTURE_MAX_ANISOTROPY&&(t=Se.DEFAULT_TEXTURE_MAX_ANISOTROPY),this._maxAnisotropy=t,this.bind();var e=B.gl;Se.EXT_TEXTURE_FILTER_ANISOTROPIC&&e.texParameteri(e.TEXTURE_CUBE_MAP,Se.EXT_TEXTURE_FILTER_ANISOTROPIC.TEXTURE_MAX_ANISOTROPY_EXT,t),e.bindTexture(e.TEXTURE_CUBE_MAP,null)},get size(){return this._size},get format(){return this._format},get dataType(){return this._dataType},initEmpty:function(t,e,i){this._format=e=e||Ne.RGBA,this._dataType=i=i||De.UNSIGNED_BYTE,this._size=t,this.bind();var n=B.gl,r=Ne.getDefaultInternalFormat(e,i);n.texImage2D(Ce.POSITIVE_X,0,r,t,t,0,e,i,null),n.texImage2D(Ce.NEGATIVE_X,0,r,t,t,0,e,i,null),n.texImage2D(Ce.POSITIVE_Y,0,r,t,t,0,e,i,null),n.texImage2D(Ce.NEGATIVE_Y,0,r,t,t,0,e,i,null),n.texImage2D(Ce.POSITIVE_Z,0,r,t,t,0,e,i,null),n.texImage2D(Ce.NEGATIVE_Z,0,r,t,t,0,e,i,null),this._isReady=!0,n.bindTexture(n.TEXTURE_2D,null)},uploadData:function(t,e,i,n,r){this._size=e,this._format=n=n||Ne.RGBA,this._dataType=r=r||De.UNSIGNED_BYTE,i=void 0===i||i,this.bind();var s=B.gl;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0);var o=Ne.getDefaultInternalFormat(n,r);s.texImage2D(Ce.POSITIVE_X,0,o,e,e,0,n,r,t[0]),s.texImage2D(Ce.NEGATIVE_X,0,o,e,e,0,n,r,t[1]),s.texImage2D(Ce.POSITIVE_Y,0,o,e,e,0,n,r,t[2]),s.texImage2D(Ce.NEGATIVE_Y,0,o,e,e,0,n,r,t[3]),s.texImage2D(Ce.POSITIVE_Z,0,o,e,e,0,n,r,t[4]),s.texImage2D(Ce.NEGATIVE_Z,0,o,e,e,0,n,r,t[5]),i&&s.generateMipmap(s.TEXTURE_CUBE_MAP),this._isReady=!0,s.bindTexture(s.TEXTURE_CUBE_MAP,null)},uploadImages:function(t,e,i,n){e=void 0===e||e,this._format=i,this._dataType=n,this.uploadImagesToMipLevel(t,0,i,n);var r=B.gl;e&&(this.bind(),r.generateMipmap(r.TEXTURE_CUBE_MAP)),this._isReady=!0,r.bindTexture(r.TEXTURE_CUBE_MAP,null)},uploadImagesToMipLevel:function(t,e,i,n){var r=B.gl;this._format=i=i||Ne.RGBA,this._dataType=n=n||De.UNSIGNED_BYTE,0===e&&(this._size=t[0].naturalWidth),this.bind(),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,0);var s=Ne.getDefaultInternalFormat(i,n);r.texImage2D(Ce.POSITIVE_X,e,s,i,n,t[0]),r.texImage2D(Ce.NEGATIVE_X,e,s,i,n,t[1]),r.texImage2D(Ce.POSITIVE_Y,e,s,i,n,t[2]),r.texImage2D(Ce.NEGATIVE_Y,e,s,i,n,t[3]),r.texImage2D(Ce.POSITIVE_Z,e,s,i,n,t[4]),r.texImage2D(Ce.NEGATIVE_Z,e,s,i,n,t[5]),r.bindTexture(r.TEXTURE_CUBE_MAP,null)},isReady:function(){return this._isReady},bind:function(t){var e=B.gl;void 0!==t&&e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_CUBE_MAP,this._texture)},toString:function(){return"[TextureCube(name="+this._name+")]"}},Ct.prototype={clone:function(){return new Ct(this.srcFactor,this.dstFactor,this.operator,this.color)}},Ct._initDefaults=function(){Ct.ADD=new Ct(Re.SOURCE_ALPHA,Re.ONE),Ct.ADD_NO_ALPHA=new Ct(Re.ONE,Re.ONE),Ct.MULTIPLY=new Ct(Re.DESTINATION_COLOR,Re.ZERO),(Ct.ALPHA=new Ct(Re.SOURCE_ALPHA,Re.ONE_MINUS_SOURCE_ALPHA)).alphaSrcFactor=Re.ONE,Ct.ALPHA.alphaDstFactor=Re.ONE_MINUS_SOURCE_ALPHA,Ct.INV_ALPHA=new Ct(Re.ONE_MINUS_SOURCE_ALPHA,Re.SOURCE_ALPHA)},Ft.prototype={get width(){return this._width},get height(){return this._height},init:function(t){var e=B.gl;e.bindFramebuffer(e.FRAMEBUFFER,this._fbo),this._colorTextures?void 0===this._cubeFace?(this._width=this._colorTextures[0]._width,this._height=this._colorTextures[0]._height):this._height=this._width=this._colorTextures[0].size:(this._width=this._depthBuffer._width,this._height=this._depthBuffer._height);var i=void 0===this._cubeFace?e.TEXTURE_2D:this._cubeFace;if(1===this._numColorTextures){var n=this._colorTextures[0];e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,i,n._texture,0)}else{if(!Se.EXT_DRAW_BUFFERS)throw new Error("Trying to bind multiple render targets without EXT_DRAW_BUFFERS support!");for(var r=0;r<this._numColorTextures;++r)n=this._colorTextures[r],e.framebufferTexture2D(e.FRAMEBUFFER,Se.EXT_DRAW_BUFFERS.COLOR_ATTACHMENT0_WEBGL+r,i,n._texture,0)}if(this._depthBuffer){var s=this._depthBuffer.format===e.DEPTH_STENCIL?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;this._depthBuffer instanceof Dt?e.framebufferTexture2D(e.FRAMEBUFFER,s,e.TEXTURE_2D,this._depthBuffer._texture,0):e.framebufferRenderbuffer(e.FRAMEBUFFER,s,e.RENDERBUFFER,this._depthBuffer._renderBuffer)}var o=e.checkFramebufferStatus(e.FRAMEBUFFER);switch(o&&!t){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.warn("Failed to initialize FBO: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.warn("Failed to initialize FBO: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.warn("Failed to initialize FBO: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case e.FRAMEBUFFER_UNSUPPORTED:console.warn("Failed to initialize FBO: FRAMEBUFFER_UNSUPPORTED")}return o===e.FRAMEBUFFER_COMPLETE},readPixels:function(){var t,e,i=B.gl,n=this._colorTextures[0];switch(i.bindFramebuffer(i.FRAMEBUFFER,this._fbo),n.format){case Ne.RGB:t=3;break;case Ne.RGBA:t=4}var r=this.width*this.height*t;switch(n.dataType){case De.FLOAT:case De.HALF_FLOAT:e=new Float32Array(r);break;case De.UNSIGNED_BYTE:e=new Uint8Array(r)}return i.readPixels(0,0,this.width,this.height,n.format,n.dataType,e),i.bindFramebuffer(i.FRAMEBUFFER,null),e}};var Ut={getSettersPerPass:function(t){return void 0===Ut._passTable&&Ut._init(),Ut._findSetters(t,Ut._passTable)},getSettersPerInstance:function(t){return void 0===Ut._instanceTable&&Ut._init(),Ut._findSetters(t,Ut._instanceTable)},_findSetters:function(t,e){var i=[];for(var n in e)if(e.hasOwnProperty(n)){var r=t.getTextureSlot(n);if(r){var s=new e[n];i.push(s),s.slot=r,s.pass=t}}return i},_init:function(){Ut._passTable={},Ut._instanceTable={},Ut._passTable.hx_normalDepthBuffer=Bt,Ut._passTable.hx_backbuffer=Ht,Ut._passTable.hx_frontbuffer=Xt,Ut._passTable.hx_lightAccumulation=zt,Ut._passTable.hx_ssao=Vt,Ut._passTable.hx_shadowMap=kt,Ut._passTable["hx_diffuseProbes[0]"]=Gt,Ut._passTable["hx_specularProbes[0]"]=Yt,Ut._instanceTable.hx_skinningTexture=jt},setArray:function(t,e,i){for(var n=i.length,r=e.location,s=0;s<n;++s){var o=t._textureSlots[e.index+s];if(!o||o.location!==r)return;o.texture=i[s]}}};function Bt(){}function Xt(){}function Ht(){}function zt(){}function Vt(){}function kt(){}function Gt(){}function Yt(){}function jt(){}function Wt(){this.location=-1,this.texture=null,this.name=null,this.index=-1}function Zt(){this.blockIndex=-1,this.bindingPoint=-1,this.buffer=null,this.name=null}Bt.prototype.execute=function(t){this.slot.texture=t._normalDepthBuffer},Xt.prototype.execute=function(t){t._hdrFront&&(this.slot.texture=t._hdrFront.texture)},Ht.prototype.execute=function(t){t._hdrBack&&(this.slot.texture=t._hdrBack.texture)},zt.prototype.execute=function(t){t._hdrBack&&(this.slot.texture=t._hdrBack.texture)},Vt.prototype.execute=function(t){this.slot.texture=t._ssaoTexture},kt.prototype.execute=function(t){this.slot.texture=t._shadowAtlas.texture},Gt.prototype.execute=function(t){Ut.setArray(this.pass,this.slot,t._diffuseProbeArray)},Yt.prototype.execute=function(t){Ut.setArray(this.pass,this.slot,t._specularProbeArray)},jt.prototype.execute=function(t){this.slot.texture=t.skeletonMatrices};var qt={getSettersPerPass:function(t){return void 0===qt._passTable&&qt._init(),qt._findSetters(t,qt._passTable)},getSettersPerInstance:function(t){return void 0===qt._instanceTable&&qt._init(),qt._findSetters(t,qt._instanceTable)},_findSetters:function(t,e){var i=[];for(var n in e)if(e.hasOwnProperty(n)){var r=t.getUniformBufferSlot(n);if(r){var s=new e[n];i.push(s),s.slot=r}}return i},_init:function(){qt._passTable={},qt._instanceTable={},qt._passTable.hx_lights=Kt,qt._passTable.hx_lightingCells=Jt}};function Kt(){}function Jt(){}function Qt(t){this._buffer=B.gl.createBuffer(),this._uniforms=[],this._size=t}function $t(t){this._shader=t,this._textureSlots=[],this._uniformBufferSlots=[],this._uniforms={},this._elementType=Le.TRIANGLES,this._cullMode=Ae.BACK,this._writeColor=!0,this._depthTest=Me.LESS_EQUAL,this._writeDepth=!0,this._blendState=null,this._storeUniforms(),this._textureSettersPass=Ut.getSettersPerPass(this),this._textureSettersInstance=Ut.getSettersPerInstance(this),Se.WEBGL_2&&(this._uniformBufferSettersPass=qt.getSettersPerPass(this),this._uniformBufferSettersInstance=qt.getSettersPerInstance(this)),this.setTexture("hx_dither2D",Te.DEFAULT_2D_DITHER_TEXTURE)}Kt.prototype.execute=function(t){this.slot.buffer=t._lightingUniformBuffer},Jt.prototype.execute=function(t){this.slot.buffer=t._lightingCellsUniformBuffer},Qt.prototype={get size(){return this._size},uploadData:function(t,e){var i=B.gl;void 0===e&&(e=i.DYNAMIC_DRAW),this.bind(),i.bufferData(i.UNIFORM_BUFFER,t,e)},registerUniform:function(t,e,i,n){this._uniforms[t]={offset:e,size:i,type:n}},getUniformOffset:function(t){var e=this._uniforms[t];return e?e.offset:-1},setUniform:function(t,e){var i=B.gl,n=this._uniforms[t];switch(this.bind(),n.type){case i.FLOAT:var r=new Float32Array(1);r[0]=e,e=r;break;case i.FLOAT_VEC2:(r=new Float32Array(2))[0]=value.x||value[0]||0,r[1]=value.y||value[1]||0,e=r;break;case i.FLOAT_VEC3:(r=new Float32Array(3))[0]=value.x||value[0]||0,r[1]=value.y||value[1]||0,r[2]=value.z||value[2]||0,e=r;break;case i.FLOAT_VEC4:(r=new Float32Array(4))[0]=value.x||value[0]||0,r[1]=value.y||value[1]||0,r[2]=value.z||value[2]||0,r[3]=value.w||value[3]||0,e=r;break;case i.INT:case i.BOOL:(r=new Int32Array(1))[0]=value,e=r;break;case i.INT_VEC2:case i.BOOL_VEC2:(r=new Int32Array(2))[0]=value.x||value[0]||0,r[1]=value.y||value[1]||0,e=r;break;case i.INT_VEC3:case i.BOOL_VEC3:(r=new Int32Array(3))[0]=value.x||value[0]||0,r[1]=value.y||value[1]||0,r[2]=value.z||value[2]||0,e=r;break;case i.INT_VEC4:case i.BOOL_VEC4:(r=new Int32Array(4))[0]=value.x||value[0]||0,r[1]=value.y||value[1]||0,r[2]=value.z||value[2]||0,r[3]=value.w||value[3]||0,e=r;break;case i.FLOAT_MAT4:e=value}i.bufferSubData(i.UNIFORM_BUFFER,n.offset,n.size,e)},bind:function(t){var e=B.gl;void 0===t?e.bindBuffer(e.UNIFORM_BUFFER,this._buffer):e.bindBufferBase(e.UNIFORM_BUFFER,t,this._buffer)}},$t.BASE_PASS=0,$t.NORMAL_DEPTH_PASS=1,$t.DIR_LIGHT_SHADOW_MAP_PASS=2,$t.POINT_LIGHT_SHADOW_MAP_PASS=3,$t.DIR_LIGHT_PASS=4,$t.POINT_LIGHT_PASS=5,$t.SPOT_LIGHT_PASS=6,$t.LIGHT_PROBE_PASS=7,$t.NUM_PASS_TYPES=8;var te={INITIALIZED:!($t.prototype={constructor:$t,getShader:function(){return this._shader},get elementType(){return this._elementType},set elementType(t){this._elementType=t},get depthTest(){return this._depthTest},set depthTest(t){this._depthTest=t},get writeColor(){return this._writeColor},set writeColor(t){this._writeColor=t},get writeDepth(){return this._writeDepth},set writeDepth(t){this._writeDepth=t},get cullMode(){return this._cullMode},set cullMode(t){this._cullMode=t},get blendState(){return this._blendState},set blendState(t){this._blendState=t},updateInstanceRenderState:function(t,e){for(var i=this._textureSettersInstance.length,n=0;n<i;++n)this._textureSettersInstance[n].execute(e);if(this._uniformBufferSettersInstance)for(i=this._uniformBufferSettersInstance.length,n=0;n<i;++n)this._uniformBufferSettersInstance[n].execute(e);this._shader.updateInstanceRenderState(t,e)},updatePassRenderState:function(t,e,i){var n,r=this._textureSettersPass.length;for(n=0;n<r;++n)this._textureSettersPass[n].execute(e);if(this._uniformBufferSettersPass)for(r=this._uniformBufferSettersPass.length,n=0;n<r;++n)this._uniformBufferSettersPass[n].execute(e);for(r=this._textureSlots.length,n=0;n<r;++n){var s=this._textureSlots[n],o=s.texture;o?o.isReady()?o.bind(n):o._default.bind(n):Dt.DEFAULT.bind(n)}for(r=this._uniformBufferSlots.length,n=0;n<r;++n){(s=this._uniformBufferSlots[n]).buffer.bind(n)}B.setMaterialPassState(this._cullMode,this._depthTest,this._writeDepth,this._writeColor,this._blendState),this._shader.updatePassRenderState(t,e)},_storeUniforms:function(){for(var t=B.gl,e=t.getProgramParameter(this._shader._program,t.ACTIVE_UNIFORMS),i=0;i<e;++i){var n=t.getActiveUniform(this._shader._program,i),r=n.name,s=t.getUniformLocation(this._shader._program,r);this._uniforms[r]={type:n.type,location:s,size:n.size}}},createUniformBufferFromShader:function(t){for(var e=B.gl,i=this.getUniformBufferSlot(t),n=this._shader._program,r=e.getActiveUniformBlockParameter(n,i.blockIndex,e.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),s=e.getActiveUniformBlockParameter(n,i.blockIndex,e.UNIFORM_BLOCK_DATA_SIZE),o=new Qt(s),a=e.getActiveUniforms(n,r,e.UNIFORM_OFFSET),h=0;h<r.length;++h){var _=e.getActiveUniform(this._shader._program,r[h]);o.registerUniform(_.name,a[h],_.size,_.type)}return o.uploadData(new Float32Array(s/4)),o},getTextureSlot:function(t){if(!this._uniforms.hasOwnProperty(t))return null;var e=B.gl;e.useProgram(this._shader._program);var i=this._uniforms[t];if(i){for(var n=i.location,r=null,s=this._textureSlots.length,o=0;o<s;++o)if(this._textureSlots[o].location===n){r=this._textureSlots[o];break}if(!r){for(var a=new Int32Array(i.size),h=0;h<i.size;++h)(r=new Wt).index=o,r.name=t,this._textureSlots.push(r),r.location=n,a[h]=o+h;1===i.size?e.uniform1i(n,o):e.uniform1iv(n,a)}return r}},getUniformBufferSlot:function(t){var e=B.gl;e.useProgram(this._shader._program);var i=B.gl.getUniformBlockIndex(this._shader._program,t);if(!(1e3<i)){for(var n=null,r=this._uniformBufferSlots.length,s=0;s<r;++s)if(this._uniformBufferSlots[s].blockIndex===i){n=this._uniformBufferSlots[s];break}return n||((n=new Zt).bindingPoint=s,n.name=t,this._uniformBufferSlots.push(n),n.blockIndex=i,e.uniformBlockBinding(this._shader._program,n.blockIndex,n.bindingPoint)),n}},setTexture:function(t,e){var i=this.getTextureSlot(t);i&&(i.texture=e)},setUniformBuffer:function(t,e){var i=this.getUniformBufferSlot(t);i&&(i.buffer=e)},setTextureArray:function(t,e){var i=this.getTextureSlot(t+"[0]"),n=i.location;if(i)for(var r=e.length,s=0;s<r;++s){var o=this._textureSlots[i.index+s];if(!o||o.location!==n)return;o.texture=e[s]}},getUniformLocation:function(t){if(this._uniforms.hasOwnProperty(t))return this._uniforms[t].location},getAttributeLocation:function(t){return this._shader.getAttributeLocation(t)},setUniformStructArray:function(t,e){for(var i=e.length,n=0;n<i;++n){var r=e[n];for(var s in r)r.hasOwnProperty("key")&&this.setUniform(t+"["+n+"]."+s,e)}},setUniformArray:function(t,e){if(t+="[0]",this._uniforms.hasOwnProperty(t)){var i=this._uniforms[t],n=B.gl;switch(n.useProgram(this._shader._program),i.type){case n.FLOAT:n.uniform1fv(i.location,e);break;case n.FLOAT_VEC2:n.uniform2fv(i.location,e);break;case n.FLOAT_VEC3:n.uniform3fv(i.location,e);break;case n.FLOAT_VEC4:n.uniform4fv(i.location,e);break;case n.FLOAT_MAT4:n.uniformMatrix4fv(i.location,!1,e);break;case n.INT:n.uniform1iv(i.location,e);break;case n.INT_VEC2:n.uniform2iv(i.location,e);break;case n.INT_VEC3:n.uniform3iv(i.location,e);break;case n.INT_VEC4:n.uniform1iv(i.location,e);break;case n.BOOL:n.uniform1bv(i.location,e);break;case n.BOOL_VEC2:n.uniform2bv(i.location,e);break;case n.BOOL_VEC3:n.uniform3bv(i.location,e);break;case n.BOOL_VEC4:n.uniform4bv(i.location,e);break;default:throw new Error("Unsupported uniform format for setting ("+i.type+") for uniform '"+t+"'. May be a todo.")}}},setUniform:function(t,e){if(this._uniforms.hasOwnProperty(t)){var i=this._uniforms[t],n=B.gl;switch(n.useProgram(this._shader._program),i.type){case n.FLOAT:n.uniform1f(i.location,e);break;case n.FLOAT_VEC2:n.uniform2f(i.location,e.x||e[0]||0,e.y||e[1]||0);break;case n.FLOAT_VEC3:n.uniform3f(i.location,e.x||e.r||e[0]||0,e.y||e.g||e[1]||0,e.z||e.b||e[2]||0);break;case n.FLOAT_VEC4:n.uniform4f(i.location,e.x||e.r||e[0]||0,e.y||e.g||e[1]||0,e.z||e.b||e[2]||0,e.w||e.a||e[3]||0);break;case n.INT:n.uniform1i(i.location,e);break;case n.INT_VEC2:n.uniform2i(i.location,e.x||e[0],e.y||e[1]);break;case n.INT_VEC3:n.uniform3i(i.location,e.x||e[0],e.y||e[1],e.z||e[2]);break;case n.INT_VEC4:n.uniform4i(i.location,e.x||e[0],e.y||e[1],e.z||e[2],e.w||e[3]);break;case n.BOOL:n.uniform1i(i.location,e);break;case n.BOOL_VEC2:n.uniform2i(i.location,e.x||e[0],e.y||e[1]);break;case n.BOOL_VEC3:n.uniform3i(i.location,e.x||e[0],e.y||e[1],e.z||e[2]);break;case n.BOOL_VEC4:n.uniform4i(i.location,e.x||e[0],e.y||e[1],e.z||e[2],e.w||e[3]);break;case n.FLOAT_MAT4:n.uniformMatrix4fv(i.location,!1,e._m);break;default:throw new Error("Unsupported uniform format for setting. May be a todo.")}}}}),OPTIONS:null,TARGET_CANVAS:null},ee=new n,ie=new n,ne=0,re=new e;re.onTick.bind(function(t){var e=(performance||Date).now();ee.dispatch(t),o.numDrawCalls=0,o.numTriangles=0,o.numClears=0,ie.dispatch(t),ne=(performance||Date).now()-e});var se,oe,ae,he,_e,le,ue,ce,de,fe,pe,me,ge,xe,ve,ye,Te={COPY_SHADER:null,DEFAULT_2D_DITHER_TEXTURE:null,DEFAULT_SKINNING_TEXTURE:null},Se={WEBGL_2:!1,EXT_DRAW_BUFFERS:null,EXT_FLOAT_TEXTURES:null,EXT_HALF_FLOAT_TEXTURES:null,EXT_FLOAT_TEXTURES_LINEAR:null,EXT_HALF_FLOAT_TEXTURES_LINEAR:null,EXT_DEPTH_TEXTURE:null,EXT_STANDARD_DERIVATIVES:null,EXT_SHADER_TEXTURE_LOD:null,EXT_TEXTURE_FILTER_ANISOTROPIC:null,EXT_ELEMENT_INDEX_UINT:null,EXT_COLOR_BUFFER_FLOAT:null,EXT_COLOR_BUFFER_HALF_FLOAT:null,DEFAULT_TEXTURE_MAX_ANISOTROPY:0,HDR_FORMAT:0},Ee={},we={},Ae={NONE:null,BACK:1029,FRONT:1028,ALL:1032},Pe={},Me={},Le={},Re={},be={},Ie={},Ne={getDefaultInternalFormat:function(t,e){if(!Se.WEBGL_2)return t;if(e===De.FLOAT){if(t===Ne.RGBA)return B.gl.RGBA32F;if(t===Ne.RGB)return B.gl.RGB32F;if(t===Ne.RG)return B.gl.RG32F}if(e===De.HALF_FLOAT){if(t===Ne.RGBA)return B.gl.RGBA16F;if(t===Ne.RGB)return B.gl.RGB16F;if(t===Ne.RG)return B.gl.RG16F}return t}},De={},Oe={},Ce={};function Fe(){this.webgl2=!1,this.maxSkeletonJoints=64,this.maxDirLights=3,this.maxPointSpotLights=20,this.numLightingCellsX=16,this.numLightingCellsY=9,this.maxLightProbes=1,this.ambientOcclusion=null,this.useSkinningTexture=!0,this.hdr=!1,this.useGammaCorrection=!0,this.usePreciseGammaCorrection=!1,this.defaultLightingModel=S.Unlit,this.numShadowCascades=1,this.debug=!1,this.throwOnShaderError=!1,this.shadowFilter=new v,this.transparentBackground=!1}function Ue(){re.start()}function Be(){re.stop()}function Xe(t){var e=new Dt;return e.initEmpty(8,8,null,t),new Ft(e).init(!0)}function He(t){this._amplitude=1/Math.sqrt(2*t*Math.PI),this._expScale=-1/(2*t)}function ze(){this.origin=new O(0,0,0,1),this.direction=new O(0,0,0,0)}function Ve(){this._flip=!1,this._mesh=null,this._mode=0,this._faceNormals=null,this._faceTangents=null,this._faceBitangents=null}function ke(t){Lt.call(this),t=t||{},this._createMesh(t),this.bounds=this._getBounds()}function Ge(t){ke.call(this,t)}function Ye(t,e){$t.call(this,this._generateShader(t,e))}function je(t,e){$t.call(this,this._generateShader(t,e))}function We(t,e,i){$t.call(this,this._generateShader(t,e,i)),this._colorLocation=this.getUniformLocation("hx_directionalLight.color"),this._dirLocation=this.getUniformLocation("hx_directionalLight.direction"),this._castShadowsLocation=this.getUniformLocation("hx_directionalLight.castShadows"),this._shadowMatricesLocation=this.getUniformLocation("hx_directionalLight.shadowMapMatrices[0]"),this._shadowSplitsLocation=this.getUniformLocation("hx_directionalLight.splitDistances"),this._depthBiasLocation=this.getUniformLocation("hx_directionalLight.depthBias"),this._maxShadowDistanceLocation=this.getUniformLocation("hx_directionalLight.maxShadowDistance")}function Ze(t,e,i){$t.call(this,this._generateShader(t,e,i))}function qe(t,e){$t.call(this,this._generateShader(t,e))}function Ke(){C.call(this),this.meta={},this._name="",this._matrixInvalid=!0,this._worldMatrix=new F,this._worldMatrixInvalid=!0,this._parent=null,this._scene=null,this._visible=!0,this._ancestorsVisible=!0,this._raycast=!0,this._children=[],this._renderOrderHint=0}function Je(){this._hash=[]}function Qe(t,e){var i=e.getShader();this.attributes=[],this.morphPositionAttributes=[],this.morphNormalAttributes=[],this._numAttributes=-1;for(var n=0;n<t.numVertexAttributes;++n){var r=t.getVertexAttributeByIndex(n),s=i.getAttributeLocation(r.name);if(0<=s){var o=t.getVertexStride(r.streamIndex),a={index:s,offset:4*r.offset,external:!1,numComponents:r.numComponents,stride:4*o,streamIndex:r.streamIndex};0===r.name.indexOf("hx_morphPosition")&&(this.morphPositionAttributes.push(a),a.external=!0),0===r.name.indexOf("hx_morphNormal")&&(this.morphNormalAttributes.push(a),a.external=!0),this.attributes[s]=a,this._numAttributes=Math.max(this._numAttributes,s+1)}}}function $e(){this._entity=null,this._enabled=!0,this._bounds=null,this._boundsInvalid=!0}function ti(t,e){$e.call(this),this._bounds=new At,this._morphPositions=null,this._morphNormals=null,this._morphWeights=null,this._meshMaterialLinkInvalid=!0,this._vertexLayouts=null,this._castShadows=!0,this._skeletonPose=null,this._morphPose=null,this.mesh=t,this.material=e}function ei(t){if(Ke.call(this),this._componentHash=new Je,this._components=[],this._requiresUpdates=!1,this._onComponentsChange=new n,this._boundsInvalid=!0,this._worldBoundsInvalid=!0,this._worldBounds=this._createBoundingVolume(),this._bounds=this._createBoundingVolume(),t instanceof Array)for(var e=0;e<t.length;++e)this.addComponent(t[e]);else t&&this.addComponent(t)}function ii(){$e.call(this),this._scaledIrradiance=new h,this._intensity=.2,this._color=new h(1,1,1),this._colorChangeListener=new D,this._colorChangeListener.add(this._color,"r"),this._colorChangeListener.add(this._color,"g"),this._colorChangeListener.add(this._color,"b"),this._colorChangeListener.onChange.bind(this._updateScaledIrradiance,this),this._scaledIrradiance=new h,this._updateScaledIrradiance()}function ni(){ii.call(this),this.intensity=3.1415,this.depthBias=0,this._castShadows=!1,this.shadowQualityBias=0}function ri(){ni.call(this),this._direction=new O,this._cascadeSplitRatios=[],this._cascadeSplitDistances=[],this._initCascadeSplitProperties(),this._bounds=new At}function si(){Et.call(this,si)}function oi(){ni.call(this),this._radius=100,this.intensity=3.1415,this.shadowQualityBias=2,this._shadowTiles=null,this._bounds=new si}function ai(t,e){$e.call(this),this._specularTexture=e,this._diffuseTexture=t,this._size=void 0,this._bounds=new At,this._bounds.clear(Et.EXPANSE_INFINITE)}function hi(){ni.call(this),this._radius=50,this._innerAngle=1.2,this._outerAngle=1.3,this._cosInner=Math.cos(.5*this._innerAngle),this._cosOuter=Math.cos(.5*this._outerAngle),this.intensity=3.1415,this.shadowQualityBias=1,this._shadowMatrix=null,this._shadowTile=null,this._bounds=new si}function _i(t,e,i,n){this._dirLights=null,this._pointLights=null,this._spotLights=null,this._diffuseLightProbes=null,this._specularLightProbes=null,$t.call(this,this._generateShader(t,e,i,n)),this._getUniformLocations(),this._assignLightProbes()}function li(t,e,i){$t.call(this,this._generateShader(t,e,i)),this._colorLocation=this.getUniformLocation("hx_pointLight.color"),this._posLocation=this.getUniformLocation("hx_pointLight.position"),this._radiusLocation=this.getUniformLocation("hx_pointLight.radius"),this._rcpRadiusLocation=this.getUniformLocation("hx_pointLight.rcpRadius"),this._castShadowsLocation=this.getUniformLocation("hx_pointLight.castShadows"),this._depthBiasLocation=this.getUniformLocation("hx_pointLight.depthBias"),this._shadowMatrixLocation=this.getUniformLocation("hx_pointLight.shadowMapMatrix"),this._shadowTilesLocation=this.getUniformLocation("hx_pointLight.shadowTiles[0]")}function ui(t,e,i){$t.call(this,this._generateShader(t,e,i)),this._diffuseSlot=this.getTextureSlot("hx_diffuseProbeMap"),this._specularSlot=this.getTextureSlot("hx_specularProbeMap"),this._numMipsLocation=this.getUniformLocation("hx_specularProbeNumMips"),this._localLocation=this.getUniformLocation("hx_probeLocal"),this._sizeLocation=this.getUniformLocation("hx_probeSize"),this._positionLocation=this.getUniformLocation("hx_probePosition")}function ci(t,e,i){$t.call(this,this._generateShader(t,e,i)),this._colorLocation=this.getUniformLocation("hx_spotLight.color"),this._posLocation=this.getUniformLocation("hx_spotLight.position"),this._radiusLocation=this.getUniformLocation("hx_spotLight.radius"),this._anglesLocation=this.getUniformLocation("hx_spotLight.angleData"),this._dirLocation=this.getUniformLocation("hx_spotLight.direction"),this._rcpRadiusLocation=this.getUniformLocation("hx_spotLight.rcpRadius"),this._castShadowsLocation=this.getUniformLocation("hx_spotLight.castShadows"),this._depthBiasLocation=this.getUniformLocation("hx_spotLight.depthBias"),this._shadowMatrixLocation=this.getUniformLocation("hx_spotLight.shadowMapMatrix"),this._shadowTileLocation=this.getUniformLocation("hx_spotLight.shadowTile")}function di(t,e){$t.call(this,this._generateShader(t,e))}He.prototype={getValueAt:function(t){return this._amplitude*Math.pow(Math.E,t*t*this._expScale)}},He.fromRadius=function(t,e){e=e||.01;var i=t/Math.sqrt(-2*Math.log(e));return new He(i*i)},ze.prototype={transformFrom:function(t,e){e.transformPoint(t.origin,this.origin),e.transformVector(t.direction,this.direction),this.direction.normalize()},toString:function(){return"Ray(\norigin: "+this.origin.toString()+"\ndirection: "+this.direction.toString()+"\n)"}},Ve.MODE_NORMALS=1,Ve.MODE_TANGENTS=2,Ve.prototype={generate:function(t,e,i,n){void 0===i&&(i=!0),this._mode=void 0===e?Ve.MODE_NORMALS|Ve.MODE_TANGENTS:e,this._flip=n||!1,this._mesh=t,this._positionAttrib=t.getVertexAttributeByName("hx_position"),this._normalAttrib=t.getVertexAttributeByName("hx_normal"),this._tangentAttrib=t.getVertexAttributeByName("hx_tangent"),this._uvAttrib=t.getVertexAttributeByName("hx_texCoord"),this._positionStride=t.getVertexStride(this._positionAttrib.streamIndex),this._normalStride=t.getVertexStride(this._normalAttrib.streamIndex),this._tangentStride=t.getVertexStride(this._tangentAttrib.streamIndex),this._uvStride=t.getVertexStride(this._uvAttrib.streamIndex),this._calculateFaceVectors(i),this._calculateVertexVectors()},_calculateFaceVectors:function(t){var e=this._mesh._indexData.length;0!=(this._mode&Ve.MODE_NORMALS)&&(this._faceNormals=new Array(e)),0!=(this._mode&Ve.MODE_TANGENTS)&&(this._faceTangents=new Array(e),this._faceBitangents=new Array(e));for(var i=new O,n=new O,r=new O,s=new O,o=new O,a=new O,h=new w,_=new w,l=new w,u=new w,c=new w,d=this._positionAttrib.offset,f=this._uvAttrib.offset,p=this._mesh.getVertexData(this._positionAttrib.streamIndex),m=this._mesh.getVertexData(this._uvAttrib.streamIndex),g=0;g<e;g+=3)this._getFloat3At(g,d,this._positionStride,s,p),this._getFloat3At(g+1,d,this._positionStride,o,p),this._getFloat3At(g+2,d,this._positionStride,a,p),this._getFloat2At(g,f,this._uvStride,h,m),this._getFloat2At(g+1,f,this._uvStride,_,m),this._getFloat2At(g+2,f,this._uvStride,l,m),o.subtract(s),a.subtract(s),this._faceNormals&&(this._flip?O.cross(a,o,i):O.cross(o,a,i),t||i.normalize(),this._faceNormals[g]=i.x,this._faceNormals[g+1]=i.y,this._faceNormals[g+2]=i.z),this._faceTangents&&(w.subtract(_,h,u),w.subtract(l,h,c),O.scale(o,c.y,n),O.scale(a,u.y,r),O.subtract(n,r,i),.001<i.lengthSqr&&i.normalize(),this._faceTangents[g]=i.x,this._faceTangents[g+1]=i.y,this._faceTangents[g+2]=i.z,O.scale(o,c.x,n),O.scale(a,u.x,n),O.subtract(r,n,i),this._faceBitangents[g]=i.x,this._faceBitangents[g+1]=i.y,this._faceBitangents[g+2]=i.z)},_calculateVertexVectors:function(){this._zeroVectors();for(var t=this._faceTangents?[]:null,e=this._mesh._indexData,i=this._normalAttrib.offset,n=this._tangentAttrib.offset,r=this._mesh.getVertexData(this._normalAttrib.streamIndex),s=this._mesh.getVertexData(this._tangentAttrib.streamIndex),o=e.length,a=0;a<o;++a){var h=e[a],_=i+h*this._normalStride,l=n+h*this._tangentStride,u=3*h,c=3*Math.floor(a/3);this._faceNormals&&(r[_]+=this._faceNormals[c],r[_+1]+=this._faceNormals[c+1],r[_+2]+=this._faceNormals[c+2]),this._faceTangents&&(s[l]+=this._faceTangents[c],s[l+1]+=this._faceTangents[c+1],s[l+2]+=this._faceTangents[c+2],t[u]+=this._faceBitangents[c],t[u+1]+=this._faceBitangents[c+1],t[u+2]+=this._faceBitangents[c+2])}this._normalize(t)},_zeroVectors:function(){for(var t=this._mesh.getVertexData(this._normalAttrib.streamIndex),e=this._mesh.getVertexData(this._tangentAttrib.streamIndex),i=this._mesh.getVertexStride(this._normalAttrib.streamIndex),n=this._mesh.getVertexStride(this._tangentAttrib.streamIndex),r=t.length/i,s=this._normalAttrib.offset,o=this._tangentAttrib.offset,a=0;a<r;++a)this._mode&Ve.MODE_NORMALS&&(t[s]=0,t[s+1]=0,t[s+2]=0),this._mode&Ve.MODE_TANGENTS&&(e[o]=0,e[o+1]=0,e[o+2]=0),s+=i,o+=n},_normalize:function(t){for(var e=this._mesh.getVertexData(this._normalAttrib.streamIndex),i=this._mesh.getVertexData(this._tangentAttrib.streamIndex),n=e.length/this._normalStride,r=this._normalAttrib.offset,s=this._tangentAttrib.offset,o=new O,a=new O,h=new O,_=new O,l=0;l<n;++l)o.x=e[r],o.y=e[r+1],o.z=e[r+2],this._mode&Ve.MODE_NORMALS&&(o.normalize(),e[r]=o.x,e[r+1]=o.y,e[r+2]=o.z),this._mode&Ve.MODE_TANGENTS&&(a.x=i[s],a.y=i[s+1],a.z=i[s+2],a.lengthSqr<1e-4?a.set(1,1,1,1):a.normalize(),h.x=t[0],h.y=t[1],h.z=t[2],O.cross(o,a,_),i[s]=a.x,i[s+1]=a.y,i[s+2]=a.z,i[s+3]=0<h.dot3(_)?-1:1),r+=this._normalStride,s+=this._tangentStride;this._mesh.setVertexData(e,this._normalAttrib.streamIndex),this._normalAttrib.streamIndex!==this._tangentAttrib.streamIndex&&this._mesh.setVertexData(i,this._tangentAttrib.streamIndex)},_getFloat3At:function(t,e,i,n,r){var s=e+this._mesh._indexData[t]*i;n.x=r[s],n.y=r[s+1],n.z=r[s+2]},_getFloat2At:function(t,e,i,n,r){var s=e+this._mesh._indexData[t]*i;n.x=r[s],n.y=r[s+1]}},ke._ATTRIBS=function(){this.positions=[],this.uvs=null,this.normals=null,this.vertexColors=null,this.indices=[]},(ke.prototype=Object.create(Lt.prototype))._generate=function(t,e){throw new Error("Abstract method called!")},ke.prototype._createMesh=function(t){var e=new ke._ATTRIBS,i=void 0===t.uvs||t.uvs,n=void 0===t.normals||t.normals,r=void 0===t.tangents||t.tangents;this.addVertexAttribute("hx_position",3),n&&(this.addVertexAttribute("hx_normal",3),e.normals=[]),r&&this.addVertexAttribute("hx_tangent",4),i&&(this.addVertexAttribute("hx_texCoord",2),e.uvs=[]),this._generate(e,t);var s=e.vertexColors;s&&this.addVertexAttribute("hx_vertexColor",3);for(var o=t.scaleU||1,a=t.scaleV||1,h=e.positions.length/3,_=0,l=0,u=0,c=[],d=0;d<h;++d)c[_++]=e.positions[u],c[_++]=e.positions[u+1],c[_++]=e.positions[u+2],n&&(c[_++]=e.normals[u],c[_++]=e.normals[u+1],c[_++]=e.normals[u+2]),r&&(_+=4),i&&(c[_++]=e.uvs[l++]*o,c[_++]=e.uvs[l++]*a),s&&(c[_++]=e.vertexColors[u],c[_++]=e.vertexColors[u+1],c[_++]=e.vertexColors[u+2]),u+=3;this.setVertexData(c,0),this.setIndexData(e.indices);var f=0;(n&&0===e.normals.length&&(f|=Ve.MODE_NORMALS),r&&(f|=Ve.MODE_TANGENTS),f)&&(new Ve).generate(this,f)},ke.prototype._getBounds=function(){return new At},Ge.prototype=Object.create(ke.prototype),Ge.ALIGN_X=1,Ge.ALIGN_Y=2,Ge.ALIGN_Z=3,Ge.prototype._generate=function(t,e){var i,n,r,s,o,a=(e=e||{}).alignment||Ge.ALIGN_Z,h=e.numSegmentsH||1,_=e.numSegmentsW||16,l=e.radius||.5,u=e.height||1,c=void 0!==e.doubleSided&&e.doubleSided,d=t.positions,f=t.uvs,p=t.normals,m=t.indices,g=1/_,x=1/h;for(i=0;i<=h;++i){var v=(i*x-.5)*u;for(n=0;n<=_;++n){o=n*g*Math.PI*2;var y=Math.sin(o),T=Math.cos(o);switch(r=y*l,s=T*l,a){case Ge.ALIGN_X:d.push(-v,r,s),p&&p.push(0,y,T);break;case Ge.ALIGN_Z:d.push(r,s,-v),p&&p.push(y,T,0);break;default:d.push(r,v,s),p&&p.push(y,0,T)}f&&f.push(1-n*g,i*x)}}for(i=0;i<h;++i)for(n=0;n<_;++n){var S=_+1,E=n+i*S;m.push(E,E+S+1,E+S),m.push(E,E+1,E+S+1),c&&(m.push(E,E+S,E+S+1),m.push(E,E+S+1,E+1))}var w=d.length/3,A=.5*u;for(n=0;n<_;++n){o=n*g*Math.PI*2;var P=Math.sin(o),M=Math.cos(o);switch(r=P*l,s=M*l,P=.5*-P+.5,M=.5*M+.5,a){case Ge.ALIGN_X:d.push(A,r,s),d.push(-A,r,s),p&&(p.push(1,0,0),p.push(-1,0,0)),f&&(f.push(M,1-P),f.push(1-M,1-P));break;case Ge.ALIGN_Z:d.push(r,s,A),d.push(r,s,-A),p&&(p.push(0,0,1),p.push(0,0,-1)),f&&(f.push(P,M),f.push(1-P,M));break;default:d.push(r,-A,s),d.push(r,A,s),p&&(p.push(0,-1,0),p.push(0,1,0)),f&&(f.push(P,M),f.push(P,1-M))}}for(n=1;n<_-1;++n){var L=n<<1;m.push(w,w+L+2,w+L),m.push(w+1,w+L+1,w+L+3)}},(Ye.prototype=Object.create($t.prototype))._generateShader=function(t,e){var i="#define HX_SKIP_NORMALS\n#define HX_SKIP_SPECULAR\n",n=i+d.get("snippets_geometry.glsl")+"\n"+e+"\n"+d.get("material_unlit_fragment.glsl");return new gt(i+t+"\n"+d.get("material_unlit_vertex.glsl"),n)},(je.prototype=Object.create($t.prototype))._generateShader=function(t,e){var i="#define HX_SKIP_NORMALS\n#define HX_SKIP_SPECULAR\n",n=i+d.get("snippets_geometry.glsl")+"\n"+te.OPTIONS.shadowFilter.getGLSL()+"\n"+e+"\n"+d.get("material_dir_shadow_fragment.glsl");return new gt(i+t+"\n"+d.get("material_unlit_vertex.glsl"),n)},(We.prototype=Object.create($t.prototype)).updatePassRenderState=(se=new O,oe=new F,ae=new Float32Array(64),function(t,e,i){var n=B.gl,r=i._scaledIrradiance;if(n.useProgram(this._shader._program),t.viewMatrix.transformVector(i.direction,se),n.uniform3f(this._colorLocation,r.r,r.g,r.b),n.uniform3f(this._dirLocation,se.x,se.y,se.z),n.uniform1i(this._castShadowsLocation,i.castShadows?1:0),i.castShadows){for(var s=te.OPTIONS.numShadowCascades,o=i._cascadeSplitDistances,a=0,h=0;h<s;++h){oe.multiply(i.getShadowMatrix(h),t.worldMatrix);for(var _=oe._m,l=0;l<16;++l)ae[a++]=_[l]}n.uniformMatrix4fv(this._shadowMatricesLocation,!1,ae),n.uniform4f(this._shadowSplitsLocation,o[0],o[1],o[2],o[3]),n.uniform1f(this._depthBiasLocation,i.depthBias),n.uniform1f(this._maxShadowDistanceLocation,o[s-1])}$t.prototype.updatePassRenderState.call(this,t,e)}),We.prototype._generateShader=function(t,e,i,n){var r={};return new gt(t+"\n"+d.get("material_fwd_dir_vertex.glsl",r),d.get("snippets_geometry.glsl",r)+"\n"+i+"\n\n\n"+te.OPTIONS.shadowFilter.getGLSL()+"\n"+d.get("directional_light.glsl")+"\n"+e+"\n"+d.get("material_fwd_dir_fragment.glsl"))},(Ze.prototype=Object.create($t.prototype))._generateShader=function(t,e,i){var n="#derivatives\n",r={HX_NUM_DIR_LIGHTS:te.OPTIONS.maxDirLights,HX_NUM_POINT_SPOT_LIGHTS:te.OPTIONS.maxPointSpotLights,HX_NUM_LIGHT_PROBES:te.OPTIONS.maxLightProbes,HX_CELL_STRIDE:te.OPTIONS.maxPointSpotLights+1,HX_NUM_CELLS_X:te.OPTIONS.numLightingCellsX,HX_NUM_CELLS_Y:te.OPTIONS.numLightingCellsY,HX_CELL_ARRAY_LEN:Math.ceil(te.OPTIONS.numLightingCellsX*te.OPTIONS.numLightingCellsY*(te.OPTIONS.maxPointSpotLights+1)/4)};return Se.EXT_SHADER_TEXTURE_LOD&&(n+="#texturelod\n"),new gt(t+"\n"+d.get("material_fwd_clustered_vertex.glsl",r),n+d.get("snippets_geometry.glsl")+"\n"+i+"\n\n\n"+te.OPTIONS.shadowFilter.getGLSL()+"\n"+d.get("directional_light.glsl",r)+"\n"+d.get("point_light.glsl")+"\n"+d.get("spot_light.glsl")+"\n"+d.get("light_probe.glsl")+"\n"+e+"\n"+d.get("material_fwd_clustered_fragment.glsl"))},(qe.prototype=Object.create($t.prototype))._generateShader=function(t,e){var i="#define HX_SKIP_NORMALS\n#define HX_SKIP_SPECULAR\n",n=i+d.get("snippets_geometry.glsl")+"\n"+e+"\n"+d.get("material_fwd_base_fragment.glsl");return new gt(i+t+"\n"+d.get("material_fwd_base_vertex.glsl"),n)},(Ke.prototype=Object.create(C.prototype,{name:{get:function(){return this._name},set:function(t){this._name=t}},parent:{get:function(){return this._parent}},numChildren:{get:function(){return this._children.length}},visible:{get:function(){return this._visible},set:function(t){this._visible=t;for(var e=0,i=this._children.length;e<i;++e)this._children[e]._updateAncestorsVisible(t&&this._ancestorsVisible)}},hierarchyVisible:{get:function(){return this._visible&&this._ancestorsVisible}},raycast:{get:function(){return this._raycast},set:function(t){this._raycast=t}},worldMatrix:{get:function(){return this._worldMatrixInvalid&&this._updateWorldMatrix(),this._worldMatrix}}})).attach=function(t){if(t instanceof Array)for(var e=t.length,i=0;i<e;++i)this.attach(t[i]);else t._parent&&t._parent.detach(t),t._parent=this,t._setScene(this._scene),t._updateAncestorsVisible(this._visible&&this._ancestorsVisible),this._children.push(t)},Ke.prototype.attachAfter=function(t,e){if(e._parent!==this)throw new Error("Reference child not a child of the scene node");t._parent&&t._parent.detach(t),t._parent=this,t._setScene(this._scene);var i=this._children.indexOf(e);this._children.splice(i+1,0,t)},Ke.prototype.isContainedIn=function(t){for(var e=this._parent;e;){if(e===t)return!0;e=e._parent}return!1},Ke.prototype.contains=function(t){if(0<=this._children.indexOf(t))return!0;for(var e=this._children.length,i=0;i<e;++i)if(this._children[i].contains(t))return!0;return!1},Ke.prototype.detach=function(t){var e=this._children.indexOf(t);if(e<0)throw new Error("Trying to remove a scene object that is not a child");t._parent=null,t._updateAncestorsVisible(!0),this._children.splice(e,1)},Ke.prototype.getChild=function(t){return this._children[t]},Ke.prototype.getChildIndex=function(t){return this._children.indexOf(t)},Ke.prototype.destroy=function(){for(this._parent&&this._parent.detach(this);this._children.length;)this._children[0].destroy()},Ke.prototype._applyMatrix=function(){C.prototype._applyMatrix.call(this),this._invalidateWorldMatrix()},Ke.prototype.findNodeByName=function(t){if(this._name===t)return this;for(var e=this._children.length,i=0;i<e;++i){var n=this._children[i].findNodeByName(t);if(n)return n}},Ke.prototype.findMaterialByName=function(t){for(var e=0,i=this._children.length;e<i;++e){var n=this._children[e].findMaterialByName(t);if(n)return n}},Ke.prototype._setScene=function(t){this._scene=t;for(var e=this._children.length,i=0;i<e;++i)this._children[i]._setScene(t)},Ke.prototype._invalidateMatrix=function(){C.prototype._invalidateMatrix.call(this),this._invalidateWorldMatrix()},Ke.prototype._invalidateWorldMatrix=function(){this._worldMatrixInvalid=!0;for(var t=this._children.length,e=0;e<t;++e)this._children[e]._invalidateWorldMatrix()},Ke.prototype._updateWorldMatrix=function(){this._parent?this._worldMatrix.multiply(this._parent.worldMatrix,this.matrix):this._worldMatrix.copyFrom(this.matrix),this._worldMatrixInvalid=!1},Ke.prototype.toString=function(){return"[SceneNode(name="+this._name+")]"},Ke.prototype.applyFunction=function(t,e){e?t.call(e,this):t(this);for(var i=this._children.length,n=0;n<i;++n)this._children[n].applyFunction(t,e)},Ke.prototype._updateAncestorsVisible=function(t){this._ancestorsVisible=t;for(var e=0,i=this._children.length;e<i;++e)this._children[e]._updateAncestorsVisible(t)},Ke.prototype.copyTo=function(t){C.prototype.copyTo.call(this,t),t.name=this.name,t.visible=this.visible,t.raycast=this.raycast;for(var e=0,i=this._children.length;e<i;++e)t.attach(this._children[e].clone())},Ke.prototype.clone=function(){var t=new Ke;return this.copyTo(t),t},Je.prototype={isBitSet:function(t){var e=t>>5;return t&=~(e<<5),this._hash[e]&1<<t},setBit:function(t){var e=this._hash,i=t>>5;t&=~(i<<5),e[i]=(e[i]||0)|1<<t},clearBit:function(t){var e=this._hash,i=t>>5;t&=~(i<<5),e[i]=(e[i]||0)&~(1<<t)},zero:function(){for(var t=this._hash,e=t.length,i=0;i<e;++i)t[i]=0},OR:function(t){var e=this._hash;t=t._hash;for(var i=Math.max(e.length,t.length),n=0;n<i;++n)e[n]=(e[n]||0)|(t[n]||0)},AND:function(t){var e=this._hash;t=t._hash;for(var i=Math.max(e.length,t.length),n=0;n<i;++n)e[n]=(e[n]||0)&(t[n]||0)},NOT:function(){for(var t=this._hash,e=t.length,i=0;i<e;++i)t[i]=~(t[i]||0)},contains:function(t){for(var e=this._hash,i=t._hash,n=i.length,r=0;r<n;++r){var s=i[r];if((e[r]&s)!==s)return!1}return!0},clone:function(){for(var t=new Je,e=this._hash.length,i=0;i<e;++i)t._hash[i]=this._hash[i];return t},toString:function(){var t="",e=this._hash,i=e.length;if(0===i)return"0b0";for(var n=0;n<i;++n){for(var r=(e[n]||0).toString(2);r.length<32;)r="0"+r;t=r+t}return"0b"+t}},$e.COMPONENT_ID=0,$e.create=(he=0,function(t,e,i){i=i||$e,t.prototype=Object.create(i.prototype,e),t.COMPONENT_ID=++he,t.prototype.COMPONENT_ID=t.COMPONENT_ID}),$e.prototype={get bounds(){return this._boundsInvalid&&(this._bounds&&this._updateBounds(),this._boundsInvalid=!1),this._bounds},onAdded:function(){},onRemoved:function(){},onUpdate:null,get entity(){return this._entity},get enabled(){return this._enabled},set enabled(t){this._entity&&(t?this.onAdded():this.onRemoved()),this._enabled=t},acceptVisitor:null,_updateBounds:function(){},_invalidateBounds:function(){this._boundsInvalid=!0,this._entity&&this._entity._invalidateBounds()},clone:function(){throw new Error("Abstract method called!")}},$e.create(ti,{castShadows:{get:function(){return this._castShadows},set:function(t){this._castShadows=t}},skeleton:{get:function(){return this._mesh.skeleton}},skeletonMatrices:{get:function(){return this._skeletonPose?this._skeletonPose.getBindMatrices(this._mesh._skeleton):null}},skeletonPose:{get:function(){return this._skeletonPose},set:function(t){this._skeletonPose=t}},morphPose:{get:function(){return this._morphPose},set:function(t){this._morphPose&&this._morphPose.onChange.unbind(this._onMorphChanged),this._morphPose=t,this._morphPose?(this._morphPose.onChange.bind(this._onMorphChanged,this),this._onMorphChanged()):this._clearMorph()}},mesh:{get:function(){return this._mesh},set:function(t){this._mesh!==t&&(this._mesh&&(this._mesh.onLayoutChanged.unbind(this._onMaterialOrMeshChange),this._mesh.onBoundsChanged.unbind(this._invalidateBounds),this._mesh.onMorphDataCreated.unbind(this._initMorphData),this._mesh.onSkeletonChange.unbind(this._onSkeletonChange)),(this._mesh=t).onLayoutChanged.bind(this._onMaterialOrMeshChange,this),t.onBoundsChanged.bind(this._invalidateBounds,this),t.onMorphDataCreated.bind(this._initMorphData,this),t.onSkeletonChange.bind(this._onSkeletonChange,this),this._initMorphData(),this._meshMaterialLinkInvalid=!0,this._invalidateBounds())}},material:{get:function(){return this._material},set:function(t){this._material&&this._material.onChange.unbind(this._onMaterialOrMeshChange),this._material=t,this._material&&(this._material.onChange.bind(this._onMaterialOrMeshChange,this),this._material._setUseSkinning(!!this._mesh.skeleton),this._material._setUseMorphing(this._mesh.hasMorphData,this._mesh.hasMorphNormals)),this._meshMaterialLinkInvalid=!0}}}),ti.prototype.updateRenderState=function(t){this._meshMaterialLinkInvalid&&this._linkMeshWithMaterial();var e=this._mesh._vertexBuffers;this._mesh._indexBuffer.bind();for(var i,n=this._vertexLayouts[t],r=n.morphPositionAttributes,s=n.morphNormalAttributes,o=B.gl,a=r.length,h=0;h<a;++h){i=r[h];var _=this._morphPositions[h]||this._mesh._defaultMorphTarget;_.bind(),o.vertexAttribPointer(i.index,i.numComponents,o.FLOAT,!1,i.stride,i.offset)}if(this._morphNormals)for(a=s.length,h=0;h<a;++h)i=s[h],(_=this._morphNormals[h]||this._mesh._defaultMorphTarget).bind(),o.vertexAttribPointer(i.index,i.numComponents,o.FLOAT,!1,i.stride,i.offset);var l=n.attributes;for(a=n._numAttributes,B.enableAttributes(n._numAttributes),h=0;h<a;++h)(i=l[h])?i.external||(e[i.streamIndex].bind(),o.vertexAttribPointer(h,i.numComponents,o.FLOAT,!1,i.stride,i.offset)):B.gl.disableVertexAttribArray(h)},ti.prototype._initVertexLayouts=function(){this._vertexLayouts=new Array($t.NUM_PASS_TYPES);for(var t=0;t<$t.NUM_PASS_TYPES;++t){var e=this._material.getPass(t);e&&(this._vertexLayouts[t]=new Qe(this._mesh,e))}},ti.prototype._linkMeshWithMaterial=function(){this._initVertexLayouts(),this._meshMaterialLinkInvalid=!1},ti.prototype._onMaterialOrMeshChange=function(){this._meshMaterialLinkInvalid=!0},ti.prototype.toString=function(){return"[MeshInstance(mesh="+this._mesh.name+")]"},ti.prototype.acceptVisitor=function(t){t.visitMeshInstance(this,this._entity)},ti.prototype._onMorphChanged=function(){for(var t=0;t<8;++t){var e=this._morphPose.getMorphTargetName(t),i=null;if(e&&(i=this._mesh.getMorphTarget(e)),i){var n=this._morphPose.getWeight(e),r=i.positionBuffer,s=i.hasNormals?i.normalBuffer:null;this._setMorphTarget(t,r,s,n)}else this._setMorphTarget(t,null,null,0)}},ti.prototype._clearMorph=function(){for(var t=0;t<8;++t)this._setMorphTarget(t,null,null,0)},ti.prototype._setMorphTarget=function(t,e,i,n){t>=this._morphWeights.length||(this._morphPositions[t]=e,i&&this._morphNormals&&(this._morphNormals[t]=i),this._morphWeights[t]=e?n:0)},ti.prototype._onSkeletonChange=function(){console.log(this._mesh.skeleton),this._material._setUseSkinning(!!this._mesh.skeleton)},ti.prototype._updateBounds=function(){this._bounds=this._mesh.bounds},ti.prototype._initMorphData=function(){if(this._morphPositions=null,this._morphNormals=null,this._morphWeights=null,this._mesh.hasMorphData){this._morphPositions=[];var t=8;this._mesh.hasMorphNormals&&(this._morphNormals=[],t=4),this._morphWeights=new Float32Array(t);for(var e=0;e<t;++e)this._morphWeights[e]=0;this._material._setUseMorphing(this._mesh.hasMorphData,this._mesh.hasMorphNormals)}},ti.prototype.clone=function(){var t=new ti(this._mesh,this._material);return t.castShadows=this.castShadows,t.skeletonPose=this._skeletonPose.clone(),t},(ei.prototype=Object.create(Ke.prototype,{worldBounds:{get:function(){return this._worldBoundsInvalid&&(this._updateWorldBounds(),this._worldBoundsInvalid=!1),this._worldBounds}},bounds:{get:function(){return this._boundsInvalid&&(this._updateBounds(),this._boundsInvalid=!1),this._bounds}}})).findMaterialByName=function(t){for(var e=0,i=this._components.length;e<i;++e){var n=this._components[e];if(n instanceof ti&&n.material.name===t)return n.material}return Ke.prototype.findMaterialByName.call(this,t)},ei.prototype.addComponent=function(t){if(t._entity)throw new Error("Component already added to an entity!");var e=this._componentHash;this._componentHash=this._componentHash.clone(),this._components.push(t),this._componentHash.setBit(t.COMPONENT_ID),this._requiresUpdates=this._requiresUpdates||!!t.onUpdate,t._entity=this,t.enabled&&t.onAdded(),t.bounds&&this._invalidateBounds(),this._onComponentsChange.dispatch(this,e)},ei.prototype._invalidateWorldMatrix=function(){Ke.prototype._invalidateWorldMatrix.call(this),this._invalidateWorldBounds()},ei.prototype._invalidateBounds=function(){this._boundsInvalid=!0,this._invalidateWorldBounds()},ei.prototype._invalidateWorldBounds=function(){this._worldBoundsInvalid=!0},ei.prototype._updateWorldBounds=function(){this._worldBounds.transformFrom(this.bounds,this.worldMatrix)},ei.prototype._updateBounds=function(){var t=this._components;this._bounds.clear();for(var e=0,i=t.length;e<i;++e){var n=t[e].bounds;n&&this._bounds.growToIncludeBound(n)}},ei.prototype.removeComponent=function(t){var e=!1,i=0,n=[],r=this._componentHash;this._componentHash=new Je;for(var s=0,o=this._components.length;s<o;++s){var a=this._components[s];a!==t&&(n[i++]=a,e=e||!!t.onUpdate,this._componentHash.setBit(a.COMPONENT_ID))}this._requiresUpdates=e,this._onComponentsChange.dispatch(this,r),this._components=n,t._entity=null,t.enabled&&t.onRemoved(),t.bounds&&this._invalidateBounds()},ei.prototype.addComponents=function(t){for(var e=0;e<t.length;++e)this.addComponent(t[e])},ei.prototype.removeComponents=function(t){for(var e=0;e<t.length;++e)this.removeComponent(t[e])},ei.prototype.destroy=function(){Ke.prototype.destroy.call(this),this._components&&this.removeComponents(this._components)},ei.prototype.hasComponentType=function(t){for(var e=0,i=this._components.length;e<i;++e)if(this._components[e]instanceof t)return!0},ei.prototype.getFirstComponentByType=function(t){for(var e=0,i=this._components.length;e<i;++e){var n=this._components[e];if(n instanceof t)return n}return null},ei.prototype.getComponentsByType=function(t){for(var e=[],i=0,n=this._components.length;i<n;++i){var r=this._components[i];r instanceof t&&e.push(r)}return e},ei.prototype.update=function(t){for(var e=this._components,i=0,n=e.length;i<n;++i){var r=e[i];r.enabled&&r.onUpdate&&r.onUpdate(t)}},ei.prototype._setScene=function(t){this._scene&&(this._scene.entityEngine.unregisterEntity(this),this._scene.partitioning.unregisterEntity(this)),t&&(t.entityEngine.registerEntity(this),t.partitioning.registerEntity(this)),Ke.prototype._setScene.call(this,t)},ei.prototype._createBoundingVolume=function(){return new At},ei.prototype.acceptVisitor=function(t){for(var e=this._components,i=0,n=e.length;i<n;++i){var r=e[i];r.acceptVisitor&&r.enabled&&r.acceptVisitor(t)}},ei.prototype._invalidateWorldMatrix=function(){Ke.prototype._invalidateWorldMatrix.call(this),this._invalidateWorldBounds(),this._scene&&this._scene._partitioning.markEntityForUpdate(this)},ei.prototype.copyTo=function(t){Ke.prototype.copyTo.call(this,t);for(var e=0,i=this._components.length;e<i;++e)t.addComponent(this._components[e].clone())},ei.prototype.clone=function(){var t=new ei;return this.copyTo(t),t},(ii.prototype=Object.create($e.prototype,{color:{get:function(){return this._color},set:function(t){this._colorChangeListener.enabled=!1,isNaN(t)?this._color.copyFrom(t):this._color.set(t),this._colorChangeListener.enabled=!0,this._updateScaledIrradiance()}},intensity:{get:function(){return this._intensity},set:function(t){this._intensity=t,this._updateScaledIrradiance()}}})).luminance=function(){return this._color.luminance()*this._intensity},ii.prototype._updateScaledIrradiance=function(){te.OPTIONS.useGammaCorrection?this._color.gammaToLinear(this._scaledIrradiance):this._scaledIrradiance.copyFrom(this._color),this._scaledIrradiance.r*=this._intensity,this._scaledIrradiance.g*=this._intensity,this._scaledIrradiance.b*=this._intensity},ii.prototype.copyTo=function(t){t.color=this.color,t.intensity=this.intensity},(ni.prototype=Object.create(ii.prototype)).acceptVisitor=function(t){t.visitLight(this)},ni.prototype._updateScaledIrradiance=function(){ii.prototype._updateScaledIrradiance.call(this);var t=1/Math.PI;this._scaledIrradiance.r*=t,this._scaledIrradiance.g*=t,this._scaledIrradiance.b*=t},ni.prototype.copyTo=function(t){ii.prototype.copyTo.call(this,t),t.shadowQualityBias=this.shadowQualityBias,t.castShadows=this.castShadows,t.depthBias=this.depthBias},$e.create(ri,{numAtlasPlanes:{get:function(){return te.OPTIONS.numShadowCascades}},castShadows:{get:function(){return this._castShadows},set:function(t){this._castShadows!==t&&(this._castShadows=t,this._shadowMatrices=t&&t?[new F,new F,new F,new F]:null)}},direction:{get:function(){var t=this._direction;return this._entity&&this._entity.worldMatrix.getColumn(1,t),t}},cascadeSplitDistances:{get:function(){return this._cascadeSplitDistances}}},ni),ri.prototype.setCascadeRatios=function(t,e,i,n){this._cascadeSplitRatios[0]=t,this._cascadeSplitRatios[1]=e,this._cascadeSplitRatios[2]=i,this._cascadeSplitRatios[3]=n},ri.prototype._initCascadeSplitProperties=function(){for(var t=1,e=te.OPTIONS.numShadowCascades-1;0<=e;--e)this._cascadeSplitRatios[e]=t,this._cascadeSplitDistances[e]=0,t*=.5},ri.prototype.getShadowMatrix=function(t){return this._shadowMatrices[t]},ri.prototype._updateBounds=function(){this._bounds.clear(Et.EXPANSE_INFINITE)},ri.prototype.toString=function(){return"[DirectionalLight(name="+this._name+")]"},ri.prototype.clone=function(){var t=new ri;return this.copyTo(t),t},(si.prototype=Object.create(Et.prototype)).setExplicit=function(t,e){this._center.copyFrom(t),this._halfExtentX=this._halfExtentY=this._halfExtentZ=e,this._expanse=Et.EXPANSE_FINITE,this._updateMinAndMax()},si.prototype.growToIncludeMesh=function(t){if(this._expanse!==Et.EXPANSE_INFINITE){var e,i,n,r,s,o,a=t.getVertexAttributeByName("hx_position"),h=a.offset,_=t.getVertexStride(a.streamIndex),l=t.getVertexData(a.streamIndex),u=l.length;for(this._expanse===Et.EXPANSE_EMPTY?(r=e=l[h],s=i=l[h+1],o=n=l[h+2],h+=_):(e=this._minimumX,i=this._minimumY,n=this._minimumZ,r=this._maximumX,s=this._maximumY,o=this._maximumZ);h<u;h+=_){var c=l[h],d=l[h+1],f=l[h+2];r<c?r=c:c<e&&(e=c),s<d?s=d:d<i&&(i=d),o<f?o=f:f<n&&(n=f)}var p=.5*(r+e),m=.5*(s+i),g=.5*(o+n),x=0;for(h=a.offset;h<u;h+=_){var v=p-l[h],y=m-l[h+1],T=g-l[h+2],S=v*v+y*y+T*T;x<S&&(x=S)}this._center.x=p,this._center.y=m,this._center.z=g;var E=Math.sqrt(x);this._halfExtentX=E,this._halfExtentY=E,this._halfExtentZ=E,this._expanse=Et.EXPANSE_FINITE,this._updateMinAndMax()}},si.prototype.growToIncludeBound=function(t){if(t._expanse!==Et.EXPANSE_EMPTY&&t._expanse!==Et.EXPANSE_INHERIT&&this._expanse!==Et.EXPANSE_INFINITE){if(t._expanse===Et.EXPANSE_INFINITE)this._expanse=Et.EXPANSE_INFINITE;else if(this._expanse===Et.EXPANSE_EMPTY)this._center.x=t._center.x,this._center.y=t._center.y,this._center.z=t._center.z,t._type===this._type?(this._halfExtentX=t._halfExtentX,this._halfExtentY=t._halfExtentY,this._halfExtentZ=t._halfExtentZ):this._halfExtentX=this._halfExtentY=this._halfExtentZ=t.getRadius(),this._expanse=Et.EXPANSE_FINITE;else{var e=this._minimumX,i=this._minimumY,n=this._minimumZ,r=this._maximumX,s=this._maximumY,o=this._maximumZ;t._maximumX>r&&(r=t._maximumX),t._maximumY>s&&(s=t._maximumY),t._maximumZ>o&&(o=t._maximumZ),t._minimumX<e&&(e=t._minimumX),t._minimumY<i&&(i=t._minimumY),t._minimumZ<n&&(n=t._minimumZ),this._center.x=.5*(e+r),this._center.y=.5*(i+s),this._center.z=.5*(n+o);var a=r-this._center.x,h=s-this._center.y,_=o-this._center.z,l=Math.sqrt(a*a+h*h+_*_);this._halfExtentX=this._halfExtentY=this._halfExtentZ=l}this._updateMinAndMax()}},si.prototype.growToIncludeMinMax=function(t,e){var i=new At;i.growToIncludeMinMax(t,e),this.growToIncludeBound(i)},si.prototype.getRadius=function(){return this._halfExtentX},si.prototype.transformFrom=function(t,e){if(t._expanse===Et.EXPANSE_INFINITE||t._expanse===Et.EXPANSE_EMPTY)this.clear(t._expanse);else{var i=e._m,n=i[0],r=i[1],s=i[2],o=i[4],a=i[5],h=i[6],_=i[8],l=i[9],u=i[10],c=t._center.x,d=t._center.y,f=t._center.z;this._center.x=n*c+o*d+_*f+i[12],this._center.y=r*c+a*d+l*f+i[13],this._center.z=s*c+h*d+u*f+i[14],n<0&&(n=-n),r<0&&(r=-r),s<0&&(s=-s),o<0&&(o=-o),a<0&&(a=-a),h<0&&(h=-h),_<0&&(_=-_),l<0&&(l=-l),u<0&&(u=-u);var p=n*(c=t._halfExtentX)+o*(d=t._halfExtentY)+_*(f=t._halfExtentZ),m=r*c+a*d+l*f,g=s*c+h*d+u*f,x=Math.sqrt(p*p+m*m+g*g);this._halfExtentX=this._halfExtentY=this._halfExtentZ=x,this._minimumX=this._center.x-this._halfExtentX,this._minimumY=this._center.y-this._halfExtentY,this._minimumZ=this._center.z-this._halfExtentZ,this._maximumX=this._center.x+this._halfExtentX,this._maximumY=this._center.y+this._halfExtentY,this._maximumZ=this._center.z+this._halfExtentZ,this._expanse=Et.EXPANSE_FINITE}},si.prototype.intersectsConvexSolid=function(t,e){if(this._expanse===Et.EXPANSE_INFINITE||this._expanse===Et.EXPANSE_INHERIT)return!0;if(this._expanse===Et.EXPANSE_EMPTY)return!1;for(var i=this._center.x,n=this._center.y,r=this._center.z,s=this._halfExtentX,o=0;o<e;++o){var a=t[o];if(s<a.x*i+a.y*n+a.z*r+a.w)return!1}return!0},si.prototype.intersectsBound=function(t){if(this._expanse===Et.EXPANSE_EMPTY||t._expanse===Et.EXPANSE_EMPTY)return!1;if(this._expanse===Et.EXPANSE_INFINITE||t._expanse===Et.EXPANSE_INFINITE||this._expanse===Et.EXPANSE_INHERIT||t._expanse===Et.EXPANSE_INHERIT)return!0;if(t._type===this._type){var e=this._center.x-t._center.x,i=this._center.y-t._center.y,n=this._center.z-t._center.z,r=this._halfExtentX+t._halfExtentX;return e*e+i*i+n*n<r*r}return Et._testAABBToSphere(t,this)},si.prototype.classifyAgainstPlane=function(t){var e=t.x*this._center.x+t.y*this._center.y+t.z*this._center.z+t.w,i=this._halfExtentX;return i<e?wt.FRONT:e<-i?wt.BACK:wt.INTERSECTING},si.prototype._updateMinAndMax=function(){var t=this._center.x,e=this._center.y,i=this._center.z,n=this._halfExtentX;this._minimumX=t-n,this._minimumY=e-n,this._minimumZ=i-n,this._maximumX=t+n,this._maximumY=e+n,this._maximumZ=i+n},si.prototype.intersectsRay=function(t){if(this._expanse===Et.EXPANSE_INFINITE)return!0;if(this._expanse===Et.EXPANSE_EMPTY||this._expanse===Et.EXPANSE_INHERIT)return!1;var e,i=this._center.x,n=this._center.y,r=this._center.z,s=this._halfExtentX,o=t.origin,a=t.direction,h=o.x,_=o.y,l=o.z,u=a.x,c=a.y,d=a.z,f=i-h,p=n-_,m=r-l,g=f*u+p*c+m*d;if(0<g){var x=h+g*u,v=_+g*c,y=l+g*d;e=(x=i-x)*x+(v=n-v)*v+(y=r-y)*y}else e=f*f+p*p+m*m;return e<=s*s},$e.create(oi,{numAtlasPlanes:{get:function(){return 6}},castShadows:{get:function(){return this._castShadows},set:function(t){if(this._castShadows=t){this._shadowTiles=[];for(var e=0;e<6;++e)this._shadowTiles[e]=new O}else this._shadowTiles=null}},radius:{get:function(){return this._radius},set:function(t){this._radius=t,this._invalidateBounds()}}},ni),oi.prototype._updateBounds=function(){this._bounds.setExplicit(O.ORIGIN_POINT,this._radius)},oi.prototype.toString=function(){return"[PointLight(name="+this._name+")]"},oi.prototype.copyTo=function(t){ni.prototype.copyTo.call(this,t),t.radius=this.radius},oi.prototype.clone=function(){var t=new oi;return this.copyTo(t),t},ai.powerRange0=98e-5,ai.powerRange1=.9921,$e.create(ai,{specularTexture:{get:function(){return this._specularTexture}},diffuseTexture:{get:function(){return this._diffuseTexture}},size:{get:function(){return this._size},set:function(t){this._size!==t&&((this._size=t)?this._bounds.setExplicit(O.ORIGIN_POINT,t):this._bounds.clear(Et.EXPANSE_INFINITE))}}}),ai.prototype.acceptVisitor=function(t){t.visitLight(this)},ai.prototype.clone=function(){var t=new ai(this._diffuseTexture,this._specularTexture);return t.size=this.size,t},$e.create(hi,{numAtlasPlanes:{get:function(){return 1}},castShadows:{get:function(){return this._castShadows},set:function(t){this._castShadows!==t&&((this._castShadows=t)?(this._shadowMatrix=new F,this._shadowTile=new O):(this._shadowMatrix=null,this._shadowTile=null))}},shadowMatrix:{get:function(){return this._shadowMatrix}},shadowTile:{get:function(){return this._shadowTile}},radius:{get:function(){return this._radius},set:function(t){this._radius=t,this._invalidateBounds()}},innerAngle:{get:function(){return this._innerAngle},set:function(t){this._innerAngle=I.clamp(t,0,Math.PI),this._outerAngle=I.clamp(this._outerAngle,this._innerAngle,Math.PI),this._cosInner=Math.cos(.5*this._innerAngle),this._cosOuter=Math.cos(.5*this._outerAngle),this._invalidateBounds()}},outerAngle:{get:function(){return this._outerAngle},set:function(t){this._outerAngle=I.clamp(t,0,Math.PI),this._innerAngle=I.clamp(this._innerAngle,0,this._outerAngle),this._cosInner=Math.cos(.5*this._innerAngle),this._cosOuter=Math.cos(.5*this._outerAngle),this._invalidateBounds()}}},ni),hi.prototype._updateBounds=(_e=new O,function(){var t=this._radius/(2*this._cosOuter);_e.set(0,t,0),this._bounds.setExplicit(_e,t)}),hi.prototype.toString=function(){return"[SpotLight(name="+this._name+")]"},hi.prototype.copyTo=function(t){ni.prototype.copyTo.call(this,t),t.radius=this.radius,t.innerAngle=this.innerAngle,t.outerAngle=this.outerAngle},hi.prototype.clone=function(){var t=new hi;return this.copyTo(t),t},(_i.prototype=Object.create($t.prototype)).updatePassRenderState=function(t,e){B.gl.useProgram(this._shader._program),this._assignDirLights(t),this._assignPointLights(t),this._assignSpotLights(t),this._assignLightProbes(t),$t.prototype.updatePassRenderState.call(this,t,e)},_i.prototype._generateShader=function(t,e,i,n){this._dirLights=[],this._pointLights=[],this._spotLights=[],this._diffuseLightProbes=[],this._specularLightProbes=[];for(var r=0;r<n.length;++r){var s=n[r];s instanceof ri?this._dirLights.push(s):s instanceof oi?this._pointLights.push(s):s instanceof hi?this._spotLights.push(s):s instanceof ai&&(s.diffuseTexture&&this._diffuseLightProbes.push(s),s.specularTexture&&this._specularLightProbes.push(s))}var o=[],a={HX_NUM_DIR_LIGHTS:this._dirLights.length,HX_NUM_POINT_LIGHTS:this._pointLights.length,HX_NUM_SPOT_LIGHTS:this._spotLights.length,HX_NUM_DIFFUSE_PROBES:this._diffuseLightProbes.length,HX_NUM_SPECULAR_PROBES:this._specularLightProbes.length};return Se.EXT_SHADER_TEXTURE_LOD&&(o+="#texturelod\n"),new gt(t+"\n"+d.get("material_fwd_fixed_vertex.glsl",a),o+d.get("snippets_geometry.glsl")+"\n"+i+"\n\n\n"+te.OPTIONS.shadowFilter.getGLSL()+"\n"+d.get("directional_light.glsl",a)+"\n"+d.get("point_light.glsl")+"\n"+d.get("spot_light.glsl")+"\n"+d.get("light_probe.glsl")+"\n"+e+"\n"+d.get("material_fwd_fixed_fragment.glsl"))},_i.prototype._assignDirLights=(le=new O,ue=new F,ce=new Float32Array(64),function(t){var e=this._dirLights;if(e)for(var i=e.length,n=B.gl,r=0;r<i;++r){var s=e[r],o=this._dirLocations[r];t.viewMatrix.transformVector(s.direction,le);var a=s._scaledIrradiance;if(n.uniform3f(o.color,a.r,a.g,a.b),n.uniform3f(o.direction,le.x,le.y,le.z),n.uniform1i(o.castShadows,s.castShadows?1:0),s.castShadows){for(var h=te.OPTIONS.numShadowCascades,_=s._cascadeSplitDistances,l=0,u=0;u<h;++u){ue.multiply(s.getShadowMatrix(u),t.worldMatrix);for(var c=ue._m,d=0;d<16;++d)ce[l++]=c[d]}n.uniformMatrix4fv(o.matrices,!1,ce),n.uniform4f(o.splits,_[0],_[1],_[2],_[3]),n.uniform1f(o.depthBias,s.depthBias),n.uniform1f(o.maxShadowDistance,_[h-1])}}}),_i.prototype._assignPointLights=(de=new O,fe=new Float32Array(24),function(t){var e=this._pointLights;if(e)for(var i=B.gl,n=e.length,r=0;r<n;++r){var s=this._pointLocations[r],o=e[r];o.entity.worldMatrix.getColumn(3,de),t.viewMatrix.transformPoint(de,de);var a=o._scaledIrradiance;if(i.uniform3f(s.color,a.r,a.g,a.b),i.uniform3f(s.position,de.x,de.y,de.z),i.uniform1f(s.radius,o._radius),i.uniform1f(s.rcpRadius,1/o._radius),i.uniform1i(s.castShadows,o.castShadows?1:0),o.castShadows){i.uniformMatrix4fv(s.matrix,!1,t.worldMatrix._m),i.uniform1f(s.depthBias,o.depthBias);var h=0;for(r=0;r<6;++r){var _=o._shadowTiles[r];fe[h++]=_.x,fe[h++]=_.y,fe[h++]=_.z,fe[h++]=_.w}i.uniform4fv(s.tiles,fe)}}}),_i.prototype._assignSpotLights=(pe=new O,me=new F,function(t){var e=this._spotLights;if(e)for(var i=B.gl,n=e.length,r=0;r<n;++r){var s=this._spotLocations[r],o=e[r],a=o.worldMatrix,h=t.viewMatrix;a.getColumn(3,pe),h.transformPoint(pe,pe);var _=o._scaledIrradiance;if(i.uniform3f(s.color,_.r,_.g,_.b),i.uniform3f(s.position,pe.x,pe.y,pe.z),i.uniform1f(s.radius,o._radius),i.uniform1f(s.rcpRadius,1/o._radius),i.uniform2f(s.angleData,o._cosOuter,1/Math.max(o._cosInner-o._cosOuter,1e-5)),a.getColumn(1,pe),h.transformVector(pe,pe),i.uniform3f(s.direction,pe.x,pe.y,pe.z),i.uniform1i(s.castShadows,o.castShadows?1:0),o.castShadows){me.multiply(o.shadowMatrix,t.worldMatrix),i.uniformMatrix4fv(s.matrix,!1,me._m),i.uniform1f(s.depthBias,o.depthBias);var l=o._shadowTile;i.uniform4f(s.tile,l.x,l.y,l.z,l.w)}}}),_i.prototype._assignLightProbes=function(){for(var t=[],e=[],i=this._diffuseLightProbes,n=i.length,r=0;r<n;++r)t[r]=i[r].diffuseTexture;n=(i=this._specularLightProbes).length;var s=[];for(r=0;r<n;++r)e[r]=i[r].specularTexture,s[r]=Math.floor(I.log2(e[r].size));0<t.length&&this.setTextureArray("hx_diffuseProbeMaps",t),0<e.length&&(this.setTextureArray("hx_specularProbeMaps",e),this.setUniformArray("hx_specularProbeNumMips",new Float32Array(s)))},_i.prototype._getUniformLocations=function(){this._dirLocations=[],this._pointLocations=[],this._spotLocations=[];for(var t=0;t<this._dirLights.length;++t)this._dirLocations.push({color:this.getUniformLocation("hx_directionalLights["+t+"].color"),direction:this.getUniformLocation("hx_directionalLights["+t+"].direction"),matrices:this.getUniformLocation("hx_directionalLights["+t+"].shadowMapMatrices[0]"),splits:this.getUniformLocation("hx_directionalLights["+t+"].splitDistances"),depthBias:this.getUniformLocation("hx_directionalLights["+t+"].depthBias"),maxShadowDistance:this.getUniformLocation("hx_directionalLights["+t+"].maxShadowDistance"),castShadows:this.getUniformLocation("hx_directionalLights["+t+"].castShadows")});for(t=0;t<this._pointLights.length;++t)this._pointLocations.push({color:this.getUniformLocation("hx_pointLights["+t+"].color"),position:this.getUniformLocation("hx_pointLights["+t+"].position"),radius:this.getUniformLocation("hx_pointLights["+t+"].radius"),rcpRadius:this.getUniformLocation("hx_pointLights["+t+"].rcpRadius"),castShadows:this.getUniformLocation("hx_pointLights["+t+"].castShadows"),depthBias:this.getUniformLocation("hx_pointLights["+t+"].depthBias"),matrix:this.getUniformLocation("hx_pointLights["+t+"].shadowMapMatrix"),tiles:this.getUniformLocation("hx_pointLights["+t+"].shadowTiles[0]")});for(t=0;t<this._spotLights.length;++t)this._spotLocations.push({color:this.getUniformLocation("hx_spotLights["+t+"].color"),position:this.getUniformLocation("hx_spotLights["+t+"].position"),direction:this.getUniformLocation("hx_spotLights["+t+"].direction"),radius:this.getUniformLocation("hx_spotLights["+t+"].radius"),rcpRadius:this.getUniformLocation("hx_spotLights["+t+"].rcpRadius"),angleData:this.getUniformLocation("hx_spotLights["+t+"].angleData"),castShadows:this.getUniformLocation("hx_spotLights["+t+"].castShadows"),matrix:this.getUniformLocation("hx_spotLights["+t+"].shadowMapMatrix"),tile:this.getUniformLocation("hx_spotLights["+t+"].shadowTile"),depthBias:this.getUniformLocation("hx_spotLights["+t+"].depthBias")})},(li.prototype=Object.create($t.prototype)).updatePassRenderState=(ge=new O,xe=new Float32Array(24),function(t,e,i){var n=B.gl,r=i._scaledIrradiance;if(n.useProgram(this._shader._program),i.entity.worldMatrix.getColumn(3,ge),t.viewMatrix.transformPoint(ge,ge),n.uniform3f(this._colorLocation,r.r,r.g,r.b),n.uniform3f(this._posLocation,ge.x,ge.y,ge.z),n.uniform1f(this._radiusLocation,i._radius),n.uniform1f(this._rcpRadiusLocation,1/i._radius),n.uniform1i(this._castShadowsLocation,i.castShadows?1:0),i.castShadows){for(var s=0,o=0;o<6;++o){var a=i._shadowTiles[o];xe[s++]=a.x,xe[s++]=a.y,xe[s++]=a.z,xe[s++]=a.w}n.uniform4fv(this._shadowTilesLocation,xe),n.uniform1f(this._depthBiasLocation,i.depthBias),n.uniformMatrix4fv(this._shadowMatrixLocation,!1,t.worldMatrix._m)}$t.prototype.updatePassRenderState.call(this,t,e)}),li.prototype._generateShader=function(t,e,i){var n={};return new gt(t+"\n"+d.get("material_fwd_point_vertex.glsl",n),d.get("snippets_geometry.glsl",n)+"\n"+i+"\n\n\n"+te.OPTIONS.shadowFilter.getGLSL()+"\n"+d.get("point_light.glsl")+"\n"+e+"\n"+d.get("material_fwd_point_fragment.glsl"))},(ui.prototype=Object.create($t.prototype)).updatePassRenderState=function(t,e,i){var n=B.gl;n.useProgram(this._shader._program),this._diffuseSlot.texture=i.diffuseTexture||Te.DARK_CUBE_TEXTURE;var r=i.specularTexture||Te.DARK_CUBE_TEXTURE;this._specularSlot.texture=r,n.uniform1f(this._numMipsLocation,Math.floor(I.log2(r.size))),n.uniform1f(this._localLocation,i._size?1:0),n.uniform1f(this._sizeLocation,i._size||0);var s=i.entity.worldMatrix._m;n.uniform3f(this._positionLocation,s[12],s[13],s[14]),$t.prototype.updatePassRenderState.call(this,t,e)},ui.prototype._generateShader=function(t,e,i){var n="";return Se.EXT_SHADER_TEXTURE_LOD&&(n+="#texturelod\n"),new gt(t+"\n"+d.get("material_fwd_probe_vertex.glsl"),n+d.get("snippets_geometry.glsl")+"\n"+i+"\n\n\n"+d.get("light_probe.glsl")+"\n"+e+"\n"+d.get("material_fwd_probe_fragment.glsl"))},(ci.prototype=Object.create($t.prototype)).updatePassRenderState=(ve=new O,ye=new F,function(t,e,i){var n=B.gl,r=i._scaledIrradiance;n.useProgram(this._shader._program);var s=i.entity.worldMatrix,o=t.viewMatrix;if(s.getColumn(3,ve),o.transformPoint(ve,ve),n.uniform3f(this._colorLocation,r.r,r.g,r.b),n.uniform3f(this._posLocation,ve.x,ve.y,ve.z),s.getColumn(1,ve),o.transformVector(ve,ve),n.uniform3f(this._dirLocation,ve.x,ve.y,ve.z),n.uniform1f(this._radiusLocation,i._radius),n.uniform1f(this._rcpRadiusLocation,1/i._radius),n.uniform2f(this._anglesLocation,i._cosOuter,1/Math.max(i._cosInner-i._cosOuter,1e-5)),n.uniform1i(this._castShadowsLocation,i.castShadows?1:0),i.castShadows){var a=i._shadowTile;n.uniform1f(this._depthBiasLocation,i.depthBias),n.uniform4f(this._shadowTileLocation,a.x,a.y,a.z,a.w),ye.multiply(i._shadowMatrix,t.worldMatrix),n.uniformMatrix4fv(this._shadowMatrixLocation,!1,ye._m)}$t.prototype.updatePassRenderState.call(this,t,e)}),ci.prototype._generateShader=function(t,e,i){var n={};return new gt(t+"\n"+d.get("material_fwd_spot_vertex.glsl",n),d.get("snippets_geometry.glsl",n)+"\n"+i+"\n\n\n"+te.OPTIONS.shadowFilter.getGLSL()+"\n"+d.get("spot_light.glsl")+"\n"+e+"\n"+d.get("material_fwd_spot_fragment.glsl"))},(di.prototype=Object.create($t.prototype))._generateShader=function(t,e){var i="#define HX_SKIP_SPECULAR\n",n=i+d.get("snippets_geometry.glsl")+"\n"+e+"\n"+d.get("material_normal_depth_fragment.glsl");return new gt(i+t+"\n"+d.get("material_normal_depth_vertex.glsl"),n)};var fi={FORWARD_DYNAMIC:0,FORWARD_FIXED:1,NUM_PATHS:2};function pi(t,e){$t.call(this,this._generateShader(t,e)),this._rcpRadiusLocation=this.getUniformLocation("hx_rcpRadius")}(pi.prototype=Object.create($t.prototype)).updatePassRenderState=function(t,e,i){$t.prototype.updatePassRenderState.call(this,t,e),B.gl.uniform1f(this._rcpRadiusLocation,1/i._radius)},pi.prototype._generateShader=function(t,e){var i="#define HX_SKIP_NORMALS\n#define HX_SKIP_SPECULAR\n",n=i+d.get("snippets_geometry.glsl")+"\n"+te.OPTIONS.shadowFilter.getGLSL()+"\n"+e+"\n"+d.get("material_point_shadow_fragment.glsl");return new gt(i+t+"\n"+d.get("material_point_shadow_vertex.glsl"),n)};var mi=0;function gi(t,e,i){this.onChange=new n,this._elementType=Le.TRIANGLES,this._cullMode=Ae.BACK,this._writeDepth=!0,this._writeColor=!0,this._passes=new Array(gi.NUM_PASS_TYPES),this._renderOrderHint=++mi,this._renderPath=null,this._renderOrder=0,this._textures={},this._uniforms={},this._fixedLights=null,this._useMorphing=!1,this._useNormalMorphing=!1,this._useSkinning=!1,this._name=null,this._geometryVertexShader=t,this._geometryFragmentShader=e,this._lightingModel=i||te.OPTIONS.defaultLightingModel,this._initialized=!1,this._blendState=null,this._additiveBlendState=Ct.ADD,this._needsNormalDepth=!1,this._needsBackbuffer=!1}function xi(t){gi.call(this),t=t||{},this._color=t.color||new h(1,1,1,1),this._emissiveColor=t.emissiveColor||new h(0,0,0,1),this._colorMap=t.colorMap||null,this._doubleSided=!!t.doubleSided,this._normalMap=t.normalMap||null,this._specularMap=t.specularMap||null,this._maskMap=t.maskMap||null,this._specularMapMode=t.specularMapMode||xi.SPECULAR_MAP_ROUGHNESS_ONLY,this._metallicness=void 0===t.metallicness?0:t.metallicness,this._alpha=void 0===t.alpha?1:t.alpha,this._roughness=void 0===t.roughness?.5:t.roughness,this._roughnessRange=void 0===t.roughnessRange?.5:t.roughnessRange,this._normalSpecularReflectance=void 0===t.normalSpecularReflectance?.027:t.normalSpecularReflectance,this._alphaThreshold=void 0===t.alphaThreshold?1:t.alphaThreshold,this._useVertexColors=!!t.useVertexColors,this.color=this._color,this.emissiveColor=this._emissiveColor,this.alpha=this._alpha,this.metallicness=this._metallicness,this.roughness=this._roughness,this.normalSpecularReflectance=this._normalSpecularReflectance,void 0!==t.lightingModel&&(this.lightingModel=t.lightingModel)}function vi(){ei.call(this);var t=new Ge({height:1,radius:.01,alignment:Ge.ALIGN_X}),e=new Ge({height:1,radius:.01,alignment:Ge.ALIGN_Y}),i=new Ge({height:1,radius:.01,alignment:Ge.ALIGN_Z});t.translate(.5,0,0),e.translate(0,.5,0),i.translate(0,0,.5);var n=new xi({color:16711680,lightingModel:S.Unlit}),r=new xi({color:65280,lightingModel:S.Unlit}),s=new xi({color:255,lightingModel:S.Unlit});this.addComponent(new ti(t,n)),this.addComponent(new ti(e,r)),this.addComponent(new ti(i,s))}gi.ID_COUNTER=0,gi.prototype={init:function(){if(!this._initialized&&this._geometryVertexShader&&this._geometryFragmentShader){this._needsNormalDepth=!1,this._needsBackbuffer=!1;var t=this._geometryVertexShader,e=this._geometryFragmentShader;this._useSkinning&&(t="#define HX_USE_SKINNING\n"+t),this._useMorphing&&(t="#define HX_USE_MORPHING\n"+t,this._useNormalMorphing&&(t="#define HX_USE_NORMAL_MORPHING\n"+t)),this._lightingModel?this._fixedLights?(this._renderPath=fi.FORWARD_FIXED,this.setPass($t.BASE_PASS,new _i(t,e,this._lightingModel,this._fixedLights))):Se.WEBGL_2?(this._renderPath=fi.FORWARD_DYNAMIC,this.setPass($t.BASE_PASS,new Ze(t,e,this._lightingModel,null))):(this._renderPath=fi.FORWARD_DYNAMIC,this.setPass($t.BASE_PASS,new qe(t,e)),this.setPass($t.DIR_LIGHT_PASS,new We(t,e,this._lightingModel)),this.setPass($t.POINT_LIGHT_PASS,new li(t,e,this._lightingModel)),this.setPass($t.SPOT_LIGHT_PASS,new ci(t,e,this._lightingModel)),this.setPass($t.LIGHT_PROBE_PASS,new ui(t,e,this._lightingModel))):(this._renderPath=fi.FORWARD_FIXED,this.setPass($t.BASE_PASS,new Ye(t,e))),this.setPass($t.DIR_LIGHT_SHADOW_MAP_PASS,new je(t,e)),this.setPass($t.POINT_LIGHT_SHADOW_MAP_PASS,new pi(t,e)),this.setPass($t.NORMAL_DEPTH_PASS,new di(t,e)),this._initialized=!0}},get initialized(){return this._initialized},get blendState(){return this._blendState},set blendState(t){(this._blendState=t)?(this._additiveBlendState=t.clone(),this._additiveBlendState.dstFactor=Re.ONE):this._additiveBlendState=Ct.ADD,this._invalidate()},get fixedLights(){return this._fixedLights},set fixedLights(t){this._fixedLights=t,this._invalidate()},get name(){return this._name},set name(t){this._name=t},get lightingModel(){return this._lightingModel},set lightingModel(t){this._lightingModel=t,this._invalidate()},get renderOrder(){return this._renderOrder},set renderOrder(t){this._renderOrder=t},get elementType(){return this._elementType},set elementType(t){this._elementType=t;for(var e=0;e<$t.NUM_PASS_TYPES;++e)this._passes[e]&&(this._passes[e].elementType=t)},get writeDepth(){return this._writeDepth},set writeDepth(t){!(this._writeDepth=t)&&this._passes[$t.NORMAL_DEPTH_PASS]?this._passes[$t.NORMAL_DEPTH_PASS]=null:t&&!this._passes[$t.NORMAL_DEPTH_PASS]&&this._invalidate();for(var e=0;e<$t.NUM_PASS_TYPES;++e)this._passes[e]&&(this._passes[e].writeDepth=t)},get writeColor(){return this._writeColor},set writeColor(t){this._writeColor=t;for(var e=0;e<$t.NUM_PASS_TYPES;++e)this._passes[e]&&(this._passes[e].writeColor=t)},get cullMode(){return this._cullMode},set cullMode(t){this._cullMode=t;for(var e=0;e<$t.NUM_PASS_TYPES;++e)e!==$t.DIR_LIGHT_SHADOW_MAP_PASS&&e!==$t.POINT_LIGHT_SHADOW_MAP_PASS&&this._passes[e]&&(this._passes[e].cullMode=t)},get renderPath(){return this._initialized||this.init(),this._renderPath},getPass:function(t){return this._initialized||this.init(),this._passes[t]},setPass:function(t,e){if(this._passes[t]=e){for(var i in e.cullMode=t===$t.DIR_LIGHT_SHADOW_MAP_PASS||t===$t.POINT_LIGHT_SHADOW_MAP_PASS?te.OPTIONS.shadowFilter.cullMode:this._cullMode,e.elementType=this._elementType,e.writeDepth=this._writeDepth,e.writeColor=this._writeColor,$t.DIR_LIGHT_PASS<=t&&t<=$t.LIGHT_PROBE_PASS&&(e.blendState=this._additiveBlendState),t===$t.BASE_PASS&&(e.blendState=this._blendState),e.getTextureSlot("hx_normalDepthBuffer")&&(this._needsNormalDepth=!0),e.getTextureSlot("hx_backbuffer")&&(this._needsBackbuffer=!0),this._textures)if(this._textures.hasOwnProperty(i)){var n=this._textures[i];n instanceof Array?e.setTextureArray(i,n):e.setTexture(i,n)}for(var r in this._uniforms)this._uniforms.hasOwnProperty(r)&&("]"===r.charAt(r.length-1)?e.setUniformArray(r.substr(0,r.length-3),this._uniforms[r]):e.setUniform(r,this._uniforms[r]))}this.onChange.dispatch()},hasPass:function(t){return this._initialized||this.init(),!!this._passes[t]},setTexture:function(t,e){e?this._textures[t]=e:delete this._textures[t];for(var i=0;i<$t.NUM_PASS_TYPES;++i)this._passes[i]&&this._passes[i].setTexture(t,e)},setTextureArray:function(t,e){e?this._textures[t]=e:delete this._textures[t];for(var i=0;i<$t.NUM_PASS_TYPES;++i)this._passes[i]&&this._passes[i].setTextureArray(t,e)},setUniform:function(t,e,i){if(void 0===i&&(i=!0),i||!this._uniforms.hasOwnProperty(t)){this._uniforms[t]=e;for(var n=0;n<$t.NUM_PASS_TYPES;++n)this._passes[n]&&this._passes[n].setUniform(t,e)}},setUniformArray:function(t,e,i){if(void 0===i&&(i=!0),i||!this._uniforms.hasOwnProperty(t+"[0]")){this._uniforms[t+"[0]"]=e;for(var n=0;n<$t.NUM_PASS_TYPES;++n)this._passes[n]&&this._passes[n].setUniformArray(t,e)}},_setUseSkinning:function(t){this._useSkinning!==t&&this._invalidate(),this._useSkinning=t},_setUseMorphing:function(t,e){this._useSkinning===t&&this._useNormalMorphing===e||this._invalidate(),this._useMorphing=t,this._useNormalMorphing=e},_invalidate:function(){this._initialized=!1,this._passes=new Array(gi.NUM_PASS_TYPES),this.onChange.dispatch()},toString:function(){return"[Material(name="+this._name+")]"}},xi.roughnessFromShininess=function(t){return Math.sqrt(2/(t+2))},xi.SPECULAR_MAP_ROUGHNESS_ONLY=1,xi.SPECULAR_MAP_ALL=2,xi.SPECULAR_MAP_SHARE_NORMAL_MAP=3,xi.SPECULAR_MAP_METALLIC_ROUGHNESS=4,(xi.prototype=Object.create(gi.prototype,{doubleSided:{get:function(){return this._doubleSided},set:function(t){this._doubleSided!==t&&this._invalidate(),this._doubleSided=t,this.cullMode=t?Ae.NONE:Ae.BACK}},alpha:{get:function(){return this._alpha},set:function(t){this._alpha=I.saturate(t),this.setUniform("alpha",this._alpha)}},useVertexColors:{get:function(){return this._useVertexColors},set:function(t){this._useVertexColors!==t&&this._invalidate(),this._useVertexColors=t}},color:{get:function(){return this._color},set:function(t){this._color=isNaN(t)?t:new h(t),this.setUniform("color",this._color)}},colorMap:{get:function(){return this._colorMap},set:function(t){!!this._colorMap!=!!t&&this._invalidate(),this._colorMap=t,this.setTexture("colorMap",t)}},normalMap:{get:function(){return this._normalMap},set:function(t){!!this._normalMap!=!!t&&this._invalidate(),this.setTexture("normalMap",t),this._normalMap=t}},occlusionMap:{get:function(){return this._occlusionMap},set:function(t){!!this._occlusionMap!=!!t&&this._invalidate(),this.setTexture("occlusionMap",t),this._occlusionMap=t}},emissiveColor:{get:function(){return this._emissiveColor},set:function(t){this._emissiveColor=isNaN(t)?t:new h(t),this.setUniform("emissiveColor",this._emissiveColor)}},emissionMap:{get:function(){return this._emissionMap},set:function(t){!!this._emissionMap!=!!t&&this._invalidate(),this.setTexture("emissionMap",t),this._emissionMap=t}},specularMap:{get:function(){return this._specularMap},set:function(t){!!this._specularMap!=!!t&&this._invalidate(),this.setTexture("specularMap",t),this._specularMap=t}},maskMap:{get:function(){return this._maskMap},set:function(t){!!this._maskMap!=!!t&&this._invalidate(),this.setTexture("maskMap",t),this._maskMap=t}},specularMapMode:{get:function(){return this._specularMapMode},set:function(t){this._specularMapMode!==t&&this._invalidate(),this._specularMapMode=t}},metallicness:{get:function(){return this._metallicness},set:function(t){this._metallicness=I.saturate(t),this.setUniform("metallicness",this._metallicness)}},normalSpecularReflectance:{get:function(){return this._normalSpecularReflectance},set:function(t){this._normalSpecularReflectance=I.saturate(t),this.setUniform("normalSpecularReflectance",this._normalSpecularReflectance)}},roughness:{get:function(){return this._roughness},set:function(t){this._roughness=t,this.setUniform("roughness",this._roughness)}},roughnessRange:{get:function(){return this._roughnessRange},set:function(t){this._roughnessRange=t,this.setUniform("roughnessRange",2*this._roughnessRange)}},alphaThreshold:{get:function(){return this._alphaThreshold},set:function(t){t=I.saturate(t),1===this._alphaThreshold!=(1===t)&&this._invalidate(),this._alphaThreshold=t,this.setUniform("alphaThreshold",t)}}})).init=function(){var t=this._generateDefines();this._geometryVertexShader=d.get("default_geometry_vertex.glsl",t),this._geometryFragmentShader=d.get("default_geometry_fragment.glsl",t),gi.prototype.init.call(this)},xi.prototype._generateDefines=function(){var t={};switch(this._colorMap&&(t.COLOR_MAP=1),this._useVertexColors&&(t.VERTEX_COLORS=1),this._normalMap&&(t.NORMAL_MAP=1),this._occlusionMap&&(t.OCCLUSION_MAP=1),this._emissionMap&&(t.EMISSION_MAP=1),this._maskMap&&(t.MASK_MAP=1),this._alphaThreshold<1&&(t.ALPHA_THRESHOLD=1),this._specularMapMode){case xi.SPECULAR_MAP_ROUGHNESS_ONLY:this._specularMap&&(t.ROUGHNESS_MAP=1);break;case xi.SPECULAR_MAP_ALL:this._specularMap&&(t.SPECULAR_MAP=1);break;case xi.SPECULAR_MAP_METALLIC_ROUGHNESS:this._specularMap&&(t.METALLIC_ROUGHNESS_MAP=1);break;default:t.NORMAL_ROUGHNESS_MAP=1}return this._doubleSided&&(t.DOUBLE_SIDED=1),t},vi.prototype=Object.create(Ke.prototype);var yi,Ti,Si,Ei,wi,Ai=(yi={},Ti={},{getTime:function(t){return yi[t]},startTiming:function(t){yi[t]||(yi[t]=0),Ti[t]=Date.now()},stopTiming:function(t){yi[t]+=Date.now()-Ti[t]},resetTiming:function(t){yi[t]=0}});function Pi(t){this.onEntityAdded=new n,this.onEntityRemoved=new n,this.onDisposed=new n,this._hash=t,this._entities=[],this._usageCount=0}function Mi(){this._updateableEntities=[],this._entities=[],this._entitySets={},this._systems=[],ee.bind(this._update,this)}function Li(){this._entities=[]}function Ri(t){this._name=null,this._rootNode=t||new Ke,this._rootNode.name="Root",this._rootNode._setScene(this),this._skybox=null,this._entityEngine=new Mi,this._partitioning=new Li}function bi(){}function Ii(t){gi.call(this);var e=d.get("default_skybox_vertex.glsl"),i=d.get("default_skybox_fragment.glsl");this.writeDepth=!1,this.cullMode=Ae.NONE;var n=new Ye(e,i);this.setPass($t.BASE_PASS,n),this._renderPath=fi.FORWARD_FIXED,this._initialized=!0,this._renderOrder=Number.POSITIVE_INFINITY,this.setTexture("hx_skybox",t)}function Ni(t){ke.call(this,t)}function Di(){this._planes=new Array(6),this._corners=new Array(8);for(var t=0;t<6;++t)this._planes[t]=new O;for(t=0;t<8;++t)this._corners[t]=new O}function Oi(){ei.call(this),this._renderTargetWidth=0,this._renderTargetHeight=0,this._viewProjectionMatrixInvalid=!0,this._viewProjectionMatrix=new F,this._inverseProjectionMatrix=new F,this._inverseViewProjectionMatrix=new F,this._projectionMatrix=new F,this._viewMatrix=new F,this._projectionMatrixDirty=!0,this._clusterPlanesDirty=!0,this._nearDistance=.1,this._farDistance=1e3,this._frustum=new Di,this.position.set(0,-1,0)}function Ci(){Oi.call(this),this._vFOV=1.047198,this._aspectRatio=1}function Fi(t){ei.call(this),t instanceof gi||(t=new Ii(t));var e=new Ni({width:1,invert:!0});e.bounds.clear(Et.EXPANSE_INFINITE),e._boundsInvalid=!1,this._meshInstance=new ti(e,t),this.addComponent(this._meshInstance)}function Ui(e){var i=null,n=null;this.getItem=function(){var t;return i?i=(t=i).next:((t=new e).next=n,n=t),t},this.reset=function(){i=n}}function Bi(){this.worldMatrix=null,this.meshInstance=null,this.skeleton=null,this.skeletonMatrices=null,this.material=null,this.camera=null,this.renderOrderHint=0,this.worldBounds=null,this.next=null}Pi.prototype={get numEntities(){return this._entities.length},getEntity:function(t){return this._entities[t]},_containsComponentHash:function(t){this._hash.contains(t)},_add:function(t){this._entities.push(t),this.onEntityAdded.dispatch(t)},_remove:function(t){this.onEntityRemoved.dispatch(t);var e=this._entities.indexOf(t);this._entities.splice(e,1)},_increaseUsage:function(){++this._usageCount},free:function(){0==--this._usageCount&&this.onDisposed.dispatch(this)}},Mi.prototype={startSystem:function(t){if(0<=this._systems.indexOf(t))throw new Error("System already running!");this._systems.push(t),t._onStarted(this)},stopSystem:function(t){var e=this._systems.push(t);if(e<0)throw new Error("System not running!");this._systems.splice(e,1),t.onStopped()},getEntitySet:function(t){for(var e=new Je,i=t.length,n=0;n<i;++n)e.setBit(t[n].COMPONENT_ID);var r=e.toString(),s=this._entitySets[r];if(!s)for((s=new Pi(e)).onDisposed.bind(this._onSetDisposed,this),this._entitySets[r]=s,i=this._entities.length,n=0;n<i;++n){var o=this._entities[n];o._componentHash.contains(e)&&s._add(o)}return s._increaseUsage(),s},registerEntity:function(e){this._entities.push(e),e._onComponentsChange.bind(this._onEntityComponentsChange,this),e._requiresUpdates&&this._addUpdatableEntity(e),u.forEach(this._entitySets,function(t){e._componentHash.contains(t._hash)&&t._add(e)})},unregisterEntity:function(e){var t=this._entities.indexOf(e);this._entities.splice(t),e._onComponentsChange.unbind(this),e._requiresUpdates&&this._removeUpdatableEntity(e),u.forEach(this._entitySets,function(t){e._componentHash.contains(t._hash)&&t._remove(e)})},_onEntityComponentsChange:function(n,r){n._requiresUpdates?this._addUpdatableEntity(n):this._removeUpdatableEntity(n),u.forEach(this._entitySets,function(t){var e=r.contains(t._hash),i=n._componentHash.contains(t._hash);!e&&i?t._add(n):e&&!i&&t._remove(n)})},_addUpdatableEntity:function(t){this._updateableEntities.indexOf(t)<0&&this._updateableEntities.push(t)},_removeUpdatableEntity:function(t){var e=this._updateableEntities.indexOf(t);0<=e&&this._updateableEntities.splice(e,1)},_update:function(t){for(var e=this._updateableEntities,i=e.length,n=0;n<i;++n)e[n].update(t);var r=this._systems;for(i=r.length,n=0;n<i;++n)r[n].onUpdate(t)},_onSetDisposed:function(t){delete this._entitySets[t._hash]}},Li.prototype={acceptVisitor:function(t){for(var e=this._entities,i=0,n=e.length;i<n;++i){var r=e[i];t.qualifies(r)&&r.acceptVisitor(t)}},markEntityForUpdate:function(t){},registerEntity:function(t){this._entities.push(t)},unregisterEntity:function(t){var e=this._entities.indexOf(t);this._entities.splice(e,1)}},Ri.prototype={get name(){return this._name},set name(t){this._name=t},get rootNode(){return this._rootNode},get skybox(){return this._skybox},set skybox(t){this._skybox=t},findNodeByName:function(t){return this._rootNode.findNodeByName(t)},findMaterialByName:function(t){return this._rootNode.findMaterialByName(t)},attach:function(t){this._rootNode.attach(t)},detach:function(t){this._rootNode.detach(t)},destroy:function(){this._rootNode.destroy()},get numChildren(){return this._rootNode.numChildren},getChild:function(t){return this._rootNode.getChild(t)},contains:function(t){this._rootNode.contains(t)},acceptVisitor:function(t){t.visitScene(this),this._partitioning.acceptVisitor(t)},getEntitySet:function(t){return this._entityEngine.getEntitySet(t)},get entityEngine(){return this._entityEngine},get partitioning(){return this._partitioning},startSystem:function(t){this._entityEngine.startSystem(t)},stopSystem:function(t){this._entityEngine.stopSystem(t)},get worldBounds(){return this._rootNode.worldBounds},applyFunction:function(t,e){this._rootNode.applyFunction(t,e)}},bi.prototype={qualifies:function(t){},visitLight:function(t){},visitAmbientLight:function(t){},visitMeshInstance:function(t){},visitScene:function(t){},visitEffect:function(t){}},Ii.prototype=Object.create(gi.prototype),(Ni.prototype=Object.create(ke.prototype))._generate=function(t,e){var i,n,r,s,o,a,h,_,l=e.numSegmentsW||1,u=e.numSegmentsH||e.numSegmentsW||1,c=e.numSegmentsD||e.numSegmentsW||1,d=e.width||1,f=e.height||d,p=e.depth||d,m=e.invert?-1:1,g=void 0!==e.doubleSided&&e.doubleSided,x=1/l,v=1/u,y=1/c,T=.5*d,S=.5*f,E=.5*p,w=t.positions,A=t.uvs,P=t.normals,M=t.indices;for(h=0;h<=u;++h)for(n=f*(o=h*v)-S,m<0&&(o=1-o),a=0;a<=l;++a)i=d*(s=a*x)-T,m<0&&(s=1-s),w.push(i*m,E*m,n*m),w.push(-i*m,-E*m,n*m),P&&(P.push(0,1,0),P.push(0,-1,0)),A&&(A.push(s,o),A.push(s,o));for(h=0;h<=u;++h)for(n=f*(o=h*v)-S,_=0;_<=c;++_)r=p*(s=_*y)-E,w.push(-T,r*m,n),w.push(T,-r*m,n),P&&(P.push(-m,0,0),P.push(m,0,0)),A&&(A.push(s,o),A.push(s,o));for(_=0;_<=c;++_)for(r=p*(o=_*y)-E,a=0;a<=l;++a)i=d*(s=a*x)-T,w.push(i,-r*m,S),w.push(i,r*m,-S),P&&(P.push(0,0,m),P.push(0,0,-m)),A&&(A.push(1-s,1-o),A.push(1-s,1-o));for(var L=0,R=0;R<3;++R){for(var b=1===R?c:l,I=2===R?c:u,N=0;N<I;++N)for(var D=0;D<b;++D){var O=b+1,C=L+D+N*O,F=C<<1,U=C+O+1<<1,B=C+O<<1,X=C+1<<1;M.push(F,B,U),M.push(F,U,X),M.push(1|F,1|B,1|U),M.push(1|F,1|U,1|X)}L+=(b+1)*(I+1)}var H=0;if(g)for(;0<H;)M.push(M[0],M[2],M[1]),M.push(M[3],M[5],M[4]),H+=6},Di.PLANE_LEFT=0,Di.PLANE_RIGHT=1,Di.PLANE_BOTTOM=2,Di.PLANE_TOP=3,Di.PLANE_NEAR=4,Di.PLANE_FAR=5,Di.CLIP_SPACE_CORNERS=[new O(-1,-1,-1,1),new O(1,-1,-1,1),new O(1,1,-1,1),new O(-1,1,-1,1),new O(-1,-1,1,1),new O(1,-1,1,1),new O(1,1,1,1),new O(-1,1,1,1)],Di.prototype={get planes(){return this._planes},get corners(){return this._corners},update:function(t,e){this._updatePlanes(t),this._updateCorners(e)},_updatePlanes:function(t){var e=t._m,i=this._planes[Di.PLANE_LEFT],n=this._planes[Di.PLANE_RIGHT],r=this._planes[Di.PLANE_TOP],s=this._planes[Di.PLANE_BOTTOM],o=this._planes[Di.PLANE_NEAR],a=this._planes[Di.PLANE_FAR],h=e[0],_=e[4],l=e[8],u=e[12],c=e[1],d=e[5],f=e[9],p=e[13],m=e[2],g=e[6],x=e[10],v=e[14],y=e[3],T=e[7],S=e[11],E=e[15];i.x=-(y+h),i.y=-(T+_),i.z=-(S+l),i.w=-(E+u),i.normalizeAsPlane(),n.x=h-y,n.y=_-T,n.z=l-S,n.w=u-E,n.normalizeAsPlane(),s.x=-(y+c),s.y=-(T+d),s.z=-(S+f),s.w=-(E+p),s.normalizeAsPlane(),r.x=c-y,r.y=d-T,r.z=f-S,r.w=p-E,r.normalizeAsPlane(),o.x=-(y+m),o.y=-(T+g),o.z=-(S+x),o.w=-(E+v),o.normalizeAsPlane(),a.x=m-y,a.y=g-T,a.z=x-S,a.w=v-E,a.normalizeAsPlane()},_updateCorners:function(t){for(var e=0;e<8;++e){var i=this._corners[e];t.transform(Di.CLIP_SPACE_CORNERS[e],i),i.scale(1/i.w)}}},(Oi.prototype=Object.create(ei.prototype,{nearDistance:{get:function(){return this._nearDistance},set:function(t){this._nearDistance!==t&&(this._nearDistance=t,this._invalidateProjectionMatrix())}},farDistance:{get:function(){return this._farDistance},set:function(t){this._farDistance!==t&&(this._farDistance=t,this._invalidateProjectionMatrix())}},clusterPlanesW:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._clusterPlanesDirty&&this._updateClusterPlanes(),this._clusterPlanesW}},clusterPlanesH:{get:function(){return this._projectionMatrixDirty&&this._updateProjectionMatrix(),this._clusterPlanesDirty&&this._updateClusterPlanes(),this._clusterPlanesH}},viewProjectionMatrix:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._viewProjectionMatrix}},viewMatrix:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._viewMatrix}},projectionMatrix:{get:function(){return this._projectionMatrixDirty&&this._updateProjectionMatrix(),this._projectionMatrix}},inverseViewProjectionMatrix:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._inverseViewProjectionMatrix}},inverseProjectionMatrix:{get:function(){return this._projectionMatrixDirty&&this._updateProjectionMatrix(),this._inverseProjectionMatrix}},frustum:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._frustum}}})).getRay=function(t,e){var i=new ze,n=i.direction;return n.set(t,e,1,1),this.inverseProjectionMatrix.transform(n,n),n.homogeneousProject(),this.worldMatrix.transformVector(n,n),n.normalize(),this.worldMatrix.getColumn(3,i.origin),i},Oi.prototype._setRenderTargetResolution=function(t,e){this._renderTargetWidth=t,this._renderTargetHeight=e},Oi.prototype._invalidateViewProjectionMatrix=function(){this._viewProjectionMatrixInvalid=!0},Oi.prototype._invalidateWorldMatrix=function(){ei.prototype._invalidateWorldMatrix.call(this),this._invalidateViewProjectionMatrix()},Oi.prototype._updateViewProjectionMatrix=function(){this._viewMatrix.inverseAffineOf(this.worldMatrix),this._viewProjectionMatrix.multiply(this.projectionMatrix,this._viewMatrix),this._inverseProjectionMatrix.inverseOf(this._projectionMatrix),this._inverseViewProjectionMatrix.inverseOf(this._viewProjectionMatrix),this._frustum.update(this._viewProjectionMatrix,this._inverseViewProjectionMatrix),this._viewProjectionMatrixInvalid=!1},Oi.prototype._invalidateProjectionMatrix=function(){this._projectionMatrixDirty=!0,this._clusterPlanesDirty=!0,this._invalidateViewProjectionMatrix()},Oi.prototype._updateProjectionMatrix=function(){throw new Error("Abstract method!")},Oi.prototype._updateBounds=function(){this._bounds.clear(Et.EXPANSE_INFINITE)},Oi.prototype.toString=function(){return"[Camera(name="+this._name+")]"},Oi.prototype._initClusterPlanes=function(){this._clusterPlanesW=[],this._clusterPlanesH=[];for(var t=0;t<=te.OPTIONS.numLightingCellsX;++t)this._clusterPlanesW[t]=new O;for(t=0;t<=te.OPTIONS.numLightingCellsY;++t)this._clusterPlanesH[t]=new O},Oi.prototype._updateClusterPlanes=(Si=new O,Ei=new O,wi=new O,function(){if(this._clusterPlanesDirty){var t=2/te.OPTIONS.numLightingCellsX,e=2/te.OPTIONS.numLightingCellsY;this._clusterPlanesW||this._initClusterPlanes();for(var i=this._inverseProjectionMatrix,n=-1,r=0;r<=te.OPTIONS.numLightingCellsX;++r)Si.set(n,0,0,1),Ei.set(n,0,1,1),wi.set(n,1,0,1),i.projectPoint(Si,Si),i.projectPoint(Ei,Ei),i.projectPoint(wi,wi),this._clusterPlanesW[r].planeFromPoints(Si,Ei,wi),n+=t;var s=-1;for(r=0;r<=te.OPTIONS.numLightingCellsY;++r)this._clusterPlanesH[r],Si.set(0,s,0,1),Ei.set(1,s,0,1),wi.set(0,s,1,1),i.projectPoint(Si,Si),i.projectPoint(Ei,Ei),i.projectPoint(wi,wi),this._clusterPlanesH[r].planeFromPoints(Si,Ei,wi),s+=e;this._clusterPlanesDirty=!1}}),Oi.prototype.copyTo=function(t){ei.prototype.copyTo.call(this,t),t.nearDistance=this.nearDistance,t.farDistance=this.farDistance},Oi.prototype.acceptVisitorPost=function(t){ei.prototype.acceptVisitor.call(this,t)},Oi.prototype.acceptVisitor=function(t){},(Ci.prototype=Object.create(Oi.prototype,{verticalFOV:{get:function(){return this._vFOV},set:function(t){this._vFOV!==t&&(this._vFOV=t,this._invalidateProjectionMatrix())}}}))._setAspectRatio=function(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._invalidateProjectionMatrix())},Ci.prototype._setRenderTargetResolution=function(t,e){Oi.prototype._setRenderTargetResolution.call(this,t,e),this._setAspectRatio(t/e)},Ci.prototype._updateProjectionMatrix=function(){this._projectionMatrix.fromPerspectiveProjection(this._vFOV,this._aspectRatio,this._nearDistance,this._farDistance),this._projectionMatrixDirty=!1},Ci.prototype.copyTo=function(t){Oi.prototype.copyTo.call(this,t),t.verticalFOV=this.verticalFOV},Ci.prototype.clone=function(){var t=new Ci;return this.copyTo(t),t},(Fi.prototype=Object.create(ei.prototype)).copyTo=function(t){ei.prototype.copyTo.call(this,t)},Fi.prototype.clone=function(){var t=new Fi(this._meshInstance.material);return this.copyTo(t),t};var Xi,Hi=function(t,e){var i;return 0!==(i=t.material._renderOrder-e.material._renderOrder)?i:0!==(i=t.material._renderOrderHint-e.material._renderOrderHint)?i:t.renderOrderHint-e.renderOrderHint},zi=function(t,e){var i=t.material._renderOrder-e.material._renderOrder;return 0!==i?i:e.renderOrderHint-t.renderOrderHint},Vi=function(t,e){return t.shadowQualityBias-e.shadowQualityBias};function ki(){bi.call(this),this._renderItemPool=new Ui(Bi),this._opaques=[],this._transparents=null,this._camera=null,this._cameraYAxis=new O,this._frustumPlanes=null,this._lights=null,this._ambientColor=new h,this._shadowCasters=null,this._effects=null,this._needsNormalDepth=!1,this._needsBackbuffer=!1,this._numShadowPlanes=0,this._shadowPlaneBuckets=null}function Gi(t,e,i,n,r,s){$e.call(this),this._bounds=new At,this._bounds.clear(Et.EXPANSE_INFINITE),this._terrainSize=t||512,this._minElevation=e,this._maxElevation=i,this._numLevels=n||4,this._container=new Ke,this._detail=s||32;var o=2*Math.ceil(.5*this._detail);this._snapSize=this._terrainSize/this._detail/Math.pow(2,this._numLevels),(this._material=r).setUniform("hx_elevationOffset",e),r.setUniform("hx_elevationScale",i-e),this._initMeshes(o),this._initTree()}function Yi(){this._entityEngine=null,this._sets=[]}function ji(){$e.call(this),this._subs=[]}function Wi(){this._name=null,this._keyFrames=[],this._duration=0,this._looping=!0}function Zi(t){this._clip=t,this._time=0,this._timeScale=1,this._isPlaying=!0,this._currentFrameIndex=0,this._timeChanged=!0,this._looping=t.looping,this.wraps=0,this.frame1=0,this.frame2=0,this.ratio=0}function qi(){this._layers=[],this._time=0,this._timeScale=1,this._name=null,this._looping=!0}function Ki(t,e,i){this._name=null,this._clip=i,this._playhead=new Zi(i),this._targetObject=t,this._propertyName=e}function Ji(){this.position=new O,this.rotation=new N,this.scale=new O(1,1,1),this.skeletonPose=null}function Qi(t,e,i){mt.assert(t[e]instanceof O,"Type mismatch!"),Ki.call(this,t,e,i),this._skeletonPose=t instanceof Ji?t.skeletonPose:null}function $i(t,e,i){mt.assert(t[e]instanceof N,"Type mismatch!"),Ki.call(this,t,e,i),this._skeletonPose=t instanceof Ji?t.skeletonPose:null}function tn(t,e,i){Ki.call(this,t,e,i)}function en(){this._weights={},this._stateInvalid=!0,this._knownTargets=[],this.onChange=new n}function nn(t){$e.call(this),this._morphPose=t||new en}function rn(){this._applyInverseBindPose=!0,this._joints=[],this._name=""}function sn(){this._jointPoses=[],this._skinningTexture=null,this._globalMatrices=null,this._bindMatrices=null,this._skeletonMatricesInvalid=!0}function on(){this._rootJointDeltaPosition=new O,this._pose=new sn,this._name=null}function an(t){on.call(this),this._playhead=new Zi(t),this._rootPosition=new O,this._name=t.name,this._numJoints=t.getKeyFrame(0).value._jointPoses.length;var e=t.getKeyFrame(t.numKeyFrames-1).value._jointPoses[0].position,i=t.getKeyFrame(0).value._jointPoses[0].position;this._clipRootDelta=O.subtract(e,i)}function hn(t,e){this._skeleton=e,this._rootNode=t,this._transferRootJoint=!1,e&&(this.skeleton=e)}function _n(t){$e.call(this),t instanceof Wi&&(t=new an(t)),this._blendTree=new hn(t)}function ln(){on.call(this),this._value=0,this._child1=null,this._child2=null,this._minValue=0,this._maxValue=1,this._numJoints=0,this._t=0,this._valueChanged=!1}function un(t){on.call(this),this._skeleton=t,this._poseInvalid=!0,this._pose.copyBindPose(t),this._poseLookUp={};for(var e=0;e<t.numJoints;++e){var i=t.getJoint(e);this._poseLookUp[i.name]=this._pose._jointPoses[e]}}function cn(){this.name=null,this.parentIndex=-1,this.inverseBindPose=new F}function dn(){on.call(this),this._children=[],this._numJoints=0,this._clips={}}function fn(){Oi.call(this),this._left=-1,this._right=1,this._top=1,this._bottom=-1}function pn(){$e.call(this),this._speed=1,this._speedMultiplier=2,this._localVelocity=new O(0,0,0,0),this._localAcceleration=new O(0,0,0,0),this._pitch=0,this._yaw=0,this._mouseX=0,this._mouseY=0,this._friction=5,this._maxAcceleration=this._speed,this._maxVelocity=this._speed,this._onKeyDown=null,this._onKeyUp=null}function mn(t){$e.call(this),this._coords=new O(.5*-Math.PI,.4*Math.PI,1,0),this._localAcceleration=new O(0,0,0,0),this._localVelocity=new O(0,0,0,0),this.touchZoomSpeed=.01,this.zoomSpeed=1,this.maxRadius=4,this.minRadius=.1,this.dampen=.9,this.lookAtTarget=t||new O(0,0,0,1),this._oldMouseX=0,this._oldMouseY=0,this._isDown=!1}function gn(t){this._dataView=t,this._offset=0,this._endian=gn.LITTLE_ENDIAN}function xn(t,e){var i=new gt(t=t||d.get("default_post_vertex.glsl"),e);$t.call(this,i),this._vertexLayout=null,this._cullMode=Ae.NONE,this._depthTest=Me.DISABLED,this._writeDepth=!1,this.setMesh(It.DEFAULT),this.setTexture("hx_dither2D",Te.DEFAULT_2D_DITHER_TEXTURE)}function vn(t){t=Math.floor(t),this._initWeights(t);var e={RADIUS:t,NUM_WEIGHTS:t+1},i=d.get("gaussian_blur_vertex.glsl",e),n=d.get("gaussian_blur_fragment.glsl",e);xn.call(this,i,n),this.setUniformArray("gaussianWeights",new Float32Array(this._weights))}function yn(){$e.call(this),this._isSupported=!0,this._mesh=null,this._outputsGamma=!1,this._needsNormalDepth=!1}function Tn(t,e,i,n){yn.call(this),this._downScale=i||4,this._targetWidth=-1,this._targetHeight=-1,t=t||100,t/=this._downScale,this._thresholdPass=new xn(null,d.get("bloom_threshold_fragment.glsl")),this._compositePass=new xn(d.get("bloom_composite_vertex.glsl"),d.get("bloom_composite_fragment.glsl")),this._blurPass=new vn(t),this._blurSourceSlot=this._blurPass.getTextureSlot("sourceTexture"),this._thresholdWidth=-1,this._thresholdHeight=-1,this._thresholdMaps=[],this._smallFBOs=[];for(var r=0;r<2;++r)this._thresholdMaps[r]=new Dt,this._thresholdMaps[r].filter=Ee.BILINEAR_NOMIP,this._thresholdMaps[r].wrapMode=we.CLAMP,this._smallFBOs[r]=new Ft([this._thresholdMaps[r]]);this._anisotropy=n||1,this._strength=void 0===e?1:e,Se.EXT_HALF_FLOAT_TEXTURES_LINEAR&&Se.EXT_HALF_FLOAT_TEXTURES?this.thresholdLuminance=te.OPTIONS.hdr:this.thresholdLuminance=.9,this._compositePass.setTexture("bloomTexture",this._thresholdMaps[0]),this.strength=this._strength}function Sn(t,e){e||(e=t),yn.call(this),this._blurPass=new vn(e),this._blurSourceSlot=this._blurPass.getTextureSlot("sourceTexture"),this._radius=e,this._numSamples=t}function En(){xn.call(this,null,d.get("copy_fragment.glsl"))}function wn(t){if(this._adaptive=void 0!==t&&t,this._adaptive&&(!Se.EXT_SHADER_TEXTURE_LOD||!Se.EXT_COLOR_BUFFER_HALF_FLOAT))return console.log("Warning: adaptive tone mapping not supported, using non-adaptive"),void(this._adaptive=!1);yn.call(this),this._toneMapPass=this._createToneMapPass(),this._adaptive&&(this._extractLuminancePass=new xn(null,d.get("tonemap_reference_fragment.glsl")),this._extractLuminancePass.blendState=new Ct(Re.CONSTANT_ALPHA,Re.ONE_MINUS_CONSTANT_ALPHA,be.ADD,new h(1,1,1,1)),this._luminanceMap=new Dt,this._luminanceMap.initEmpty(256,256,Ne.RGBA,Se.EXT_HALF_FLOAT_TEXTURES.HALF_FLOAT_OES),this._luminanceFBO=new Ft(this._luminanceMap),this._luminanceFBO.init(),this._adaptationRate=500,this._toneMapPass.setTexture("hx_luminanceMap",this._luminanceMap),this._toneMapPass.setUniform("hx_luminanceMipLevel",I.log2(this._luminanceMap._width))),this.key=.25,this.exposure=0}function An(t){wn.call(this,t),this._outputsGamma=!0}function Pn(t,e,i,n){yn.call(this),this._fogPass=new xn(d.get("fog_vertex.glsl"),d.get("fog_fragment.glsl")),this.needsNormalDepth=!0,this.density=void 0===t?.001:t,this._tint=new h(1,1,1,1),void 0!==e&&(this.tint=e),this.startDistance=void 0===n?0:n,this.heightFallOff=void 0===i?.01:i}function Mn(){yn.call(this),this._pass=new xn(null,d.get("fxaa_fragment.glsl")),this._pass.setUniform("edgeThreshold",.25),this._pass.setUniform("edgeThresholdMin",1/16),this._pass.setUniform("edgeSharpness",100)}function Ln(t,e){32<(t=t||4)&&(t=32),32<(e=e||4)&&(e=32),this._numRays=t,this._numSamplesPerRay=e,this._strength=1,this._bias=.1,this._fallOffDistance=1,this._radius=.5,this._scale=.5,this._sampleDirTexture=null,this._ditherTexture=null,yn.call(this)}function Rn(t){64<(t=t||16)&&(t=64),this._numSamples=t,this._strength=1,this._fallOffDistance=1,this._radius=.5,this._scale=.5,this._ditherTexture=null,yn.call(this)}function bn(t){wn.call(this,t)}ki.MAX_SHADOW_QUALITY_BUCKETS=4,(ki.prototype=Object.create(bi.prototype,{numShadowPlanes:{get:function(){return this._numShadowPlanes}},shadowPlaneBuckets:{get:function(){return this._shadowPlaneBuckets}},ambientColor:{get:function(){return this._ambientColor}},needsNormalDepth:{get:function(){return this._needsNormalDepth}},needsBackbuffer:{get:function(){return this._needsBackbuffer}}})).getOpaqueRenderList=function(t){return this._opaques[t]},ki.prototype.getTransparentRenderList=function(){return this._transparents},ki.prototype.getLights=function(){return this._lights},ki.prototype.getShadowCasters=function(){return this._shadowCasters},ki.prototype.getEffects=function(){return this._effects},ki.prototype.collect=function(t,e){(this._camera=t).worldMatrix.getColumn(1,this._cameraYAxis),this._frustumPlanes=t.frustum._planes,this._reset(),e.acceptVisitor(this);for(var i=0;i<fi.NUM_PATHS;++i)this._opaques[i].sort(Hi);this._transparents.sort(zi),this._shadowCasters.sort(Vi),this._camera.acceptVisitorPost(this)},ki.prototype.qualifies=function(t){return t.hierarchyVisible&&t.worldBounds.intersectsConvexSolid(this._frustumPlanes,6)},ki.prototype.visitScene=function(t){var e=t._skybox;e&&this.visitMeshInstance(e._meshInstance)},ki.prototype.visitEffect=function(t){this._needsNormalDepth=this._needsNormalDepth||t._needsNormalDepth,this._effects.push(t)},ki.prototype.visitMeshInstance=function(t){if(t.enabled){var e=t.entity,i=e.worldBounds,n=this._cameraYAxis,r=n.x,s=n.y,o=n.z,a=t.skeleton,h=t.skeletonMatrices,_=this._renderItemPool,l=this._camera,u=this._opaques,c=this._transparents,d=t.material,f=d.renderPath;this._needsNormalDepth=this._needsNormalDepth||d._needsNormalDepth,this._needsBackbuffer=this._needsBackbuffer||d._needsBackbuffer;var p=_.getItem();p.material=d,p.meshInstance=t,p.skeleton=a,p.skeletonMatrices=h;var m=i._center;p.renderOrderHint=m.x*r+m.y*s+m.z*o,p.worldMatrix=e.worldMatrix,p.camera=l,p.worldBounds=i,(d.blendState||d._needsBackbuffer?c:u[f]).push(p)}},ki.prototype.visitAmbientLight=function(t){var e=t._scaledIrradiance;this._ambientColor.r+=e.r,this._ambientColor.g+=e.g,this._ambientColor.b+=e.b},ki.prototype.visitLight=function(t){if(this._lights.push(t),t._castShadows){this._shadowCasters.push(t),this._numShadowPlanes+=t.numAtlasPlanes;var e=t.shadowQualityBias;this._shadowPlaneBuckets[e]+=t.numAtlasPlanes}},ki.prototype._reset=function(){this._renderItemPool.reset();for(var t=0;t<fi.NUM_PATHS;++t)this._opaques[t]=[];for(this._transparents=[],this._lights=[],this._shadowCasters=[],this._effects=[],this._needsNormalDepth=te.OPTIONS.ambientOcclusion,this._ambientColor.set(0,0,0,1),this._numShadowPlanes=0,this._shadowPlaneBuckets=[],t=0;t<ki.MAX_SHADOW_QUALITY_BUCKETS;++t)this._shadowPlaneBuckets[t]=0},$e.create(Gi,{terrainSize:{get:function(){return this._terrainSize}}}),Gi.prototype.onAdded=function(){this._entity.attach(this._container)},Gi.prototype.onRemoved=function(){this._entity.detach(this._container)},Gi.prototype._createMesh=function(t,e,i,n){var r=1/e,s=new Lt,o=t*r,a=.5*o;s.addVertexAttribute("hx_position",3),s.addVertexAttribute("hx_normal",3),s.addVertexAttribute("hx_cellSize",1);for(var h=[],_=[],l=i?e-1:e,u=e+1,c=0;c<=l;++c)for(var d=(c*r-.5)*t,f=0;f<=e;++f){var p=(f*r-.5)*t,m=n||f!==e||c!==e?o:a;if(h.push(p,d,0,0,0,1,m),f!==e&&c!==l){var g=f+c*u;_.push(g,g+u+1,g+u),_.push(g,g+1,g+u+1)}}var x=h.length/7;if(i)for(d=(e*r-.5)*t,f=0;f<=e;++f)p=(f*r-.5)*t,h.push(p,d,0,0,0,1),h.push(a),f!==e&&(g=f+l*u,h.push(p+a,d,0,0,0,1,a),_.push(g,x+2*f+1,x+2*f),_.push(g+1,x+2*f+1,g),_.push(x+2*f+2,x+2*f+1,g+1));return s.setVertexData(h,0),s.setIndexData(_),s.dynamicBounds=!1,s.bounds.clear(),s.bounds.growToIncludeMinMax(new O(-t,-t,this._minElevation),new O(t,t,this._maxElevation)),s},Gi.prototype._initMeshes=function(t){this._meshes=[];for(var e=.25*this._terrainSize,i=0;i<this._numLevels;++i){if(i===this._numLevels-1){var n=this._createMesh(e,t,!1,!0);this._meshes[i]={edge:n,corner:n}}else this._meshes[i]={edge:this._createMesh(e,t,!0,!1),corner:this._createMesh(e,t,!1,!1)};e*=.5}},Gi.prototype._initTree=function(){for(var t=.25*this._terrainSize,e=0;e<4;++e)for(var i=this._terrainSize*(e/4-.5)+.5*t,n=0;n<4;++n){var r=this._terrainSize*(n/4-.5)+.5*t,s=0,o=0;if(1===n?s=1:2===n&&(s=-1),1===e?o=1:2===e&&(o=-1),s&&o)this._subDivide(r,i,s,o,1,.5*t);else{var a=0,h="edge";n%3==e%3?(h="corner",0===n&&0===e&&(a=0),0===n&&3===e&&(a=1),3===n&&3===e&&(a=2),3===n&&0===e&&(a=-1)):(3===e&&(a=2),3===n&&(a=-1),0===n&&(a=1)),this._addMesh(r,i,0,a,h)}}},Gi.prototype._addMesh=function(t,e,i,n,r){var s=new ei,o=new HX.MeshInstance(this._meshes[i][r],this._material);s.addComponent(o),s.position.set(t,e,0),s.rotation.fromAxisAngle(O.Z_AXIS,-n*Math.PI*.5),this._container.attach(s)},Gi.prototype._subDivide=function(t,e,i,n,r,s){s*=.5;for(var o=-1;o<=1;o+=2)for(var a=-1;a<=1;a+=2)if(a!==i||o!==n||r===this._numLevels-1){var h=0,_="corner";t<0&&e<0?a<0&&0<o?(_="edge",h=1):(0<a&&o<0&&(_="edge"),h=0):0<t&&0<e?0<a&&o<0?(_="edge",h=-1):(a<0&&0<o&&(_="edge"),h=2):t<0&&0<e?0<a&&0<o?(_="edge",h=2):(a<0&&o<0&&(_="edge"),h=1):0<t&&e<0&&(a<0&&o<0?(_="edge",h=0):(0<a&&0<o&&(_="edge"),h=-1)),this._addMesh(t+s*a,e+s*o,r,h,_)}r<this._numLevels-1&&this._subDivide(t+s*i,e+s*n,i,n,r+1,s)},Gi.prototype.onUpdate=function(){if(this._camera){var t=this._camera.position,e=this._container.position,i=this._entity.position;e.x=Math.round(t.x/this._snapSize)*this._snapSize-i.x,e.y=Math.round(t.y/this._snapSize)*this._snapSize-i.y}},Gi.prototype.acceptVisitor=function(t){t instanceof ki&&(this._camera=t._camera)},Gi.prototype.clone=function(){return new Gi(this._terrainSize,this._minElevation,this._maxElevation,this._numLevels,this._material,this._detail)},Yi.prototype={onStarted:function(){},onStopped:function(){},onUpdate:function(t){},getEntitySet:function(t){var e=this._entityEngine.getEntitySet(t);return this._sets.push(e),e},_onStarted:function(t){this._entityEngine=t,this.onStarted()},_onStopped:function(){for(var t=0;t<this._sets;++t)this._sets[t].free();this._sets=[]}},$e.create(ji),ji.prototype.addComponent=function(t){if(t._entity)throw new Error("Component already added to an entity!");this._subs.push(t)},ji.prototype.removeComponent=function(t){var e=this._subs.indexOf(t);0<=e&&this._subs.splice(e,1)},ji.prototype.onAdded=function(){for(var t=0;t<this._subs.length;++t){var e=this._subs[t];e._entity=this._entity,e.onAdded()}},ji.prototype.onRemoved=function(){for(var t=0;t<this._subs.length;++t){var e=this._subs[t];e.onRemoved(),e._entity=null}},ji.prototype.onUpdate=function(t){for(var e=this._subs.length,i=0;i<e;++i){this._subs[i].onUpdate(t)}},ji.prototype.clone=function(){for(var t=new ji,e=0;e<this._subs.length;++e)t.addComponent(this._subs[e].clone());return t},Wi.prototype={get looping(){return this._looping},set looping(t){this._looping=t},get name(){return this._name},set name(t){this._name=t},get numKeyFrames(){return this._keyFrames.length},get duration(){return this._duration},addKeyFrame:function(t){this._keyFrames.push(t),t.time>this._duration&&(this._duration=t.time)},sortKeyFrames:function(){this._keyFrames.sort(function(t,e){return t.time-e.time})},getKeyFrame:function(t){return this._keyFrames[t]},toString:function(){return"[AnimationClip(name="+this.name+")"}},Zi.prototype={get timeScale(){return this._timeScale},set timeScale(t){this._timeScale=t},get looping(){return this._looping},set looping(t){this._looping=t},get time(){return this._time},set time(t){this._looping||(t=I.clamp(t,0,this._clip.duration)),this._time!==t&&(this._time=t,this._timeChanged=!0)},play:function(){this._isPlaying=!0},stop:function(){this._isPlaying=!1},update:function(t){if(!(this._isPlaying&&0!==t)&&!this._timeChanged)return!1;this._timeChanged=!1,this._isPlaying&&(t*=this._timeScale,this._time+=t);var e,i,n=this._clip,r=n.numKeyFrames,s=r-1,o=n.duration,a=0;if(this._looping||(this._time>o?(this._time=o,this._isPlaying=!1):this._time<0&&(this._time=0,this._isPlaying=!1)),0<=t){for(;this._looping&&this._time>=o;)this._currentFrameIndex=0,this._time-=o,++a;for(;++this._currentFrameIndex===r&&(this._currentFrameIndex=0),(i=n.getKeyFrame(this._currentFrameIndex)).time<this._time;);--this._currentFrameIndex,e=n.getKeyFrame(this._currentFrameIndex)}else{for(;this._looping&&this._time<0;)this._currentFrameIndex=s,this._time+=o,++a;for(++this._currentFrameIndex;--this._currentFrameIndex<0&&(this._currentFrameIndex=r),(e=n.getKeyFrame(this._currentFrameIndex)).time>this._time;);}return this.wraps=a,this.frame1=e,this.frame2=i,this.ratio=(this._time-e.time)/(i.time-e.time),!0}},qi.prototype={get name(){return this._name},set name(t){this._name=t},get timeScale(){return this._timeScale},set timeScale(t){this._timeScale=t},get time(){return this._time},set time(t){this._time=t;for(var e=0;e<this._layers.length;++e)this._layers[e].time=t},get looping(){return this._looping},set looping(t){this._looping=t;for(var e=0;e<this._layers.length;++e)this._layers[e].looping=!0},addLayer:function(t){this._layers.push(t),t.time=this._time,t.looping=this._looping},removeLayer:function(t){var e=this._layers.indexOf(t);0<=e&&this._layers.splice(e,1)},play:function(){ee.bind(this._update,this)},stop:function(){ee.unbind(this._update)},_update:function(t){t*=this._timeScale,this._time+=t;for(var e=this._layers.length,i=0;i<e;++i)this._layers[i].update(t)}},Ki.prototype={get looping(){return this._playhead.looping},set looping(t){this._playhead.looping=t},get time(){return this._playhead.time},set time(t){this._playhead.time=t},get duration(){return this._clip.duration},getKeyFrame:function(t){return this._clip.getKeyFrame(t)},update:function(t){},toString:function(){return"[AnimationLayer(name="+this.name+")"}},Ji.prototype={copyFrom:function(t){this.rotation.copyFrom(t.rotation),this.position.copyFrom(t.position),this.scale.copyFrom(t.scale)},toString:function(){return"[SkeletonJointPose]"}},(Qi.prototype=Object.create(Ki.prototype)).update=function(t){var e=this._playhead;e.update(t)&&(this._targetObject[this._propertyName].lerp(e.frame1.value,e.frame2.value,e.ratio),this._skeletonPose&&this._skeletonPose.invalidateGlobalPose())},($i.prototype=Object.create(Ki.prototype)).update=function(t){var e=this._playhead;e.update(t)&&(this._targetObject[this._propertyName].slerp(e.frame1.value,e.frame2.value,e.ratio),this._skeletonPose&&this._skeletonPose.invalidateGlobalPose())},(tn.prototype=Object.create(Ki.prototype)).update=function(t){var e=this._playhead;if(e.update(t)){var i=I.lerp(e.frame1.value,e.frame2.value,e.ratio);this._targetObject.setWeight(this._propertyName,i)}},en.prototype={getWeight:function(t){return this._weights[t]},getMorphTargetName:function(t){return this._knownTargets[t]},setWeight:function(t,e){var i=this._weights[t];i!==e&&(void 0===i&&this._knownTargets.push(t),this._stateInvalid=!0,this._weights[t]=e)},update:function(){if(this._stateInvalid){var i=this._weights;this._knownTargets.sort(function(t,e){return i[e.name]-i[t.name]}),this._stateInvalid=!1,this.onChange.dispatch()}},clone:function(){var t=new en;for(var e in this._weights)t.setWeight(e,this._weights[e]);return t}},$e.create(nn,{morphPose:{get:function(){return this._morphPose},set:function(t){this._morphPose=t,this._assignMorphPose(t)}}}),nn.prototype.setWeight=function(t,e){this._morphPose.setWeight(t,e)},nn.prototype.onAdded=function(){this._assignMorphPose(this._morphPose)},nn.prototype.onRemoved=function(){this._assignMorphPose(null)},nn.prototype.onUpdate=function(t){this._morphPose.update()},nn.prototype._assignMorphPose=function(t){for(var e=this.entity.getComponentsByType(ti),i=0,n=e.length;i<n;++i)e[i].morphPose=t},nn.prototype.clone=function(){return new nn(this._morphPose.clone())},rn.prototype={get applyInverseBindPose(){return this._applyInverseBindPose},set applyInverseBindPose(t){this._applyInverseBindPose=t},get numJoints(){return this._joints.length},addJoint:function(t){this._joints.push(t)},getJoint:function(t){return this._joints[t]},get name(){return this._name},set name(t){this._name=t},toString:function(){return"[Skeleton(name="+this.name+")"}},sn.prototype={get numJoints(){return this._jointPoses.length},getJointPose:function(t){return this._jointPoses[t]},setJointPose:function(t,e){(this._jointPoses[t]=e).skeletonPose=this},invalidateGlobalPose:function(){this._skeletonMatricesInvalid=!0},interpolate:function(t,e,i){t=t._jointPoses,e=e._jointPoses;var n=t.length;this._jointPoses.length!==n&&this._initJointPoses(n);for(var r=this._jointPoses,s=0;s<n;++s){var o=r[s];o.rotation.slerp(t[s].rotation,e[s].rotation,i),o.position.lerp(t[s].position,e[s].position,i),o.scale.lerp(t[s].scale,e[s].scale,i)}},copyBindPose:function(t){for(var e=new F,i=0;i<t.numJoints;++i){var n=t.getJoint(i),r=this._jointPoses[i]=new Ji;e.inverseAffineOf(n.inverseBindPose),0<=n.parentIndex&&e.append(t.getJoint(n.parentIndex).inverseBindPose),e.decompose(r)}},copyFrom:function(t){t=t._jointPoses;var e=this._jointPoses,i=t.length;this._jointPoses.length!==i&&this._initJointPoses(i);for(var n=0;n<i;++n)e[n].copyFrom(t[n])},_initJointPoses:function(t){this._numJoints=t,this._jointPoses.length=t;for(var e=0;e<t;++e)this.setJointPose(e,new Ji)},getBindMatrices:function(t){return(this._skeletonMatricesInvalid||this._skeleton!==t)&&this._updateSkeletonMatrices(t),this._skeleton=t,this._skinningTexture||this._bindMatrices},_generateDefault:function(t){this._skeletonMatricesInvalid=!1,this._skeleton=t,this._initJointPoses(t.numJoints);for(var e=new HX.Matrix4x4,i=0;i<this._jointPoses.length;++i)e.inverseOf(t.getJoint(i).inverseBindPose),e.decompose(this._jointPoses[i]);if(te.OPTIONS.useSkinningTexture)this._skinningTexture=Te.DEFAULT_SKINNING_TEXTURE;else for(this._globalMatrices=[],this._bindMatrices=[],i=0;i<t.numJoints;++i)this._globalMatrices[i]=new F,this._bindMatrices[i]=new F},_updateSkeletonMatrices:function(t){var e=this._globalMatrices,i=this._bindMatrices;e&&e.length===t.numJoints||(this._generateGlobalSkeletonData(t),e=this._globalMatrices,i=this._bindMatrices);for(var n=t.numJoints,r=0;r<n;++r){var s=this._jointPoses[r],o=e[r],a=t.getJoint(r),h=a.parentIndex;o.compose(s),-1!==h&&o.append(e[h]),t._applyInverseBindPose?i[r].multiplyAffine(o,a.inverseBindPose):i[r].copyFrom(o)}te.OPTIONS.useSkinningTexture&&this._updateSkinningTexture()},_generateGlobalSkeletonData:function(t){this._globalMatrices=[],this._bindMatrices=[];for(var e=0;e<t.numJoints;++e)this._globalMatrices[e]=new F,this._bindMatrices[e]=new F;te.OPTIONS.useSkinningTexture&&(this._skinningTexture=new Dt,this._skinningTexture.filter=Ee.NEAREST_NOMIP,this._skinningTexture.wrapMode=we.CLAMP)},_updateSkinningTexture:function(){Xi=Xi||new Float32Array(3*te.OPTIONS.maxSkeletonJoints*4);for(var t=this._bindMatrices,e=t.length,i=0,n=0;n<3;++n){for(var r=0;r<e;++r){var s=t[r]._m;Xi[i++]=s[n],Xi[i++]=s[n+4],Xi[i++]=s[n+8],Xi[i++]=s[n+12]}for(r=e;r<te.OPTIONS.maxSkeletonJoints;++r)Xi[i++]=0,Xi[i++]=0,Xi[i++]=0,Xi[i++]=0}this._skinningTexture.uploadData(Xi,te.OPTIONS.maxSkeletonJoints,3,!1,Ne.RGBA,De.FLOAT)},clone:function(){var t=new sn;return t.copyFrom(this),t}},on.prototype={get name(){return this._name},set name(t){this._name=t},findNode:function(t){return this._name===t?this:this._queryChildren(t)},update:function(t,e){},get rootJointDeltaPosition(){return this._rootJointDeltaPosition},get numJoints(){return-1},_queryChildren:function(t){throw new Error("Abstract method called!")}},(an.prototype=Object.create(on.prototype,{numJoints:{get:function(){return this._numJoints}},looping:{get:function(){return this._playhead._looping},set:function(t){this._playhead.looping=t}},duration:{get:function(){return this._clip.duration}},timeScale:{get:function(){return this._playhead.timeScale},set:function(t){this._playhead.timeScale=t}},time:{get:function(){return this._playhead.time},set:function(t){this._playhead.time=t,this._timeChanged=!0}}})).play=function(){this._animationClipPlayer.play()},an.prototype.stop=function(){this._animationClipPlayer.stop()},an.prototype.update=function(t,e){if(!this._playhead.update(t))return!1;var i=this._playhead;return this._pose.interpolate(i.frame1.value,i.frame2.value,i.ratio),e&&this._transferRootJointTransform(i.wraps,t),!0},an.prototype._transferRootJointTransform=function(t,e){var i=this._pose._jointPoses[0].position,n=this._rootPosition,r=this._rootJointDeltaPosition;O.subtract(i,n,r),0<e&&0<t?r.addScaled(this._clipRootDelta,t):e<0&&0<t&&r.addScaled(this._clipRootDelta,-t),this._rootPosition.copyFrom(i),i.set(0,0,0)},an.prototype._queryChildren=function(t){return null},hn.prototype={get transferRootJoint(){return this._transferRootJoint},set transferRootJoint(t){this._transferRootJoint=t},get skeleton(){return this._skeleton},set skeleton(t){this._skeleton=t},get skeletonPose(){return this._rootNode._pose},get rootJointDeltaPosition(){return this._rootNode.rootJointDeltaPosition},get rootNode(){return this._rootNode},set rootNode(t){this._rootNode=t},update:function(t){var e=this._rootNode.update(t,this._transferRootJoint);return e&&this._rootNode._pose.invalidateGlobalPose(),e},getNode:function(t){return this._rootNode.findNode(t)}},$e.create(_n,{transferRootJoint:{get:function(){return this._blendTree.transferRootJoint},set:function(t){this._blendTree.transferRootJoint=t}},applyInverseBindPose:{get:function(){return this._blendTree.applyInverseBindPose},set:function(t){this._blendTree.applyInverseBindPose=t}},animationNode:{get:function(){return this._blendTree.rootNode},set function(t){this._blendTree.rootNode=t,this._entity&&(this._blendTree.skeleton=this._entity.skeleton)}}}),_n.prototype.onAdded=function(){this._blendTree.skeleton=this._entity.skeleton,this._entity.skeletonPose=this._blendTree.skeletonPose},_n.prototype.onUpdate=function(t){if(this._blendTree.update(t)){var e=this._entity.matrix,i=this._blendTree.rootJointDeltaPosition;e.prependTranslation(i),this._entity.matrix=e,this._entity.skeletonPose=this._blendTree.skeletonPose}},_n.prototype.getNode=function(t){return this._blendTree.getNode(t)},_n.prototype.clone=function(){var t=new _n(this._blendTree.rootNode);return t.transferRootJoint=this.transferRootJoint,t.applyInverseBindPose=this.applyInverseBindPose,t},(ln.prototype=Object.create(on.prototype,{numJoints:{get:function(){return this._numJoints}},minValue:{get:function(){return this._minValue},set:function(t){this._minValue=t}},maxValue:{get:function(){return this._maxValue},set:function(t){this._maxValue=t}},value:{get:function(){return this._value},set:function(t){t=I.clamp(t,this._minValue,this._maxValue),this._value!==t&&(this._valueChanged=!0),this._value=t,this._t=(this._value-this._minValue)/(this._maxValue-this._minValue)}},child1:{get:function(){return this._child1},set:function(t){if(this._child1=t,this._child2&&t.numJoints!==this._child2.numJoints)throw new Error("Incompatible child nodes (numJoints mismatch)!");this._numJoints=t.numJoints}},child2:{get:function(){return this._child2},set:function(t){if(this._child2=t,this._child1&&t.numJoints!==this._child1.numJoints)throw new Error("Incompatible child nodes (numJoints mismatch)!")}}})).update=function(t,e){var i=this._child1.update(t,e);i=(i=this._child2.update(t,e)||i)||this._valueChanged;var n=this._t;return i&&(.999<n?this._pose.copyFrom(this._child1._pose):n<.001?this._pose.copyFrom(this._child2._pose):this._pose.interpolate(this._child1._pose,this._child2._pose,this._t),this._valueChanged=!1),i},ln.prototype._queryChildren=function(t){return this._child1.findNode(t)||this._child2.findNode(t)},(un.prototype=Object.create(on.prototype,{numJoints:{get function(){return this._skeleton.numJoints}}})).update=function(t){var e=this._poseInvalid;return this._poseInvalid=!1,e},un.prototype.setJointRotation=function(t,e){this._getJointPose(t).rotation.copyFrom(e),this._poseInvalid=!0},un.prototype.setJointTranslation=function(t,e){this._getJointPose(t).position.copyFrom(e),this._poseInvalid=!0},un.prototype.setJointScale=function(t,e){this._getJointPose(t).scale.copyFrom(e),this._poseInvalid=!0},un.prototype._getJointPose=function(t){return t instanceof String?this._poseLookUp[t]:this._pose._jointPoses[t]},un.prototype._queryChildren=function(t){return null},cn.prototype={toString:function(){return"[SkeletonJoint]"}},(dn.prototype=Object.create(on.prototype,{numJoints:{get:function(){return this._numJoints}}})).addClip=function(t){this._clips[t.name]=t},dn.prototype.fadeTo=function(t,e,i){0===e&&!1===t.looping&&(this._children=[]),t instanceof String?t=new an(this._clips[t]):t instanceof Wi&&(t=new an(t)),this._numJoints=t.numJoints,this._children.unshift({node:t,weight:0===e?1:0,fadeSpeed:0===e?1e4:1/e,sync:i})},dn.prototype.update=function(t,e){var i=this._children.length,n=0,r=0,s=void 0;for(u=i-1;0<=u;--u){var o=this._children[u],a=o.node;o.sync&&(s=s||o,n+=o.node.duration*o.weight,r+=o.weight)}if(0!==r&&(n/=r),s)var h=s.duration/n,_=(s.time+t*h)/s.duration;for(var l=1<i&&0<t,u=0;u<i;++u){a=(o=this._children[u]).node,o.sync?(a.time=a.duration*_,l=a.update(0,e)||l):l=a.update(t,e)||l;var c=o.weight+t*o.fadeSpeed;if(!1===a.looping){var d=(a.duration-a.time)*o.fadeSpeed;d<=1&&(c*=d,d<.001&&1!==i&&(--i,this._children.splice(u--,1)))}if(.999<c&&!1!==a.looping){o.weight=1,this._children.splice(u+1);break}o.weight=c}if(!l)return!1;var f=this._children.length-1;a=this._children[f].node;var p=this._rootJointDeltaPosition,m=this._pose;for(m.copyFrom(a._pose),e&&p.copyFrom(a._rootJointDeltaPosition),u=f-1;0<=u;--u)a=(o=this._children[u]).node,e&&p.lerp(p,a._rootJointDeltaPosition,o.weight),m.interpolate(m,a._pose,o.weight);return!0},an.prototype._queryChildren=function(t){return null},(fn.prototype=Object.create(Oi.prototype)).setBounds=function(t,e,i,n){this._left=t,this._right=e,this._top=i,this._bottom=n,this._invalidateProjectionMatrix()},fn.prototype._updateProjectionMatrix=function(){this._projectionMatrix.fromOrthographicOffCenterProjection(this._left,this._right,this._top,this._bottom,this._nearDistance,this._farDistance),this._projectionMatrixDirty=!1},fn.prototype.copyTo=function(t){Oi.prototype.copyTo.call(this,t),t.setBounds(this._left,this._right,this._top,this._bottom)},fn.prototype.clone=function(){var t=new fn;return this.copyTo(t),t},$e.create(pn,{speed:{get:function(){return this._speed},set:function(t){this._speed=t,this._maxAcceleration=t,this._maxVelocity=t}},shiftMultiplier:{get:function(){return this._speedMultiplier},set:function(t){this._speedMultiplier=t}},pitch:{get:function(){return this._pitch},set:function(t){this._pitch=t}},yaw:{get:function(){return this._yaw},set:function(t){this._yaw=t}},friction:{get:function(){return this._friction},set:function(t){this._friction=t}}}),pn.prototype.onAdded=function(t){var e=this;this._onKeyDown=function(t){switch("which"in t?t.which:t.keyCode){case 16:e._maxVelocity=e._speed*e._speedMultiplier,e._maxAcceleration=e._speed*e._speedMultiplier;break;case 87:e._setForwardForce(1);break;case 83:e._setForwardForce(-1);break;case 65:e._setStrideForce(-1);break;case 68:e._setStrideForce(1)}},this._onKeyUp=function(t){switch("which"in t?t.which:t.keyCode){case 16:e._maxVelocity=e._speed,e._maxAcceleration=e._speed;break;case 87:case 83:e._setForwardForce(0);break;case 65:case 68:e._setStrideForce(0)}},this._onMouseMove=function(t){t=t||window.event,e._addPitch((e._mouseY-t.clientY)/100),e._addYaw(-(e._mouseX-t.clientX)/100),e._mouseX=t.clientX,e._mouseY=t.clientY},this._onMouseDown=function(t){e._mouseX=t.clientX,e._mouseY=t.clientY,te.TARGET_CANVAS.addEventListener("mousemove",e._onMouseMove)},this._onMouseUp=function(t){te.TARGET_CANVAS.removeEventListener("mousemove",e._onMouseMove)},document.addEventListener("keydown",this._onKeyDown),document.addEventListener("keyup",this._onKeyUp),te.TARGET_CANVAS.addEventListener("mousedown",this._onMouseDown),te.TARGET_CANVAS.addEventListener("mouseup",this._onMouseUp)},pn.prototype.onRemoved=function(t){document.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("keyup",this._onKeyUp),te.TARGET_CANVAS.removeEventListener("mousemove",this._onMouseMove),te.TARGET_CANVAS.removeEventListener("mousedown",this._onMouseDown),te.TARGET_CANVAS.removeEventListener("mouseup",this._onMouseUp)},pn.prototype.onUpdate=function(t){var e=.001*t,i=O.scale(this._localVelocity,this._friction*e);this._localVelocity.subtract(i);var n=O.scale(this._localAcceleration,this._maxAcceleration*e);this._localVelocity.add(n);var r=this._localVelocity.length;r>this._maxVelocity&&this._localVelocity.scale(this._maxVelocity/r),this._pitch<.5*-Math.PI?this._pitch=.5*-Math.PI:this._pitch>.5*Math.PI&&(this._pitch=.5*Math.PI);var s=this.entity.matrix,o=s.getColumn(3),a=O.scale(this._localVelocity,e);s.fromRotationPitchYawRoll(this._pitch,this._yaw,0),s.prependTranslation(a),s.appendTranslation(o),this.entity.matrix=s},pn.prototype._setForwardForce=function(t){this._localAcceleration.y=t*this._maxAcceleration},pn.prototype._setStrideForce=function(t){this._localAcceleration.x=t*this._maxAcceleration},pn.prototype._addPitch=function(t){this._pitch+=t},pn.prototype._addYaw=function(t){this._yaw+=t},pn.prototype.clone=function(){var t=new pn;return t.speed=this.speed,t.shiftMultiplier=this.shiftMultiplier,t.pitch=this.pitch,t.yaw=this.yaw,t.friction=this.friction,t},$e.create(mn,{radius:{get:function(){return this._coords.z},set:function(t){this._coords.z=t}},azimuth:{get:function(){return this._coords.x},set:function(t){this._coords.x=t}},polar:{get:function(){return this._coords.y},set:function(t){this._coords.y=t}}}),mn.prototype.onAdded=function(){var _=this;this._onMouseWheel=function(t){var e=t.detail?-120*t.detail:t.wheelDelta;_.setZoomImpulse(-e*_.zoomSpeed*1e-4)},this._onMouseDown=function(t){_._oldMouseX=void 0,_._oldMouseY=void 0,_._isDown=!0},this._onMouseMove=function(t){_._isDown&&_._updateMove(t.screenX,t.screenY)},this._onTouchDown=function(t){if(_._oldMouseX=void 0,_._oldMouseY=void 0,2===t.touches.length){var e=t.touches[0],i=t.touches[1],n=e.screenX-i.screenX,r=e.screenY-i.screenY;_._startPitchDistance=Math.sqrt(n*n+r*r),_._startZoom=_.radius}_._isDown=!0},this._onTouchMove=function(t){if(t.preventDefault(),_._isDown){var e=t.touches.length;if(1===e){var i=t.touches[0];_._updateMove(i.screenX,i.screenY)}else if(2===e){var n=t.touches[0],r=t.touches[1],s=n.screenX-r.screenX,o=n.screenY-r.screenY,a=Math.sqrt(s*s+o*o),h=_._startPitchDistance-a;_.radius=_._startZoom+h*_.touchZoomSpeed}}},this._onUp=function(t){_._isDown=!1};var t=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";te.TARGET_CANVAS.addEventListener(t,this._onMouseWheel),te.TARGET_CANVAS.addEventListener("mousemove",this._onMouseMove),te.TARGET_CANVAS.addEventListener("touchmove",this._onTouchMove),te.TARGET_CANVAS.addEventListener("mousedown",this._onMouseDown),te.TARGET_CANVAS.addEventListener("touchstart",this._onTouchDown),te.TARGET_CANVAS.addEventListener("mouseup",this._onUp),te.TARGET_CANVAS.addEventListener("touchend",this._onUp)},mn.prototype.onRemoved=function(){var t=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";te.TARGET_CANVAS.removeEventListener(t,this._onMouseWheel),te.TARGET_CANVAS.removeEventListener("mousemove",this._onMouseMove),te.TARGET_CANVAS.removeEventListener("touchmove",this._onTouchMove),te.TARGET_CANVAS.removeEventListener("mousedown",this._onMouseDown),te.TARGET_CANVAS.removeEventListener("touchstart",this._onTouchDown),te.TARGET_CANVAS.removeEventListener("mouseup",this._onUp),te.TARGET_CANVAS.removeEventListener("touchend",this._onUp)},mn.prototype.onUpdate=function(t){this._localVelocity.x*=this.dampen,this._localVelocity.y*=this.dampen,this._localVelocity.z*=this.dampen,this._localVelocity.x+=this._localAcceleration.x,this._localVelocity.y+=this._localAcceleration.y,this._localVelocity.z+=this._localAcceleration.z,this._localAcceleration.x=0,this._localAcceleration.y=0,this._localAcceleration.z=0,this._coords.add(this._localVelocity),this._coords.y=I.clamp(this._coords.y,.1,Math.PI-.1),this._coords.z=I.clamp(this._coords.z,this.minRadius,this.maxRadius);var e=this.entity.matrix,i=new O;i.fromSphericalCoordinates(this._coords.z,this._coords.x,this._coords.y),i.w=0,i.add(this.lookAtTarget),e.lookAt(this.lookAtTarget,i),this.entity.matrix=e},mn.prototype.setAzimuthImpulse=function(t){this._localAcceleration.x=t},mn.prototype.setPolarImpulse=function(t){this._localAcceleration.y=t},mn.prototype.setZoomImpulse=function(t){this._localAcceleration.z=t},mn.prototype._updateMove=function(t,e){if(void 0!==this._oldMouseX){var i=this._oldMouseX-t,n=this._oldMouseY-e;this.setAzimuthImpulse(.0015*i),this.setPolarImpulse(.0015*n)}this._oldMouseX=t,this._oldMouseY=e},mn.prototype.clone=function(){var t=new mn;return t.radius=this.radius,t.azimuth=this.azimuth,t.polar=this.polar,t.touchZoomSpeed=this.touchZoomSpeed,t.zoomSpeed=this.zoomSpeed,t.maxRadius=this.maxRadius,t.minRadius=this.minRadius,t.dampen=this.dampen,t.lookAtTarget=this.lookAtTarget.clone(),t},gn.LITTLE_ENDIAN=!0,gn.BIG_ENDIAN=!1,gn.prototype={get offset(){return this._offset},set offset(t){this._offset=t},get endian(){return this._endian},set endian(t){this._endian=t},get byteLength(){return this._dataView.byteLength},get bytesAvailable(){return this._dataView.byteLength-this._offset},getChar:function(){return String.fromCharCode(this.getUint8())},getUint8:function(){return this._dataView.getUint8(this._offset++)},getUint16:function(){var t=this._dataView.getUint16(this._offset,this._endian);return this._offset+=2,t},getUint32:function(){var t=this._dataView.getUint32(this._offset,this._endian);return this._offset+=4,t},getInt8:function(){return this._dataView.getInt8(this._offset++)},getInt16:function(){var t=this._dataView.getInt16(this._offset,this._endian);return this._offset+=2,t},getInt32:function(){var t=this._dataView.getInt32(this._offset,this._endian);return this._offset+=4,t},getInt64AsFloat64:function(){var t,e;return this._endian===gn.LITTLE_ENDIAN?(t=this._dataView.getUint32(this._offset,this._endian),e=this._dataView.getInt32(this._offset+4,this._endian)):(e=this._dataView.getInt32(this._offset,this._endian),t=this._dataView.getUint32(this._offset+4,this._endian)),this._offset+=8,t+4294967296*e},getFloat32:function(){var t=this._dataView.getFloat32(this._offset,this._endian);return this._offset+=4,t},getFloat64:function(){var t=this._dataView.getFloat64(this._offset,this._endian);return this._offset+=8,t},getUint8Array:function(t){return this._readArray(t,Uint8Array,this.getUint8)},getUint16Array:function(t){return this._readArray(t,Uint16Array,this.getUint16)},getUint32Array:function(t){return this._readArray(t,Uint32Array,this.getUint32)},getInt8Array:function(t){return this._readArray(t,Int8Array,this.getInt8)},getInt16Array:function(t){return this._readArray(t,Int16Array,this.getInt16)},getInt32Array:function(t){return this._readArray(t,Int32Array,this.getInt32)},getInt64AsFloat64Array:function(t){return this._readArray(t,Float64Array,this.getInt64AsFloat64)},getFloat32Array:function(t){return this._readArray(t,Float32Array,this.getFloat32)},getFloat64Array:function(t){return this._readArray(t,Float64Array,this.getFloat64)},getString:function(t){if(!t)return this._get0String();for(var e="",i=0;i<t;++i)e+=this.getChar();return e},_get0String:function(){var t="";do{var e=this.getUint8();e&&(t+=String.fromCharCode(e))}while(0!==e);return t},_readArray:function(t,e,i){for(var n=new e(t),r=0;r<t;++r)n[r]=i.call(this);return n}},(xn.prototype=Object.create($t.prototype)).setMesh=function(t){this._mesh!==t&&(this._mesh=t,this._vertexLayout=new Qe(this._mesh,this))},xn.prototype.updateRenderState=function(t){var e=t._camera;this.updateInstanceRenderState(e),this.updatePassRenderState(e,t),this._mesh._vertexBuffers[0].bind(),this._mesh._indexBuffer.bind();for(var i=this._vertexLayout,n=i.attributes,r=n.length,s=0;s<r;++s){var o=n[s];B.gl.vertexAttribPointer(o.index,o.numComponents,B.gl.FLOAT,!1,o.stride,o.offset)}B.enableAttributes(i._numAttributes)},(vn.prototype=Object.create(xn.prototype))._initWeights=function(t){this._weights=[];for(var e=He.fromRadius(t,.01),i=0,n=0;n<=t;++n)this._weights[n]=e.getValueAt(n),i+=0<n?2*this._weights[n]:1;for(i=1/i,n=0;n<=t;++n)this._weights[n]*=i},$e.create(yn,{needsNormalDepth:{get:function(){return this._needsNormalDepth},set:function(t){this._needsNormalDepth=t}},hdrTarget:{get:function(){return this._renderer._hdrFront.fbo}},hdrSource:{get:function(){return this._renderer._hdrBack.texture}}}),yn.prototype.isSupported=function(){return this._isSupported},yn.prototype.render=function(t,e){this._renderer=t,this.draw(e)},yn.prototype.draw=function(t){throw new Error("Abstract method error!")},yn.prototype._drawPass=function(t){t.updateRenderState(this._renderer),B.drawElements(B.gl.TRIANGLES,6,0)},yn.prototype.onAdded=function(){},yn.prototype.onRemoved=function(){},yn.prototype._swapHDRFrontAndBack=function(){this._renderer._swapHDRFrontAndBack()},yn.prototype.acceptVisitor=function(t){t.visitEffect(this)},(Tn.prototype=Object.create(yn.prototype,{strength:{get:function(){return this._strength},set:function(t){this._strength=t,this._compositePass.setUniform("strength",this._strength)}},thresholdLuminance:{get:function(){return this._thresholdLuminance},set:function(t){this._thresholdLuminance=t,this._thresholdPass.setUniform("threshold",t)}}}))._initTextures=function(){for(var t=0;t<2;++t)this._thresholdWidth=Math.ceil(this._targetWidth/this._downScale),this._thresholdHeight=Math.ceil(this._targetHeight/this._downScale),this._thresholdMaps[t].initEmpty(this._thresholdWidth,this._thresholdHeight,Ne.RGB,Se.HDR_FORMAT),this._smallFBOs[t].init()},Tn.prototype.draw=function(t){this._renderer._width===this._targetWidth&&this._renderer._height===this._targetHeight||(this._targetWidth=this._renderer._width,this._targetHeight=this._renderer._height,this._initTextures()),B.setRenderTarget(this._smallFBOs[0]),B.clear(),this._drawPass(this._thresholdPass),B.setRenderTarget(this._smallFBOs[1]),B.clear(),this._blurSourceSlot.texture=this._thresholdMaps[0],this._blurPass.setUniform("stepSize",{x:1/this._thresholdWidth,y:0}),this._drawPass(this._blurPass),B.setRenderTarget(this._smallFBOs[0]),B.clear(),this._blurSourceSlot.texture=this._thresholdMaps[1],this._blurPass.setUniform("stepSize",{x:0,y:this._anisotropy/this._thresholdHeight}),this._drawPass(this._blurPass),B.setRenderTarget(this.hdrTarget),B.clear(),this._drawPass(this._compositePass)},(Sn.prototype=Object.create(yn.prototype,{radius:{get:function(){return this._radius},set:function(t){this._radius=t}}})).draw=function(t){var e=this._radius/this._numSamples;B.setRenderTarget(this.hdrTarget),B.clear(),this._blurSourceSlot.texture=this.hdrSource,this._blurPass.setUniform("stepSize",{x:e/this.hdrSource.width,y:0}),this._drawPass(this._blurPass),this._swapHDRFrontAndBack(),B.setRenderTarget(this.hdrTarget),B.clear(),this._blurSourceSlot.texture=this.hdrSource,this._blurPass.setUniform("stepSize",{x:0,y:e/this.hdrSource.height}),this._drawPass(this._blurPass)},(En.prototype=Object.create(xn.prototype)).setSourceTexture=function(t){this.setTexture("sampler",t)},(wn.prototype=Object.create(yn.prototype,{exposure:{get:function(){return this._exposure},set:function(t){this._exposure=t,this._isSupported&&this._toneMapPass.setUniform("hx_exposure",Math.pow(2,t))}},key:{get:function(){return this._key},set:function(t){this._key=t,this._isSupported&&this._toneMapPass.setUniform("hx_key",t)}},adaptationRate:{get:function(){return this._adaptationRate},set:function(t){this._adaptationRate=t}}}))._createToneMapPass=function(){throw new Error("Abstract method called!")},wn.prototype.draw=function(t){if(this._adaptive){var e=0<this._adaptationRate?t/this._adaptationRate:1;1<e&&(e=1),this._extractLuminancePass.blendState.color.a=e,B.setRenderTarget(this._luminanceFBO),this._drawPass(this._extractLuminancePass),this._luminanceMap.generateMipmap()}B.setRenderTarget(this.hdrTarget),B.clear(),this._drawPass(this._toneMapPass)},(An.prototype=Object.create(wn.prototype))._createToneMapPass=function(){var t={},e="";return this._adaptive&&(t.HX_ADAPTIVE=1,e="#texturelod\n"),new xn(null,e+d.get("snippets_tonemap.glsl",t)+"\n"+d.get("tonemap_filmic_fragment.glsl"))},(Pn.prototype=Object.create(yn.prototype,{density:{get:function(){return this._density},set:function(t){this._density=t,this._fogPass.setUniform("density",t)}},tint:{get:function(){return this._tint},set:function(t){this._tint.copyFrom(t),te.OPTIONS.useGammaCorrection&&this._tint.gammaToLinear(),this._fogPass.setUniform("tint",{x:t.r,y:t.g,z:t.b})}},startDistance:{get:function(){return this._startDistance},set:function(t){this._startDistance=t,this._fogPass.setUniform("startDistance",t)}},heightFallOff:{get:function(){return this._heightFallOff},set:function(t){this._heightFallOff=t,this._fogPass.setUniform("heightFallOff",t)}}})).draw=function(t){B.setRenderTarget(this.hdrTarget),B.clear(),this._drawPass(this._fogPass)},(Mn.prototype=Object.create(yn.prototype)).draw=function(t){B.setRenderTarget(this.hdrTarget),B.clear(),this._drawPass(this._pass)},(Ln.prototype=Object.create(yn.prototype,{sampleRadius:{get:function(){return this._radius},set:function(t){this._radius=t,this._aoPass&&this._aoPass.setUniform("halfSampleRadius",.5*this._radius)}},fallOffDistance:{get:function(){return this._fallOffDistance},set:function(t){this._fallOffDistance=t,this._aoPass&&this._aoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance)}},strength:{get:function(){return this._strength},set:function(t){this._strength=t,this._aoPass&&this._aoPass.setUniform("strengthPerRay",this._strength/this._numRays)}},bias:{get:function(){return this._bias},set:function(t){this._bias=t,this._aoPass&&this._aoPass.setUniform("bias",this._bias)}},scale:{get:function(){return this._scale},set:function(t){this._scale=t}}})).init=function(){this._aoPass=new xn(d.get("hbao_vertex.glsl"),d.get("hbao_fragment.glsl",{NUM_RAYS:this._numRays,NUM_SAMPLES_PER_RAY:this._numSamplesPerRay})),this._blurPass=new xn(d.get("ao_blur_vertex.glsl"),d.get("ao_blur_fragment.glsl")),this._initSampleDirTexture(),this._initDitherTexture(),this._aoPass.setUniform("strengthPerRay",this._strength/this._numRays),this._aoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance),this._aoPass.setUniform("halfSampleRadius",.5*this._radius),this._aoPass.setUniform("bias",this._bias),this._aoPass.setTexture("ditherTexture",this._ditherTexture),this._aoPass.setTexture("sampleDirTexture",this._sampleDirTexture),this._sourceTextureSlot=this._blurPass.getTextureSlot("source"),this._aoTexture=new Dt,this._aoTexture.filter=Ee.BILINEAR_NOMIP,this._aoTexture.wrapMode=we.CLAMP,this._backTexture=new Dt,this._backTexture.filter=Ee.BILINEAR_NOMIP,this._backTexture.wrapMode=we.CLAMP,this._fbo1=new Ft(this._backTexture),this._fbo2=new Ft(this._aoTexture)},Ln.prototype.getAOTexture=function(){return this._aoTexture},Ln.prototype.draw=function(t){var e=this._renderer._width*this._scale,i=this._renderer._height*this._scale;Nt.assureSize(e,i,this._aoTexture,this._fbo2)&&(Nt.assureSize(e,i,this._backTexture,this._fbo1),this._aoPass.setUniform("ditherScale",{x:.25*e,y:.25*i})),B.setClearColor(h.WHITE),B.setRenderTarget(this._fbo1),B.clear(),this._drawPass(this._aoPass),B.setRenderTarget(this._fbo2),B.clear(),this._blurPass.setUniform("pixelSize",{x:1/e,y:1/i}),this._sourceTextureSlot.texture=this._backTexture,this._drawPass(this._blurPass),B.setClearColor(h.BLACK)},Ln.prototype._initSampleDirTexture=function(){this._sampleDirTexture=new Dt;for(var t=[],e=0,i=0;i<256;++i){var n=i/256*2*Math.PI,r=.5*Math.cos(n)+.5,s=.5*Math.sin(n)+.5;t[e]=Math.round(255*r),t[e+1]=Math.round(255*s),t[e+2]=0,t[e+3]=255,e+=4}this._sampleDirTexture.uploadData(new Uint8Array(t),256,1,!1),this._sampleDirTexture.filter=Ee.NEAREST_NOMIP,this._sampleDirTexture.wrapMode=we.REPEAT},Ln.prototype._initDitherTexture=function(){this._ditherTexture=new Dt;var t,e=[],i=0,n=[],r=[];for(t=0;t<16;++t)n.push(t/16),r.push(t/15);u.shuffle(n),u.shuffle(r);for(var s=t=0;s<4;++s)for(var o=0;o<4;++o){var a=n[t],h=r[t];++t,e[i]=Math.round(255*a),e[i+1]=Math.round(255*h),e[i+2]=0,e[i+3]=255,i+=4}this._ditherTexture.uploadData(new Uint8Array(e),4,4,!1),this._ditherTexture.filter=Ee.NEAREST_NOMIP,this._ditherTexture.wrapMode=we.REPEAT},(Rn.prototype=Object.create(yn.prototype,{sampleRadius:{get:function(){return this._radius},set:function(t){this._radius=t,this._ssaoPass&&this._ssaoPass.setUniform("sampleRadius",this._radius)}},fallOffDistance:{get:function(){return this._fallOffDistance},set:function(t){this._fallOffDistance=t,this._ssaoPass&&this._ssaoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance)}},strength:{get:function(){return this._strength},set:function(t){this._strength=t,this._ssaoPass&&this._ssaoPass.setUniform("strengthPerSample",2*this._strength/this._numSamples)}},scale:{get:function(){return this._scale},set:function(t){this._scale=t}}})).init=function(){this._ssaoPass=new xn(null,d.get("ssao_fragment.glsl",{NUM_SAMPLES:this._numSamples})),this._blurPass=new xn(d.get("ao_blur_vertex.glsl"),d.get("ao_blur_fragment.glsl")),this._initSamples(),this._initDitherTexture(),this._ssaoPass.setUniform("strengthPerSample",2*this._strength/this._numSamples),this._ssaoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance),this._ssaoPass.setUniform("sampleRadius",this._radius),this._ssaoPass.setTexture("ditherTexture",this._ditherTexture),this._sourceTextureSlot=this._blurPass.getTextureSlot("source"),this._ssaoTexture=new Dt,this._ssaoTexture.filter=Ee.BILINEAR_NOMIP,this._ssaoTexture.wrapMode=we.CLAMP,this._backTexture=new Dt,this._backTexture.filter=Ee.BILINEAR_NOMIP,this._backTexture.wrapMode=we.CLAMP,this._fbo1=new Ft(this._backTexture),this._fbo2=new Ft(this._ssaoTexture)},Rn.prototype.getAOTexture=function(){return this._ssaoTexture},Rn.prototype._initSamples=function(){for(var t=[],e=0,i=P.DEFAULT.getPoints(),n=0;n<this._numSamples;++n){var r=i[n];t[e++]=Math.pow(r.x,2),t[e++]=Math.pow(r.y,2),t[e++]=Math.pow(r.z,2)}this._ssaoPass.setUniformArray("samples",new Float32Array(t))},Rn.prototype.draw=function(t){var e=this._renderer._width*this._scale,i=this._renderer._height*this._scale;Nt.assureSize(e,i,this._ssaoTexture,this._fbo2)&&(Nt.assureSize(e,i,this._backTexture,this._fbo1),this._ssaoPass.setUniform("ditherScale",{x:.25*e,y:.25*i})),B.setClearColor(h.WHITE),B.setRenderTarget(this._fbo1),B.clear(),this._drawPass(this._ssaoPass),B.setRenderTarget(this._fbo2),B.clear(),this._blurPass.setUniform("pixelSize",{x:1/e,y:1/i}),this._sourceTextureSlot.texture=this._backTexture,this._drawPass(this._blurPass),B.setClearColor(h.BLACK)},Rn.prototype._initDitherTexture=function(){this._ditherTexture=new Dt,this._ditherTexture.uploadData(new Uint8Array([126,255,126,255,135,253,105,255,116,51,26,255,137,57,233,255,139,254,121,255,56,61,210,255,227,185,73,255,191,179,30,255,107,245,173,255,205,89,34,255,191,238,138,255,56,233,125,255,198,228,161,255,85,13,164,255,140,248,168,255,147,237,65,255]),4,4,!1),this._ditherTexture.filter=Ee.NEAREST_NOMIP,this._ditherTexture.wrapMode=we.REPEAT},(bn.prototype=Object.create(wn.prototype))._createToneMapPass=function(){var t={},e="";return this._adaptive&&(t.HX_ADAPTIVE=1,e+="#texturelod\n"),new xn(null,e+d.get("snippets_tonemap.glsl",t)+"\n"+d.get("tonemap_reinhard_fragment.glsl"))};var In=function(t){var e=t.lastIndexOf("/"),i={};return 0<=e?(i.path=t.substr(0,e+1),i.filename=t.substr(e+1)):(i.path="./",i.filename=t),i};function Nn(t){this._params=void 0,this._data=null,this._timeout=0,this._method="GET",this._type=Nn.DATA_TEXT,this._headers=t||{}}function Dn(t,e){this._dataType=void 0===e?Nn.DATA_TEXT:e,this._containerType=t,this.onComplete=null,this.onProgress=null,this.onFail=null,this.fileMap=null,this.options={},this.path="",this.filename=""}function On(t){this.onComplete=new n,this.onProgress=new n,this.onFail=new n,this.fileMap={},this.options={},this._headers={},this._importerType=t,this.crossOrigin=void 0}function Cn(t,e){this.fileMap={},this._numLoaded=0,this._queue=[],this._assets={},t&&"/"!==t.charAt(t.length-1)&&(t+="/"),this._basePath=t||"",this._onComplete=new n,this._onProgress=new n,this._crossOrigin=e}function Fn(){Dn.call(this,Wi,Nn.DATA_BINARY)}function Un(){Dn.call(this,Ot)}function Bn(){Dn.call(this,Dt,Dn.TYPE_IMAGE)}Nn.ERROR_TIME_OUT=408,Nn.METHOD_GET="get",Nn.METHOD_POST="post",Nn.DATA_TEXT=0,Nn.DATA_BINARY=1,Nn.prototype={get type(){return this._type},set type(t){this._type=t},get method(){return this._method},set method(t){this._method=t},get timeoutDuration(){return this._timeout},set timeoutDuration(t){this._timeout=t},get parameters(){return this._params},set parameters(t){this._params=t},get data(){return this._data},setRequestHeader:function(t,e){this._headers[t]=e},load:function(t){var e=new XMLHttpRequest;for(var i in e.open(this._method,t,!0),this._headers)this._headers.hasOwnProperty(i)&&e.setRequestHeader(i,this._headers[i]);this._timeout&&(e.timeout=this._timeout,e.ontimeout=function(){n.onError(Nn.ERROR_TIME_OUT)}),this._type===Nn.DATA_BINARY?e.responseType="arraybuffer":e.overrideMimeType("application/json");var n=this;e.onreadystatechange=function(){var t=this.DONE||4;this.readyState===t&&(200===this.status?(this._data=n._type===Nn.DATA_TEXT?e.responseText:new DataView(e.response),n.onComplete&&n.onComplete(this._data)):n.onError&&n.onError(this.status))},e.send(this._params)},onComplete:function(t){},onError:function(t){}},Dn.prototype={get dataType(){return this._dataType},createContainer:function(){return new this._containerType},parse:function(t,e){},_notifyComplete:function(t){this.onComplete&&(this.onComplete instanceof n?this.onComplete.dispatch(t):this.onComplete(t))},_notifyProgress:function(t){this.onProgress&&(this.onProgress instanceof n?this.onProgress.dispatch(t):this.onProgress(t))},_notifyFailure:function(t){this.onFail instanceof n?(this.onFail.hasListeners||console.error(t),this.onFail.dispatch(t)):this.onFail(t)},_correctURL:function(t){return this.path+(this.fileMap.hasOwnProperty(t)?this.fileMap[t]:t).replace("\\","/")}},Dn.TYPE_TEXT=Nn.DATA_TEXT,Dn.TYPE_BINARY=Nn.DATA_BINARY,Dn.TYPE_IMAGE=2,On.prototype={setRequestHeader:function(t,e){this._headers[t]=e},load:function(t,e){var i=new this._importerType;return e=e||i.createContainer(),i.onComplete=this.onComplete,i.onProgress=this.onProgress,i.onFail=this.onFail,i.fileMap=this.fileMap,i.options=this.options,t instanceof Blob?this._importFromFile(t,e,i):this._importFromFilename(t,e,i),e},_fail:function(t){console.warn("Failed loading "+filename+". Error code: "+t),this.onFail&&(this.onFail instanceof n?this.onFail.dispatch(t):this.onFail(t))},_importFromFile:function(t,e,i){var n=new FileReader;switch(n.onerror=function(t){self._fail.call(self,t)},i.dataType){case Dn.TYPE_TEXT:n.onload=function(){i.parse(n.result,e)},n.readAsText(t);break;case Dn.TYPE_BINARY:n.onload=function(){i.parse(new DataView(n.result),e)},n.readAsArrayBuffer(t);break;case Dn.TYPE_IMAGE:var r=document.createElementNS("http://www.w3.org/1999/xhtml","img");n.onload=function(){r.src=n.result,i.parse(r,e)},n.readAsDataURL(t)}},_importFromFilename:function(t,e,i){var n=In(t);if(i.path=n.path,i.filename=n.filename,i.dataType===Dn.TYPE_IMAGE){var r=document.createElementNS("http://www.w3.org/1999/xhtml","img");r.crossOrigin=this.options.crossOrigin,r.addEventListener("load",function(){i.parse(r,e)}),r.addEventListener("error",function(){console.warn("Failed loading asset '"+t+"'"),s._fail.call(s)}),r.src=t}else{var s=this,o=new Nn(this._headers);o.type=i.dataType,o.onComplete=function(t){i.parse(t,e)},o.onError=function(t){s._fail.call(s,t)},o.load(t)}}},Cn.Type={JSON:0,ASSET:1,PLAIN_TEXT:2,RAW_BINARY:3},Cn.prototype={get onComplete(){return this._onComplete},get onProgress(){return this._onProgress},get basePath(){return this._basePath},get crossOrigin(){return this._crossOrigin},queueAsset:function(t,e,i,n,r,s){this._queue.push({id:t,file:e instanceof Blob?e:this._basePath+e,type:i,parser:n,options:r,target:s})},load:function(){if(0!==this._queue.length){var t=this._queue[this._numLoaded];switch(t.type){case Cn.Type.JSON:this._json(t.file,t.id);break;case Cn.Type.PLAIN_TEXT:this._plainText(t.file,t.id);break;case Cn.Type.RAW_BINARY:this._rawBinary(t.file,t.id);break;case Cn.Type.ASSET:this._asset(t.file,t.id,t.parser,t.options,t.target);break;default:throw new Error("Unknown asset type "+t.type+"!")}}else this.onComplete.dispatch(this)},get:function(t){return this._assets[t]},addAsset:function(t,e){this._assets[t]=e},mergeLibrary:function(t){u.forEach(t._assets,function(t,e){this.addAsset(e,t)}.bind(this))},_json:function(t,e){var i=this;this._loadText(t,function(t){i._assets[e]=JSON.parse(t),i._onAssetLoaded()})},_plainText:function(t,e){var i=this;this._loadText(t,function(t){i._assets[e]=t,i._onAssetLoaded()})},_loadText:function(t,e){if(t instanceof Blob){var i=new FileReader;i.onload=function(){e(i.result)},i.readAsText(t)}else{var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",t,!0),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&e(n.responseText)},n.send(null)}},_rawBinary:function(t,e){var i=this;if(t instanceof Blob){var n=new FileReader;n.onload=function(){i._assets[e]=data,i._onAssetLoaded()},n.readAsArrayBuffer(t)}else{var r=new Nn;r.type=Nn.DATA_BINARY,r.onComplete=function(t){i._assets[e]=t,i._onAssetLoaded()},r.load(t)}},_asset:function(t,e,i,n,r){var s=new On(i);s.fileMap=this.fileMap,s.options=n||{},s.options.crossOrigin=this._crossOrigin,s.onComplete.bind(function(){this._onAssetLoaded()},this),s.onProgress.bind(function(t){this._onProgress.dispatch((this._numLoaded+t)/this._queue.length)},this),this._assets[e]=s.load(t,r),this._assets[e].name=e},_onAssetLoaded:function(){++this._numLoaded,this._onProgress.dispatch(this._numLoaded/this._queue.length),this._numLoaded===this._queue.length?this._onComplete.dispatch(this):this.load()}},Fn.prototype=Object.create(Dn.prototype),Fn.VERSION="0.1.0",Fn.VALUE_TYPE_SKELETON_POSE=1,Fn.VALUE_TYPE_NUMBER=2,Fn.VALUE_TYPE_FLOAT3=3,Fn.VALUE_TYPE_QUATERNION=4,Fn.prototype.parse=function(t,e){var i=new gn(t);if("HX_CLIP"!==i.getString(7))throw new Error("Invalid file hash!");i.getUint16Array(3).join(".");for(var n=i.getUint8(),r=i.getUint32(),s=i.getUint8(),o=0;o<r;++o){var a=new HX.KeyFrame;a.time=i.getUint32(),a.value=this._readValue(i,n,s),e.addKeyFrame(a)}this._notifyComplete(e)},Fn.prototype._readValue=function(t,e,i){if(e===Fn.VALUE_TYPE_SKELETON_POSE){for(var n=i,r=new sn,s=0;s<n;++s){var o=new Ji;o.position.set(t.getFloat32(),t.getFloat32(),t.getFloat32()),o.rotation.set(t.getFloat32(),t.getFloat32(),t.getFloat32(),t.getFloat32()),o.scale.set(t.getFloat32(),t.getFloat32(),t.getFloat32()),r.setJointPose(s,o)}return r}return e===AnimationClipExporter.VALUE_TYPE_FLOAT3?new HX.Float4(t.getFloat32(),t.getFloat32(),t.getFloat32(),0):e===AnimationClipExporter.VALUE_TYPE_QUATERNION?new HX.Quaternion(t.getFloat32(),t.getFloat32(),t.getFloat32(),t.getFloat32()):e===AnimationClipExporter.VALUE_TYPE_NUMBER?t.getFloat32():void 0},(Un.prototype=Object.create(Dn.prototype)).parse=function(t,e){var i=JSON.parse(t),n=[i.files.posX,i.files.negX,i.files.posY,i.files.negY,i.files.posZ,i.files.negZ];i.loadMips?this._loadMipChain(n,e):this._loadFaces(n,e)},Un.prototype._loadFaces=function(t,e){for(var i=void 0===this.options.generateMipmaps||this.options.generateMipmaps,n=[],r=this,s=function(){r._notifyFailure("Failed loading texture '"+t[0]+"'")},o=function(){r._notifyProgress(this.nextID/6),n[this.nextID].src=r.path+t[this.nextID]},a=function(){e.uploadImages(n,i),r._notifyComplete(e)},h=0;h<6;++h){var _=document.createElementNS("http://www.w3.org/1999/xhtml","img");_.crossOrigin=this.options.crossOrigin,_.nextID=h+1,h<5?_.addEventListener("load",o):_.addEventListener("load",a),_.addEventListener("error",s),n[h]=_}n[0].src=r.path+t[0]},Un.prototype._loadMipChain=function(l,u){for(var c,d=[],f=this,t=document.createElementNS("http://www.w3.org/1999/xhtml","img"),p=[],e=0;e<6;++e)p[e]=l[e].replace("%m","0");t.addEventListener("load",function(){t.naturalWidth===t.naturalHeight&&I.isPowerOfTwo(t.naturalWidth)?(c=I.log2(t.naturalWidth)+1,function(){for(var t=[],e=6*c,i=1,n=0,r=1;r<c;++r){for(var s=0;s<6;++s)p.push(l[s].replace("%m",r.toString())),t.push(i),n+=i;i*=.5}var o=function(){f._notifyFailure("Failed loading texture")},a=function(){f._notifyProgress(t[this.nextID]/n),d[this.nextID].src=f.path+p[this.nextID]},h=function(){for(var t=0;t<c;++t)u.uploadImagesToMipLevel(d.slice(6*t,6*t+6),t);u._isReady=!0,f._notifyComplete(u)};for(r=1;r<e;++r){var _=document.createElementNS("http://www.w3.org/1999/xhtml","img");_.crossOrigin=f.options.crossOrigin,_.nextID=r+1,r<e-1?_.addEventListener("load",a):_.addEventListener("load",h),_.addEventListener("onError",o),d[r]=_}d[1].src=f.path+p[1]}(),d[0]=t):f._notifyFailure("Failed loading mipchain: incorrect dimensions")}),t.addEventListener("error",function(){f._notifyFailure("Failed loading texture")}),t.src=f.path+p[0]},(Bn.prototype=Object.create(Dn.prototype)).parse=function(t,e){var i=void 0===this.options.generateMipmaps||this.options.generateMipmaps;e.uploadImage(t,t.naturalWidth,t.naturalHeight,i),this._notifyComplete(e)};var Xn=Bn;function Hn(){Dn.call(this,gi),Hn._initPropertyMap()}function zn(){Dn.call(this,Lt,Nn.DATA_BINARY)}(Hn.prototype=Object.create(Dn.prototype)).parse=function(t,e){(t=JSON.parse(t)).class?(this._isClass=!0,this._applyClass(t.class,e)):this._isClass=!1,this._loadShaders(t,e)},Hn.prototype._applyClass=function(t,e){var i;switch(t){case"BasicMaterial":i=xi;break;default:throw new Error("Unknown material class!")}for(var n in Object.assign(e,i.prototype),i.prototype)Object.prototype.hasOwnProperty.call(i.prototype,n)&&(e[n]=i.prototype[n]);for(var r=Object.getOwnPropertyNames(i.prototype),s=0;s<r.length;++s){var o=r[s],a=Object.getOwnPropertyDescriptor(i.prototype,o);Object.defineProperty(e,o,a)}i.call(e)},Hn.prototype._gatherShaderFiles=function(t){var e=[];if(!this._isClass){var i=t.geometry,n=i.vertexShader,r=i.fragmentShader;e.indexOf(n)<0&&e.push(this._correctURL(n)),e.indexOf(r)<0&&e.push(this._correctURL(r))}var s=t.lightingModel;return s&&"unlit"!==s&&e.indexOf(s)<0&&e.push(this._correctURL(s)),e},Hn.prototype._loadShaders=function(t,e){var i=this._gatherShaderFiles(t);this._shaderLibrary=new Cn(null,this.options.crossOrigin),this._shaderLibrary.fileMap=this.fileMap;for(var n=0;n<i.length;++n)this._shaderLibrary.queueAsset(i[n],i[n],Cn.Type.PLAIN_TEXT);this._shaderLibrary.onComplete.bind(function(){this._processMaterial(t,e),this._loadTextures(t,e)},this),this._shaderLibrary.load()},Hn.prototype._processMaterial=function(t,e){var i="";if(!this._isClass){this.options.defines&&u.forEach(this.options.defines,function(t,e){i+="#define "+e+" "+t+"\n"}.bind(this));var n=i+this._shaderLibrary.get(this._correctURL(t.geometry.vertexShader)),r=i+this._shaderLibrary.get(this._correctURL(t.geometry.fragmentShader));e._geometryVertexShader=n,e._geometryFragmentShader=r,e.init()}if("unlit"===t.lightingModel?e.lightingModel=S.Unlit:t.lightingModel&&(e.lightingModel=this._shaderLibrary.get(this._correctURL(t.lightingModel))),this._applyUniforms(t,e),this._isClass&&this._applyProperties(t,e),t.hasOwnProperty("elementType")&&(e.elementType=Hn._PROPERTY_MAP[t.elementType]),t.hasOwnProperty("cullMode")&&(e.cullMode=Hn._PROPERTY_MAP[t.cullMode]),t.hasOwnProperty("writeDepth")&&(e.writeDepth=t.writeDepth),t.hasOwnProperty("blend")){var s=new Ct,o=t.blend;o.hasOwnProperty("source")&&(s.srcFactor=Hn._PROPERTY_MAP[o.source]),o.hasOwnProperty("destination")&&(s.dstFactor=Hn._PROPERTY_MAP[o.destination]),o.hasOwnProperty("operator")&&(s.operator=Hn._PROPERTY_MAP[o.operator]),e.blendState=s}},Hn.prototype._applyProperties=function(t,e){if(t.properties)for(var i in t.properties)if(t.properties.hasOwnProperty(i)){var n=t.properties[i],r=typeof e[i];if("number"===r||"boolean"===r)e[i]=n;else if(e[i]instanceof h)e[i]=new h(n[0],n[1],n[2],n[3]);else if(e[i]instanceof w)e[i]=new h(n[0],n[1]);else{if(!(e[i]instanceof O))throw new Error("Unsupport property format!");e[i]=new O(n[0],n[1],n[2],n[3])}}},Hn.prototype._applyUniforms=function(t,e){if(t.uniforms)for(var i in t.uniforms)if(t.uniforms.hasOwnProperty(i)){var n=t.uniforms[i];isNaN(n)?e.setUniform(i,{x:n[0],y:n[1],z:n[2],w:n[3]},!1):e.setUniform(i,n,!1)}},Hn.prototype._loadTextures=function(e,i){var t=[];for(var n in e.textures)e.textures.hasOwnProperty(n)&&(t.push(this._correctURL(e.textures[n])),i.setTexture(n,Dt.DEFAULT));this._textureLibrary=new Cn(null,this.options.crossOrigin),this._textureLibrary.fileMap=this.fileMap;for(var r=0;r<t.length;++r)this._textureLibrary.queueAsset(t[r],t[r],Cn.Type.ASSET,Bn);this._textureLibrary.onComplete.bind(function(){for(var t in e.textures)e.textures.hasOwnProperty(t)&&(this._isClass?i[t]=this._textureLibrary.get(this._correctURL(e.textures[t])):i.setTexture(t,this._textureLibrary.get(this._correctURL(e.textures[t]))));this._notifyComplete(i)},this),this._textureLibrary.load()},Hn._PROPERTY_MAP=null,Hn._initPropertyMap=function(){Hn._PROPERTY_MAP=Hn._PROPERTY_MAP||{back:Ae.BACK,front:Ae.FRONT,both:Ae.ALL,none:null,lines:Le.LINES,points:Le.POINTS,triangles:Le.TRIANGLES,one:Re.ONE,zero:Re.ZERO,sourceColor:Re.SOURCE_COLOR,oneMinusSourceColor:Re.ONE_MINUS_SOURCE_COLOR,sourceAlpha:Re.SOURCE_ALPHA,oneMinusSourceAlpha:Re.ONE_MINUS_SOURCE_ALPHA,destinationAlpha:Re.DST_ALPHA,oneMinusDestinationAlpha:Re.ONE_MINUS_DESTINATION_ALPHA,destinationColor:Re.DESTINATION_COLOR,sourceAlphaSaturate:Re.SOURCE_ALPHA_SATURATE,add:be.ADD,subtract:be.SUBTRACT,reverseSubtract:be.REVERSE_SUBTRACT,always:Me.ALWAYS,disabled:Me.DISABLED,equal:Me.EQUAL,greater:Me.GREATER,greaterEqual:Me.GREATER_EQUAL,less:Me.LESS,lessEqual:Me.LESS_EQUAL,never:Me.NEVER,notEqual:Me.NOT_EQUAL}},zn.prototype=Object.create(Dn.prototype),zn.VERSION="0.1.0",zn.prototype.parse=function(t,e){var i=new gn(t);if("HX_MESH"!==i.getString(7))throw new Error("Invalid file hash!");i.getUint16Array(3).join(".");this._parseMesh(i,e),e.skeleton=this._parseSkeleton(i),this._notifyComplete(e)},zn.prototype._parseMesh=function(t,e){var i,n=t.getUint32();i=16===t.getUint8()?t.getUint16Array(n):t.getUint32Array(n),e.setIndexData(i);t.getUint32();for(var r=t.getUint8(),s=0;s<r;++s){var o=t.getUint8(),a=t.getString(o),h=t.getUint8(),_=t.getUint8();e.addVertexAttribute(a,_,h)}var l=t.getUint8();for(s=0;s<l;++s){var u=t.getUint32(),c=t.getFloat32Array(u);e.setVertexData(c,s)}return e},zn.prototype._parseSkeleton=function(t){var e=t.getUint8();if(0===e)return null;for(var i=new rn,n=0;n<e;++n){var r=new cn,s=t.getUint8();0!==s&&(r.name=t.getString(s));var o=t.getUint8();r.parentIndex=255===o?-1:o;for(var a=0;a<16;++a)r.inverseBindPose._m[a]=t.getFloat32();i.addJoint(r)}return i};var Vn={toCube:function(t,e,i,n){i=i||!0,e=e||t.height,Vn._EQUI_TO_CUBE_SHADER||(Vn._EQUI_TO_CUBE_SHADER=new gt(d.get("2d_to_cube_vertex.glsl"),d.get("equirectangular_to_cube_fragment.glsl"))),this._createRenderCubeGeometry();var r=B.gl;(n=n||new Ot).initEmpty(e,t.format,t.dataType);var s=[Ce.POSITIVE_X,Ce.NEGATIVE_X,Ce.POSITIVE_Y,Ce.NEGATIVE_Y,Ce.POSITIVE_Z,Ce.NEGATIVE_Z];Vn._EQUI_TO_CUBE_SHADER.updatePassRenderState();var o=Vn._EQUI_TO_CUBE_SHADER.getUniformLocation("source"),a=Vn._EQUI_TO_CUBE_SHADER.getAttributeLocation("hx_position"),h=Vn._EQUI_TO_CUBE_SHADER.getAttributeLocation("corner");r.uniform1i(o,0),t.bind(0),Vn._TO_CUBE_VERTICES.bind(),Vn._TO_CUBE_INDICES.bind(),r.vertexAttribPointer(a,2,r.FLOAT,!1,20,0),r.vertexAttribPointer(h,3,r.FLOAT,!1,20,8),B.enableAttributes(2);for(var _=B.getCurrentRenderTarget(),l=0;l<6;++l){var u=new Ft(n,null,s[l]);u.init(),B.setRenderTarget(u),B.drawElements(r.TRIANGLES,6,6*l)}return B.setRenderTarget(_),i&&n.generateMipmap(),Se.EXT_SHADER_TEXTURE_LOD||(n.filter=Ee.BILINEAR_NOMIP),n},_createRenderCubeGeometry:function(){if(!Vn._TO_CUBE_VERTICES){Vn._TO_CUBE_VERTICES=new St,Vn._TO_CUBE_INDICES=new Tt,Vn._TO_CUBE_VERTICES.uploadData(new Float32Array([1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,1,1,1,1,-1,1,1,-1,1,1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,1,-1,-1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,1,-1,-1,-1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1,1,-1,-1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,-1,-1,-1,1,-1,-1,-1])),Vn._TO_CUBE_INDICES.uploadData(new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]))}}};function kn(){Dn.call(this,Ot,Dn.TYPE_IMAGE)}(kn.prototype=Object.create(Dn.prototype)).parse=function(t,e){var i=new Dt;i.wrapMode=we.REPEAT,i.uploadImage(t,t.naturalWidth,t.naturalHeight,!0);var n=void 0===this.options.generateMipmaps||this.options.generateMipmaps;Vn.toCube(i,this.options.size,n,e),this._notifyComplete(e)};var Gn=kn,Yn={from8BitTexture:function(t,e,i){var n=B.gl;e=e||!0;var r=i||new Dt;r.initEmpty(t.width,t.height);var s=new Ft(r);s.init();var o=new Dt;o.initEmpty(t.width,t.height);var a=new Ft(o);a.init();var h=new xt(d.get("greyscale_to_rgba8.glsl")),_=B.getCurrentRenderTarget();B.setRenderTarget(s),B.clear(),h.execute(It.DEFAULT,t),e&&i.generateMipmap();var l=new xt(d.get("smooth_heightmap_fragment.glsl")),u=n.getUniformLocation(l._program,"reference"),c=n.getUniformLocation(l._program,"stepSize");return n.uniform1i(u,1),t.bind(1),B.setRenderTarget(a),B.clear(),n.uniform2f(c,1/t.width,0),l.execute(It.DEFAULT,r),o.generateMipmap(),B.setRenderTarget(s),B.clear(),n.uniform2f(c,0,1/t.height),l.execute(It.DEFAULT,o),e&&i.generateMipmap(),B.setRenderTarget(_),r}};function jn(){Dn.call(this,Dt,Dn.TYPE_IMAGE)}(jn.prototype=Object.create(Dn.prototype)).parse=function(t,e){var i=new Dt;i.wrapMode=we.REPEAT,i.uploadImage(t,t.naturalWidth,t.naturalHeight,!0);var n=void 0===this.options.generateMipmaps||this.options.generateMipmaps;Yn.from8BitTexture(i,n,e),this._notifyComplete(e)};var Wn=jn;function Zn(){ii.call(this),this._bounds=new At}function qn(){this._renderBuffer=B.gl.createRenderbuffer(),this._format=null}$e.create(Zn,{},ii),Zn.prototype.acceptVisitor=function(t){t.visitAmbientLight(this)},Zn.prototype._updateBounds=function(){this._bounds.clear(Et.EXPANSE_INFINITE)},Zn.prototype.clone=function(){var t=new Zn;return this.copyTo(t),t},qn.prototype={get width(){return this._width},get height(){return this._height},get format(){return this._format},init:function(t,e,i){var n=B.gl;i=void 0===i||i,this._width=t,this._height=e,this._format=i?n.DEPTH_STENCIL:n.DEPTH_COMPONENT16,n.bindRenderbuffer(n.RENDERBUFFER,this._renderBuffer),n.renderbufferStorage(n.RENDERBUFFER,this._format,t,e),n.bindRenderbuffer(n.RENDERBUFFER,null)}};var Kn,Jn,Qn,$n,tr,er,ir,nr=function(t,e,i,n){for(var r=i.length,s=null,o=null,a=0;a<r;++a){var h=i[a],_=h.material.getPass(e);if(_){var l=h.meshInstance;_!==s&&(_.updatePassRenderState(h.camera,t,n),s=_,o=null),_.updateInstanceRenderState(h.camera,h,n),o!==l._mesh&&(l.updateRenderState(e),o=l._mesh);var u=l._mesh;B.drawElements(_._elementType,u._numIndices,0,u._indexType)}}return B.setBlendState(null),r};function rr(t,e,i,n){this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0}function sr(){this._texture=new Dt,this._depthBuffer=new qn,this._fbo=new Ft(this._texture,this._depthBuffer),te.OPTIONS.shadowFilter.blurShader&&(this._fboNoDepth=new Ft(this._texture,null),this._texture2=new Dt,this._fbo2=new Ft(this._texture2,null))}function or(){bi.call(this),this._renderCameras=null,this._cameraYAxis=new O,this._bounds=new At,this._cullPlanes=null,this._numCullPlanes=0,this._renderList=[],this._renderItemPool=new Ui(Bi)}function ar(){this._inverseLightMatrix=new F,this._shadowMapCameras=null,this._collectorCamera=new fn,this._maxY=0,this._numCullPlanes=0,this._cullPlanes=[],this._localBounds=new At,this._casterCollector=new or,this._initCameras()}function hr(){bi.call(this),this._lightBounds=null,this._renderLists=[],this._renderItemPool=new Ui(Bi),this._octantPlanes=[],this._cameraPos=null,this._octantPlanes[0]=new O(0,1,-1,0),this._octantPlanes[1]=new O(1,0,-1,0),this._octantPlanes[2]=new O(-1,0,-1,0),this._octantPlanes[3]=new O(0,-1,-1,0),this._octantPlanes[4]=new O(1,1,0,0),this._octantPlanes[5]=new O(-1,1,0,0);for(var t=0;t<6;++t)this._octantPlanes[t].normalize()}function _r(){this._casterCollector=new hr,this._scene=null,this._initFaces()}function lr(){bi.call(this),this._frustumPlanes=null,this._renderList=[],this._renderItemPool=new Ui(Bi),this._cameraYAxis=new O}function ur(){this._casterCollector=new lr,this._camera=new Ci,this._camera.nearDistance=.01}function cr(t){if(this._renderTarget=t||null,this._width=0,this._height=0,this._depthPrepass=!1,this._gammaApplied=!1,this._copyTextureShader=new vt("xyzw",!0),this._applyGamma=new yt,this._camera=null,this._scene=null,this._depthBuffer=this._createDepthBuffer(),this._hdrBack=new cr.HDRBuffers(this._depthBuffer),this._hdrFront=new cr.HDRBuffers(this._depthBuffer),this._renderCollector=new ki,this._normalDepthBuffer=new Dt,this._normalDepthBuffer.filter=Ee.BILINEAR_NOMIP,this._normalDepthBuffer.wrapMode=we.CLAMP,this._normalDepthFBO=new Ft(this._normalDepthBuffer,this._depthBuffer),this._backgroundColor=h.BLACK.clone(),this._debugMode=cr.DebugMode.NONE,this._ssaoTexture=null,this._cascadeShadowRenderer=new ar,this._omniShadowRenderer=new _r,this._spotShadowRenderer=new ur,this._shadowAtlas=new sr(!!te.OPTIONS.shadowFilter.blurShader),this._shadowAtlas.resize(2048,2048),Se.WEBGL_2){var e=16+320*te.OPTIONS.maxDirLights+16*te.OPTIONS.maxLightProbes+224*te.OPTIONS.maxPointSpotLights;this._diffuseProbeArray=[],this._specularProbeArray=[],this._lightingUniformBuffer=new Qt(e),this._lightingDataView=new DataView(new ArrayBuffer(e)),this._numCells=te.OPTIONS.numLightingCellsX*te.OPTIONS.numLightingCellsY,this._cellStride=te.OPTIONS.maxPointSpotLights+1,this._lightingCellsUniformBuffer=new Qt(this._numCells*this._cellStride*4),this._cellData=new Int32Array(this._numCells*this._cellStride);for(var i=0;i<e;++i)this._lightingDataView.setInt8(i,0)}}function dr(t,e,i,n){var r=new Ot,s=new Ot;e=e||De.UNSIGNED_BYTE,r.initEmpty(4,null,e),s.initEmpty(t,null,e),i=i||.1,n=n||1e3,ai.call(this,r,s),this._cameras=[],this._specularFBOs=[],this._diffuseFBOs=[];var o=new qn;o.init(t,t,!1);for(var a=[],h=0;h<6;++h)a[h]=new N;a[0].fromAxisAngle(O.Y_AXIS,.5*Math.PI),a[1].fromAxisAngle(O.Y_AXIS,.5*-Math.PI),a[2].fromAxisAngle(O.X_AXIS,.5*-Math.PI),a[3].fromAxisAngle(O.X_AXIS,.5*Math.PI),a[4].fromAxisAngle(O.Y_AXIS,0),a[5].fromAxisAngle(O.Y_AXIS,Math.PI),this._diffuseScene=new Ri,this._diffuseScene.skybox=new Fi(s);var _=[Ce.POSITIVE_X,Ce.NEGATIVE_X,Ce.POSITIVE_Y,Ce.NEGATIVE_Y,Ce.POSITIVE_Z,Ce.NEGATIVE_Z];for(h=0;h<6;++h){var l=new Ci;l.nearDistance=i,l.farDistance=n,l.verticalFOV=.5*Math.PI,l.rotation.copyFrom(a[h]),l.scale.set(1,-1,1),this._cameras.push(l);var u=new Ft(s,o,_[h]);u.init(),this._specularFBOs.push(u),(u=new Ft(r,null,_[h])).init(),this._diffuseFBOs.push(u)}this._renderer=new cr}function fr(t){gt.call(this);var e=B.gl,i={RADIUS:t,RCP_NUM_SAMPLES:"float("+1/(1+2*t)+")"},n=d.get("copy_vertex.glsl",i),r=d.get("esm_blur_fragment.glsl",i);this.init(n,r),this._textureLocation=e.getUniformLocation(this._program,"source"),this._directionLocation=e.getUniformLocation(this._program,"direction"),this._positionAttributeLocation=e.getAttribLocation(this._program,"hx_position"),this._texCoordAttributeLocation=e.getAttribLocation(this._program,"hx_texCoord"),e.useProgram(this._program),e.uniform1i(this._textureLocation,0)}function pr(){x.call(this),this._expScaleFactor=80,this._blurRadius=1,this._darkeningFactor=.35}function mr(){x.call(this),this._softness=.001,this._numShadowSamples=6,this._dither=!1}function gr(t){var e=B.gl;gt.call(this);var i={RADIUS:t,RCP_NUM_SAMPLES:"float("+1/(1+2*t)+")"},n=d.get("copy_vertex.glsl",i),r=d.get("vsm_blur_fragment.glsl",i);this.init(n,r),this._textureLocation=e.getUniformLocation(this._program,"source"),this._directionLocation=e.getUniformLocation(this._program,"direction"),this._positionAttributeLocation=e.getAttribLocation(this._program,"hx_position"),this._texCoordAttributeLocation=e.getAttribLocation(this._program,"hx_texCoord"),e.useProgram(this._program),e.uniform1i(this._textureLocation,0)}function xr(){x.call(this),this._blurRadius=2,this._lightBleedReduction=.5,this._minVariance=.001,this._useHalfFloat=!0,this._cullMode=Ae.BACK}function vr(t){ke.call(this,t)}function yr(t){ke.call(this,t)}function Tr(t){ke.call(this,t)}function Sr(t){ke.call(this,t)}function Er(t){ke.call(this,t)}function wr(t){ke.call(this,t)}function Ar(){this._views=[]}function Pr(){this.onComplete=new n,this.onProgress=new n,this._queue=[],this._childQueues=[],this._currentIndex=0,this._isRunning=!1}sr.prototype={get fbo(){return this._fbo},get texture(){return this._texture},get size(){return this._size},resize:function(t){if(this._size!==t){if(this._size=t,this._texture.initEmpty(t,t,te.OPTIONS.shadowFilter.getShadowMapFormat(),te.OPTIONS.shadowFilter.getShadowMapDataType()),this._texture.filter=te.OPTIONS.shadowFilter.shadowMapFilter,this._texture.filter!==Ee.NEAREST_NOMIP&&this._texture.filter!==Ee.BILINEAR_NOMIP)throw new Error("ShadowAtlas does not support mipmaps!");this._depthBuffer.init(t,t,!1),this._fbo.init(),this._texture2&&(this._texture2.initEmpty(t,t,te.OPTIONS.shadowFilter.getShadowMapFormat(),te.OPTIONS.shadowFilter.getShadowMapDataType()),this._texture2.filter=Ee.NEAREST_NOMIP,this._fboNoDepth.init(),this._fbo2.init())}},getNextRect:function(){return this._rects[this._currentRectIndex++]},initRects:function(t,e){this._currentRectIndex=0,this._rects=[new rr(0,0,this._size,this._size)];for(var i=t.length,n=0;n<i;++n){var r=t[n];if(!(0<(e-=r)))return void this._divideLast(r,this._rects);this._divideLast(r+1,this._rects)}},blur:function(){var t=te.OPTIONS.shadowFilter,e=t.blurShader;if(e){this._texture.filter=Ee.NEAREST_NOMIP;for(var i=t.numBlurPasses,n=0;n<i;++n)B.setRenderTarget(this._fbo2),B.clear(),e.execute(It.DEFAULT,this._texture,1/this._size,0),B.setRenderTarget(this._fboNoDepth),B.clear(),e.execute(It.DEFAULT,this._texture2,0,1/this._size);this._texture.filter=t.shadowMapFilter}},_divideLast:function(t,e){if(!(t<=1))for(var i=e[e.length-1],n=Math.floor(Math.sqrt(t)),r=Math.ceil(t/n),s=i.x,o=i.y,a=i.width/n,h=i.height/r,_=0,l=0;l<r;++l)for(var u=0;u<n;++u){var c;if(i?(c=i,i=null):(c=new rr,e.push(c)),c.x=s+u*a,c.y=o+l*h,c.width=a,c.height=h,++_===t)return c}}},(or.prototype=Object.create(bi.prototype)).getRenderList=function(t){return this._renderList[t]},or.prototype.collect=function(t,e){(this._collectorCamera=t).worldMatrix.getColumn(1,this._cameraYAxis),this._bounds.clear(),this._renderItemPool.reset();for(var i=te.OPTIONS.numShadowCascades,n=0;n<i;++n)this._renderList[n]=[];for(e.acceptVisitor(this),n=0;n<i;++n)this._renderList[n].sort(Hi)},or.prototype.getBounds=function(){return this._bounds},or.prototype.setRenderCameras=function(t){this._renderCameras=t},or.prototype.setCullPlanes=function(t,e){this._cullPlanes=t,this._numCullPlanes=e},or.prototype.visitMeshInstance=function(t){if(t._castShadows&&t.enabled){var e=t.skeleton,i=t.skeletonMatrices,n=t._entity,r=n.worldBounds;this._bounds.growToIncludeBound(r);for(var s=$t.DIR_LIGHT_SHADOW_MAP_PASS,o=te.OPTIONS.numShadowCascades,a=this._cameraYAxis,h=a.x,_=a.y,l=a.z,u=0;u<o;++u){var c=this._renderList[u],d=this._renderCameras[u];if(r.intersectsConvexSolid(d.frustum.planes,4)){var f=t.material;if(f.hasPass(s)){var p=this._renderItemPool.getItem();p.pass=f.getPass(s),p.meshInstance=t,p.worldMatrix=n.worldMatrix,p.camera=d,p.material=f,p.skeleton=e,p.skeletonMatrices=i;var m=r._center;p.renderOrderHint=m.x*h+m.y*_+m.z*l,c.push(p)}}}}},or.prototype.qualifies=function(t){return t.hierarchyVisible&&t.worldBounds.intersectsConvexSolid(this._cullPlanes,this._numCullPlanes)},ar.prototype={render:function(t,e,i,n){this._inverseLightMatrix.inverseAffineOf(t.entity.worldMatrix),this._updateCollectorCamera(t,i),this._updateSplits(t,i),this._updateCullPlanes(t,i),this._collectShadowCasters(n),this._updateCascadeCameras(t,e,i,this._casterCollector.getBounds());for(var r=$t.DIR_LIGHT_SHADOW_MAP_PASS,s=te.OPTIONS.numShadowCascades,o=1/e.size,a=0;a<s;++a){var h=e.getNextRect();B.setViewport(h);var _=t._shadowMatrices[a];_.copyFrom(this._shadowMapCameras[a].viewProjectionMatrix),_.appendScale(.5),_.appendTranslation(.5,.5,.5),_.appendScale(h.width*o,h.height*o,1),_.appendTranslation(h.x*o,h.y*o,0),nr(this,r,this._casterCollector.getRenderList(a))}},_updateCollectorCamera:function(t,e){var i=e.frustum._corners,n=new O,r=new O,s=new O;this._inverseLightMatrix.transformPoint(i[0],n),r.copyFrom(n);for(var o=1;o<8;++o)this._inverseLightMatrix.transformPoint(i[o],s),n.minimize(s),r.maximize(s);this._maxY=r.y,this._collectorCamera.matrix.copyFrom(t.entity.worldMatrix),this._collectorCamera._invalidateWorldMatrix(),this._collectorCamera.setBounds(n.x,r.x+1,r.z+1,n.z)},_updateSplits:function(t,e){for(var i=e.nearDistance,n=e.farDistance-i,r=te.OPTIONS.numShadowCascades,s=t._cascadeSplitDistances,o=t._cascadeSplitRatios,a=0;a<r;++a)s[a]=i+o[a]*n},_updateCascadeCameras:function(t,e,i,n){this._localBounds.transformFrom(n,this._inverseLightMatrix);for(var r=this._localBounds.minimum,s=this._localBounds.maximum,o=new O,a=new O,h=new O,_=new O,l=i.frustum.corners,u=0,c=te.OPTIONS.numShadowCascades,d=0;d<c;++d){var f=t._cascadeSplitRatios[d],p=this._shadowMapCameras[d];p.matrix=t.entity.worldMatrix;for(var m=0;m<4;++m){var g=l[m],x=l[m+4],v=g.x,y=g.y,T=g.z,S=x.x-v,E=x.y-y,w=x.z-T;o.x=v+S*u,o.y=y+E*u,o.z=T+w*u,a.x=v+S*f,a.y=y+E*f,a.z=T+w*f,this._inverseLightMatrix.transformPoint(o,o),this._inverseLightMatrix.transformPoint(a,a),0===m?(h.copyFrom(o),_.copyFrom(o)):(h.minimize(o),_.maximize(o)),h.minimize(a),_.maximize(a)}u=f,_.y=Math.min(this._maxY,_.y);var A=Math.max(h.x,r.x),P=Math.min(_.x,s.x),M=Math.max(h.z,r.z),L=Math.min(_.z,s.z),R=P-A,b=L-M;R=1*Math.ceil(R/1),b=1*Math.ceil(b/1),R=Math.max(R,1),b=Math.max(b,1);var I=e.size/R*.5,N=e.size/b*.5;P=(A=Math.floor(A*I)/I)+R,L=(M=Math.floor(M*N)/N)+b;var D=te.OPTIONS.shadowFilter.softness?te.OPTIONS.shadowFilter.softness:.002;p.setBounds(A-D,P+D,L+D,M-D),p.nearDistance=r.y,p.farDistance=_.y}},_updateCullPlanes:function(t,e){for(var i=this._collectorCamera.frustum,n=i._planes,r=0;r<4;++r)this._cullPlanes[r]=n[r];this._numCullPlanes=4,n=(i=e.frustum)._planes;for(var s=t.direction,o=0;o<6;++o){var a=n[o];.001<a.dot3(s)&&(this._cullPlanes[this._numCullPlanes++]=a)}},_collectShadowCasters:function(t){this._casterCollector.setCullPlanes(this._cullPlanes,this._numCullPlanes),this._casterCollector.setRenderCameras(this._shadowMapCameras),this._casterCollector.collect(this._collectorCamera,t)},_initCameras:function(){this._shadowMapCameras=[];for(var t=0;t<te.OPTIONS.numShadowCascades;++t)this._shadowMapCameras[t]=new fn}},(hr.prototype=Object.create(bi.prototype)).getRenderList=function(t){return this._renderLists[t]},hr.prototype.setLightBounds=function(t){this._lightBounds=t},hr.prototype.collect=function(t,e){this._cameras=t,this._renderLists=[];for(var i=this._cameraPos=t[0].position,n=0;n<6;++n){var r=this._octantPlanes[n];r.w=-(i.x*r.x+i.y*r.y+i.z*r.z),this._renderLists[n]=[]}for(this._renderItemPool.reset(),e.acceptVisitor(this),n=0;n<6;++n)this._renderLists[n].sort(Hi)},hr.prototype.visitMeshInstance=function(t){if(t._castShadows&&t.enabled){var e=t.entity,i=e.worldBounds,n=e.worldMatrix,r=this._octantPlanes,s=i.classifyAgainstPlane(r[0]),o=i.classifyAgainstPlane(r[1]),a=i.classifyAgainstPlane(r[2]),h=i.classifyAgainstPlane(r[3]),_=i.classifyAgainstPlane(r[4]),l=i.classifyAgainstPlane(r[5]);0<=o&&a<=0&&0<=_&&l<=0&&this._addTo(t,0,i,n),o<=0&&0<=a&&_<=0&&0<=l&&this._addTo(t,1,i,n),0<=s&&h<=0&&0<=_&&0<=l&&this._addTo(t,2,i,n),s<=0&&0<=h&&_<=0&&l<=0&&this._addTo(t,3,i,n),s<=0&&o<=0&&a<=0&&h<=0&&this._addTo(t,4,i,n),0<=s&&0<=o&&0<=a&&0<=h&&this._addTo(t,5,i,n)}},hr.prototype._addTo=function(t,e,i,n){var r=t.skeleton,s=t.skeletonMatrices,o=this._renderItemPool,a=this._cameraPos,h=a.x,_=a.y,l=a.z,u=this._renderLists[e],c=this._cameras[e],d=t.material,f=o.getItem();f.material=d,f.meshInstance=t,f.skeleton=r,f.skeletonMatrices=s;var p=i._center,m=h-p.x,g=_-p.y,x=l-p.z;f.renderOrderHint=m*m+g*g+x*x,f.worldMatrix=n,f.camera=c,f.worldBounds=i,u.push(f)},hr.prototype.qualifies=function(t){return t.hierarchyVisible&&t.worldBounds.intersectsBound(this._lightBounds)},_r.prototype={render:(Kn=new O,function(t,e,i,n){var r=t.entity;r.worldMatrix.getColumn(3,Kn);for(var s=0;s<6;++s){var o=this._cameras[s],a=t._radius;o.farDistance=a,o.position.copyFrom(Kn)}this._casterCollector.setLightBounds(r.worldBounds),this._casterCollector.collect(this._cameras,n),B.setInvertCulling(!0);var h=1/e.size;for(s=0;s<6;++s){var _=e.getNextRect();B.setViewport(_);var l=_.width*h,u=_.height*h,c=_.x*h,d=_.y*h;t._shadowTiles[s].set(.5*l,.5*u,.5*l+c,.5*u+d),nr(this,$t.POINT_LIGHT_SHADOW_MAP_PASS,this._casterCollector.getRenderList(s),t)}B.setInvertCulling(!1),B.setColorMask(!0)}),_initFaces:function(){this._cameras=[],(new N).fromAxisAngle(O.Z_AXIS,Math.PI);for(var t=[],e=0;e<6;++e)t[e]=new N;for(t[0].fromAxisAngle(O.Z_AXIS,.5*-Math.PI),t[1].fromAxisAngle(O.Z_AXIS,.5*Math.PI),t[2].fromAxisAngle(O.Z_AXIS,0),t[3].fromAxisAngle(O.Z_AXIS,Math.PI),t[4].fromAxisAngle(O.X_AXIS,.5*Math.PI),t[5].fromAxisAngle(O.X_AXIS,.5*-Math.PI),e=0;e<6;++e){var i=new Ci;i.nearDistance=.01,i.verticalFOV=.5*Math.PI,i.rotation.copyFrom(t[e]),i.scale.set(1,1,-1),this._cameras.push(i)}}},(lr.prototype=Object.create(bi.prototype)).getRenderList=function(){return this._renderList},lr.prototype.collect=function(t,e){this._camera=t,this._renderList=[],t.worldMatrix.getColumn(1,this._cameraYAxis),this._frustumPlanes=t.frustum._planes,this._renderItemPool.reset(),e.acceptVisitor(this),this._renderList.sort(Hi)},lr.prototype.visitMeshInstance=function(t){if(t._castShadows&&t.enabled){var e=t.entity,i=e.worldBounds,n=this._cameraYAxis,r=n.x,s=n.y,o=n.z,a=t.skeleton,h=t.skeletonMatrices,_=this._renderItemPool,l=this._camera,u=this._renderList,c=t.material,d=_.getItem();d.material=c,d.meshInstance=t,d.skeleton=a,d.skeletonMatrices=h;var f=i._center;d.renderOrderHint=f.x*r+f.y*s+f.z*o,d.worldMatrix=e.worldMatrix,d.camera=l,d.worldBounds=i,u.push(d)}},lr.prototype.qualifies=function(t){return t.visible&&t.worldBounds.intersectsConvexSolid(this._frustumPlanes,6)},ur.prototype={render:function(t,e,i,n){this._camera.verticalFOV=t.outerAngle,this._camera.farDistance=t._radius,this._camera.matrix.copyFrom(t.entity.worldMatrix),this._camera._invalidateWorldMatrix(),this._casterCollector.collect(this._camera,n);var r=e.getNextRect(),s=1/e.size;B.setViewport(r),t.shadowMatrix.copyFrom(this._camera.viewProjectionMatrix);var o=r.width*s,a=r.height*s,h=r.x*s,_=r.y*s;t._shadowTile.set(.5*o,.5*a,.5*o+h,.5*a+_),nr(this,$t.POINT_LIGHT_SHADOW_MAP_PASS,this._casterCollector.getRenderList(),t)}},cr.DebugMode={NONE:0,SSAO:1,NORMAL_DEPTH:2,SHADOW_MAP:3},(cr.HDRBuffers=function(t){this.texture=new Dt,this.texture.filter=Ee.BILINEAR_NOMIP,this.texture.wrapMode=we.CLAMP,this.fbo=new Ft(this.texture),this.fboDepth=new Ft(this.texture,t)}).prototype={resize:function(t,e){this.texture.initEmpty(t,e,Ne.RGBA,Se.HDR_FORMAT),this.fbo.init(),this.fboDepth.init()}},cr.prototype={get debugMode(){return this._debugMode},set debugMode(t){this._debugMode=t},get shadowMapSize(){return this._shadowAtlas.width},set shadowMapSize(t){this._shadowAtlas.resize(t,t)},get depthPrepass(){return this._depthPrepass},set depthPrepass(t){this._depthPrepass=t},get renderTarget(){return this._renderTarget},set renderTarget(t){this._renderTarget=t},get backgroundColor(){return this._backgroundColor},set backgroundColor(t){t instanceof h?this._backgroundColor.copyFrom(t):this._backgroundColor.set(t)},get camera(){return this._camera},render:function(t,e,i){this._gammaApplied=!1,this._camera=t,this._scene=e,this._camera._updateClusterPlanes(),this._updateSize(this._renderTarget),t._setRenderTargetResolution(this._width,this._height),this._renderCollector.collect(t,e),this._ambientColor=this._renderCollector._ambientColor,this._renderShadowCasters(),B.setDepthMask(!0),B.setColorMask(!0),this._renderNormalDepth(),this._renderAO(),B.setRenderTarget(this._hdrFront.fboDepth),B.setClearColor(this._backgroundColor),B.clear(),this._renderDepthPrepass(),Se.WEBGL_2?this._renderClustered():this._renderForward(),this._swapHDRFrontAndBack(),this._renderEffects(i),B.setColorMask(!0),this._renderToScreen(),B.setBlendState(),B.setDepthMask(!0)},_renderDepthPrepass:function(){this._depthPrepass&&(B.lockColorMask(!1),nr(this,$t.NORMAL_DEPTH_PASS,this._renderCollector.getOpaqueRenderList(fi.FORWARD_FIXED)),nr(this,$t.NORMAL_DEPTH_PASS,this._renderCollector.getOpaqueRenderList(fi.FORWARD_DYNAMIC)),B.unlockColorMask(!0))},_renderClustered:function(){var t,e=this._renderCollector.getLights(),i=e.length,n=this._lightingDataView,r=this._cellData,s=this._camera,o=te.OPTIONS.maxDirLights,a=te.OPTIONS.maxLightProbes,h=te.OPTIONS.maxPointSpotLights,_=16,l=320*o+_,u=16*a+l,c=0,d=0,f=0,p=te.OPTIONS.numLightingCellsX*te.OPTIONS.numLightingCellsY,m=this._cellStride;for(t=0;t<p;++t)r[t*m]=0;for(t=0;t<a;++t)this._diffuseProbeArray[t]=Ot.DEFAULT,this._specularProbeArray[t]=Ot.DEFAULT;for(t=0;t<i;++t){var g=e[t];g instanceof ri&&c<o?(this.writeDirectionalLight(g,s,n,_),_+=320,++c):g instanceof ai&&f<a?(this.writeLightProbe(g,n,l),g.diffuseTexture&&(this._diffuseProbeArray[f]=g.diffuseTexture),g.specularTexture&&(this._specularProbeArray[f]=g.specularTexture),l+=16,++f):g instanceof oi&&d<h?(this.writePointSpotLight(g,s,n,u,!1,r,d),u+=224,++d):g instanceof hi&&d<h&&(this.writePointSpotLight(g,s,n,u,!0,r,d),u+=224,++d)}n.setInt32(0,c,!0),n.setInt32(4,f,!0),n.setInt32(8,d,!0),this._lightingUniformBuffer.uploadData(this._lightingDataView),this._lightingCellsUniformBuffer.uploadData(this._cellData),nr(this,$t.BASE_PASS,this._renderCollector.getOpaqueRenderList(fi.FORWARD_FIXED)),nr(this,$t.BASE_PASS,this._renderCollector.getOpaqueRenderList(fi.FORWARD_DYNAMIC)),this._renderCollector.needsBackbuffer&&this._copyBackbuffer(),nr(this,$t.BASE_PASS,this._renderCollector.getTransparentRenderList(fi.FORWARD_FIXED)),nr(this,$t.BASE_PASS,this._renderCollector.getTransparentRenderList(fi.FORWARD_DYNAMIC))},writePointSpotLight:(tr=new O,er=new O,ir=new F,function(t,e,i,n,r,s,o){var a,h=t._scaledIrradiance,_=t.entity.worldMatrix,l=e.viewMatrix;if(i.setFloat32(n,h.r,!0),i.setFloat32(n+4,h.g,!0),i.setFloat32(n+8,h.b,!0),i.setFloat32(n+12,t.radius,!0),_.getColumn(3,tr),l.transformPoint(tr,tr),i.setFloat32(n+16,tr.x,!0),i.setFloat32(n+20,tr.y,!0),i.setFloat32(n+24,tr.z,!0),i.setFloat32(n+28,1/t.radius,!0),r?(_.getColumn(1,er),l.transformVector(er,er),i.setFloat32(n+32,er.x,!0),i.setFloat32(n+36,er.y,!0),i.setFloat32(n+40,er.z,!0),i.setUint32(n+112,1,!0),i.setFloat32(n+120,t._cosOuter,!0),i.setFloat32(n+124,1/Math.max(t._cosInner-t._cosOuter,1e-5),!0)):i.setUint32(n+112,0,!0),i.setUint32(n+116,t.castShadows?1:0,!0),t.castShadows){var u;if(i.setFloat32(n+44,t.depthBias,!0),r){ir.multiply(t._shadowMatrix,e.worldMatrix),u=ir._m;var c=t._shadowTile;i.setFloat32(n+128,c.x,!0),i.setFloat32(n+132,c.y,!0),i.setFloat32(n+136,c.z,!0),i.setFloat32(n+140,c.w,!0)}else{u=e.worldMatrix._m,a=n+128;for(var d=0;d<6;++d)c=t._shadowTiles[d],i.setFloat32(a,c.x,!0),i.setFloat32(a+4,c.y,!0),i.setFloat32(a+8,c.z,!0),i.setFloat32(a+12,c.w,!0),a+=16}a=n+48;for(var f=0;f<16;++f)i.setFloat32(a,u[f],!0),a+=4}r&&l.transformPoint(t.entity.worldBounds.center,tr),this.assignToCells(t,e,o,tr,s,r?er:null)}),assignToCells:($n=new O,function(t,e,i,n,r,s){var o=this._cellStride,a=t.entity.worldBounds.getRadius(),h=te.OPTIONS.numLightingCellsX,_=te.OPTIONS.numLightingCellsY,l=e._clusterPlanesW,u=e._clusterPlanesH;e.projectionMatrix.projectPoint(n,$n);var c=Math.floor((.5*$n.x+.5)*h),d=Math.floor((.5*$n.y+.5)*_);c<0?c=0:h<=c&&(c=h-1),d<0?d=0:_<=d&&(d=_-1);for(var f,p,m=c,g=c,x=c;0<=x&&!(l[m=x].dot4(n)>a);--x);for(x=c+1;x<h&&!(-l[(g=x)+1].dot4(n)>a);++x);for(var v=d;0<=v;--v){for(x=m;x<=g;++x)p=++r[f=(x+v*h)*o],r[f+p]=i;if(u[v].dot4(n)>a)break}for(v=d+1;v<_;++v){for(x=m;x<=g;++x)p=++r[f=(x+v*h)*o],r[f+p]=i;if(-u[v+1].dot4(n)>a)break}}),writeLightProbe:function(t,e,i){e.setUint32(i,t.diffuseTexture?1:0,!0);var n=t.specularTexture;if(n){e.setUint32(i+4,1,!0);var r=Math.floor(I.log2(n.size));e.setFloat32(i+8,r,!0)}else e.setUint32(i+4,0,!0)},writeDirectionalLight:(Jn=new O,Qn=new F,function(t,e,i,n){var r=t._scaledIrradiance;if(i.setFloat32(n,r.r,!0),i.setFloat32(n+4,r.g,!0),i.setFloat32(n+8,r.b,!0),e.viewMatrix.transformVector(t.direction,Jn),i.setFloat32(n+16,Jn.x,!0),i.setFloat32(n+20,Jn.y,!0),i.setFloat32(n+24,Jn.z,!0),i.setUint32(n+28,t.castShadows?1:0,!0),t.castShadows){for(var s=te.OPTIONS.numShadowCascades,o=t._cascadeSplitDistances,a=Qn._m,h=n+32,_=0;_<s;++_){Qn.multiply(t.getShadowMatrix(_),e.worldMatrix);for(var l=0;l<16;++l)i.setFloat32(h,a[l],!0),h+=4}i.setFloat32(n+288,o[0],!0),i.setFloat32(n+292,o[1],!0),i.setFloat32(n+296,o[2],!0),i.setFloat32(n+300,o[3],!0),i.setFloat32(n+304,t.depthBias,!0),i.setFloat32(n+308,o[s-1],!0)}}),_copyBackbuffer:function(){B.setRenderTarget(this._hdrBack.fbo),B.clear(),this._copyTextureShader.execute(It.DEFAULT,this._hdrFront.texture),B.setRenderTarget(this._hdrFront.fboDepth)},_renderForward:function(){this._renderForwardOpaque(),this._renderCollector.needsBackbuffer&&this._copyBackbuffer(),this._renderForwardTransparent()},_renderForwardOpaque:function(){nr(this,$t.BASE_PASS,this._renderCollector.getOpaqueRenderList(fi.FORWARD_FIXED));var t=this._renderCollector.getOpaqueRenderList(fi.FORWARD_DYNAMIC);0!==t.length&&this._renderOpaqueDynamicMultipass(t)},_renderOpaqueDynamicMultipass:function(t){nr(this,$t.BASE_PASS,t);for(var e=this._renderCollector.getLights(),i=e.length,n=0;n<i;++n){var r=e[n];r instanceof ai?nr(this,$t.LIGHT_PROBE_PASS,t,r):r instanceof ri?nr(this,$t.DIR_LIGHT_PASS,t,r):r instanceof oi?this._renderLightPassIfIntersects(r,$t.POINT_LIGHT_PASS,t):r instanceof hi&&this._renderLightPassIfIntersects(r,$t.SPOT_LIGHT_PASS,t)}},_renderForwardTransparent:function(){for(var t=this._renderCollector.getLights(),e=t.length,i=this._renderCollector.getTransparentRenderList(),n=i.length,r=0;r<n;++r){var s=i[r];if(this._renderSingleItemSingleLight($t.BASE_PASS,s),s.material._renderPath===fi.FORWARD_DYNAMIC)for(var o=0;o<e;++o){var a=t[o];if(a instanceof ai)this._renderSingleItemSingleLight($t.LIGHT_PROBE_PASS,s,a);else if(a instanceof ri){var h=a.castShadows?$t.DIR_LIGHT_SHADOW_PASS:$t.DIR_LIGHT_PASS;this._renderSingleItemSingleLight(h,s,a)}else a instanceof oi?this._renderLightPassIfIntersects(a,$t.POINT_LIGHT_PASS,i):a instanceof hi&&this._renderLightPassIfIntersects(a,$t.SPOT_LIGHT_PASS,i)}}B.setBlendState()},_renderLightPassIfIntersects:function(t,e,i){for(var n=t.entity.worldBounds,r=i.length,s=0;s<r;++s){var o=i[s];o.material.getPass(e)&&(n.intersectsBound(o.worldBounds)&&this._renderSingleItemSingleLight(e,o,t))}},_renderSingleItemSingleLight:function(t,e,i){var n=e.material.getPass(t);if(n){var r=e.meshInstance;n.updatePassRenderState(e.camera,this,i),n.updateInstanceRenderState(e.camera,e,i),r.updateRenderState(t);var s=r._mesh;B.drawElements(n._elementType,s._numIndices,0,s._indexType)}},_renderNormalDepth:function(){var t=this._renderCollector,e=t.getOpaqueRenderList(fi.FORWARD_DYNAMIC),i=t.getOpaqueRenderList(fi.FORWARD_FIXED);t.needsNormalDepth&&(B.setRenderTarget(this._normalDepthFBO),B.setClearColor(h.BLUE),B.clear(),nr(this,$t.NORMAL_DEPTH_PASS,e),nr(this,$t.NORMAL_DEPTH_PASS,i))},_renderAO:function(){var t=te.OPTIONS.ambientOcclusion;t&&(this._ssaoTexture=t.getAOTexture(),t.render(this,0))},_renderShadowCasters:function(){this._shadowAtlas.initRects(this._renderCollector.shadowPlaneBuckets,this._renderCollector.numShadowPlanes);var t=this._renderCollector.getShadowCasters(),e=t.length;B.setRenderTarget(this._shadowAtlas.fbo),B.setClearColor(h.WHITE),B.clear();for(var i=0;i<e;++i){var n=t[i];n instanceof ri?this._cascadeShadowRenderer.render(n,this._shadowAtlas,this._camera,this._scene):n instanceof oi?this._omniShadowRenderer.render(n,this._shadowAtlas,this._camera,this._scene):n instanceof hi&&this._spotShadowRenderer.render(n,this._shadowAtlas,this._camera,this._scene)}this._shadowAtlas.blur()},_renderEffect:function(t,e){this._gammaApplied=this._gammaApplied||t._outputsGamma,t.render(this,e)},_renderToScreen:function(){if(B.setRenderTarget(this._renderTarget),B.clear(),this._debugMode){var t;switch(this._debugMode){case cr.DebugMode.NORMAL_DEPTH:t=this._normalDepthBuffer;break;case cr.DebugMode.SHADOW_MAP:t=this._shadowAtlas.texture;break;case cr.DebugMode.SSAO:t=this._ssaoTexture}this._copyTextureShader.execute(It.DEFAULT,t)}else this._gammaApplied?this._copyTextureShader.execute(It.DEFAULT,this._hdrBack.texture):this._applyGamma.execute(It.DEFAULT,this._hdrBack.texture)},_renderEffects:function(t){var e=this._renderCollector.getEffects();if(e)for(var i=e.length,n=0;n<i;++n){var r=e[n];r.isSupported()&&(this._renderEffect(r,t),this._swapHDRFrontAndBack())}},_updateSize:function(){var t,e;this._renderTarget?(t=this._renderTarget.width,e=this._renderTarget.height):(t=te.TARGET_CANVAS.width,e=te.TARGET_CANVAS.height),this._width===t&&this._height===e||(this._width=t,this._height=e,this._depthBuffer.init(this._width,this._height,!0),this._hdrBack.resize(this._width,this._height),this._hdrFront.resize(this._width,this._height),this._normalDepthBuffer.initEmpty(t,e),this._normalDepthFBO.init())},_swapHDRFrontAndBack:function(){var t=this._hdrBack;this._hdrBack=this._hdrFront,this._hdrFront=t},_createDepthBuffer:function(){return new qn}},$e.create(dr,{},ai),dr.prototype.render=function(){var t=this._specularTexture,e=this._diffuseTexture;this._specularTexture=Te.DARK_CUBE_TEXTURE,this._diffuseTexture=Te.DARK_CUBE_TEXTURE;var i=this._entity.worldMatrix.getColumn(3),n=this._entity._scene;B.setInvertCulling(!0);for(var r=0;r<6;++r)this._cameras[r].position.copyFrom(i),this._renderer.render(this._cameras[r],n,0,this._specularFBOs[r]);for(t.generateMipmap(),r=0;r<6;++r)this._renderer.render(this._cameras[r],this._diffuseScene,0,this._diffuseFBOs[r]);e.generateMipmap(),B.setInvertCulling(!1),this._diffuseTexture=e,this._specularTexture=t},dr.prototype.clone=function(){var t=new dr(this._diffuseTexture.size,this._diffuseTexture.dataType,this._cameras[0].nearDistance,this._cameras[0].farDistance);return t.size=this.size,t},(fr.prototype=Object.create(gt.prototype)).execute=function(t,e,i,n){var r=B.gl;B.setDepthTest(Me.DISABLED),B.setCullMode(Ae.NONE),t._vertexBuffers[0].bind(),t._indexBuffer.bind(),this.updatePassRenderState(),e.bind(0),r.vertexAttribPointer(this._positionAttributeLocation,2,r.FLOAT,!1,16,0),r.vertexAttribPointer(this._texCoordAttributeLocation,2,r.FLOAT,!1,16,8),B.enableAttributes(2),r.uniform2f(this._directionLocation,i,n),B.drawElements(Le.TRIANGLES,6,0)},(pr.prototype=Object.create(x.prototype,{shadowMapFilter:{get:function(){return Ee.BILINEAR_NOMIP}},blurRadius:{get:function(){return this._blurRadius},set:function(t){this._blurRadius=t,this._invalidateBlurShader()}},darkeningFactor:{get:function(){return this._darkeningFactor},set:function(t){this._darkeningFactor=t}},expScaleFactor:{get:function(){return this._expScaleFactor},set:function(t){this._expScaleFactor=t}}})).getShadowMapFormat=function(){return Ne.RG||Ne.RGB},pr.prototype.getShadowMapDataType=function(){return De.FLOAT},pr.prototype.getGLSL=function(){var t=this._getDefines();return d.get("shadow_esm.glsl",t)},pr.prototype._getDefines=function(){return{HX_ESM_CONSTANT:"float("+this._expScaleFactor+")",HX_ESM_DARKENING:"float("+this._darkeningFactor+")"}},pr.prototype._createBlurShader=function(){return new fr(this._blurRadius)},(mr.prototype=Object.create(x.prototype,{softness:{get:function(){return this._softness},set:function(t){this._softness!==t&&(this._softness=t)}},numShadowSamples:{get:function(){return this._numShadowSamples},set:function(t){t=I.clamp(t,1,32),this._numShadowSamples!==t&&(this._numShadowSamples=t)}},dither:{get:function(){return this._dither},set:function(t){this._dither!==t&&(this._dither=t)}}})).getGLSL=function(){var t={HX_PCF_NUM_SHADOW_SAMPLES:this._numShadowSamples,HX_PCF_RCP_NUM_SHADOW_SAMPLES:"float("+1/this._numShadowSamples+")",HX_PCF_SOFTNESS:this._softness};return this._dither&&(t.HX_PCF_DITHER_SHADOWS=1),d.get("shadow_pcf.glsl",t)},(gr.prototype=Object.create(gt.prototype)).execute=function(t,e,i,n){var r=B.gl;B.setDepthTest(Me.DISABLED),B.setCullMode(Ae.NONE),t._vertexBuffers[0].bind(),t._indexBuffer.bind(),this.updatePassRenderState(),e.bind(0),r.vertexAttribPointer(this._positionAttributeLocation,2,De.FLOAT,!1,16,0),r.vertexAttribPointer(this._texCoordAttributeLocation,2,De.FLOAT,!1,16,8),B.enableAttributes(2),r.uniform2f(this._directionLocation,i,n),B.drawElements(r.TRIANGLES,6,0)},(xr.prototype=Object.create(x.prototype,{shadowMapFilter:{get:function(){return Ee.BILINEAR_NOMIP}},minVariance:{get:function(){return this._minVariance},set:function(t){this._minVariance=t}},blurRadius:{get:function(){return this._blurRadius},set:function(t){this._blurRadius=t,this._invalidateBlurShader()}},lightBleedReduction:{get:function(){return this._lightBleedReduction},set:function(t){this._lightBleedReduction=t}},useHalfFloat:{get:function(){return this._useHalfFloat},set:function(t){this._useHalfFloat=t}}})).getGLSL=function(){var t=this._getDefines();return d.get("shadow_vsm.glsl",t)},xr.prototype.getShadowMapFormat=function(){return Se.EXT_COLOR_BUFFER_HALF_FLOAT||Se.EXT_COLOR_BUFFER_FLOAT?Ne.RG||Ne.RGB:Ne.RGBA},xr.prototype.getShadowMapDataType=function(){return Se.EXT_COLOR_BUFFER_HALF_FLOAT&&this._useHalfFloat?De.HALF_FLOAT:Se.EXT_COLOR_BUFFER_FLOAT?De.FLOAT:De.UNSIGNED_BYTE},xr.prototype._createBlurShader=function(){return new gr(this._blurRadius)},xr.prototype._getDefines=function(){var t=1-this._lightBleedReduction;return{HX_VSM_MIN_VARIANCE:"float("+this._minVariance+")",HX_VSM_LIGHT_BLEED_REDUCTION:"float("+this._lightBleedReduction+")",HX_VSM_RCP_LIGHT_BLEED_REDUCTION_RANGE:"float("+1/t+")"}},(vr.prototype=Object.create(ke.prototype))._generate=function(t,e){for(var i=(e=e||{}).numSegmentsW||16,n=e.numSegmentsH||10,r=e.radius||.5,s=e.invert?-1:1,o=void 0!==e.doubleSided&&e.doubleSided,a=t.positions,h=t.uvs,_=t.normals,l=1/i,u=1/n,c=0;c<=n;++c){var d=c*u,f=d*Math.PI,p=-Math.cos(f),m=Math.sin(f);s<0&&(d=1-d);for(var g=0;g<=i;++g){var x=g*l,v=x*Math.PI*2;s&&(x=1-x);var y=Math.cos(v)*m*s,T=p*s,S=Math.sin(v)*m*s;a.push(y*r,S*r,T*r),_&&_.push(y*s,S*s,T*s),h&&h.push(x,d)}}var E=t.indices;for(c=0;c<n;++c)for(g=0;g<i;++g){var w=i+1,A=g+c*w;E.push(A,A+w+1,A+w),E.push(A,A+1,A+w+1),o&&(E.push(A,A+w,A+w+1),E.push(A,A+w+1,A+1))}},vr.prototype._getBounds=function(){return new si},yr.prototype=Object.create(ke.prototype),yr.ALIGN_X=1,yr.ALIGN_Y=2,yr.ALIGN_Z=3,yr.prototype._generate=function(t,e){var i,n,r,s,o,a=(e=e||{}).alignment||yr.ALIGN_Z,h=e.numSegmentsH||1,_=e.numSegmentsW||16,l=e.radius||.5,u=e.height||1,c=void 0!==e.doubleSided&&e.doubleSided,d=t.positions,f=t.uvs,p=t.normals,m=t.indices,g=1/_,x=1/h;for(i=0;i<=h;++i){var v=(1-i*x)*l,y=(i*x-.5)*u;for(n=0;n<=_;++n){o=n*g*Math.PI*2;var T=Math.sin(o),S=Math.cos(o);switch(r=T*v,s=S*v,a){case yr.ALIGN_X:d.push(y,s,r),p&&p.push(0,S,T);break;case yr.ALIGN_Z:d.push(r,-s,y),p&&p.push(T,-S,0);break;default:d.push(r,y,s),p&&p.push(T,0,S)}f&&f.push(1-n*g,i*x)}}var E,w=_+1;for(n=0;n<_;++n){for(i=0;i<h-1;++i)E=n+i*w,m.push(E,E+w+1,E+w),m.push(E,E+1,E+w+1),c&&(m.push(E,E+w,E+w+1),m.push(E,E+w+1,E+1));E=n+(h-1)*w,m.push(E,E+1,E+w+1)}var A=d.length/3,P=.5*u;for(n=0;n<_;++n){o=n*g*Math.PI*2;var M=Math.sin(o),L=Math.cos(o);switch(r=M*l,s=L*l,M=.5*-M+.5,L=.5*L+.5,a){case yr.ALIGN_X:d.push(-P,s,r),p&&p.push(-1,0,0),f&&f.push(L,1-M);break;case yr.ALIGN_Z:d.push(r,-s,-P),p&&p.push(0,0,-1),f&&f.push(M,L);break;default:d.push(r,-P,s),p&&p.push(0,-1,0),f&&f.push(M,L)}}for(n=1;n<_-1;++n)m.push(A,A+n+1,A+n)},Tr.prototype=Object.create(ke.prototype),Tr.ALIGN_XZ=1,Tr.ALIGN_XY=2,Tr.ALIGN_YZ=3,Tr.prototype._generate=function(t,e){var i=(e=e||{}).alignment||Tr.ALIGN_XY,n=e.numSegmentsW||1,r=e.numSegmentsH||1,s=e.width||1,o=e.height||1,a=void 0!==e.doubleSided&&e.doubleSided,h=t.positions,_=t.uvs,l=t.normals,u=t.indices,c=1/n,d=1/r,f=0,p=0,m=0,g=0,x=0,v=0,y=0,T=0;i===Tr.ALIGN_XY?v=1:i===Tr.ALIGN_XZ?x=1:g=1;for(var S=0;S<=r;++S)for(var E=(S*d-.5)*o,w=0;w<=n;++w){var A=(w*c-.5)*s;if(i===Tr.ALIGN_XY?(f=A,p=E):(i===Tr.ALIGN_XZ?f=A:p=A,m=E),y=1-w*c,T=S*d,h.push(f,p,m),l&&l.push(g,x,v),_&&_.push(y,T),a&&(h.push(f,p,m),l&&l.push(-g,-x,-v),_&&_.push(1-y,T)),w!==n&&S!==r){var P=n+1,M=w+S*P,L=a?1:0;u.push(M<<L,M+P+1<<L,M+P<<L),u.push(M<<L,M+1<<L,M+P+1<<L),a&&(u.push(1+(M+P<<L),1+(M+P+1<<L),1+(M<<L)),u.push(1+(M+P+1<<L),1+(M+1<<L),1+(M<<L)))}}},Sr.prototype=Object.create(ke.prototype),Sr.ALIGN_XY=1,Sr.ALIGN_XZ=2,Sr.ALIGN_YZ=3,Sr.prototype._generate=function(t,e){for(var i=(e=e||{}).numSegmentsW||15,n=e.numSegmentsH||20,r=e.radius||.5,s=e.tubeRadius||.1,o=e.alignment||Sr.ALIGN_XY,a=void 0!==e.doubleSided&&e.doubleSided,h=t.positions,_=t.uvs,l=t.normals,u=1/i,c=1/n,d=0;d<=n;++d)for(var f=d*c,p=f*Math.PI*2,m=Math.cos(p),g=Math.sin(p),x=0;x<=i;++x){var v=x*u,y=v*Math.PI*2,T=Math.cos(y),S=Math.sin(y),E=r+m*s;switch(o){case Sr.ALIGN_XZ:h.push(T*E,-g*s,S*E),l&&l.push(T*m,-g,S*m);break;case Sr.ALIGN_XY:h.push(T*E,S*E,g*s),l&&l.push(T*m,S*m,g);break;case Sr.ALIGN_YZ:h.push(g*s,T*E,S*E),l&&l.push(g,T*m,S*m)}_&&_.push(v,1-f)}for(var w=t.indices,A=0;A<n;++A)for(var P=0;P<i;++P){var M=i+1,L=P+A*M;w.push(L,L+M+1,L+M),w.push(L,L+1,L+M+1),a&&(w.push(L,L+M,L+M+1),w.push(L,L+M+1,L+1))}},(Er.prototype=Object.create(ke.prototype))._generate=function(t,e){var i=e.width||1,n=.5*i,r=.5*(e.height||i),s=.5*(e.depth||i),o=t.positions,a=t.indices;o.push(-n,-s,-r),o.push(n,-s,-r),o.push(-n,-s,r),o.push(n,-s,r),o.push(-n,s,-r),o.push(n,s,-r),o.push(-n,s,r),o.push(n,s,r),a.push(0,1),a.push(2,3),a.push(0,2),a.push(1,3),a.push(4,5),a.push(6,7),a.push(4,6),a.push(5,7),a.push(0,4),a.push(2,6),a.push(1,5),a.push(3,7)},wr.prototype=Object.create(ke.prototype),wr.ALIGN_XZ=1,wr.ALIGN_XY=2,wr.ALIGN_YZ=3,wr.prototype._generate=function(t,e){for(var i=(e=e||{}).alignment||wr.ALIGN_XY,n=e.numSegmentsW||1,r=e.numSegmentsH||1,s=e.width||1,o=e.height||1,a=t.positions,h=t.indices,_=1/n,l=1/r,u=0,c=0,d=0,f=0;f<=r;++f)for(var p=(f*l-.5)*o,m=0;m<=n;++m){var g=(m*_-.5)*s;if(i===wr.ALIGN_XY?(u=g,c=p):(i===wr.ALIGN_XZ?u=g:c=g,d=p),a.push(u,c,d),m!==n&&f!==r){var x=n+1,v=m+f*x;h.push(v,v+1),h.push(v+1,v+x+1),h.push(v+x+1,v+x),h.push(v+x,v)}}},Ar.prototype={addView:function(t){t._texture=new Dt,t._texture.filter=Ee.BILINEAR_NOMIP,t._texture.wrapMode=we.CLAMP,t._fbo=new Ft(t._texture),t._renderer=new cr(t._fbo),this._views.push(t)},removeView:function(t){t._fbo=null,t._texture=null,t._renderer=null;var e=this._views.indexOf(t);this._views.splice(e,1)},render:function(t,e){for(var i=te.TARGET_CANVAS.clientWidth,n=te.TARGET_CANVAS.clientHeight,r=this._views.length,s=0;s<r;++s){var o=this._views[s],a=Math.floor(i*o.widthRatio),h=Math.floor(n*o.heightRatio);o._texture.width===a&&o._texture.height===h||(o._texture.initEmpty(a,h),o._fbo.init()),o._renderer.render(o.camera,o.scene,t)}B.setRenderTarget(e),B.clear();var _=new rr;for(s=0;s<r;++s)o=this._views[s],_.x=Math.floor(o.xRatio*i),_.y=Math.floor((1-o.yRatio-o.heightRatio)*n),_.width=o._texture.width,_.height=o._texture.height,B.setViewport(_),Te.COPY_SHADER.execute(It.DEFAULT,o._texture)}},Pr.prototype={queue:function(t,e){var i=1===arguments.length?[t]:Array.apply(null,arguments);this._queue.push({func:t,args:i.slice(1)})},addChildQueue:function(t){this._childQueues.push(t)},execute:function(){if(this._isRunning)throw new Error("Already running!");this._isRunning=!0,this._currentIndex=0,this._executeTask()},_executeTask:function(){setTimeout(this._executeImpl.bind(this))},_executeImpl:function(){if(this.onProgress.dispatch(this._currentIndex/this._queue.length),0<this._childQueues.length){var t=this._childQueues.shift();t.onComplete.bind(this._executeImpl,this),t.execute()}else if(this._queue.length===this._currentIndex)this.onComplete.dispatch();else{var e=this._queue[this._currentIndex];e.func.apply(this,e.args),++this._currentIndex,this._executeTask()}}};var Mr={execute:function(t){Te.COPY_SHADER.execute(It.DEFAULT,t)}},Lr={getFromImage:function(t){var e=document.createElement("canvas");return e.width=t.naturalWidth,e.height=t.naturalHeight,e.getContext("2d").drawImage(t,0,0),e.getImageData(0,0,e.width,e.height)}},Rr={merge:function(t,e,i){var n=new Dt;n.initEmpty(t.width,t.height);var r=new Ft(n);B.setRenderTarget(r),B.setClearColor(h.WHITE),B.clear();var s=B.gl;return t&&(s.colorMask(!0,!1,!1,!1),Te.COPY_SHADER.execute(It.DEFAULT,t)),e&&(s.colorMask(!1,!0,!1,!1),Te.COPY_SHADER.execute(It.DEFAULT,e)),i&&(s.colorMask(!1,!1,!0,!1),Te.COPY_SHADER.execute(It.DEFAULT,i)),s.colorMask(!0,!0,!0,!0),B.setRenderTarget(null),B.setClearColor(h.BLACK),n}},br={_isMobile:void 0,get isMobile(){if(void 0===this._isMobile){var t=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent);this._isMobile=t||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent)}return this._isMobile}};function Ir(){this.entity=null,this.component=null,this.point=new O,this.faceNormal=new O,this.t=1/0}function Nr(){this.meshInstance=null,this.closestDistanceSqr=0,this.objectMatrix=new F,this.next=null}function Dr(){bi.call(this),this._potentials=null,this._potentialPool=new Ui(Nr),this._localRay=new ze}function Or(t){this._numFrames=t||1,this._frames=[],this._maxFPS=void 0,this._minFPS=void 0,this._currentFPS=0,this._averageFPS=0;for(var e=this._runningSum=0;e<this._numFrames;++e)this._frames[e]=0;this._index=0}function Cr(t){this._fpsCounter=new Or(30),this._width=100,this._height=95,this._dpr=window.devicePixelRatio||1,this._elm=document.createElement("canvas"),this._elm.style.position="fixed",this._elm.style.left="5px",this._elm.style.top="5px",this._elm.style.width=this._width+"px",this._elm.style.height=this._height+"px",this._elm.width=this._pixelWidth=this._width*this._dpr,this._elm.height=this._pixelHeight=this._height*this._dpr;var e=10*this._dpr;this._context=this._elm.getContext("2d"),this._context.font=e+'px "Lucida Console",Monaco,monospace',(t=t||document.getElementsByTagName("body")[0]).appendChild(this._elm),ee.bind(this._update,this)}(Dr.prototype=Object.create(bi.prototype)).cast=function(t,e){this._potentials=[],this._ray=t,this._scene=e,this._potentialPool.reset(),e.acceptVisitor(this),this._potentials.sort(this._sortPotentialFunc);var i=this._findClosest();return i.entity?i:null},Dr.prototype.qualifies=function(t){return t.raycast&&t.visible&&t.worldBounds.intersectsRay(this._ray)},Dr.prototype.visitMeshInstance=function(t){var e=t._entity,i=this._potentialPool.getItem();i.meshInstance=t;var n=this._ray.direction,r=n.x,s=n.y,o=n.z,a=this._ray.origin,h=e.worldBounds,_=h.center,l=h._halfExtentX,u=h._halfExtentY,c=h._halfExtentZ;l=0<r?_.x-l:_.x+l,u=0<s?_.y-u:_.y+u,c=0<o?_.z-c:_.z+c,l-=a.x,u-=a.y,c-=a.z,i.closestDistanceSqr=l*r+u*s+c*o,i.objectMatrix.inverseAffineOf(e.worldMatrix),this._potentials.push(i)},Dr.prototype._findClosest=function(){for(var t=this._potentials,e=t.length,i=new Ir,n=this._ray,r=this._localRay,s=0;s<e;++s){var o=t[s];if(o.closestDistanceSqr>i.t*i.t)break;r.transformFrom(n,o.objectMatrix),this._testMesh(r,o.meshInstance.mesh,i)&&(i.entity=o.meshInstance.entity,i.component=o.meshInstance)}if(i.entity){var a=i.entity.worldMatrix;a.transformPoint(i.point,i.point),a.transformNormal(i.faceNormal,i.faceNormal)}return i},Dr.prototype._testMesh=function(t,e,i){for(var n=t.direction,r=t.origin,s=r.x,o=r.y,a=r.z,h=n.x,_=n.y,l=n.z,u=e.getVertexAttributeByName("hx_position"),c=e.getVertexData(u.streamIndex),d=e.getIndexData(),f=e.getVertexStride(u.streamIndex),p=d.length,m=u.offset,g=!1,x=0;x<p;x+=3){var v=d[x]*f+m,y=d[x+1]*f+m,T=d[x+2]*f+m,S=c[v],E=c[v+1],w=c[v+2],A=c[y]-S,P=c[y+1]-E,M=c[y+2]-w,L=c[T]-S,R=c[T+1]-E,b=c[T+2]-w,I=P*b-M*R,N=M*L-A*b,D=A*R-P*L,O=I*h+N*_+D*l;if(!(0<=O)){var C=I*s+N*o+D*a+-(I*S+N*E+D*w);if(!(C<0||(C/=-O)>=i.t)){var F=C*h+s,U=C*_+o,B=C*l+a,X=F-S,H=U-E,z=B-w,V=A*A+P*P+M*M,k=L*L+R*R+b*b,G=A*L+P*R+M*b,Y=V*k-G*G;if(0!==Y){var j=X*A+H*P+z*M,W=X*L+H*R+z*b,Z=1/Y,q=(k*j-G*W)*Z,K=(V*W-G*j)*Z;0<=q&&0<=K&&q+K<=1&&(i.faceNormal.set(I,N,D,0),i.point.set(F,U,B,1),i.t=C,g=!0)}}}}return i.faceNormal.normalize(),g},Dr.prototype._sortPotentialFunc=function(t,e){return t.closestDistanceSqr-e.closestDistanceSqr},Or.prototype={update:function(t){this._currentFPS=1e3/t,this._runningSum-=this._frames[this._index],this._runningSum+=this._currentFPS,this._averageFPS=this._runningSum/this._numFrames,this._frames[this._index++]=this._currentFPS,this._index===this._numFrames&&(this._index=0),(void 0===this._maxFPS||this._currentFPS>this._maxFPS)&&(this._maxFPS=this._currentFPS),(void 0===this._minFPS||this._currentFPS<this._minFPS)&&(this._minFPS=this._currentFPS)},get lastFrameFPS(){return Math.round(this._currentFPS)},get averageFPS(){return Math.round(this._averageFPS)},get maxFPS(){return Math.round(this._maxFPS)},get minFPS(){return Math.round(this._minFPS)},reset:function(){this._maxFPS=void 0,this._minFPS=void 0}},Cr.prototype={remove:function(){this._elm.parentNode.removeChild(this._elm)},_update:function(t){this._fpsCounter.update(t);var e=this._context;e.fillStyle="rgba(0, 0, 0, .5)",e.fillRect(0,0,this._pixelWidth,this._pixelHeight);var i=ne.toFixed(1),n=t.toFixed(1);e.fillStyle="#fff",e.fillText("FPS: "+this._fpsCounter.averageFPS,10*this._dpr,15*this._dpr),e.fillText("Time: "+i+" ("+n+") ",10*this._dpr,30*this._dpr),e.fillText("Draws: "+o.numDrawCalls,10*this._dpr,45*this._dpr),e.fillText("Tris: "+o.numTriangles,10*this._dpr,60*this._dpr),e.fillText("Clears: "+o.numClears,10*this._dpr,75*this._dpr)}},t.ShaderLibrary=d,t.init=function(t,e){if(te.INITIALIZED)throw new Error("Can only initialize Helix once!");(te.TARGET_CANVAS=t).width=t.clientWidth,t.height=t.clientHeight,te.OPTIONS=e=e||new Fe;var i,n={antialias:!1,alpha:te.OPTIONS.transparentBackground,depth:!1,stencil:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1},r="";if(e.webgl2&&(i=t.getContext("webgl2",n)),i?(Se.WEBGL_2=!0,console.log("WebGL 2 supported!"),E.VERSION="#version 300 es\n",r+="#define HX_GLSL_300_ES\n",$t.NUM_PASS_TYPES=4):i=t.getContext("webgl",n)||t.getContext("experimental-webgl",n),!i)throw new Error("WebGL not supported");B._setGL(i),te.INITIALIZED=!0;var s=i.getSupportedExtensions();function o(t){var e=0<=s.indexOf(t)?i.getExtension(t):null;return e||console.warn(t+" extension not supported!"),e}a=B.gl,Ee.NEAREST={min:a.NEAREST_MIPMAP_NEAREST,mag:a.NEAREST},Ee.BILINEAR={min:a.LINEAR_MIPMAP_NEAREST,mag:a.LINEAR},Ee.TRILINEAR={min:a.LINEAR_MIPMAP_LINEAR,mag:a.LINEAR},Se.EXT_TEXTURE_FILTER_ANISOTROPIC&&(Ee.TRILINEAR_ANISOTROPIC={min:a.LINEAR_MIPMAP_LINEAR,mag:a.LINEAR}),Ee.NEAREST_NOMIP={min:a.NEAREST,mag:a.NEAREST},Ee.BILINEAR_NOMIP={min:a.LINEAR,mag:a.LINEAR},we.REPEAT={s:a.REPEAT,t:a.REPEAT},we.CLAMP={s:a.CLAMP_TO_EDGE,t:a.CLAMP_TO_EDGE},we.DEFAULT=we.REPEAT,Ee.DEFAULT=Ee.TRILINEAR,Pe.KEEP=a.KEEP,Pe.ZERO=a.ZERO,Pe.REPLACE=a.REPLACE,Pe.INCREMENT=a.INCR,Pe.INCREMENT_WRAP=a.INCR_WRAP,Pe.DECREMENT=a.DECR,Pe.DECREMENT_WRAP=a.DECR_WRAP,Pe.INVERT=a.INVERT,Me.DISABLED=null,Me.ALWAYS=a.ALWAYS,Me.NEVER=a.NEVER,Me.LESS=a.LESS,Me.EQUAL=a.EQUAL,Me.LESS_EQUAL=a.LEQUAL,Me.GREATER=a.GREATER,Me.NOT_EQUAL=a.NOTEQUAL,Me.GREATER_EQUAL=a.GEQUAL,Le.POINTS=a.POINTS,Le.LINES=a.LINES,Le.LINE_STRIP=a.LINE_STRIP,Le.LINE_LOOP=a.LINE_LOOP,Le.TRIANGLES=a.TRIANGLES,Le.TRIANGLE_STRIP=a.TRIANGLE_STRIP,Le.TRIANGLE_FAN=a.TRIANGLE_FAN,Re.ZERO=a.ZERO,Re.ONE=a.ONE,Re.SOURCE_COLOR=a.SRC_COLOR,Re.ONE_MINUS_SOURCE_COLOR=a.ONE_MINUS_SRC_COLOR,Re.DESTINATION_COLOR=a.DST_COLOR,Re.ONE_MINUS_DESTINATION_COLOR=a.ONE_MINUS_DST_COLOR,Re.SOURCE_ALPHA=a.SRC_ALPHA,Re.ONE_MINUS_SOURCE_ALPHA=a.ONE_MINUS_SRC_ALPHA,Re.DESTINATION_ALPHA=a.DST_ALPHA,Re.ONE_MINUS_DESTINATION_ALPHA=a.ONE_MINUS_DST_ALPHA,Re.SOURCE_ALPHA_SATURATE=a.SRC_ALPHA_SATURATE,Re.CONSTANT_ALPHA=a.CONSTANT_ALPHA,Re.ONE_MINUS_CONSTANT_ALPHA=a.ONE_MINUS_CONSTANT_ALPHA,be.ADD=a.FUNC_ADD,be.SUBTRACT=a.FUNC_SUBTRACT,be.REVERSE_SUBTRACT=a.FUNC_REVERSE_SUBTRACT,Ie.COLOR=a.COLOR_BUFFER_BIT,Ie.STENCIL=a.STENCIL_BUFFER_BIT,Ie.DEPTH=a.DEPTH_BUFFER_BIT,Ie.COMPLETE=a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT,Ne.RGBA=a.RGBA,Ne.RGB=a.RGB,Ne.RG=a.RG,De.UNSIGNED_BYTE=a.UNSIGNED_BYTE,De.UNSIGNED_SHORT=a.UNSIGNED_SHORT,De.UNSIGNED_INT=a.UNSIGNED_INT,De.FLOAT=a.FLOAT,De.HALF_FLOAT=a.HALF_FLOAT,Oe.STATIC_DRAW=a.STATIC_DRAW,Oe.DYNAMIC_DRAW=a.DYNAMIC_DRAW,Ce.POSITIVE_X=a.TEXTURE_CUBE_MAP_POSITIVE_X,Ce.NEGATIVE_X=a.TEXTURE_CUBE_MAP_NEGATIVE_X,Ce.POSITIVE_Y=a.TEXTURE_CUBE_MAP_POSITIVE_Z,Ce.NEGATIVE_Y=a.TEXTURE_CUBE_MAP_NEGATIVE_Z,Ce.POSITIVE_Z=a.TEXTURE_CUBE_MAP_POSITIVE_Y,Ce.NEGATIVE_Z=a.TEXTURE_CUBE_MAP_NEGATIVE_Y,!1!==e.useGammaCorrection&&(r+=te.OPTIONS.usePreciseGammaCorrection?"#define HX_GAMMA_CORRECTION_PRECISE\n":"#define HX_GAMMA_CORRECTION_FAST\n"),r+="#define HX_NUM_SHADOW_CASCADES "+te.OPTIONS.numShadowCascades+"\n",r+="#define HX_MAX_SKELETON_JOINTS "+te.OPTIONS.maxSkeletonJoints+"\n",Se.EXT_DRAW_BUFFERS=!!Se.WEBGL_2||o("WEBGL_draw_buffers"),Se.EXT_FLOAT_TEXTURES=!!Se.WEBGL_2||o("OES_texture_float"),Se.EXT_FLOAT_TEXTURES_LINEAR=o("OES_texture_float_linear"),Se.EXT_HALF_FLOAT_TEXTURES=!!Se.WEBGL_2||o("OES_texture_half_float"),Se.EXT_HALF_FLOAT_TEXTURES_LINEAR=o("OES_texture_half_float_linear"),Se.EXT_COLOR_BUFFER_FLOAT=o("EXT_color_buffer_float")||o("WEBGL_color_buffer_float"),Se.EXT_COLOR_BUFFER_HALF_FLOAT=o("EXT_color_buffer_float")||o("EXT_color_buffer_half_float"),Se.EXT_DEPTH_TEXTURE=o("WEBGL_depth_texture"),Se.EXT_STANDARD_DERIVATIVES=o("OES_standard_derivatives"),Se.EXT_SHADER_TEXTURE_LOD=o("EXT_shader_texture_lod"),Se.EXT_TEXTURE_FILTER_ANISOTROPIC=o("EXT_texture_filter_anisotropic"),Se.EXT_ELEMENT_INDEX_UINT=o("OES_element_index_uint"),Se.DEFAULT_TEXTURE_MAX_ANISOTROPY=Se.EXT_TEXTURE_FILTER_ANISOTROPIC?i.getParameter(Se.EXT_TEXTURE_FILTER_ANISOTROPIC.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,Se.EXT_FLOAT_TEXTURES?r+="#define HX_FLOAT_TEXTURES\n":e.useSkinningTexture=!1,Se.EXT_FLOAT_TEXTURES_LINEAR&&(r+="#define HX_FLOAT_TEXTURES_LINEAR\n"),Se.EXT_HALF_FLOAT_TEXTURES&&(r+="#define HX_HALF_FLOAT_TEXTURES\n",De.HALF_FLOAT=Se.WEBGL_2?i.HALF_FLOAT:Se.EXT_HALF_FLOAT_TEXTURES.HALF_FLOAT_OES),Se.WEBGL_2||Se.EXT_HALF_FLOAT_TEXTURES_LINEAR?r+="#define HX_HALF_FLOAT_TEXTURES_LINEAR\n":e.hdr=!1,Se.EXT_COLOR_BUFFER_FLOAT||(Se.EXT_COLOR_BUFFER_FLOAT=Xe(De.FLOAT),Se.EXT_COLOR_BUFFER_FLOAT||console.warn("Float FBOs not supported")),Se.EXT_COLOR_BUFFER_HALF_FLOAT||(Se.EXT_COLOR_BUFFER_HALF_FLOAT=Xe(De.HALF_FLOAT),Se.EXT_COLOR_BUFFER_HALF_FLOAT||console.warn("HalfFloat FBOs not supported")),Se.EXT_DEPTH_TEXTURE||(r+="#define HX_NO_DEPTH_TEXTURES\n"),Se.EXT_SHADER_TEXTURE_LOD&&(r+="#define HX_TEXTURE_LOD\n"),Se.HDR_FORMAT=e.hdr?De.HALF_FLOAT:i.UNSIGNED_BYTE,e.useSkinningTexture&&(r+="#define HX_USE_SKINNING_TEXTURE\n",function(){Te.DEFAULT_SKINNING_TEXTURE=new Dt;for(var t=[],e=0;e<te.OPTIONS.maxSkeletonJoints;++e)t.push(1,0,0,0);for(e=0;e<te.OPTIONS.maxSkeletonJoints;++e)t.push(0,1,0,0);for(e=0;e<te.OPTIONS.maxSkeletonJoints;++e)t.push(0,0,1,0);Te.DEFAULT_SKINNING_TEXTURE.uploadData(new Float32Array(t),te.OPTIONS.maxSkeletonJoints,3,!1,Ne.RGBA,De.FLOAT),Te.DEFAULT_SKINNING_TEXTURE.filter=Ee.NEAREST_NOMIP,Te.DEFAULT_SKINNING_TEXTURE.wrapMode=we.CLAMP}()),Dt._initDefault(),Ot._initDefault(),Ct._initDefaults(),It._initDefault(),A._initDefault(),P._initDefault(),function(t,e){var i,n=t*e,r=1/n,s=[],o=0,a=[];for(i=0;i<n;++i)a.push(i/n);for(u.shuffle(a),i=0;i<n;++i){var h=a[i]*Math.PI*2,_=Math.cos(h),l=Math.sin(h);s[o++]=_,s[o++]=l,s[o++]=r+a[i],s[o++]=1}if(Te.DEFAULT_2D_DITHER_TEXTURE=new Dt,Te.DEFAULT_2D_DITHER_TEXTURE.filter=Ee.NEAREST_NOMIP,Te.DEFAULT_2D_DITHER_TEXTURE.wrapMode=we.REPEAT,Se.EXT_FLOAT_TEXTURES)Te.DEFAULT_2D_DITHER_TEXTURE.uploadData(new Float32Array(s),t,e,!1,Ne.RGBA,De.FLOAT);else{for(n=s.length,i=0;i<n;++i)s[i]=Math.round(255*(.5*s[i]+.5));Te.DEFAULT_2D_DITHER_TEXTURE.uploadData(new Uint8Array(s),t,e,!1,Ne.RGBA,De.UNSIGNED_BYTE)}Te.DARK_CUBE_TEXTURE=new Ot,s=[s=new Uint8Array([0,0,0,0]),s,s,s,s,s],Te.DARK_CUBE_TEXTURE.uploadData(s,1,!0)}(32,32),e.ambientOcclusion&&(r+="#define HX_SSAO\n",e.ambientOcclusion.init()),E.GENERAL=r+E.GENERAL,Te.COPY_SHADER=new vt,B.setClearColor(h.BLACK),Ue();var a},t.destroy=function(){Be(),te.INITIALIZED=!1,ie.unbindAll(),ee.unbindAll(),B._setGL(null)},t.start=Ue,t.stop=Be,t.META=te,t.capabilities=Se,t.onPreFrame=ee,t.onFrame=ie,t.TextureFilter=Ee,t.CullMode=Ae,t.StencilOp=Pe,t.Comparison=Me,t.ElementType=Le,t.BlendFactor=Re,t.BlendOperation=be,t.ClearMask=Ie,t.InitOptions=Fe,t.TextureFormat=Ne,t.DataType=De,t.BufferUsage=Oe,t.CubeFace=Ce,t.Float2=w,t.Float4=O,t.CenteredGaussianCurve=He,t.MathX=I,t.Matrix4x4=F,t.PlaneSide=wt,t.PoissonDisk=A,t.PoissonSphere=P,t.Quaternion=N,t.Ray=ze,t.Transform=C,t.Debug=mt,t.DebugAxes=vi,t.Profiler=Ai,t.BoundingVolume=Et,t.BoundingAABB=At,t.BoundingSphere=si,t.SceneNode=Ke,t.Scene=Ri,t.SceneVisitor=bi,t.Skybox=Fi,t.Terrain=Gi,t.Entity=ei,t.EntitySystem=Yi,t.EntitySet=Pi,t.Component=$e,t.CompositeComponent=ji,t.KeyFrame=function(t,e){this.time=t||0,this.value=e},t.AnimationClip=Wi,t.AnimationPlayhead=Zi,t.LayeredAnimation=qi,t.AnimationLayer=Ki,t.AnimationLayerFloat4=Qi,t.AnimationLayerQuat=$i,t.AnimationLayerMorphTarget=tn,t.MorphAnimation=nn,t.MorphPose=en,t.MorphTarget=Pt,t.Skeleton=rn,t.SkeletonAnimation=_n,t.SkeletonBinaryLerpNode=ln,t.SkeletonBlendNode=on,t.SkeletonBlendTree=hn,t.SkeletonClipNode=an,t.SkeletonFreePoseNode=un,t.SkeletonJoint=cn,t.SkeletonJointPose=Ji,t.SkeletonPose=sn,t.SkeletonXFadeNode=dn,t.Camera=Oi,t.Frustum=Di,t.PerspectiveCamera=Ci,t.OrthographicOffCenterCamera=fn,t.FloatController=pn,t.OrbitController=mn,t.Color=h,t.DataStream=gn,t.GL=B,t.Signal=n,t.Bloom=Tn,t.Blur=Sn,t.CopyTexturePass=En,t.Effect=yn,t.EffectPass=xn,t.FilmicToneMapping=An,t.Fog=Pn,t.FXAA=Mn,t.GaussianBlurPass=vn,t.HBAO=Ln,t.SSAO=Rn,t.ReinhardToneMapping=bn,t.AssetLibrary=Cn,t.AssetLoader=On,t.URLLoader=Nn,t.HCLIP=Fn,t.HCM=Un,t.HMAT=Hn,t.HMESH=zn,t.Importer=Dn,t.JPG_EQUIRECTANGULAR=kn,t.PNG_EQUIRECTANGULAR=Gn,t.JPG_HEIGHTMAP=jn,t.PNG_HEIGHTMAP=Wn,t.JPG=Bn,t.PNG=Xn,t.AmbientLight=Zn,t.DirectionalLight=ri,t.Light=ii,t.DirectLight=ni,t.LightProbe=ai,t.DynamicLightProbe=dr,t.PointLight=oi,t.SpotLight=hi,t.ShadowFilter=x,t.ExponentialShadowFilter=pr,t.HardShadowFilter=v,t.PCFShadowFilter=mr,t.VarianceShadowFilter=xr,t.MaterialPass=$t,t.Material=gi,t.BasicMaterial=xi,t.SkyboxMaterial=Ii,t.Mesh=Lt,t.MeshInstance=ti,t.SpherePrimitive=vr,t.BoxPrimitive=Ni,t.Primitive=ke,t.ConePrimitive=yr,t.CylinderPrimitive=Ge,t.PlanePrimitive=Tr,t.TorusPrimitive=Sr,t.WireBoxPrimitive=Er,t.WirePlanePrimitive=wr,t.BlendState=Ct,t.Renderer=cr,t.LightingModel=S,t.View=function(t,e,i,n,r,s){this.scene=t,this.camera=e,this._renderer=null,this._texture=null,this._fbo=null,this.xRatio=i||0,this.yRatio=n||0,this.widthRatio=r||1,this.heightRatio=s||1},t.MultiRenderer=Ar,t.StencilState=function(t,e,i,n,r,s,o){this.enabled=!0,this.reference=t||0,this.comparison=e||Me.ALWAYS,this.onStencilFail=i||Pe.KEEP,this.onDepthFail=n||Pe.KEEP,this.onPass=r||Pe.KEEP,this.readMask=null==s?4294967295:s,this.writeMask=null==o?4294967295:o},t.FrameBuffer=Ft,t.Texture2D=Dt,t.TextureCube=Ot,t.TextureUtils=Nt,t.WriteOnlyDepthBuffer=qn,t.AsyncTaskQueue=Pr,t.ArrayUtils=u,t.BlitTexture=Mr,t.EquirectangularTexture=Vn,t.HeightMap=Yn,t.ImageData=Lr,t.MergeSpecularTextures=Rr,t.NormalTangentGenerator=Ve,t.Platform=br,t.RayCaster=Dr,t.StatsDisplay=Cr,Object.defineProperty(t,"__esModule",{value:!0})});