!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.HX=t.HX||{})}(this,function(t){"use strict";var e=t;e.VERSION="0.1",e.INITIALIZED=!1;var i=null;e.InitOptions=function(){this.maxBones=64,this.useSkinningTexture=!0,this.hdr=!1,this.useGammaCorrection=!0,this.usePreciseGammaCorrection=!1,this.defaultLightingModel=e.LightingModel.Unlit,this.maxPointLightsPerPass=3,this.maxDirLightsPerPass=1,this.ignoreAllExtensions=!1,this.ignoreDrawBuffersExtension=!1,this.ignoreDepthTexturesExtension=!1,this.ignoreTextureLODExtension=!1,this.ignoreHalfFloatTextureExtension=!1,this.throwOnShaderError=!1,this.directionalShadowFilter=new e.HardDirectionalShadowFilter},e.init=function(t,n){function r(t){return a.indexOf(t)>=0?i.getExtension(t):null}if(e.INITIALIZED)throw new Error("Can only initialize Helix once!");e.TARGET_CANVAS=t;var o={antialias:!1,alpha:!1,depth:!1,stencil:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1},s=t.getContext("webgl",o)||t.getContext("experimental-webgl",o);if(e.OPTIONS=n||new e.InitOptions,e.GL=i=s,!i)throw new Error("WebGL not supported");e.INITIALIZED=!0;var a=i.getSupportedExtensions();e._initGLProperties(),e._initLights(),e.GLSLIncludeGeometryPass="\n"+e.DirectionalLight.SHADOW_FILTER.getGLSL()+e.GLSLIncludeGeometryPass;var h="";e.OPTIONS.useGammaCorrection!==!1&&(h+=e.OPTIONS.usePreciseGammaCorrection?"#define HX_GAMMA_CORRECTION_PRECISE\n":"#define HX_GAMMA_CORRECTION_FAST\n"),h+="#define HX_MAX_BONES "+e.OPTIONS.maxBones+"\n",e.OPTIONS.ignoreDrawBuffersExtension=e.OPTIONS.ignoreDrawBuffersExtension||e.OPTIONS.ignoreAllExtensions,e.OPTIONS.ignoreDepthTexturesExtension=e.OPTIONS.ignoreDepthTexturesExtension||e.OPTIONS.ignoreAllExtensions,e.OPTIONS.ignoreTextureLODExtension=e.OPTIONS.ignoreTextureLODExtension||e.OPTIONS.ignoreAllExtensions,e.OPTIONS.ignoreHalfFloatTextureExtension=e.OPTIONS.ignoreHalfFloatTextureExtension||e.OPTIONS.ignoreAllExtensions,e.OPTIONS.ignoreDrawBuffersExtension||(e.EXT_DRAW_BUFFERS=r("WEBGL_draw_buffers")),e.EXT_DRAW_BUFFERS&&e.EXT_DRAW_BUFFERS.MAX_DRAW_BUFFERS_WEBGL>=3&&(h+="#extension GL_EXT_draw_buffers : require\n"),e.EXT_FLOAT_TEXTURES=r("OES_texture_float"),e.EXT_FLOAT_TEXTURES||(console.warn("OES_texture_float extension not supported!"),e.OPTIONS.useSkinningTexture=!1),e.OPTIONS.ignoreHalfFloatTextureExtension||(e.EXT_HALF_FLOAT_TEXTURES=r("OES_texture_half_float")),e.EXT_HALF_FLOAT_TEXTURES||console.warn("OES_texture_half_float extension not supported!"),e.EXT_FLOAT_TEXTURES_LINEAR=r("OES_texture_float_linear"),e.EXT_FLOAT_TEXTURES_LINEAR||console.warn("OES_texture_float_linear extension not supported!"),e.EXT_HALF_FLOAT_TEXTURES_LINEAR=r("OES_texture_half_float_linear"),e.EXT_HALF_FLOAT_TEXTURES_LINEAR||console.warn("OES_texture_half_float_linear extension not supported!"),e.OPTIONS.ignoreDepthTexturesExtension||(e.EXT_DEPTH_TEXTURE=r("WEBGL_depth_texture")),e.EXT_DEPTH_TEXTURE||(console.warn("WEBGL_depth_texture extension not supported!"),h+="#define HX_NO_DEPTH_TEXTURES\n"),e.EXT_STANDARD_DERIVATIVES=r("OES_standard_derivatives"),e.EXT_STANDARD_DERIVATIVES||console.warn("OES_standard_derivatives extension not supported!"),e.OPTIONS.ignoreTextureLODExtension||(e.EXT_SHADER_TEXTURE_LOD=r("EXT_shader_texture_lod")),e.EXT_SHADER_TEXTURE_LOD||console.warn("EXT_shader_texture_lod extension not supported!"),e.EXT_TEXTURE_FILTER_ANISOTROPIC=r("EXT_texture_filter_anisotropic"),e.EXT_TEXTURE_FILTER_ANISOTROPIC||console.warn("EXT_texture_filter_anisotropic extension not supported!"),e.DEFAULT_TEXTURE_MAX_ANISOTROPY=e.EXT_TEXTURE_FILTER_ANISOTROPIC?i.getParameter(e.EXT_TEXTURE_FILTER_ANISOTROPIC.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,e.EXT_HALF_FLOAT_TEXTURES_LINEAR&&e.EXT_HALF_FLOAT_TEXTURES||(e.OPTIONS.hdr=!1),e.HDR_FORMAT=e.OPTIONS.hdr?e.EXT_HALF_FLOAT_TEXTURES.HALF_FLOAT_OES:i.UNSIGNED_BYTE,e.GAMMA_CORRECTION_IN_LIGHTS=!1,e.OPTIONS.useGammaCorrection&&!e.OPTIONS.hdr&&(e.GAMMA_CORRECT_LIGHTS=!0,h+="#define HX_GAMMA_CORRECT_LIGHTS\n"),e.OPTIONS.useSkinningTexture&&(h+="#define HX_USE_SKINNING_TEXTURE\n",this._initDefaultSkinningTexture()),e.NUM_MORPH_TARGETS=8,e.GLSLIncludeGeneral=h+e.GLSLIncludeGeneral,e.COPY_SHADER=new e.CopyChannelsShader,e._initMaterialPasses(),e.Texture2D._initDefault(),e.TextureCube._initDefault(),e.BlendState._initDefaults(),e.RectMesh._initDefault(),e.PoissonDisk._initDefault(),e.PoissonSphere._initDefault(),e._init2DDitherTexture(32,32),e.setClearColor(e.Color.BLACK),e.onPreFrame=new e.Signal,e.onFrame=new e.Signal,e.FRAME_TICKER=new e.FrameTicker,e.start()},e.start=function(){e.FRAME_TICKER.start(function(t){e.onPreFrame.dispatch(t),e.onFrame.dispatch(t)})},e.stop=function(){e.FRAME_TICKER.stop()},e._initMaterialPasses=function(){var t=e.OPTIONS;e.MaterialPass.BASE_PASS=0,e.MaterialPass.NORMAL_DEPTH_PASS=1,e.MaterialPass.DIR_LIGHT_PASS=2,e.MaterialPass.DIR_LIGHT_SHADOW_PASS=e.MaterialPass.DIR_LIGHT_PASS+t.maxDirLightsPerPass,e.MaterialPass.POINT_LIGHT_PASS=e.MaterialPass.DIR_LIGHT_SHADOW_PASS+1,e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS=e.MaterialPass.POINT_LIGHT_PASS+t.maxPointLightsPerPass,e.MaterialPass.NUM_PASS_TYPES=e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS+1},e._initLights=function(){e.DirectionalLight.SHADOW_FILTER=e.OPTIONS.directionalShadowFilter},e._initDefaultSkinningTexture=function(){e.DEFAULT_SKINNING_TEXTURE=new e.Texture2D;for(var t=[],n=0;n<e.OPTIONS.maxBones;++n)t.push(1,0,0,0,0,1,0,0,0,0,1,0);e.DEFAULT_SKINNING_TEXTURE.uploadData(new Float32Array(t),e.OPTIONS.maxBones,3,!1,i.RGBA,i.FLOAT),e.DEFAULT_SKINNING_TEXTURE.filter=e.TextureFilter.NEAREST_NOMIP,e.DEFAULT_SKINNING_TEXTURE.wrapMode=e.TextureWrapMode.CLAMP},e._init2DDitherTexture=function(t,n){e.DEFAULT_2D_DITHER_TEXTURE=new e.Texture2D;var r,o=t*n,s=1/o,a=[],h=0,l=[];for(r=0;r<o;++r)l.push(r/o);for(e.shuffle(l),r=0;r<o;++r){var u=l[r]*Math.PI*2,c=Math.cos(u),_=Math.sin(u);a[h++]=c,a[h++]=_,a[h++]=s+l[r],a[h++]=1}e.DEFAULT_2D_DITHER_TEXTURE.uploadData(new Float32Array(a),t,n,!1,i.RGBA,i.FLOAT),e.DEFAULT_2D_DITHER_TEXTURE.filter=e.TextureFilter.NEAREST_NOMIP,e.DEFAULT_2D_DITHER_TEXTURE.wrapMode=e.TextureWrapMode.REPEAT},e._initGLProperties=function(){e.TextureFilter={},e.TextureFilter.NEAREST={min:i.NEAREST_MIPMAP_NEAREST,mag:i.NEAREST},e.TextureFilter.BILINEAR={min:i.LINEAR_MIPMAP_NEAREST,mag:i.LINEAR},e.TextureFilter.TRILINEAR={min:i.LINEAR_MIPMAP_LINEAR,mag:i.LINEAR},e.EXT_TEXTURE_FILTER_ANISOTROPIC&&(e.TextureFilter.TRILINEAR_ANISOTROPIC={min:i.LINEAR_MIPMAP_LINEAR,mag:i.LINEAR}),e.TextureFilter.NEAREST_NOMIP={min:i.NEAREST,mag:i.NEAREST},e.TextureFilter.BILINEAR_NOMIP={min:i.LINEAR,mag:i.LINEAR},e.TextureWrapMode={},e.TextureWrapMode.REPEAT={s:i.REPEAT,t:i.REPEAT},e.TextureWrapMode.CLAMP={s:i.CLAMP_TO_EDGE,t:i.CLAMP_TO_EDGE},e.TextureWrapMode.DEFAULT=e.TextureWrapMode.REPEAT,e.TextureFilter.DEFAULT=e.TextureFilter.TRILINEAR,e.CullMode={NONE:null,BACK:i.BACK,FRONT:i.FRONT,ALL:i.FRONT_AND_BACK},e.StencilOp={KEEP:i.KEEP,ZERO:i.ZERO,REPLACE:i.REPLACE,INCREMENT:i.INCR,INCREMENT_WRAP:i.INCR_WRAP,DECREMENT:i.DECR,DECREMENT_WRAP:i.DECR_WRAP,INVERT:i.INVERT},e.Comparison={DISABLED:null,ALWAYS:i.ALWAYS,NEVER:i.NEVER,LESS:i.LESS,EQUAL:i.EQUAL,LESS_EQUAL:i.LEQUAL,GREATER:i.GREATER,NOT_EQUAL:i.NOTEQUAL,GREATER_EQUAL:i.GEQUAL},e.ElementType={POINTS:i.POINTS,LINES:i.LINES,LINE_STRIP:i.LINE_STRIP,LINE_LOOP:i.LINE_LOOP,TRIANGLES:i.TRIANGLES,TRIANGLE_STRIP:i.TRIANGLE_STRIP,TRIANGLE_FAN:i.TRIANGLE_FAN},e.BlendFactor={ZERO:i.ZERO,ONE:i.ONE,SOURCE_COLOR:i.SRC_COLOR,ONE_MINUS_SOURCE_COLOR:i.ONE_MINUS_SRC_COLOR,DESTINATION_COLOR:i.DST_COLOR,ONE_MINUS_DESTINATION_COLOR:i.ONE_MINUS_DST_COLOR,SOURCE_ALPHA:i.SRC_ALPHA,ONE_MINUS_SOURCE_ALPHA:i.ONE_MINUS_SRC_ALPHA,DESTINATION_ALPHA:i.DST_ALPHA,ONE_MINUS_DESTINATION_ALPHA:i.ONE_MINUS_DST_ALPHA,SOURCE_ALPHA_SATURATE:i.SRC_ALPHA_SATURATE,CONSTANT_ALPHA:i.CONSTANT_ALPHA,ONE_MINUS_CONSTANT_ALPHA:i.ONE_MINUS_CONSTANT_ALPHA},e.BlendOperation={ADD:i.FUNC_ADD,SUBTRACT:i.FUNC_SUBTRACT,REVERSE_SUBTRACT:i.FUNC_REVERSE_SUBTRACT},e.COMPLETE_CLEAR_MASK=i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT},e.ShaderLibrary={get:function(t,i){var n="";for(var r in i)i.hasOwnProperty(r)&&(n+="#define "+r+" "+i[r]+"\n");return n+e.ShaderLibrary[t]}},e.ShaderLibrary["debug_bounds_fragment.glsl"]="uniform vec4 color;\n\nvoid main()\n{\n    gl_FragColor = color;\n}",e.ShaderLibrary["debug_bounds_vertex.glsl"]="attribute vec4 hx_position;\n\nuniform mat4 hx_wvpMatrix;\n\nvoid main()\n{\n    gl_Position = hx_wvpMatrix * hx_position;\n}",e.ShaderLibrary["lighting_blinn_phong.glsl"]="float hx_probeGeometricShadowing(vec3 normal, vec3 reflection, float roughness, float metallicness)\n{\n    // schlick-smith\n    /*float k = 2.0 / sqrt(3.1415 * (roughness * roughness + 2.0));\n    float nDotV = max(dot(normal, reflection), 0.0);\n    float denom = nDotV * (1.0 - k) + k;\n    return nDotV * nDotV / (denom * denom);   // since l == v*/\n    float att = 1.0 - roughness;\n    return mix(att * att, 1.0, metallicness);\n}\n\n// schlick-beckman\nfloat hx_lightVisibility(vec3 normal, vec3 viewDir, float roughness, float nDotL)\n{\n\tfloat nDotV = max(-dot(normal, viewDir), 0.0);\n\tfloat r = roughness * roughness * 0.797896;\n\tfloat g1 = nDotV * (1.0 - r) + r;\n\tfloat g2 = nDotL * (1.0 - r) + r;\n    return .25 / (g1 * g2);\n}\n\nfloat hx_blinnPhongDistribution(float roughness, vec3 normal, vec3 halfVector)\n{\n\tfloat roughnessSqr = clamp(roughness * roughness, 0.0001, .9999);\n//\troughnessSqr *= roughnessSqr;\n\tfloat halfDotNormal = max(-dot(halfVector, normal), 0.0);\n\treturn pow(halfDotNormal, 2.0/roughnessSqr - 2.0) / roughnessSqr;\n}\n\nvoid hx_brdf(in HX_GeometryData geometry, in vec3 lightDir, in vec3 viewDir, in vec3 viewPos, in vec3 lightColor, vec3 normalSpecularReflectance, out vec3 diffuseColor, out vec3 specularColor)\n{\n\tfloat nDotL = max(-dot(lightDir, geometry.normal), 0.0);\n\tvec3 irradiance = nDotL * lightColor;\t// in fact irradiance / PI\n\n\tvec3 halfVector = normalize(lightDir + viewDir);\n\n\tfloat distribution = hx_blinnPhongDistribution(geometry.roughness, geometry.normal, halfVector);\n\n\tfloat halfDotLight = max(dot(halfVector, lightDir), 0.0);\n\tfloat cosAngle = 1.0 - halfDotLight;\n\t// to the 5th power\n\tfloat power = cosAngle*cosAngle;\n\tpower *= power;\n\tpower *= cosAngle;\n\tvec3 fresnel = normalSpecularReflectance + (1.0 - normalSpecularReflectance)*power;\n\n// / PI factor is encoded in light colour\n\tdiffuseColor = irradiance;\n\tspecularColor = irradiance * fresnel * distribution;\n\n//#ifdef HX_VISIBILITY\n//    specularColor *= hx_lightVisibility(normal, lightDir, geometry.roughness, nDotL);\n//#endif\n}",e.ShaderLibrary["lighting_ggx.glsl"]="// TODO: Implement this: https://learnopengl.com/#!PBR/Theory\n\n// schlick-beckman\nfloat hx_lightVisibility(vec3 normal, vec3 viewDir, float roughness, float nDotL)\n{\n\tfloat nDotV = max(-dot(normal, viewDir), 0.0);\n\tfloat r = roughness * roughness * 0.797896;\n\tfloat g1 = nDotV * (1.0 - r) + r;\n\tfloat g2 = nDotL * (1.0 - r) + r;\n    return .25 / (g1 * g2);\n}\n\nfloat hx_ggxDistribution(float roughness, vec3 normal, vec3 halfVector)\n{\n    float roughSqr = roughness*roughness;\n    float halfDotNormal = max(-dot(halfVector, normal), 0.0);\n    float denom = (halfDotNormal * halfDotNormal) * (roughSqr - 1.0) + 1.0;\n    return roughSqr / (denom * denom);\n}\n\n// light dir is to the lit surface\n// view dir is to the lit surface\nvoid hx_brdf(in HX_GeometryData geometry, in vec3 lightDir, in vec3 viewDir, in vec3 viewPos, in vec3 lightColor, vec3 normalSpecularReflectance, out vec3 diffuseColor, out vec3 specularColor)\n{\n\tfloat nDotL = max(-dot(lightDir, geometry.normal), 0.0);\n\tvec3 irradiance = nDotL * lightColor;\t// in fact irradiance / PI\n\n\tvec3 halfVector = normalize(lightDir + viewDir);\n\n\tfloat distribution = hx_ggxDistribution(geometry.roughness, geometry.normal, halfVector);\n\n\tfloat halfDotLight = max(dot(halfVector, lightDir), 0.0);\n\tfloat cosAngle = 1.0 - halfDotLight;\n\t// to the 5th power\n\tfloat power = cosAngle*cosAngle;\n\tpower *= power;\n\tpower *= cosAngle;\n\tvec3 fresnel = normalSpecularReflectance + (1.0 - normalSpecularReflectance)*power;\n\n\tdiffuseColor = irradiance;\n\n\tspecularColor = irradiance * fresnel * distribution;\n\n#ifdef VISIBILITY\n    specularColor *= hx_lightVisibility(normal, lightDir, geometry.roughness, nDotL);\n#endif\n}",e.ShaderLibrary["directional_light.glsl"]="struct HX_DirectionalLight\n{\n    vec3 color;\n    vec3 direction; // in view space?\n\n    mat4 shadowMapMatrices[4];\n    vec4 splitDistances;\n    float depthBias;\n    float maxShadowDistance;    // = light.splitDistances[light.numCascades - 1]\n};\n\nvoid hx_calculateLight(HX_DirectionalLight light, HX_GeometryData geometry, vec3 viewVector, vec3 viewPosition, vec3 normalSpecularReflectance, out vec3 diffuse, out vec3 specular)\n{\n\thx_brdf(geometry, light.direction, viewVector, viewPosition, light.color, normalSpecularReflectance, diffuse, specular);\n}\n\nmat4 hx_getShadowMatrix(HX_DirectionalLight light, vec3 viewPos)\n{\n// HX_MAX_CASCADES is the maximum amount of all cascades for the lights used in this shader\n    #if HX_MAX_CASCADES > 1\n        // not very efficient :(\n        for (int i = 0; i < HX_MAX_CASCADES - 1; ++i) {\n            // remember, negative Z!\n            if (viewPos.z > light.splitDistances[i])\n                return light.shadowMapMatrices[i];\n        }\n        return light.shadowMapMatrices[HX_MAX_CASCADES - 1];\n    #else\n        return light.shadowMapMatrices[0];\n    #endif\n}\n\nfloat hx_calculateShadows(HX_DirectionalLight light, sampler2D shadowMap, vec3 viewPos)\n{\n    mat4 shadowMatrix = hx_getShadowMatrix(light, viewPos);\n    float shadow = hx_readShadow(shadowMap, viewPos, shadowMatrix, light.depthBias);\n    return max(shadow, float(viewPos.z < light.maxShadowDistance));\n}",e.ShaderLibrary["light_probe.glsl"]="#define HX_PROBE_K0 .00098\n#define HX_PROBE_K1 .9921\n\n/*\nvar minRoughness = 0.0014;\nvar maxPower = 2.0 / (minRoughness * minRoughness) - 2.0;\nvar maxMipFactor = (exp2(-10.0/Math.sqrt(maxPower)) - HX_PROBE_K0)/HX_PROBE_K1;\nvar HX_PROBE_SCALE = 1.0 / maxMipFactor\n*/\n\n#define HX_PROBE_SCALE\n\nvec3 hx_calculateDiffuseProbeLight(samplerCube texture, vec3 normal)\n{\n\treturn hx_gammaToLinear(textureCube(texture, normal).xyz);\n}\n\nvec3 hx_calculateSpecularProbeLight(samplerCube texture, float numMips, vec3 reflectedViewDir, vec3 fresnelColor, float roughness)\n{\n    #ifdef HX_TEXTURE_LOD\n    // knald method:\n        float power = 2.0/(roughness * roughness) - 2.0;\n        float factor = (exp2(-10.0/sqrt(power)) - HX_PROBE_K0)/HX_PROBE_K1;\n//        float mipLevel = numMips * (1.0 - clamp(factor * HX_PROBE_SCALE, 0.0, 1.0));\n        float mipLevel = numMips * (1.0 - clamp(factor, 0.0, 1.0));\n        vec4 specProbeSample = textureCubeLodEXT(texture, reflectedViewDir, mipLevel);\n    #else\n        vec4 specProbeSample = textureCube(texture, reflectedViewDir);\n    #endif\n\treturn hx_gammaToLinear(specProbeSample.xyz) * fresnelColor;\n}",e.ShaderLibrary["point_light.glsl"]="struct HX_PointLight\n{\n    vec3 color;\n    vec3 position; // in view space?\n    float radius;\n};\n\nvoid hx_calculateLight(HX_PointLight light, HX_GeometryData geometry, vec3 viewVector, vec3 viewPosition, vec3 normalSpecularReflectance, out vec3 diffuse, out vec3 specular)\n{\n    vec3 direction = viewPosition - light.position;\n    float attenuation = dot(direction, direction);  // distance squared\n    float distance = sqrt(attenuation);\n    direction /= distance;\n    attenuation = max((1.0 - distance / light.radius) / attenuation, 0.0);\n\thx_brdf(geometry, direction, viewVector, viewPosition, light.color * attenuation, normalSpecularReflectance, diffuse, specular);\n}",e.ShaderLibrary["default_geometry_fragment.glsl"]="varying vec3 normal;\n\nuniform vec3 color;\nuniform float alpha;\n\n#if defined(COLOR_MAP) || defined(NORMAL_MAP)|| defined(SPECULAR_MAP)|| defined(ROUGHNESS_MAP) || defined(MASK_MAP)\nvarying vec2 texCoords;\n#endif\n\n#ifdef COLOR_MAP\nuniform sampler2D colorMap;\n#endif\n\n#ifdef MASK_MAP\nuniform sampler2D maskMap;\n#endif\n\n#ifdef NORMAL_MAP\nvarying vec3 tangent;\nvarying vec3 bitangent;\n\nuniform sampler2D normalMap;\n#endif\n\nuniform float roughness;\nuniform float roughnessRange;\nuniform float normalSpecularReflectance;\nuniform float metallicness;\n\n#if defined(ALPHA_THRESHOLD)\nuniform float alphaThreshold;\n#endif\n\n#if defined(SPECULAR_MAP) || defined(ROUGHNESS_MAP)\nuniform sampler2D specularMap;\n#endif\n\n#ifdef VERTEX_COLORS\nvarying vec3 vertexColor;\n#endif\n\nHX_GeometryData hx_geometry()\n{\n    vec4 outputColor = vec4(color, alpha);\n\n    #ifdef VERTEX_COLORS\n        outputColor.xyz *= vertexColor;\n    #endif\n\n    #ifdef COLOR_MAP\n        outputColor *= texture2D(colorMap, texCoords);\n    #endif\n\n    #ifdef MASK_MAP\n        outputColor.w *= texture2D(maskMap, texCoords).x;\n    #endif\n\n    #ifdef ALPHA_THRESHOLD\n        if (outputColor.w < alphaThreshold) discard;\n    #endif\n\n    float metallicnessOut = metallicness;\n    float specNormalReflOut = normalSpecularReflectance;\n    float roughnessOut = roughness;\n\n    vec3 fragNormal = normal;\n    #ifdef NORMAL_MAP\n        vec4 normalSample = texture2D(normalMap, texCoords);\n        mat3 TBN;\n        TBN[2] = normalize(normal);\n        TBN[0] = normalize(tangent);\n        TBN[1] = normalize(bitangent);\n\n        fragNormal = TBN * (normalSample.xyz - .5);\n\n        #ifdef NORMAL_ROUGHNESS_MAP\n            roughnessOut -= roughnessRange * (normalSample.w - .5);\n        #endif\n    #endif\n\n    #if defined(SPECULAR_MAP) || defined(ROUGHNESS_MAP)\n          vec4 specSample = texture2D(specularMap, texCoords);\n          roughnessOut -= roughnessRange * (specSample.x - .5);\n\n          #ifdef SPECULAR_MAP\n              specNormalReflOut *= specSample.y;\n              metallicnessOut *= specSample.z;\n          #endif\n    #endif\n\n    HX_GeometryData data;\n    data.color = hx_gammaToLinear(outputColor);\n    data.normal = normalize(fragNormal);\n    data.metallicness = metallicnessOut;\n    data.normalSpecularReflectance = specNormalReflOut;\n    data.roughness = roughnessOut;\n    data.emission = vec3(0.0);\n    return data;\n}",e.ShaderLibrary["default_geometry_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec3 hx_normal;\n\n// morph positions are offsets re the base position!\n#ifdef HX_USE_MORPHING\nattribute vec3 hx_morphPosition0;\nattribute vec3 hx_morphPosition1;\nattribute vec3 hx_morphPosition2;\nattribute vec3 hx_morphPosition3;\n#if HX_NUM_MORPH_TARGETS > 4\nattribute vec3 hx_morphPosition4;\nattribute vec3 hx_morphPosition5;\nattribute vec3 hx_morphPosition6;\nattribute vec3 hx_morphPosition7;\n#endif\n\nuniform float hx_morphWeights[HX_NUM_MORPH_TARGETS];\n#endif\n\n#ifdef HX_USE_SKINNING\nattribute vec4 hx_boneIndices;\nattribute vec4 hx_boneWeights;\n\n// WebGL doesn't support mat4x3 and I don't want to split the uniform either\n#ifdef HX_USE_SKINNING_TEXTURE\nuniform sampler2D hx_skinningTexture;\n#else\nuniform vec4 hx_skinningMatrices[HX_MAX_BONES * 3];\n#endif\n#endif\n\nuniform mat4 hx_wvpMatrix;\nuniform mat3 hx_normalWorldViewMatrix;\nuniform mat4 hx_worldViewMatrix;\n\nvarying vec3 normal;\n\n#if defined(COLOR_MAP) || defined(NORMAL_MAP)|| defined(SPECULAR_MAP)|| defined(ROUGHNESS_MAP) || defined(MASK_MAP)\nattribute vec2 hx_texCoord;\nvarying vec2 texCoords;\n#endif\n\n#ifdef VERTEX_COLORS\nattribute vec3 hx_vertexColor;\nvarying vec3 vertexColor;\n#endif\n\n#ifdef NORMAL_MAP\nattribute vec4 hx_tangent;\n\nvarying vec3 tangent;\nvarying vec3 bitangent;\n#endif\n\nvoid hx_geometry()\n{\n    vec4 morphedPosition = hx_position;\n    vec3 morphedNormal = hx_normal;\n\n// TODO: Abstract this in functions for easier reuse in other materials\n#ifdef HX_USE_MORPHING\n    morphedPosition.xyz += hx_morphPosition0 * hx_morphWeights[0];\n    morphedPosition.xyz += hx_morphPosition1 * hx_morphWeights[1];\n    morphedPosition.xyz += hx_morphPosition2 * hx_morphWeights[2];\n    morphedPosition.xyz += hx_morphPosition3 * hx_morphWeights[3];\n    #if HX_NUM_MORPH_TARGETS > 4\n        morphedPosition.xyz += hx_morphPosition4 * hx_morphWeights[4];\n        morphedPosition.xyz += hx_morphPosition5 * hx_morphWeights[5];\n        morphedPosition.xyz += hx_morphPosition6 * hx_morphWeights[6];\n        morphedPosition.xyz += hx_morphPosition7 * hx_morphWeights[7];\n    #endif\n#endif\n\n#ifdef HX_USE_SKINNING\n    mat4 skinningMatrix = hx_getSkinningMatrix(0);\n\n    vec4 animPosition = morphedPosition * skinningMatrix;\n    vec3 animNormal = morphedNormal * mat3(skinningMatrix);\n\n    #ifdef NORMAL_MAP\n    vec3 animTangent = hx_tangent.xyz * mat3(skinningMatrix);\n    #endif\n#else\n    vec4 animPosition = morphedPosition;\n    vec3 animNormal = morphedNormal;\n\n    #ifdef NORMAL_MAP\n    vec3 animTangent = hx_tangent.xyz;\n    #endif\n#endif\n\n    gl_Position = hx_wvpMatrix * animPosition;\n    normal = normalize(hx_normalWorldViewMatrix * animNormal);\n\n#ifdef NORMAL_MAP\n    tangent = mat3(hx_worldViewMatrix) * animTangent;\n    bitangent = cross(tangent, normal) * hx_tangent.w;\n#endif\n\n#if defined(COLOR_MAP) || defined(NORMAL_MAP)|| defined(SPECULAR_MAP)|| defined(ROUGHNESS_MAP) || defined(MASK_MAP)\n    texCoords = hx_texCoord;\n#endif\n\n#ifdef VERTEX_COLORS\n    vertexColor = hx_vertexColor;\n#endif\n}",e.ShaderLibrary["default_skybox_fragment.glsl"]="varying vec3 viewWorldDir;\n\nuniform samplerCube hx_skybox;\n\nHX_GeometryData hx_geometry()\n{\n    HX_GeometryData data;\n    data.color = textureCube(hx_skybox, viewWorldDir);\n    data.emission = vec3(0.0);\n    data.color = hx_gammaToLinear(data.color);\n    return data;\n}",e.ShaderLibrary["default_skybox_vertex.glsl"]="attribute vec4 hx_position;\n\nuniform vec3 hx_cameraWorldPosition;\nuniform float hx_cameraFarPlaneDistance;\nuniform mat4 hx_viewProjectionMatrix;\n\nvarying vec3 viewWorldDir;\n\n// using 2D quad for rendering skyboxes rather than 3D cube causes jittering of the skybox\nvoid hx_geometry()\n{\n    viewWorldDir = hx_position.xyz;\n    vec4 pos = hx_position;\n    // use a decent portion of the frustum to prevent FP issues\n    pos.xyz = pos.xyz * hx_cameraFarPlaneDistance + hx_cameraWorldPosition;\n    pos = hx_viewProjectionMatrix * pos;\n    // make sure it's drawn behind everything else, so z = 1.0\n    pos.z = pos.w;\n    gl_Position = pos;\n}\n\n",e.ShaderLibrary["material_dir_shadow_fragment.glsl"]="void main()\n{\n    // geometry is really only used for kil instructions if necessary\n    // hopefully the compiler optimizes the rest out for us\n    HX_GeometryData data = hx_geometry();\n    gl_FragColor = hx_getShadowMapValue(gl_FragCoord.z);\n}",e.ShaderLibrary["material_lit_static_fragment.glsl"]="varying vec3 hx_viewPosition;\n\nuniform vec3 hx_ambientColor;\n\n#if HX_NUM_DIR_LIGHTS > 0\nuniform HX_DirectionalLight hx_directionalLights[HX_NUM_DIR_LIGHTS];\n#endif\n\n#if HX_NUM_DIR_LIGHT_CASTERS > 0\nuniform HX_DirectionalLight hx_directionalLightCasters[HX_NUM_DIR_LIGHT_CASTERS];\n\nuniform sampler2D hx_directionalShadowMaps[HX_NUM_DIR_LIGHT_CASTERS];\nuniform float test[HX_NUM_DIR_LIGHT_CASTERS];\n#endif\n\n#if HX_NUM_POINT_LIGHTS > 0\nuniform HX_PointLight hx_pointLights[HX_NUM_POINT_LIGHTS];\n#endif\n\n#if HX_NUM_DIFFUSE_PROBES > 0 || HX_NUM_SPECULAR_PROBES > 0\nuniform mat4 hx_cameraWorldMatrix;\n#endif\n\n#if HX_NUM_DIFFUSE_PROBES > 0\nuniform samplerCube hx_diffuseProbeMaps[HX_NUM_DIFFUSE_PROBES];\n#endif\n\n#if HX_NUM_SPECULAR_PROBES > 0\nuniform samplerCube hx_specularProbeMaps[HX_NUM_SPECULAR_PROBES];\nuniform float hx_specularProbeNumMips[HX_NUM_SPECULAR_PROBES];\n#endif\n\n#if HX_APPLY_SSAO\nuniform sampler2D hx_ssao;\n\nuniform vec2 hx_rcpRenderTargetResolution;\n#endif\n\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n\n    // TODO: Provide support for proper AO so it's not a bad post-process effect?\n\n    // update the colours\n    vec3 specularColor = mix(vec3(data.normalSpecularReflectance), data.color.xyz, data.metallicness);\n    data.color.xyz *= 1.0 - data.metallicness;\n\n    vec3 diffuseAccum = vec3(0.0);\n    vec3 specularAccum = vec3(0.0);\n    vec3 viewVector = normalize(hx_viewPosition);\n\n    float ssao = 1.0;\n\n    #if HX_APPLY_SSAO\n        vec2 screenUV = gl_FragCoord.xy * hx_rcpRenderTargetResolution;\n        ssao = texture2D(hx_ssao, screenUV).x;\n    #endif\n\n    #if HX_NUM_DIR_LIGHTS > 0\n    for (int i = 0; i < HX_NUM_DIR_LIGHTS; ++i) {\n        vec3 diffuse, specular;\n        hx_calculateLight(hx_directionalLights[i], data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n        diffuseAccum += diffuse;\n        specularAccum += specular;\n    }\n    #endif\n\n    #if HX_NUM_DIR_LIGHT_CASTERS > 0\n    for (int i = 0; i < HX_NUM_DIR_LIGHT_CASTERS; ++i) {\n        vec3 diffuse, specular;\n        hx_calculateLight(hx_directionalLightCasters[i], data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n        float shadow = hx_calculateShadows(hx_directionalLightCasters[i], hx_directionalShadowMaps[i], hx_viewPosition);\n        diffuseAccum += diffuse * shadow;\n        specularAccum += specular * shadow;\n    }\n    #endif\n\n\n    #if HX_NUM_POINT_LIGHTS > 0\n    for (int i = 0; i < HX_NUM_POINT_LIGHTS; ++i) {\n        vec3 diffuse, specular;\n        hx_calculateLight(hx_pointLights[i], data, viewVector, hx_viewPosition, specularColor, diffuse, specular);\n        diffuseAccum += diffuse;\n        specularAccum += specular;\n    }\n    #endif\n\n    #if HX_NUM_DIFFUSE_PROBES > 0\n    vec3 worldNormal = mat3(hx_cameraWorldMatrix) * data.normal;\n    for (int i = 0; i < HX_NUM_DIFFUSE_PROBES; ++i) {\n        diffuseAccum += hx_calculateDiffuseProbeLight(hx_diffuseProbeMaps[i], worldNormal) * ssao;\n    }\n    #endif\n\n    #if HX_NUM_SPECULAR_PROBES > 0\n    vec3 reflectedViewDir = reflect(viewVector, data.normal);\n    vec3 fresnel = hx_fresnelProbe(specularColor, reflectedViewDir, data.normal, data.roughness);\n\n    reflectedViewDir = mat3(hx_cameraWorldMatrix) * reflectedViewDir;\n\n    for (int i = 0; i < HX_NUM_SPECULAR_PROBES; ++i) {\n        specularAccum += hx_calculateSpecularProbeLight(hx_specularProbeMaps[i], hx_specularProbeNumMips[i], reflectedViewDir, fresnel, data.roughness) * ssao;\n    }\n    #endif\n\n    gl_FragColor = vec4((diffuseAccum + hx_ambientColor * ssao) * data.color.xyz + specularAccum + data.emission, data.color.w);\n\n    #ifdef HX_GAMMA_CORRECT_LIGHTS\n        gl_FragColor = hx_linearToGamma(gl_FragColor);\n    #endif\n}",e.ShaderLibrary["material_lit_static_vertex.glsl"]="uniform mat4 hx_worldViewMatrix;\n\nvarying vec3 hx_viewPosition;\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    hx_geometry();\n    // we need to do an unprojection here to be sure to have skinning - or anything like that - support\n    hx_viewPosition = (hx_inverseProjectionMatrix * gl_Position).xyz;\n}",e.ShaderLibrary["material_normal_depth_fragment.glsl"]="varying float hx_linearDepth;\n\nvoid main()\n{\n    HX_GeometryData data = hx_geometry();\n    gl_FragColor.xy = hx_encodeNormal(data.normal);\n    gl_FragColor.zw = hx_floatToRG8(hx_linearDepth);\n//    gl_FragColor.zw = hx_floatToRG8(gl_FragCoord.z);\n}",e.ShaderLibrary["material_normal_depth_vertex.glsl"]="varying float hx_linearDepth;\n\nuniform mat4 hx_worldViewMatrix;\nuniform float hx_rcpCameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\n\nvoid main()\n{\n    hx_geometry();\n\n    hx_linearDepth = (gl_Position.w - hx_cameraNearPlaneDistance) * hx_rcpCameraFrustumRange;\n}",e.ShaderLibrary["material_unlit_fragment.glsl"]="void main()\n{\n    HX_GeometryData data = hx_geometry();\n    gl_FragColor = data.color;\n    gl_FragColor.xyz += data.emission;\n\n\n    #ifdef HX_GAMMA_CORRECT_LIGHTS\n        gl_FragColor = hx_linearToGamma(gl_FragColor);\n    #endif\n}",e.ShaderLibrary["material_unlit_vertex.glsl"]="void main()\n{\n    hx_geometry();\n}",e.ShaderLibrary["bloom_composite_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D bloomTexture;\nuniform sampler2D hx_backbuffer;\nuniform float strength;\n\nvoid main()\n{\n\tgl_FragColor = texture2D(hx_backbuffer, uv) + texture2D(bloomTexture, uv) * strength;\n}",e.ShaderLibrary["bloom_composite_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec2 hx_texCoord;\n\nvarying vec2 uv;\n\nvoid main()\n{\n\t   uv = hx_texCoord;\n\t   gl_Position = hx_position;\n}",e.ShaderLibrary["bloom_threshold_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D hx_backbuffer;\n\nuniform float threshold;\n\nvoid main()\n{\n        vec4 color = texture2D(hx_backbuffer, uv);\n        float originalLuminance = .05 + hx_luminance(color);\n        float targetLuminance = max(originalLuminance - threshold, 0.0);\n        gl_FragColor = color * targetLuminance / originalLuminance;\n}\n",e.ShaderLibrary["default_post_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec2 hx_texCoord;\n\nvarying vec2 uv;\n\nvoid main()\n{\n\tuv = hx_texCoord;\n\tgl_Position = hx_position;\n}",e.ShaderLibrary["fog_fragment.glsl"]="varying vec2 uv;\nvarying vec3 viewDir;\n\nuniform vec3 tint;\nuniform float density;\nuniform float startDistance;\nuniform float heightFallOff;\n\nuniform float hx_cameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\nuniform vec3 hx_cameraWorldPosition;\n\nuniform sampler2D hx_normalDepth;\nuniform sampler2D hx_backbuffer;\n\nvoid main()\n{\n    vec4 normalDepth = texture2D(hx_normalDepth, uv);\n\tvec4 color = texture2D(hx_backbuffer, uv);\n\tfloat depth = hx_decodeLinearDepth(normalDepth);\n\t// do not fog up skybox\n\tif (normalDepth.z == 1.0 && normalDepth.w == 1.0) depth = 0.0;\n\tfloat absViewZ = hx_cameraNearPlaneDistance + depth * hx_cameraFrustumRange;\n\tvec3 viewVec = viewDir * absViewZ;\n\tfloat fogFactor = max(length(viewVec) - startDistance, 0.0);// * exp(-heightFallOff * hx_cameraWorldPosition.y);\n//    if( abs( viewVec.y ) > 0.1 )\n//\t{\n\t\tfloat t = heightFallOff * (viewVec.y + hx_cameraWorldPosition.y);\n\t\tfogFactor *= saturate(( 1.0 - exp( -t ) ) / t);\n//\t}\n\n\tfloat fog = clamp(exp(-fogFactor * density), 0.0, 1.0);\n\tcolor.xyz = mix(tint, color.xyz, fog);\n\tgl_FragColor = color;\n}",e.ShaderLibrary["fog_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec2 hx_texCoord;\n\nvarying vec2 uv;\nvarying vec3 viewDir;\n\nuniform mat4 hx_inverseProjectionMatrix;\nuniform mat4 hx_cameraWorldMatrix;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    viewDir = mat3(hx_cameraWorldMatrix) * hx_getLinearDepthViewVector(hx_position.xy, hx_inverseProjectionMatrix);\n    gl_Position = hx_position;\n}",e.ShaderLibrary["fxaa_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D hx_backbuffer;\nuniform vec2 hx_rcpRenderTargetResolution;\nuniform float edgeThreshold;\nuniform float edgeThresholdMin;\nuniform float edgeSharpness;\n\nfloat luminanceHint(vec4 color)\n{\n\treturn .30/.59 * color.r + color.g;\n}\n\nvoid main()\n{\n\tvec4 center = texture2D(hx_backbuffer, uv);\n\tvec2 halfRes = vec2(hx_rcpRenderTargetResolution.x, hx_rcpRenderTargetResolution.y) * .5;\n\tfloat topLeftLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(-halfRes.x, halfRes.y)));\n\tfloat bottomLeftLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(-halfRes.x, -halfRes.y)));\n\tfloat topRightLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(halfRes.x, halfRes.y)));\n\tfloat bottomRightLum = luminanceHint(texture2D(hx_backbuffer, uv + vec2(halfRes.x, -halfRes.y)));\n\n\tfloat centerLum = luminanceHint(center);\n\tfloat minLum = min(min(topLeftLum, bottomLeftLum), min(topRightLum, bottomRightLum));\n\tfloat maxLum = max(max(topLeftLum, bottomLeftLum), max(topRightLum, bottomRightLum));\n\tfloat range = max(centerLum, maxLum) - min(centerLum, minLum);\n\tfloat threshold = max(edgeThresholdMin, maxLum * edgeThreshold);\n\tfloat applyFXAA = range < threshold? 0.0 : 1.0;\n\n\tfloat diagDiff1 = bottomLeftLum - topRightLum;\n\tfloat diagDiff2 = bottomRightLum - topLeftLum;\n\tvec2 dir1 = normalize(vec2(diagDiff1 + diagDiff2, diagDiff1 - diagDiff2));\n\tvec4 sampleNeg1 = texture2D(hx_backbuffer, uv - halfRes * dir1);\n\tvec4 samplePos1 = texture2D(hx_backbuffer, uv + halfRes * dir1);\n\n\tfloat minComp = min(abs(dir1.x), abs(dir1.y)) * edgeSharpness;\n\tvec2 dir2 = clamp(dir1.xy / minComp, -2.0, 2.0) * 2.0;\n\tvec4 sampleNeg2 = texture2D(hx_backbuffer, uv - hx_rcpRenderTargetResolution * dir2);\n\tvec4 samplePos2 = texture2D(hx_backbuffer, uv + hx_rcpRenderTargetResolution * dir2);\n\tvec4 tap1 = sampleNeg1 + samplePos1;\n\tvec4 fxaa = (tap1 + sampleNeg2 + samplePos2) * .25;\n\tfloat fxaaLum = luminanceHint(fxaa);\n\tif ((fxaaLum < minLum) || (fxaaLum > maxLum))\n\t\tfxaa = tap1 * .5;\n\tgl_FragColor = mix(center, fxaa, applyFXAA);\n}",
e.ShaderLibrary["gaussian_blur_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D sourceTexture;\n\nuniform vec2 stepSize;\n\nuniform float gaussianWeights[NUM_WEIGHTS];\n\nvoid main()\n{\n\tvec4 total = texture2D(sourceTexture, uv) * gaussianWeights[0];\n    vec2 offset = vec2(0.0);\n\n\tfor (int i = 1; i <= RADIUS; ++i) {\n\t\toffset += stepSize;\n\t    vec4 s = texture2D(sourceTexture, uv + offset) + texture2D(sourceTexture, uv - offset);\n\t\ttotal += s * gaussianWeights[i];\n\t}\n\n\tgl_FragColor = total;\n}",e.ShaderLibrary["gaussian_blur_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec2 hx_texCoord;\n\nvarying vec2 uv;\n\nvoid main()\n{\n\tuv = hx_texCoord;\n\tgl_Position = hx_position;\n}",e.ShaderLibrary["post_viewpos_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec2 hx_texCoord;\n\nvarying vec2 uv;\nvarying vec3 viewDir;\n\nuniform mat4 hx_inverseProjectionMatrix;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    viewDir = hx_getLinearDepthViewVector(hx_position.xy, hx_inverseProjectionMatrix);\n    gl_Position = hx_position;\n}",e.ShaderLibrary["ssr_fragment.glsl"]='#derivatives\n\nuniform sampler2D hx_gbufferColor;\nuniform sampler2D hx_gbufferNormals;\nuniform sampler2D hx_gbufferSpecular;\nuniform sampler2D hx_gbufferDepth;\nuniform sampler2D hx_dither2D;\nuniform vec2 hx_renderTargetResolution;\n\nuniform sampler2D hx_frontbuffer;\n\nvarying vec2 uv;\nvarying vec3 viewDir;\n\nuniform vec2 ditherTextureScale;\nuniform float hx_cameraNearPlaneDistance;\nuniform float hx_cameraFrustumRange;\nuniform float hx_rcpCameraFrustumRange;\nuniform mat4 hx_projectionMatrix;\n\nuniform float maxDistance;\nuniform float stepSize;\nuniform float maxRoughness;\n\n// all in viewspace\n// 0 is start, 1 is end\nfloat raytrace(in vec3 ray0, in vec3 rayDir, out float hitZ, out vec2 hitUV)\n{\n    vec4 dither = texture2D(hx_dither2D, uv * ditherTextureScale);\n    // Clip to the near plane\n\tfloat rayLength = ((ray0.z + rayDir.z * maxDistance) > -hx_cameraNearPlaneDistance) ?\n\t\t\t\t\t\t(-hx_cameraNearPlaneDistance - ray0.z) / rayDir.z : maxDistance;\n\n    vec3 ray1 = ray0 + rayDir * rayLength;\n\n    // only need the w component for perspective correct interpolation\n    // need to get adjusted ray end\'s uv value\n    vec4 hom0 = hx_projectionMatrix * vec4(ray0, 1.0);\n    vec4 hom1 = hx_projectionMatrix * vec4(ray1, 1.0);\n    float rcpW0 = 1.0 / hom0.w;\n    float rcpW1 = 1.0 / hom1.w;\n\n    hom0 *= rcpW0;\n    hom1 *= rcpW1;\n\n    // expressed in pixels, so we can snap to 1\n    // need to figure out the ratio between 1 pixel and the entire line "width" (if primarily vertical, it\'s actually height)\n\n    // line dimensions in pixels:\n\n    vec2 pixelSize = (hom1.xy - hom0.xy) * hx_renderTargetResolution * .5;\n\n    // line-"width" = max(abs(pixelSize.x), abs(pixelSize.y))\n    // ratio pixel/width = 1 / max(abs(pixelSize.x), abs(pixelSize.y))\n\n    float stepRatio = 1.0 / max(abs(pixelSize.x), abs(pixelSize.y)) * stepSize;\n\n    vec2 uvEnd = hom1.xy * .5 + .5;\n\n    vec2 dUV = (uvEnd - uv) * stepRatio;\n    hitUV = uv;\n\n    // linear depth\n    float rayDepth = (-ray0.z - hx_cameraNearPlaneDistance) * hx_rcpCameraFrustumRange;\n    float rayPerspDepth0 = rayDepth * rcpW0;\n    float rayPerspDepth1 = (-ray1.z - hx_cameraNearPlaneDistance) * hx_rcpCameraFrustumRange * rcpW1;\n    float rayPerspDepth = rayPerspDepth0;\n    // could probably optimize this:\n    float dRayD = (rayPerspDepth1 - rayPerspDepth0) * stepRatio;\n\n    float rcpW = rcpW0;\n    float dRcpW = (rcpW1 - rcpW0) * stepRatio;\n    float sceneDepth = rayDepth;\n\n    float amount = 0.0;\n\n    hitUV += dUV * dither.z;\n    rayPerspDepth += dRayD * dither.z;\n    rcpW += dRcpW * dither.z;\n\n    float sampleCount;\n    for (int i = 0; i < NUM_SAMPLES; ++i) {\n        rayDepth = rayPerspDepth / rcpW;\n\n        sceneDepth = hx_sampleLinearDepth(hx_gbufferDepth, hitUV);\n\n        if (rayDepth > sceneDepth + .001) {\n            amount = float(sceneDepth < 1.0);\n            sampleCount = float(i);\n            break;\n        }\n\n        hitUV += dUV;\n        rayPerspDepth += dRayD;\n        rcpW += dRcpW;\n    }\n\n    hitZ = -hx_cameraNearPlaneDistance - sceneDepth * hx_cameraFrustumRange;\n\n    // TODO: fade out last samples\n    amount *= clamp((1.0 - (sampleCount - float(NUM_SAMPLES)) / float(NUM_SAMPLES)) * 5.0, 0.0, 1.0);\n    return amount;\n}\n\nvoid main()\n{\n    vec4 colorSample = hx_gammaToLinear(texture2D(hx_gbufferColor, uv));\n    vec4 specularSample = texture2D(hx_gbufferSpecular, uv);\n    float depth = hx_sampleLinearDepth(hx_gbufferDepth, uv);\n    vec3 normalSpecularReflectance;\n    float roughness;\n    float metallicness;\n    hx_decodeReflectionData(colorSample, specularSample, normalSpecularReflectance, roughness, metallicness);\n    vec3 normal = hx_decodeNormal(texture2D(hx_gbufferNormals, uv));\n    vec3 reflDir = reflect(normalize(viewDir), normal);\n\n    vec3 fresnel = hx_fresnel(normalSpecularReflectance, reflDir, normal);\n    // not physically correct, but attenuation is required to look good\n\n    // step for every pixel\n\n    float absViewZ = hx_cameraNearPlaneDistance + depth * hx_cameraFrustumRange;\n    vec3 viewSpacePos = absViewZ * viewDir;\n\n    float hitZ = 0.0;\n    vec2 hitUV;\n    float amount = raytrace(viewSpacePos, reflDir, hitZ, hitUV);\n    float fadeFactor = 1.0 - clamp(reflDir.z * 2.0, 0.0, 1.0);\n\n    vec2 borderFactors = abs(hitUV * 2.0 - 1.0);\n    borderFactors = (1.0 - borderFactors) * 10.0;\n    fadeFactor *= clamp(borderFactors.x, 0.0, 1.0) * clamp(borderFactors.y, 0.0, 1.0);\n\n    float diff = viewSpacePos.z - hitZ;\n    fadeFactor *= hx_linearStep(-1.0, 0.0, diff);\n    fadeFactor *= hx_linearStep(maxRoughness, 0.0, roughness);\n\n    vec4 reflColor = texture2D(hx_frontbuffer, hitUV);\n\n    float amountUsed = amount * fadeFactor;\n    gl_FragColor = vec4(fresnel * reflColor.xyz, amountUsed);\n}\n\n',e.ShaderLibrary["ssr_stencil_fragment.glsl"]="uniform sampler2D hx_gbufferSpecular;\n\nvarying vec2 uv;\n\nuniform float maxRoughness;\n\nvoid main()\n{\n    vec4 specularSample = texture2D(hx_gbufferSpecular, uv);\n    if (specularSample.x > maxRoughness)\n        discard;\n}\n\n",e.ShaderLibrary["tonemap_filmic_fragment.glsl"]="void main()\n{\n\tvec4 color = hx_getToneMapScaledColor();\n\tvec3 x = max(vec3(0.0), color.xyz - 0.004);\n\n\t// this has pow 2.2 gamma included, not valid if using fast gamma correction\n\t//gl_FragColor = vec4((x * (6.2 * x + .5))/(x * (6.2 * x + 1.7) + 0.06), 1.0);\n\n    // Jim Hejl and Richard Burgess-Dawson\n\t/*float a = 6.2;\n    float b = .5;\n    float c = 6.2;\n    float d = 1.7;\n    float e = 0.06;*/\n\n\t// ACES -> this desaturates less\n\tfloat a = 2.51;\n    float b = 0.03;\n    float c = 2.43;\n    float d = 0.59;\n    float e = 0.14;\n\tgl_FragColor = vec4((x*(a*x+b))/(x*(c*x+d)+e), 1.0);\n}",e.ShaderLibrary["tonemap_reference_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D hx_backbuffer;\n\nvoid main()\n{\n\tvec4 color = texture2D(hx_backbuffer, uv);\n\tfloat lum = clamp(hx_luminance(color), 0.0, 1000.0);\n\tfloat l = log(1.0 + lum);\n\tgl_FragColor = vec4(l, l, l, 1.0);\n}",e.ShaderLibrary["tonemap_reinhard_fragment.glsl"]="void main()\n{\n\tvec4 color = hx_getToneMapScaledColor();\n\tfloat lum = hx_luminance(color);\n\tgl_FragColor = color / (1.0 + lum);\n}",e.ShaderLibrary["blend_color_copy_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D sampler;\n\nuniform vec4 blendColor;\n\nvoid main()\n{\n    // extractChannel comes from a macro\n   gl_FragColor = texture2D(sampler, uv) * blendColor;\n}\n",e.ShaderLibrary["copy_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D sampler;\n\nvoid main()\n{\n    // extractChannel comes from a macro\n   gl_FragColor = vec4(extractChannels(texture2D(sampler, uv)));\n\n#ifndef COPY_ALPHA\n   gl_FragColor.a = 1.0;\n#endif\n}\n",e.ShaderLibrary["copy_to_gamma_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D sampler;\n\nvoid main()\n{\n   gl_FragColor = vec4(hx_linearToGamma(texture2D(sampler, uv).xyz), 1.0);\n}",e.ShaderLibrary["copy_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec2 hx_texCoord;\n\nvarying vec2 uv;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    gl_Position = hx_position;\n}",e.ShaderLibrary["null_fragment.glsl"]="void main()\n{\n   gl_FragColor = vec4(1.0);\n}\n",e.ShaderLibrary["null_vertex.glsl"]="attribute vec4 hx_position;\n\nvoid main()\n{\n    gl_Position = hx_position;\n}",e.ShaderLibrary["dir_shadow_esm.glsl"]="vec4 hx_getShadowMapValue(float depth)\n{\n    // I wish we could write exp directly, but precision issues (can't encode real floats)\n    return vec4(exp(HX_ESM_CONSTANT * depth));\n// so when blurring, we'll need to do ln(sum(exp())\n//    return vec4(depth);\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec3 viewPos, mat4 shadowMapMatrix, float depthBias)\n{\n    vec4 shadowMapCoord = shadowMapMatrix * vec4(viewPos, 1.0);\n    float shadowSample = texture2D(shadowMap, shadowMapCoord.xy).x;\n    shadowMapCoord.z += depthBias;\n//    float diff = shadowSample - shadowMapCoord.z;\n//    return saturate(HX_ESM_DARKENING * exp(HX_ESM_CONSTANT * diff));\n    return saturate(HX_ESM_DARKENING * shadowSample * exp(-HX_ESM_CONSTANT * shadowMapCoord.z));\n}",e.ShaderLibrary["dir_shadow_hard.glsl"]="vec4 hx_getShadowMapValue(float depth)\n{\n    return hx_floatToRGBA8(depth);\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec3 viewPos, mat4 shadowMapMatrix, float depthBias)\n{\n    vec4 shadowMapCoord = shadowMapMatrix * vec4(viewPos, 1.0);\n    float shadowSample = hx_RGBA8ToFloat(texture2D(shadowMap, shadowMapCoord.xy));\n    float diff = shadowMapCoord.z - shadowSample - depthBias;\n    return float(diff < 0.0);\n}",e.ShaderLibrary["dir_shadow_pcf.glsl"]="#ifdef HX_PCF_DITHER_SHADOWS\n    uniform sampler2D hx_dither2D;\n    uniform vec2 hx_dither2DTextureScale;\n#endif\n\nuniform vec2 hx_poissonDisk[HX_PCF_NUM_SHADOW_SAMPLES];\n\nvec4 hx_getShadowMapValue(float depth)\n{\n    return hx_floatToRGBA8(depth);\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec3 viewPos, mat4 shadowMapMatrix, float depthBias)\n{\n    vec2 radii = vec2(shadowMapMatrix[0][0], shadowMapMatrix[1][1]) * float(HX_PCF_SOFTNESS);\n    vec4 shadowMapCoord = shadowMapMatrix * vec4(viewPos, 1.0);\n    float shadowTest = 0.0;\n\n    #ifdef HX_PCF_DITHER_SHADOWS\n        vec4 dither = texture2D(hx_dither2D, gl_FragCoord.xy * hx_dither2DTextureScale);\n        dither = vec4(dither.x, -dither.y, dither.y, dither.x) * radii.xxyy;  // add radius scale\n    #else\n        vec4 dither = radii.xxyy;\n    #endif\n\n    for (int i = 0; i < HX_PCF_NUM_SHADOW_SAMPLES; ++i) {\n        vec2 offset;\n        offset.x = dot(dither.xy, hx_poissonDisk[i]);\n        offset.y = dot(dither.zw, hx_poissonDisk[i]);\n        float shadowSample = hx_RGBA8ToFloat(texture2D(shadowMap, shadowMapCoord.xy + offset));\n        float diff = shadowMapCoord.z - shadowSample - depthBias;\n        shadowTest += float(diff < 0.0);\n    }\n\n    return shadowTest * HX_PCF_RCP_NUM_SHADOW_SAMPLES;\n}",e.ShaderLibrary["dir_shadow_vsm.glsl"]="#derivatives\n\nvec4 hx_getShadowMapValue(float depth)\n{\n    float dx = dFdx(depth);\n    float dy = dFdy(depth);\n    float moment2 = depth * depth + 0.25*(dx*dx + dy*dy);\n    return vec4(hx_floatToRG8(depth), hx_floatToRG8(moment2));\n}\n\nfloat hx_readShadow(sampler2D shadowMap, vec3 viewPos, mat4 shadowMapMatrix, float depthBias)\n{\n    vec4 shadowMapCoord = shadowMapMatrix * vec4(viewPos, 1.0);\n    vec4 s = texture2D(shadowMap, shadowMapCoord.xy);\n    vec2 moments = vec2(hx_RG8ToFloat(s.xy), hx_RG8ToFloat(s.zw));\n    shadowMapCoord.z += depthBias;\n\n    float variance = moments.y - moments.x * moments.x;\n    variance = max(variance, HX_VSM_MIN_VARIANCE);\n\n    float diff = shadowMapCoord.z - moments.x;\n    float upperBound = 1.0;\n\n    // transparents could be closer to the light than casters\n    if (diff > 0.0)\n        upperBound = variance / (variance + diff*diff);\n\n    return saturate((upperBound - HX_VSM_LIGHT_BLEED_REDUCTION) / HX_VSM_LIGHT_BLEED_REDUCTION_RANGE);\n}",e.ShaderLibrary["esm_blur_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D source;\nuniform vec2 direction; // this is 1/pixelSize\n\nfloat readValue(vec2 coord)\n{\n    float v = texture2D(source, coord).x;\n    return v;\n//    return exp(HX_ESM_CONSTANT * v);\n}\n\nvoid main()\n{\n    float total = readValue(uv);\n\n\tfor (int i = 1; i <= RADIUS; ++i) {\n\t    vec2 offset = direction * float(i);\n\t\ttotal += readValue(uv + offset) + readValue(uv - offset);\n\t}\n\n//\tgl_FragColor = vec4(log(total * RCP_NUM_SAMPLES) / HX_ESM_CONSTANT);\n\tgl_FragColor = vec4(total * RCP_NUM_SAMPLES);\n}",e.ShaderLibrary["vsm_blur_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D source;\nuniform vec2 direction; // this is 1/pixelSize\n\nvec2 readValues(vec2 coord)\n{\n    vec4 s = texture2D(source, coord);\n    return vec2(hx_RG8ToFloat(s.xy), hx_RG8ToFloat(s.zw));\n}\n\nvoid main()\n{\n    vec2 total = readValues(uv);\n\n\tfor (int i = 1; i <= RADIUS; ++i) {\n\t    vec2 offset = direction * float(i);\n\t\ttotal += readValues(uv + offset) + readValues(uv - offset);\n\t}\n\n    total *= RCP_NUM_SAMPLES;\n\n\tgl_FragColor.xy = hx_floatToRG8(total.x);\n\tgl_FragColor.zw = hx_floatToRG8(total.y);\n}",e.ShaderLibrary["snippets_general.glsl"]="#define HX_LOG_10 2.302585093\n\nfloat saturate(float value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\nvec2 saturate(vec2 value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\nvec4 saturate(vec4 value)\n{\n    return clamp(value, 0.0, 1.0);\n}\n\n// Only for 0 - 1\nvec4 hx_floatToRGBA8(float value)\n{\n    vec4 enc = value * vec4(1.0, 255.0, 65025.0, 16581375.0);\n    // cannot fract first value or 1 would not be encodable\n    enc.yzw = fract(enc.yzw);\n    return enc - enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n}\n\nfloat hx_RGBA8ToFloat(vec4 rgba)\n{\n    return dot(rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0));\n}\n\nvec2 hx_floatToRG8(float value)\n{\n    vec2 enc = vec2(1.0, 255.0) * value;\n    enc.y = fract(enc.y);\n    enc.x -= enc.y / 255.0;\n    return enc;\n}\n\nfloat hx_RG8ToFloat(vec2 rg)\n{\n    return dot(rg, vec2(1.0, 1.0/255.0));\n}\n\nvec2 hx_encodeNormal(vec3 normal)\n{\n    vec2 data;\n    float p = sqrt(normal.z*8.0 + 8.0);\n    data = normal.xy / p + .5;\n    return data;\n}\n\nvec3 hx_decodeNormal(vec4 data)\n{\n    vec3 normal;\n    data.xy = data.xy*4.0 - 2.0;\n    float f = dot(data.xy, data.xy);\n    float g = sqrt(1.0 - f * .25);\n    normal.xy = data.xy * g;\n    normal.z = 1.0 - f * .5;\n    return normal;\n}\n\nfloat hx_log10(float val)\n{\n    return log(val) / HX_LOG_10;\n}\n\nvec4 hx_gammaToLinear(vec4 color)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        color.x = pow(color.x, 2.2);\n        color.y = pow(color.y, 2.2);\n        color.z = pow(color.z, 2.2);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        color.xyz *= color.xyz;\n    #endif\n    return color;\n}\n\nvec3 hx_gammaToLinear(vec3 color)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        color.x = pow(color.x, 2.2);\n        color.y = pow(color.y, 2.2);\n        color.z = pow(color.z, 2.2);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        color.xyz *= color.xyz;\n    #endif\n    return color;\n}\n\nvec4 hx_linearToGamma(vec4 linear)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        linear.x = pow(linear.x, 0.454545);\n        linear.y = pow(linear.y, 0.454545);\n        linear.z = pow(linear.z, 0.454545);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        linear.xyz = sqrt(linear.xyz);\n    #endif\n    return linear;\n}\n\nvec3 hx_linearToGamma(vec3 linear)\n{\n    #if defined(HX_GAMMA_CORRECTION_PRECISE)\n        linear.x = pow(linear.x, 0.454545);\n        linear.y = pow(linear.y, 0.454545);\n        linear.z = pow(linear.z, 0.454545);\n    #elif defined(HX_GAMMA_CORRECTION_FAST)\n        linear.xyz = sqrt(linear.xyz);\n    #endif\n    return linear;\n}\n\n/*float hx_sampleLinearDepth(sampler2D tex, vec2 uv)\n{\n    return hx_RGBA8ToFloat(texture2D(tex, uv));\n}*/\n\nfloat hx_decodeLinearDepth(vec4 samp)\n{\n    return hx_RG8ToFloat(samp.zw);\n}\n\nvec3 hx_getFrustumVector(vec2 position, mat4 unprojectionMatrix)\n{\n    vec4 unprojNear = unprojectionMatrix * vec4(position, -1.0, 1.0);\n    vec4 unprojFar = unprojectionMatrix * vec4(position, 1.0, 1.0);\n    return unprojFar.xyz/unprojFar.w - unprojNear.xyz/unprojNear.w;\n}\n\n// view vector with z = -1, so we can use nearPlaneDist + linearDepth * (farPlaneDist - nearPlaneDist) as a scale factor to find view space position\nvec3 hx_getLinearDepthViewVector(vec2 position, mat4 unprojectionMatrix)\n{\n    vec4 unproj = unprojectionMatrix * vec4(position, 0.0, 1.0);\n    unproj /= unproj.w;\n    return -unproj.xyz / unproj.z;\n}\n\n// THIS IS FOR NON_LINEAR DEPTH!\nfloat hx_depthToViewZ(float depthSample, mat4 projectionMatrix)\n{\n//    z = -projectionMatrix[3][2] / (d * 2.0 - 1.0 + projectionMatrix[2][2])\n    return -projectionMatrix[3][2] / (depthSample * 2.0 - 1.0 + projectionMatrix[2][2]);\n}\n\nvec3 hx_getNormalSpecularReflectance(float metallicness, float insulatorNormalSpecularReflectance, vec3 color)\n{\n    return mix(vec3(insulatorNormalSpecularReflectance), color, metallicness);\n}\n\nvec3 hx_fresnel(vec3 normalSpecularReflectance, vec3 lightDir, vec3 halfVector)\n{\n    float cosAngle = 1.0 - max(dot(halfVector, lightDir), 0.0);\n    // to the 5th power\n    float power = pow(cosAngle, 5.0);\n    return normalSpecularReflectance + (1.0 - normalSpecularReflectance) * power;\n}\n\n// https://seblagarde.wordpress.com/2011/08/17/hello-world/\nvec3 hx_fresnelProbe(vec3 normalSpecularReflectance, vec3 lightDir, vec3 normal, float roughness)\n{\n    float cosAngle = 1.0 - max(dot(normal, lightDir), 0.0);\n    // to the 5th power\n    float power = pow(cosAngle, 5.0);\n    float gloss = (1.0 - roughness) * (1.0 - roughness);\n    vec3 bound = max(vec3(gloss), normalSpecularReflectance);\n    return normalSpecularReflectance + (bound - normalSpecularReflectance) * power;\n}\n\n\nfloat hx_luminance(vec4 color)\n{\n    return dot(color.xyz, vec3(.30, 0.59, .11));\n}\n\nfloat hx_luminance(vec3 color)\n{\n    return dot(color, vec3(.30, 0.59, .11));\n}\n\n// linear variant of smoothstep\nfloat hx_linearStep(float lower, float upper, float x)\n{\n    return clamp((x - lower) / (upper - lower), 0.0, 1.0);\n}\n\n// sadly, need a parameter due to a bug in Internet Explorer / Edge. Just pass in 0.\n#ifdef HX_USE_SKINNING_TEXTURE\n#define HX_RCP_MAX_BONES 1.0 / float(HX_MAX_BONES - 1)\nmat4 hx_getSkinningMatrixImpl(vec4 weights, vec4 indices, sampler2D tex)\n{\n    mat4 m = mat4(0.0);\n    for (int i = 0; i < 4; ++i) {\n        mat4 t;\n        float index = indices[i] * HX_RCP_MAX_BONES;\n        t[0] = texture2D(tex, vec2(index, 0.0));\n        t[1] = texture2D(tex, vec2(index, 0.5));\n        t[2] = texture2D(tex, vec2(index, 1.0));\n        t[3] = vec4(0.0, 0.0, 0.0, 1.0);\n        m += weights[i] * t;\n    }\n    return m;\n}\n#define hx_getSkinningMatrix(v) hx_getSkinningMatrixImpl(hx_boneWeights, hx_boneIndices, hx_skinningTexture)\n#else\n#define hx_getSkinningMatrix(v) ( hx_boneWeights.x * mat4(hx_skinningMatrices[int(hx_boneIndices.x) * 3], hx_skinningMatrices[int(hx_boneIndices.x) * 3 + 1], hx_skinningMatrices[int(hx_boneIndices.x) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) + hx_boneWeights.y * mat4(hx_skinningMatrices[int(hx_boneIndices.y) * 3], hx_skinningMatrices[int(hx_boneIndices.y) * 3 + 1], hx_skinningMatrices[int(hx_boneIndices.y) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) + hx_boneWeights.z * mat4(hx_skinningMatrices[int(hx_boneIndices.z) * 3], hx_skinningMatrices[int(hx_boneIndices.z) * 3 + 1], hx_skinningMatrices[int(hx_boneIndices.z) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) + hx_boneWeights.w * mat4(hx_skinningMatrices[int(hx_boneIndices.w) * 3], hx_skinningMatrices[int(hx_boneIndices.w) * 3 + 1], hx_skinningMatrices[int(hx_boneIndices.w) * 3 + 2], vec4(0.0, 0.0, 0.0, 1.0)) )\n#endif",e.ShaderLibrary["snippets_geometry.glsl"]="struct HX_GeometryData\n{\n    vec4 color;\n    vec3 normal;\n    float metallicness;\n    float normalSpecularReflectance;\n    float roughness;\n    vec3 emission;\n    vec4 data;  // this can be anything the lighting model requires\n};",e.ShaderLibrary["snippets_tonemap.glsl"]="varying vec2 uv;\n\n#ifdef HX_ADAPTIVE\nuniform sampler2D hx_luminanceMap;\nuniform float hx_luminanceMipLevel;\n#endif\n\nuniform float hx_exposure;\nuniform float hx_key;\n\nuniform sampler2D hx_backbuffer;\n\n\nvec4 hx_getToneMapScaledColor()\n{\n    #ifdef HX_ADAPTIVE\n    float referenceLuminance = exp(texture2DLodEXT(hx_luminanceMap, uv, hx_luminanceMipLevel).x) - 1.0;\n    referenceLuminance = clamp(referenceLuminance, .08, 1000.0);\n\tfloat exposure = hx_key / referenceLuminance * hx_exposure;\n\t#else\n\tfloat exposure = hx_exposure;\n\t#endif\n    return texture2D(hx_backbuffer, uv) * exposure;\n}",e.ShaderLibrary["2d_to_cube_vertex.glsl"]="// position to write to\nattribute vec4 hx_position;\n\n// the corner of the cube map\nattribute vec3 corner;\n\nvarying vec3 direction;\n\nvoid main()\n{\n    direction = corner;\n    gl_Position = hx_position;\n}\n",e.ShaderLibrary["equirectangular_to_cube_fragment.glsl"]="#define RECIPROCAL_PI2 0.15915494\n\nvarying vec3 direction;\n\nuniform sampler2D source;\n\nvoid main()\n{\n    vec3 dir = normalize(direction);\n    vec2 uv;\n    uv.x = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tuv.y = dir.y * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n",e.ShaderLibrary["greyscale_to_rgba8.glsl"]="varying vec2 uv;\n\nuniform sampler2D source;\n\nvoid main()\n{\n    gl_FragColor = hx_floatToRGBA8(texture2D(source, uv).x);\n}\n",e.ShaderLibrary["smooth_heightmap_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D reference;    // the source (8 bit) texture\nuniform sampler2D source;\n\nuniform vec2 stepSize;\n\nvoid main()\n{\n    float gauss[4];\n    gauss[0] = 0.201788613113303;\n    gauss[1] = 0.17755834971394;\n    gauss[2] = 0.120969095455128;\n    gauss[3] = 0.063811162332456;\n    float refHeight = texture2D(reference, uv).x;\n    float total = hx_RGBA8ToFloat(texture2D(source, uv)) * gauss[0];\n    float totalWeight = gauss[0];\n    float currentWeightL = 1.0;\n    float currentWeightR = 1.0;\n    vec2 offset = vec2(0.0);\n\n\n    for (int i = 0; i < 3; ++i) {\n        offset += stepSize;\n        float refLeft = texture2D(reference, uv - offset).x;\n        float refRight = texture2D(reference, uv + offset).x;\n        float heightLeft = hx_RGBA8ToFloat(texture2D(source, uv - offset));\n        float heightRight = hx_RGBA8ToFloat(texture2D(source, uv + offset));\n        // smooth out over N pixels that have the same reference height in the source image\n        currentWeightL = max(currentWeightL - abs(refLeft - refHeight) * 5.0, 0.0);\n        currentWeightR = max(currentWeightR - abs(refRight - refHeight) * 5.0, 0.0);\n        totalWeight += (currentWeightL + currentWeightR) * gauss[i + 1];\n        total += (heightLeft * currentWeightL + heightRight * currentWeightR) *  gauss[i + 1];\n    }\n\n    gl_FragColor = hx_floatToRGBA8(total / totalWeight);\n//    gl_FragColor = hx_floatToRGBA8(refHeight);\n}\n",e.ShaderLibrary["ao_blur_fragment.glsl"]="varying vec2 uv;\n\nuniform sampler2D source;\nuniform vec2 halfTexelOffset;\n\nvoid main()\n{\n    vec4 total = texture2D(source, uv - halfTexelOffset * 3.0);\n    total += texture2D(source, uv + halfTexelOffset);\n\tgl_FragColor = total * .5;\n}",e.ShaderLibrary["hbao_fragment.glsl"]="uniform float hx_cameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\nuniform vec2 hx_rcpRenderTargetResolution;\nuniform mat4 hx_projectionMatrix;\n\nuniform float strengthPerRay;\nuniform float halfSampleRadius;\nuniform float bias;\nuniform float rcpFallOffDistance;\nuniform vec2 ditherScale;\n\nuniform sampler2D hx_normalDepth;\nuniform sampler2D sampleDirTexture;\nuniform sampler2D ditherTexture;\n\nvarying vec2 uv;\nvarying vec3 viewDir;\nvarying vec3 frustumCorner;\n\nvec3 getViewPos(vec2 sampleUV)\n{\n    vec4 smp = texture2D(hx_normalDepth, sampleUV);\n    float depth = hx_decodeLinearDepth(smp);\n    float viewZ = depth * hx_cameraFrustumRange + hx_cameraNearPlaneDistance;\n    vec3 viewPos = frustumCorner * vec3(sampleUV * 2.0 - 1.0, 1.0);\n    return viewPos * viewZ;\n}\n\n// Retrieves the occlusion factor for a particular sample\nfloat getSampleOcclusion(vec2 sampleUV, vec3 centerViewPos, vec3 centerNormal, vec3 tangent, inout float topOcclusion)\n{\n    vec3 sampleViewPos = getViewPos(sampleUV);\n\n    // get occlusion factor based on candidate horizon elevation\n    vec3 horizonVector = sampleViewPos - centerViewPos;\n    float horizonVectorLength = length(horizonVector);\n\n    float occlusion;\n\n    // If the horizon vector points away from the tangent, make an estimate\n    if (dot(tangent, horizonVector) < 0.0)\n        occlusion = .5;\n    else\n        occlusion = dot(centerNormal, horizonVector) / horizonVectorLength;\n\n    // this adds occlusion only if angle of the horizon vector is higher than the previous highest one without branching\n    float diff = max(occlusion - topOcclusion, 0.0);\n    topOcclusion = max(occlusion, topOcclusion);\n\n    // attenuate occlusion contribution using distance function 1 - (d/f)^2\n    float distanceFactor = clamp(horizonVectorLength * rcpFallOffDistance, 0.0, 1.0);\n    distanceFactor = 1.0 - distanceFactor * distanceFactor;\n    return diff * distanceFactor;\n}\n\n// Retrieves the occlusion for a given ray\nfloat getRayOcclusion(vec2 direction, float jitter, vec2 projectedRadii, vec3 centerViewPos, vec3 centerNormal)\n{\n    // calculate the nearest neighbour sample along the direction vector\n    vec2 texelSizedStep = direction * hx_rcpRenderTargetResolution;\n    direction *= projectedRadii;\n\n    // gets the tangent for the current ray, this will be used to handle opposing horizon vectors\n    // Tangent is corrected with respect to face normal by projecting it onto the tangent plane defined by the normal\n    vec3 tangent = getViewPos(uv + texelSizedStep) - centerViewPos;\n    tangent -= dot(centerNormal, tangent) * centerNormal;\n\n    vec2 stepUV = direction.xy / float(NUM_SAMPLES_PER_RAY - 1);\n\n    // jitter the starting position for ray marching between the nearest neighbour and the sample step size\n    vec2 jitteredOffset = mix(texelSizedStep, stepUV, jitter);\n    //stepUV *= 1.0 + jitter * .1;\n    vec2 sampleUV = uv + jitteredOffset;\n\n    // top occlusion keeps track of the occlusion contribution of the last found occluder.\n    // set to bias value to avoid near-occluders\n    float topOcclusion = bias;\n    float occlusion = 0.0;\n\n    // march!\n    for (int step = 0; step < NUM_SAMPLES_PER_RAY; ++step) {\n        occlusion += getSampleOcclusion(sampleUV, centerViewPos, centerNormal, tangent, topOcclusion);\n        sampleUV += stepUV;\n    }\n\n    return occlusion;\n}\n\nvoid main()\n{\n    vec4 normalDepth = texture2D(hx_normalDepth, uv);\n    vec3 centerNormal = hx_decodeNormal(normalDepth);\n    float centerDepth = hx_decodeLinearDepth(normalDepth);\n    float viewZ = hx_cameraNearPlaneDistance + centerDepth * hx_cameraFrustumRange;\n    vec3 centerViewPos = viewZ * viewDir;\n\n    // clamp z to a minimum, so the radius does not get excessively large in screen-space\n    float projRadius = halfSampleRadius / max(-centerViewPos.z, 7.0);\n    vec2 projectedRadii = projRadius * vec2(hx_projectionMatrix[0][0], hx_projectionMatrix[1][1]);\n\n    // do not take more steps than there are pixels\n    float totalOcclusion = 0.0;\n\n    vec2 randomFactors = texture2D(ditherTexture, uv * ditherScale).xy;\n\n    vec2 rayUV = vec2(0.0);\n    for (int i = 0; i < NUM_RAYS; ++i) {\n        rayUV.x = (float(i) + randomFactors.x) / float(NUM_RAYS);\n        vec2 sampleDir = texture2D(sampleDirTexture, rayUV).xy * 2.0 - 1.0;\n        totalOcclusion += getRayOcclusion(sampleDir, randomFactors.y, projectedRadii, centerViewPos, centerNormal);\n    }\n\n    totalOcclusion = 1.0 - clamp(strengthPerRay * totalOcclusion, 0.0, 1.0);\n    gl_FragColor = vec4(vec3(totalOcclusion), 1.0);\n}",e.ShaderLibrary["hbao_vertex.glsl"]="attribute vec4 hx_position;\nattribute vec2 hx_texCoord;\n\nuniform mat4 hx_inverseProjectionMatrix;\n\nvarying vec2 uv;\nvarying vec3 viewDir;\nvarying vec3 frustumCorner;\n\nvoid main()\n{\n    uv = hx_texCoord;\n    viewDir = hx_getLinearDepthViewVector(hx_position.xy, hx_inverseProjectionMatrix);\n    frustumCorner = hx_getLinearDepthViewVector(vec2(1.0, 1.0), hx_inverseProjectionMatrix);\n    gl_Position = hx_position;\n}",e.ShaderLibrary["ssao_fragment.glsl"]="uniform mat4 hx_projectionMatrix;\nuniform mat4 hx_cameraWorldMatrix;\nuniform float hx_cameraFrustumRange;\nuniform float hx_cameraNearPlaneDistance;\n\nuniform vec2 ditherScale;\nuniform float strengthPerSample;\nuniform float rcpFallOffDistance;\nuniform float sampleRadius;\nuniform vec3 samples[NUM_SAMPLES]; // w contains bias\n\nuniform sampler2D ditherTexture;\nuniform sampler2D hx_normalDepth;\n\nvarying vec2 uv;\n\nvoid main()\n{\n    vec4 normalDepth = texture2D(hx_normalDepth, uv);\n    vec3 centerNormal = hx_decodeNormal(normalDepth);\n    float centerDepth = hx_decodeLinearDepth(normalDepth);\n    float totalOcclusion = 0.0;\n    vec3 dither = texture2D(ditherTexture, uv * ditherScale).xyz;\n    vec3 randomPlaneNormal = normalize(dither - .5);\n    float w = centerDepth * hx_cameraFrustumRange + hx_cameraNearPlaneDistance;\n    vec3 sampleRadii;\n    sampleRadii.xy = sampleRadius * .5 / w * vec2(hx_projectionMatrix[0][0], hx_projectionMatrix[1][1]);\n    sampleRadii.z = sampleRadius;\n\n    for (int i = 0; i < NUM_SAMPLES; ++i) {\n        vec3 sampleOffset = reflect(samples[i], randomPlaneNormal);\n        vec3 normOffset = normalize(sampleOffset);\n        float cosFactor = dot(normOffset, centerNormal);\n        float sign = sign(cosFactor);\n        sampleOffset *= sign;\n        cosFactor *= sign;\n\n        vec3 scaledOffset = sampleOffset * sampleRadii;\n\n        vec2 samplePos = uv + scaledOffset.xy;\n        normalDepth = texture2D(hx_normalDepth, samplePos);\n        float occluderDepth = hx_decodeLinearDepth(normalDepth);\n        float diffZ = (centerDepth - occluderDepth) * hx_cameraFrustumRange;\n\n        // distanceFactor: from 1 to 0, near to far\n        float distanceFactor = clamp(diffZ * rcpFallOffDistance, 0.0, 1.0);\n        distanceFactor = 1.0 - distanceFactor;\n\n        // sampleOcclusion: 1 if occluding, 0 otherwise\n        float sampleOcclusion = float(diffZ > scaledOffset.z);\n        totalOcclusion += sampleOcclusion * distanceFactor * cosFactor;\n    }\n    gl_FragColor = vec4(vec3(1.0 - totalOcclusion * strengthPerSample), 1.0);\n}",e.Float2=function(t,e){this.x=t||0,this.y=e||0},e.Float2.angle=function(t,i){return Math.acos(e.dot2(t,i)/(t.length*i.length))},e.Float2.distance=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},e.Float2.angleNormalized=function(t,i){return Math.acos(e.dot2(t,i))},e.Float2.add=function(t,i,n){return n=n||new e.Float2,n.x=t.x+i.x,n.y=t.y+i.y,n},e.Float2.subtract=function(t,i,n){return n=n||new e.Float2,n.x=t.x-i.x,n.y=t.y-i.y,n},e.Float2.scale=function(t,i,n){return n=n||new e.Float2,n.x=t.x*i,n.y=t.y*i,n},e.Float2.negate=function(t,i,n){return n=n||new e.Float2,n.x=-n.x,n.y=-n.y,n},e.Float2.prototype={constructor:e.Float2,set:function(t,e){this.x=t,this.y=e},get lengthSqr(){return this.x*this.x+this.y*this.y},get length(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var t=1/this.length;this.x*=t,this.y*=t},clone:function(){return new e.Float2(this.x,this.y)},add:function(t){
this.x+=t.x,this.y+=t.y},subtract:function(t){this.x-=t.x,this.y-=t.y},scale:function(t){this.x*=t,this.y*=t},negate:function(){this.x=-this.x,this.y=-this.y},abs:function(){this.x=Math.abs(this.x),this.y=Math.abs(this.y)},lerp:function(t,e,i){var n=t.x,r=t.y;this.x=n+(e.x-n)*i,this.y=r+(e.y-r)*i},fromPolarCoordinates:function(t,e){this.x=t*Math.cos(e),this.y=t*Math.sin(e)},copyFrom:function(t){this.x=t.x,this.y=t.y},maximize:function(t){t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y)},minimize:function(t){t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y)}},e.Float2.ZERO=new e.Float2(0,0),e.Float2.X_AXIS=new e.Float2(1,0),e.Float2.Y_AXIS=new e.Float2(0,1),e.PlaneSide={FRONT:1,BACK:-1,INTERSECTING:0},e.Float4=function(t,e,i,n){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0===n?1:n},e.Float4.angle=function(t,i){return Math.acos(e.dot3(t,i)/(t.length*i.length))},e.Float4.distance=function(t,e){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+n*n+r*r)},e.Float4.negate=function(t,i){return i=i||new e.Float4,i.x=-t.x,i.y=-t.y,i.z=-t.z,i.w=-t.w,i},e.Float4.angleNormalized=function(t,i){return Math.acos(e.dot3(t,i))},e.Float4.add=function(t,i,n){return n=n||new e.Float4,n.x=t.x+i.x,n.y=t.y+i.y,n.z=t.z+i.z,n.w=t.w+i.w,n},e.Float4.subtract=function(t,i,n){return n=n||new e.Float4,n.x=t.x-i.x,n.y=t.y-i.y,n.z=t.z-i.z,n.w=t.w-i.w,n},e.Float4.scale=function(t,i,n){return n=n||new e.Float4,n.x=t.x*i,n.y=t.y*i,n.z=t.z*i,n},e.Float4.scale4=function(t,i,n){return n=n||new e.Float4,n.x=t.x*i,n.y=t.y*i,n.z=t.z*i,n.w=t.w*i,n},e.Float4.prototype={constructor:e.Float4,set:function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=void 0===n?this.w:n},get lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z},get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var t=1/this.length;this.x*=t,this.y*=t,this.z*=t},normalizeAsPlane:function(){var t=1/this.length;this.x*=t,this.y*=t,this.z*=t,this.w*=t},clone:function(){return new e.Float4(this.x,this.y,this.z,this.w)},add:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w},addScaled:function(t,e){this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e},subtract:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w},scale:function(t){this.x*=t,this.y*=t,this.z*=t},scale4:function(t){this.x*=t,this.y*=t,this.z*=t,this.w*=t},negate:function(){this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w},homogeneousProject:function(){var t=1/this.w;this.x*=t,this.y*=t,this.z*=t,this.w=1},abs:function(){this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this.w=Math.abs(this.w)},cross:function(t,e){var i=t.x,n=t.y,r=t.z,o=e.x,s=e.y,a=e.z;this.x=n*a-r*s,this.y=r*o-i*a,this.z=i*s-n*o},lerp:function(t,e,i){var n=t.x,r=t.y,o=t.z,s=t.w;this.x=n+(e.x-n)*i,this.y=r+(e.y-r)*i,this.z=o+(e.z-o)*i,this.w=s+(e.w-s)*i},fromSphericalCoordinates:function(t,e,i){this.x=t*Math.sin(i)*Math.cos(e),this.y=t*Math.cos(i),this.z=t*Math.sin(i)*Math.sin(e),this.w=0},copyFrom:function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},maximize:function(t){t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w)},maximize3:function(t){t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z)},minimize:function(t){t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w)},minimize3:function(t){t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z)},toString:function(){return"Float4("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}},e.Float4.ORIGIN_POINT=new e.Float4(0,0,0,1),e.Float4.ZERO=new e.Float4(0,0,0,0),e.Float4.X_AXIS=new e.Float4(1,0,0,0),e.Float4.Y_AXIS=new e.Float4(0,1,0,0),e.Float4.Z_AXIS=new e.Float4(0,0,1,0),e.Gaussian={estimateGaussianRadius:function(t,e){return Math.sqrt(-2*t*Math.log(e))}},e.CenteredGaussianCurve=function(t){this._amplitude=1/Math.sqrt(2*t*Math.PI),this._expScale=-1/(2*t)},e.CenteredGaussianCurve.prototype={getValueAt:function(t){return this._amplitude*Math.pow(Math.E,t*t*this._expScale)}},e.CenteredGaussianCurve.fromRadius=function(t,i){i=i||.01;var n=t/Math.sqrt(-2*Math.log(i));return new e.CenteredGaussianCurve(n*n)},e.dot2=function(t,e){return t.x*e.x+t.y*e.y},e.dot3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.dot4=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.sign=function(t){return 0===t?0:t>0?1:-1},e.isPowerOfTwo=function(t){return!!t&&(t&-t)===t},e.RCP_LOG_OF_2=1/Math.log(2),e.DEG_TO_RAD=Math.PI/180,e.RAD_TO_DEG=180/Math.PI,e.log2=function(t){return Math.log(t)*e.RCP_LOG_OF_2},e.clamp=function(t,e,i){return t<e?e:t>i?i:t},e.saturate=function(t){return e.clamp(t,0,1)},e.lerp=function(t,e,i){return t+(e-t)*i},e.Matrix4x4=function(t,e,i,n,r,o,s,a,h,l,u,c,_,d,f,p){if(void 0!==t&&isNaN(t))this._m=new Float32Array(t);else{var m=this._m=new Float32Array(16);m[0]=void 0===t?1:0,m[1]=r||0,m[2]=h||0,m[3]=_||0,m[4]=e||0,m[5]=void 0===o?1:0,m[6]=l||0,m[7]=d||0,m[8]=i||0,m[9]=s||0,m[10]=void 0===u?1:0,m[11]=f||0,m[12]=n||0,m[13]=a||0,m[14]=c||0,m[15]=void 0===p?1:0}},e.Matrix4x4.prototype={constructor:e.Matrix4x4,transform:function(t,i){i=i||new e.Float4;var n=t.x,r=t.y,o=t.z,s=t.w,a=this._m;return i.x=a[0]*n+a[4]*r+a[8]*o+a[12]*s,i.y=a[1]*n+a[5]*r+a[9]*o+a[13]*s,i.z=a[2]*n+a[6]*r+a[10]*o+a[14]*s,i.w=a[3]*n+a[7]*r+a[11]*o+a[15]*s,i},transformPoint:function(t,i){i=i||new e.Float4;var n=t.x,r=t.y,o=t.z,s=this._m;return i.x=s[0]*n+s[4]*r+s[8]*o+s[12],i.y=s[1]*n+s[5]*r+s[9]*o+s[13],i.z=s[2]*n+s[6]*r+s[10]*o+s[14],i.w=1,i},transformVector:function(t,i){i=i||new e.Float4;var n=t.x,r=t.y,o=t.z,s=this._m;return i.x=s[0]*n+s[4]*r+s[8]*o,i.y=s[1]*n+s[5]*r+s[9]*o,i.z=s[2]*n+s[6]*r+s[10]*o,i.w=0,i},transformExtent:function(t,i){i=i||new e.Float4;var n=t.x,r=t.y,o=t.z,s=this._m,a=s[0],h=s[1],l=s[2],u=s[4],c=s[5],_=s[6],d=s[8],f=s[9],p=s[10];return a<0&&(a=-a),h<0&&(h=-h),l<0&&(l=-l),u<0&&(u=-u),c<0&&(c=-c),_<0&&(_=-_),d<0&&(d=-d),f<0&&(f=-f),p<0&&(p=-p),i.x=a*n+u*r+d*o,i.y=h*n+c*r+f*o,i.z=l*n+_*r+p*o,i.w=0,i},copyFrom:function(t){var e=this._m,i=t._m;e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15]},fromQuaternion:function(t){var e=t.x,i=t.y,n=t.z,r=t.w,o=this._m;o[0]=1-2*(i*i+n*n),o[1]=2*(e*i+r*n),o[2]=2*(e*n-r*i),o[3]=0,o[4]=2*(e*i-r*n),o[5]=1-2*(e*e+n*n),o[6]=2*(i*n+r*e),o[7]=0,o[8]=2*(e*n+r*i),o[9]=2*(i*n-r*e),o[10]=1-2*(e*e+i*i),o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1},multiply:function(t,e){var i=t._m,n=e._m,r=i[0],o=i[1],s=i[2],a=i[3],h=i[4],l=i[5],u=i[6],c=i[7],_=i[8],d=i[9],f=i[10],p=i[11],m=i[12],g=i[13],x=i[14],S=i[15],v=n[0],T=n[1],E=n[2],y=n[3],M=n[4],A=n[5],P=n[6],b=n[7],w=n[8],R=n[9],D=n[10],C=n[11],L=n[12],O=n[13],I=n[14],F=n[15],N=this._m;N[0]=r*v+h*T+_*E+m*y,N[1]=o*v+l*T+d*E+g*y,N[2]=s*v+u*T+f*E+x*y,N[3]=a*v+c*T+p*E+S*y,N[4]=r*M+h*A+_*P+m*b,N[5]=o*M+l*A+d*P+g*b,N[6]=s*M+u*A+f*P+x*b,N[7]=a*M+c*A+p*P+S*b,N[8]=r*w+h*R+_*D+m*C,N[9]=o*w+l*R+d*D+g*C,N[10]=s*w+u*R+f*D+x*C,N[11]=a*w+c*R+p*D+S*C,N[12]=r*L+h*O+_*I+m*F,N[13]=o*L+l*O+d*I+g*F,N[14]=s*L+u*O+f*I+x*F,N[15]=a*L+c*O+p*I+S*F},multiplyAffine:function(t,e){var i=t._m,n=e._m,r=i[0],o=i[1],s=i[2],a=i[4],h=i[5],l=i[6],u=i[8],c=i[9],_=i[10],d=i[12],f=i[13],p=i[14],m=n[0],g=n[1],x=n[2],S=n[4],v=n[5],T=n[6],E=n[8],y=n[9],M=n[10],A=n[12],P=n[13],b=n[14],w=this._m;w[0]=r*m+a*g+u*x,w[1]=o*m+h*g+c*x,w[2]=s*m+l*g+_*x,w[4]=r*S+a*v+u*T,w[5]=o*S+h*v+c*T,w[6]=s*S+l*v+_*T,w[8]=r*E+a*y+u*M,w[9]=o*E+h*y+c*M,w[10]=s*E+l*y+_*M,w[12]=r*A+a*P+u*b+d,w[13]=o*A+h*P+c*b+f,w[14]=s*A+l*P+_*b+p},fromRotationAxisAngle:function(t,e){var i=Math.cos(e),n=Math.sin(e),r=1/t.length,o=t.x*r,s=t.y*r,a=t.z*r,h=1-i,l=this._m;l[0]=h*o*o+i,l[1]=h*o*s+n*a,l[2]=h*o*a-n*s,l[3]=0,l[4]=h*o*s-n*a,l[5]=h*s*s+i,l[6]=h*s*a+n*o,l[7]=0,l[8]=h*o*a+n*s,l[9]=h*s*a-n*o,l[10]=h*a*a+i,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1},fromEuler:function(t,e,i){var n=Math.cos(t),r=Math.sin(t),o=Math.cos(e),s=Math.sin(e),a=Math.cos(i),h=Math.sin(i),l=this._m;l[0]=o*a,l[1]=n*h+r*s*a,l[2]=r*h-n*s*a,l[3]=0,l[4]=-o*h,l[5]=n*a-r*s*h,l[6]=r*a+n*s*h,l[7]=0,l[8]=s,l[9]=-r*o,l[10]=n*o,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1},fromRotationPitchYawRoll:function(t,e,i){var n=Math.cos(-t),r=Math.cos(-e),o=Math.cos(i),s=Math.sin(-t),a=Math.sin(-e),h=Math.sin(i),l=-a*n,u=-s,c=r*n,_=-r*h-a*s*o,d=n*o,f=-a*h+s*o*r,p=d*c-f*u,m=f*l-_*c,g=_*u-d*l,x=this._m;x[0]=p,x[1]=m,x[2]=g,x[3]=0,x[4]=_,x[5]=d,x[6]=f,x[7]=0,x[8]=l,x[9]=u,x[10]=c,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1},fromTranslation:function(t,e,i){void 0===e&&(t=t.x,e=t.y,i=t.z);var n=this._m;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=t,n[13]=e,n[14]=i,n[15]=1},fromScale:function(t,e,i){void 0===e&&(e=i=t);var n=this._m;n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=i,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},fromPerspectiveProjection:function(t,e,i,n){var r=1/Math.tan(.5*t),o=r/e,s=1/(i-n),a=this._m;a[0]=o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=r,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(n+i)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*n*s,a[15]=0},fromOrthographicOffCenterProjection:function(t,e,i,n,r,o){var s=1/(e-t),a=1/(i-n),h=1/(r-o),l=this._m;l[0]=2*s,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=2*a,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=2*h,l[11]=0,l[12]=-(t+e)*s,l[13]=-(i+n)*a,l[14]=(o+r)*h,l[15]=1},fromOrthographicProjection:function(t,e,i,n){var r=1/t,o=1/e,s=1/(i-n),a=this._m;a[0]=2*r,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*s,a[11]=0,a[12]=0,a[13]=0,a[14]=(n+i)*s,a[15]=1},clone:function(){return new e.Matrix4x4(this._m)},transpose:function(){var t=this._m,e=t[1],i=t[2],n=t[3],r=t[6],o=t[7],s=t[11];t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=e,t[6]=t[9],t[7]=t[13],t[8]=i,t[9]=r,t[11]=t[14],t[12]=n,t[13]=o,t[14]=s},determinant3x3:function(t,e){var i=0===e?4:0,n=e<2?8:4,r=3===e?8:12,o=0===t?1:0,s=t<2?2:1,a=3===t?2:3,h=this._m,l=h[i|s],u=h[s|n],c=h[r|s],_=h[i|a],d=h[n|a],f=h[a|r];return h[i|o]*(u*f-c*d)-h[n|o]*(l*f-c*_)+h[r|o]*(l*d-u*_)},cofactor:function(t,e){var i=1-((t+e&1)<<1);return i*this.determinant3x3(t,e)},getCofactorMatrix:function(t,i,n){n=n||new e.Matrix4x4;for(var r=n._m,o=0;o<16;++o)r[o]=this.cofactor(3&o,o>>2);return n},getAdjugate:function(t,i,n){n=n||new e.Matrix4x4;for(var r=n._m,o=0;o<16;++o)r[o]=this.cofactor(o>>2,3&o);return n},determinant:function(){var t=this._m;return t[0]*this.determinant3x3(0,0)-t[4]*this.determinant3x3(0,1)+t[8]*this.determinant3x3(0,2)-t[12]*this.determinant3x3(0,3)},inverseOf:function(t){var e=1/t.determinant(),i=e*t.cofactor(0,0),n=e*t.cofactor(0,1),r=e*t.cofactor(0,2),o=e*t.cofactor(0,3),s=e*t.cofactor(1,0),a=e*t.cofactor(1,1),h=e*t.cofactor(1,2),l=e*t.cofactor(1,3),u=e*t.cofactor(2,0),c=e*t.cofactor(2,1),_=e*t.cofactor(2,2),d=e*t.cofactor(2,3),f=e*t.cofactor(3,0),p=e*t.cofactor(3,1),m=e*t.cofactor(3,2),g=e*t.cofactor(3,3),x=this._m;x[0]=i,x[1]=n,x[2]=r,x[3]=o,x[4]=s,x[5]=a,x[6]=h,x[7]=l,x[8]=u,x[9]=c,x[10]=_,x[11]=d,x[12]=f,x[13]=p,x[14]=m,x[15]=g},inverseAffineOf:function(t){var e=t._m,i=e[0],n=e[1],r=e[2],o=e[4],s=e[5],a=e[6],h=e[8],l=e[9],u=e[10],c=e[12],_=e[13],d=e[14],f=i*(s*u-l*a)-o*(n*u-l*r)+h*(n*a-s*r),p=1/f,m=(s*u-l*a)*p,g=(l*r-n*u)*p,x=(n*a-s*r)*p,S=(h*a-o*u)*p,v=(i*u-h*r)*p,T=(o*r-i*a)*p,E=(o*l-h*s)*p,y=(h*n-i*l)*p,M=(i*s-o*n)*p,A=this._m;A[0]=m,A[1]=g,A[2]=x,A[3]=0,A[4]=S,A[5]=v,A[6]=T,A[7]=0,A[8]=E,A[9]=y,A[10]=M,A[11]=0,A[12]=-m*c-S*_-E*d,A[13]=-g*c-v*_-y*d,A[14]=-x*c-T*_-M*d,A[15]=1},writeNormalMatrix:function(t,e){e=e||0;var i=this._m,n=i[0],r=i[1],o=i[2],s=i[4],a=i[5],h=i[6],l=i[8],u=i[9],c=i[10],_=n*(a*c-u*h)-s*(r*c-u*o)+l*(r*h-a*o),d=1/_;t[e]=(a*c-u*h)*d,t[e+1]=(l*h-s*c)*d,t[e+2]=(s*u-l*a)*d,t[e+3]=(u*o-r*c)*d,t[e+4]=(n*c-l*o)*d,t[e+5]=(l*r-n*u)*d,t[e+6]=(r*h-a*o)*d,t[e+7]=(s*o-n*h)*d,t[e+8]=(n*a-s*r)*d},writeData:function(t,e){e=e||0;for(var i=this._m,n=0;n<16;++n)t[e+n]=i[n]},writeData4x3:function(t,e){var i=this._m;e=e||0,t[e]=i[0],t[e+1]=i[4],t[e+2]=i[8],t[e+3]=i[12],t[e+4]=i[1],t[e+5]=i[5],t[e+6]=i[9],t[e+7]=i[13],t[e+8]=i[2],t[e+9]=i[6],t[e+10]=i[10],t[e+11]=i[14]},invert:function(){this.inverseOf(this)},invertAffine:function(){this.inverseAffineOf(this)},append:function(t){this.multiply(t,this)},prepend:function(t){this.multiply(this,t)},appendAffine:function(t){this.multiplyAffine(t,this)},prependAffine:function(t){this.multiplyAffine(this,t)},add:function(t){var e=this._m,i=t._m;e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[3]+=i[3],e[4]+=i[4],e[5]+=i[5],e[6]+=i[6],e[7]+=i[7],e[8]+=i[8],e[9]+=i[9],e[10]+=i[10],e[11]+=i[11],e[12]+=i[12],e[13]+=i[13],e[14]+=i[14],e[15]+=i[15]},addAffine:function(t){var e=this._m,i=t._m;e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[4]+=i[4],e[5]+=i[5],e[6]+=i[6],e[8]+=i[8],e[9]+=i[9],e[10]+=i[10]},subtract:function(t){var e=this._m,i=t._m;e[0]-=i[0],e[1]-=i[1],e[2]-=i[2],e[3]-=i[3],e[4]-=i[4],e[5]-=i[5],e[6]-=i[6],e[7]-=i[7],e[8]-=i[8],e[9]-=i[9],e[10]-=i[10],e[11]-=i[11],e[12]-=i[12],e[13]-=i[13],e[14]-=i[14],e[15]-=i[15]},subtractAffine:function(t){var e=this._m,i=t._m;e[0]-=i[0],e[1]-=i[1],e[2]-=i[2],e[4]-=i[4],e[5]-=i[5],e[6]-=i[6],e[8]-=i[8],e[9]-=i[9],e[10]-=i[10]},appendScale:function(t,e,i){void 0===e&&(e=i=t);var n=this._m;n[0]*=t,n[1]*=e,n[2]*=i,n[4]*=t,n[5]*=e,n[6]*=i,n[8]*=t,n[9]*=e,n[10]*=i,n[12]*=t,n[13]*=e,n[14]*=i},prependScale:function(t,e,i){void 0===e&&(e=i=t);var n=this._m;n[0]*=t,n[1]*=t,n[2]*=t,n[3]*=t,n[4]*=e,n[5]*=e,n[6]*=e,n[7]*=e,n[8]*=i,n[9]*=i,n[10]*=i,n[11]*=i},appendTranslation:function(t){var e=this._m;e[12]+=t.x,e[13]+=t.y,e[14]+=t.z},prependTranslation:function(t){var e=this._m,i=t.x,n=t.y,r=t.z;e[12]+=e[0]*i+e[4]*n+e[8]*r,e[13]+=e[1]*i+e[5]*n+e[9]*r,e[14]+=e[2]*i+e[6]*n+e[10]*r,e[15]+=e[3]*i+e[7]*n+e[11]*r},appendQuaternion:function(t){var e=this._m,i=t.x,n=t.y,r=t.z,o=t.w,s=1-2*(n*n+r*r),a=2*(i*n+o*r),h=2*(i*r-o*n),l=2*(i*n-o*r),u=1-2*(i*i+r*r),c=2*(n*r+o*i),_=2*(i*r+o*n),d=2*(n*r-o*i),f=1-2*(i*i+n*n),p=e[0],m=e[1],g=e[2],x=e[4],S=e[5],v=e[6],T=e[8],E=e[9],y=e[10],M=e[12],A=e[13],P=e[14];e[0]=s*p+l*m+_*g,e[1]=a*p+u*m+d*g,e[2]=h*p+c*m+f*g,e[4]=s*x+l*S+_*v,e[5]=a*x+u*S+d*v,e[6]=h*x+c*S+f*v,e[8]=s*T+l*E+_*y,e[9]=a*T+u*E+d*y,e[10]=h*T+c*E+f*y,e[12]=s*M+l*A+_*P,e[13]=a*M+u*A+d*P,e[14]=h*M+c*A+f*P},prependQuaternion:function(t){var e=this._m,i=t.x,n=t.y,r=t.z,o=t.w,s=e[0],a=e[1],h=e[2],l=e[4],u=e[5],c=e[6],_=e[8],d=e[9],f=e[10],p=1-2*(n*n+r*r),m=2*(i*n+o*r),g=2*(i*r-o*n),x=2*(i*n-o*r),S=1-2*(i*i+r*r),v=2*(n*r+o*i),T=2*(i*r+o*n),E=2*(n*r-o*i),y=1-2*(i*i+n*n);e[0]=s*p+l*m+_*g,e[1]=a*p+u*m+d*g,e[2]=h*p+c*m+f*g,e[4]=s*x+l*S+_*v,e[5]=a*x+u*S+d*v,e[6]=h*x+c*S+f*v,e[8]=s*T+l*E+_*y,e[9]=a*T+u*E+d*y,e[10]=h*T+c*E+f*y},appendRotationAxisAngle:function(t,e){var i=this._m,n=Math.cos(e),r=Math.sin(e),o=1/t.length,s=t.x*o,a=t.y*o,h=t.z*o,l=1-n,u=l*s*s+n,c=l*s*a+r*h,_=l*s*h-r*a,d=l*s*a-r*h,f=l*a*a+n,p=l*a*h+r*s,m=l*s*h+r*a,g=l*a*h-r*s,x=l*h*h+n,S=i[0],v=i[1],T=i[2],E=i[4],y=i[5],M=i[6],A=i[8],P=i[9],b=i[10],w=i[12],R=i[13],D=i[14];i[0]=u*S+d*v+m*T,i[1]=c*S+f*v+g*T,i[2]=_*S+p*v+x*T,i[4]=u*E+d*y+m*M,i[5]=c*E+f*y+g*M,i[6]=_*E+p*y+x*M,i[8]=u*A+d*P+m*b,i[9]=c*A+f*P+g*b,i[10]=_*A+p*P+x*b,i[12]=u*w+d*R+m*D,i[13]=c*w+f*R+g*D,i[14]=_*w+p*R+x*D},prependRotationAxisAngle:function(t,e){var i=this._m,n=Math.cos(e),r=Math.sin(e),o=1/t.length,s=t.x*o,a=t.y*o,h=t.z*o,l=1-n,u=i[0],c=i[1],_=i[2],d=i[4],f=i[5],p=i[6],m=i[8],g=i[9],x=i[10],S=l*s*s+n,v=l*s*a+r*h,T=l*s*h-r*a,E=l*s*a-r*h,y=l*a*a+n,M=l*a*h+r*s,A=l*s*h+r*a,P=l*a*h-r*s,b=l*h*h+n;i[0]=u*S+d*v+m*T,i[1]=c*S+f*v+g*T,i[2]=_*S+p*v+x*T,i[4]=u*E+d*y+m*M,i[5]=c*E+f*y+g*M,i[6]=_*E+p*y+x*M,i[8]=u*A+d*P+m*b,i[9]=c*A+f*P+g*b,i[10]=_*A+p*P+x*b},getRow:function(t,i){var n=this._m;return i=i||new e.Float4,i.x=n[t],i.y=n[4|t],i.z=n[8|t],i.w=n[12|t],i},setRow:function(t,e){var i=this._m;i[t]=e.x,i[4|t]=e.y,i[8|t]=e.z,i[12|t]=e.w},getElement:function(t,e){return this._m[t|e<<2]},setElement:function(t,e,i){this._m[t|e<<2]=i},getColumn:function(t,i){var n=this._m;return i=i||new e.Float4,t<<=2,i.x=n[t],i.y=n[1|t],i.z=n[2|t],i.w=n[3|t],i},setColumn:function(t,e){var i=this._m;t<<=2,i[t]=e.x,i[1|t]=e.y,i[2|t]=e.z,i[3|t]=e.w},lookAt:function(t,i,n){var r=e.Float4.subtract(i,t);r.normalize();var o=new e.Float4;if(o.cross(n,r),Math.abs(o.lengthSqr)>1e-4)o.normalize();else{var s=new e.Float4(n.x,n.z,n.y,0);o.cross(s,r),Math.abs(o.lengthSqr)<=1e-4&&(s.set(n.z,n.y,n.z,0),o.cross(s,r)),o.normalize()}var a=new e.Float4;a.cross(r,o);var h=this._m;h[0]=o.x,h[1]=o.y,h[2]=o.z,h[3]=0,h[4]=a.x,h[5]=a.y,h[6]=a.z,h[7]=0,h[8]=r.x,h[9]=r.y,h[10]=r.z,h[11]=0,h[12]=i.x,h[13]=i.y,h[14]=i.z,h[15]=1},compose:function(t){this.fromQuaternion(t.rotation);var e=t.scale;this.prependScale(e.x,e.y,e.z),this.appendTranslation(t.position)},decompose:function(t,i,n){t=t||new e.Transform;var r;void 0===i?(i=t.rotation,n=t.scale,r=t.position):r=t;var o=this._m,s=o[0],a=o[1],h=o[2],l=o[4],u=o[5],c=o[6],_=o[8],d=o[9],f=o[10],p=a*c-h*u,m=h*l-s*c,g=s*u-a*l,x=e.sign(p*_+m*d+g*f);n.x=x*Math.sqrt(s*s+a*a+h*h),n.y=x*Math.sqrt(l*l+u*u+c*c),n.z=x*Math.sqrt(_*_+d*d+f*f);var S=this.clone(),v=1/n.x,T=1/n.y,E=1/n.z,y=S._m;return y[0]*=v,y[1]*=v,y[2]*=v,y[4]*=T,y[5]*=T,y[6]*=T,y[8]*=E,y[9]*=E,y[10]*=E,i.fromMatrix(S),r.copyFrom(this.getColumn(3)),t},swapColums:function(t,e){var i=this._m;if(t!==e){t<<=2,e<<=2;var n=i[t],r=i[1|t],o=i[2|t],s=i[3|t];i[t]=i[e],i[1|t]=i[1|e],i[2|t]=i[2|e],i[3|t]=i[3|e],i[e]=n,i[1|e]=r,i[2|e]=o,i[3|e]=s}},toString:function(){for(var t=this._m,e="",i=0;i<16;++i){var n=3&i;0===n&&(e+="["),e+=t[i],e+=3===n?"]\n":"\t , \t"}return e}},e.Matrix4x4.IDENTITY=new e.Matrix4x4,e.Matrix4x4.ZERO=new e.Matrix4x4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),e.PoissonDisk=function(t,i,n,r){this._mode=void 0===t?e.PoissonDisk.CIRCULAR:t,this._initialDistance=i||1,this._decayFactor=n||.99,this._maxTests=r||2e4,this._currentDistance=0,this._points=null,this.reset()},e.PoissonDisk.SQUARE=0,e.PoissonDisk.CIRCULAR=1,e.PoissonDisk._initDefault=function(){e.PoissonDisk.DEFAULT=new e.PoissonDisk,e.PoissonDisk.DEFAULT.generatePoints(64),e.PoissonDisk.DEFAULT_FLOAT32=new Float32Array(128);for(var t=e.PoissonDisk.DEFAULT.getPoints(),i=0;i<64;++i){var n=t[i];e.PoissonDisk.DEFAULT_FLOAT32[2*i]=n.x,e.PoissonDisk.DEFAULT_FLOAT32[2*i+1]=n.y}},e.PoissonDisk.prototype={getPoints:function(){return this._points},reset:function(){this._currentDistance=this._initialDistance,this._points=[]},generatePoints:function(t){for(var e=0;e<t;++e)this.generatePoint()},generatePoint:function(){for(;;){for(var t=0,e=this._currentDistance*this._currentDistance;t++<this._maxTests;){var i=this._getCandidate();if(this._isValid(i,e))return this._points.push(i),i}this._currentDistance*=this._decayFactor}},_getCandidate:function(){for(;;){var t=2*Math.random()-1,i=2*Math.random()-1;if(this._mode===e.PoissonDisk.SQUARE||t*t+i*i<=1)return new e.Float2(t,i)}},_isValid:function(t,e){for(var i=this._points.length,n=0;n<i;++n){var r=this._points[n],o=t.x-r.x,s=t.y-r.y;if(o*o+s*s<e)return!1}return!0}},e.PoissonSphere=function(t,i,n,r){this._mode=void 0===t?e.PoissonSphere.CIRCULAR:t,this._initialDistance=i||1,this._decayFactor=n||.99,this._maxTests=r||2e4,this._currentDistance=0,this._points=null,this.reset()},e.PoissonSphere.BOX=0,e.PoissonSphere.CIRCULAR=1,e.PoissonSphere._initDefault=function(){e.PoissonSphere.DEFAULT=new e.PoissonSphere,e.PoissonSphere.DEFAULT.generatePoints(64),e.PoissonSphere.DEFAULT_FLOAT32=new Float32Array(192);for(var t=e.PoissonSphere.DEFAULT.getPoints(),i=0;i<64;++i){var n=t[i];e.PoissonSphere.DEFAULT_FLOAT32[3*i]=n.x,e.PoissonSphere.DEFAULT_FLOAT32[3*i+1]=n.y,e.PoissonSphere.DEFAULT_FLOAT32[3*i+2]=n.z}},e.PoissonSphere.prototype={getPoints:function(){return this._points},reset:function(){this._currentDistance=this._initialDistance,this._points=[]},generatePoints:function(t){for(var e=0;e<t;++e)this.generatePoint()},generatePoint:function(){for(;;){for(var t=0,e=this._currentDistance*this._currentDistance;t++<this._maxTests;){var i=this._getCandidate();if(this._isValid(i,e))return this._points.push(i),i}this._currentDistance*=this._decayFactor}},_getCandidate:function(){for(;;){var t=2*Math.random()-1,i=2*Math.random()-1,n=2*Math.random()-1;if(this._mode===e.PoissonSphere.BOX||t*t+i*i+n*n<=1)return new e.Float4(t,i,n,0)}},_isValid:function(t,e){for(var i=this._points.length,n=0;n<i;++n){var r=this._points[n],o=t.x-r.x,s=t.y-r.y,a=t.z-r.z;if(o*o+s*s+a*a<e)return!1}return!0}},e.Quaternion=function(){this.x=0,this.y=0,this.z=0,this.w=1},e.Quaternion.prototype={fromAxisAngle:function(t,e){var i=.5*e,n=Math.sin(i)/t.length;this.x=t.x*n,this.y=t.y*n,this.z=t.z*n,this.w=Math.cos(i)},fromPitchYawRoll:function(t,i,n){var r=new e.Matrix4x4;r.fromRotationPitchYawRoll(t,i,n),this.fromMatrix(r)},fromEuler:function(t,e,i){var n=Math.cos(.5*t),r=Math.cos(.5*e),o=Math.cos(.5*i),s=Math.sin(.5*t),a=Math.sin(.5*e),h=Math.sin(.5*i);this.x=s*r*o+n*a*h,this.y=n*a*o-s*r*h,this.z=n*r*h+s*a*o,this.w=n*r*o-s*a*h},toEuler:function(t){t=t||new e.Float4;var i=this.x,n=this.y,r=this.z,o=this.w,s=i*i,a=n*n,h=r*r,l=o*o;return t.x=Math.atan2(-2*(n*r-o*i),l-s-a+h),t.y=Math.asin(2*(i*r+o*n)),t.z=Math.atan2(-2*(i*n-o*r),l+s-a-h),t},fromMatrix:function(t){var e,i=t._m[0],n=t._m[5],r=t._m[10],o=i+n+r;o>0?(o+=1,e=1/Math.sqrt(o)*.5,this.x=e*(t._m[6]-t._m[9]),this.y=e*(t._m[8]-t._m[2]),this.z=e*(t._m[1]-t._m[4]),this.w=e*o):i>n&&i>r?(o=i-n-r+1,e=1/Math.sqrt(o)*.5,this.x=e*o,this.y=e*(t._m[1]+t._m[4]),this.z=e*(t._m[8]+t._m[2]),this.w=e*(t._m[6]-t._m[9])):n>r?(o=n-i-r+1,e=1/Math.sqrt(o)*.5,this.x=e*(t._m[1]+t._m[4]),this.y=e*o,this.z=e*(t._m[6]+t._m[9]),this.w=e*(t._m[8]-t._m[2])):(o=r-i-n+1,e=1/Math.sqrt(o)*.5,this.x=e*(t._m[8]+t._m[2]),this.y=e*(t._m[6]+t._m[9]),this.z=e*o,this.w=e*(t._m[1]-t._m[4])),this.normalize()},rotate:function(t,i){i=i||new e.Float4;var n=t.x,r=t.y,o=t.z,s=this.x,a=this.y,h=this.z,l=this.w,u=-s*n-a*r-h*o,c=l*n+a*o-h*r,_=l*r-s*o+h*n,d=l*o+s*r-a*n;return i.x=-u*s+c*l-_*h+d*a,i.y=-u*a+c*h+_*l-d*s,i.z=-u*h-c*a+_*s+d*l,i.w=t.w,i},lerp:function(t,e,i){var n=t.w,r=t.x,o=t.y,s=t.z,a=e.w,h=e.x,l=e.y,u=e.z;n*a+r*h+o*l+s*u<0&&(a=-a,h=-h,l=-l,u=-u),this.x=r+i*(h-r),this.y=o+i*(l-o),this.z=s+i*(u-s),this.w=n+i*(a-n),this.normalize()},slerp:function(t,e,i){var n=t.w,r=t.x,o=t.y,s=t.z,a=e.w,h=e.x,l=e.y,u=e.z,c=n*a+r*h+o*l+s*u;if(c<0&&(c=-c,a=-a,h=-h,l=-l,u=-u),c<.95){var _=Math.acos(c),d=i*_;this.x=h-r*c,this.y=l-o*c,this.z=u-s*c,this.w=a-n*c,this.normalize();var f=Math.cos(d),p=Math.sin(d);this.x=r*f+this.x*p,this.y=o*f+this.y*p,this.z=s*f+this.z*p,this.w=n*f+this.w*p}else this.x=r+i*(h-r),this.y=o+i*(l-o),this.z=s+i*(u-s),this.w=n+i*(a-n),this.normalize()},negate:function(){this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w},set:function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},copyFrom:function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},get normSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},get norm(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=t,this.y*=t,this.z*=t,this.w*=t},conjugateOf:function(t){this.x=-t.x,this.y=-t.y,this.z=-t.z,this.w=t.w},inverseOf:function(t){var e=t.x,i=t.y,n=t.z,r=t.w,o=1/(e*e+i*i+n*n+r*r);this.x=-e*o,this.y=-i*o,this.z=-n*o,this.w=r*o},invert:function(t){var e=this.x,i=this.y,n=this.z,r=this.w,o=1/(e*e+i*i+n*n+r*r);this.x=-e*o,this.y=-i*o,this.z=-n*o,this.w=r*o},multiply:function(t,e){var i=t.w,n=t.x,r=t.y,o=t.z,s=e.w,a=e.x,h=e.y,l=e.z;this.x=i*a+n*s+r*l-o*h,this.y=i*h-n*l+r*s+o*a,this.z=i*l+n*h-r*a+o*s,this.w=i*s-n*a-r*h-o*l},append:function(t){this.multiply(t,this)},prepend:function(t){this.multiply(this,t)},toString:function(){return"Quaternion("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}},e.Transform=function(){this._position=new e.Float4(0,0,0,1),this._rotation=new e.Quaternion,this._scale=new e.Float4(1,1,1,1),this._matrix=new e.Matrix4x4,this._changeListener=new e.PropertyListener,this._changeListener.add(this._position,"x"),this._changeListener.add(this._position,"y"),this._changeListener.add(this._position,"z"),this._changeListener.add(this._rotation,"x"),this._changeListener.add(this._rotation,"y"),this._changeListener.add(this._rotation,"z"),this._changeListener.add(this._rotation,"w"),this._changeListener.add(this._scale,"x"),this._changeListener.add(this._scale,"y"),this._changeListener.add(this._scale,"z"),this._changeListener.onChange.bind(this._invalidateMatrix,this)},e.Transform.prototype={get position(){return this._position},set position(t){this._position.copyFrom(t)},get rotation(){return this._rotation},set rotation(t){this._rotation.copyFrom(t)},get scale(){return this._scale},set scale(t){this._scale.copyFrom(t)},lookAt:function(t){this._matrix.lookAt(t,this._position,e.Float4.Y_AXIS),this._applyMatrix()},copyFrom:function(t){this._changeListener.enabled=!1,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scale.copyFrom(t.scale),this._changeListener.enabled=!0},get matrix(){return this._matrixInvalid&&this._updateMatrix(),this._matrix},set matrix(t){this._matrix.copyFrom(t),this._applyMatrix()},_invalidateMatrix:function(){this._matrixInvalid=!0},_updateMatrix:function(){this._matrix.compose(this),this._matrixInvalid=!1},_applyMatrix:function(){this._matrixInvalid=!1,this._changeListener.enabled=!1,this._matrix.decompose(this),this._changeListener.enabled=!0}},e.shuffle=function(t){for(var e,i,n=t.length;0!==n;)i=Math.floor(Math.random()*n),n-=1,e=t[n],t[n]=t[i],t[i]=e;return t},e.Color=function(t,e,i,n){this.set(t,e,i,n)},e.Color.prototype={set:function(t,e,i,n){void 0===t?(this.a=1,this.r=1,this.g=1,this.b=1):void 0===e?(this.a=1,this.r=((16711680&t)>>>16)/255,this.g=((65280&t)>>>8)/255,this.b=(255&t)/255):(this.r=t,this.g=e,this.b=i,this.a=void 0===n?1:n)},hex:function(){var t=255*Math.min(this.r,1),e=255*Math.min(this.g,1),i=255*Math.min(this.b,1);return t<<16|e<<8|i},luminance:function(){return.3*this.r+.59*this.g+.11*this.b},gammaToLinear:function(t){return t=t||new e.Color,e.OPTIONS.usePreciseGammaCorrection?(t.r=Math.pow(this.r,2.2),t.g=Math.pow(this.g,2.2),t.b=Math.pow(this.b,2.2)):(t.r=this.r*this.r,t.g=this.g*this.g,t.b=this.b*this.b),t.a=this.a,t},linearToGamma:function(t){return t=t||new e.Color,e.OPTIONS.usePreciseGammaCorrection?(t.r=Math.pow(this.r,.454545),t.g=Math.pow(this.g,.454545),t.b=Math.pow(this.b,.454545)):(t.r=Math.sqrt(this.r),t.g=Math.sqrt(this.g),t.b=Math.sqrt(this.b)),t.a=this.a,t},copyFrom:function(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a},toString:function(){return"Color("+this.r+", "+this.g+", "+this.b+", "+this.a+")"},clone:function(){var t=new e.Color;return t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t}},e.Color.BLACK=new e.Color(0,0,0,1),e.Color.ZERO=new e.Color(0,0,0,0),e.Color.RED=new e.Color(1,0,0,1),e.Color.GREEN=new e.Color(0,1,0,1),e.Color.BLUE=new e.Color(0,0,1,1),e.Color.YELLOW=new e.Color(1,1,0,1),e.Color.MAGENTA=new e.Color(1,0,1,1),e.Color.CYAN=new e.Color(0,1,1,1),e.Color.WHITE=new e.Color(1,1,1,1),e.DataStream=function(t){this._dataView=t,this._offset=0,this._endian=e.DataStream.LITTLE_ENDIAN},e.DataStream.LITTLE_ENDIAN=!0,e.DataStream.BIG_ENDIAN=!1,e.DataStream.prototype={get offset(){return this._offset},set offset(t){this._offset=t},get endian(){return this._endian},set endian(t){this._endian=t},get byteLength(){return this._dataView.byteLength},get bytesAvailable(){return this._dataView.byteLength-this._offset},getChar:function(){return String.fromCharCode(this.getUint8())},getUint8:function(){return this._dataView.getUint8(this._offset++)},getUint16:function(){var t=this._dataView.getUint16(this._offset,this._endian);return this._offset+=2,t},getUint32:function(){var t=this._dataView.getUint32(this._offset,this._endian);return this._offset+=4,t},getInt8:function(){return this._dataView.getInt8(this._offset++)},getInt16:function(){var t=this._dataView.getInt16(this._offset,this._endian);return this._offset+=2,t},getInt32:function(){var t=this._dataView.getInt32(this._offset,this._endian);return this._offset+=4,t},getInt64AsFloat64:function(){var t,i;return this._endian===e.DataStream.LITTLE_ENDIAN?(t=this._dataView.getUint32(this._offset,this._endian),i=this._dataView.getInt32(this._offset+4,this._endian)):(i=this._dataView.getInt32(this._offset,this._endian),t=this._dataView.getUint32(this._offset+4,this._endian)),this._offset+=8,t+4294967296*i},getFloat32:function(){var t=this._dataView.getFloat32(this._offset,this._endian);return this._offset+=4,t},getFloat64:function(){var t=this._dataView.getFloat64(this._offset,this._endian);return this._offset+=8,t},getArray:function(t){return this._readArray(t,Array,this.getUint8)},getUint8Array:function(t){return this._readArray(t,Uint8Array,this.getUint8)},getUint16Array:function(t){return this._readArray(t,Uint16Array,this.getUint16)},getUint32Array:function(t){return this._readArray(t,Uint32Array,this.getUint32)},getInt8Array:function(t){return this._readArray(t,Int8Array,this.getInt8)},getInt16Array:function(t){return this._readArray(t,Int16Array,this.getInt16)},getInt32Array:function(t){return this._readArray(t,Int32Array,this.getInt32)},getInt64AsFloat64Array:function(t){return this._readArray(t,Float64Array,this.getInt64AsFloat64)},getFloat32Array:function(t){return this._readArray(t,Float32Array,this.getFloat32)},getFloat64Array:function(t){return this._readArray(t,Float64Array,this.getFloat64)},getString:function(t){if(!t)return this._get0String();for(var e="",i=0;i<t;++i)e+=this.getChar();return e},_get0String:function(){var t="";do{var e=this.getUint8();e&&(t+=String.fromCharCode(e))}while(0!==e);return t},_readArray:function(t,e,i){for(var n=new e(t),r=0;r<t;++r)n[r]=i.call(this);return n}},e._numActiveAttributes=0,e._renderTarget=null,e._renderTargetInvalid=!0,e._viewport={x:0,y:0,width:0,height:0},e._viewportInvalid=!0,e._depthMask=!0,e._depthMaskInvalid=!0,e._cullMode=null,e._cullModeInvalid=!0,e._depthTest=null,e._depthTestInvalid=!0,e._blendState=null,e._blendStateInvalid=!1,e._stencilState=null,e._stencilStateInvalid=!1,e._glStats={numDrawCalls:0,numTriangles:0,numClears:0},e._clearGLStats=function(){e._glStats.numDrawCalls=0,e._glStats.numTriangles=0,e._glStats.numClears=0},e.clear=function(t){void 0===t&&(t=e.COMPLETE_CLEAR_MASK),e._updateRenderState(),i.clear(t),++e._glStats.numClears},e.drawElements=function(t,n,r){++e._glStats.numDrawCalls,e._glStats.numTriangles+=n/3,e._updateRenderState(),i.drawElements(t,n,i.UNSIGNED_SHORT,2*r)},e.setViewport=function(t){e._viewportInvalid=!0,t?(e._viewport.x=t.x||0,e._viewport.y=t.y||0,e._viewport.width=t.width||0,e._viewport.height=t.height||0):(e._viewport.x=0,e._viewport.y=0,e._viewport.width=e.TARGET_CANVAS.width,e._viewport.height=e.TARGET_CANVAS.height)},e.getCurrentRenderTarget=function(){return e._renderTarget},e.setRenderTarget=function(t){e._renderTarget=t,e._renderTargetInvalid=!0,e.setViewport(t)},e.enableAttributes=function(t){var n,r=e._numActiveAttributes;if(r<t)for(n=r;n<t;++n)i.enableVertexAttribArray(n);else if(r>t)for(t+=1,n=t;n<r;++n)i.disableVertexAttribArray(n);e._numActiveAttributes=t},e.setClearColor=function(t){t=isNaN(t)?t:new e.Color(t),i.clearColor(t.r,t.g,t.b,t.a)},e.setCullMode=function(t){e._cullMode!==t&&(e._cullMode=t,e._cullModeInvalid=!0)},e.setDepthMask=function(t){e._depthMask!==t&&(e._depthMask=t,e._depthMaskInvalid=!0)},e.setDepthTest=function(t){e._depthTest!==t&&(e._depthTest=t,e._depthTestInvalid=!0)},e.setBlendState=function(t){e._blendState!==t&&(e._blendState=t,e._blendStateInvalid=!0)},e.updateStencilReferenceValue=function(t){var n=e._stencilState;n&&n.reference!==t&&(n.reference=t,!e._stencilStateInvalid&&n.enabled&&i.stencilFunc(n.comparison,t,n.readMask))},e.setStencilState=function(t){e._stencilState=t,e._stencilStateInvalid=!0},e._updateRenderState=function(){if(e._renderTargetInvalid){var t=e._renderTarget;t?(i.bindFramebuffer(i.FRAMEBUFFER,t._fbo),t._numColorTextures>1&&e.EXT_DRAW_BUFFERS.drawBuffersWEBGL(t._drawBuffers)):i.bindFramebuffer(i.FRAMEBUFFER,null),
e._renderTargetInvalid=!1}if(this._viewportInvalid&&(i.viewport(e._viewport.x,e._viewport.y,e._viewport.width,e._viewport.height),e._viewportInvalid=!1),e._depthMaskInvalid&&(i.depthMask(e._depthMask),e._depthMaskInvalid=!1),e._cullModeInvalid&&(e._cullMode===e.CullMode.NONE?i.disable(i.CULL_FACE):(i.enable(i.CULL_FACE),i.cullFace(e._cullMode))),e._depthTestInvalid&&(e._depthTest===e.Comparison.DISABLED?i.disable(i.DEPTH_TEST):(i.enable(i.DEPTH_TEST),i.depthFunc(e._depthTest))),e._blendStateInvalid){var n=e._blendState;if(null===n||void 0===n||n.enabled===!1)i.disable(i.BLEND);else{i.enable(i.BLEND),i.blendFunc(n.srcFactor,n.dstFactor),i.blendEquation(n.operator);var r=n.color;r&&i.blendColor(r.r,r.g,r.b,r.a)}e._blendStateInvalid=!1}if(e._stencilStateInvalid){var o=e._stencilState;null===o||o.enabled===!1?(i.disable(i.STENCIL_TEST),i.stencilFunc(e.Comparison.ALWAYS,0,255),i.stencilOp(e.StencilOp.KEEP,e.StencilOp.KEEP,e.StencilOp.KEEP)):(i.enable(i.STENCIL_TEST),i.stencilFunc(o.comparison,o.reference,o.readMask),i.stencilOp(o.onStencilFail,o.onDepthFail,o.onPass),i.stencilMask(o.writeMask)),e._stencilStateInvalid=!1}},e.IndexBuffer=function(){this._buffer=i.createBuffer()},e.IndexBuffer.prototype={constructor:e.IndexBuffer,uploadData:function(t,e){void 0===e&&(e=i.STATIC_DRAW),this.bind(),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t,e)},dispose:function(){this._buffer&&(i.deleteBuffer(this._buffer),this._buffer=0)},bind:function(){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._buffer)}},e.PropertyListener=function(){this._enabled=!0,this.onChange=new e.Signal,this._targets=[]},e.PropertyListener.prototype={get enabled(){return this._enabled},set enabled(t){this._enabled=t},add:function(t,e){var i=this._targets.length;this._targets.push({object:t,propertyName:e,value:t[e]});var n=this,r=n._targets[i];Object.defineProperty(t,e,{get:function(){return r.value},set:function(t){t!==r.value&&(r.value=t,n._enabled&&n.onChange.dispatch())}})},remove:function(t,e){for(var i=0;i<this._targets.length;++i){var n=this._targets[i];n.object===t&&n.propertyName===e&&(delete n.object[n.propertyName],n.object[n.propertyName]=n.value,this._targets.splice(i--,1))}}},e.Rect=function(t,e,i,n){this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0},e.Signal=function(){this._listeners=[],this._lookUp={}},e.Signal.prototype={bind:function(t,e){this._lookUp[t]=this._listeners.length;var i=e?t.bind(e):t;this._listeners.push(i)},unbind:function(t){var e=this._lookUp[t];this._listeners.splice(e,1),delete this._lookUp[t]},dispatch:function(t){for(var e=this._listeners.length,i=0;i<e;++i)this._listeners[i](t)},get hasListeners(){return this._listeners.length>0}},e.VertexBuffer=function(){this._buffer=i.createBuffer()},e.VertexBuffer.prototype={constructor:e.VertexBuffer,uploadData:function(t,e){void 0===e&&(e=i.STATIC_DRAW),this.bind(),i.bufferData(i.ARRAY_BUFFER,t,e)},dispose:function(){this._buffer&&(i.deleteBuffer(this._buffer),this._buffer=0)},bind:function(){i.bindBuffer(i.ARRAY_BUFFER,this._buffer)}},e.FileUtils={extractPathAndFilename:function(t){var e=t.lastIndexOf("/"),i={};return e>=0?(i.path=t.substr(0,e+1),i.filename=t.substr(e+1)):(i.path="./",i.filename=t),i}},e.URLLoader=function(){this._params=void 0,this._data=null,this._timeout=0,this._method="GET",this._type=e.URLLoader.DATA_TEXT},e.URLLoader.ERROR_TIME_OUT=408,e.URLLoader.METHOD_GET="get",e.URLLoader.METHOD_POST="post",e.URLLoader.DATA_TEXT=0,e.URLLoader.DATA_BINARY=1,e.URLLoader.prototype={get type(){return this._type},set type(t){this._type=t},get method(){return this._method},set method(t){this._method=t},get timeoutDuration(){return this._timeout},set timeoutDuration(t){this._timeout=t},get parameters(){return this._params},set parameters(t){this._params=t},get data(){return this._data},load:function(t){var i=new XMLHttpRequest;i.open(this._method,t,!0),this._timeout&&(i.timeout=this._timeout),this._type===e.URLLoader.DATA_BINARY?i.responseType="arraybuffer":i.overrideMimeType("application/json");var n=this;i.ontimeout=function(){n.onError(e.URLLoader.ERROR_TIME_OUT)},i.onreadystatechange=function(){var t=this.DONE||4;this.readyState===t&&(200===this.status?(this._data=n._type===e.URLLoader.DATA_TEXT?i.responseText:new DataView(i.response),n.onComplete&&n.onComplete(this._data)):n.onError&&n.onError(this.status))},i.send(this._params)},onComplete:function(t){},onError:function(t){}},e.BulkURLLoader=function(){this._params=void 0,this._timeout=5e3,this._method="GET",this._type=e.URLLoader.DATA_TEXT,this._abortOnFail=!1,this._files=null,this._index=0,this._data=null},e.BulkURLLoader.prototype={getData:function(t){return this._data[t]},get type(){return this._type},set type(t){this._type=t},get abortOnFail(){return this._abortOnFail},set abortOnFail(t){this._abortOnFail=t},get method(){return this._method},set method(t){this._method=t},get timeoutDuration(){return this._timeout},set timeoutDuration(t){this._timeout=t},get parameters(){return this._params},set parameters(t){this._params=t},load:function(t){this._files=t,this._data={},this._index=0,this._loadQueued()},_loadQueued:function(){if(this._index===this._files.length)return void this.onComplete();var t=new e.URLLoader;t.parameters=this._params,t.timeoutDuration=this._timeout,t.method=this._method,t.type=this._type;var i=this;t.onComplete=function(t){var e=i._files[i._index];i._data[e]=t,++i._index,i._loadQueued()},t.onFail=function(){i.onFail(),i._abortOnFail||t.onComplete(null)},t.load(this._files[this._index])},onComplete:function(t){},onError:function(t){}},e.Shader=function(t,e){this._ready=!1,this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uniformSetters=null,t&&e&&this.init(t,e)},e.Shader.ID_COUNTER=0,e.Shader.prototype={constructor:e.Shader,isReady:function(){return this._ready},init:function(t,n){if(t=e.GLSLIncludeGeneral+t,n=e.GLSLIncludeGeneral+n,t=this._processShaderCode(t),n=this._processShaderCode(n),this._vertexShader=i.createShader(i.VERTEX_SHADER),!this._initShader(this._vertexShader,t)){if(this.dispose(),e.OPTIONS.throwOnShaderError)throw new Error("Failed generating vertex shader: \n"+t);return void console.warn("Failed generating vertex shader")}if(this._fragmentShader=i.createShader(i.FRAGMENT_SHADER),!this._initShader(this._fragmentShader,n)){if(this.dispose(),e.OPTIONS.throwOnShaderError)throw new Error("Failed generating fragment shader: \n"+n);return void console.warn("Failed generating fragment shader:")}if(this._program=i.createProgram(),i.attachShader(this._program,this._vertexShader),i.attachShader(this._program,this._fragmentShader),i.linkProgram(this._program),!i.getProgramParameter(this._program,i.LINK_STATUS)){var r=i.getProgramInfoLog(this._program);if(this.dispose(),console.log("**********"),e.Debug.printShaderCode(t),console.log("**********"),e.Debug.printShaderCode(n),e.OPTIONS.throwOnShaderError)throw new Error("Error in program linking:"+r);return void console.warn("Error in program linking:"+r)}this._ready=!0,this._uniformSetters=e.UniformSetter.getSetters(this)},updateRenderState:function(t,e){i.useProgram(this._program);for(var n=this._uniformSetters.length,r=0;r<n;++r)this._uniformSetters[r].execute(t,e)},_initShader:function(t,n){return i.shaderSource(t,n),i.compileShader(t),!!i.getShaderParameter(t,i.COMPILE_STATUS)||(console.warn(i.getShaderInfoLog(t)),e.Debug.printShaderCode(n),!1)},dispose:function(){i.deleteShader(this._vertexShader),i.deleteShader(this._fragmentShader),i.deleteProgram(this._program),this._ready=!1},getProgram:function(){return this._program},getUniformLocation:function(t){return i.getUniformLocation(this._program,t)},getAttributeLocation:function(t){return i.getAttribLocation(this._program,t)},_processShaderCode:function(t){return t=this._processExtensions(t,/^\s*#derivatives\s*$/gm,"GL_OES_standard_derivatives"),t=this._processExtensions(t,/^\s*#texturelod\s*$/gm,"GL_EXT_shader_texture_lod"),t=this._guard(t,/^uniform\s+\w+\s+hx_\w+\s*;/gm),t=this._guard(t,/^attribute\s+\w+\s+hx_\w+\s*;/gm)},_processExtensions:function(t,e,i){var n=t.search(e);return n<0?t:t="#extension "+i+" : enable\n"+t.replace(e,"")},_guard:function(t,e){for(var i=t.match(e)||[],n={},r=0;r<i.length;++r){var o=i[r];if(!n[o]){var s=o.indexOf("hx_"),a=o.indexOf(";"),h=o.substring(s,a);h=h.trim(),n[o]=!0;var l=h.toUpperCase(),u="#ifndef "+l+"\n#define "+l+"\n"+o+"\n#endif\n",c=new RegExp(o,"g");t=t.replace(c,u)}}return t}},e.MaterialPass=function(t){this._shader=t,this._textureSlots=[],this._uniforms={},this._elementType=e.ElementType.TRIANGLES,this._cullMode=e.CullMode.BACK,this._depthTest=e.Comparison.LESS_EQUAL,this._writeDepth=!0,this._blendState=null,this._storeUniforms(),this._textureSettersPass=e.TextureSetter.getSettersPerPass(this),this._textureSettersInstance=e.TextureSetter.getSettersPerInstance(this),this._useSkinning=!1},e.MaterialPass.BASE_PASS=0,e.MaterialPass.NORMAL_DEPTH_PASS=1,e.MaterialPass.DIR_LIGHT_PASS=2,e.MaterialPass.DIR_LIGHT_SHADOW_PASS=-1,e.MaterialPass.POINT_LIGHT_PASS=-1,e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS=-1,e.MaterialPass.NUM_PASS_TYPES=-1,e.MaterialPass.prototype={constructor:e.MaterialPass,getShader:function(){return this._shader},get elementType(){return this._elementType},set elementType(t){this._elementType=t},get depthTest(){return this._depthTest},set depthTest(t){this._depthTest=t},set writeDepth(t){this._writeDepth=t},get cullMode(){return this._cullMode},set cullMode(t){this._cullMode=t},get blendState(){return this._blendState},set blendState(t){this._blendState=t},updateInstanceRenderState:function(t,e){for(var i=this._textureSettersInstance.length,n=0;n<i;++n)this._textureSettersInstance[n].execute(e);this._shader.updateRenderState(t,e)},updatePassRenderState:function(t){var i,n=this._textureSettersPass.length;for(i=0;i<n;++i)this._textureSettersPass[i].execute(t);for(n=this._textureSlots.length,i=0;i<n;++i){var r=this._textureSlots[i],o=r.texture;o?o.isReady()?o.bind(i):o._default.bind(i):e.Texture2D.DEFAULT.bind(i)}e.setCullMode(this._cullMode),e.setDepthTest(this._depthTest),e.setDepthMask(this._writeDepth),e.setBlendState(this._blendState)},_storeUniforms:function(){for(var t=i.getProgramParameter(this._shader._program,i.ACTIVE_UNIFORMS),e=0;e<t;++e){var n=i.getActiveUniform(this._shader._program,e),r=n.name,o=i.getUniformLocation(this._shader._program,r);this._uniforms[r]={type:n.type,location:o,size:n.size}}},getTextureSlot:function(t){if(!this._uniforms.hasOwnProperty(t))return null;i.useProgram(this._shader._program);var n=this._uniforms[t];if(n){for(var r=n.location,o=null,s=this._textureSlots.length,a=0;a<s;++a)if(this._textureSlots[a].location===r){o=this._textureSlots[a];break}if(!o){for(var h=new Int32Array(n.size),l=0;l<n.size;++l)o=new e.TextureSlot,o.index=a,o.name=t,this._textureSlots.push(o),o.location=r,h[l]=a+l;1===n.size?i.uniform1i(r,a):i.uniform1iv(r,h)}return o}},setTexture:function(t,e){var i=this.getTextureSlot(t);i&&(i.texture=e)},setTextureArray:function(t,e){var i=this.getTextureSlot(t+"[0]"),n=i.location;if(i)for(var r=e.length,o=0;o<r;++o){var s=this._textureSlots[i.index+o];if(!s||s.location!==n)return;s.texture=e[o]}},getUniformLocation:function(t){if(this._uniforms.hasOwnProperty(t))return this._uniforms[t].location},getAttributeLocation:function(t){return this._shader.getAttributeLocation(t)},setUniformStructArray:function(t,e){for(var i=e.length,n=0;n<i;++n){var r=e[n];for(var o in r)r.hasOwnProperty("key")&&this.setUniform(t+"["+n+"]."+o,e)}},setUniformArray:function(t,e){if(t+="[0]",this._uniforms.hasOwnProperty(t)){var n=this._uniforms[t];switch(i.useProgram(this._shader._program),n.type){case i.FLOAT:i.uniform1fv(n.location,e);break;case i.FLOAT_VEC2:i.uniform2fv(n.location,e);break;case i.FLOAT_VEC3:i.uniform3fv(n.location,e);break;case i.FLOAT_VEC4:i.uniform4fv(n.location,e);break;case i.FLOAT_MAT4:i.uniformMatrix4fv(n.location,!1,e);break;case i.INT:i.uniform1iv(n.location,e);break;case i.INT_VEC2:i.uniform2iv(n.location,e);break;case i.INT_VEC3:i.uniform3iv(n.location,e);break;case i.INT_VEC4:i.uniform1iv(n.location,e);break;case i.BOOL:i.uniform1bv(n.location,e);break;case i.BOOL_VEC2:i.uniform2bv(n.location,e);break;case i.BOOL_VEC3:i.uniform3bv(n.location,e);break;case i.BOOL_VEC4:i.uniform4bv(n.location,e);break;default:throw new Error("Unsupported uniform format for setting ("+n.type+") for uniform '"+t+"'. May be a todo.")}}},setUniform:function(t,e){if(this._uniforms.hasOwnProperty(t)){var n=this._uniforms[t];switch(i.useProgram(this._shader._program),n.type){case i.FLOAT:i.uniform1f(n.location,e);break;case i.FLOAT_VEC2:i.uniform2f(n.location,e.x||e[0]||0,e.y||e[1]||0);break;case i.FLOAT_VEC3:i.uniform3f(n.location,e.x||e.r||e[0]||0,e.y||e.g||e[1]||0,e.z||e.b||e[2]||0);break;case i.FLOAT_VEC4:i.uniform4f(n.location,e.x||e.r||e[0]||0,e.y||e.g||e[1]||0,e.z||e.b||e[2]||0,e.w||e.a||e[3]||0);break;case i.INT:i.uniform1i(n.location,e);break;case i.INT_VEC2:i.uniform2i(n.location,e.x||e[0],e.y||e[1]);break;case i.INT_VEC3:i.uniform3i(n.location,e.x||e[0],e.y||e[1],e.z||e[2]);break;case i.INT_VEC4:i.uniform1i(n.location,e.x||e[0],e.y||e[1],e.z||e[2],e.w||e[3]);break;case i.BOOL:i.uniform1i(n.location,e);break;case i.BOOL_VEC2:i.uniform2i(n.location,e.x||e[0],e.y||e[1]);break;case i.BOOL_VEC3:i.uniform3i(n.location,e.x||e[0],e.y||e[1],e.z||e[2]);break;case i.BOOL_VEC4:i.uniform4i(n.location,e.x||e[0],e.y||e[1],e.z||e[2],e.w||e[3]);break;case i.FLOAT_MAT4:i.uniformMatrix4fv(n.location,!1,e._m);break;default:throw new Error("Unsupported uniform format for setting. May be a todo.")}}}},e.Material=function(t,i,n){this._elementType=e.ElementType.TRIANGLES,this._cullMode=e.CullMode.BACK,this._writeDepth=!0,this._passes=new Array(e.Material.NUM_PASS_TYPES),this._renderOrderHint=++e.Material.ID_COUNTER,this._renderOrder=0,this.onChange=new e.Signal,this._textures={},this._uniforms={},this._useMorphing=!1,this._useSkinning=!1,this._lights=null,this._name=null,this._ssao=!1,this._geometryVertexShader=t,this._geometryFragmentShader=i,this._lightingModel=n||e.OPTIONS.defaultLightingModel,this._initialized=!1,this._blendState=null,this._needsNormalDepth=!1,this._needsBackbuffer=!1},e.Material.ID_COUNTER=0,e.Material.prototype={init:function(){!this._initialized&&this._geometryVertexShader&&this._geometryFragmentShader&&(this._needsNormalDepth=!1,this._needsBackbuffer=!1,this._dirLights=null,this._dirLightCasters=null,this._pointLights=null,this._lightingModel?this._lights&&this.setPass(e.MaterialPass.BASE_PASS,new e.StaticLitPass(this._geometryVertexShader,this._geometryFragmentShader,this._lightingModel,this._lights,this._ssao)):this.setPass(e.MaterialPass.BASE_PASS,new e.UnlitPass(this._geometryVertexShader,this._geometryFragmentShader)),this.setPass(e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS,new e.DirectionalShadowPass(this._geometryVertexShader,this._geometryFragmentShader)),!this._needsNormalDepth&&this._writeDepth&&this.setPass(e.MaterialPass.NORMAL_DEPTH_PASS,new e.NormalDepthPass(this._geometryVertexShader,this._geometryFragmentShader)),this._initialized=!0)},get initialized(){return this._initialized},get ssao(){return this._ssao},set ssao(t){this._ssao!==t&&(this._ssao=t,this._invalidate())},get blendState(){return this._blendState},set blendState(t){this._blendState=t;for(var i=0;i<e.MaterialPass.NUM_PASS_TYPES;++i)i!==e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS&&i!==e.MaterialPass.NORMAL_DEPTH_PASS&&this._passes[i]&&(this._passes[i].blendState=t)},get name(){return this._name},set name(t){this._name=t},get lights(){return this._lights},set lights(t){this._lights=t,!this._lightingModel&&t&&(this._lightingModel=e.LightingModel.GGX),this._invalidate()},get lightingModel(){return this._lightingModel},set lightingModel(t){this._lightingModel=t,this._invalidate()},get renderOrder(){return this._renderOrder},set renderOrder(t){this._renderOrder=t},get elementType(){return this._elementType},set elementType(t){this._elementType=t;for(var i=0;i<e.MaterialPass.NUM_PASS_TYPES;++i)this._passes[i]&&(this._passes[i].elementType=t)},get writeDepth(){return this._writeDepth},set writeDepth(t){this._writeDepth=t,!t&&this._passes[e.MaterialPass.NORMAL_DEPTH_PASS]?this._passes[e.MaterialPass.NORMAL_DEPTH_PASS]=null:t&&!this._passes[e.MaterialPass.NORMAL_DEPTH_PASS]&&this._invalidate();for(var i=0;i<e.MaterialPass.NUM_PASS_TYPES;++i)this._passes[i]&&(this._passes[i].writeDepth=t)},get cullMode(){return this._cullMode},set cullMode(t){this._cullMode=t;for(var i=0;i<e.MaterialPass.NUM_PASS_TYPES;++i)i!==e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS&&this._passes[i]&&(this._passes[i].cullMode=t)},getPass:function(t){return this._initialized||this.init(),this._passes[t]},setPass:function(t,i){if(this._passes[t]=i,i){t===e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS?i.cullMode=e.DirectionalLight.SHADOW_FILTER.getCullMode():i.cullMode=this._cullMode,i.elementType=this._elementType,i.writeDepth=this._writeDepth,t!==e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS&&t!==e.MaterialPass.NORMAL_DEPTH_PASS&&(i.blendState=this._blendState),i.getTextureSlot("hx_normalDepth")&&(this._needsNormalDepth=!0),i.getTextureSlot("hx_backbuffer")&&(this._needsBackbuffer=!0);for(var n in this._textures)if(this._textures.hasOwnProperty(n)){var r=this._textures[n];r instanceof Array?i.setTextureArray(n,r):i.setTexture(n,r)}for(var o in this._uniforms)this._uniforms.hasOwnProperty(o)&&("]"===o.charAt(o.length-1)?i.setUniformArray(o.substr(0,o.length-3),this._uniforms[o]):i.setUniform(o,this._uniforms[o]))}this.onChange.dispatch()},hasPass:function(t){return this._initialized||this.init(),!!this._passes[t]},setTexture:function(t,i){i?this._textures[t]=i:delete this._textures[t];for(var n=0;n<e.MaterialPass.NUM_PASS_TYPES;++n)this.hasPass(n)&&this._passes[n].setTexture(t,i)},setTextureArray:function(t,i){i?this._textures[t]=i:delete this._textures[t];for(var n=0;n<e.MaterialPass.NUM_PASS_TYPES;++n)this.hasPass(n)&&this._passes[n].setTextureArray(t,i)},setUniform:function(t,i,n){if(void 0===n&&(n=!0),n||!this._uniforms.hasOwnProperty(t)){this._uniforms[t]=i;for(var r=0;r<e.MaterialPass.NUM_PASS_TYPES;++r)this._passes[r]&&this._passes[r].setUniform(t,i)}},setUniformArray:function(t,i,n){if(void 0===n&&(n=!0),n||!this._uniforms.hasOwnProperty(t+"[0]")){this._uniforms[t+"[0]"]=i;for(var r=0;r<e.MaterialPass.NUM_PASS_TYPES;++r)this._passes[r]&&this._passes[r].setUniformArray(t,i)}},_setUseSkinning:function(t){this._useSkinning=t},_setUseMorphing:function(t){this._useMorphing=t},_invalidate:function(){this._initialized=!1,this._passes=new Array(e.Material.NUM_PASS_TYPES),this.onChange.dispatch()},_setSSAOTexture:function(t){this._lights&&this._lightingModel&&this.getPass(e.MaterialPass.BASE_PASS)._setSSAOTexture(t)},toString:function(){return"[Material(name="+this._name+")]"}},e.AssetLoader=function(t){this.onComplete=new e.Signal,this.onFail=new e.Signal,this.fileMap={},this.options={},this._importerType=t},e.AssetLoader.prototype={load:function(t,i){function n(i){console.warn("Failed loading "+t+". Error code: "+i),this.onFail&&(this.onFail instanceof e.Signal?this.onFail.dispatch(i):this.onFail(i))}var r=new this._importerType;i=i||r.createContainer(),r.onComplete=this.onComplete,r.onFail=this.onFail,r.fileMap=this.fileMap,r.options=this.options;var o=e.FileUtils.extractPathAndFilename(t);if(r.path=o.path,r.filename=o.filename,r.dataType===e.Importer.TYPE_IMAGE){var s=new Image;s.onload=function(){r.parse(s,i)},s.onError=function(){console.warn("Failed loading texture '"+t+"'"),n.call(this)},s.src=t}else{var a=new e.URLLoader;a.type=r.dataType,a.onComplete=function(t){r.parse(t,i)},a.onError=function(t){n(t)},a.load(t)}return i}},e.Importer=function(t,i){this._dataType=void 0===i?e.URLLoader.DATA_TEXT:i,this._containerType=t,this.onComplete=null,this.onFail=null,this.fileMap=null,this.options={},this.path="",this.filename=""},e.Importer.prototype={get dataType(){return this._dataType},createContainer:function(){return new this._containerType},parse:function(t,e){},_notifyComplete:function(t){this.onComplete&&(this.onComplete instanceof e.Signal?this.onComplete.dispatch(t):this.onComplete(t))},_notifyFailure:function(t){this.onFail instanceof e.Signal?(this.onFail.hasListeners||console.error(t),this.onFail.dispatch(t)):this.onFail(t)},_correctURL:function(t){return this.path+(this.fileMap.hasOwnProperty(t)?this.fileMap[t]:t).replace("\\","/")}},e.Importer.TYPE_TEXT=e.URLLoader.DATA_TEXT,e.Importer.TYPE_BINARY=e.URLLoader.DATA_BINARY,e.Importer.TYPE_IMAGE=2,e.SceneNode=function(){e.Transform.call(this),this._name=null,this._worldMatrix=new e.Matrix4x4,this._worldBoundsInvalid=!0,this._matrixInvalid=!0,this._worldMatrixInvalid=!0,this._parent=null,this._scene=null,this._worldBounds=this._createBoundingVolume(),this._debugBounds=null,this._visible=!0,this._children=[],this._renderOrderHint=0},e.SceneNode.prototype=Object.create(e.Transform.prototype),Object.defineProperties(e.SceneNode.prototype,{name:{get:function(){return this._name},set:function(t){this._name=t}},numChildren:{get:function(){return this._children.length}},visible:{get:function(){return this._visible},set:function(t){this._visible=t}},worldBounds:{get:function(){return this._worldBoundsInvalid&&(this._updateWorldBounds(),this._worldBoundsInvalid=!1),this._worldBounds}},worldMatrix:{get:function(){return this._worldMatrixInvalid&&this._updateWorldMatrix(),this._worldMatrix}},showDebugBounds:{get:function(){return null!==this._debugBounds},set:function(t){!!this._debugBounds!==t&&(t?(this._debugBounds=this._worldBounds.getDebugModelInstance(),this._updateDebugBounds()):this._debugBounds=null)}}}),e.SceneNode.prototype.attach=function(t){if(t instanceof Array)for(var e=t.length,i=0;i<e;++i)this.attach(t[i]);else{if(t._parent)throw new Error("Child is already parented!");t._parent=this,t._setScene(this._scene),this._children.push(t),this._invalidateWorldBounds()}},e.SceneNode.prototype.detach=function(t){var e=this._children.indexOf(t);if(e<0)throw new Error("Trying to remove a scene object that is not a child");t._parent=null,this._children.splice(e,1),this._invalidateWorldBounds()},e.SceneNode.prototype.getChild=function(t){return this._children[t]},e.SceneNode.prototype._applyMatrix=function(){e.Transform.prototype._applyMatrix.call(this),this._invalidateWorldMatrix()},e.SceneNode.prototype.findMaterialByName=function(t){var i=new e.MaterialQueryVisitor(t);return this.acceptVisitor(i),i.foundMaterial},e.SceneNode.prototype.findNodeByName=function(t){if(this._name===t)return this;for(var e=this._children.length,i=0;i<e;++i){var n=this._children[i].findNodeByName(t);if(n)return n}},e.SceneNode.prototype._setScene=function(t){this._scene=t;for(var e=this._children.length,i=0;i<e;++i)this._children[i]._setScene(t)},e.SceneNode.prototype.acceptVisitor=function(t){this._debugBounds&&this._debugBounds.acceptVisitor(t);for(var e=this._children.length,i=0;i<e;++i){var n=this._children[i];t.qualifies(n)&&n.acceptVisitor(t)}},e.SceneNode.prototype._invalidateMatrix=function(){e.Transform.prototype._invalidateMatrix.call(this),this._invalidateWorldMatrix()},e.SceneNode.prototype._invalidateWorldMatrix=function(){this._worldMatrixInvalid=!0,this._invalidateWorldBounds();for(var t=this._children.length,e=0;e<t;++e)this._children[e]._invalidateWorldMatrix()},e.SceneNode.prototype._invalidateWorldBounds=function(){this._worldBoundsInvalid||(this._worldBoundsInvalid=!0,this._parent&&this._parent._invalidateWorldBounds())},e.SceneNode.prototype._updateWorldBounds=function(){for(var t=this._children.length,e=0;e<t;++e)this._worldBounds.growToIncludeBound(this._children[e].worldBounds);this._debugBounds&&this._updateDebugBounds()},e.SceneNode.prototype._updateDebugBounds=function(){var t=this._debugBounds.matrix,e=this._worldBounds;t.fromScale(2*e._halfExtentX,2*e._halfExtentY,2*e._halfExtentZ),t.appendTranslation(e._center),this._debugBounds.matrix=t},e.SceneNode.prototype._updateMatrix=function(){e.Transform.prototype._updateMatrix.call(this),this._invalidateWorldBounds()},e.SceneNode.prototype._updateWorldMatrix=function(){this._parent?this._worldMatrix.multiply(this._parent.worldMatrix,this.matrix):this._worldMatrix.copyFrom(this.matrix),this._worldMatrixInvalid=!1},e.SceneNode.prototype._createBoundingVolume=function(){return new e.BoundingAABB},e.SceneNode.prototype.toString=function(){return"[SceneNode(name="+this._name+")]"},e.SceneNode.prototype.applyFunction=function(t){t(this);for(var e=this._children.length,i=0;i<e;++i)this._children[i].applyFunction(t)},e.Component=function(){this._entity=null},e.Component.prototype={onAdded:function(){},onRemoved:function(){},onUpdate:null,get entity(){return this._entity}},e.CompositeComponent=function(){e.Component.call(this),this._subs=[]},e.CompositeComponent.prototype=Object.create(e.Component.prototype),e.CompositeComponent.prototype.addComponent=function(t){if(t._entity)throw new Error("Component already added to an entity!");this._subs.push(t)},e.CompositeComponent.prototype.removeComponent=function(t){var e=this._subs.indexOf(t);e>=0&&this._subs.splice(e,1)},e.CompositeComponent.prototype.onAdded=function(){for(var t=0;t<this._subs.length;++t){var e=this._subs[t];e._entity=this._entity,e.onAdded()}},e.CompositeComponent.prototype.onRemoved=function(){for(var t=0;t<this._subs.length;++t){var e=this._subs[t];e.onRemoved(),e._entity=null}},e.CompositeComponent.prototype.onUpdate=function(t){for(var e=this._subs.length,i=0;i<e;++i){var n=this._subs[i];n.onUpdate(t)}},e.Entity=function(){e.SceneNode.call(this),this._components=null,this._requiresUpdates=!1,this._onRequireUpdatesChange=new e.Signal,this._effects=null},e.Entity.create=function(t){var i=new e.Entity;if(t)for(var n=t.length,r=0;r<n;++r)i.addComponent(t[r]);return i},e.Entity.prototype=Object.create(e.SceneNode.prototype),e.Entity.prototype.addComponents=function(t){for(var e=0;e<t.length;++e)this.addComponent(t[e])},e.Entity.prototype.removeComponents=function(t){for(var e=0;e<t.length;++e)this.removeComponent(t[e])},e.Entity.prototype.hasComponentType=function(t){if(!this._components)return!1;for(var e=0;e<this._components.length;++e)if(this._components[e]instanceof t)return!0},e.Entity.prototype.getComponentsByType=function(t){var e=[];if(!this._components)return e;for(var i=0;i<this._components.length;++i){var n=this._components[i];n instanceof t&&e.push(n)}return e},e.Entity.prototype.addComponent=function(t){if(t._entity)throw new Error("Component already added to an entity!");this._components=this._components||[],this._components.push(t),this._updateRequiresUpdates(this._requiresUpdates||!!t.onUpdate),t._entity=this,t.onAdded()},e.Entity.prototype._updateRequiresUpdates=function(t){t!==this._requiresUpdates&&(this._requiresUpdates=t,this._onRequireUpdatesChange.dispatch(this))},e.Entity.prototype.removeComponent=function(t){t.onRemoved();for(var e=!1,i=this._components.length,n=0,r=[],o=0;o<i;++o){var s=this._components[o];s!==t&&(r[n++]=s,e=e||!!t.onUpdate)}this._components=0===n?null:r,t._entity=null,this._updateRequiresUpdates(e)},e.Entity.prototype.acceptVisitor=function(t){e.SceneNode.prototype.acceptVisitor.call(this,t),this._effects&&t.visitEffects(this._effects,this)},e.Entity.prototype.update=function(t){var e=this._components;if(e)for(var i=e.length,n=0;n<i;++n){var r=e[n];r.onUpdate&&r.onUpdate(t)}},e.Entity.prototype._registerEffect=function(t){this._effects=this._effects||[],this._effects.push(t)},e.Entity.prototype._unregisterEffect=function(t){var e=this._effects.indexOf(t);this._effects.splice(e,1),0===this._effects.length&&(this._effects=null)},e.Entity.prototype._setScene=function(t){this._scene&&this._scene.entityEngine.unregisterEntity(this),t&&t.entityEngine.registerEntity(this),e.SceneNode.prototype._setScene.call(this,t)},e.EntityEngine=function(){this._updateableEntities=[],e.onPreFrame.bind(this._update,this)},e.EntityEngine.prototype={registerEntity:function(t){t._onRequireUpdatesChange.bind(this._onEntityUpdateChange,this),t._requiresUpdates&&this._addUpdatableEntity(t)},unregisterEntity:function(t){t._onRequireUpdatesChange.unbind(this),t._requiresUpdates&&this._removeUpdatableEntity(t)},_onEntityUpdateChange:function(t){t._requiresUpdates?this._addUpdatableEntity(t):this._removeUpdatableEntity(t)},_addUpdatableEntity:function(t){this._updateableEntities.push(t)},_removeUpdatableEntity:function(t){var e=this._updateableEntities.indexOf(t);this._updateableEntities.splice(e,1)},_update:function(t){for(var e=this._updateableEntities,i=e.length,n=0;n<i;++n)e[n].update(t)}},e.EffectPass=function(t,i){t=t||e.ShaderLibrary.get("default_post_vertex.glsl");var n=new e.Shader(t,i);e.MaterialPass.call(this,n),this._vertexLayout=null,this._cullMode=e.CullMode.NONE,this._depthTest=e.Comparison.DISABLED,this._writeDepth=!1,this.setMesh(e.RectMesh.DEFAULT),this.setTexture("hx_dither2D",e.DEFAULT_2D_DITHER_TEXTURE)},e.EffectPass.prototype=Object.create(e.MaterialPass.prototype),e.EffectPass.prototype.setMesh=function(t){this._mesh!==t&&(this._mesh=t,this._vertexLayout=new e.VertexLayout(this._mesh,this))},e.EffectPass.prototype.updateRenderState=function(t){this.updateInstanceRenderState(t._camera),this.updatePassRenderState(t),this._mesh._vertexBuffers[0].bind(),this._mesh._indexBuffer.bind();for(var n=this._vertexLayout,r=n.attributes,o=r.length,s=0;s<o;++s){var a=r[s];i.vertexAttribPointer(a.index,a.numComponents,i.FLOAT,!1,a.stride,a.offset)}e.enableAttributes(n._numAttributes)},e.Effect=function(){e.Component.call(this),this._isSupported=!0,this._mesh=null,this._outputsGamma=!1,this._needsNormalDepth=!1},e.Effect.prototype=Object.create(e.Component.prototype,{needsNormalDepth:{get:function(){return this._needsNormalDepth},set:function(t){this._needsNormalDepth=t}},hdrTarget:{get:function(){return this._renderer._hdrFront.fbo}},hdrSource:{get:function(){return this._renderer._hdrBack.texture}}}),e.Effect.prototype.isSupported=function(){return this._isSupported},e.Effect.prototype.render=function(t,e){this._renderer=t,this.draw(e)},e.Effect.prototype.draw=function(t){throw new Error("Abstract method error!")},e.Effect.prototype._drawPass=function(t){t.updateRenderState(this._renderer),e.drawElements(i.TRIANGLES,6,0)},e.Effect.prototype.onAdded=function(){this._entity._registerEffect(this)},e.Effect.prototype.onRemoved=function(){this._entity._unregisterEffect(this)},e.Effect.prototype._swapHDRFrontAndBack=function(){this._renderer._swapHDRFrontAndBack()},e.Light=function(){e.Entity.call(this),this._intensity=3.1415,this._color=new e.Color(1,1,1),this._scaledIrradiance=new e.Color,this._castShadows=!1,this._updateScaledIrradiance()},e.Light.prototype=Object.create(e.Entity.prototype),e.Light.prototype.acceptVisitor=function(t){e.Entity.prototype.acceptVisitor.call(this,t),t.visitLight(this)},Object.defineProperties(e.Light.prototype,{intensity:{get:function(){return this._intensity},set:function(t){this._intensity=t,this._updateScaledIrradiance()}},color:{get:function(){return this._color},set:function(t){this._color=isNaN(t)?t:new e.Color(t),this._updateScaledIrradiance()}}}),e.Light.prototype.renderBatch=function(t,e,i){throw new Error("Abstract method!")},e.Light.prototype.luminance=function(){return this._color.luminance()*this._intensity},e.Light.prototype._updateScaledIrradiance=function(){var t=this._intensity/Math.PI;e.OPTIONS.useGammaCorrection?this._color.gammaToLinear(this._scaledIrradiance):this._scaledIrradiance.copyFrom(this._color),this._scaledIrradiance.r*=t,this._scaledIrradiance.g*=t,this._scaledIrradiance.b*=t,this._invalidateWorldBounds()},e.ShadowFilter=function(){this._blurShader=null,this._numBlurPasses=1,this.onShaderInvalid=new e.Signal},e.ShadowFilter.prototype={getShadowMapFormat:function(){return i.RGBA},getShadowMapDataType:function(){return i.UNSIGNED_BYTE},getGLSL:function(){throw new Error("Abstract method called")},getCullMode:function(){return e.CullMode.BACK},get blurShader(){return this._blurShader||(this._blurShader=this._createBlurShader()),
this._blurShader},get numBlurPasses(){return this._numBlurPasses},set numBlurPasses(t){this._numBlurPasses=t},init:function(){},_createBlurShader:function(){},_invalidateBlurShader:function(){this._blurShader&&(this._blurShader.dispose(),this._blurShader=null)}},e.RenderItem=function(){this.worldMatrix=null,this.meshInstance=null,this.skeleton=null,this.skeletonMatrices=null,this.material=null,this.camera=null,this.renderOrderHint=0,this.next=null},e.RenderItemPool=function(){var t=null,i=null;this.getItem=function(){var n;return t?(n=t,t=t.next):(n=new e.RenderItemPool,n.next=i,i=n),n},this.reset=function(){t=i}},e.SceneVisitor=function(){},e.SceneVisitor.prototype={collect:function(t,e){},qualifies:function(t){},visitLight:function(t){},visitAmbientLight:function(t){},visitModelInstance:function(t,e){},visitScene:function(t){},visitEffects:function(t,e){}},e.BoundingVolume=function(t){this._type=t,this._expanse=e.BoundingVolume.EXPANSE_EMPTY,this._minimumX=0,this._minimumY=0,this._minimumZ=0,this._maximumX=0,this._maximumY=0,this._maximumZ=0,this._halfExtentX=0,this._halfExtentY=0,this._halfExtentZ=0,this._center=new e.Float4},e.BoundingVolume.EXPANSE_EMPTY=0,e.BoundingVolume.EXPANSE_INFINITE=1,e.BoundingVolume.EXPANSE_FINITE=2,e.BoundingVolume._testAABBToSphere=function(t,e){var i,n=e._maximumX,r=e._maximumY,o=e._maximumZ,s=t._minimumX,a=t._minimumY,h=t._minimumZ,l=e._halfExtentX,u=this._center.x,c=this._center.y,_=this._center.z,d=0;return s>u?(i=u-s,d+=i*i):n<u&&(i=u-n,d+=i*i),a>c?(i=c-a,d+=i*i):r<c&&(i=c-r,d+=i*i),h>_?(i=_-h,d+=i*i):o<_&&(i=_-o,d+=i*i),d<l*l},e.BoundingVolume.prototype={get expanse(){return this._expanse},get type(){return this._type},growToIncludeMesh:function(t){throw new Error("Abstract method!")},growToIncludeBound:function(t){throw new Error("Abstract method!")},growToIncludeMinMax:function(t,e){throw new Error("Abstract method!")},clear:function(t){this._minimumX=this._minimumY=this._minimumZ=0,this._maximumX=this._maximumY=this._maximumZ=0,this._center.set(0,0,0),this._halfExtentX=this._halfExtentY=this._halfExtentZ=0,this._expanse=void 0===t?e.BoundingVolume.EXPANSE_EMPTY:t},get minimum(){return new e.Float4(this._minimumX,this._minimumY,this._minimumZ,1)},get maximum(){return new e.Float4(this._maximumX,this._maximumY,this._maximumZ,1)},get center(){return this._center},get halfExtent(){return new e.Float4(this._halfExtentX,this._halfExtentY,this._halfExtentZ,0)},getRadius:function(){throw new Error("Abstract method!")},transformFrom:function(t,e){throw new Error("Abstract method!")},intersectsConvexSolid:function(t,e){throw new Error("Abstract method!")},intersectsBound:function(t){throw new Error("Abstract method!")},classifyAgainstPlane:function(t){throw new Error("Abstract method!")},createDebugModelInstance:function(){throw new Error("Abstract method!")},getDebugModelInstance:function(){return void 0===this._type._debugModel&&(this._type._debugModel=this.createDebugModelInstance()),this._type._debugModel},getDebugMaterial:function(){if(void 0===e.BoundingVolume._debugMaterial){var t=new e.Material,i=new e.Shader(e.ShaderLibrary.get("debug_bounds_vertex.glsl"),e.ShaderLibrary.get("debug_bounds_fragment.glsl")),n=new e.MaterialPass(i);n.elementType=e.ElementType.LINES,n.cullMode=e.CullMode.NONE,t.setPass(e.MaterialPass.GEOMETRY_PASS,n),t.setUniform("color",new e.Color(1,0,1)),e.BoundingVolume._debugMaterial=t}return e.BoundingVolume._debugMaterial},toString:function(){return"BoundingVolume: [ "+this._minimumX+", "+this._minimumY+", "+this._minimumZ+" ] - [ "+this._maximumX+", "+this._maximumY+", "+this._maximumZ+" ], expanse: "+this._expanse}},e.SkeletonBlendNode=function(){this._rootJointDeltaPosition=new e.Float4,this._valueID=null,this._pose=new e.SkeletonPose},e.SkeletonBlendNode.prototype={update:function(t,e){},setValue:function(t,e){this._valueID===t&&this._applyValue(e)},get rootJointDeltaPosition(){return this._rootJointDeltaPosition},get numJoints(){return-1},get valueID(){return this._valueID},set valueID(t){this._valueID=t},_applyValue:function(t){}},e.Model=function(t){this._name=null,this._localBounds=new e.BoundingAABB,this._skeleton=null,this.onChange=new e.Signal,t?(this._meshes=null,this._setModelData(t)):this._meshes=[]},e.Model.prototype={constructor:e.Model,get name(){return this._name},set name(t){this._name=t},get numMeshes(){return this._meshes.length},getMesh:function(t){return this._meshes[t]},dispose:function(){if(this._meshes)for(var t=0;t<this._meshes.length;++t)this._meshes[t].dispose()},get localBounds(){return this._localBounds},get skeleton(){return this._skeleton},set skeleton(t){this._skeleton=t},_setModelData:function(t){this.dispose(),this._localBounds.clear(),this._meshes=[];for(var i=0;i<t.numMeshes;++i){var n=t.getMeshData(i);this._localBounds.growToIncludeMesh(n),this._meshes.push(new e.Mesh(n,this))}this.skeleton=t.skeleton,this.onChange.dispatch()},toString:function(){return"[Model(name="+this._name+")]"}},e.Primitive={_ATTRIBS:function(){this.positions=[],this.uvs=null,this.normals=null,this.indices=[]},define:function(){var t=function(i){i=i||{};var n=t.createMeshData(i),r=new e.ModelData;r.addMeshData(n),e.Model.call(this,r)};return t.prototype=Object.create(e.Model.prototype),t.createMeshData=function(i){var n=new e.Primitive._ATTRIBS,r=void 0===i.uvs||i.uvs,o=void 0===i.normals||i.normals,s=void 0===i.tangents||i.tangents,a=new e.MeshData;a.addVertexAttribute("hx_position",3),o&&(a.addVertexAttribute("hx_normal",3),n.normals=[]),s&&a.addVertexAttribute("hx_tangent",4),r&&(a.addVertexAttribute("hx_texCoord",2),n.uvs=[]),t._generate(n,i);for(var h=i.scaleU||1,l=i.scaleV||1,u=n.positions.length/3,c=0,_=0,d=0,f=[],p=0;p<u;++p)f[c++]=n.positions[d],f[c++]=n.positions[d+1],f[c++]=n.positions[d+2],o&&(f[c++]=n.normals[d],f[c++]=n.normals[d+1],f[c++]=n.normals[d+2]),s&&(c+=4),r&&(f[c++]=n.uvs[_++]*h,f[c++]=n.uvs[_++]*l),d+=3;a.setVertexData(f,0),a.setIndexData(n.indices);var m=0;if(o&&0===n.normals.length&&(m|=e.NormalTangentGenerator.MODE_NORMALS),s&&(m|=e.NormalTangentGenerator.MODE_TANGENTS),m){var g=new e.NormalTangentGenerator;g.generate(a,m)}return a},t.createMesh=function(i){var n=t.createMeshData(i);return new e.Mesh(n)},t}},e.KeyFrame=function(t,e){this.time=t||0,this.value=e},e.FloatController=function(){e.Component.call(this),this._speed=1,this._speedMultiplier=2,this._torquePitch=0,this._torqueYaw=0,this._localVelocity=new e.Float4(0,0,0,0),this._localAcceleration=new e.Float4(0,0,0,0),this._pitch=0,this._yaw=0,this._mouseX=0,this._mouseY=0,this._torque=1,this._friction=5,this._maxAcceleration=this._speed,this._maxVelocity=this._speed,this._onKeyDown=null,this._onKeyUp=null},e.FloatController.prototype=Object.create(e.Component.prototype,{speed:{get:function(){return this._speed},set:function(t){this._speed=t,this._maxAcceleration=t,this._maxVelocity=t}},shiftMultiplier:{get:function(){return this._speedMultiplier},set:function(t){this._speedMultiplier=t}},pitch:{get:function(){return this._pitch},set:function(t){this._pitch=t}},yaw:{get:function(){return this._yaw},set:function(t){this._yaw=t}},roll:{get:function(){return this._roll},set:function(t){this._roll=t}},torque:{get:function(){return this._torque},set:function(t){this._torque=t}},friction:{get:function(){return this._friction},set:function(t){this._friction=t}}}),e.FloatController.prototype.onAdded=function(t){var i=this;this._onKeyDown=function(t){var e="which"in t?t.which:t.keyCode;switch(e){case 16:i._maxVelocity=i._speed*i._speedMultiplier,i._maxAcceleration=i._speed*i._speedMultiplier;break;case 87:i._setForwardForce(-1);break;case 83:i._setForwardForce(1);break;case 65:i._setStrideForce(-1);break;case 68:i._setStrideForce(1)}},this._onKeyUp=function(t){var e="which"in t?t.which:t.keyCode;switch(e){case 16:i._maxVelocity=i._speed,i._maxAcceleration=i._speed;break;case 87:case 83:i._setForwardForce(0);break;case 65:case 68:i._setStrideForce(0)}},this._onMouseMove=function(t){t=t||window.event,i._addPitch(-(i._mouseY-t.clientY)/100),i._addYaw((i._mouseX-t.clientX)/100),i._mouseX=t.clientX,i._mouseY=t.clientY},this._onMouseDown=function(t){i._mouseX=t.clientX,i._mouseY=t.clientY,e.TARGET_CANVAS.addEventListener("mousemove",i._onMouseMove)},this._onMouseUp=function(t){e.TARGET_CANVAS.removeEventListener("mousemove",i._onMouseMove)},document.addEventListener("keydown",this._onKeyDown),document.addEventListener("keyup",this._onKeyUp),e.TARGET_CANVAS.addEventListener("mousedown",this._onMouseDown),e.TARGET_CANVAS.addEventListener("mouseup",this._onMouseUp)},e.FloatController.prototype.onRemoved=function(t){document.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("keyup",this._onKeyUp),e.TARGET_CANVAS.removeEventListener("mousemove",this._onMouseMove),e.TARGET_CANVAS.removeEventListener("mousedown",this._onMouseDown),e.TARGET_CANVAS.removeEventListener("mouseup",this._onMouseUp)},e.FloatController.prototype.onUpdate=function(t){var i=.001*t,n=e.Float4.scale(this._localVelocity,this._friction*i);this._localVelocity.subtract(n);var r=e.Float4.scale(this._localAcceleration,this._maxAcceleration*i);this._localVelocity.add(r);var o=this._localVelocity.length;o>this._maxVelocity&&this._localVelocity.scale(this._maxVelocity/o),this._pitch+=this._torquePitch,this._yaw+=this._torqueYaw,this._pitch<.5*-Math.PI?this._pitch=.5*-Math.PI:this._pitch>.5*Math.PI&&(this._pitch=.5*Math.PI);var s=this.entity.matrix,a=s.getColumn(3),h=e.Float4.scale(this._localVelocity,i);s.fromRotationPitchYawRoll(this._pitch,this._yaw,0),s.prependTranslation(h),s.appendTranslation(a),this.entity.matrix=s},e.FloatController.prototype._setForwardForce=function(t){this._localAcceleration.z=t*this._maxAcceleration},e.FloatController.prototype._setStrideForce=function(t){this._localAcceleration.x=t*this._maxAcceleration},e.FloatController.prototype._setTorquePitch=function(t){this._torquePitch=t*this._torque},e.FloatController.prototype._setTorqueYaw=function(t){this._torqueYaw=t*this._torque},e.FloatController.prototype._addPitch=function(t){this._pitch+=t},e.FloatController.prototype._addYaw=function(t){this._yaw+=t},e.OrbitController=function(t){e.Component.call(this),this._coords=new e.Float4(.5*Math.PI,.4*Math.PI,1,0),this._localAcceleration=new e.Float4(0,0,0,0),this._localVelocity=new e.Float4(0,0,0,0),this.touchZoomSpeed=.01,this.zoomSpeed=1,this.maxRadius=4,this.minRadius=.1,this.dampen=.9,this.lookAtTarget=t||new e.Float4(0,0,0,1),this._oldMouseX=0,this._oldMouseY=0,this._isDown=!1},e.OrbitController.prototype=Object.create(e.Component.prototype,{radius:{get:function(){return this._coords.z},set:function(t){this._coords.z=t}},azimuth:{get:function(){return this._coords.x},set:function(t){this._coords.x=t}},polar:{get:function(){return this._coords.y},set:function(t){this._coords.y=t}}}),e.OrbitController.prototype.onAdded=function(){var t=this;this._onMouseWheel=function(e){var i=e.detail?-120*e.detail:e.wheelDelta;t.setZoomImpulse(-i*t.zoomSpeed*1e-4)},this._onMouseDown=function(e){t._oldMouseX=void 0,t._oldMouseY=void 0,t._isDown=!0},this._onMouseMove=function(e){t._isDown&&t._updateMove(e.screenX,e.screenY)},this._onTouchDown=function(e){if(t._oldMouseX=void 0,t._oldMouseY=void 0,2===e.touches.length){var i=e.touches[0],n=e.touches[1],r=i.screenX-n.screenX,o=i.screenY-n.screenY;t._startPitchDistance=Math.sqrt(r*r+o*o),t._startZoom=t.radius}t._isDown=!0},this._onTouchMove=function(e){if(e.preventDefault(),t._isDown){var i=e.touches.length;if(1===i){var n=e.touches[0];t._updateMove(n.screenX,n.screenY)}else if(2===i){var r=e.touches[0],o=e.touches[1],s=r.screenX-o.screenX,a=r.screenY-o.screenY,h=Math.sqrt(s*s+a*a),l=t._startPitchDistance-h;t.radius=t._startZoom+l*this.touchZoomSpeed}}},this._onUp=function(e){t._isDown=!1};var i=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";e.TARGET_CANVAS.addEventListener(i,this._onMouseWheel),e.TARGET_CANVAS.addEventListener("mousemove",this._onMouseMove),e.TARGET_CANVAS.addEventListener("touchmove",this._onTouchMove),e.TARGET_CANVAS.addEventListener("mousedown",this._onMouseDown),e.TARGET_CANVAS.addEventListener("touchstart",this._onTouchDown),e.TARGET_CANVAS.addEventListener("mouseup",this._onUp),e.TARGET_CANVAS.addEventListener("touchend",this._onUp)},e.OrbitController.prototype.onRemoved=function(){var t=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";e.TARGET_CANVAS.removeEventListener(t,this._onMouseWheel),e.TARGET_CANVAS.removeEventListener("mousemove",this._onMouseMove),e.TARGET_CANVAS.removeEventListener("touchmove",this._onTouchMove),e.TARGET_CANVAS.removeEventListener("mousedown",this._onMouseDown),e.TARGET_CANVAS.removeEventListener("touchstart",this._onTouchDown),e.TARGET_CANVAS.removeEventListener("mouseup",this._onUp),e.TARGET_CANVAS.removeEventListener("touchend",this._onUp)},e.OrbitController.prototype.onUpdate=function(t){this._localVelocity.x*=this.dampen,this._localVelocity.y*=this.dampen,this._localVelocity.z*=this.dampen,this._localVelocity.x+=this._localAcceleration.x,this._localVelocity.y+=this._localAcceleration.y,this._localVelocity.z+=this._localAcceleration.z,this._localAcceleration.x=0,this._localAcceleration.y=0,this._localAcceleration.z=0,this._coords.add(this._localVelocity),this._coords.y=e.clamp(this._coords.y,.1,Math.PI-.1),this._coords.z=e.clamp(this._coords.z,this.minRadius,this.maxRadius);var i=this.entity.matrix,n=new e.Float4;n.fromSphericalCoordinates(this._coords.z,this._coords.x,this._coords.y),n.add(this.lookAtTarget),i.lookAt(this.lookAtTarget,n,e.Float4.Y_AXIS),this.entity.matrix=i},e.OrbitController.prototype.setAzimuthImpulse=function(t){this._localAcceleration.x=t},e.OrbitController.prototype.setPolarImpulse=function(t){this._localAcceleration.y=t},e.OrbitController.prototype.setZoomImpulse=function(t){this._localAcceleration.z=t},e.OrbitController.prototype._updateMove=function(t,e){if(void 0!==this._oldMouseX){var i=t-this._oldMouseX,n=e-this._oldMouseY;this.setAzimuthImpulse(.0015*i),this.setPolarImpulse(.0015*-n)}this._oldMouseX=t,this._oldMouseY=e},e.Debug={printShaderCode:function(t){for(var e=t.split("\n"),i="",n=0;n<e.length;++n)i+=n+1+":\t"+e[n]+"\n";console.log(i)},printSkeletonHierarchy:function(t){for(var e="Skeleton: \n",i=0;i<t.numJoints;++i){for(var n=t.getJoint(i),r=n.name;n.parentIndex!==-1;)n=t.getJoint(n.parentIndex),e+="\t";e+="\t"+r+"\n"}console.log(e)},assert:function(t,e){if(!t)throw new Error(e)}},e.Bloom=function(t,i,n,r){e.Effect.call(this),this._downScale=n||4,this._targetWidth=-1,this._targetHeight=-1,t=t||256,t/=this._downScale,this._thresholdPass=new e.EffectPass(null,e.ShaderLibrary.get("bloom_threshold_fragment.glsl")),this._compositePass=new e.EffectPass(e.ShaderLibrary.get("bloom_composite_vertex.glsl"),e.ShaderLibrary.get("bloom_composite_fragment.glsl")),this._blurPass=new e.GaussianBlurPass(t),this._blurSourceSlot=this._blurPass.getTextureSlot("sourceTexture"),this._thresholdWidth=-1,this._thresholdHeight=-1,this._thresholdMaps=[],this._smallFBOs=[];for(var o=0;o<2;++o)this._thresholdMaps[o]=new e.Texture2D,this._thresholdMaps[o].filter=e.TextureFilter.BILINEAR_NOMIP,this._thresholdMaps[o].wrapMode=e.TextureWrapMode.CLAMP,this._smallFBOs[o]=new e.FrameBuffer([this._thresholdMaps[o]]);this._anisotropy=r||1,this._strength=void 0===i?1:i,e.EXT_HALF_FLOAT_TEXTURES_LINEAR&&e.EXT_HALF_FLOAT_TEXTURES?this.thresholdLuminance=e.OPTIONS.hdr:this.thresholdLuminance=.9,this._compositePass.setTexture("bloomTexture",this._thresholdMaps[0]),this.strength=this._strength},e.Bloom.prototype=Object.create(e.Effect.prototype,{strength:{get:function(){return this._strength},set:function(t){this._strength=t,this._compositePass.setUniform("strength",this._strength)}}}),e.Bloom.prototype._initTextures=function(){for(var t=0;t<2;++t)this._thresholdWidth=Math.ceil(this._targetWidth/this._downScale),this._thresholdHeight=Math.ceil(this._targetHeight/this._downScale),this._thresholdMaps[t].initEmpty(this._thresholdWidth,this._thresholdHeight,i.RGB,e.HDR_FORMAT),this._smallFBOs[t].init()},e.Bloom.prototype.draw=function(t){this._renderer._width===this._targetWidth&&this._renderer._height===this._targetHeight||(this._targetWidth=this._renderer._width,this._targetHeight=this._renderer._height,this._initTextures()),e.setRenderTarget(this._smallFBOs[0]),e.clear(),this._drawPass(this._thresholdPass),e.setRenderTarget(this._smallFBOs[1]),e.clear(),this._blurSourceSlot.texture=this._thresholdMaps[0],this._blurPass.setUniform("stepSize",{x:1/this._thresholdWidth,y:0}),this._drawPass(this._blurPass),e.setRenderTarget(this._smallFBOs[0]),e.clear(),this._blurSourceSlot.texture=this._thresholdMaps[1],this._blurPass.setUniform("stepSize",{x:0,y:this._anisotropy/this._thresholdHeight}),this._drawPass(this._blurPass),e.setRenderTarget(this.hdrTarget),e.clear(),this._drawPass(this._compositePass)},e.Bloom.prototype.dispose=function(){for(var t=0;t<2;++t)this._smallFBOs[t].dispose(),this._thresholdMaps[t].dispose();this._smallFBOs=null,this._thresholdMaps=null},Object.defineProperty(e.Bloom.prototype,"thresholdLuminance",{get:function(){return this._thresholdLuminance},set:function(t){this._thresholdLuminance=t,this._thresholdPass.setUniform("threshold",t)}}),e.Blur=function(t,i){i||(i=t),e.Effect.call(this),this._blurPass=new e.GaussianBlurPass(i),this._blurSourceSlot=this._blurPass.getTextureSlot("sourceTexture"),this._radius=i,this._numSamples=t},e.Blur.prototype=Object.create(e.Effect.prototype,{radius:{get:function(){return this._radius},set:function(t){this._radius=t}}}),e.Blur.prototype.draw=function(t){var i=this._radius/this._numSamples;e.setRenderTarget(this.hdrTarget),e.clear(),this._blurSourceSlot.texture=this.hdrSource,this._blurPass.setUniform("stepSize",{x:i/this.hdrSource.width,y:0}),this._drawPass(this._blurPass),this._swapHDRFrontAndBack(),e.setRenderTarget(this.hdrTarget),e.clear(),this._blurSourceSlot.texture=this.hdrSource,this._blurPass.setUniform("stepSize",{x:0,y:i/this.hdrSource.height}),this._drawPass(this._blurPass)},e.Blur.prototype.dispose=function(){for(var t=0;t<2;++t)this._smallFBOs[t].dispose(),this._thresholdMaps[t].dispose();this._smallFBOs=null,this._thresholdMaps=null},e.CopyTexturePass=function(){e.EffectPass.call(this,null,e.ShaderLibrary.get("copy_fragment.glsl"))},e.CopyTexturePass.prototype=Object.create(e.EffectPass.prototype),e.CopyTexturePass.prototype.setSourceTexture=function(t){this.setTexture("sampler",t)},e.Fog=function(t,i,n,r){e.Effect.call(this),this._fogPass=new e.EffectPass(e.ShaderLibrary.get("fog_vertex.glsl"),e.ShaderLibrary.get("fog_fragment.glsl")),this.needsNormalDepth=!0,this.density=void 0===t?.001:t,this.tint=void 0===i?new e.Color(1,1,1,1):i,this.startDistance=void 0===r?0:r,this.heightFallOff=void 0===n?.01:n},e.Fog.prototype=Object.create(e.Effect.prototype,{density:{get:function(){return this._density},set:function(t){this._density=t,this._fogPass.setUniform("density",t)}},tint:{get:function(){return this._tint},set:function(t){this._tint=t,this._fogPass.setUniform("tint",{x:t.r,y:t.g,z:t.b})}},startDistance:{get:function(){return this._startDistance},set:function(t){this._startDistance=t,this._fogPass.setUniform("startDistance",t)}},heightFallOff:{get:function(){return this._heightFallOff},set:function(t){this._heightFallOff=t,this._fogPass.setUniform("heightFallOff",t)}}}),e.Fog.prototype.draw=function(t){e.setRenderTarget(this.hdrTarget),e.clear(),this._drawPass(this._fogPass)},e.FXAA=function(){e.Effect.call(this),this._pass=new e.EffectPass(null,e.ShaderLibrary.get("fxaa_fragment.glsl")),this._pass.setUniform("edgeThreshold",1/8),this._pass.setUniform("edgeThresholdMin",1/16),this._pass.setUniform("edgeSharpness",4)},e.FXAA.prototype=Object.create(e.Effect.prototype),e.FXAA.prototype.draw=function(t){e.setRenderTarget(this.hdrTarget),e.clear(),this._drawPass(this._pass)},e.GaussianBlurPass=function(t){t=Math.floor(t),this._initWeights(t);var i={RADIUS:t,NUM_WEIGHTS:t+1},n=e.ShaderLibrary.get("gaussian_blur_vertex.glsl",i),r=e.ShaderLibrary.get("gaussian_blur_fragment.glsl",i);e.EffectPass.call(this,n,r),this.setUniformArray("gaussianWeights",new Float32Array(this._weights))},e.GaussianBlurPass.prototype=Object.create(e.EffectPass.prototype),e.GaussianBlurPass.prototype._initWeights=function(t){this._weights=[];for(var i=e.CenteredGaussianCurve.fromRadius(t,.01),n=0,r=0;r<=t;++r)this._weights[r]=i.getValueAt(r),n+=r>0?2*this._weights[r]:1;for(n=1/n,r=0;r<=t;++r)this._weights[r]*=n},e.HBAO=function(t,i){t=t||4,i=i||4,t>32&&(t=32),i>32&&(i=32),this._numRays=t,this._strength=1,this._bias=.01,this._fallOffDistance=1,this._radius=.5,this._scale=.5,this._sampleDirTexture=null,this._ditherTexture=null,e.Effect.call(this),this._aoPass=new e.EffectPass(e.ShaderLibrary.get("hbao_vertex.glsl"),e.ShaderLibrary.get("hbao_fragment.glsl",{NUM_RAYS:t,NUM_SAMPLES_PER_RAY:i})),this._blurPass=new e.EffectPass(null,e.ShaderLibrary.get("ao_blur_fragment.glsl")),this._initSampleDirTexture(),this._initDitherTexture(),this._aoPass.setUniform("strengthPerRay",this._strength/this._numRays),this._aoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance),this._aoPass.setUniform("halfSampleRadius",.5*this._radius),this._aoPass.setUniform("bias",this._bias),this._aoPass.setTexture("ditherTexture",this._ditherTexture),this._aoPass.setTexture("sampleDirTexture",this._sampleDirTexture),this._sourceTextureSlot=this._blurPass.getTextureSlot("source"),this._aoTexture=new e.Texture2D,this._aoTexture.filter=e.TextureFilter.BILINEAR_NOMIP,this._aoTexture.wrapMode=e.TextureWrapMode.CLAMP,this._backTexture=new e.Texture2D,this._backTexture.filter=e.TextureFilter.BILINEAR_NOMIP,this._backTexture.wrapMode=e.TextureWrapMode.CLAMP,this._fbo1=new e.FrameBuffer(this._aoTexture),this._fbo2=new e.FrameBuffer(this._backTexture)},e.HBAO.prototype=Object.create(e.Effect.prototype),e.HBAO.prototype.getAOTexture=function(){return this._aoTexture},Object.defineProperties(e.HBAO.prototype,{sampleRadius:{get:function(){return this._radius},set:function(t){this._radius=t,this._aoPass.setUniform("halfSampleRadius",.5*this._radius)}},fallOffDistance:{get:function(){return this._fallOffDistance},set:function(t){this._fallOffDistance=t,this._aoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance)}},strength:{get:function(){return this._strength},set:function(t){this._strength=t,this._aoPass.setUniform("strengthPerRay",this._strength/this._numRays)}},bias:{get:function(){return this._bias},set:function(t){this._bias=t,this._aoPass.setUniform("bias",this._bias)}},scale:{get:function(){return this._scale},set:function(t){this._scale=t}}}),e.HBAO.prototype.draw=function(t){var i=this._renderer._width*this._scale,n=this._renderer._height*this._scale;e.TextureUtils.assureSize(i,n,this._aoTexture,this._fbo1)&&(e.TextureUtils.assureSize(i,n,this._backTexture,this._fbo2),this._aoPass.setUniform("ditherScale",{x:.25*i,y:.25*n})),e.setRenderTarget(this._fbo1),e.clear(),this._drawPass(this._aoPass),e.setRenderTarget(this._fbo2),e.clear(),this._blurPass.setUniform("halfTexelOffset",{x:.5/i,y:0}),this._sourceTextureSlot.texture=this._aoTexture,this._drawPass(this._blurPass),e.setRenderTarget(this._fbo1),e.clear(),this._blurPass.setUniform("halfTexelOffset",{x:0,y:.5/n}),this._sourceTextureSlot.texture=this._backTexture,this._drawPass(this._blurPass)},e.HBAO.prototype._initSampleDirTexture=function(){this._sampleDirTexture=new e.Texture2D;for(var t=[],i=0,n=0;n<256;++n){var r=n/256*2*Math.PI,o=.5*Math.cos(r)+.5,s=.5*Math.sin(r)+.5;t[i]=Math.round(255*o),t[i+1]=Math.round(255*s),t[i+2]=0,t[i+3]=255,i+=4}this._sampleDirTexture.uploadData(new Uint8Array(t),256,1,!1),this._sampleDirTexture.filter=e.TextureFilter.NEAREST_NOMIP,this._sampleDirTexture.wrapMode=e.TextureWrapMode.REPEAT},e.HBAO.prototype._initDitherTexture=function(){this._ditherTexture=new e.Texture2D;var t,i=[],n=0,r=[],o=[];for(t=0;t<16;++t)r.push(t/16),o.push(t/15);e.shuffle(r),e.shuffle(o),t=0;for(var s=0;s<4;++s)for(var a=0;a<4;++a){var h=r[t],l=o[t];++t,i[n]=Math.round(255*h),i[n+1]=Math.round(255*l),i[n+2]=0,i[n+3]=255,n+=4}this._ditherTexture.uploadData(new Uint8Array(i),4,4,!1),this._ditherTexture.filter=e.TextureFilter.NEAREST_NOMIP,this._ditherTexture.wrapMode=e.TextureWrapMode.REPEAT},e.ScreenSpaceReflections=function(t){e.Effect.call(this),t=t||5,this._numSamples=t;var i={NUM_SAMPLES:t};this._isSupported=!!e.EXT_STANDARD_DERIVATIVES,this._stencilWriteState=new e.StencilState(1,e.Comparison.ALWAYS,e.StencilOp.REPLACE,e.StencilOp.REPLACE,e.StencilOp.REPLACE),this._stencilReadState=new e.StencilState(1,e.Comparison.EQUAL,e.StencilOp.KEEP,e.StencilOp.KEEP,e.StencilOp.KEEP),this._stencilPass=new e.EffectPass(null,e.ShaderLibrary.get("ssr_stencil_fragment.glsl")),this._pass=new e.EffectPass(e.ShaderLibrary.get("post_viewpos_vertex.glsl",i),e.ShaderLibrary.get("ssr_fragment.glsl",i)),this._scale=.5,this.stepSize=Math.max(500/t,1),this.maxDistance=500,this.maxRoughness=.4,this._depthBuffer=new e.WriteOnlyDepthBuffer,this._ssrTexture=new e.Texture2D,this._ssrTexture.filter=e.TextureFilter.BILINEAR_NOMIP,this._ssrTexture.wrapMode=e.TextureWrapMode.CLAMP,this._fbo=new e.FrameBuffer(this._ssrTexture,this._depthBuffer)},e.ScreenSpaceReflections.prototype=Object.create(e.Effect.prototype),Object.defineProperties(e.ScreenSpaceReflections.prototype,{stepSize:{get:function(){return this._stepSize},set:function(t){this._stepSize=t,this._pass.setUniform("stepSize",t)}},maxDistance:{get:function(){return this._stepSize},set:function(t){this._stepSize=t,this._pass.setUniform("maxDistance",t)}},maxRoughness:{get:function(){return this._stepSize},set:function(t){this._stepSize=t,this._pass.setUniform("maxRoughness",t),this._stencilPass.setUniform("maxRoughness",t)}},scale:{get:function(){return this._scale},set:function(t){this._scale=t,this._scale>1&&(this._scale=1)}}}),e.ScreenSpaceReflections.prototype.getSSRTexture=function(){return this._ssrTexture},e.ScreenSpaceReflections.prototype.draw=function(t){var n=this._renderer._width*this._scale,r=this._renderer._height*this._scale;e.TextureUtils.assureSize(n,r,this._ssrTexture,null,i.RGBA,e.HDR_FORMAT)&&(this._depthBuffer.init(n,r),this._fbo.init(),this._pass.setUniform("ditherTextureScale",{x:n/e.DEFAULT_2D_DITHER_TEXTURE.width,y:r/e.DEFAULT_2D_DITHER_TEXTURE.height})),e.pushRenderTarget(this._fbo),e.setClearColor(e.Color.ZERO),e.clear(),i.colorMask(!1,!1,!1,!1),e.setStencilState(this._stencilWriteState),this._drawPass(this._stencilPass),i.colorMask(!0,!0,!0,!0),e.setStencilState(this._stencilReadState),this._drawPass(this._pass),e.setStencilState(),e.popRenderTarget()},e.SSAO=function(t){t=t||8,t>64&&(t=64),this._numSamples=t,this._strength=1,this._fallOffDistance=1,this._radius=.5,this._scale=.5,this._ditherTexture=null,e.Effect.call(this),this._ssaoPass=new e.EffectPass(null,e.ShaderLibrary.get("ssao_fragment.glsl",{NUM_SAMPLES:t})),this._blurPass=new e.EffectPass(null,e.ShaderLibrary.get("ao_blur_fragment.glsl")),this._initSamples(),this._initDitherTexture(),this._ssaoPass.setUniform("strengthPerSample",2*this._strength/this._numSamples),this._ssaoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance),this._ssaoPass.setUniform("sampleRadius",this._radius),this._ssaoPass.setTexture("ditherTexture",this._ditherTexture),this._sourceTextureSlot=this._blurPass.getTextureSlot("source"),this._ssaoTexture=new e.Texture2D,this._ssaoTexture.filter=e.TextureFilter.BILINEAR_NOMIP,this._ssaoTexture.wrapMode=e.TextureWrapMode.CLAMP,this._backTexture=new e.Texture2D,this._backTexture.filter=e.TextureFilter.BILINEAR_NOMIP,this._backTexture.wrapMode=e.TextureWrapMode.CLAMP,this._fbo1=new e.FrameBuffer(this._ssaoTexture),this._fbo2=new e.FrameBuffer(this._backTexture)},e.SSAO.prototype=Object.create(e.Effect.prototype),e.SSAO.prototype.getAOTexture=function(){return this._ssaoTexture},Object.defineProperties(e.SSAO.prototype,{sampleRadius:{get:function(){return this._radius},set:function(t){this._radius=t,this._ssaoPass.setUniform("sampleRadius",this._radius)}},fallOffDistance:{get:function(){return this._fallOffDistance},set:function(t){this._fallOffDistance=t,this._ssaoPass.setUniform("rcpFallOffDistance",1/this._fallOffDistance)}},strength:{get:function(){return this._strength},set:function(t){this._strength=t,this._ssaoPass.setUniform("strengthPerSample",2*this._strength/this._numSamples)}},scale:{get:function(){return this._scale},set:function(t){this._scale=t}}}),e.SSAO.prototype._initSamples=function(){for(var t=[],i=0,n=e.PoissonSphere.DEFAULT.getPoints(),r=0;r<this._numSamples;++r){var o=n[r];t[i++]=Math.pow(o.x,2),t[i++]=Math.pow(o.y,2),t[i++]=Math.pow(o.z,2)}this._ssaoPass.setUniformArray("samples",new Float32Array(t))},e.SSAO.prototype.draw=function(t){var i=this._renderer._width*this._scale,n=this._renderer._height*this._scale;e.TextureUtils.assureSize(i,n,this._ssaoTexture,this._fbo1)&&(e.TextureUtils.assureSize(i,n,this._backTexture,this._fbo2),this._ssaoPass.setUniform("ditherScale",{x:.25*i,y:.25*n})),e.setClearColor(e.Color.WHITE),e.setRenderTarget(this._fbo1),e.clear(),this._drawPass(this._ssaoPass),e.setRenderTarget(this._fbo2),e.clear(),this._blurPass.setUniform("halfTexelOffset",{x:.5/i,y:0}),this._sourceTextureSlot.texture=this._ssaoTexture,this._drawPass(this._blurPass),e.setRenderTarget(this._fbo1),e.clear(),this._blurPass.setUniform("halfTexelOffset",{x:0,y:.5/n}),this._sourceTextureSlot.texture=this._backTexture,this._drawPass(this._blurPass),e.setClearColor(e.Color.BLACK)},e.SSAO.prototype._initDitherTexture=function(){var t=[126,255,126,255,135,253,105,255,116,51,26,255,137,57,233,255,139,254,121,255,56,61,210,255,227,185,73,255,191,179,30,255,107,245,173,255,205,89,34,255,191,238,138,255,56,233,125,255,198,228,161,255,85,13,164,255,140,248,168,255,147,237,65,255];this._ditherTexture=new e.Texture2D,this._ditherTexture.uploadData(new Uint8Array(t),4,4,!1),this._ditherTexture.filter=e.TextureFilter.NEAREST_NOMIP,this._ditherTexture.wrapMode=e.TextureWrapMode.REPEAT},e.ToneMapEffect=function(t){return this._adaptive=void 0!==t&&t,!this._adaptive||e.EXT_SHADER_TEXTURE_LOD&&e.EXT_HALF_FLOAT_TEXTURES?(e.Effect.call(this),this._toneMapPass=this._createToneMapPass(),this._adaptive&&(this._extractLuminancePass=new e.EffectPass(null,e.ShaderLibrary.get("tonemap_reference_fragment.glsl")),this._extractLuminancePass.blendState=new e.BlendState(e.BlendFactor.CONSTANT_ALPHA,e.BlendFactor.ONE_MINUS_CONSTANT_ALPHA,e.BlendOperation.ADD,new e.Color(1,1,1,1)),this._luminanceMap=new e.Texture2D,this._luminanceMap.initEmpty(256,256,i.RGBA,e.EXT_HALF_FLOAT_TEXTURES.HALF_FLOAT_OES),this._luminanceFBO=new e.FrameBuffer(this._luminanceMap),this._luminanceFBO.init(),this._adaptationRate=500,this._toneMapPass.setTexture("hx_luminanceMap",this._luminanceMap),this._toneMapPass.setUniform("hx_luminanceMipLevel",e.log2(this._luminanceMap._width))),this.key=.25,void(this.exposure=0)):(console.log("Warning: adaptive tone mapping not supported, using non-adaptive"),void(this._adaptive=!1))},e.ToneMapEffect.prototype=Object.create(e.Effect.prototype),e.ToneMapEffect.prototype._createToneMapPass=function(){throw new Error("Abstract method called!")},e.ToneMapEffect.prototype.dispose=function(){e.Effect.prototype.dispose.call(this),this._luminanceFBO.dispose(),this._luminanceMap.dispose()},e.ToneMapEffect.prototype.draw=function(t){if(this._adaptive){if(!this._isSupported)return;var i=this._adaptationRate>0?t/this._adaptationRate:1;i>1&&(i=1),this._extractLuminancePass.blendState.color.a=i,e.setRenderTarget(this._luminanceFBO),this._drawPass(this._extractLuminancePass),this._luminanceMap.generateMipmap()}e.setRenderTarget(this.hdrTarget),e.clear(),this._drawPass(this._toneMapPass)},Object.defineProperties(e.ToneMapEffect.prototype,{exposure:{get:function(){return this._exposure},set:function(t){this._exposure=t,this._isSupported&&this._toneMapPass.setUniform("hx_exposure",Math.pow(2,t))}},key:{get:function(){return this._key},set:function(t){
this._key=t,this._isSupported&&this._toneMapPass.setUniform("hx_key",t)}},adaptationRate:{get:function(){return this._adaptationRate},set:function(t){this._adaptationRate=t}}}),e.ReinhardToneMapEffect=function(t){e.ToneMapEffect.call(this,t)},e.ReinhardToneMapEffect.prototype=Object.create(e.ToneMapEffect.prototype),e.ReinhardToneMapEffect.prototype._createToneMapPass=function(){var t={},i="";return this._adaptive&&(t.HX_ADAPTIVE=1,i+="#texturelod\n"),new e.EffectPass(null,i+e.ShaderLibrary.get("snippets_tonemap.glsl",t)+"\n"+e.ShaderLibrary.get("tonemap_reinhard_fragment.glsl"))},e.FilmicToneMapEffect=function(t){e.ToneMapEffect.call(this,t),this._outputsGamma=!0},e.FilmicToneMapEffect.prototype=Object.create(e.ToneMapEffect.prototype),e.FilmicToneMapEffect.prototype._createToneMapPass=function(){var t={},i="";return this._adaptive&&(t.HX_ADAPTIVE=1,i="#texturelod\n"),new e.EffectPass(null,i+e.ShaderLibrary.get("snippets_tonemap.glsl",t)+"\n"+e.ShaderLibrary.get("tonemap_filmic_fragment.glsl"))},e.AmbientLight=function(){e.Entity.call(this),this._scaledIrradiance=new e.Color,this._intensity=.2,this.color=new e.Color(1,1,1),this._scaledIrradiance=new e.Color,this._updateScaledIrradiance()},e.AmbientLight.prototype=Object.create(e.Entity.prototype),Object.defineProperties(e.AmbientLight.prototype,{color:{get:function(){return this._color},set:function(t){this._color=isNaN(t)?t:new e.Color(t),this._updateScaledIrradiance()}},intensity:{get:function(){return this._intensity},set:function(t){this._intensity=t,this._updateScaledIrradiance()}}}),e.AmbientLight.prototype.acceptVisitor=function(t){e.Entity.prototype.acceptVisitor.call(this,t),t.visitAmbientLight(this)},e.AmbientLight.prototype._updateWorldBounds=function(){this._worldBounds.clear(e.BoundingVolume.EXPANSE_INFINITE)},e.AmbientLight.prototype._updateScaledIrradiance=function(){e.OPTIONS.useGammaCorrection?this._color.gammaToLinear(this._scaledIrradiance):this._scaledIrradiance.copyFrom(this._color),this._scaledIrradiance.r*=this._intensity,this._scaledIrradiance.g*=this._intensity,this._scaledIrradiance.b*=this._intensity},e.DirectionalLight=function(){e.Light.call(this),this.depthBias=0,this._numCascades=1,this._shadowMapSize=1024,this._shadowMapRenderer=null,this.direction=new e.Float4((-1),(-1),(-1),0)},e.DirectionalLight.SHADOW_FILTER=null,e.DirectionalLight.prototype=Object.create(e.Light.prototype,{castShadows:{get:function(){return this._castShadows},set:function(t){this._castShadows!==t&&(this._castShadows=t,t?this._shadowMapRenderer=new e.CascadeShadowMapRenderer(this,this._numCascades,this._shadowMapSize):(this._shadowMapRenderer.dispose(),this._shadowMapRenderer=null))}},numCascades:{get:function(){return this._numCascades},set:function(t){t>4&&(console.warn("set numCascades called with value greater than 4. Real value will be set to 4."),t=4),this._numCascades=t,this._shadowMapRenderer&&(this._shadowMapRenderer.numCascades=t)}},shadowMapSize:{get:function(){return this._shadowMapSize},set:function(t){this._shadowMapSize=t,this._shadowMapRenderer&&(this._shadowMapRenderer.shadowMapSize=t)}},direction:{get:function(){var t=this.worldMatrix.getColumn(2);return t.x=-t.x,t.y=-t.y,t.z=-t.z,t},set:function(t){var i=new e.Matrix4x4,n=this.worldMatrix.getColumn(3),r=e.Float4.add(t,n);i.lookAt(r,n,e.Float4.Y_AXIS),this.matrix=i}}}),e.DirectionalLight.prototype.setCascadeRatios=function(t,e,i,n){this._shadowMapRenderer.setSplitRatios(t,e,i,n)},e.DirectionalLight.prototype._updateWorldBounds=function(){this._worldBounds.clear(e.BoundingVolume.EXPANSE_INFINITE)},e.ExponentialDirectionalShadowFilter=function(){e.ShadowFilter.call(this),this._expScaleFactor=80,this._blurRadius=1,this._darkeningFactor=.35},e.ExponentialDirectionalShadowFilter.prototype=Object.create(e.ShadowFilter.prototype,{blurRadius:{get:function(){return this._blurRadius},set:function(t){this._blurRadius=t,this._invalidateBlurShader()}},darkeningFactor:{get:function(){return this._darkeningFactor},set:function(t){this._darkeningFactor=t,this.onShaderInvalid.dispatch()}},expScaleFactor:{get:function(){return this._expScaleFactor},set:function(t){this._expScaleFactor=t,this.onShaderInvalid.dispatch()}}}),e.ExponentialDirectionalShadowFilter.prototype.getShadowMapFormat=function(){return i.RGB},e.ExponentialDirectionalShadowFilter.prototype.getShadowMapDataType=function(){return i.FLOAT},e.ExponentialDirectionalShadowFilter.prototype.getGLSL=function(){var t=this._getDefines();return e.ShaderLibrary.get("dir_shadow_esm.glsl",t)},e.ExponentialDirectionalShadowFilter.prototype._getDefines=function(){return{HX_ESM_CONSTANT:"float("+this._expScaleFactor+")",HX_ESM_DARKENING:"float("+this._darkeningFactor+")"}},e.ExponentialDirectionalShadowFilter.prototype._createBlurShader=function(){return new e.ESMBlurShader(this._blurRadius)},e.ESMBlurShader=function(t){e.Shader.call(this);var n={RADIUS:t,RCP_NUM_SAMPLES:"float("+1/(1+2*t)+")"},r=e.ShaderLibrary.get("copy_vertex.glsl",n),o=e.ShaderLibrary.get("esm_blur_fragment.glsl",n);this.init(r,o),this._textureLocation=i.getUniformLocation(this._program,"source"),this._directionLocation=i.getUniformLocation(this._program,"direction"),this._positionAttributeLocation=i.getAttribLocation(this._program,"hx_position"),this._texCoordAttributeLocation=i.getAttribLocation(this._program,"hx_texCoord"),i.useProgram(this._program),i.uniform1i(this._textureLocation,0)},e.ESMBlurShader.prototype=Object.create(e.Shader.prototype),e.ESMBlurShader.prototype.execute=function(t,n,r,o){e.setDepthTest(e.Comparison.DISABLED),e.setCullMode(e.CullMode.NONE),t._vertexBuffers[0].bind(),t._indexBuffer.bind(),this.updateRenderState(),n.bind(0),i.vertexAttribPointer(this._positionAttributeLocation,2,i.FLOAT,!1,16,0),i.vertexAttribPointer(this._texCoordAttributeLocation,2,i.FLOAT,!1,16,8),e.enableAttributes(2),i.uniform2f(this._directionLocation,r,o),e.drawElements(i.TRIANGLES,6,0)},e.HardDirectionalShadowFilter=function(){e.ShadowFilter.call(this)},e.HardDirectionalShadowFilter.prototype=Object.create(e.ShadowFilter.prototype),e.HardDirectionalShadowFilter.prototype.getGLSL=function(){return e.ShaderLibrary.get("dir_shadow_hard.glsl")},e.HardDirectionalShadowFilter.prototype.getCullMode=function(){return e.CullMode.FRONT},e.LightProbe=function(t,i){e.Entity.call(this),this._specularTexture=i,this._diffuseTexture=t,this._size=void 0},e.LightProbe.powerRange0=98e-5,e.LightProbe.powerRange1=.9921,e.LightProbe.prototype=Object.create(e.Entity.prototype,{specularTexture:{get:function(){return this._specularTexture}},diffuseTexture:{get:function(){return this._diffuseTexture}}}),e.LightProbe.prototype._updateWorldBounds=function(){this._worldBounds.clear(e.BoundingVolume.EXPANSE_INFINITE),e.Light.prototype._updateWorldBounds.call(this)},e.PCFDirectionalShadowFilter=function(){e.ShadowFilter.call(this),this._softness=.01,this._numShadowSamples=6,this._dither=!1},e.PCFDirectionalShadowFilter.prototype=Object.create(e.ShadowFilter.prototype,{softness:{get:function(){return this._softness},set:function(t){this._softness!==t&&(this._softness=t,this.onShaderInvalid.dispatch())}},numShadowSamples:{get:function(){return this._numShadowSamples},set:function(t){this._numShadowSamples!==t&&(this._numShadowSamples=t,this.onShaderInvalid.dispatch())}},dither:{get:function(){return this._dither},set:function(t){this._dither!==t&&(this._dither=t,this.onShaderInvalid.dispatch())}}}),e.PCFDirectionalShadowFilter.prototype.getCullMode=function(){return e.CullMode.FRONT},e.PCFDirectionalShadowFilter.prototype.getGLSL=function(){var t={HX_PCF_NUM_SHADOW_SAMPLES:this._numShadowSamples,HX_PCF_RCP_NUM_SHADOW_SAMPLES:"float("+1/this._numShadowSamples+")",HX_PCF_SOFTNESS:this._softness};return this._dither&&(t.HX_PCF_DITHER_SHADOWS=1),e.ShaderLibrary.get("dir_shadow_pcf.glsl",t)},e.PointLight=function(){e.Light.call(this),this._radius=100,this.intensity=3.1415},e.PointLight.LIGHTS_PER_BATCH=20,e.PointLight.SPHERE_SEGMENTS_W=16,e.PointLight.SPHERE_SEGMENTS_H=10,e.PointLight.NUM_SPHERE_INDICES=-1,e.PointLight.prototype=Object.create(e.Light.prototype,{radius:{get:function(){return this._radius},set:function(t){this._radius=t,this._updateWorldBounds()}}}),e.PointLight.prototype._createBoundingVolume=function(){return new e.BoundingSphere},e.PointLight.prototype._updateWorldBounds=function(){this._worldBounds.setExplicit(this.worldMatrix.getColumn(3),this._radius)},e.VarianceDirectionalShadowFilter=function(){e.ShadowFilter.call(this),this._blurRadius=2,this._lightBleedReduction=.35},e.VarianceDirectionalShadowFilter.prototype=Object.create(e.ShadowFilter.prototype,{blurRadius:{get:function(){return this._blurRadius},set:function(t){this._blurRadius=t,this._invalidateBlurShader()}},lightBleedReduction:{get:function(){return this._lightBleedReduction},set:function(t){this._lightBleedReduction=t,this.onShaderInvalid.dispatch()}}}),e.VarianceDirectionalShadowFilter.prototype.getGLSL=function(){var t=this._getDefines();return e.ShaderLibrary.get("dir_shadow_vsm.glsl",t)},e.VarianceDirectionalShadowFilter.prototype._createBlurShader=function(){return new e.VSMBlurShader(this._blurRadius)},e.VarianceDirectionalShadowFilter.prototype._getDefines=function(){var t=1-this._lightBleedReduction;return{HX_VSM_MIN_VARIANCE:-1e-4,HX_VSM_LIGHT_BLEED_REDUCTION:"float("+this._lightBleedReduction+")",HX_VSM_LIGHT_BLEED_REDUCTION_RANGE:"float("+t+")"}},e.VSMBlurShader=function(t){e.Shader.call(this);var n={RADIUS:t,RCP_NUM_SAMPLES:"float("+1/(1+2*t)+")"},r=e.ShaderLibrary.get("copy_vertex.glsl",n),o=e.ShaderLibrary.get("vsm_blur_fragment.glsl",n);this.init(r,o),this._textureLocation=i.getUniformLocation(this._program,"source"),this._directionLocation=i.getUniformLocation(this._program,"direction"),this._positionAttributeLocation=i.getAttribLocation(this._program,"hx_position"),this._texCoordAttributeLocation=i.getAttribLocation(this._program,"hx_texCoord"),i.useProgram(this._program),i.uniform1i(this._textureLocation,0)},e.VSMBlurShader.prototype=Object.create(e.Shader.prototype),e.VSMBlurShader.prototype.execute=function(t,n,r,o){e.setDepthTest(e.Comparison.DISABLED),e.setCullMode(e.CullMode.NONE),t._vertexBuffers[0].bind(),t._indexBuffer.bind(),this.updateRenderState(),n.bind(0),i.vertexAttribPointer(this._positionAttributeLocation,2,i.FLOAT,!1,16,0),i.vertexAttribPointer(this._texCoordAttributeLocation,2,i.FLOAT,!1,16,8),e.enableAttributes(2),i.uniform2f(this._directionLocation,r,o),e.drawElements(i.TRIANGLES,6,0)},e.AssetLibrary=function(t){this._numLoaded=0,this._queue=[],this._assets={},t&&"/"!=t.charAt(t.length-1)&&(t+="/"),this._basePath=t||"",this._onComplete=new e.Signal,this._onProgress=new e.Signal},e.AssetLibrary.Type={JSON:0,ASSET:1,PLAIN_TEXT:2},e.AssetLibrary.prototype={get onComplete(){return this._onComplete},get onProgress(){return this._onProgress},get basePath(){return this._basePath},queueAsset:function(t,e,i,n){this._queue.push({id:t,filename:this._basePath+e,type:i,parser:n})},load:function(){if(0===this._queue.length)return void this.onComplete.dispatch();var t=this._queue[this._numLoaded];switch(t.type){case e.AssetLibrary.Type.JSON:this._json(t.filename,t.id);break;case e.AssetLibrary.Type.PLAIN_TEXT:this._plainText(t.filename,t.id);break;case e.AssetLibrary.Type.ASSET:this._model(t.filename,t.id,t.parser)}},get:function(t){return this._assets[t]},_json:function(t,e){var i=this,n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",t,!0),n.onreadystatechange=function(){4===n.readyState&&"200"===n.status&&(i._assets[e]=JSON.parse(n.responseText),i._onAssetLoaded())},n.send(null)},_plainText:function(t,e){var i=this,n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",t,!0),n.onreadystatechange=function(){4===n.readyState&&"200"===n.status&&(i._assets[e]=n.responseText,i._onAssetLoaded())},n.send(null)},_textureCube:function(t,i){var n=this,r=new e.AssetLoader(e.HCM);r.bind(function(){n._onAssetLoaded()}),this._assets[i]=r.load(t)},_texture2D:function(t,i){var n=this,r=new e.AssetLoader(e.JPG);r.onComplete.bind(function(){n._onAssetLoaded()}),this._assets[i]=r.load(t)},_model:function(t,i,n){var r=this,o=new e.AssetLoader(n);o.onComplete.bind(function(){r._onAssetLoaded()}),this._assets[i]=o.load(t)},_onAssetLoaded:function(){this._onProgress.dispatch(this._numLoaded/this._queue.length),++this._numLoaded===this._queue.length?this._onComplete.dispatch(this):this.load()}},e.BulkAssetLoader=function(){this._assets=null,this._files=null,this._abortOnFail=!1,this.onComplete=new e.Signal,this.onFail=new e.Signal},e.BulkAssetLoader.prototype={get abortOnFail(){return this._abortOnFail},set abortOnFail(t){this._abortOnFail=t},getAsset:function(t){return this._assets[t]},load:function(t,e){if(this._files=t,this._assets={},this._index=0,e)for(var i=0;i<this._files.length;++i)this._files[i]={file:this._files[i],importer:e,target:null};this._loadQueued()},_loadQueued:function(){if(this._index===this._files.length)return void this._notifyComplete();var t=this._files[this._index],i=new e.AssetLoader(t.importer),n=this;i.onComplete=function(e){var i=t.file;n._assets[i]=e,++n._index,n._loadQueued()},i.onFail=function(t){n._notifyFailure(t),n._abortOnFail||i.onComplete()},i.load(t.file,t.target)},_notifyComplete:function(){this.onComplete&&(this.onComplete instanceof e.Signal?this.onComplete.dispatch():this.onComplete())},_notifyFailure:function(t){return this.onFail?void(this.onFail instanceof e.Signal?this.onFail.dispatch(t):this.onFail(t)):void console.warn("Importer error: "+t)}},e.HCM=function(){e.Importer.call(this,e.TextureCube)},e.HCM.prototype=Object.create(e.Importer.prototype),e.HCM.prototype.parse=function(t,e){var i=JSON.parse(t),n=[i.files.posX,i.files.negX,i.files.posY,i.files.negY,i.files.posZ,i.files.negZ];i.loadMips?this._loadMipChain(n,e):this._loadFaces(n,e)},e.HCM.prototype._loadFaces=function(t,e){for(var i=void 0===this.options.generateMipmaps||this.options.generateMipmaps,n=[],r=this,o=function(){r._notifyFailure("Failed loading texture '"+t[0]+"'")},s=function(){n[this.nextID].src=r.path+t[this.nextID]},a=function(){e.uploadImages(n,i),r._notifyComplete(e)},h=0;h<6;++h){var l=new Image;l.nextID=h+1,h<5?l.onload=s:l.onload=a,l.onError=o,n[h]=l}n[0].src=r.path+t[0]},e.HCM.prototype._loadMipChain=function(t,i){function n(){for(var e=6*r,n=1;n<r;++n)for(var a=0;a<6;++a)h.push(t[a].replace("%m",n.toString()));var l=function(){s._notifyFailure("Failed loading texture")},u=function(){o[this.nextID].src=s.path+h[this.nextID]},c=function(){for(var t=0;t<r;++t)i.uploadImagesToMipLevel(o.slice(6*t,6*t+6),t);i._isReady=!0,s._notifyComplete(i)};for(n=1;n<e;++n){var _=new Image;_.nextID=n+1,n<e-1?_.onload=u:_.onload=c,_.onError=l,o[n]=_}o[1].src=s.path+h[1]}for(var r,o=[],s=this,a=new Image,h=[],l=0;l<6;++l)h[l]=t[l].replace("%m","0");a.onload=function(){a.naturalWidth===a.naturalHeight&&e.isPowerOfTwo(a.naturalWidth)?(r=e.log2(a.naturalWidth)+1,n(),o[0]=a):s._notifyFailure("Failed loading mipchain: incorrect dimensions")},a.onerror=function(){s._notifyFailure("Failed loading texture")},a.src=s.path+h[0]},e.HMT=function(){e.Importer.call(this,e.Material),e.HMT._initPropertyMap()},e.HMT.prototype=Object.create(e.Importer.prototype),e.HMT.prototype.parse=function(t,e){t=JSON.parse(t),this._loadShaders(t,e)},e.HMT.prototype._gatherShaderFiles=function(t){var e=[],i=t.geometry,n=i.vertexShader,r=i.fragmentShader,o=t.lightingModel;return e.indexOf(n)<0&&e.push(this._correctURL(n)),e.indexOf(r)<0&&e.push(this._correctURL(r)),o&&e.indexOf(o)<0&&e.push(this._correctURL(o)),e},e.HMT.prototype._loadShaders=function(t,i){var n={},r=this._gatherShaderFiles(t),o=new e.BulkURLLoader,s=this;o.onComplete=function(){for(var e=0;e<r.length;++e)n[r[e]]=o.getData(r[e]);s._processMaterial(t,n,i),s._loadTextures(t,i)},o.onFail=function(t){s._notifyFailure("Error loading shaders: "+t)},o.load(r)},e.HMT.prototype._processMaterial=function(t,i,n){var r="";if(this.options.defines)for(var o in this.options.defines)this.options.defines.hasOwnProperty(o)&&(r+="#define "+o+" "+this.options.defines[o]+"\n");var s=r+i[this._correctURL(t.geometry.vertexShader)],a=r+i[this._correctURL(t.geometry.fragmentShader)];if(n._geometryVertexShader=s,n._geometryFragmentShader=a,n.init(),t.lightingModel&&(n.lightingModel=i[this._correctURL(t.lightingModel)]),this._applyUniforms(t,n),n.setTexture("hx_dither2D",e.DEFAULT_2D_DITHER_TEXTURE),t.hasOwnProperty("elementType")&&(n.elementType=e.HMT._PROPERTY_MAP[t.elementType]),t.hasOwnProperty("cullMode")&&(n.cullMode=e.HMT._PROPERTY_MAP[t.cullMode]),t.hasOwnProperty("writeDepth")&&(n.writeDepth=t.writeDepth),t.hasOwnProperty("blend")){var h=new e.BlendState,l=t.blend;l.hasOwnProperty("source")&&(h.srcFactor=e.HMT._PROPERTY_MAP[l.source]),l.hasOwnProperty("destination")&&(h.dstFactor=e.HMT._PROPERTY_MAP[l.destination]),l.hasOwnProperty("operator")&&(h.operator=e.HMT._PROPERTY_MAP[l.operator]),n.blendState=h}},e.HMT.prototype._applyUniforms=function(t,e){if(t.uniforms)for(var i in t.uniforms)if(t.uniforms.hasOwnProperty(i)){var n=t.uniforms[i];isNaN(n)?e.setUniform(i,{x:n[0],y:n[1],z:n[2],w:n[3]},!1):e.setUniform(i,n,!1)}},e.HMT.prototype._loadTextures=function(t,i){var n=[];for(var r in t.textures)t.textures.hasOwnProperty(r)&&(n.push(this._correctURL(t.textures[r])),i.setTexture(r,e.Texture2D.DEFAULT));var o=new e.BulkAssetLoader,s=this;o.onComplete=function(){for(var e in t.textures)t.textures.hasOwnProperty(e)&&i.setTexture(e,o.getAsset(s._correctURL(t.textures[e])));s._notifyComplete(i)},o.onFail=function(t){s._notifyFailure(t)},o.load(n,e.JPG)},e.HMT._PROPERTY_MAP=null,e.HMT._initPropertyMap=function(){e.HMT._PROPERTY_MAP=e.HMT._PROPERTY_MAP||{back:e.CullMode.BACK,front:e.CullMode.FRONT,both:e.CullMode.ALL,none:null,lines:e.ElementType.LINES,points:e.ElementType.POINTS,triangles:e.ElementType.TRIANGLES,one:e.BlendFactor.ONE,zero:e.BlendFactor.ZERO,sourceColor:e.BlendFactor.SOURCE_COLOR,oneMinusSourceColor:e.BlendFactor.ONE_MINUS_SOURCE_COLOR,sourceAlpha:e.BlendFactor.SOURCE_ALPHA,oneMinusSourceAlpha:e.BlendFactor.ONE_MINUS_SOURCE_ALPHA,destinationAlpha:e.BlendFactor.DST_ALPHA,oneMinusDestinationAlpha:e.BlendFactor.ONE_MINUS_DESTINATION_ALPHA,destinationColor:e.BlendFactor.DESTINATION_COLOR,sourceAlphaSaturate:e.BlendFactor.SOURCE_ALPHA_SATURATE,add:e.BlendOperation.ADD,subtract:e.BlendOperation.SUBTRACT,reverseSubtract:e.BlendOperation.REVERSE_SUBTRACT,always:e.Comparison.ALWAYS,disabled:e.Comparison.DISABLED,equal:e.Comparison.EQUAL,greater:e.Comparison.GREATER,greaterEqual:e.Comparison.GREATER_EQUAL,less:e.Comparison.LESS,lessEqual:e.Comparison.LESS_EQUAL,never:e.Comparison.NEVER,notEqual:e.Comparison.NOT_EQUAL}},e.HSC=function(){e.Importer.call(this,e.Scene)},e.HSC.prototype=Object.create(e.Importer.prototype),e.HSC.prototype.parse=function(t,e){var i=JSON.parse(t);if("0.1"!==i.version)throw new Error("Incompatible file format version!");var n=this._processObjects(i.objects,e);this._processConnections(i.connections,n),this._notifyComplete(e)},e.HSC.prototype._processObjects=function(t,i){for(var n=[],r=t.length,o=0;o<r;++o){var s,a=t[o];switch(a.type){case"scene":s=i;break;case"mesh":s=this._processMesh(a);break;case"model":s=new e.ModelData;break;case"modelinstance":s=this._processModelInstance(a);break;case"material":s=this._processMaterial(a);break;case"dirlight":s=this._processDirLight(a);break;case"ptlight":s=this._processPointLight(a);break;case"amblight":s=this._processAmbientLight(a);break;default:console.warn("Unsupported object of type "+a.type),s=null}s&&(s.name=a.name,n[a.id]=s),n.push(s)}return n},e.HSC.prototype._processMesh=function(t){var i=new e.MeshData,n=t.numVertices,r=t.vertexData,o=[];for(var s in r)if(r.hasOwnProperty(s)){var a=r[s];i.addVertexAttribute(s,a.length/n,0),o.push(a)}var h=0,l=!r.hasOwnProperty("hx_normal"),u=!r.hasOwnProperty("hx_tangent");l&&(i.addVertexAttribute("hx_normal",3),h|=e.NormalTangentGenerator.MODE_NORMALS),u&&(i.addVertexAttribute("hx_tangent",4),h|=e.NormalTangentGenerator.MODE_TANGENTS);for(var c=[],_=0,d=0;d<n;++d){for(var f=0;f<o.length;++f)for(var p=o[f],m=p.length/n,g=0;g<m;++g)c[_++]=p[d*m+g];var x=l?3:0;for(x+=u?4:0,f=0;f<x;++f)c[_++]=0}if(i.setIndexData(t.indexData),i.setVertexData(c,0),h){var S=new e.NormalTangentGenerator;S.generate(i,h)}return i},e.HSC.prototype._processMaterial=function(t){var i=new e.BasicMaterial;return t.hasOwnProperty("color")&&(i.color=new e.Color(t.color[0],t.color[1],t.color[2])),t.hasOwnProperty("metallicness")&&(i.metallicness=t.metallicness),t.hasOwnProperty("normalSpecularReflectance")&&(i.normalSpecularReflectance=t.normalSpecularReflectance),t.hasOwnProperty("refractiveRatio")&&(i.refractiveRatio=t.refractiveRatio,i.refract=1!==t.refractiveRatio),t.hasOwnProperty("transparent")&&(i.transparent=t.transparent),t.hasOwnProperty("alpha")&&(i.alpha=t.alpha),t.hasOwnProperty("alphaThreshold")&&(i.alphaThreshold=t.alphaThreshold),t.hasOwnProperty("roughness")&&(i.roughness=t.roughness),t.hasOwnProperty("roughnessRange")&&(i.roughnessRange=t.roughnessRange),t.hasOwnProperty("specularMapMode")&&(i.specularMapMode=t.specularMapMode),i},e.HSC.prototype._processDirLight=function(t){var i=new e.DirectionalLight;return this._processLight(t,i),t.hasOwnProperty("direction")&&(i.direction=new e.Float4(t.direction[0],t.direction[1],t.direction[2])),t.hasOwnProperty("shadows")&&(i.castShadows=t.shadows),i},e.HSC.prototype._processPointLight=function(t){var i=new e.PointLight;return this._processLight(t,i),t.hasOwnProperty("radius")&&(i.radius=t.radius),i},e.HSC.prototype._processAmbientLight=function(t){var i=new e.AmbientLight;return this._processLight(t,i),i},e.HSC.prototype._processLight=function(t,i){this._processSceneNode(t,i),t.hasOwnProperty("color")&&(i.color=new e.Color(t.color[0],t.color[1],t.color[2])),t.hasOwnProperty("intensity")&&(i.intensity=t.intensity)},e.HSC.prototype._processModelInstance=function(t){var i=new e.ModelInstance;return this._processSceneNode(t,i),i},e.HSC.prototype._processSceneNode=function(t,i){t.hasOwnProperty("matrix")?i.transform=new e.Matrix4x4(t.matrix):(t.hasOwnProperty("position")&&(i.position.x=t.position[0],i.position.y=t.position[1],i.position.z=t.position[2]),t.hasOwnProperty("rotation")&&(i.rotation.x=t.rotation[0],i.rotation.y=t.rotation[1],i.rotation.z=t.rotation[2],i.rotation.w=t.rotation[3]),t.hasOwnProperty("scale")&&(i.scale.x=t.scale[0],i.scale.y=t.scale[1],i.scale.z=t.scale[2]))},e.HSC.prototype._processConnections=function(t,i){for(var n=[],r=[],o=t.length,s=0;s<o;++s){var a=t[s].p,h=t[s].c,l=i[a],u=i[h];u instanceof e.MeshData?l.addMeshData(u):u instanceof e.ModelData?n.push({c:h,p:t[s].p}):u instanceof e.SceneNode?l.attach(u):u instanceof e.Material&&(r[a]=r[a]||[],r[a].push(u))}for(o=n.length,s=0;s<o;++s){var c=i[n[s].p],_=i[n[s].c],d=new e.Model(_);c.init(d,r[n[s].p])}},e.JPG_EQUIRECTANGULAR=function(){e.Importer.call(this,e.TextureCube,e.Importer.TYPE_IMAGE)},e.JPG_EQUIRECTANGULAR.prototype=Object.create(e.Importer.prototype),e.JPG_EQUIRECTANGULAR.prototype.parse=function(t,i){var n=new e.Texture2D;n.wrapMode=e.TextureWrapMode.REPEAT,n.uploadImage(t,t.naturalWidth,t.naturalHeight,!0);var r=void 0===this.options.generateMipmaps||this.options.generateMipmaps;e.EquirectangularTexture.toCube(n,this.options.size,r,i),n.dispose(),this._notifyComplete(i)},e.PNG_EQUIRECTANGULAR=e.JPG_EQUIRECTANGULAR,e.JPG_HEIGHTMAP=function(){e.Importer.call(this,e.Texture2D,e.Importer.TYPE_IMAGE)},e.JPG_HEIGHTMAP.prototype=Object.create(e.Importer.prototype),e.JPG_HEIGHTMAP.prototype.parse=function(t,i){var n=new e.Texture2D;n.wrapMode=e.TextureWrapMode.REPEAT,n.uploadImage(t,t.naturalWidth,t.naturalHeight,!0);var r=void 0===this.options.generateMipmaps||this.options.generateMipmaps;e.HeightMap.from8BitTexture(n,r,i),n.dispose(),this._notifyComplete(i)},e.PNG_HEIGHTMAP=e.JPG_HEIGHTMAP,e.JPG=function(){e.Importer.call(this,e.Texture2D,e.Importer.TYPE_IMAGE)},e.JPG.prototype=Object.create(e.Importer.prototype),e.JPG.prototype.parse=function(t,e){var i=void 0===this.options.generateMipmaps||this.options.generateMipmaps;e.uploadImage(t,t.naturalWidth,t.naturalHeight,i),this._notifyComplete(e)},e.PNG=e.JPG,e.BasicMaterial=function(t){e.Material.call(this),t=t||{},this._color=t.color||new e.Color(1,1,1,1),this._colorMap=t.colorMap||null,this._doubleSided=!!t.doubleSided,this._normalMap=t.normalMap||null,this._specularMap=t.specularMap||null,this._maskMap=t.maskMap||null,this._specularMapMode=t.specularMapMode||e.BasicMaterial.SPECULAR_MAP_ROUGHNESS_ONLY,this._metallicness=void 0===t.metallicness?0:t.metallicness,this._alpha=void 0===t.alpha?1:t.alpha,this._roughness=void 0===t.roughness?.5:t.roughness,this._roughnessRange=void 0===t.roughnessRange?.5:t.roughnessRange,this._normalSpecularReflectance=void 0===t.normalSpecularReflectance?.027:t.normalSpecularReflectance,this._alphaThreshold=void 0===t.alphaThreshold?1:t.alphaThreshold,this._useVertexColors=!!t.useVertexColors,this.color=this._color,this.alpha=this._alpha,this.metallicness=this._metallicness,this.roughness=this._roughness,this.normalSpecularReflectance=this._normalSpecularReflectance,void 0!==t.lightingModel&&(this.lightingModel=t.lightingModel)},e.BasicMaterial.roughnessFromShininess=function(t){return Math.sqrt(2/(t+2))},e.BasicMaterial.SPECULAR_MAP_ROUGHNESS_ONLY=1,e.BasicMaterial.SPECULAR_MAP_ALL=2,e.BasicMaterial.SPECULAR_MAP_SHARE_NORMAL_MAP=3,e.BasicMaterial.prototype=Object.create(e.Material.prototype,{doubleSided:{get:function(){return this._doubleSided},set:function(t){this._doubleSided=t;for(var i=0;i<e.MaterialPass.NUM_PASS_TYPES;++i)this._passes[i]&&(this._passes[i].cullMode=t?e.CullMode.NONE:e.CullMode.BACK)}},alpha:{get:function(){return this._alpha},set:function(t){this._alpha=e.saturate(t),this.setUniform("alpha",this._alpha)}},useVertexColors:{get:function(){return this._useVertexColors},set:function(t){this._useVertexColors!==t&&this._invalidate(),this._useVertexColors=t}},color:{get:function(){return this._color},set:function(t){this._color=isNaN(t)?t:new e.Color(t),this.setUniform("color",this._color)}},colorMap:{get:function(){return this._colorMap},set:function(t){!!this._colorMap!=!!t&&this._invalidate(),this._colorMap=t,this.setTexture("colorMap",t)}},normalMap:{get:function(){return this._normalMap},set:function(t){!!this._normalMap!=!!t&&this._invalidate(),this.setTexture("normalMap",t),this._normalMap=t}},specularMap:{get:function(){return this._specularMap},set:function(t){!!this._specularMap!=!!t&&this._invalidate(),this.setTexture("specularMap",t),this._specularMap=t}},maskMap:{get:function(){return this._maskMap},set:function(t){!!this._maskMap!=!!t&&this._invalidate(),this.setTexture("maskMap",t),this._maskMap=t}},specularMapMode:{get:function(){return this._specularMapMode},set:function(t){this._specularMapMode!==t&&this._invalidate(),this._specularMapMode=t}},metallicness:{get:function(){return this._metallicness},set:function(t){this._metallicness=e.saturate(t),this.setUniform("metallicness",this._metallicness)}},normalSpecularReflectance:{get:function(){return this._normalSpecularReflectance},set:function(t){this._normalSpecularReflectance=e.saturate(t),this.setUniform("normalSpecularReflectance",this._normalSpecularReflectance)}},roughness:{get:function(){return this._roughness},set:function(t){this._roughness=t,this.setUniform("roughness",this._roughness)}},roughnessRange:{get:function(){return this._roughnessRange},set:function(t){this._roughnessRange=t,this.setUniform("roughnessRange",2*this._roughnessRange)}},alphaThreshold:{get:function(){return this._alphaThreshold},set:function(t){t=e.saturate(t),1===this._alphaThreshold!=(1===t)&&this._invalidate(),this._alphaThreshold=t,this.setUniform("alphaThreshold",t)}}}),e.BasicMaterial.prototype.init=function(){var t=this._generateDefines();this._geometryVertexShader=e.ShaderLibrary.get("default_geometry_vertex.glsl",t),this._geometryFragmentShader=e.ShaderLibrary.get("default_geometry_fragment.glsl",t),e.Material.prototype.init.call(this)},e.BasicMaterial.prototype._generateDefines=function(){var t={};switch(this._colorMap&&(t.COLOR_MAP=1),this._useVertexColors&&(t.VERTEX_COLORS=1),this._normalMap&&(t.NORMAL_MAP=1),this._maskMap&&(t.MASK_MAP=1),this._alphaThreshold<1&&(t.ALPHA_THRESHOLD=1),this._useSkinning&&(t.HX_USE_SKINNING=1),this._useMorphing&&(t.HX_USE_MORPHING=1,t.HX_NUM_MORPH_TARGETS=e.NUM_MORPH_TARGETS),this._specularMapMode){case e.BasicMaterial.SPECULAR_MAP_ROUGHNESS_ONLY:this._specularMap&&(t.ROUGHNESS_MAP=1);break;case e.BasicMaterial.SPECULAR_MAP_ALL:this._specularMap&&(t.SPECULAR_MAP=1);break;default:t.NORMAL_ROUGHNESS_MAP=1}return t},e.BasicMaterial.prototype._setUseSkinning=function(t){this._useSkinning!==t&&this._invalidate(),this._useSkinning=t},e.DirectionalShadowPass=function(t,i){e.MaterialPass.call(this,this._generateShader(t,i))},e.DirectionalShadowPass.prototype=Object.create(e.MaterialPass.prototype),e.DirectionalShadowPass.prototype._generateShader=function(t,i){var n=e.ShaderLibrary.get("snippets_geometry.glsl")+"\n"+e.DirectionalLight.SHADOW_FILTER.getGLSL()+"\n"+i+"\n"+e.ShaderLibrary.get("material_dir_shadow_fragment.glsl"),r=t+"\n"+e.ShaderLibrary.get("material_unlit_vertex.glsl");return new e.Shader(r,n)},e.NormalDepthPass=function(t,i){e.MaterialPass.call(this,this._generateShader(t,i))},e.NormalDepthPass.prototype=Object.create(e.MaterialPass.prototype),e.NormalDepthPass.prototype._generateShader=function(t,i){var n=e.ShaderLibrary.get("snippets_geometry.glsl")+"\n"+i+"\n"+e.ShaderLibrary.get("material_normal_depth_fragment.glsl"),r=t+"\n"+e.ShaderLibrary.get("material_normal_depth_vertex.glsl");return new e.Shader(r,n)},e.SkyboxMaterial=function(t){e.Material.call(this);var i=e.ShaderLibrary.get("default_skybox_vertex.glsl"),n=e.ShaderLibrary.get("default_skybox_fragment.glsl");this.writeDepth=!1,this.cullMode=e.CullMode.NONE;var r=new e.UnlitPass(i,n);this.setPass(e.MaterialPass.BASE_PASS,r),this._initialized=!0,this._renderOrder=Number.POSITIVE_INFINITY,this.setTexture("hx_skybox",t)},e.SkyboxMaterial.prototype=Object.create(e.Material.prototype),e.StaticLitPass=function(t,i,n,r,o){this._dirLights=null,this._dirLightCasters=null,this._pointLights=null,this._diffuseLightProbes=null,this._specularLightProbes=null,this._maxCascades=0,e.MaterialPass.call(this,this._generateShader(t,i,n,r,o)),this._ssaoSlot=this.getTextureSlot("hx_ssao"),this._assignShadowMaps(),this._assignLightProbes()},e.StaticLitPass.prototype=Object.create(e.MaterialPass.prototype),e.StaticLitPass.prototype.updatePassRenderState=function(t){var i=t._camera;this.setUniform("hx_ambientColor",t._renderCollector.ambientColor),this._assignDirLights(i),this._assignDirLightCasters(i),this._assignPointLights(i),this._assignLightProbes(i),e.MaterialPass.prototype.updatePassRenderState.call(this,t)},e.StaticLitPass.prototype._generateShader=function(t,i,n,r,o){this._dirLights=[],this._dirLightCasters=[],this._pointLights=[],this._diffuseLightProbes=[],this._specularLightProbes=[],this._maxCascades=0;for(var s=0;s<r.length;++s){var a=r[s];a instanceof e.DirectionalLight?a.castShadows?(this._dirLightCasters.push(a),a.numCascades>this._maxCascades&&(this._maxCascades=a.numCascades)):this._dirLights.push(a):a instanceof e.PointLight?this._pointLights.push(a):a instanceof e.LightProbe&&(a.diffuseTexture&&this._diffuseLightProbes.push(a),a.specularTexture&&this._specularLightProbes.push(a))}var h=[],l={HX_NUM_DIR_LIGHTS:this._dirLights.length,HX_NUM_DIR_LIGHT_CASTERS:this._dirLightCasters.length,HX_NUM_POINT_LIGHTS:this._pointLights.length,HX_NUM_DIFFUSE_PROBES:this._diffuseLightProbes.length,HX_NUM_SPECULAR_PROBES:this._specularLightProbes.length,HX_MAX_CASCADES:this._maxCascades,HX_APPLY_SSAO:o?1:0};e.EXT_SHADER_TEXTURE_LOD&&l.HX_NUM_SPECULAR_PROBES>0&&(l.HX_TEXTURE_LOD=1,h+="#texturelod\n");var u=h+e.ShaderLibrary.get("snippets_geometry.glsl")+"\n"+n+"\n\n\n"+e.DirectionalLight.SHADOW_FILTER.getGLSL()+"\n"+e.ShaderLibrary.get("directional_light.glsl",l)+"\n"+e.ShaderLibrary.get("point_light.glsl")+"\n"+e.ShaderLibrary.get("light_probe.glsl")+"\n"+i+"\n"+e.ShaderLibrary.get("material_lit_static_fragment.glsl"),c=t+"\n"+e.ShaderLibrary.get("material_lit_static_vertex.glsl",l);
return new e.Shader(c,u)},e.StaticLitPass.prototype._assignDirLights=function(t){var i=this._dirLights;if(i)for(var n=new e.Float4,r=i.length,o=0;o<r;++o){var s=i[o];t.viewMatrix.transformVector(s.direction,n),this.setUniform("hx_directionalLights["+o+"].color",s._scaledIrradiance),this.setUniform("hx_directionalLights["+o+"].direction",n)}},e.StaticLitPass.prototype._assignDirLightCasters=function(t){var i=this._dirLightCasters;if(i)for(var n=new e.Float4,r=i.length,o=new e.Matrix4x4,s=new Float32Array(64),a=0;a<r;++a){var h=i[a];t.viewMatrix.transformVector(h.direction,n),this.setUniform("hx_directionalLightCasters["+a+"].color",h._scaledIrradiance),this.setUniform("hx_directionalLightCasters["+a+"].direction",n);for(var l=h._shadowMapRenderer,u=l._numCascades,c=l._splitDistances,_=0,d=0;d<u;++d){o.multiply(l.getShadowMatrix(d),t.worldMatrix);for(var f=o._m,p=0;p<16;++p)s[_++]=f[p]}this.setUniformArray("hx_directionalLightCasters["+a+"].shadowMapMatrices",s),this.setUniform("hx_directionalLightCasters["+a+"].splitDistances",c),this.setUniform("hx_directionalLightCasters["+a+"].depthBias",h.depthBias),this.setUniform("hx_directionalLightCasters["+a+"].maxShadowDistance",c[u-1])}},e.StaticLitPass.prototype._assignPointLights=function(t){var i=this._pointLights;if(i)for(var n=new e.Float4,r=i.length,o=0;o<r;++o){var s=i[o];s.worldMatrix.getColumn(3,n),t.viewMatrix.transformPoint(n,n),this.setUniform("hx_pointLights["+o+"].color",s._scaledIrradiance),this.setUniform("hx_pointLights["+o+"].position",n),this.setUniform("hx_pointLights["+o+"].radius",s.radius)}},e.StaticLitPass.prototype._assignShadowMaps=function(){var t=this._dirLightCasters,e=t.length;if(e>0){for(var i=[],n=0;n<e;++n){var r=t[n],o=r._shadowMapRenderer;i[n]=o._shadowMap}this.setTextureArray("hx_directionalShadowMaps",i)}},e.StaticLitPass.prototype._assignLightProbes=function(){for(var t=[],i=[],n=this._diffuseLightProbes,r=n.length,o=0;o<r;++o)t[o]=n[o].diffuseTexture;n=this._specularLightProbes,r=n.length;var s=[];for(o=0;o<r;++o)i[o]=n[o].specularTexture,s[o]=Math.floor(e.log2(i[o].size));t.length>0&&this.setTextureArray("hx_diffuseProbeMaps",t),i.length>0&&(this.setTextureArray("hx_specularProbeMaps",i),this.setUniformArray("hx_specularProbeNumMips",new Float32Array(s)))},e.StaticLitPass.prototype._setSSAOTexture=function(t){this._ssaoSlot.texture=t},e.TextureSlot=function(){this.location=-1,this.texture=null,this.name=null,this.index=-1},e.UnlitPass=function(t,i){e.MaterialPass.call(this,this._generateShader(t,i))},e.UnlitPass.prototype=Object.create(e.MaterialPass.prototype),e.UnlitPass.prototype._generateShader=function(t,i){var n=e.ShaderLibrary.get("snippets_geometry.glsl")+"\n"+i+"\n"+e.ShaderLibrary.get("material_unlit_fragment.glsl"),r=t+"\n"+e.ShaderLibrary.get("material_unlit_vertex.glsl");return new e.Shader(r,n)},e.Mesh=function(t,i){this._model=i,this._vertexBuffers=[],this._vertexStrides=[],this._vertexAttributes=null,this._morphAttributes=null,this._indexBuffer=new e.IndexBuffer,this._defaultMorphTarget=null,this._renderOrderHint=++e.Mesh.ID_COUNTER,this.updateMeshData(t)},e.Mesh.ID_COUNTER=0,e.Mesh.prototype={constructor:e.Mesh,get hasMorphData(){return!!this._morphAttributes},updateMeshData:function(t){var i=t.numStreams,n=this._vertexBuffers.length;if(i>n)for(var r=n;r<i;++r)t.hasVertexData(r)&&(this._vertexBuffers[r]=new e.VertexBuffer);else i<n&&(this._vertexBuffers.length=i,this._vertexStrides.length=i);for(r=0;r<i;++r)t.hasVertexData(r)&&this._vertexBuffers[r].uploadData(t.getVertexData(r),t.vertexUsage),this._vertexStrides[r]=t.getVertexStride(r);this._numIndices=t._indexData.length,this._numVertices=t.numVertices,this._indexBuffer.uploadData(t._indexData,t.indexUsage),this._vertexAttributes=t._vertexAttributes,this._morphAttributes=t._morphAttributes,this._morphAttributes&&(this._defaultMorphTarget=new e.VertexBuffer,this._defaultMorphTarget.uploadData(t._defaultMorphTarget))},dispose:function(){for(var t=0;t<this._vertexBuffers.length;++t)this._vertexBuffers[t].dispose();this._indexBuffer.dispose()},get numVertices(){return this._numVertices},get numIndices(){return this._numIndices},get numVertexAttributes(){return this._vertexAttributes.length},getVertexStride:function(t){return this._vertexStrides[t]},getVertexAttribute:function(t){return this._vertexAttributes[t]}},e.MeshBatch={create:function(t,i){var n,r,o,s=new e.MeshData,a=t._indexData;s.vertexUsage=t.vertexUsage,s.indexUsage=t.indexUsage;var h=t._vertexAttributes,l=t.numStreams;for(r=0;r<h.length;++r){var u=h[r];s.addVertexAttribute(u.name,u.numComponents,u.streamIndex)}s.addVertexAttribute("hx_instanceID",1,l);var c=[],_=0,d=t.numVertices;for(n=a.length,r=0;r<i;++r)for(o=0;o<n;++o)c[_++]=a[o]+d*r;for(s.setIndexData(c),r=0;r<t.numStreams;++r){var f=[],p=t.getVertexData(r);for(n=p.length,_=0,o=0;o<i;++o)for(var m=0;m<n;++m)f[_++]=p[m];s.setVertexData(f,r)}var g=[];for(_=0,o=0;o<i;++o)for(r=0;r<d;++r)g[_++]=o;return s.setVertexData(g,l),s}},e.MeshData=function(){this._vertexStrides=[],this._vertexData=[],this._indexData=void 0,this.vertexUsage=i.STATIC_DRAW,this.indexUsage=i.STATIC_DRAW,this._vertexAttributes=[],this._defaultMorphTarget=null,this._numStreams=0},e.MeshData.DEFAULT_VERTEX_SIZE=12,e.MeshData.createDefaultEmpty=function(){var t=new e.MeshData;return t.addVertexAttribute("hx_position",3),t.addVertexAttribute("hx_normal",3),t.addVertexAttribute("hx_tangent",4),t.addVertexAttribute("hx_texCoord",2),t},e.MeshData.prototype={constructor:e.MeshData,hasVertexData:function(t){return!!this._vertexData[t]},getVertexData:function(t){return this._vertexData[t]},setVertexData:function(t,e){this._vertexData[e||0]=new Float32Array(t)},setIndexData:function(t){this._indexData=new Uint16Array(t)},addVertexAttribute:function(t,e,i){"hx_morphUV"===t&&(this._hasMorphUVs=!0),i=i||0,this._numStreams=Math.max(this._numStreams,i+1),this._vertexStrides[i]=this._vertexStrides[i]||0,this._vertexAttributes.push({name:t,offset:this._vertexStrides[i],numComponents:e,streamIndex:i}),this._vertexStrides[i]+=e},getVertexAttribute:function(t){for(var e=this._vertexAttributes.length,i=0;i<e;++i)if(this._vertexAttributes[i].name===t)return this._vertexAttributes[i]},getVertexStride:function(t){return this._vertexStrides[t]},get numStreams(){return this._numStreams},get numVertices(){return this._vertexData[0].length/this._vertexStrides[0]},extractAttributeData:function(t){for(var e=this.getVertexAttribute(t),i=this.getVertexStride(e),n=this.getVertexData(e.streamIndex),r=e.numComponents,o=[],s=0,a=e.offset;a<n.length;a+=i)for(var h=0;h<r;++h)o[s++]=n[a+h];return o},generateMorphData:function(){this._morphAttributes=[];for(var t=[],i=0;i<this.numVertices;++i)t.push(0,0,0);for(this._defaultMorphTarget=new Float32Array(t),i=0;i<e.NUM_MORPH_TARGETS;++i)this.addVertexAttribute("hx_morphPosition"+i,3,this.numStreams),this._morphAttributes[i]=this._vertexAttributes[this._vertexAttributes.length-1]}},e.MeshInstance=function(t,i){if(this._mesh=t,this._meshMaterialLinkInvalid=!1,this._vertexLayouts=null,this._visible=!0,t.hasMorphData){this._morphTargets=[];for(var n=[],r=0;r<e.NUM_MORPH_TARGETS;++r)n[r]=0;this._morphWeights=new Float32Array(n)}this.material=i},e.MeshInstance.prototype={constructor:e.MeshInstance,get visible(){return this._visible},set visible(t){this._visible=t},setMorphTarget:function(t,e,i){this._morphTargets[t]=e,this._morphWeights[t]=e?i:0},get material(){return this._material},set material(t){this._material&&this._material.onChange.unbind(this._onMaterialChange),this._material=t,this._material&&(this._material.onChange.bind(this._onMaterialChange,this),this.material._setUseSkinning(this._material._useSkinning||!!this._mesh._model.skeleton),this.material._setUseMorphing(this._material._useMorphing||this._mesh.hasMorphData)),this._meshMaterialLinkInvalid=!0},updateRenderState:function(t){this._meshMaterialLinkInvalid&&this._linkMeshWithMaterial();var n=this._mesh._vertexBuffers;this._mesh._indexBuffer.bind();for(var r,o=this._vertexLayouts[t],s=o.morphAttributes,a=s.length,h=0;h<a;++h){var r=s[h],l=this._morphTargets[h]||this._mesh._defaultMorphTarget;l.bind(),i.vertexAttribPointer(r.index,r.numComponents,i.FLOAT,!1,r.stride,r.offset)}var u=o.attributes;for(a=u.length,h=0;h<a;++h)r=u[h],n[r.streamIndex].bind(),i.vertexAttribPointer(r.index,r.numComponents,i.FLOAT,!1,r.stride,r.offset);e.enableAttributes(o._numAttributes)},_initVertexLayouts:function(){this._vertexLayouts=new Array(e.MaterialPass.NUM_PASS_TYPES);for(var t=0;t<e.MaterialPass.NUM_PASS_TYPES;++t){var i=this._material.getPass(t);i&&(this._vertexLayouts[t]=new e.VertexLayout(this._mesh,i))}},_linkMeshWithMaterial:function(){this._initVertexLayouts(),this._meshMaterialLinkInvalid=!1},_onMaterialChange:function(){this._meshMaterialLinkInvalid=!0}},e.ModelData=function(){this._meshDataList=[],this._joints=[],this.skeleton=null},e.ModelData.prototype={constructor:e.ModelData,get numMeshes(){return this._meshDataList.length},getMeshData:function(t){return this._meshDataList[t]},addMeshData:function(t){this._meshDataList.push(t)},addJoint:function(t){this._joints.push(t)},get hasSkeleton(){return this._joints.length>0}},e.ModelInstance=function(t,i){e.Entity.call(this),this._meshBounds=new e.BoundingAABB,this._model=null,this._meshInstances=[],this._castShadows=!0,this._skeletonPose=null,this._morphPose=null,this.init(t,i)},e.ModelInstance.prototype=Object.create(e.Entity.prototype,{model:{get:function(){return this._model}},castShadows:{get:function(){return this._castShadows},set:function(t){this._castShadows=t}},numMeshInstances:{get:function(){return this._meshInstances.length}},skeleton:{get:function(){return this._model.skeleton}},skeletonMatrices:{get:function(){return this._skeletonPose},set:function(t){this._skeletonPose=t}},morphPose:{get:function(){return this._morphPose},set:function(t){this._morphPose&&this._morphPose.onChange.unbind(this._onMorphChanged),this._morphPose=t,this._morphPose?(this._morphPose.onChange.bind(this._onMorphChanged,this),this._onMorphChanged()):this._clearMorph()}}}),e.ModelInstance.prototype.init=function(t,e){if(this._model||this._materials)throw new Error("ModelInstance already initialized");this._model=t,e&&(this._materials=e instanceof Array?e:[e]),t&&(t.skeleton&&this._generateDefaultSkeletonPose(),t.onChange.bind(this._onModelChange,this),this._onModelChange()),this._invalidateWorldBounds()},e.ModelInstance.prototype.getMeshInstance=function(t){return this._meshInstances[t]},e.ModelInstance.prototype._generateDefaultSkeletonPose=function(){if(e.OPTIONS.useSkinningTexture)return void(this._skeletonPose=e.DEFAULT_SKINNING_TEXTURE);this._skeletonPose=[];for(var t=0;t<this._model.skeleton.numJoints;++t)this._skeletonPose[t]=new e.Matrix4x4},e.ModelInstance.prototype._addMeshInstance=function(t,i){this._meshInstances.push(new e.MeshInstance(t,i))},e.ModelInstance.prototype._onModelChange=function(){for(var t=this._materials.length-1,e=0;e<this._model.numMeshes;++e)this._addMeshInstance(this._model.getMesh(e),this._materials[Math.min(e,t)]);this._invalidateWorldBounds()},e.ModelInstance.prototype._clearMorph=function(){for(var t=e.NUM_MORPH_TARGETS,i=this._meshInstances.length,n=0;n<t;++n)for(var r=0;r<i;++r)this._meshInstances[r].setMorphTarget(n,null,0)},e.ModelInstance.prototype._onMorphChanged=function(){for(var t=e.NUM_MORPH_TARGETS,i=this._meshInstances.length,n=0;n<t;++n){var r=this._morphPose.getMorphTarget(n);if(r)for(var o=this._morphPose.getWeight(r.name),s=0;s<i;++s){var a=this._meshInstances[s];a.setMorphTarget(n,r.getVertexBuffer(s),o)}else for(var s=0;s<i;++s)this._meshInstances[s].setMorphTarget(n,null,0)}},e.ModelInstance.prototype._updateWorldBounds=function(){this._meshBounds.transformFrom(this._model.localBounds,this.worldMatrix),this._worldBounds.growToIncludeBound(this._meshBounds),e.Entity.prototype._updateWorldBounds.call(this)},e.ModelInstance.prototype.acceptVisitor=function(t){t.visitModelInstance(this,this.worldMatrix,this.worldBounds),e.Entity.prototype.acceptVisitor.call(this,t)},e.ModelInstance.prototype.toString=function(){return"[ModelInstance(name="+this._name+")]"},e.RectMesh={},e.RectMesh.create=function(){var t=new e.MeshData;return t.addVertexAttribute("hx_position",2),t.addVertexAttribute("hx_texCoord",2),t.setVertexData([-1,1,0,1,1,1,1,1,1,-1,1,0,-1,-1,0,0],0),t.setIndexData([0,1,2,0,2,3]),new e.Mesh(t)},e.RectMesh._initDefault=function(){e.RectMesh.DEFAULT=e.RectMesh.create()},e.ScanlineMesh={},e.ScanlineMesh.create=function(t){var i=new e.MeshData;i.addVertexAttribute("hx_position",2);for(var n=2/t,r=[],o=[],s=0,a=0;a<t;a+=2){var h=a/t*2-1,l=h+n;r.push(-1,l,1,l,1,h,-1,h),o.push(s,s+1,s+2,s,s+2,s+3),s+=4}return i.setVertexData(r,0),i.setIndexData(o),new e.Mesh(i)},e.VertexLayout=function(t,e){var i=e.getShader();this.attributes=[],this.morphAttributes=[],this._numAttributes=-1;for(var n=0;n<t.numVertexAttributes;++n){var r=t.getVertexAttribute(n),o=i.getAttributeLocation(r.name);if(o>=0){var s=t.getVertexStride(r.streamIndex),a={index:o,offset:4*r.offset,numComponents:r.numComponents,stride:4*s,streamIndex:r.streamIndex};0===r.name.indexOf("hx_morph")?this.morphAttributes.push(a):this.attributes.push(a),this._numAttributes=Math.max(this._numAttributes,o+1)}}},e.VertexLayout.prototype={constructor:e.VertexLayout},e.BlendState=function(t,i,n,r){this.enabled=!0,this.srcFactor=t||e.BlendFactor.ONE,this.dstFactor=i||e.BlendFactor.ZERO,this.operator=n||e.BlendOperation.ADD,this.color=r||null},e.BlendState._initDefaults=function(){e.BlendState.ADD=new e.BlendState(e.BlendFactor.SOURCE_ALPHA,e.BlendFactor.ONE),e.BlendState.ADD_NO_ALPHA=new e.BlendState(e.BlendFactor.ONE,e.BlendFactor.ONE),e.BlendState.MULTIPLY=new e.BlendState(e.BlendFactor.DESTINATION_COLOR,e.BlendFactor.ZERO),e.BlendState.ALPHA=new e.BlendState(e.BlendFactor.SOURCE_ALPHA,e.BlendFactor.ONE_MINUS_SOURCE_ALPHA),e.BlendState.INV_ALPHA=new e.BlendState(e.BlendFactor.ONE_MINUS_SOURCE_ALPHA,e.BlendFactor.SOURCE_ALPHA)},e.CascadeShadowCasterCollector=function(t){e.SceneVisitor.call(this),this._renderCameras=null,this._bounds=new e.BoundingAABB,this._numCascades=t,this._cullPlanes=null,this._splitPlanes=null,this._numCullPlanes=0,this._renderLists=[],this._renderItemPool=new e.RenderItemPool},e.CascadeShadowCasterCollector.prototype=Object.create(e.SceneVisitor.prototype),e.CascadeShadowCasterCollector.prototype.getRenderList=function(t){return this._renderLists[t]},e.CascadeShadowCasterCollector.prototype.collect=function(t,e){this._collectorCamera=t,this._bounds.clear(),this._renderItemPool.reset();for(var i=0;i<this._numCascades;++i)this._renderLists[i]=[];e.acceptVisitor(this)},e.CascadeShadowCasterCollector.prototype.getBounds=function(){return this._bounds},e.CascadeShadowCasterCollector.prototype.setRenderCameras=function(t){this._renderCameras=t},e.CascadeShadowCasterCollector.prototype.setCullPlanes=function(t,e){this._cullPlanes=t,this._numCullPlanes=e},e.CascadeShadowCasterCollector.prototype.setSplitPlanes=function(t){this._splitPlanes=t},e.CascadeShadowCasterCollector.prototype.visitModelInstance=function(t,i,n){if(t._castShadows!==!1){this._bounds.growToIncludeBound(n);for(var r=e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS,o=this._numCascades,s=t.numMeshInstances,a=t.skeleton,h=t.skeletonMatrices,l=o-1,u=0;u<=l;++u){var c,_=this._renderLists[u],d=this._renderCameras[u];if(c=u===l?e.PlaneSide.BACK:n.classifyAgainstPlane(this._splitPlanes[u]),c!==e.PlaneSide.FRONT){for(var f=0;f<s;++f){var p=t.getMeshInstance(f),m=p.material;if(m.hasPass(r)){var g=this._renderItemPool.getItem();g.pass=m.getPass(r),g.meshInstance=p,g.worldMatrix=i,g.camera=d,g.material=m,g.skeleton=a,g.skeletonMatrices=h,_.push(g)}}if(c===e.PlaneSide.BACK)return}}}},e.CascadeShadowCasterCollector.prototype.qualifies=function(t){return t.visible},e.CascadeShadowMapRenderer=function(t,i,n){this._light=t,this._numCascades=i||3,this._numCascades>4&&(this._numCascades=4),this._shadowMapSize=n||1024,this._shadowMapInvalid=!0,this._fboFront=null,this._fboBack=null,this._depthBuffer=null,this._shadowMap=this._createShadowBuffer(),this._shadowBackBuffer=e.DirectionalLight.SHADOW_FILTER.blurShader?this._createShadowBuffer():null,this._shadowMatrices=[new e.Matrix4x4,new e.Matrix4x4,new e.Matrix4x4,new e.Matrix4x4],this._transformToUV=[new e.Matrix4x4,new e.Matrix4x4,new e.Matrix4x4,new e.Matrix4x4],this._inverseLightMatrix=new e.Matrix4x4,this._splitRatios=null,this._splitDistances=null,this._shadowMapCameras=null,this._collectorCamera=new e.OrthographicOffCenterCamera,this._minZ=0,this._numCullPlanes=0,this._cullPlanes=[],this._localBounds=new e.BoundingAABB,this._casterCollector=new e.CascadeShadowCasterCollector(this._numCascades),this._initSplitProperties(),this._initCameras(),this._viewports=[]},e.CascadeShadowMapRenderer.prototype={get numCascades(){return this._numCascades},set numCascades(t){this._numCascades!==t&&(this._numCascades=t,this._invalidateShadowMap(),this._initSplitProperties(),this._initCameras(),this._casterCollector=new e.CascadeShadowCasterCollector(t))},get shadowMapSize(){return this._shadowMapSize},set shadowMapSize(t){this._shadowMapSize!==t&&(this._shadowMapSize=t,this._invalidateShadowMap())},render:function(t,n){this._shadowMapInvalid&&this._initShadowMap(),this._inverseLightMatrix.inverseAffineOf(this._light.worldMatrix),this._updateCollectorCamera(t),this._updateSplits(t),this._updateCullPlanes(t),this._collectShadowCasters(n),this._updateCascadeCameras(t,this._casterCollector.getBounds()),e.setRenderTarget(this._fboFront);var r=e.MaterialPass.DIR_LIGHT_SHADOW_MAP_PASS;e.setClearColor(e.Color.WHITE),e.clear();for(var o=0;o<this._numCascades;++o){var s=this._viewports[o];i.viewport(s.x,s.y,s.width,s.height),e.RenderUtils.renderPass(this,r,this._casterCollector.getRenderList(o))}e.DirectionalLight.SHADOW_FILTER.blurShader&&this._blur(),e.setRenderTarget(),e.setClearColor(e.Color.BLACK)},_updateCollectorCamera:function(t){var i=t.frustum._corners,n=new e.Float4,r=new e.Float4,o=new e.Float4;this._inverseLightMatrix.transformPoint(i[0],n),r.copyFrom(n);for(var s=1;s<8;++s)this._inverseLightMatrix.transformPoint(i[s],o),n.minimize(o),r.maximize(o);this._minZ=n.z,this._collectorCamera.matrix.copyFrom(this._light.worldMatrix),this._collectorCamera._invalidateWorldMatrix(),this._collectorCamera.setBounds(n.x,r.x+1,r.y+1,n.y),this._collectorCamera._setRenderTargetResolution(this._shadowMap._width,this._shadowMap._height)},_updateSplits:function(t){for(var i=t.nearDistance,n=t.farDistance-i,r=new e.Float4(0,0,(-1),0),o=t.worldMatrix,s=0;s<this._numCascades;++s)this._splitDistances[s]=r.w=-(i+this._splitRatios[s]*n),o.transform(r,this._splitPlanes[s])},_updateCascadeCameras:function(t,i){this._localBounds.transformFrom(i,this._inverseLightMatrix);for(var n=this._localBounds.minimum,r=this._localBounds.maximum,o=1,s=new e.Float4,a=new e.Float4,h=new e.Float4,l=new e.Float4,u=t.frustum.corners,c=0,_=0;_<this._numCascades;++_){var d=this._splitRatios[_],f=this._shadowMapCameras[_];f.matrix=this._light.worldMatrix;for(var p=0;p<4;++p){var m=u[p],g=u[p+4],x=m.x,S=m.y,v=m.z,T=g.x-x,E=g.y-S,y=g.z-v;s.x=x+T*c,s.y=S+E*c,s.z=v+y*c,a.x=x+T*d,a.y=S+E*d,a.z=v+y*d,this._inverseLightMatrix.transformPoint(s,s),this._inverseLightMatrix.transformPoint(a,a),0===p?(h.copyFrom(s),l.copyFrom(s)):(h.minimize(s),l.maximize(s)),h.minimize(a),l.maximize(a)}c=d,h.z=Math.max(this._minZ,h.z);var M=Math.max(h.x,n.x),A=Math.min(l.x,r.x),P=Math.max(h.y,n.y),b=Math.min(l.y,r.y),w=A-M,R=b-P;w=Math.ceil(w/o)*o,R=Math.ceil(R/o)*o,w=Math.max(w,o),R=Math.max(R,o);var D=this._shadowMap._width/w*.5,C=this._shadowMap._height/R*.5;M=Math.floor(M*D)/D,P=Math.floor(P*C)/C,A=M+w,b=P+R;var L=e.DirectionalLight.SHADOW_FILTER.softness?e.DirectionalLight.SHADOW_FILTER.softness:.1;f.setBounds(M-L,A+L,b+L,P-L),f.nearDistance=-r.z,f.farDistance=-h.z,f._setRenderTargetResolution(this._shadowMap._width,this._shadowMap._height),this._shadowMatrices[_].multiply(this._transformToUV[_],f.viewProjectionMatrix)}},_updateCullPlanes:function(t){for(var i=this._collectorCamera.frustum,n=i._planes,r=0;r<4;++r)this._cullPlanes[r]=n[r];this._numCullPlanes=4,i=t.frustum,n=i._planes;for(var o=this._light.direction,s=0;s<6;++s){var a=n[s];e.dot3(a,o)>.001&&(this._cullPlanes[this._numCullPlanes++]=a)}},_collectShadowCasters:function(t){this._casterCollector.setSplitPlanes(this._splitPlanes),this._casterCollector.setCullPlanes(this._cullPlanes,this._numCullPlanes),this._casterCollector.setRenderCameras(this._shadowMapCameras),this._casterCollector.collect(this._collectorCamera,t)},get splitDistances(){return this._splitDistances},setSplitRatios:function(t,e,i,n){this._splitRatios[0]=t,this._splitRatios[1]=e,this._splitRatios[2]=i,this._splitRatios[3]=n},getShadowMatrix:function(t){return this._shadowMatrices[t]},_invalidateShadowMap:function(){this._shadowMapInvalid=!0},_initShadowMap:function(){var t=this._numCascades>1?2:1,i=Math.ceil(this._numCascades/2),n=this._shadowMapSize*t,r=this._shadowMapSize*i;this._shadowMap.initEmpty(n,r,e.DirectionalLight.SHADOW_FILTER.getShadowMapFormat(),e.DirectionalLight.SHADOW_FILTER.getShadowMapDataType()),this._depthBuffer||(this._depthBuffer=new e.WriteOnlyDepthBuffer),this._fboFront||(this._fboFront=new e.FrameBuffer(this._shadowMap,this._depthBuffer)),this._depthBuffer.init(n,r,!1),this._fboFront.init(),this._shadowMapInvalid=!1,this._shadowBackBuffer&&(this._shadowBackBuffer.initEmpty(n,r,e.DirectionalLight.SHADOW_FILTER.getShadowMapFormat(),e.DirectionalLight.SHADOW_FILTER.getShadowMapDataType()),this._fboBack||(this._fboBack=new e.FrameBuffer(this._shadowBackBuffer,this._depthBuffer)),this._fboBack.init()),this._viewports=[],this._viewports.push(new e.Rect(0,0,this._shadowMapSize,this._shadowMapSize)),this._viewports.push(new e.Rect(this._shadowMapSize,0,this._shadowMapSize,this._shadowMapSize)),this._viewports.push(new e.Rect(0,this._shadowMapSize,this._shadowMapSize,this._shadowMapSize)),this._viewports.push(new e.Rect(this._shadowMapSize,this._shadowMapSize,this._shadowMapSize,this._shadowMapSize)),this._initViewportMatrices(1/t,1/i)},_initSplitProperties:function(){var t=1;this._splitRatios=[],this._splitDistances=[0,0,0,0],this._splitPlanes=[];for(var i=this._numCascades-1;i>=0;--i)this._splitRatios[i]=t,this._splitPlanes[i]=new e.Float4,this._splitDistances[i]=0,t*=.33},_initCameras:function(){this._shadowMapCameras=[];for(var t=this._numCascades-1;t>=0;--t)this._shadowMapCameras[t]=new e.OrthographicOffCenterCamera},_initViewportMatrices:function(t,i){for(var n=new e.Float4(.5,.5,.5),r=0;r<4;++r)this._transformToUV[r].fromScale(.5),this._transformToUV[r].appendTranslation(n),this._transformToUV[r].appendScale(t,i,1);this._transformToUV[1].appendTranslation(new e.Float4(.5,0,0)),this._transformToUV[2].appendTranslation(new e.Float4(0,.5,0)),this._transformToUV[3].appendTranslation(new e.Float4(.5,.5,0))},_createShadowBuffer:function(){var t=new e.Texture2D;return t.filter=e.TextureFilter.BILINEAR_NOMIP,t.wrapMode=e.TextureWrapMode.CLAMP,t},_blur:function(){for(var t=e.DirectionalLight.SHADOW_FILTER.blurShader,i=0;i<e.DirectionalLight.SHADOW_FILTER.numBlurPasses;++i)e.setRenderTarget(this._fboBack),e.clear(),t.execute(e.RectMesh.DEFAULT,this._shadowMap,1/this._shadowMapSize,0),e.setRenderTarget(this._fboFront),e.clear(),t.execute(e.RectMesh.DEFAULT,this._shadowBackBuffer,0,1/this._shadowMapSize)}},e.ForwardRenderer=function(){this._width=0,this._height=0,this._gammaApplied=!1,this._copyTextureShader=new e.CopyChannelsShader("xyzw",(!0)),this._applyGamma=new e.ApplyGammaShader,this._scale=1,this._camera=null,this._scene=null,this._depthBuffer=this._createDepthBuffer(),this._hdrBack=new e.ForwardRenderer.HDRBuffers(this._depthBuffer),this._hdrFront=new e.ForwardRenderer.HDRBuffers(this._depthBuffer),this._renderCollector=new e.RenderCollector,this._normalDepthTexture=null,this._normalDepthFBO=null,this._ssaoTexture=this._createDummySSAOTexture(),this._aoEffect=null,this._backgroundColor=e.Color.BLACK.clone(),this._depthPrepass=!0},e.ForwardRenderer.HDRBuffers=function(t){this.texture=new e.Texture2D,this.texture.filter=e.TextureFilter.BILINEAR_NOMIP,this.texture.wrapMode=e.TextureWrapMode.CLAMP,this.fbo=new e.FrameBuffer(this.texture),this.fboDepth=new e.FrameBuffer(this.texture,t)},e.ForwardRenderer.HDRBuffers.prototype={dispose:function(){this.texture.dispose(),this.fbo.dispose(),this.fboDepth.dispose()},resize:function(t,n){this.texture.initEmpty(t,n,i.RGBA,e.HDR_FORMAT),this.fbo.init(),this.fboDepth.init()}},e.ForwardRenderer.prototype={get backgroundColor(){return this._backgroundColor},set backgroundColor(t){this._backgroundColor=new e.Color(t)},get depthPrepass(){return this._depthPrepass},set depthPrepass(t){this._depthPrepass=t},get scale(){return this._scale},set scale(t){this._scale=t},get camera(){return this._camera},get ambientOcclusion(){return this._aoEffect},set ambientOcclusion(t){this._aoEffect=t,this._aoEffect||(this._ssaoTexture=this._createDummySSAOTexture())},render:function(t,i,n,r){this._gammaApplied=e.GAMMA_CORRECT_LIGHTS,this._camera=t,this._scene=i,this._updateSize(r),t._setRenderTargetResolution(this._width,this._height),this._renderCollector.collect(t,i),this._renderShadowCasters();var o=this._renderCollector.getOpaqueStaticRenderList(),s=this._renderCollector.getTransparentStaticRenderList();e.setClearColor(e.Color.BLACK),e.setDepthMask(!0),this._renderNormalDepth(o),this._renderAO(),e.setRenderTarget(this._hdrFront.fboDepth),e.setClearColor(this._backgroundColor),e.clear(),this._renderDepthPrepass(o),this._renderStatics(o),this._renderCollector.needsBackbuffer&&this._copyToBackBuffer(),this._renderStatics(s),this._swapHDRFrontAndBack(),this._renderEffects(n),this._renderToScreen(r),e.setBlendState(),e.setDepthMask(!0)},_renderDepthPrepass:function(t){this._depthPrepass&&(i.colorMask(!1,!1,!1,!1),this._renderPass(e.MaterialPass.NORMAL_DEPTH_PASS,t),i.colorMask(!0,!0,!0,!0))},_renderStatics:function(t){e.setClearColor(this._backgroundColor),this._renderPass(e.MaterialPass.BASE_PASS,t)},_renderNormalDepth:function(t){(this._renderCollector.needsNormalDepth||this._aoEffect)&&(this._normalDepthTexture||this._initNormalDepth(),e.setRenderTarget(this._normalDepthFBO),e.setClearColor(e.Color.BLUE),e.clear(),this._renderPass(e.MaterialPass.NORMAL_DEPTH_PASS,t),e.setClearColor(e.Color.BLACK))},_renderAO:function(){this._aoEffect&&(this._ssaoTexture=this._aoEffect.getAOTexture(),this._aoEffect.render(this,0))},_renderShadowCasters:function(){for(var t=this._renderCollector._shadowCasters,e=t.length,i=0;i<e;++i)t[i].render(this._camera,this._scene)},_renderEffect:function(t,e){this._gammaApplied=this._gammaApplied||t._outputsGamma,t.render(this,e)},_renderPass:function(t,i){e.RenderUtils.renderPass(this,t,i)},_renderToScreen:function(t){e.setRenderTarget(t),e.clear(),this._gammaApplied?this._copyTextureShader.execute(e.RectMesh.DEFAULT,this._hdrBack.texture):this._applyGamma.execute(e.RectMesh.DEFAULT,this._hdrBack.texture)},_renderEffects:function(t){var e=this._renderCollector._effects;if(e)for(var i=e.length,n=0;n<i;++n){var r=e[n];r.isSupported()&&(this._renderEffect(r,t),this._swapHDRFrontAndBack())}},_updateSize:function(t){var i,n;t?(i=t.width,n=t.height):(i=Math.floor(e.TARGET_CANVAS.width*this._scale),n=Math.floor(e.TARGET_CANVAS.height*this._scale)),this._width===i&&this._height===n||(this._width=i,this._height=n,this._depthBuffer.init(this._width,this._height,!0),this._hdrBack.resize(this._width,this._height),this._hdrFront.resize(this._width,this._height),this._normalDepthTexture&&(this._normalDepthTexture.initEmpty(i,n),this._normalDepthFBO.init()))},_swapHDRFrontAndBack:function(){var t=this._hdrBack;this._hdrBack=this._hdrFront,this._hdrFront=t},_createDepthBuffer:function(){return new e.WriteOnlyDepthBuffer},_initNormalDepth:function(){this._normalDepthTexture=new e.Texture2D,this._normalDepthTexture.filter=e.TextureFilter.BILINEAR_NOMIP,this._normalDepthTexture.wrapMode=e.TextureWrapMode.CLAMP,this._normalDepthTexture.initEmpty(this._width,this._height),this._normalDepthFBO=new e.FrameBuffer(this._normalDepthTexture,this._depthBuffer),this._normalDepthFBO.init()},_createDummySSAOTexture:function(){var t=new Uint8Array([255,255,255,255]),i=new e.Texture2D;i.uploadData(t,1,1,!0),e.Texture2D.DEFAULT.filter=e.TextureFilter.NEAREST_NOMIP},_copyToBackBuffer:function(){e.setRenderTarget(this._hdrBack.fbo),e.clear(),this._copyTextureShader.execute(e.RectMesh.DEFAULT,this._hdrFront.texture),e.setRenderTarget(this._hdrFront.fboDepth)}},e.LightingModel={Unlit:null,BlinnPhong:e.ShaderLibrary.get("lighting_blinn_phong.glsl"),GGX:e.ShaderLibrary.get("lighting_ggx.glsl")},e.View=function(t,i,n,r,o,s){this.scene=t,this.camera=i,this.viewport=new e.Rect,this._renderer=null,this._texture=null,this._fbo=null,this.xRatio=n||0,this.yRatio=r||0,this.widthRatio=o||1,this.heightRatio=s||1},e.MultiRenderer=function(){this._views=[]},e.MultiRenderer.prototype={addView:function(t){t._renderer=new e.ForwardRenderer,t._texture=new e.Texture2D,t._texture.filter=e.TextureFilter.BILINEAR_NOMIP,t._texture.wrapMode=e.TextureWrapMode.CLAMP,t._fbo=new e.FrameBuffer(t._texture),this._views.push(t)},removeView:function(t){t._fbo.dispose(),t._texture.dispose(),t._renderer.dispose();var e=this._views.indexOf(t);this._views.splice(e,1)},render:function(t,i){for(var n=e.TARGET_CANVAS.clientWidth,r=e.TARGET_CANVAS.clientHeight,o=this._views.length,s=0;s<o;++s){var a=this._views[s],h=Math.floor(n*a.widthRatio),l=Math.floor(r*a.heightRatio);a._texture.width===h&&a._texture.height===l||(a._texture.initEmpty(h,l),a._fbo.init()),a._renderer.render(a.camera,a.scene,t,a._fbo)}e.setRenderTarget(i),e.clear();var u=new e.Rect;for(s=0;s<o;++s)a=this._views[s],u.x=Math.floor(a.xRatio*n),u.y=Math.floor((1-a.yRatio-a.heightRatio)*r),u.width=a._texture.width,u.height=a._texture.height,e.setViewport(u),e.COPY_SHADER.execute(e.RectMesh.DEFAULT,a._texture)}},e.RenderCollector=function(){e.SceneVisitor.call(this),this._renderItemPool=new e.RenderItemPool,this._opaquesStatic=[],this._opaquesDynamic=[],this._transparentsDynamic=[],this._transparentsStatic=[],this._camera=null,this._cameraZAxis=new e.Float4,this._frustum=null,this._lights=null,this._ambientColor=new e.Color,this._shadowCasters=null,this._effects=null,this._needsNormalDepth=!1,this._needsBackbuffer=!1},e.RenderCollector.prototype=Object.create(e.SceneVisitor.prototype),e.RenderCollector.prototype.getOpaqueDynamicRenderList=function(){return this._opaquesDynamic},e.RenderCollector.prototype.getTransparentDynamicRenderList=function(){return this._transparentsDynamic},e.RenderCollector.prototype.getOpaqueStaticRenderList=function(){return this._opaquesStatic},e.RenderCollector.prototype.getTransparentStaticRenderList=function(){return this._transparentsStatic},e.RenderCollector.prototype.getLights=function(){return this._lights},e.RenderCollector.prototype.getShadowCasters=function(){return this._shadowCasters},e.RenderCollector.prototype.getEffects=function(){return this._effects},Object.defineProperties(e.RenderCollector.prototype,{ambientColor:{get:function(){return this._ambientColor}},needsNormalDepth:{get:function(){return this._needsNormalDepth}},needsBackbuffer:{get:function(){return this._needsBackbuffer}}}),e.RenderCollector.prototype.collect=function(t,e){this._camera=t,t.worldMatrix.getColumn(2,this._cameraZAxis),this._frustum=t.frustum,this._reset(),e.acceptVisitor(this),this._opaquesStatic.sort(this._sortOpaques),this._opaquesDynamic.sort(this._sortOpaques),this._transparentsStatic.sort(this._sortTransparents),this._transparentsDynamic.sort(this._sortTransparents),this._lights.sort(this._sortLights);var i=this._camera._effects;if(i)for(var n=i.length,r=0;r<n;++r){var o=i[r];this._needsNormalDepth=this._needsNormalDepth||o._needsNormalDepth,this._effects.push(o)}},e.RenderCollector.prototype.qualifies=function(t){return t.visible&&t.worldBounds.intersectsConvexSolid(this._frustum._planes,6);
},e.RenderCollector.prototype.visitScene=function(t){var e=t._skybox;e&&this.visitModelInstance(e._modelInstance,t._rootNode.worldMatrix,t._rootNode.worldBounds)},e.RenderCollector.prototype.visitEffects=function(t){for(var e=t.length,i=0;i<e;++i)this._effects.push(t[i])},e.RenderCollector.prototype.visitModelInstance=function(t,i,n){for(var r=t.numMeshInstances,o=this._cameraZAxis,s=o.x,a=o.y,h=o.z,l=t.skeleton,u=t.skeletonMatrices,c=this._renderItemPool,_=this._camera,d=0;d<r;++d){var f=t.getMeshInstance(d);if(f.visible){var p=f.material;this._needsNormalDepth=this._needsNormalDepth||p._needsNormalDepth,this._needsBackbuffer=this._needsBackbuffer||p._needsBackbuffer;var m=c.getItem();m.material=p,m.meshInstance=f,m.skeleton=l,m.skeletonMatrices=u;var g=n._center;if(m.renderOrderHint=g.x*s+g.y*a+g.z*h,m.worldMatrix=i,m.camera=_,p.hasPass(e.MaterialPass.BASE_PASS)){var x=p.blendState||p._needsBackbuffer?this._transparentsStatic:this._opaquesStatic;x.push(m)}}}},e.RenderCollector.prototype.visitAmbientLight=function(t){var e=t._scaledIrradiance;this._ambientColor.r+=e.r,this._ambientColor.g+=e.g,this._ambientColor.b+=e.b},e.RenderCollector.prototype.visitLight=function(t){this._lights.push(t),t._castShadows&&this._shadowCasters.push(t._shadowMapRenderer)},e.RenderCollector.prototype._reset=function(){this._renderItemPool.reset(),this._opaquesDynamic=[],this._opaquesStatic=[],this._transparentsDynamic=[],this._transparentsStatic=[],this._lights=[],this._shadowCasters=[],this._effects=[],this._needsNormalDepth=!1,this._ambientColor.set(0,0,0,1)},e.RenderCollector.prototype._sortTransparents=function(t,e){var i=t.material._renderOrder-e.material._renderOrder;return 0!==i?i:e.renderOrderHint-t.renderOrderHint},e.RenderCollector.prototype._sortOpaques=function(t,e){var i;return i=t.material._renderOrder-e.material._renderOrder,0!==i?i:(i=t.material._renderOrderHint-e.material._renderOrderHint,0!==i?i:t.renderOrderHint-e.renderOrderHint)},e.RenderCollector.prototype._sortLights=function(t,e){return t._type===e._type?t._castShadows?1:-1:t._type-e._type},e.RenderUtils={renderPass:function(t,i,n){for(var r=n.length,o=null,s=null,a=0;a<r;++a){var h=n[a],l=h.material,u=l.getPass(i);if(u){var c=h.meshInstance;u!==o&&(u.updatePassRenderState(t),o=u,s=null),u.updateInstanceRenderState(h.camera,h),s!==c._mesh&&(c.updateRenderState(i),s=c._mesh),e.drawElements(u._elementType,c._mesh.numIndices,0)}}return e.setBlendState(null),r}},e.StencilState=function(t,i,n,r,o,s,a){this.enabled=!0,this.reference=t||0,this.comparison=i||e.Comparison.ALWAYS,this.onStencilFail=n||e.StencilOp.KEEP,this.onDepthFail=r||e.StencilOp.KEEP,this.onPass=o||e.StencilOp.KEEP,this.readMask=void 0===s||null===s?4294967295:s,this.writeMask=void 0===a||null===a?4294967295:a},e.CustomCopyShader=function(t){e.Shader.call(this),this.init(e.ShaderLibrary.get("copy_vertex.glsl"),t);var n=i.getUniformLocation(this._program,"sampler");this._positionAttributeLocation=i.getAttribLocation(this._program,"hx_position"),this._texCoordAttributeLocation=i.getAttribLocation(this._program,"hx_texCoord"),i.useProgram(this._program),i.uniform1i(n,0)},e.CustomCopyShader.prototype=Object.create(e.Shader.prototype),e.CustomCopyShader.prototype.execute=function(t,n){e.setDepthTest(e.Comparison.DISABLED),e.setCullMode(e.CullMode.NONE),t._vertexBuffers[0].bind(),t._indexBuffer.bind(),this.updateRenderState(),n.bind(0),i.vertexAttribPointer(this._positionAttributeLocation,2,i.FLOAT,!1,16,0),i.vertexAttribPointer(this._texCoordAttributeLocation,2,i.FLOAT,!1,16,8),e.enableAttributes(2),e.drawElements(i.TRIANGLES,6,0)},e.CopyChannelsShader=function(t,i){t=t||"xyzw",i=void 0===i||i;var n="#define extractChannels(src) ((src)."+t+")\n";i&&(n+="#define COPY_ALPHA\n"),e.CustomCopyShader.call(this,n+e.ShaderLibrary.get("copy_fragment.glsl"))},e.CopyChannelsShader.prototype=Object.create(e.CustomCopyShader.prototype),e.BlendColorCopyShader=function(){e.CustomCopyShader.call(this,e.ShaderLibrary.get("blend_color_copy_fragment.glsl")),this._colorLocation=i.getUniformLocation(this._program,"blendColor"),this.setBlendColor(1,1,1,1)},e.BlendColorCopyShader.prototype=Object.create(e.CustomCopyShader.prototype),e.BlendColorCopyShader.prototype.setBlendColor=function(t,e,n,r){i.useProgram(this._program),i.uniform4f(this._colorLocation,t,e,n,r)},e.ApplyGammaShader=function(){e.CustomCopyShader.call(this,e.ShaderLibrary.get("copy_to_gamma_fragment.glsl"))},e.ApplyGammaShader.prototype=Object.create(e.CustomCopyShader.prototype),e.BoundingAABB=function(){e.BoundingVolume.call(this,e.BoundingAABB)},e.BoundingAABB.prototype=Object.create(e.BoundingVolume.prototype),e.BoundingAABB.prototype.growToIncludeMesh=function(t){if(this._expanse!==e.BoundingVolume.EXPANSE_INFINITE){var i,n,r,o,s,a,h=t.getVertexAttribute("hx_position"),l=h.offset,u=t.getVertexStride(h.streamIndex),c=t.getVertexData(h.streamIndex),_=c.length;for(this._expanse===e.BoundingVolume.EXPANSE_EMPTY?(o=i=c[l],s=n=c[l+1],a=r=c[l+2],l+=u):(i=this._minimumX,n=this._minimumY,r=this._minimumZ,o=this._maximumX,s=this._maximumY,a=this._maximumZ);l<_;l+=u){var d=c[l],f=c[l+1],p=c[l+2];d>o?o=d:d<i&&(i=d),f>s?s=f:f<n&&(n=f),p>a?a=p:p<r&&(r=p)}this._minimumX=i,this._minimumY=n,this._minimumZ=r,this._maximumX=o,this._maximumY=s,this._maximumZ=a,this._expanse=e.BoundingVolume.EXPANSE_FINITE,this._updateCenterAndExtent()}},e.BoundingAABB.prototype.growToIncludeBound=function(t){t._expanse!==e.BoundingVolume.EXPANSE_EMPTY&&this._expanse!==e.BoundingVolume.EXPANSE_INFINITE&&(t._expanse===e.BoundingVolume.EXPANSE_INFINITE?this._expanse=e.BoundingVolume.EXPANSE_INFINITE:this._expanse===e.BoundingVolume.EXPANSE_EMPTY?(this._minimumX=t._minimumX,this._minimumY=t._minimumY,this._minimumZ=t._minimumZ,this._maximumX=t._maximumX,this._maximumY=t._maximumY,this._maximumZ=t._maximumZ,this._expanse=e.BoundingVolume.EXPANSE_FINITE):(t._minimumX<this._minimumX&&(this._minimumX=t._minimumX),t._minimumY<this._minimumY&&(this._minimumY=t._minimumY),t._minimumZ<this._minimumZ&&(this._minimumZ=t._minimumZ),t._maximumX>this._maximumX&&(this._maximumX=t._maximumX),t._maximumY>this._maximumY&&(this._maximumY=t._maximumY),t._maximumZ>this._maximumZ&&(this._maximumZ=t._maximumZ)),this._updateCenterAndExtent())},e.BoundingAABB.prototype.growToIncludeMinMax=function(t,i){this._expanse!==e.BoundingVolume.EXPANSE_INFINITE&&(this._expanse===e.BoundingVolume.EXPANSE_EMPTY?(this._minimumX=t.x,this._minimumY=t.y,this._minimumZ=t.z,this._maximumX=i.x,this._maximumY=i.y,this._maximumZ=i.z,this._expanse=e.BoundingVolume.EXPANSE_FINITE):(t.x<this._minimumX&&(this._minimumX=t.x),t.y<this._minimumY&&(this._minimumY=t.y),t.z<this._minimumZ&&(this._minimumZ=t.z),i.x>this._maximumX&&(this._maximumX=i.x),i.y>this._maximumY&&(this._maximumY=i.y),i.z>this._maximumZ&&(this._maximumZ=i.z)),this._updateCenterAndExtent())},e.BoundingAABB.prototype.transformFrom=function(t,i){if(t._expanse===e.BoundingVolume.EXPANSE_INFINITE||t._expanse===e.BoundingVolume.EXPANSE_EMPTY)this.clear(t._expanse);else{var n=i._m,r=n[0],o=n[1],s=n[2],a=n[4],h=n[5],l=n[6],u=n[8],c=n[9],_=n[10],d=t._center.x,f=t._center.y,p=t._center.z;this._center.x=r*d+a*f+u*p+n[12],this._center.y=o*d+h*f+c*p+n[13],this._center.z=s*d+l*f+_*p+n[14],r<0&&(r=-r),o<0&&(o=-o),s<0&&(s=-s),a<0&&(a=-a),h<0&&(h=-h),l<0&&(l=-l),u<0&&(u=-u),c<0&&(c=-c),_<0&&(_=-_),d=t._halfExtentX,f=t._halfExtentY,p=t._halfExtentZ,this._halfExtentX=r*d+a*f+u*p,this._halfExtentY=o*d+h*f+c*p,this._halfExtentZ=s*d+l*f+_*p,this._minimumX=this._center.x-this._halfExtentX,this._minimumY=this._center.y-this._halfExtentY,this._minimumZ=this._center.z-this._halfExtentZ,this._maximumX=this._center.x+this._halfExtentX,this._maximumY=this._center.y+this._halfExtentY,this._maximumZ=this._center.z+this._halfExtentZ,this._expanse=t._expanse}},e.BoundingAABB.prototype.intersectsConvexSolid=function(t,i){if(this._expanse===e.BoundingVolume.EXPANSE_INFINITE)return!0;if(this._expanse===e.BoundingVolume.EXPANSE_EMPTY)return!1;for(var n=this._minimumX,r=this._minimumY,o=this._minimumZ,s=this._maximumX,a=this._maximumY,h=this._maximumZ,l=0;l<i;++l){var u=t[l],c=u.x,_=u.y,d=u.z,f=u.w,p=c>0?n:s,m=_>0?r:a,g=d>0?o:h,x=c*p+_*m+d*g+f;if(x>0)return!1}return!0},e.BoundingAABB.prototype.intersectsBound=function(t){return this._expanse!==e.BoundingVolume.EXPANSE_EMPTY&&t._expanse!==e.BoundingVolume.EXPANSE_EMPTY&&(this._expanse===e.BoundingVolume.EXPANSE_INFINITE||t._expanse===e.BoundingVolume.EXPANSE_INFINITE||(t._type===this._type?this._maximumX>t._minimumX&&this._minimumX<t._maximumX&&this._maximumY>t._minimumY&&this._minimumY<t._maximumY&&this._maximumZ>t._minimumZ&&this._minimumZ<t._maximumZ:e.BoundingVolume._testAABBToSphere(this,t)))},e.BoundingAABB.prototype.classifyAgainstPlane=function(t){var i=t.x,n=t.y,r=t.z,o=t.w,s=i*this._center.x+n*this._center.y+r*this._center.z+o;i<0&&(i=-i),n<0&&(n=-n),r<0&&(r=-r);var a=i*this._halfExtentX+n*this._halfExtentY+r*this._halfExtentZ;return s>a?e.PlaneSide.FRONT:s<-a?e.PlaneSide.BACK:e.PlaneSide.INTERSECTING},e.BoundingAABB.prototype.setExplicit=function(t,i){this._minimumX=t.x,this._minimumY=t.y,this._minimumZ=t.z,this._maximumX=i.x,this._maximumY=i.y,this._maximumZ=i.z,this._expanse=e.BoundingVolume.EXPANSE_FINITE,this._updateCenterAndExtent()},e.BoundingAABB.prototype._updateCenterAndExtent=function(){var t=this._minimumX,e=this._minimumY,i=this._minimumZ,n=this._maximumX,r=this._maximumY,o=this._maximumZ;this._center.x=.5*(t+n),this._center.y=.5*(e+r),this._center.z=.5*(i+o),this._halfExtentX=.5*(n-t),this._halfExtentY=.5*(r-e),this._halfExtentZ=.5*(o-i)},e.BoundingAABB.prototype.getRadius=function(){return Math.sqrt(this._halfExtentX*this._halfExtentX+this._halfExtentY*this._halfExtentY+this._halfExtentZ*this._halfExtentZ)},e.BoundingAABB.prototype.createDebugModelInstance=function(){return new e.ModelInstance(new e.BoxPrimitive,[this.getDebugMaterial()])},e.BoundingSphere=function(){e.BoundingVolume.call(this,e.BoundingSphere)},e.BoundingSphere.prototype=Object.create(e.BoundingVolume.prototype),e.BoundingSphere.prototype.setExplicit=function(t,i){this._center.copyFrom(t),this._halfExtentX=this._halfExtentY=this._halfExtentZ=i,this._expanse=e.BoundingVolume.EXPANSE_FINITE,this._updateMinAndMax()},e.BoundingSphere.prototype.growToIncludeMesh=function(t){if(this._expanse!==e.BoundingVolume.EXPANSE_INFINITE){var i,n,r,o,s,a,h=t.getVertexAttribute("hx_position"),l=h.offset,u=t.getVertexStride(h.streamIndex),c=h.getVertexData(h.streamIndex),_=c.length;for(this._expanse===e.BoundingVolume.EXPANSE_EMPTY?(o=i=c[l],s=n=c[l+1],a=r=c[l+2],l+=u):(i=this._minimumX,n=this._minimumY,r=this._minimumZ,o=this._maximumX,s=this._maximumY,a=this._maximumZ);l<_;l+=u){var d=c[l],f=c[l+1],p=c[l+2];d>o?o=d:d<i&&(i=d),f>s?s=f:f<n&&(n=f),p>a?a=p:p<r&&(r=p)}var m=.5*(o+i),g=.5*(s+n),x=.5*(a+r),S=0;for(l=h.offset;l<_;l+=u){var v=m-c[l],T=g-c[l+1],E=x-c[l+2],y=v*v+T*T+E*E;y>S&&(S=y)}this._center.x=m,this._center.y=g,this._center.z=x;var M=Math.sqrt(S);this._halfExtentX=M,this._halfExtentY=M,this._halfExtentZ=M,this._expanse=e.BoundingVolume.EXPANSE_FINITE,this._updateMinAndMax()}},e.BoundingSphere.prototype.growToIncludeBound=function(t){if(t._expanse!==e.BoundingVolume.EXPANSE_EMPTY&&this._expanse!==e.BoundingVolume.EXPANSE_INFINITE){if(t._expanse===e.BoundingVolume.EXPANSE_INFINITE)this._expanse=e.BoundingVolume.EXPANSE_INFINITE;else if(this._expanse===e.BoundingVolume.EXPANSE_EMPTY)this._center.x=t._center.x,this._center.y=t._center.y,this._center.z=t._center.z,t._type===this._type?(this._halfExtentX=t._halfExtentX,this._halfExtentY=t._halfExtentY,this._halfExtentZ=t._halfExtentZ):this._halfExtentX=this._halfExtentY=this._halfExtentZ=t.getRadius(),this._expanse=e.BoundingVolume.EXPANSE_FINITE;else{var i=this._minimumX,n=this._minimumY,r=this._minimumZ,o=this._maximumX,s=this._maximumY,a=this._maximumZ;t._maximumX>o&&(o=t._maximumX),t._maximumY>s&&(s=t._maximumY),t._maximumZ>a&&(a=t._maximumZ),t._minimumX<i&&(i=t._minimumX),t._minimumY<n&&(n=t._minimumY),t._minimumZ<r&&(r=t._minimumZ),this._center.x=.5*(i+o),this._center.y=.5*(n+s),this._center.z=.5*(r+a);var h=o-this._center.x,l=s-this._center.y,u=a-this._center.z,c=Math.sqrt(h*h+l*l+u*u);this._halfExtentX=this._halfExtentY=this._halfExtentZ=c}this._updateMinAndMax()}},e.BoundingSphere.prototype.growToIncludeMinMax=function(t,i){var n=new e.BoundingAABB;n.growToIncludeMinMax(t,i),this.growToIncludeBound(n)},e.BoundingSphere.prototype.getRadius=function(){return this._halfExtentX},e.BoundingSphere.prototype.transformFrom=function(t,i){if(t._expanse===e.BoundingVolume.EXPANSE_INFINITE||t._expanse===e.BoundingVolume.EXPANSE_EMPTY)this.clear(t._expanse);else{var n=i._m,r=n[0],o=n[1],s=n[2],a=n[4],h=n[5],l=n[6],u=n[8],c=n[9],_=n[10],d=t._center.x,f=t._center.y,p=t._center.z;this._center.x=r*d+a*f+u*p+n[12],this._center.y=o*d+h*f+c*p+n[13],this._center.z=s*d+l*f+_*p+n[14],r<0&&(r=-r),o<0&&(o=-o),s<0&&(s=-s),a<0&&(a=-a),h<0&&(h=-h),l<0&&(l=-l),u<0&&(u=-u),c<0&&(c=-c),_<0&&(_=-_),d=t._halfExtentX,f=t._halfExtentY,p=t._halfExtentZ;var m=r*d+a*f+u*p,g=o*d+h*f+c*p,x=s*d+l*f+_*p,S=Math.sqrt(m*m+g*g+x*x);this._halfExtentX=this._halfExtentY=this._halfExtentZ=S,this._minimumX=this._center.x-this._halfExtentX,this._minimumY=this._center.y-this._halfExtentY,this._minimumZ=this._center.z-this._halfExtentZ,this._maximumX=this._center.x+this._halfExtentX,this._maximumY=this._center.y+this._halfExtentY,this._maximumZ=this._center.z+this._halfExtentZ,this._expanse=e.BoundingVolume.EXPANSE_FINITE}},e.BoundingSphere.prototype.intersectsConvexSolid=function(t,i){if(this._expanse===e.BoundingVolume.EXPANSE_INFINITE)return!0;if(this._expanse===e.BoundingVolume.EXPANSE_EMPTY)return!1;for(var n=this._center.x,r=this._center.y,o=this._center.z,s=this._halfExtentX,a=0;a<i;++a){var h=t[a],l=h.x*n+h.y*r+h.z*o+h.w;if(l>s)return!1}return!0},e.BoundingSphere.prototype.intersectsBound=function(t){if(this._expanse===e.BoundingVolume.EXPANSE_EMPTY||t._expanse===e.BoundingVolume.EXPANSE_EMPTY)return!1;if(this._expanse===e.BoundingVolume.EXPANSE_INFINITE||t._expanse===e.BoundingVolume.EXPANSE_INFINITE)return!0;if(t._type===this._type){var i=this._center.x-t._center.x,n=this._center.y-t._center.y,r=this._center.z-t._center.z,o=this._halfExtentX+t._halfExtentX;return i*i+n*n+r*r<o*o}return e.BoundingVolume._testAABBToSphere(t,this)},e.BoundingSphere.prototype.classifyAgainstPlane=function(t){var i=t.x*this._center.x+t.y*this._center.y+t.z*this._center.z+t.w,n=this._halfExtentX;return i>n?e.PlaneSide.FRONT:i<-n?e.PlaneSide.BACK:e.PlaneSide.INTERSECTING},e.BoundingSphere.prototype._updateMinAndMax=function(){var t=this._center.x,e=this._center.y,i=this._center.z,n=this._halfExtentX;this._minimumX=t-n,this._minimumY=e-n,this._minimumZ=i-n,this._maximumX=t+n,this._maximumY=e+n,this._maximumZ=i+n},e.BoundingSphere.prototype.createDebugModelInstance=function(){return new e.ModelInstance(new e.SpherePrimitive({doubleSided:!0}),[this.getDebugMaterial()])},e.Frustum=function(){this._planes=new Array(6),this._corners=new Array(8);for(var t=0;t<6;++t)this._planes[t]=new e.Float4;for(t=0;t<8;++t)this._corners[t]=new e.Float4;this._r1=new e.Float4,this._r2=new e.Float4,this._r3=new e.Float4,this._r4=new e.Float4},e.Frustum.PLANE_LEFT=0,e.Frustum.PLANE_RIGHT=1,e.Frustum.PLANE_BOTTOM=2,e.Frustum.PLANE_TOP=3,e.Frustum.PLANE_NEAR=4,e.Frustum.PLANE_FAR=5,e.Frustum.CLIP_SPACE_CORNERS=[new e.Float4((-1),(-1),(-1),1),new e.Float4(1,(-1),(-1),1),new e.Float4(1,1,(-1),1),new e.Float4((-1),1,(-1),1),new e.Float4((-1),(-1),1,1),new e.Float4(1,(-1),1,1),new e.Float4(1,1,1,1),new e.Float4((-1),1,1,1)],e.Frustum.prototype={get planes(){return this._planes},get corners(){return this._corners},update:function(t,e){this._updatePlanes(t),this._updateCorners(e)},_updatePlanes:function(t){var i=t.getRow(0,this._r1),n=t.getRow(1,this._r2),r=t.getRow(2,this._r3),o=t.getRow(3,this._r4);e.Float4.add(o,i,this._planes[e.Frustum.PLANE_LEFT]),e.Float4.subtract(o,i,this._planes[e.Frustum.PLANE_RIGHT]),e.Float4.add(o,n,this._planes[e.Frustum.PLANE_BOTTOM]),e.Float4.subtract(o,n,this._planes[e.Frustum.PLANE_TOP]),e.Float4.add(o,r,this._planes[e.Frustum.PLANE_NEAR]),e.Float4.subtract(o,r,this._planes[e.Frustum.PLANE_FAR]);for(var s=0;s<6;++s)this._planes[s].negate(),this._planes[s].normalizeAsPlane()},_updateCorners:function(t){for(var i=0;i<8;++i){var n=this._corners[i];t.transform(e.Frustum.CLIP_SPACE_CORNERS[i],n),n.scale(1/n.w)}}},e.Camera=function(){e.Entity.call(this),this._renderTargetWidth=0,this._renderTargetHeight=0,this._viewProjectionMatrixInvalid=!0,this._viewProjectionMatrix=new e.Matrix4x4,this._inverseProjectionMatrix=new e.Matrix4x4,this._inverseViewProjectionMatrix=new e.Matrix4x4,this._projectionMatrix=new e.Matrix4x4,this._viewMatrix=new e.Matrix4x4,this._projectionMatrixDirty=!0,this._nearDistance=.1,this._farDistance=1e3,this._frustum=new e.Frustum,this.position.set(0,0,1)},e.Camera.prototype=Object.create(e.Entity.prototype),Object.defineProperties(e.Camera.prototype,{nearDistance:{get:function(){return this._nearDistance},set:function(t){this._nearDistance=t,this._invalidateProjectionMatrix()}},farDistance:{get:function(){return this._farDistance},set:function(t){this._farDistance=t,this._invalidateProjectionMatrix()}},viewProjectionMatrix:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._viewProjectionMatrix}},viewMatrix:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._viewMatrix}},projectionMatrix:{get:function(){return this._projectionMatrixDirty&&this._updateProjectionMatrix(),this._projectionMatrix}},inverseViewProjectionMatrix:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._inverseViewProjectionMatrix}},inverseProjectionMatrix:{get:function(){return this._projectionMatrixDirty&&this._updateProjectionMatrix(),this._inverseProjectionMatrix}},frustum:{get:function(){return this._viewProjectionMatrixInvalid&&this._updateViewProjectionMatrix(),this._frustum}}}),e.Camera.prototype.acceptVisitor=function(t){e.SceneNode.prototype.acceptVisitor.call(this,t)},e.Camera.prototype._setRenderTargetResolution=function(t,e){this._renderTargetWidth=t,this._renderTargetHeight=e},e.Camera.prototype._invalidateViewProjectionMatrix=function(){this._viewProjectionMatrixInvalid=!0},e.Camera.prototype._invalidateWorldMatrix=function(){e.Entity.prototype._invalidateWorldMatrix.call(this),this._invalidateViewProjectionMatrix()},e.Camera.prototype._updateViewProjectionMatrix=function(){this._viewMatrix.inverseAffineOf(this.worldMatrix),this._viewProjectionMatrix.multiply(this.projectionMatrix,this._viewMatrix),this._inverseProjectionMatrix.inverseOf(this._projectionMatrix),this._inverseViewProjectionMatrix.inverseOf(this._viewProjectionMatrix),this._frustum.update(this._viewProjectionMatrix,this._inverseViewProjectionMatrix),this._viewProjectionMatrixInvalid=!1},e.Camera.prototype._invalidateProjectionMatrix=function(){this._projectionMatrixDirty=!0,this._invalidateViewProjectionMatrix()},e.Camera.prototype._updateProjectionMatrix=function(){throw new Error("Abstract method!")},e.Camera.prototype._updateWorldBounds=function(){this._worldBounds.clear(e.BoundingVolume.EXPANSE_INFINITE)},e.Camera.prototype.toString=function(){return"[Camera(name="+this._name+")]"},e.PerspectiveCamera=function(){e.Camera.call(this),this._vFOV=1.047198,this._aspectRatio=0},e.PerspectiveCamera.prototype=Object.create(e.Camera.prototype),Object.defineProperties(e.PerspectiveCamera.prototype,{verticalFOV:{get:function(){return this._vFOV},set:function(t){this._vFOV=t,this._invalidateProjectionMatrix()}}}),e.PerspectiveCamera.prototype._setAspectRatio=function(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._invalidateProjectionMatrix())},e.PerspectiveCamera.prototype._setRenderTargetResolution=function(t,i){e.Camera.prototype._setRenderTargetResolution.call(this,t,i),this._setAspectRatio(t/i)},e.PerspectiveCamera.prototype._updateProjectionMatrix=function(){this._projectionMatrix.fromPerspectiveProjection(this._vFOV,this._aspectRatio,this._nearDistance,this._farDistance),this._projectionMatrixDirty=!1},e.OrthographicOffCenterCamera=function(){e.Camera.call(this),this._left=-1,this._right=1,this._top=1,this._bottom=-1},e.OrthographicOffCenterCamera.prototype=Object.create(e.Camera.prototype),e.OrthographicOffCenterCamera.prototype.setBounds=function(t,e,i,n){this._left=t,this._right=e,this._top=i,this._bottom=n,this._invalidateProjectionMatrix()},e.OrthographicOffCenterCamera.prototype._updateProjectionMatrix=function(){this._projectionMatrix.fromOrthographicOffCenterProjection(this._left,this._right,this._top,this._bottom,this._nearDistance,this._farDistance),this._projectionMatrixDirty=!1},e.MaterialQueryVisitor=function(t){e.SceneVisitor.call(this),this._materialName=t},e.MaterialQueryVisitor.prototype=Object.create(e.SceneVisitor.prototype,{foundMaterial:{get:function(){return this._foundMaterial}}}),e.MaterialQueryVisitor.prototype.qualifies=function(t){return!this._foundMaterial},e.MaterialQueryVisitor.prototype.visitModelInstance=function(t,e){for(var i=t._materials,n=i.length,r=0;r<n;++r){var o=i[r];o.name===this._materialName&&(this._foundMaterial=o)}},e.Scene=function(t){this._rootNode=t||new e.SceneNode,this._rootNode._setScene(this),this._skybox=null,this._entityEngine=new e.EntityEngine},e.Scene.prototype={constructor:e.Scene,get skybox(){return this._skybox},set skybox(t){this._skybox=t},findNodeByName:function(t){return this._rootNode.findNodeByName(t)},findMaterialByName:function(t){return this._rootNode.findMaterialByName(t)},attach:function(t){this._rootNode.attach(t)},detach:function(t){this._rootNode.detach(t)},get numChildren(){return this._rootNode.numChildren},getChild:function(t){return this._rootNode.getChild(t)},contains:function(t){this._rootNode.contains(t)},acceptVisitor:function(t){t.visitScene(this),this._rootNode.acceptVisitor(t)},get entityEngine(){return this._entityEngine},get worldBounds(){return this._rootNode.worldBounds}},e.Skybox=function(t){t instanceof e.Material||(t=new e.SkyboxMaterial(t));var i=new e.BoxPrimitive({width:1,invert:!0});i.localBounds.clear(e.BoundingVolume.EXPANSE_INFINITE),this._modelInstance=new e.ModelInstance(i,t)},e.Skybox.prototype={},e.Terrain=function(t,i,n,r,o,s){e.SceneNode.call(this),this._terrainSize=t||512,this._minElevation=i,this._maxElevation=n,this._numLevels=r||4,s=s||32;var a=2*Math.ceil(.5*s);this._snapSize=this._terrainSize/s/Math.pow(2,this._numLevels),this._material=o,o.setUniform("hx_elevationOffset",i),o.setUniform("hx_elevationScale",n-i),this._initModels(a),this._initTree()},e.Terrain.prototype=Object.create(e.SceneNode.prototype,{terrainSize:{get:function(){return this._terrainSize}}}),e.Terrain.prototype._createModel=function(t,i,n,r){var o=1/i,s=new e.MeshData,a=t*o,h=.5*a;s.addVertexAttribute("hx_position",3),s.addVertexAttribute("hx_normal",3),s.addVertexAttribute("hx_cellSize",1);for(var l=[],u=[],c=n?i-1:i,_=i+1,d=0;d<=c;++d)for(var f=(d*o-.5)*t,p=0;p<=i;++p){var m=(p*o-.5)*t,g=r||p!==i||d!==i?a:h;if(l.push(m,0,f,0,1,0,g),p!==i&&d!==c){var x=p+d*_;u.push(x,x+_,x+_+1),u.push(x,x+_+1,x+1)}}var S=l.length/7;if(n)for(f=(i*o-.5)*t,p=0;p<=i;++p)m=(p*o-.5)*t,l.push(m,0,f,0,1,0),l.push(h),p!==i&&(x=p+c*_,l.push(m+h,0,f,0,1,0,h),u.push(x,S+2*p,S+2*p+1),u.push(x,S+2*p+1,x+1),u.push(S+2*p+1,S+2*p+2,x+1));s.setVertexData(l,0),s.setIndexData(u);var v=new e.ModelData;v.addMeshData(s);var T=new e.Model(v);return T.localBounds.growToIncludeMinMax(new e.Float4(0,this._minElevation,0),new e.Float4(0,this._maxElevation,0)),T},e.Terrain.prototype._initModels=function(t){this._models=[];for(var e=.25*this._terrainSize,i=0;i<this._numLevels;++i){if(i===this._numLevels-1){var n=this._createModel(e,t,!1,!0);this._models[i]={edge:n,corner:n}}else this._models[i]={edge:this._createModel(e,t,!0,!1),corner:this._createModel(e,t,!1,!1)};e*=.5}},e.Terrain.prototype._initTree=function(){for(var t=0,e=.25*this._terrainSize,i=0;i<4;++i)for(var n=this._terrainSize*(i/4-.5)+.5*e,r=0;r<4;++r){var o=this._terrainSize*(r/4-.5)+.5*e,s=0,a=0;if(1===r?s=1:2===r&&(s=-1),1===i?a=1:2===i&&(a=-1),s&&a)this._subDivide(o,n,s,a,t+1,.5*e);else{var h=0,l="edge",u=!0;r%3===i%3?(l="corner",0===r&&0===i&&(h=0),0===r&&3===i&&(h=1),3===r&&3===i&&(h=2),3===r&&0===i&&(h=-1)):(3===i&&(h=2),3===r&&(h=-1),0===r&&(h=1)),u&&this._addModel(o,n,t,h,l)}}},e.Terrain.prototype._addModel=function(t,i,n,r,o){var s=new e.ModelInstance(this._models[n][o],this._material);s.position.set(t,0,i),s.rotation.fromAxisAngle(e.Float4.Y_AXIS,r*Math.PI*.5),this.attach(s)},e.Terrain.prototype._subDivide=function(t,e,i,n,r,o){o*=.5;for(var s=-1;s<=1;s+=2)for(var a=-1;a<=1;a+=2)if(a!==i||s!==n||r===this._numLevels-1){var h=0,l="corner";t<0&&e<0?a<0&&s>0?(l="edge",h=1):a>0&&s<0?(l="edge",h=0):h=0:t>0&&e>0?a>0&&s<0?(l="edge",h=-1):a<0&&s>0?(l="edge",h=2):h=2:t<0&&e>0?a>0&&s>0?(l="edge",h=2):a<0&&s<0?(l="edge",h=1):h=1:t>0&&e<0&&(a<0&&s<0?(l="edge",h=0):a>0&&s>0?(l="edge",h=-1):h=-1),this._addModel(t+o*a,e+o*s,r,h,l)}r<this._numLevels-1&&this._subDivide(t+o*i,e+o*n,i,n,r+1,o)},e.Terrain.prototype.acceptVisitor=function(t){if(t instanceof e.RenderCollector){var i=t._camera.position;this.position.x=Math.floor(i.x/this._snapSize)*this._snapSize,this.position.z=Math.floor(i.z/this._snapSize)*this._snapSize}e.SceneNode.prototype.acceptVisitor.call(this,t)},e.Terrain.prototype._updateWorldBounds=function(){this._worldBounds.clear(e.BoundingVolume.EXPANSE_INFINITE)},e.GLSLIncludeGeneral="precision highp float;\n\n"+e.ShaderLibrary.get("snippets_general.glsl")+"\n\n",e.TextureSetter={},e.TextureSetter.getSettersPerPass=function(t){return void 0===e.TextureSetter._passTable&&e.TextureSetter._init(),e.TextureSetter._findSetters(t,e.TextureSetter._passTable)},e.TextureSetter.getSettersPerInstance=function(t){return void 0===e.TextureSetter._instanceTable&&e.TextureSetter._init(),e.TextureSetter._findSetters(t,e.TextureSetter._instanceTable)},e.TextureSetter._findSetters=function(t,e){var i=[];for(var n in e)if(e.hasOwnProperty(n)){var r=t.getTextureSlot(n);if(r){var o=new e[n];i.push(o),o.slot=r}}return i},e.TextureSetter._init=function(){e.TextureSetter._passTable={},e.TextureSetter._instanceTable={},e.TextureSetter._passTable.hx_normalDepth=e.NormalDepthSetter,e.TextureSetter._passTable.hx_backbuffer=e.BackbufferSetter,e.TextureSetter._passTable.hx_frontbuffer=e.FrontbufferSetter,e.TextureSetter._passTable.hx_ssao=e.SSAOSetter,e.TextureSetter._instanceTable.hx_skinningTexture=e.SkinningTextureSetter},e.NormalDepthSetter=function(){},e.NormalDepthSetter.prototype.execute=function(t){t._normalDepthTexture&&(this.slot.texture=t._normalDepthTexture)},e.FrontbufferSetter=function(){},e.FrontbufferSetter.prototype.execute=function(t){t._hdrFront&&(this.slot.texture=t._hdrFront.texture)},e.BackbufferSetter=function(){},e.BackbufferSetter.prototype.execute=function(t){t._hdrBack&&(this.slot.texture=t._hdrBack.texture)},e.SSAOSetter=function(){},e.SSAOSetter.prototype.execute=function(t){this.slot.texture=t._ssaoTexture},e.SkinningTextureSetter=function(){},e.SkinningTextureSetter.prototype.execute=function(t){this.slot.texture=t.skeletonMatrices},e.UniformSetter={},e.UniformSetter.getSetters=function(t){return void 0===e.UniformSetter._table&&e.UniformSetter._init(),e.UniformSetter._findSetters(t)},e.UniformSetter._findSetters=function(t){var n=[];for(var r in e.UniformSetter._table){var o=i.getUniformLocation(t._program,r);if(null!==o){var s=new e.UniformSetter._table[r];n.push(s),s.location=o}}return n},e.UniformSetter._init=function(){e.UniformSetter._table={},e.UniformSetter._table.hx_worldMatrix=e.WorldMatrixSetter,e.UniformSetter._table.hx_worldViewMatrix=e.WorldViewMatrixSetter,e.UniformSetter._table.hx_wvpMatrix=e.WorldViewProjectionSetter,e.UniformSetter._table.hx_viewMatrix=e.ViewMatrixSetter,e.UniformSetter._table.hx_projectionMatrix=e.ProjectionSetter,e.UniformSetter._table.hx_inverseProjectionMatrix=e.InverseProjectionSetter,e.UniformSetter._table.hx_inverseWVPMatrix=e.InverseWVPSetter,e.UniformSetter._table.hx_viewProjectionMatrix=e.ViewProjectionSetter,e.UniformSetter._table.hx_inverseViewProjectionMatrix=e.InverseViewProjectionSetter,e.UniformSetter._table.hx_normalWorldMatrix=e.NormalWorldMatrixSetter,e.UniformSetter._table.hx_normalWorldViewMatrix=e.NormalWorldViewMatrixSetter,e.UniformSetter._table.hx_cameraWorldPosition=e.CameraWorldPosSetter,e.UniformSetter._table.hx_cameraWorldMatrix=e.CameraWorldMatrixSetter,e.UniformSetter._table.hx_cameraFrustumRange=e.CameraFrustumRangeSetter,e.UniformSetter._table.hx_rcpCameraFrustumRange=e.RCPCameraFrustumRangeSetter,e.UniformSetter._table.hx_cameraNearPlaneDistance=e.CameraNearPlaneDistanceSetter,e.UniformSetter._table.hx_cameraFarPlaneDistance=e.CameraFarPlaneDistanceSetter,e.UniformSetter._table.hx_renderTargetResolution=e.RenderTargetResolutionSetter,e.UniformSetter._table.hx_rcpRenderTargetResolution=e.RCPRenderTargetResolutionSetter,e.UniformSetter._table.hx_dither2DTextureScale=e.Dither2DTextureScaleSetter,e.UniformSetter._table["hx_skinningMatrices[0]"]=e.SkinningMatricesSetter,e.UniformSetter._table["hx_poissonDisk[0]"]=e.PoissonDiskSetter,e.UniformSetter._table["hx_morphWeights[0]"]=e.MorphWeightsSetter},e.WorldMatrixSetter=function(){},e.WorldMatrixSetter.prototype.execute=function(t,e){i.uniformMatrix4fv(this.location,!1,e.worldMatrix._m)},e.ViewProjectionSetter=function(){},e.ViewProjectionSetter.prototype.execute=function(t){i.uniformMatrix4fv(this.location,!1,t.viewProjectionMatrix._m)},e.InverseViewProjectionSetter=function(){},e.InverseViewProjectionSetter.prototype.execute=function(t){i.uniformMatrix4fv(this.location,!1,t.inverseViewProjectionMatrix._m)},e.InverseWVPSetter=function(){},e.InverseWVPSetter.prototype.execute=function(t){i.uniformMatrix4fv(this.location,!1,t.inverseViewProjectionMatrix._m)},e.ProjectionSetter=function(){},e.ProjectionSetter.prototype.execute=function(t){i.uniformMatrix4fv(this.location,!1,t.projectionMatrix._m)},e.InverseProjectionSetter=function(){},e.InverseProjectionSetter.prototype.execute=function(t){i.uniformMatrix4fv(this.location,!1,t.inverseProjectionMatrix._m)},e.WorldViewProjectionSetter=function(){},e.WorldViewProjectionSetter.prototype.execute=function(){var t=new e.Matrix4x4,n=t._m;return function(e,r){t.multiply(e.viewProjectionMatrix,r.worldMatrix),i.uniformMatrix4fv(this.location,!1,n)}}(),e.WorldViewMatrixSetter=function(){this._matrix=new e.Matrix4x4},e.WorldViewMatrixSetter.prototype.execute=function(){var t=new e.Matrix4x4,n=t._m;return function(e,r){t.multiply(e.viewMatrix,r.worldMatrix),i.uniformMatrix4fv(this.location,!1,n)}}(),e.NormalWorldMatrixSetter=function(){},e.NormalWorldMatrixSetter.prototype.execute=function(){var t=new Float32Array(9);return function(e,n){n.worldMatrix.writeNormalMatrix(t),i.uniformMatrix3fv(this.location,!1,t)}}(),e.NormalWorldViewMatrixSetter=function(){},e.NormalWorldViewMatrixSetter.prototype.execute=function(){var t=new Float32Array(9);return function(e,n){var r=e.viewMatrix._m,o=n.worldMatrix._m,s=r[0],a=r[1],h=r[2],l=r[4],u=r[5],c=r[6],_=r[8],d=r[9],f=r[10],p=r[12],m=r[13],g=r[14],x=o[0],S=o[1],v=o[2],T=o[3],E=o[4],y=o[5],M=o[6],A=o[7],P=o[8],b=o[9],w=o[10],R=o[11],D=s*x+l*S+_*v+p*T,C=a*x+u*S+d*v+m*T,L=h*x+c*S+f*v+g*T,O=s*E+l*y+_*M+p*A,I=a*E+u*y+d*M+m*A,F=h*E+c*y+f*M+g*A,N=s*P+l*b+_*w+p*R,B=a*P+u*b+d*w+m*R,U=h*P+c*b+f*w+g*R,j=D*(I*U-B*F)-O*(C*U-B*L)+N*(C*F-I*L),V=1/j;t[0]=(I*U-B*F)*V,t[1]=(N*F-O*U)*V,t[2]=(O*B-N*I)*V,t[3]=(B*L-C*U)*V,t[4]=(D*U-N*L)*V,t[5]=(N*C-D*B)*V,t[6]=(C*F-I*L)*V,t[7]=(O*L-D*F)*V,t[8]=(D*I-O*C)*V,i.uniformMatrix3fv(this.location,!1,t)}}(),e.CameraWorldPosSetter=function(){},e.CameraWorldPosSetter.prototype.execute=function(t){var e=t.worldMatrix._m;i.uniform3f(this.location,e[12],e[13],e[14])},e.CameraWorldMatrixSetter=function(){},e.CameraWorldMatrixSetter.prototype.execute=function(t){
var e=t.worldMatrix;i.uniformMatrix4fv(this.location,!1,e._m)},e.CameraFrustumRangeSetter=function(){},e.CameraFrustumRangeSetter.prototype.execute=function(t){i.uniform1f(this.location,t._farDistance-t._nearDistance)},e.RCPCameraFrustumRangeSetter=function(){},e.RCPCameraFrustumRangeSetter.prototype.execute=function(t){i.uniform1f(this.location,1/(t._farDistance-t._nearDistance))},e.CameraNearPlaneDistanceSetter=function(){},e.CameraNearPlaneDistanceSetter.prototype.execute=function(t){i.uniform1f(this.location,t._nearDistance)},e.CameraFarPlaneDistanceSetter=function(){},e.CameraFarPlaneDistanceSetter.prototype.execute=function(t){i.uniform1f(this.location,t._farDistance)},e.ViewMatrixSetter=function(){},e.ViewMatrixSetter.prototype.execute=function(t){i.uniformMatrix4fv(this.location,!1,t.viewMatrix._m)},e.RenderTargetResolutionSetter=function(){},e.RenderTargetResolutionSetter.prototype.execute=function(t){i.uniform2f(this.location,t._renderTargetWidth,t._renderTargetHeight)},e.RCPRenderTargetResolutionSetter=function(){},e.RCPRenderTargetResolutionSetter.prototype.execute=function(t){i.uniform2f(this.location,1/t._renderTargetWidth,1/t._renderTargetHeight)},e.Dither2DTextureScaleSetter=function(){},e.Dither2DTextureScaleSetter.prototype.execute=function(){i.uniform2f(this.location,1/e.DEFAULT_2D_DITHER_TEXTURE.width,1/e.DEFAULT_2D_DITHER_TEXTURE.height)},e.PoissonDiskSetter=function(){},e.PoissonDiskSetter.prototype.execute=function(){i.uniform2fv(this.location,e.PoissonDisk.DEFAULT_FLOAT32)},e.SkinningMatricesSetter=function(){this._data=new Float32Array(12*e.OPTIONS.maxBones)},e.SkinningMatricesSetter.prototype.execute=function(t,e){var n=e.skeleton;if(n){for(var r=e.skeletonMatrices,o=n.numJoints,s=0,a=0;a<o;++a)r[a].writeData4x3(this._data,s),s+=12;i.uniform4fv(this.location,this._data)}},e.MorphWeightsSetter=function(){},e.MorphWeightsSetter.prototype.execute=function(t,e){i.uniform1fv(this.location,e.meshInstance._morphWeights)},e.FrameBuffer=function(t,n,r){if(t&&void 0===t[0]&&(t=[t]),this._cubeFace=r,this._colorTextures=t,this._numColorTextures=this._colorTextures?this._colorTextures.length:0,this._depthBuffer=n,this._colorTextures&&this._numColorTextures>1){this._drawBuffers=new Array(this._numColorTextures);for(var o=0;o<this._numColorTextures;++o)this._drawBuffers[o]=e.EXT_DRAW_BUFFERS.COLOR_ATTACHMENT0_WEBGL+o}else this._drawBuffers=null;this._fbo=i.createFramebuffer()},e.FrameBuffer.prototype={constructor:e.FrameBuffer,get width(){return this._width},get height(){return this._height},init:function(){i.bindFramebuffer(i.FRAMEBUFFER,this._fbo),this._colorTextures?void 0===this._cubeFace?(this._width=this._colorTextures[0]._width,this._height=this._colorTextures[0]._height):this._height=this._width=this._colorTextures[0].size:(this._width=this._depthBuffer._width,this._height=this._depthBuffer._height);for(var t=0;t<this._numColorTextures;++t){var n=this._colorTextures[t],r=void 0===this._cubeFace?i.TEXTURE_2D:this._cubeFace;e.EXT_DRAW_BUFFERS?i.framebufferTexture2D(i.FRAMEBUFFER,e.EXT_DRAW_BUFFERS.COLOR_ATTACHMENT0_WEBGL+t,r,n._texture,0):i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,r,n._texture,0)}if(this._depthBuffer){var o=this._depthBuffer.format===i.DEPTH_STENCIL?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;this._depthBuffer instanceof e.Texture2D?i.framebufferTexture2D(i.FRAMEBUFFER,o,i.TEXTURE_2D,this._depthBuffer._texture,0):(i.bindRenderbuffer(i.RENDERBUFFER,this._depthBuffer._renderBuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,o,i.RENDERBUFFER,this._depthBuffer._renderBuffer))}var s=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(s){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.warn("Failed to initialize FBO: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.warn("Failed to initialize FBO: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.warn("Failed to initialize FBO: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.warn("Failed to initialize FBO: FRAMEBUFFER_UNSUPPORTED")}},dispose:function(){i.deleteFramebuffer(this._fbo)}},e.Texture2D=function(){this._name=null,this._default=e.Texture2D.DEFAULT,this._texture=i.createTexture(),this._width=0,this._height=0,this._format=null,this._dataType=null,this.bind(),this.maxAnisotropy=e.DEFAULT_TEXTURE_MAX_ANISOTROPY,this.filter=e.TextureFilter.DEFAULT,this.wrapMode=e.TextureWrapMode.DEFAULT,this._isReady=!1,i.bindTexture(i.TEXTURE_2D,null)},e.Texture2D._initDefault=function(){var t=new Uint8Array([255,0,255,255]);e.Texture2D.DEFAULT=new e.Texture2D,e.Texture2D.DEFAULT.uploadData(t,1,1,!0),e.Texture2D.DEFAULT.filter=e.TextureFilter.NEAREST_NOMIP},e.Texture2D.prototype={get name(){return this._name},set name(t){this._name=t},dispose:function(){i.deleteTexture(this._texture),this._isReady=!1},generateMipmap:function(){this.bind(),i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,null)},get filter(){return this._filter},set filter(t){this._filter=t,this.bind(),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,t.min),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,t.mag),i.bindTexture(i.TEXTURE_2D,null),t!==e.TextureFilter.NEAREST_NOMIP&&t!==e.TextureFilter.NEAREST||(this.maxAnisotropy=1)},get wrapMode(){return this._wrapMode},set wrapMode(t){this._wrapMode=t,this.bind(),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,t.s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,t.t),i.bindTexture(i.TEXTURE_2D,null)},get maxAnisotropy(){return this._maxAnisotropy},set maxAnisotropy(t){t>e.DEFAULT_TEXTURE_MAX_ANISOTROPY&&(t=e.DEFAULT_TEXTURE_MAX_ANISOTROPY),this._maxAnisotropy=t,this.bind(),e.EXT_TEXTURE_FILTER_ANISOTROPIC&&i.texParameteri(i.TEXTURE_2D,e.EXT_TEXTURE_FILTER_ANISOTROPIC.TEXTURE_MAX_ANISOTROPY_EXT,t),i.bindTexture(i.TEXTURE_2D,null)},get width(){return this._width},get height(){return this._height},get format(){return this._format},get dataType(){return this._dataType},initEmpty:function(t,e,n,r){this._format=n=n||i.RGBA,this._dataType=r=r||i.UNSIGNED_BYTE,this.bind(),this._width=t,this._height=e,i.texImage2D(i.TEXTURE_2D,0,n,t,e,0,n,r,null),this._isReady=!0,i.bindTexture(i.TEXTURE_2D,null)},uploadData:function(t,n,r,o,s,a){e.EXT_HALF_FLOAT_TEXTURES&&a===e.EXT_HALF_FLOAT_TEXTURES.HALF_FLOAT_OES&&(t=e.TextureUtils.encodeToFloat16Array(t)),this._width=n,this._height=r,this._format=s=s||i.RGBA,this._dataType=a=a||i.UNSIGNED_BYTE,o=void 0!==o&&o,this.bind(),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,0),i.texImage2D(i.TEXTURE_2D,0,s,n,r,0,s,a,t),o&&i.generateMipmap(i.TEXTURE_2D),this._isReady=!0,i.bindTexture(i.TEXTURE_2D,null)},uploadImage:function(t,e,n,r,o,s){this._width=e,this._height=n,this._format=o=o||i.RGBA,this._dataType=s=s||i.UNSIGNED_BYTE,r=void 0===r||r,this.bind(),t&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1),i.texImage2D(i.TEXTURE_2D,0,o,o,s,t),r&&i.generateMipmap(i.TEXTURE_2D),this._isReady=!0,i.bindTexture(i.TEXTURE_2D,null)},isReady:function(){return this._isReady},bind:function(t){void 0!==t&&i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,this._texture)},toString:function(){return"[Texture2D(name="+this._name+")]"}},e.TextureCube=function(){this._name=null,this._default=e.TextureCube.DEFAULT,this._texture=i.createTexture(),this._size=0,this._format=null,this._dataType=null,this.bind(),this.filter=e.TextureFilter.DEFAULT,this.maxAnisotropy=e.DEFAULT_TEXTURE_MAX_ANISOTROPY,this._isReady=!1},e.TextureCube._initDefault=function(){var t=new Uint8Array([255,0,255,255]);e.TextureCube.DEFAULT=new e.TextureCube,e.TextureCube.DEFAULT.uploadData([t,t,t,t,t,t],1,!0),e.TextureCube.DEFAULT.filter=e.TextureFilter.NEAREST_NOMIP,i.bindTexture(i.TEXTURE_CUBE_MAP,null)},e.TextureCube.prototype={constructor:e.TextureCube,get name(){return this._name},set name(t){this._name=t},dispose:function(){i.deleteTexture(this._texture),this._isReady=!1},generateMipmap:function(){this.bind(),i.generateMipmap(i.TEXTURE_CUBE_MAP),i.bindTexture(i.TEXTURE_CUBE_MAP,null)},get filter(){return this._filter},set filter(t){this._filter=t,this.bind(),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,t.min),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,t.mag),i.bindTexture(i.TEXTURE_CUBE_MAP,null)},get maxAnisotropy(){return this._maxAnisotropy},set maxAnisotropy(t){t>e.DEFAULT_TEXTURE_MAX_ANISOTROPY&&(t=e.DEFAULT_TEXTURE_MAX_ANISOTROPY),this._maxAnisotropy=t,this.bind(),e.EXT_TEXTURE_FILTER_ANISOTROPIC&&i.texParameteri(i.TEXTURE_CUBE_MAP,e.EXT_TEXTURE_FILTER_ANISOTROPIC.TEXTURE_MAX_ANISOTROPY_EXT,t),i.bindTexture(i.TEXTURE_CUBE_MAP,null)},get size(){return this._size},get format(){return this._format},get dataType(){return this._dataType},initEmpty:function(t,e,n){this._format=e=e||i.RGBA,this._dataType=n=n||i.UNSIGNED_BYTE,this._size=t,this.bind(),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X,0,e,t,t,0,e,n,null),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e,t,t,0,e,n,null),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e,t,t,0,e,n,null),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e,t,t,0,e,n,null),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e,t,t,0,e,n,null),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e,t,t,0,e,n,null),this._isReady=!0,i.bindTexture(i.TEXTURE_2D,null)},uploadData:function(t,e,n,r,o){this._size=e,this._format=r=r||i.RGBA,this._dataType=o=o||i.UNSIGNED_BYTE,n=void 0===n||n,this.bind(),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,0),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X,0,r,e,e,0,r,o,t[0]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_X,0,r,e,e,0,r,o,t[1]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Y,0,r,e,e,0,r,o,t[2]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,r,e,e,0,r,o,t[3]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Z,0,r,e,e,0,r,o,t[4]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,r,e,e,0,r,o,t[5]),n&&i.generateMipmap(i.TEXTURE_CUBE_MAP),this._isReady=!0,i.bindTexture(i.TEXTURE_CUBE_MAP,null)},uploadImages:function(t,e,n,r){e=void 0===e||e,this._format=n,this._dataType=r,this.uploadImagesToMipLevel(t,0,n,r),e&&(this.bind(),i.generateMipmap(i.TEXTURE_CUBE_MAP)),this._isReady=!0,i.bindTexture(i.TEXTURE_CUBE_MAP,null)},uploadImagesToMipLevel:function(t,e,n,r){this._format=n=n||i.RGBA,this._dataType=r=r||i.UNSIGNED_BYTE,0===e&&(this._size=t[0].naturalWidth),this.bind(),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,0),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X,e,n,n,r,t[0]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_X,e,n,n,r,t[1]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Y,e,n,n,r,t[2]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,e,n,n,r,t[3]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Z,e,n,n,r,t[4]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,e,n,n,r,t[5]),i.bindTexture(i.TEXTURE_CUBE_MAP,null)},isReady:function(){return this._isReady},bind:function(t){void 0!==t&&i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_CUBE_MAP,this._texture)},toString:function(){return"[TextureCube(name="+this._name+")]"}},e.TextureUtils={assureSize:function(t,e,i,n,r,o){return(t!==i.width||e!==i.height)&&(i.initEmpty(t,e,r,o),n&&n.init(),!0)},copy:function(t,i){e.setRenderTarget(i),e.clear(),e.COPY_SHADER.execute(e.RectMesh.DEFAULT,t),e.setRenderTarget(null)},encodeHalfFloat:function(t){var e=new Float32Array(1),i=new Int32Array(e.buffer);return function(t){e[0]=t;var n=i[0],r=n>>16&32768,o=n>>12&2047,s=n>>23&255;return s<103?r:s>142?(r|=31744,r|=(255==s?0:1)&&8388607&n):s<113?(o|=2048,r|=(o>>114-s)+(o>>113-s&1)):(r|=s-112<<10|o>>1,r+=1&o)}}(),encodeToFloat16Array:function(t){for(var i=e.TextureUtils.encodeHalfFloat,n=[],r=0;r<t.length;++r)n[r]=i(t[r]);return new Uint16Array(n)}},e.WriteOnlyDepthBuffer=function(){this._renderBuffer=i.createRenderbuffer(),this._format=null},e.WriteOnlyDepthBuffer.prototype={constructor:e.FrameBuffer,get width(){return this._width},get height(){return this._height},get format(){return this._format},init:function(t,e,n){n=void 0===n||n,this._width=t,this._height=e,this._format=n?i.DEPTH_STENCIL:i.DEPTH_COMPONENT16,i.bindRenderbuffer(i.RENDERBUFFER,this._renderBuffer),i.renderbufferStorage(i.RENDERBUFFER,this._format,t,e)},dispose:function(){i.deleteRenderBuffer(this._renderBuffer)}},e.EquirectangularTexture={toCube:function(t,n,r,o){r=r||!0,n=n||t.height,e.EquirectangularTexture._EQUI_TO_CUBE_SHADER||(e.EquirectangularTexture._EQUI_TO_CUBE_SHADER=new e.Shader(e.ShaderLibrary.get("2d_to_cube_vertex.glsl"),e.ShaderLibrary.get("equirectangular_to_cube_fragment.glsl"))),this._createRenderCubeGeometry(),o=o||new e.TextureCube,o.initEmpty(n,t.format,t.dataType);var s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];e.EquirectangularTexture._EQUI_TO_CUBE_SHADER.updateRenderState();var a=e.EquirectangularTexture._EQUI_TO_CUBE_SHADER.getUniformLocation("source"),h=e.EquirectangularTexture._EQUI_TO_CUBE_SHADER.getAttributeLocation("hx_position"),l=e.EquirectangularTexture._EQUI_TO_CUBE_SHADER.getAttributeLocation("corner");i.uniform1i(a,0),t.bind(0),e.EquirectangularTexture._TO_CUBE_VERTICES.bind(),e.EquirectangularTexture._TO_CUBE_INDICES.bind(),i.vertexAttribPointer(h,2,i.FLOAT,!1,20,0),i.vertexAttribPointer(l,3,i.FLOAT,!1,20,8),e.enableAttributes(2);for(var u=e.getCurrentRenderTarget(),c=0;c<6;++c){var _=new e.FrameBuffer(o,null,s[c]);_.init(),e.setRenderTarget(_),e.drawElements(i.TRIANGLES,6,6*c),_.dispose()}return e.setRenderTarget(u),r&&o.generateMipmap(),e.EXT_SHADER_TEXTURE_LOD||(o.filter=e.TextureFilter.BILINEAR_NOMIP),o},_createRenderCubeGeometry:function(){if(!e.EquirectangularTexture._TO_CUBE_VERTICES){var t=[1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,1,1,1,1,-1,1,1,-1,1,1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,-1,1,-1,1,-1,-1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,1,-1,-1,-1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1,1,-1],i=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];e.EquirectangularTexture._TO_CUBE_VERTICES=new e.VertexBuffer,e.EquirectangularTexture._TO_CUBE_INDICES=new e.IndexBuffer,e.EquirectangularTexture._TO_CUBE_VERTICES.uploadData(new Float32Array(t)),e.EquirectangularTexture._TO_CUBE_INDICES.uploadData(new Uint16Array(i))}}},e.FPSCounter=function(t){this._numFrames=t||1,this._frames=[],this._maxFPS=void 0,this._minFPS=void 0,this._currentFPS=0,this._averageFPS=0,this._runningSum=0;for(var e=0;e<this._numFrames;++e)this._frames[e]=0;this._index=0},e.FPSCounter.prototype={update:function(t){this._currentFPS=1e3/t,this._runningSum-=this._frames[this._index],this._runningSum+=this._currentFPS,this._averageFPS=this._runningSum/this._numFrames,this._frames[this._index++]=this._currentFPS,this._index===this._numFrames&&(this._index=0),(void 0===this._maxFPS||this._currentFPS>this._maxFPS)&&(this._maxFPS=this._currentFPS),(void 0===this._minFPS||this._currentFPS<this._minFPS)&&(this._minFPS=this._currentFPS)},get lastFrameFPS(){return Math.round(this._currentFPS)},get averageFPS(){return Math.round(this._averageFPS)},get maxFPS(){return Math.round(this._maxFPS)},get minFPS(){return Math.round(this._minFPS)},reset:function(){this._maxFPS=void 0,this._minFPS=void 0}},function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-t)),o=window.setTimeout(function(){e(n+r)},r);return t=n+r,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),e.FrameTicker=function(){this._isRunning=!1,this._callback=void 0,this._dt=0,this._currentTime=0,this.onTick=new e.Signal},e.FrameTicker.prototype={constructor:e.FrameTicker,start:function(t){this._isRunning||(this._callback=t,this._currentTime=this._getTime(),this._isRunning=!0,this._tick(),this._tick._this=this)},stop:function(){this._isRunning=!1},get dt(){return this._dt},get time(){return this._currentTime},_tick:function(){if(this._isRunning){self.requestAnimationFrame(this._tick.bind(this));var t=this._getTime();this._dt=t-this._currentTime,this._dt!==this._dt&&(this._dt=0),this._currentTime=t,this._callback&&this._callback(this._dt),this.onTick.dispatch(this._dt)}},_getTime:function(){return void 0===self.performance||void 0===self.performance.now?Date.now():self.performance.now()}},e.HeightMap={from8BitTexture:function(t,n,r){n=n||!0;var o=r||new e.Texture2D;o.initEmpty(t.width,t.height);var s=new e.FrameBuffer(o);s.init();var a=new e.Texture2D;a.initEmpty(t.width,t.height);var h=new e.FrameBuffer(a);h.init();var l=new e.CustomCopyShader(e.ShaderLibrary.get("greyscale_to_rgba8.glsl")),u=e.getCurrentRenderTarget();e.setRenderTarget(s),e.clear(),l.execute(e.RectMesh.DEFAULT,t),n&&r.generateMipmap();var c=new e.CustomCopyShader(e.ShaderLibrary.get("smooth_heightmap_fragment.glsl")),_=i.getUniformLocation(c._program,"reference"),d=i.getUniformLocation(c._program,"stepSize");return i.uniform1i(_,1),t.bind(1),e.setRenderTarget(h),e.clear(),i.uniform2f(d,1/t.width,0),c.execute(e.RectMesh.DEFAULT,o),a.generateMipmap(),e.setRenderTarget(s),e.clear(),i.uniform2f(d,0,1/t.height),c.execute(e.RectMesh.DEFAULT,a),h.dispose(),n&&r.generateMipmap(),e.setRenderTarget(u),s.dispose(),o}},e.ImageData={getFromImage:function(t){var e=document.createElement("canvas");e.width=t.naturalWidth,e.height=t.naturalHeight;var i=e.getContext("2d");return i.drawImage(t,0,0),e.getImageData(0,0,e.width,e.height)}},e.MultiViewProject=function(){this._initialized=!1},e.MultiViewProject.prototype={onInit:function(){},onUpdate:function(t){},init:function(t,i){if(this._initialized)throw new Error("Already initialized project!");e.init(t,i),this._resizeCanvas(),this._renderer=new e.MultiRenderer;var n=this;window.addEventListener("resize",function(){n._resizeCanvas.call(n)}),this.onInit(),this._initialized=!0,this.start()},addView:function(t){this._renderer.addView(t)},removeView:function(t){this._renderer.removeView(t)},start:function(){e.onFrame.bind(this._update,this)},stop:function(){e.onFrame.unbind(this._update)},get renderer(){return this._renderer},_update:function(t){e._clearGLStats(),this.onUpdate(t),this._renderer.render(t)},_resizeCanvas:function(){this._canvas=document.getElementById("webglContainer"),this._canvas.width=this._canvas.clientWidth,this._canvas.height=this._canvas.clientHeight}},e.NormalTangentGenerator=function(){this._meshData=null,this._mode=0,this._faceNormals=null,this._faceTangents=null,this._faceBitangents=null},e.NormalTangentGenerator.MODE_NORMALS=1,e.NormalTangentGenerator.MODE_TANGENTS=2,e.NormalTangentGenerator.prototype={generate:function(t,i,n){void 0===n&&(n=!0),this._mode=void 0===i?e.NormalTangentGenerator.MODE_NORMALS|e.NormalTangentGenerator.MODE_TANGENTS:i,this._meshData=t,this._positionAttrib=t.getVertexAttribute("hx_position"),this._normalAttrib=t.getVertexAttribute("hx_normal"),this._tangentAttrib=t.getVertexAttribute("hx_tangent"),this._uvAttrib=t.getVertexAttribute("hx_texCoord"),this._positionStride=t.getVertexStride(this._positionAttrib.streamIndex),this._normalStride=t.getVertexStride(this._normalAttrib.streamIndex),this._tangentStride=t.getVertexStride(this._tangentAttrib.streamIndex),this._uvStride=t.getVertexStride(this._uvAttrib.streamIndex),this._calculateFaceVectors(n),this._calculateVertexVectors()},_calculateFaceVectors:function(t){var i=this._meshData._indexData.length;0!==(this._mode&e.NormalTangentGenerator.MODE_NORMALS)&&(this._faceNormals=new Array(i)),0!==(this._mode&e.NormalTangentGenerator.MODE_TANGENTS)&&(this._faceTangents=new Array(i),this._faceBitangents=new Array(i));for(var n=new e.Float4,r=new e.Float4,o=new e.Float4,s=new e.Float4,a=new e.Float4,h=new e.Float4,l=new e.Float2,u=new e.Float2,c=new e.Float2,_=new e.Float2,d=new e.Float2,f=this._positionAttrib.offset,p=this._uvAttrib.offset,m=this._meshData.getVertexData(this._positionAttrib.streamIndex),g=this._meshData.getVertexData(this._uvAttrib.streamIndex),x=0;x<i;x+=3)this._getFloat3At(x,f,this._positionStride,s,m),this._getFloat3At(x+1,f,this._positionStride,a,m),this._getFloat3At(x+2,f,this._positionStride,h,m),this._getFloat2At(x,p,this._uvStride,l,g),this._getFloat2At(x+1,p,this._uvStride,u,g),this._getFloat2At(x+2,p,this._uvStride,c,g),a.subtract(s),h.subtract(s),this._faceNormals&&(n.cross(a,h),t||n.normalize(),this._faceNormals[x]=n.x,this._faceNormals[x+1]=n.y,this._faceNormals[x+2]=n.z),this._faceTangents&&(e.Float2.subtract(u,l,_),e.Float2.subtract(c,l,d),e.Float4.scale(a,d.y,r),e.Float4.scale(h,_.y,o),e.Float4.subtract(r,o,n),n.lengthSqr>.001&&n.normalize(),this._faceTangents[x]=n.x,this._faceTangents[x+1]=n.y,this._faceTangents[x+2]=n.z,e.Float4.scale(a,d.x,r),e.Float4.scale(h,_.x,r),e.Float4.subtract(o,r,n),this._faceBitangents[x]=n.x,this._faceBitangents[x+1]=n.y,this._faceBitangents[x+2]=n.z)},_calculateVertexVectors:function(){this._zeroVectors();for(var t=this._faceTangents?[]:null,e=this._meshData._indexData,i=this._normalAttrib.offset,n=this._tangentAttrib.offset,r=this._meshData.getVertexData(this._normalAttrib.streamIndex),o=this._meshData.getVertexData(this._tangentAttrib.streamIndex),s=e.length,a=0;a<s;++a){var h=e[a],l=i+h*this._normalStride,u=n+h*this._tangentStride,c=3*h,_=3*Math.floor(a/3);this._faceNormals&&(r[l]+=this._faceNormals[_],r[l+1]+=this._faceNormals[_+1],r[l+2]+=this._faceNormals[_+2]),this._faceTangents&&(o[u]+=this._faceTangents[_],o[u+1]+=this._faceTangents[_+1],o[u+2]+=this._faceTangents[_+2],t[c]+=this._faceBitangents[_],t[c+1]+=this._faceBitangents[_+1],t[c+2]+=this._faceBitangents[_+2])}this._normalize(t)},_zeroVectors:function(){for(var t=this._meshData.getVertexData(this._normalAttrib.streamIndex),i=this._meshData.getVertexData(this._tangentAttrib.streamIndex),n=this._meshData.getVertexStride(this._normalAttrib.streamIndex),r=this._meshData.getVertexStride(this._tangentAttrib.streamIndex),o=t.length/n,s=this._normalAttrib.offset,a=this._tangentAttrib.offset,h=0;h<o;++h)this._mode&e.NormalTangentGenerator.MODE_NORMALS&&(t[s]=0,t[s+1]=0,t[s+2]=0),this._mode&e.NormalTangentGenerator.MODE_TANGENTS&&(i[a]=0,i[a+1]=0,i[a+2]=0),s+=n,a+=r},_normalize:function(t){for(var i=this._meshData.getVertexData(this._normalAttrib.streamIndex),n=this._meshData.getVertexData(this._tangentAttrib.streamIndex),r=i.length/this._normalStride,o=this._normalAttrib.offset,s=this._tangentAttrib.offset,a=0,h=new e.Float4,l=new e.Float4,u=new e.Float4,c=new e.Float4,_=0;_<r;++_)h.x=i[o],h.y=i[o+1],h.z=i[o+2],this._mode&e.NormalTangentGenerator.MODE_NORMALS&&(h.normalize(),i[o]=h.x,i[o+1]=h.y,i[o+2]=h.z),this._mode&e.NormalTangentGenerator.MODE_TANGENTS&&(l.x=n[s],l.y=n[s+1],l.z=n[s+2],l.lengthSqr<1e-4?l.set(1,1,1,1):l.normalize(),u.x=t[a],u.y=t[a+1],u.z=t[a+2],c.cross(l,h),n[s]=l.x,n[s+1]=l.y,n[s+2]=l.z,n[s+3]=e.dot3(u,c)>0?1:-1),o+=this._normalStride,s+=this._tangentStride},_getFloat3At:function(t,e,i,n,r){var o=this._meshData._indexData,s=e+o[t]*i;n.x=r[s],n.y=r[s+1],n.z=r[s+2]},_getFloat2At:function(t,e,i,n,r){var o=this._meshData._indexData,s=e+o[t]*i;n.x=r[s],n.y=r[s+1]}},e.SimpleProject=function(){this._initialized=!1},e.SimpleProject.prototype={onInit:function(){},onUpdate:function(t){},init:function(t,i){if(this._initialized)throw new Error("Already initialized project!");e.init(t,i),this._canvas=t,this._resizeCanvas(),this._scene=new e.Scene,this._camera=new e.PerspectiveCamera,this._scene.attach(this._camera),this._renderer=new e.ForwardRenderer;var n=this;window.addEventListener("resize",function(){n._resizeCanvas()}),this.onInit(),this._initialized=!0,this.start()},start:function(){e.onFrame.bind(this._update,this)},stop:function(){e.onFrame.unbind(this._update)},get renderer(){return this._renderer},get scene(){return this._scene},set scene(t){this._scene.detach(this._camera),this._scene=t,this._scene.attach(this._camera)},get camera(){return this._camera},set camera(t){if(this._scene.detach(this._camera),this._camera=t,this._camera._parent){if(this._camera._scene!==this._scene)throw new Error("Camera attached to a different scene!")}else this._scene.attach(this._camera)},_update:function(t){e._clearGLStats(),this.onUpdate(t),this._renderer.render(this._camera,this._scene,t)},_resizeCanvas:function(){var t=1;this._canvas.width=this._canvas.clientWidth*t,this._canvas.height=this._canvas.clientHeight*t}},e.StatsDisplay=function(t){this._fpsCounter=new e.FPSCounter(30),this._div=document.createElement("div"),this._div.style.position="absolute",this._div.style.left="5px",this._div.style.top="5px",this._div.style.width="100px",this._div.style.background="rgba(0, 0, 0, .5)",this._div.style.padding="10px 15px 10px 15px",this._div.style.color="#ffffff",this._div.style.fontFamily='"Lucida Console", Monaco, monospace',this._div.style.fontSize="small",t=t||document.getElementsByTagName("body")[0],t.appendChild(this._div),e.onPreFrame.bind(this._update,this)},e.StatsDisplay.prototype={remove:function(){this._div.parentNode.removeChild(this._div)},_update:function(t){this._fpsCounter.update(t),this._div.innerHTML="FPS: "+this._fpsCounter.averageFPS+"<br/>Draws: "+e._glStats.numDrawCalls+"<br/>Tris: "+e._glStats.numTriangles+"<br/>Clears: "+e._glStats.numClears+"<br/><br/><div style='font-size:x-small; width:100%; text-align:right;'>Helix "+e.VERSION+"<br/></div>"}},e.MorphAnimation=function(t){e.Component.call(this),this._morphPose=new e.MorphPose;for(var i=0;i<t.length;++i)this._morphPose.addMorphTarget(t[i])},e.MorphAnimation.prototype=Object.create(e.Component.prototype,{numMorphTargets:{get:function(){return this._morphPose.numMorphTargets}}}),e.MorphAnimation.prototype.getMorphTarget=function(t){return this._morphPose.getMorphTarget(t)},e.MorphAnimation.prototype.setWeight=function(t,e){this._morphPose.setWeight(t,e)},e.MorphAnimation.prototype.onAdded=function(){this.entity.morphPose=this._morphPose},e.MorphAnimation.prototype.onRemoved=function(){this.entity.morphPose=null},e.MorphAnimation.prototype.onUpdate=function(t){this._morphPose.update(t)},e.MorphPose=function(){this._targets=[],this._weights={},this._stateInvalid=!0,this.onChange=new e.Signal},e.MorphPose.prototype={getMorphTarget:function(t){return this._targets[t]},get numMorphTargets(){return this._targets.length},addMorphTarget:function(t){this._targets.push(t),this._weights[t.name]=0,this._stateInvalid=!0},getWeight:function(t){return this._weights[t]},setWeight:function(t,e){this._weights[t]!==e&&(this._stateInvalid=!0),this._weights[t]=e},update:function(){if(this._stateInvalid){var t=this._weights;this._targets.sort(function(e,i){return t[i.name]-t[e.name]}),this._stateInvalid=!1,this.onChange.dispatch()}}},e.MorphData=function(){this.positions=[]},e.MorphTarget=function(){this.name=null,this._vertexBuffers=[],this._numVertices=[]},e.MorphTarget.prototype={get numVertices(){return this._numVertices},getNumVertices:function(t){return this._numVertices[t]},getVertexBuffer:function(t){return this._vertexBuffers[t]},initFromMorphData:function(t,i){var n=t.positions;this._numVertices[i]=n.length/3,this._vertexBuffers[i]=new e.VertexBuffer,this._vertexBuffers[i].uploadData(new Float32Array(n))}},e.SkeletonJoint=function(){this.name=null,this.parentIndex=-1,this.inverseBindPose=new e.Matrix4x4},e.SkeletonJoint.prototype={toString:function(){return"[SkeletonJoint]"}},e.SkeletonJointPose=function(){this.rotation=new e.Quaternion,this.position=new e.Float4,this.scale=new e.Float4(1,1,1)},e.SkeletonJointPose.prototype={copyFrom:function(t){this.rotation.copyFrom(t.rotation),this.position.copyFrom(t.position),this.scale.copyFrom(t.scale)},toString:function(){return"[SkeletonJointPose]"}},e.SkeletonPose=function(){this.jointPoses=[]},e.SkeletonPose.prototype={interpolate:function(t,e,i){t=t.jointPoses,e=e.jointPoses;var n=t.length;this.jointPoses.length!==n&&this._initJointPoses(n);for(var r=this.jointPoses,o=0;o<n;++o)r[o].rotation.slerp(t[o].rotation,e[o].rotation,i),r[o].position.lerp(t[o].position,e[o].position,i),r[o].scale.lerp(t[o].scale,e[o].scale,i)},copyBindPose:function(t){for(var i=new e.Matrix4x4,n=0;n<t.numJoints;++n){var r=t.getJoint(n),o=this.jointPoses[n]=new e.SkeletonJointPose;i.inverseAffineOf(r.inverseBindPose),r.parentIndex>=0&&i.append(t.getJoint(r.parentIndex).inverseBindPose),i.decompose(o)}},copyFrom:function(t){t=t.jointPoses;var e=this.jointPoses,i=t.length;this.jointPoses.length!==i&&this._initJointPoses(i);for(var n=0;n<i;++n)e[n].copyFrom(t[n])},_initJointPoses:function(t){this._numJoints=t,this.jointPoses.length=t;for(var i=0;i<t;++i)this.jointPoses[i]=new e.SkeletonJointPose}},e.Skeleton=function(){this._joints=[],this._name=""},e.Skeleton.prototype={get numJoints(){return this._joints.length},addJoint:function(t){this._joints.push(t)},getJoint:function(t){return this._joints[t]},get name(){return this._name},set name(t){this._name=t},toString:function(){return"[Skeleton(name="+this.name+")"}},e.SkeletonAnimation=function(t){e.Component.call(this),t instanceof e.SkeletonClip&&(t=new e.SkeletonClipNode(t)),this._blendTree=new e.SkeletonBlendTree(t)},e.SkeletonAnimation.prototype=Object.create(e.Component.prototype,{transferRootJoint:{get:function(){return this._blendTree.transferRootJoint},set:function(t){this._blendTree.transferRootJoint=t}},applyInverseBindPose:{get:function(){return this._blendTree.applyInverseBindPose},set:function(t){this._blendTree.applyInverseBindPose=t}},animationNode:{get:function(){return this._blendTree.rootNode},set function(t){this._blendTree.rootNode=t,this._entity&&(this._blendTree.skeleton=this._entity.skeleton)}}}),e.SkeletonAnimation.prototype.setValue=function(t,e){this._blendTree.setValue(t,e)},e.SkeletonAnimation.prototype.onAdded=function(){this._blendTree.skeleton=this._entity.skeleton},e.SkeletonAnimation.prototype.onUpdate=function(t){if(this._blendTree.update(t)){var i=this._entity.matrix,n=this._blendTree.rootJointDeltaPosition;i.prependTranslation(n),this._entity.matrix=i}this._entity.skeletonMatrices=e.OPTIONS.useSkinningTexture?this._blendTree.texture:this._blendTree.matrices},e.SkeletonBinaryLerpNode=function(){e.SkeletonBlendNode.call(this),this._value=0,this._child1=null,this._child2=null,this._minValue=0,this._maxValue=1,this._numJoints=0,this._t=0,this._valueChanged=!1},e.SkeletonBinaryLerpNode.prototype=Object.create(e.SkeletonBlendNode.prototype,{numJoints:{get:function(){return this._numJoints}},minValue:{get:function(){return this._minValue},set:function(t){this._minValue=t}},maxValue:{get:function(){return this._maxValue},set:function(t){this._maxValue=t}},value:{get:function(){return this._value},set:function(t){t=e.clamp(t,this._minValue,this._maxValue),this._value!==t&&(this._valueChanged=!0),this._value=t,this._t=(this._value-this._minValue)/(this._maxValue-this._minValue)}},child1:{get:function(){return this._child1},set:function(t){if(this._child1=t,this._child2&&t.numJoints!==this._child2.numJoints)throw new Error("Incompatible child nodes (numJoints mismatch)!");this._numJoints=t.numJoints}},child2:{get:function(){return this._child2},set:function(t){if(this._child2=t,this._child1&&t.numJoints!==this._child1.numJoints)throw new Error("Incompatible child nodes (numJoints mismatch)!")}}}),e.SkeletonBinaryLerpNode.prototype.update=function(t,e){var i=this._child1.update(t,e);i=this._child2.update(t,e)||i,i=i||this._valueChanged;var n=this._t;return i&&(n>.999?this._pose.copyFrom(this._child1._pose):n<.001?this._pose.copyFrom(this._child2._pose):this._pose.interpolate(this._child1._pose,this._child2._pose,this._t),this._valueChanged=!1),i},e.SkeletonBinaryLerpNode.prototype._applyValue=function(t){this.value=t},e.SkeletonBinaryLerpNode.prototype.setValue=function(t,i){e.SkeletonBlendNode.prototype.setValue.call(this,t,i),this._child1.setValue(t,i),
this._child2.setValue(t,i)},e.SkeletonBlendTree=function(t,i){this._skeleton=i,this._rootNode=t,this._transferRootJoint=!1,this._matrices=null,this._globalPose=new e.SkeletonPose,this._applyInverseBindPose=!0,e.OPTIONS.useSkinningTexture&&(this._texture=new e.Texture2D,this._texture.filter=e.TextureFilter.NEAREST_NOMIP,this._texture.wrapMode=e.TextureWrapMode.CLAMP),i&&(this.skeleton=i)},e.SkeletonBlendTree.prototype={get transferRootJoint(){return this._transferRootJoint},set transferRootJoint(t){this._transferRootJoint=t},get applyInverseBindPose(){return this._applyInverseBindPose},set applyInverseBindPose(t){this._applyInverseBindPose=t},get skeleton(){return this._skeleton},set skeleton(t){this._skeleton=t,this._matrices=[];for(var i=0;i<t.numJoints;++i)this._matrices[i]=new e.Matrix4x4,this._globalPose.jointPoses[i]=new e.SkeletonJointPose},get rootJointDeltaPosition(){return this._rootNode.rootJointDeltaPosition},get rootNode(){return this._rootNode},set rootNode(t){this._rootNode=t},get matrices(){return this._matrices},get texture(){return this._texture},setValue:function(t,e){this._rootNode.setValue(t,e)},update:function(t){return!!this._rootNode.update(t,this._transferRootJoint)&&(this._updateGlobalPose(),this._updateMatrices(),e.OPTIONS.useSkinningTexture&&this._updateTexture(),!0)},_updateGlobalPose:function(){for(var t=this._skeleton,e=t.numJoints,i=this._rootNode._pose.jointPoses,n=this._globalPose.jointPoses,r=0;r<e;++r){var o=i[r],s=n[r],a=t.getJoint(r);if(a.parentIndex<0)s.copyFrom(o);else{var h=n[a.parentIndex],l=s.position,u=h.position,c=h.rotation;c.rotate(o.position,l),l.x+=u.x,l.y+=u.y,l.z+=u.z,s.rotation.multiply(c,o.rotation),s.scale.x=h.scale.x*o.scale.x,s.scale.y=h.scale.y*o.scale.y,s.scale.z=h.scale.z*o.scale.z}}},_updateMatrices:function(){for(var t=this._skeleton.numJoints,i=this._matrices,n=this._globalPose.jointPoses,r=this._skeleton,o=0;o<t;++o){var s=n[o],a=i[o];this._applyInverseBindPose?a.copyFrom(r.getJoint(o).inverseBindPose):a.copyFrom(e.Matrix4x4.IDENTITY);var h=s.scale;a.appendScale(h.x,h.y,h.z),a.appendQuaternion(s.rotation),a.appendTranslation(s.position)}},_updateTexture:function(){for(var t=this._skeleton.numJoints,n=[],r=0;r<3;++r){for(var o=0;o<t;++o){var s=this._matrices[o]._m;n.push(s[r],s[r+4],s[r+8],s[r+12])}for(o=t;o<e.OPTIONS.maxBones;++o)n.push(0,0,0,0)}this._texture.uploadData(new Float32Array(n),e.OPTIONS.maxBones,3,!1,i.RGBA,i.FLOAT)}},e.SkeletonClip=function(){this._name=null,this._keyFrames=[],this._duration=0},e.SkeletonClip.prototype={get name(){return this._name},set name(t){this._name=t},addKeyFrame:function(t){this._keyFrames.push(t),t.time>this._duration&&(this._duration=t.time)},sortKeyFrames:function(){this._keyFrames.sort(function(t,e){return t.time-e.time})},get numKeyFrames(){return this._keyFrames.length},getKeyFrame:function(t){return this._keyFrames[t]},get duration(){return this._duration},toString:function(){return"[SkeletonClip(name="+this.name+")"}},e.SkeletonClipNode=function(t){e.SkeletonBlendNode.call(this),this._clip=t,this._timeScale=1,this._isPlaying=!0,this._time=0,this._currentFrameIndex=0,this._rootPosition=new e.Float4;var i=t.getKeyFrame(t.numKeyFrames-1).value.jointPoses[0].position,n=t.getKeyFrame(0).value.jointPoses[0].position;this._clipRootDelta=e.Float4.subtract(i,n)},e.SkeletonClipNode.prototype=Object.create(e.SkeletonBlendNode.prototype,{numJoints:{get:function(){return this._clip.getKeyFrame(0).value.jointPoses.length}},timeScale:{get:function(){return this._timeScale},set:function(t){this._timeScale=t}},time:{get:function(){return this._time},set:function(t){this._time=t,this._timeChanged=!0}}}),e.SkeletonClipNode.prototype.play=function(){this._isPlaying=!0},e.SkeletonClipNode.prototype.stop=function(){this._isPlaying=!1},e.SkeletonClipNode.prototype.update=function(t,e){if(!(this._isPlaying&&0!==t||this._timeChanged))return!1;this._timeChanged=!1,this._isPlaying&&(t*=this._timeScale,this._time+=t);var i,n,r=this._clip,o=r.numKeyFrames,s=o-1,a=r.duration,h=0;if(t>0){for(;this._time>=a;)this._currentFrameIndex=0,this._time-=a,++h;do++this._currentFrameIndex===o&&(this._currentFrameIndex=0),n=r.getKeyFrame(this._currentFrameIndex);while(n.time<this._time);--this._currentFrameIndex,i=r.getKeyFrame(this._currentFrameIndex)}else{for(;this._time<0;)this._currentFrameIndex=s,this._time+=a,++h;++this._currentFrameIndex;do--this._currentFrameIndex<0&&(this._currentFrameIndex=o),i=r.getKeyFrame(this._currentFrameIndex);while(i.time>this._time)}var l=(this._time-i.time)/(n.time-i.time);return this._pose.interpolate(i.value,n.value,l),e&&this._transferRootJointTransform(h,t),!0},e.SkeletonClipNode.prototype._transferRootJointTransform=function(t,i){var n=this._pose.jointPoses[0].position,r=this._rootPosition,o=this._rootJointDeltaPosition;e.Float4.subtract(n,r,o),i>0&&t>0?o.addScaled(this._clipRootDelta,t):i<0&&t>0&&o.addScaled(this._clipRootDelta,-t),this._rootPosition.copyFrom(n),n.set(0,0,0)},e.SkeletonClipNode.prototype._applyValue=function(t){this.time=t*this._clip.duration},e.SkeletonFreePoseNode=function(t){e.SkeletonBlendNode.call(this),this._skeleton=t,this._poseInvalid=!0,this._pose.copyBindPose(t),this._poseLookUp={};for(var i=0;i<t.numJoints;++i){var n=t.getJoint(i);this._poseLookUp[n.name]=this._pose.jointPoses[i]}},e.SkeletonFreePoseNode.prototype=Object.create(e.SkeletonBlendNode.prototype,{numJoints:{get function(){return this._skeleton.numJoints}}}),e.SkeletonFreePoseNode.prototype.update=function(t){var e=this._poseInvalid;return this._poseInvalid=!1,e},e.SkeletonFreePoseNode.prototype.setJointRotation=function(t,e){var i=this._getJointPose(t);i.rotation.copyFrom(e),this._poseInvalid=!0},e.SkeletonFreePoseNode.prototype.setJointTranslation=function(t,e){var i=this._getJointPose(t);i.position.copyFrom(e),this._poseInvalid=!0},e.SkeletonFreePoseNode.prototype.setJointScale=function(t,e){var i=this._getJointPose(t);i.scale.copyFrom(e),this._poseInvalid=!0},e.SkeletonFreePoseNode.prototype._getJointPose=function(t){return t instanceof String?this._poseLookUp[t]:this._pose.jointPoses[t]},e.SkeletonXFadeNode=function(){e.SkeletonBlendNode.call(this),this._children=[],this._numJoints=0},e.SkeletonXFadeNode.prototype=Object.create(e.SkeletonBlendNode.prototype,{numJoints:{get:function(){return this._numJoints}}}),e.SkeletonXFadeNode.prototype.update=function(t,e){for(var i=this._children.length,n=i>1&&t>0,r=0;r<i;++r){var o=this._children[r];n=o.node.update(t,e)||n;var s=o.weight+t*o.fadeSpeed;if(s>.999){o.weight=1,this._children.splice(r+1);break}o.weight=s}if(!n)return!1;var a=this._children.length-1,h=this._children[a].node,l=this._rootJointDeltaPosition,u=this._pose;for(u.copyFrom(h._pose),e&&l.copyFrom(h._rootJointDeltaPosition),r=a-1;r>=0;--r)o=this._children[r],h=o.node,e&&l.lerp(l,h._rootJointDeltaPosition,o.weight),u.interpolate(u,h._pose,o.weight);return!0},e.SkeletonXFadeNode.prototype.fadeTo=function(t,i){t instanceof e.SkeletonClip&&(t=new e.SkeletonClipNode(t)),this._numJoints=t.numJoints,this._children.unshift({node:t,weight:0,fadeSpeed:1/i})},e.BoxPrimitive=e.Primitive.define(),e.BoxPrimitive._generate=function(t,e){var i,n,r,o,s,a,h,l,u=e.numSegmentsW||1,c=e.numSegmentsH||e.numSegmentsW||1,_=e.numSegmentsD||e.numSegmentsW||1,d=e.width||1,f=e.height||d,p=e.depth||d,m=e.invert?-1:1,g=void 0!==e.doubleSided&&e.doubleSided,x=1/u,S=1/c,v=1/_,T=.5*d,E=.5*f,y=.5*p,M=t.positions,A=t.uvs,P=t.normals,b=t.indices;for(h=0;h<=c;++h)for(s=h*S,n=f*s-E,m<0&&(s=1-s),a=0;a<=u;++a)o=a*x,i=d*o-T,m<0&&(o=1-o),M.push(i*m,n*m,y*m),M.push(-i*m,n*m,-y*m),P&&(P.push(0,0,1),P.push(0,0,-1)),A&&(A.push(o,s),A.push(o,s));for(h=0;h<=c;++h)for(s=h*S,n=f*s-E,l=0;l<=_;++l)o=l*v,r=p*o-y,M.push(-T,n,r*m),M.push(T,n,-r*m),P&&(P.push(-m,0,0),P.push(m,0,0)),A&&(A.push(o,s),A.push(o,s));for(l=0;l<=_;++l)for(s=l*v,r=p*s-y,a=0;a<=u;++a)o=a*x,i=d*o-T,M.push(i,E,-r*m),M.push(i,-E,r*m),P&&(P.push(0,m,0),P.push(0,-m,0)),A&&(A.push(1-o,1-s),A.push(1-o,1-s));for(var w=0,R=0;R<3;++R){for(var D=1===R?_:u,C=2===R?_:c,L=0;L<C;++L)for(var O=0;O<D;++O){var I=D+1,F=w+O+L*I,N=F<<1,B=F+I+1<<1,U=F+I<<1,j=F+1<<1;b.push(N,B,U),b.push(N,j,B),b.push(1|N,1|B,1|U),b.push(1|N,1|j,1|B)}w+=(D+1)*(C+1)}var V=0;if(g)for(var X=0;X<V;)b.push(b[X],b[X+2],b[X+1]),b.push(b[X+3],b[X+5],b[X+4]),V+=6},e.ConePrimitive=e.Primitive.define(),e.ConePrimitive.ALIGN_X=1,e.ConePrimitive.ALIGN_Y=2,e.ConePrimitive.ALIGN_Z=3,e.ConePrimitive._generate=function(t,e){e=e||{};var i,n,r,o,s,a=e.numSegmentsH||1,h=e.numSegmentsW||1,l=e.radius||1,u=e.height||1,c=void 0!==e.doubleSided&&e.doubleSided,_=t.positions,d=t.uvs,f=t.normals,p=t.indices,m=1/h,g=1/a;for(i=0;i<=a;++i){var x=(1-i*g)*l,S=(i*g-.5)*u;for(n=0;n<=h;++n){s=n*m*Math.PI*2;var v=Math.sin(s),T=Math.cos(s);r=v*x,o=T*x,_.push(r,S,-o),f&&f.push(v,0,-T),d&&d.push(1-n*m,i*g)}}var E,y=h+1;for(n=0;n<h;++n){for(i=0;i<a-1;++i)E=n+i*y,p.push(E,E+y,E+y+1),p.push(E,E+y+1,E+1),c&&(p.push(E,E+y+1,E+y),p.push(E,E+1,E+y+1));E=n+(a-1)*y,p.push(E,E+y+1,E+1)}var M=_.length/3,A=.5*u;for(n=0;n<h;++n){s=n*m*Math.PI*2;var P=Math.sin(s),b=Math.cos(s);r=P*l,o=b*l,P=.5*-P+.5,b=.5*b+.5,_.push(r,-A,-o),f&&f.push(0,-1,0),d&&d.push(P,b)}for(n=1;n<h-1;++n)p.push(M,M+n,M+n+1)},e.CylinderPrimitive=e.Primitive.define(),e.CylinderPrimitive.ALIGN_X=1,e.CylinderPrimitive.ALIGN_Y=2,e.CylinderPrimitive.ALIGN_Z=3,e.CylinderPrimitive._generate=function(t,i){i=i||{};var n,r,o,s,a,h=i.alignment||e.CylinderPrimitive.ALIGN_Y,l=i.numSegmentsH||1,u=i.numSegmentsW||1,c=i.radius||1,_=i.height||1,d=void 0!==i.doubleSided&&i.doubleSided,f=t.positions,p=t.uvs,m=t.normals,g=t.indices,x=1/u,S=1/l;for(n=0;n<=l;++n){var v=(n*S-.5)*_;for(r=0;r<=u;++r){a=r*x*Math.PI*2;var T=Math.sin(a),E=Math.cos(a);switch(o=T*c,s=E*c,h){case e.CylinderPrimitive.ALIGN_X:f.push(-v,o,-s),m&&m.push(0,T,-E);break;case e.CylinderPrimitive.ALIGN_Y:f.push(o,v,-s),m&&m.push(T,0,-E);break;case e.CylinderPrimitive.ALIGN_Z:f.push(o,s,v),m&&m.push(T,E,0)}p&&p.push(1-r*x,n*S)}}for(n=0;n<l;++n)for(r=0;r<u;++r){var y=u+1,M=r+n*y;g.push(M,M+y,M+y+1),g.push(M,M+y+1,M+1),d&&(g.push(M,M+y+1,M+y),g.push(M,M+1,M+y+1))}var A=f.length/3,P=.5*_;for(r=0;r<u;++r){a=r*x*Math.PI*2;var b=Math.sin(a),w=Math.cos(a);switch(o=b*c,s=w*c,b=.5*-b+.5,w=.5*w+.5,h){case e.CylinderPrimitive.ALIGN_X:f.push(P,o,-s),f.push(-P,o,-s),m&&(m.push(1,0,0),m.push(-1,0,0)),p&&(p.push(w,1-b),p.push(1-w,1-b));break;case e.CylinderPrimitive.ALIGN_Y:f.push(o,-P,-s),f.push(o,P,-s),m&&(m.push(0,-1,0),m.push(0,1,0)),p&&(p.push(b,w),p.push(b,1-w));break;case e.CylinderPrimitive.ALIGN_Z:f.push(o,s,-P),f.push(o,s,P),m&&(m.push(0,0,-1),m.push(0,0,1)),p&&(p.push(b,w),p.push(1-b,w))}}for(r=1;r<u-1;++r){var R=r<<1;g.push(A,A+R,A+R+2),g.push(A+1,A+R+3,A+R+1)}},e.PlanePrimitive=e.Primitive.define(),e.PlanePrimitive.ALIGN_XZ=1,e.PlanePrimitive.ALIGN_XY=2,e.PlanePrimitive.ALIGN_YZ=3,e.PlanePrimitive._generate=function(t,i){i=i||{};var n=i.alignment||e.PlanePrimitive.ALIGN_XZ,r=i.numSegmentsW||1,o=i.numSegmentsH||1,s=i.width||1,a=i.height||1,h=void 0!==i.doubleSided&&i.doubleSided,l=t.positions,u=t.uvs,c=t.normals,_=t.indices,d=1/r,f=1/o,p=0,m=0,g=0,x=0,S=0,v=0,T=0,E=0;n===e.PlanePrimitive.ALIGN_XY?v=-1:n===e.PlanePrimitive.ALIGN_XZ?S=1:x=1;for(var y=0;y<=o;++y)for(var M=(y*f-.5)*a,A=0;A<=r;++A){var P=(A*d-.5)*s;if(n===e.PlanePrimitive.ALIGN_XY?(p=P,m=M,T=1-A*d,E=y*f):n===e.PlanePrimitive.ALIGN_XZ?(p=P,g=M,T=1-A*d,E=y*f):(m=M,g=P,T=1-A*d,E=y*f),l.push(p,m,g),c&&c.push(x,S,v),u&&u.push(T,E),h&&(l.push(p,m,g),c&&c.push(-x,-S,-v),u&&u.push(1-T,E)),A!==r&&y!==o){var b=r+1,w=A+y*b,R=h?1:0;_.push(w<<R,w+b<<R,w+b+1<<R),_.push(w<<R,w+b+1<<R,w+1<<R),h&&(_.push((w+b+1<<R)+1,(w+b<<R)+1,(w<<R)+1),_.push((w+1<<R)+1,(w+b+1<<R)+1,(w<<R)+1))}}},e.SpherePrimitive=e.Primitive.define(),e.SpherePrimitive._generate=function(t,e){e=e||{};for(var i=e.numSegmentsW||16,n=e.numSegmentsH||10,r=e.radius||.5,o=e.invert?-1:1,s=void 0!==e.doubleSided&&e.doubleSided,a=t.positions,h=t.uvs,l=t.normals,u=1/i,c=1/n,_=0;_<=n;++_){var d=_*c,f=d*Math.PI,p=-Math.cos(f),m=Math.sin(f);o<0&&(d=1-d);for(var g=0;g<=i;++g){var x=g*u,S=x*Math.PI*2;o&&(x=1-x);var v=Math.cos(S)*m*o,T=p*o,E=Math.sin(S)*m*o;a.push(v*r,T*r,E*r),l&&l.push(v*o,T*o,E*o),h&&h.push(x,d)}}var y=t.indices;for(_=0;_<n;++_)for(g=0;g<i;++g){var M=i+1,A=g+_*M;y.push(A,A+M,A+M+1),y.push(A,A+M+1,A+1),s&&(y.push(A,A+M+1,A+M),y.push(A,A+1,A+M+1))}},e.TorusPrimitive=e.Primitive.define(),e.TorusPrimitive.ALIGN_XZ=1,e.TorusPrimitive.ALIGN_XY=2,e.TorusPrimitive.ALIGN_YZ=3,e.TorusPrimitive._generate=function(t,i){i=i||{};for(var n=i.numSegmentsW||15,r=i.numSegmentsH||20,o=i.radius||.5,s=i.tubeRadius||.1,a=i.alignment||e.PlanePrimitive.ALIGN_XZ,h=void 0!==i.doubleSided&&i.doubleSided,l=t.positions,u=t.uvs,c=t.normals,_=1/n,d=1/r,f=0;f<=r;++f)for(var p=f*d,m=p*Math.PI*2,g=Math.cos(m),x=Math.sin(m),S=0;S<=n;++S){var v=S*_,T=v*Math.PI*2,E=Math.cos(T),y=Math.sin(T),M=o+g*s;switch(a){case e.TorusPrimitive.ALIGN_XZ:l.push(E*M,x*s,y*M),c&&c.push(E*g,x,y*g);break;case e.TorusPrimitive.ALIGN_XY:l.push(-E*M,y*M,x*s),c&&c.push(-E*g,y*g,x);break;case e.TorusPrimitive.ALIGN_YZ:l.push(x*s,-E*M,y*M),c&&c.push(x,-E*g,y*g)}u&&u.push(v,1-p)}for(var A=t.indices,P=0;P<r;++P)for(var b=0;b<n;++b){var w=n+1,R=b+P*w;A.push(R,R+w,R+w+1),A.push(R,R+w+1,R+1),h&&(A.push(R,R+w+1,R+w),A.push(R,R+1,R+w+1))}},Object.defineProperty(t,"__esModule",{value:!0})});